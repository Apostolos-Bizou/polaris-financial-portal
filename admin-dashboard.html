<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polaris Financial Services - Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --polaris-green: #1B5E20;
            --polaris-green-light: #2E7D32;
            --polaris-gold: #D4AF37;
            --gold-plan: #FFD700;
            --platinum-plan: #E5E4E2;
            --silver-plan: #C0C0C0;
            --bg-dark: #3d5a80;
            --bg-card: #0d1f2d;
            --text-primary: #ffffff;
            --text-secondary: #b8d4e8;
            --text-muted: #7aa0c0;
            --border-color: #2d5070;
            --success: #4CAF50;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Open Sans', sans-serif;
            background: #3d5a80;
            color: var(--text-primary);
            min-height: 100vh;
        }
        h1, h2, h3 { font-family: 'Montserrat', sans-serif; }
        
        .bg-pattern {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(ellipse at 20% 20%, rgba(27, 94, 32, 0.15) 0%, transparent 50%),
                        radial-gradient(ellipse at 80% 80%, rgba(212, 175, 55, 0.08) 0%, transparent 50%);
        }
        
        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 10000;
            transition: opacity 0.5s;
        }
        .loading-screen.hidden { opacity: 0; visibility: hidden; }
        .loader-ring {
            width: 80px; height: 80px; border: 3px solid var(--border-color);
            border-top-color: var(--polaris-gold); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 1.5rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .login-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: flex;
            align-items: center; justify-content: center; z-index: 9999;
        }
        .login-modal.hidden { display: none; }
        .login-box {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 20px; padding: 3rem; width: 100%; max-width: 420px;
        }
        .login-box::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--polaris-green), var(--polaris-gold));
        }
        .login-title {
            font-size: 1.75rem; font-weight: 700; text-align: center;
            margin-bottom: 0.5rem;
        }
        .login-subtitle {
            text-align: center; color: var(--text-secondary);
            margin-bottom: 2rem;
        }
        .login-input {
            width: 100%; background: var(--bg-dark);
            border: 1px solid var(--border-color); border-radius: 10px;
            padding: 1rem; color: var(--text-primary);
            font-family: inherit; margin-bottom: 1rem;
        }
        .login-input:focus { outline: none; border-color: var(--polaris-green); }
        .login-btn {
            width: 100%; background: linear-gradient(135deg, var(--polaris-green), var(--polaris-green-light));
            border: none; border-radius: 10px; padding: 1rem;
            color: white; font-family: 'Montserrat', sans-serif;
            font-weight: 700; cursor: pointer; transition: transform 0.3s;
        }
        .login-btn:hover { transform: translateY(-2px); }
        .login-error { color: var(--danger); text-align: center; margin-top: 1rem; }
        
        .header {
            background: rgba(10, 26, 10, 0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem; position: sticky; top: 0; z-index: 100;
        }
        .header-content {
            max-width: 1600px; margin: 0 auto;
            display: flex; align-items: center; justify-content: space-between;
        }
        .logo-section { display: flex; align-items: center; gap: 0.75rem; }
        .polaris-star {
            font-size: 2rem;
            background: linear-gradient(135deg, #FFD700, #FFA000, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 8px rgba(255,215,0,0.5));
            animation: starGlow 2s ease-in-out infinite alternate;
        }
        @keyframes starGlow {
            from { filter: drop-shadow(0 0 5px rgba(255,215,0,0.4)); }
            to { filter: drop-shadow(0 0 12px rgba(255,215,0,0.7)); }
        }
        .polaris-text {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4rem;
            font-weight: 800;
            letter-spacing: 2px;
            background: linear-gradient(135deg, #D4AF37, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .logo-section img { height: 40px; }
        .portal-badge {
            background: var(--polaris-gold); color: var(--bg-dark);
            padding: 0.3rem 0.8rem; border-radius: 15px;
            font-size: 0.7rem; font-weight: 700;
        }
        .user-section { display: flex; align-items: center; gap: 1rem; }
        .client-badge {
            display: flex; align-items: center; gap: 0.5rem;
            background: var(--bg-card); border: 1px solid var(--border-color);
            padding: 0.4rem 1rem 0.4rem 0.4rem; border-radius: 25px;
        }
        .client-avatar {
            width: 32px; height: 32px; border-radius: 50%;
            background: var(--polaris-green); display: flex;
            align-items: center; justify-content: center; font-weight: 700;
        }
        .logout-btn {
            background: transparent; border: 1px solid var(--border-color);
            color: var(--text-secondary); padding: 0.5rem 1rem;
            border-radius: 8px; cursor: pointer;
        }
        .logout-btn:hover { background: var(--danger); border-color: var(--danger); color: white; }
        
        /* Admin Dashboard - Client Selector */
        .client-selector-wrapper {
            display: flex; align-items: center; gap: 0.75rem;
        }
        .client-selector {
            background: var(--bg-dark); border: 2px solid var(--border-color);
            color: var(--text-primary); padding: 0.6rem 1rem;
            border-radius: 10px; font-family: inherit; font-size: 0.9rem;
            min-width: 250px; cursor: pointer;
            transition: all 0.3s;
        }
        .client-selector:focus { outline: none; border-color: var(--polaris-gold); }
        .client-selector:hover { border-color: var(--polaris-green); }
        .compare-btn {
            display: flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, #1565C0, #1976D2);
            color: white; padding: 0.6rem 1rem;
            border: none; border-radius: 10px; cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.8rem; font-weight: 700;
            transition: all 0.3s;
        }
        .compare-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(25,118,210,0.4); }
        .compare-btn.active { background: linear-gradient(135deg, #E65100, #FF9800); }
        .active-members-btn {
            display: flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, var(--polaris-gold), #FFA000);
            color: var(--bg-dark); padding: 0.6rem 1.25rem;
            border-radius: 25px; text-decoration: none;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem; font-weight: 700;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(212,175,55,0.3);
            cursor: pointer; border: none;
        }
        .active-members-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212,175,55,0.5);
        }
        .admin-badge { background: linear-gradient(135deg, var(--polaris-green), #4CAF50); }
        .admin-avatar { background: linear-gradient(135deg, #FFD700, #FFA000) !important; color: var(--bg-dark) !important; }
        
        /* Compare Panel */
        .compare-panel {
            background: rgba(10, 26, 10, 0.98); border-bottom: 2px solid var(--polaris-gold);
            padding: 1.5rem; position: sticky; top: 70px; z-index: 99;
            backdrop-filter: blur(10px);
        }
        .compare-panel-content {
            max-width: 800px; margin: 0 auto; text-align: center;
        }
        .compare-panel h3 { color: var(--polaris-gold); margin-bottom: 1rem; font-size: 1.2rem; }
        .compare-selectors {
            display: flex; align-items: center; justify-content: center; gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .compare-select-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .compare-select-group label { color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; }
        .compare-select {
            background: var(--bg-dark); border: 2px solid var(--border-color);
            color: var(--text-primary); padding: 0.75rem 1.25rem;
            border-radius: 10px; font-size: 1rem; min-width: 220px;
        }
        .compare-vs {
            font-family: 'Montserrat', sans-serif; font-weight: 800;
            font-size: 1.5rem; color: var(--polaris-gold);
            padding: 0 1rem;
        }
        .compare-apply-btn {
            background: linear-gradient(135deg, var(--polaris-green), #4CAF50);
            color: white; border: none; padding: 0.75rem 2rem;
            border-radius: 25px; font-weight: 700; cursor: pointer;
            margin-right: 1rem; transition: all 0.3s;
        }
        .compare-apply-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(46,125,50,0.4); }
        .compare-cancel-btn {
            background: transparent; border: 2px solid var(--border-color);
            color: var(--text-secondary); padding: 0.7rem 1.5rem;
            border-radius: 25px; cursor: pointer; transition: all 0.3s;
        }
        .compare-cancel-btn:hover { border-color: var(--danger); color: var(--danger); }
        
        /* Section Dividers */
        .section-divider {
            display: flex; align-items: center; justify-content: center; gap: 1rem;
            margin: 3rem 0 2rem; padding: 1rem 0;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(90deg, transparent, rgba(46,125,50,0.1), transparent);
        }
        .section-divider-icon { font-size: 2rem; }
        .section-divider-text {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4rem; font-weight: 800;
            letter-spacing: 3px; text-transform: uppercase;
            background: linear-gradient(135deg, var(--polaris-gold), #FFD700);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .client-filter-badge {
            background: linear-gradient(135deg, var(--polaris-green), #4CAF50);
            color: white; padding: 0.3rem 0.8rem; border-radius: 15px;
            font-size: 0.85rem; font-weight: 600; margin-left: 0.5rem;
        }
        
        /* Quarter Selector Bar */
        .quarter-selector-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(10, 26, 10, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1rem 1.5rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }
        .quarter-selector-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .quarter-label {
            color: var(--text-muted);
            font-size: 0.95rem;
            font-weight: 600;
        }
        .quarter-buttons {
            display: flex;
            gap: 0.5rem;
        }
        .quarter-btn {
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.6rem 1.25rem;
            border-radius: 10px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .quarter-btn:hover {
            border-color: var(--polaris-gold);
            color: var(--polaris-gold);
        }
        .quarter-btn.active {
            background: linear-gradient(135deg, var(--polaris-green), #4CAF50);
            border-color: var(--polaris-green);
            color: white;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3);
        }
        .quarter-btn.compare-selected {
            background: linear-gradient(135deg, #1565C0, #1976D2);
            border-color: #1976D2;
            color: white;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
        }
        .quarter-selector-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .quarter-compare-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: transparent;
            border: 2px solid #1976D2;
            color: #42A5F5;
            padding: 0.6rem 1.25rem;
            border-radius: 10px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        .quarter-compare-btn:hover {
            background: rgba(25, 118, 210, 0.1);
        }
        .quarter-compare-btn.active {
            background: linear-gradient(135deg, #1565C0, #1976D2);
            border-color: #1976D2;
            color: white;
        }
        .selected-quarters-badge {
            background: linear-gradient(135deg, var(--polaris-gold), #FFD700);
            color: var(--bg-dark);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
        }
        
        .active-members-btn {
            display: flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, var(--polaris-gold), #FFA000);
            color: var(--bg-dark); padding: 0.6rem 1.25rem;
            border-radius: 25px; text-decoration: none;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem; font-weight: 700;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(212,175,55,0.3);
        }
        .active-members-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212,175,55,0.5);
        }
        .report-btn {
            display: flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, #2E7D32, #4CAF50);
            color: white; padding: 0.6rem 1.25rem;
            border: none; border-radius: 25px; cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem; font-weight: 700;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(46,125,50,0.3);
        }
        .report-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(46,125,50,0.5);
        }
        .reports-btn {
            display: flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, #B8860B, #D4AF37);
            color: white; padding: 0.6rem 1.25rem;
            border: none; border-radius: 25px; cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem; font-weight: 700;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(123,31,162,0.3);
        }
        .reports-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(123,31,162,0.5);
        }
        .email-center-btn {
            display: flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, #1565C0, #1976D2);
            color: white; padding: 0.6rem 1.25rem;
            border: none; border-radius: 25px; cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem; font-weight: 700;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(21,101,192,0.3);
        }
        .email-center-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(21,101,192,0.5);
        }
        
        /* Email Center Modal */
        .email-center-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex;
            align-items: center; justify-content: center; z-index: 9999;
            backdrop-filter: blur(5px);
        }
        .email-center-modal.hidden { display: none; }
        .email-center-box {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 20px; width: 95%; max-width: 900px; max-height: 90vh;
            overflow: hidden; position: relative;
        }
        .email-center-header {
            background: linear-gradient(135deg, #1565C0, #1976D2);
            padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center;
        }
        .email-center-header h2 { color: white; font-size: 1.5rem; margin: 0; }
        .email-center-close {
            background: rgba(255,255,255,0.2); border: none; color: white;
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
            font-size: 1.2rem; transition: all 0.3s;
        }
        .email-center-close:hover { background: rgba(255,255,255,0.3); }
        .email-center-content {
            padding: 1.5rem 2rem; max-height: calc(90vh - 80px); overflow-y: auto;
        }
        .email-tabs {
            display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;
        }
        .email-tab {
            padding: 0.6rem 1.2rem; background: var(--bg-dark); border: 1px solid var(--border-color);
            border-radius: 20px; color: var(--text-secondary); cursor: pointer;
            font-size: 0.85rem; transition: all 0.3s;
        }
        .email-tab:hover { background: var(--border-color); }
        .email-tab.active {
            background: linear-gradient(135deg, #1565C0, #1976D2);
            color: white; border-color: transparent;
        }
        .email-form-group {
            margin-bottom: 1.25rem;
        }
        .email-form-group label {
            display: block; color: var(--text-secondary); margin-bottom: 0.5rem;
            font-size: 0.9rem; font-weight: 600;
        }
        .email-select, .email-input, .email-textarea {
            width: 100%; padding: 0.8rem 1rem; background: var(--bg-dark);
            border: 1px solid var(--border-color); border-radius: 10px;
            color: var(--text-primary); font-family: inherit; font-size: 0.95rem;
        }
        .email-select:focus, .email-input:focus, .email-textarea:focus {
            outline: none; border-color: #1976D2;
        }
        .email-textarea { min-height: 150px; resize: vertical; }
        .email-recipients-box {
            background: var(--bg-dark); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 1rem; max-height: 200px; overflow-y: auto;
        }
        .email-recipient-item {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem;
            border-radius: 8px; margin-bottom: 0.25rem; transition: background 0.2s;
        }
        .email-recipient-item:hover { background: rgba(255,255,255,0.05); }
        .email-recipient-item input[type="checkbox"] {
            width: 18px; height: 18px; cursor: pointer;
        }
        .email-recipient-info { flex: 1; }
        .email-recipient-name { color: var(--text-primary); font-weight: 500; }
        .email-recipient-email { color: var(--text-muted); font-size: 0.8rem; }
        .email-recipient-role {
            font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 10px;
            background: var(--border-color); color: var(--text-secondary);
        }
        .email-actions {
            display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap;
        }
        .email-action-btn {
            padding: 0.4rem 0.8rem; background: var(--border-color); border: none;
            border-radius: 15px; color: var(--text-secondary); cursor: pointer;
            font-size: 0.8rem; transition: all 0.2s;
        }
        .email-action-btn:hover { background: #1976D2; color: white; }
        .email-preview-box {
            background: #fff; border-radius: 10px; padding: 1.5rem;
            color: #333; max-height: 300px; overflow-y: auto;
        }
        .email-btn-row {
            display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end;
        }
        .email-btn {
            padding: 0.8rem 2rem; border: none; border-radius: 25px;
            font-family: 'Montserrat', sans-serif; font-weight: 700;
            cursor: pointer; transition: all 0.3s;
        }
        .email-btn-preview {
            background: var(--border-color); color: var(--text-primary);
        }
        .email-btn-preview:hover { background: #3d5a80; }
        .email-btn-send {
            background: linear-gradient(135deg, #1565C0, #1976D2); color: white;
        }
        .email-btn-send:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(21,101,192,0.4); }
        .email-btn-send:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .email-status {
            padding: 1rem; border-radius: 10px; margin-top: 1rem; text-align: center;
        }
        .email-status.success { background: rgba(76,175,80,0.2); color: #4CAF50; }
        .email-status.error { background: rgba(231,76,60,0.2); color: #e74c3c; }
        .template-card {
            background: var(--bg-dark); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 1rem; margin-bottom: 0.75rem;
            cursor: pointer; transition: all 0.2s;
        }
        .template-card:hover { border-color: #1976D2; transform: translateX(5px); }
        .template-card.selected { border-color: #1976D2; background: rgba(25,118,210,0.1); }
        .template-card-title { color: var(--text-primary); font-weight: 600; margin-bottom: 0.25rem; }
        .template-card-category {
            font-size: 0.75rem; color: var(--text-muted);
            background: var(--border-color); padding: 0.2rem 0.5rem;
            border-radius: 10px; display: inline-block;
        }
        
        /* Contract Center Modal */
        .contract-center-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(5px); }
        .contract-center-modal.hidden { display: none; }
        .contract-center-box { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; width: 98%; max-width: 1400px; height: 95vh; max-height: 95vh; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        .contract-center-header { background: linear-gradient(135deg, #1a365d, #2c5282); padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .contract-center-header h2 { color: white; font-size: 1.5rem; margin: 0; }
        .contract-center-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; transition: all 0.3s; }
        .contract-center-close:hover { background: rgba(255,255,255,0.3); }
        .contract-center-content { padding: 1.5rem 2rem; flex: 1; overflow-y: auto; }
        
        /* Offers Center Button */
        .offers-center-btn {
            display: flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, #1E3A5F, #2d5a87);
            color: white; padding: 0.6rem 1rem;
            border: none; border-radius: 10px; cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.8rem; font-weight: 700;
            transition: all 0.3s;
        }
        .offers-center-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(30,58,95,0.4); }
        
        /* Offers Center Modal */
        .offers-center-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; align-items: stretch; justify-content: stretch; z-index: 9999; padding: 0; margin: 0; overflow: hidden; }
        .offers-center-modal.hidden { display: none; }
        .offers-center-modal * { scrollbar-width: none; -ms-overflow-style: none; }
        .offers-center-modal *::-webkit-scrollbar { display: none; }
        .offers-center-box { background: var(--bg-card); border: none; border-radius: 0; width: 100%; height: 100%; max-width: 100%; max-height: 100%; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        .offers-center-header { background: linear-gradient(135deg, #1E3A5F, #2d5a87); padding: 0.75rem 2rem; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .offers-center-header h2 { color: white; font-size: 1.3rem; margin: 0; }
        .offers-center-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.1rem; transition: all 0.3s; }
        .offers-center-close:hover { background: rgba(255,255,255,0.3); }
        .offers-center-content { padding: 1rem 2rem; flex: 1; overflow-y: auto; overflow-x: hidden; scrollbar-width: none; -ms-overflow-style: none; }
        .offers-center-content::-webkit-scrollbar { display: none; }
        .offers-stats { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.75rem; margin-bottom: 1rem; }
        .offer-stat-card { background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 10px; padding: 0.5rem 0.75rem; text-align: center; }
        .offer-stat-card.draft { border-left: 3px solid #6c757d; }
        .offer-stat-card.sent { border-left: 3px solid #3498db; }
        .offer-stat-card.accepted { border-left: 3px solid #27ae60; }
        .offer-stat-card.rejected { border-left: 3px solid #e74c3c; }
        .offer-stat-card.total { border-left: 3px solid var(--polaris-gold); }
        .offer-stat-value { font-size: 1.4rem; font-weight: 700; color: var(--text-primary); line-height: 1.2; }
        .offer-stat-label { font-size: 0.7rem; color: var(--text-muted); }
        .offers-tabs { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .offers-tab { padding: 0.75rem 1.5rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 20px; color: var(--text-secondary); cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
        .offers-tab:hover { background: var(--border-color); }
        .offers-tab.active { background: linear-gradient(135deg, #1E3A5F, #2d5a87); color: white; border-color: transparent; }
        
        /* Program Cards for Offer Creator */
        .program-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .program-card { background: var(--bg-dark); border: 2px solid var(--border-color); border-radius: 12px; padding: 1.25rem; transition: all 0.3s; }
        .program-card:hover { border-color: var(--polaris-gold); }
        .program-card.selected { border-color: var(--polaris-gold); background: rgba(212,175,55,0.1); }
        .program-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .program-card-name { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); }
        .program-card-limits { font-size: 0.8rem; color: var(--polaris-gold); background: rgba(212,175,55,0.2); padding: 0.25rem 0.5rem; border-radius: 10px; }
        .program-card-details { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem; }
        .program-card-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        .program-input-group { display: flex; flex-direction: column; gap: 0.25rem; }
        .program-input-group label { font-size: 0.75rem; color: var(--text-muted); }
        .program-input-group input { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem; color: var(--text-primary); font-size: 0.9rem; width: 100%; }
        .program-input-group input:focus { outline: none; border-color: var(--polaris-gold); }
        
        /* Cost Summary Box */
        .cost-summary-box { background: linear-gradient(135deg, #1E3A5F, #0d2137); border: 2px solid var(--polaris-gold); border-radius: 16px; padding: 1.5rem; margin-top: 1.5rem; }
        .cost-summary-title { font-size: 1.1rem; font-weight: 700; color: var(--polaris-gold); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .cost-summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem; }
        .cost-summary-item { text-align: center; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 10px; }
        .cost-summary-item-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; }
        .cost-summary-item-value { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); }
        .cost-summary-total { display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 2px solid rgba(212,175,55,0.3); }
        .cost-summary-total-label { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); }
        .cost-summary-total-value { font-size: 2rem; font-weight: 800; color: var(--polaris-gold); }
        
        /* Offers Table */
        .offers-table { width: 100%; border-collapse: collapse; }
        .offers-table th { background: rgba(0,0,0,0.3); padding: 1rem; text-align: left; font-size: 0.85rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
        .offers-table td { padding: 1rem; border-top: 1px solid var(--border-color); }
        .offers-table tbody tr:hover { background: rgba(255,255,255,0.05); }
        .offer-status { padding: 0.3rem 0.75rem; border-radius: 15px; font-size: 0.8rem; font-weight: 600; }
        .offer-status.draft { background: rgba(108,117,125,0.2); color: #adb5bd; }
        .offer-status.sent { background: rgba(52,152,219,0.2); color: #3498db; }
        .offer-status.accepted { background: rgba(39,174,96,0.2); color: #27ae60; }
        .offer-status.rejected { background: rgba(231,76,60,0.2); color: #e74c3c; }
        .offer-status.expired { background: rgba(243,156,18,0.2); color: #f39c12; }
        
        .contract-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
        .contract-stat-card { background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; text-align: center; }
        .contract-stat-card.warning { border-color: #f39c12; }
        .contract-stat-value { font-size: 2.5rem; font-weight: 700; color: var(--polaris-gold); }
        .contract-stat-label { font-size: 0.9rem; color: var(--text-muted); margin-top: 0.5rem; }
        .contract-tabs { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .contract-tab { padding: 0.75rem 1.5rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 20px; color: var(--text-secondary); cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
        .contract-tab:hover { background: var(--border-color); }
        .contract-tab.active { background: linear-gradient(135deg, #1a365d, #2c5282); color: white; border-color: transparent; }
        .contract-table-wrapper { background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; flex: 1; min-height: 300px; }
        .contract-table { width: 100%; border-collapse: collapse; }
        .contract-table th { background: rgba(0,0,0,0.3); padding: 1rem 1.25rem; text-align: left; font-size: 0.85rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .contract-table td { padding: 1rem 1.25rem; border-top: 1px solid var(--border-color); font-size: 0.95rem; }
        .contract-table tbody tr:hover { background: rgba(255,255,255,0.05); }
        .contract-status { display: inline-block; padding: 0.35rem 0.9rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: capitalize; }
        .contract-status.draft { background: rgba(100,100,100,0.3); color: #aaa; }
        .contract-status.sent { background: rgba(33,150,243,0.2); color: #2196F3; }
        .contract-status.negotiating { background: rgba(255,152,0,0.2); color: #FF9800; }
        .contract-status.signed { background: rgba(76,175,80,0.2); color: #4CAF50; }
        .contract-status.active { background: rgba(76,175,80,0.3); color: #81C784; }
        .contract-status.expired { background: rgba(244,67,54,0.2); color: #F44336; }
        .contract-type { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        .contract-type.ASA { background: #1a365d; color: white; }
        .contract-type.NDA { background: #7c3aed; color: white; }
        .contract-type.DPA { background: #0891b2; color: white; }
        .contract-action-btn { padding: 0.3rem 0.6rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; transition: all 0.2s; margin-right: 0.25rem; text-decoration: none; display: inline-block; }
        .contract-action-btn.view { background: rgba(33,150,243,0.2); color: #2196F3; }
        .contract-action-btn.edit { background: rgba(255,152,0,0.2); color: #FF9800; }
        .contract-action-btn.download { background: rgba(76,175,80,0.2); color: #4CAF50; }
        .contract-action-btn:hover { transform: scale(1.05); }
        .contract-form-group { margin-bottom: 1.25rem; }
        .contract-form-group label { display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 600; }
        .contract-select, .contract-input { width: 100%; padding: 0.8rem 1rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem; }
        .contract-select:focus, .contract-input:focus { outline: none; border-color: #2c5282; }
        .contract-checkbox-group { display: flex; gap: 1.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
        .contract-checkbox-label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: var(--text-primary); }
        .contract-checkbox-label input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .financial-terms-box { background: rgba(26,54,93,0.3); border: 1px solid #2c5282; border-radius: 12px; padding: 1.25rem; margin-top: 1rem; }
        .financial-terms-title { color: #63b3ed; font-weight: 600; margin-bottom: 1rem; }
        .financial-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .financial-grid .contract-form-group { margin-bottom: 0; }
        .contract-btn-row { display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end; }
        .contract-btn { padding: 0.8rem 2rem; border: none; border-radius: 25px; font-family: 'Montserrat', sans-serif; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .contract-btn-secondary { background: var(--border-color); color: var(--text-primary); }
        .contract-btn-secondary:hover { background: #3d5a80; }
        .contract-btn-primary { background: linear-gradient(135deg, #1a365d, #2c5282); color: white; }
        .contract-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(26,54,93,0.4); }
        .contract-filter-bar { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: flex-end; }
        .contract-filter-group { flex: 1; min-width: 150px; }
        .contract-filter-group label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem; }
        .contract-filter-group select, .contract-filter-group input { width: 100%; padding: 0.5rem 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.85rem; }
        .contract-center-btn { background: linear-gradient(135deg, #1a365d, #2c5282); border: none; color: white; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s; }
        .contract-center-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(26,54,93,0.4); }
        .contract-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .contract-details-section { background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.25rem; }
        .contract-details-section h4 { color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 1rem; }
        .contract-detail-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color); }
        .contract-detail-row:last-child { border-bottom: none; }
        .contract-detail-label { color: var(--text-muted); font-size: 0.9rem; }
        .contract-detail-value { color: var(--text-primary); font-weight: 500; }
        @media (max-width: 768px) { .contract-stats { grid-template-columns: repeat(2, 1fr); } .contract-details-grid { grid-template-columns: 1fr; } .financial-grid { grid-template-columns: 1fr; } }
        
        /* Report Builder Modal */
        .report-builder-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex;
            align-items: center; justify-content: center; z-index: 9999;
            backdrop-filter: blur(5px);
        }
        .report-builder-modal.hidden { display: none; }
        .report-builder-box {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 24px; padding: 0; width: 100%; max-width: 800px;
            max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;
        }
        .rb-header {
            background: linear-gradient(135deg, #1B5E20, #2E7D32);
            padding: 1.5rem 2rem; color: white;
        }
        .rb-header h2 { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem; }
        .rb-header p { font-size: 0.9rem; opacity: 0.9; }
        .rb-close {
            position: absolute; top: 1rem; right: 1.5rem;
            background: rgba(255,255,255,0.2); border: none;
            width: 36px; height: 36px; border-radius: 50%;
            color: white; font-size: 1.25rem; cursor: pointer;
            transition: background 0.3s;
        }
        .rb-close:hover { background: rgba(255,255,255,0.3); }
        .rb-content {
            padding: 2rem; overflow-y: auto; flex: 1;
        }
        .rb-section { margin-bottom: 2rem; }
        .rb-section:last-child { margin-bottom: 0; }
        .rb-section-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem; font-weight: 700; color: var(--text-primary);
            margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;
        }
        
        /* Period Selection */
        .rb-period-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;
        }
        .rb-select-group label {
            display: block; font-size: 0.8rem; color: var(--text-muted);
            margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .rb-select {
            width: 100%; background: var(--bg-dark); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 0.8rem 1rem; color: var(--text-primary);
            font-family: inherit; font-size: 0.95rem; cursor: pointer;
        }
        .rb-select:focus { outline: none; border-color: #D4AF37; }
        
        /* Quick Templates */
        .rb-templates {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem;
        }
        .rb-template-btn {
            background: var(--bg-dark); border: 2px solid var(--border-color);
            border-radius: 12px; padding: 1rem; text-align: center;
            cursor: pointer; transition: all 0.3s; color: var(--text-primary);
        }
        .rb-template-btn:hover {
            border-color: #D4AF37; background: rgba(212,175,55,0.1);
        }
        .rb-template-btn.active {
            border-color: #D4AF37; background: rgba(212,175,55,0.15);
        }
        .rb-template-btn span { display: block; font-size: 1.5rem; margin-bottom: 0.5rem; }
        .rb-template-btn div { font-size: 0.85rem; font-weight: 600; }
        
        /* Report Sections */
        .rb-sections-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .rb-section-item {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg-dark); border: 2px solid var(--border-color);
            border-radius: 12px; padding: 1rem 1.25rem; cursor: pointer;
            transition: all 0.3s;
        }
        .rb-section-item:hover { border-color: rgba(212,175,55,0.5); }
        .rb-section-item.selected {
            border-color: #D4AF37; background: rgba(212,175,55,0.1);
        }
        .rb-section-item input[type="checkbox"] {
            width: 20px; height: 20px; accent-color: #D4AF37;
            margin-right: 1rem; cursor: pointer;
        }
        .rb-section-item-content { flex: 1; }
        .rb-section-item-title { font-weight: 600; font-size: 0.95rem; }
        .rb-section-item-desc { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.2rem; }
        .rb-section-item-badge {
            background: rgba(33,150,243,0.2); color: #2196F3;
            padding: 0.3rem 0.75rem; border-radius: 20px;
            font-size: 0.75rem; font-weight: 600;
        }
        
        /* Export Format */
        .rb-formats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .rb-format-btn {
            background: var(--bg-dark); border: 2px solid var(--border-color);
            border-radius: 16px; padding: 1.5rem; text-align: center;
            cursor: pointer; transition: all 0.3s;
        }
        .rb-format-btn:hover { border-color: #D4AF37; }
        .rb-format-btn.selected {
            border-color: #D4AF37; background: rgba(212,175,55,0.1);
        }
        .rb-format-btn span { display: block; font-size: 2.5rem; margin-bottom: 0.5rem; }
        .rb-format-btn div { font-size: 1rem; font-weight: 600; color: var(--text-primary); }
        
        /* Info Box */
        .rb-info-box {
            background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.3);
            border-radius: 12px; padding: 1rem 1.25rem;
            display: flex; align-items: flex-start; gap: 0.75rem;
        }
        .rb-info-box span { font-size: 1.5rem; }
        .rb-info-box div { font-size: 0.85rem; color: var(--text-secondary); }
        .rb-info-box strong { color: var(--polaris-gold); }
        
        /* Footer Actions */
        .rb-footer {
            padding: 1.5rem 2rem; border-top: 1px solid var(--border-color);
            display: flex; gap: 1rem; background: var(--bg-dark);
        }
        .rb-btn {
            flex: 1; padding: 1rem; border-radius: 12px; font-family: 'Montserrat', sans-serif;
            font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .rb-btn-cancel {
            background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-secondary);
        }
        .rb-btn-cancel:hover { background: var(--border-color); }
        .rb-btn-preview {
            background: transparent; border: 2px solid #D4AF37; color: #D4AF37;
        }
        .rb-btn-preview:hover { background: rgba(212,175,55,0.1); }
        .rb-btn-generate {
            background: linear-gradient(135deg, #1B5E20, #2E7D32); border: none; color: white;
            box-shadow: 0 4px 15px rgba(27,94,32,0.3);
        }
        .rb-btn-generate:hover {
            transform: translateY(-2px); box-shadow: 0 8px 25px rgba(27,94,32,0.4);
        }
        
        @media (max-width: 768px) {
            .rb-templates { grid-template-columns: repeat(2, 1fr); }
            .rb-formats { grid-template-columns: 1fr; }
            .rb-period-grid { grid-template-columns: 1fr; }
        }
        
        /* Report Modal */
        .report-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex;
            align-items: center; justify-content: center; z-index: 9999;
        }
        .report-modal.hidden { display: none; }
        .report-box {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 20px; padding: 2rem; width: 100%; max-width: 500px;
            text-align: center;
        }
        .report-progress {
            width: 100%; height: 8px; background: var(--bg-dark);
            border-radius: 4px; margin: 1.5rem 0; overflow: hidden;
        }
        .report-progress-bar {
            height: 100%; background: linear-gradient(90deg, var(--polaris-green), var(--polaris-gold));
            border-radius: 4px; transition: width 0.3s;
        }
        
        .main-content { max-width: 1600px; margin: 0 auto; padding: 2rem; }
        
        .page-header { margin-bottom: 2rem; }
        .page-title {
            font-size: 1.75rem; font-weight: 700;
            display: flex; align-items: center; gap: 0.75rem;
        }
        .page-subtitle { color: var(--text-secondary); margin-top: 0.5rem; }
        .period-badge {
            display: inline-block; background: var(--bg-card);
            border: 1px solid var(--polaris-gold); color: var(--polaris-gold);
            padding: 0.4rem 1rem; border-radius: 20px;
            font-family: 'Montserrat', sans-serif; font-weight: 600;
        }
        
        .section { margin-bottom: 2.5rem; }
        .section-title {
            font-size: 1.6rem; 
            font-weight: 800;
            margin-bottom: 1.5rem; 
            display: flex; 
            align-items: center; 
            gap: 0.75rem;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-color);
            position: relative;
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, var(--polaris-gold), var(--polaris-green));
        }
        
        /* CBMS Statistics Styles */
        .cbms-stats-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1.25rem;
        }
        .cbms-stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s;
        }
        .cbms-stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .cbms-stat-card.highlight-gold {
            border-color: var(--polaris-gold);
            background: linear-gradient(135deg, var(--bg-card), rgba(212,175,55,0.1));
        }
        .cbms-stat-card.highlight-green {
            border-color: var(--polaris-green);
            background: linear-gradient(135deg, var(--bg-card), rgba(46,125,50,0.1));
        }
        .cbms-stat-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }
        .cbms-stat-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--polaris-gold);
            margin-bottom: 0.5rem;
        }
        .cbms-stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .cbms-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .cbms-detail-item {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .cbms-detail-item.highlight {
            background: linear-gradient(135deg, rgba(212,175,55,0.15), rgba(212,175,55,0.05));
            border: 1px solid rgba(212,175,55,0.3);
        }
        .cbms-detail-label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .cbms-detail-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .cbms-detail-value.gold {
            color: var(--polaris-gold);
        }
        .cbms-total-banner {
            background: linear-gradient(135deg, var(--polaris-green), #4CAF50);
            border-radius: 20px;
            padding: 2.5rem;
            text-align: center;
            box-shadow: 0 10px 40px rgba(46,125,50,0.3);
        }
        .cbms-total-label {
            font-size: 1rem;
            color: rgba(255,255,255,0.9);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 0.75rem;
        }
        .cbms-total-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 3rem;
            font-weight: 800;
            color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .cbms-total-subtext {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
            margin-top: 0.5rem;
        }
        @media (max-width: 1200px) {
            .cbms-stats-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 768px) {
            .cbms-stats-grid { grid-template-columns: repeat(2, 1fr); }
            .cbms-detail-grid { grid-template-columns: 1fr; }
        }
        
        .kpi-grid {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 1.25rem; margin-bottom: 2rem;
        }
        .kpi-card {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 16px; padding: 1.5rem;
            transition: transform 0.3s, box-shadow 0.3s;
            text-align: center;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        .kpi-card::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 100%; height: 4px; border-radius: 16px 16px 0 0;
            background: linear-gradient(90deg, var(--polaris-green), var(--polaris-gold));
        }
        .kpi-icon { font-size: 2rem; margin-bottom: 0.75rem; }
        .kpi-label {
            font-size: 0.75rem; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem;
        }
        .kpi-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.75rem; font-weight: 800;
            color: var(--polaris-gold);
        }
        .kpi-trend {
            display: inline-flex; align-items: center; gap: 0.3rem;
            margin-top: 0.5rem; padding: 0.25rem 0.6rem;
            border-radius: 15px; font-size: 0.8rem; font-weight: 600;
        }
        .kpi-trend.up { background: rgba(231, 76, 60, 0.15); color: var(--danger); }
        .kpi-trend.down { background: rgba(76, 175, 80, 0.15); color: var(--success); }
        
        .comparison-banner {
            background: linear-gradient(135deg, var(--bg-card), rgba(27, 94, 32, 0.2));
            border: 1px solid var(--border-color); border-radius: 20px;
            padding: 2rem; margin-bottom: 2rem;
        }
        .comparison-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 1.5rem;
        }
        .comparison-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.25rem;
        }
        .cmp-card {
            background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.75rem;
            text-align: center;
        }
        .cmp-label {
            font-size: 0.95rem; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1rem;
            font-weight: 600;
        }
        .cmp-values { display: flex; align-items: baseline; justify-content: center; gap: 0.75rem; margin-bottom: 0.75rem; }
        .cmp-current { font-family: 'Montserrat', sans-serif; font-size: 2rem; font-weight: 700; }
        .cmp-previous { font-size: 1.1rem; color: var(--text-muted); text-decoration: line-through; }
        .cmp-change {
            display: inline-flex; align-items: center; gap: 0.25rem;
            padding: 0.4rem 0.8rem; border-radius: 15px;
            font-size: 1rem; font-weight: 600;
        }
        .cmp-change.positive { background: rgba(76, 175, 80, 0.2); color: var(--success); }
        .cmp-change.negative { background: rgba(231, 76, 60, 0.2); color: var(--danger); }
        
        .chart-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.25rem;
        }
        .chart-grid.three { grid-template-columns: repeat(3, 1fr); }
        .chart-card {
            background: linear-gradient(145deg, var(--bg-card), rgba(10,20,10,0.95));
            border: 1px solid var(--border-color);
            border-radius: 16px; padding: 1.5rem;
            box-shadow: 
                0 10px 30px rgba(0,0,0,0.4),
                0 5px 15px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .chart-card:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 15px 40px rgba(0,0,0,0.5),
                0 8px 20px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255,255,255,0.08);
        }
        .chart-card.wide { grid-column: span 2; }
        .chart-card.full { grid-column: span 3; }
        .chart-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 1.25rem;
        }
        .chart-title { font-size: 1.15rem; font-weight: 700; }
        .chart-badge {
            background: rgba(212, 175, 55, 0.2); color: var(--polaris-gold);
            padding: 0.3rem 0.75rem; border-radius: 12px;
            font-size: 0.85rem; font-weight: 600;
        }
        .chart-container { height: 280px; position: relative; }
        .chart-container.tall { height: 350px; }
        
        .gauge-container {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; height: 260px;
        }
        .gauge-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem; font-weight: 800;
            color: var(--polaris-gold); margin-top: 1rem;
        }
        .gauge-label { color: var(--text-muted); margin-top: 0.25rem; }
        .gauge-target { color: var(--text-secondary); margin-top: 0.5rem; }
        .gauge-target span { color: var(--polaris-gold); font-weight: 600; }
        
        .stats-mini-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;
        }
        .stat-mini {
            background: linear-gradient(145deg, var(--bg-card), rgba(8,18,8,0.95));
            border: 1px solid var(--border-color);
            border-radius: 12px; padding: 1.25rem; text-align: center;
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.35),
                0 4px 10px rgba(0,0,0,0.25),
                inset 0 1px 0 rgba(255,255,255,0.05);
            transition: transform 0.3s;
        }
        .stat-mini:hover {
            transform: translateY(-2px) scale(1.02);
        }
        .stat-mini-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .stat-mini-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.6rem; font-weight: 700; color: var(--polaris-gold);
        }
        .stat-mini-label { font-size: 0.9rem; color: var(--text-muted); margin-top: 0.25rem; font-weight: 500; }
        
        .progress-item { margin-bottom: 1.5rem; }
        .progress-header { display: flex; justify-content: space-between; margin-bottom: 0.75rem; }
        .progress-label { font-size: 1.1rem; font-weight: 500; }
        .progress-value { font-family: 'Montserrat', sans-serif; color: var(--polaris-gold); font-weight: 700; font-size: 1.2rem; }
        .progress-bar {
            height: 10px; background: var(--bg-dark);
            border-radius: 5px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; border-radius: 5px;
            background: linear-gradient(90deg, var(--polaris-green), var(--polaris-gold));
            transition: width 1s ease-out;
        }
        
        .insights-list { display: flex; flex-direction: column; gap: 1rem; }
        .insight-item {
            display: flex; align-items: flex-start; gap: 1rem;
            padding: 1rem 1.25rem; background: rgba(0,0,0,0.2);
            border-radius: 10px; border-left: 4px solid var(--polaris-green);
        }
        .insight-item.success { border-left-color: var(--success); }
        .insight-item.warning { border-left-color: var(--warning); }
        .insight-item.danger { border-left-color: var(--danger); }
        .insight-icon { font-size: 1.5rem; }
        .insight-title { font-weight: 700; font-size: 1.1rem; }
        .insight-desc { font-size: 1rem; color: var(--text-secondary); margin-top: 0.25rem; }
        
        .data-table-container {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 16px; overflow: hidden;
        }
        .table-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 1.5rem; border-bottom: 1px solid var(--border-color);
        }
        .table-search {
            background: var(--bg-dark); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 0.6rem 1rem;
            color: var(--text-primary); width: 220px; font-size: 1rem;
        }
        .data-table { width: 100%; border-collapse: collapse; font-size: 1.05rem; }
        .data-table th {
            text-align: left; padding: 1.25rem 1rem;
            font-size: 1rem; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px;
            background: var(--bg-dark); border-bottom: 1px solid var(--border-color);
            font-weight: 700;
        }
        .data-table td { padding: 1.25rem 1rem; border-bottom: 1px solid var(--border-color); font-size: 1.05rem; }
        .data-table tr:hover td { background: rgba(46, 125, 50, 0.1); }
        .rank-badge {
            width: 36px; height: 36px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 1rem;
        }
        .rank-badge.gold { background: var(--gold-plan); color: var(--bg-dark); }
        .rank-badge.silver { background: var(--silver-plan); color: var(--bg-dark); }
        .rank-badge.bronze { background: #CD7F32; color: white; }
        .currency { font-family: 'Montserrat', sans-serif; color: var(--polaris-gold); font-weight: 600; font-size: 1.1rem; }
        
        .footer {
            text-align: center; padding: 2rem;
            border-top: 1px solid var(--border-color); margin-top: 2rem;
            color: var(--text-muted); font-size: 0.85rem;
        }
        
        @media (max-width: 1200px) {
            .kpi-grid { grid-template-columns: repeat(3, 1fr); }
            .chart-grid, .chart-grid.three { grid-template-columns: 1fr; }
            .chart-card.wide, .chart-card.full { grid-column: span 1; }
            .comparison-grid { grid-template-columns: repeat(2, 1fr); }
            .cbms-stats-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 768px) {
            .kpi-grid, .comparison-grid, .stats-mini-grid, .cbms-stats-grid { grid-template-columns: 1fr; }
            .cbms-detail-grid { grid-template-columns: 1fr; }
            .header-content { flex-direction: column; gap: 1rem; }
            .user-section { 
                flex-wrap: wrap; 
                justify-content: center; 
                width: 100%;
            }
            .client-selector-wrapper { 
                width: 100%; 
                flex-direction: column;
            }
            .client-selector { 
                width: 100%; 
                min-width: unset; 
            }
            .compare-btn { 
                width: 100%; 
                justify-content: center; 
            }
            .quarter-selector-bar {
                flex-direction: column;
                gap: 0.75rem;
            }
            .quarter-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            .main-content {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <div class="loading-screen" id="loadingScreen">
        <div class="loader-ring"></div>
        <div style="color: var(--text-secondary); letter-spacing: 2px;">LOADING DASHBOARD</div>
    </div>
    
    <div class="login-modal hidden" id="loginModal">
        <div class="login-box">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 3rem; color: var(--polaris-gold); margin-bottom: 0.5rem;"></div>
                <div style="font-family: 'Montserrat', sans-serif; font-size: 1.5rem; font-weight: 700; letter-spacing: 3px;">POLARIS</div>
                <div style="color: var(--text-muted); font-size: 0.8rem; letter-spacing: 2px;">FINANCIAL SERVICES</div>
            </div>
            <h2 class="login-title">Admin Dashboard</h2>
            <p class="login-subtitle">Sign in with your admin credentials</p>
            <input type="text" class="login-input" id="loginUsername" placeholder="Username" autocomplete="username">
            <input type="password" class="login-input" id="loginPassword" placeholder="Password" autocomplete="current-password">
            <button class="login-btn" onclick="handleLogin()">Sign In</button>
            <p class="login-error" id="loginError"></p>
            <p style="text-align: center; margin-top: 1.5rem; color: var(--text-muted); font-size: 0.8rem;">
                Authorized personnel only
            </p>
        </div>
    </div>
    
    <header class="header" id="mainHeader">
        <div class="header-content">
            <div class="logo-section">
                <div class="polaris-star"></div>
                <span class="polaris-text">POLARIS</span>
                <span class="portal-badge" style="background: linear-gradient(135deg, #1565C0, #1976D2);">ADMIN</span>
            </div>
            <div class="user-section">
                <button onclick="openEmailCenter()" class="email-center-btn">
                    <span></span> Email Center
                </button>
                <button onclick="openContractCenter()" class="contract-center-btn">
                    <span></span> Contracts
                </button>
                <button onclick="openOffersCenter()" class="offers-center-btn">
                    <span></span> Offers
                </button>
                <button onclick="openReportBuilder()" class="reports-btn">
                    <span></span> Reports
                </button>
                <button onclick="openActiveMembers()" class="active-members-btn">
                    <span></span> Active Members
                </button>
                <div class="client-selector-wrapper">
                    <select id="clientSelector" class="client-selector" onchange="handleClientChange()">
                        <option value="all"> All Clients (Company Total)</option>
                    </select>
                    <button class="compare-btn" onclick="toggleCompareMode()" id="compareModeBtn">
                        <span></span> Compare
                    </button>
                </div>
                <div class="client-badge admin-badge">
                    <div class="client-avatar admin-avatar">A</div>
                    <span>Admin</span>
                </div>
                <button class="logout-btn" onclick="handleLogout()">Sign Out</button>
            </div>
        </div>
    </header>
    
    <!-- Compare Mode Panel -->
    <div id="comparePanel" class="compare-panel" style="display:none">
        <div class="compare-panel-content">
            <h3> Compare Clients</h3>
            <div class="compare-selectors">
                <div class="compare-select-group">
                    <label>Client A</label>
                    <select id="compareClientA" class="compare-select"></select>
                </div>
                <div class="compare-vs">VS</div>
                <div class="compare-select-group">
                    <label>Client B</label>
                    <select id="compareClientB" class="compare-select"></select>
                </div>
            </div>
            <button class="compare-apply-btn" onclick="applyComparison()">Apply Comparison</button>
            <button class="compare-cancel-btn" onclick="toggleCompareMode()">Cancel</button>
        </div>
    </div>
    
    <main class="main-content" id="mainContent" style="display:none">
        <div class="page-header">
            <h1 class="page-title"> Admin Dashboard</h1>
            <p class="page-subtitle">
                Company-wide analytics and insights
                <span class="client-filter-badge" id="clientFilterBadge">All Clients</span>
            </p>
        </div>
        
        <!-- Quarter Selector Bar -->
        <div class="quarter-selector-bar">
            <div class="quarter-selector-left">
                <span class="quarter-label"> Select Period:</span>
                <div class="quarter-buttons">
                    <button class="quarter-btn" data-quarter="Q1" onclick="toggleQuarter('Q1')">Q1 2025</button>
                    <button class="quarter-btn" data-quarter="Q2" onclick="toggleQuarter('Q2')">Q2 2025</button>
                    <button class="quarter-btn active" data-quarter="Q3" onclick="toggleQuarter('Q3')">Q3 2025</button>
                    <button class="quarter-btn" data-quarter="Q4" onclick="toggleQuarter('Q4')">Q4 2025</button>
                </div>
            </div>
            <div class="quarter-selector-right">
                <button class="quarter-compare-btn" id="quarterCompareBtn" onclick="toggleQuarterCompare()">
                    <span></span> Compare Quarters
                </button>
                <span class="selected-quarters-badge" id="selectedQuartersBadge">Q3 2025</span>
            </div>
        </div>
        
        <!--  -->
        <!-- BUSINESS STRATEGY SECTION -->
        <!--  -->
        <div class="section-divider">
            <span class="section-divider-icon"></span>
            <span class="section-divider-text">BUSINESS STRATEGY</span>
        </div>
        
        <section class="section">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon"></div>
                    <div class="kpi-label">Total Members</div>
                    <div class="kpi-value" id="kpiMembers">-</div>
                    <div class="kpi-trend" id="kpiMembersTrend">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon"></div>
                    <div class="kpi-label">Total Claims</div>
                    <div class="kpi-value" id="kpiClaims">-</div>
                    <div class="kpi-trend" id="kpiClaimsTrend">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon"></div>
                    <div class="kpi-label">Approved Amount</div>
                    <div class="kpi-value" id="kpiApproved">-</div>
                    <div class="kpi-trend" id="kpiApprovedTrend">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon"></div>
                    <div class="kpi-label">Cost per Member</div>
                    <div class="kpi-value" id="kpiCost">-</div>
                    <div class="kpi-trend" id="kpiCostTrend">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon"></div>
                    <div class="kpi-label">Utilization Rate</div>
                    <div class="kpi-value" id="kpiUtilization">-</div>
                    <div class="kpi-trend" style="background:rgba(255,255,255,0.1);color:var(--text-secondary)">Target: 15%</div>
                </div>
            </div>
        </section>
        
        <!-- INPATIENT vs OUTPATIENT Section - TOP PRIORITY -->
        <section class="section">
            <h2 class="section-title"> Inpatient vs Outpatient Analysis</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"> Cases Distribution</h3>
                        <span class="chart-badge">Current Period</span>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem; grid-template-columns: repeat(3, 1fr);">
                        <div class="stat-mini" style="border-left:4px solid #e74c3c">
                            <div class="stat-mini-icon"></div>
                            <div class="stat-mini-value" id="inpatientCases">-</div>
                            <div class="stat-mini-label">Inpatient Cases</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #3498db">
                            <div class="stat-mini-icon"></div>
                            <div class="stat-mini-value" id="outpatientCases">-</div>
                            <div class="stat-mini-label">Outpatient Cases</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37">
                            <div class="stat-mini-icon"></div>
                            <div class="stat-mini-value" id="exGratiaCases">-</div>
                            <div class="stat-mini-label">Ex Gratia Cases</div>
                        </div>
                    </div>
                    <div class="chart-container short"><canvas id="inOutPieChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"> Cost Comparison</h3>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem; grid-template-columns: repeat(3, 1fr);">
                        <div class="stat-mini" style="border-left:4px solid #e74c3c">
                            <div class="stat-mini-icon"></div>
                            <div class="stat-mini-value" id="inpatientCost">-</div>
                            <div class="stat-mini-label">Inpatient Cost</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #3498db">
                            <div class="stat-mini-icon"></div>
                            <div class="stat-mini-value" id="outpatientCost">-</div>
                            <div class="stat-mini-label">Outpatient Cost</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37">
                            <div class="stat-mini-icon"></div>
                            <div class="stat-mini-value" id="exGratiaCost">-</div>
                            <div class="stat-mini-label">Ex Gratia Cost</div>
                        </div>
                    </div>
                    <div class="chart-container short"><canvas id="inOutCostChart"></canvas></div>
                </div>
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title"> Inpatient vs Outpatient Trend</h3>
                    </div>
                    <div class="chart-container"><canvas id="inOutTrendChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- PRINCIPAL vs DEPENDENT Section -->
        <section class="section">
            <h2 class="section-title"> Principal vs Dependent Analysis</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"> Member Type Distribution</h3>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem">
                        <div class="stat-mini" style="border-left:4px solid #2E7D32">
                            <div class="stat-mini-icon"></div>
                            <div class="stat-mini-value" id="principalCount">-</div>
                            <div class="stat-mini-label">Seafarers (Principal)</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37">
                            <div class="stat-mini-icon"></div>
                            <div class="stat-mini-value" id="dependentCount">-</div>
                            <div class="stat-mini-label">Dependents</div>
                        </div>
                    </div>
                    <div class="chart-container short"><canvas id="memberTypePieChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"> Claims by Member Type</h3>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem">
                        <div class="stat-mini" style="border-left:4px solid #2E7D32">
                            <div class="stat-mini-icon"></div>
                            <div class="stat-mini-value" id="principalClaims">-</div>
                            <div class="stat-mini-label">Seafarer Claims</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37">
                            <div class="stat-mini-icon"></div>
                            <div class="stat-mini-value" id="dependentClaims">-</div>
                            <div class="stat-mini-label">Dependent Claims</div>
                        </div>
                    </div>
                    <div class="chart-container short"><canvas id="memberTypeClaimsChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- MEMBER MOVEMENT Section -->
        <section class="section">
            <h2 class="section-title"> Member Movement</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"> Movement Summary</h3>
                        <span class="chart-badge">Current Period</span>
                    </div>
                    <div class="stats-mini-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom:1rem;">
                        <div class="stat-mini" style="border-left:4px solid #4CAF50">
                            <div style="font-size:2.2rem;color:#4CAF50;font-family:Montserrat;font-weight:800" id="newEnrollments">+0</div>
                            <div style="color:var(--text-muted);font-size:0.9rem;margin-top:0.25rem">New Members</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #e74c3c">
                            <div style="font-size:2.2rem;color:#e74c3c;font-family:Montserrat;font-weight:800" id="cancellations">-0</div>
                            <div style="color:var(--text-muted);font-size:0.9rem;margin-top:0.25rem">Cancelled</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37">
                            <div style="font-size:2.2rem;color:#D4AF37;font-family:Montserrat;font-weight:800" id="netChange">0</div>
                            <div style="color:var(--text-muted);font-size:0.9rem;margin-top:0.25rem">Net Growth</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="movementCompareChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"> Movement Trend</h3>
                        <span class="chart-badge">Quarterly</span>
                    </div>
                    <div class="chart-container"><canvas id="movementTrendChart"></canvas></div>
                </div>
            </div>
            <div class="chart-grid" style="grid-template-columns: 1fr; margin-top: 1.25rem;">
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title"> Enrollment vs Cancellation Trend</h3>
                        <span class="chart-badge">All Periods</span>
                    </div>
                    <div class="chart-container" style="height: 300px;"><canvas id="movementFullTrendChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- CLAIMS BY CATEGORY Section -->
        <section class="section">
            <h2 class="section-title"> Claims by Category</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"> Category Distribution</h3>
                        <span class="chart-badge">Current Period</span>
                    </div>
                    <div class="chart-container"><canvas id="categoryPieChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"> Cost by Category</h3>
                    </div>
                    <div class="chart-container"><canvas id="categoryCostChart"></canvas></div>
                </div>
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title"> Category Trend</h3>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem; grid-template-columns: repeat(6, 1fr);">
                        <div class="stat-mini" style="border-left:4px solid #4CAF50; padding:0.75rem;">
                            <div style="font-size:1.4rem;font-weight:700;color:#4CAF50" id="catMedical">-</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Medical</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #2196F3; padding:0.75rem;">
                            <div style="font-size:1.4rem;font-weight:700;color:#2196F3" id="catDental">-</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Dental</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #E91E63; padding:0.75rem;">
                            <div style="font-size:1.4rem;font-weight:700;color:#E91E63" id="catMaternity">-</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Maternity</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #FF9800; padding:0.75rem;">
                            <div style="font-size:1.4rem;font-weight:700;color:#FF9800" id="catOptical">-</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Optical</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37; padding:0.75rem;">
                            <div style="font-size:1.4rem;font-weight:700;color:#D4AF37" id="catLab">-</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Laboratory</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #607D8B; padding:0.75rem;">
                            <div style="font-size:1.4rem;font-weight:700;color:#607D8B" id="catOther">-</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Other</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="categoryTrendChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- YEAR-OVER-YEAR COMPARISON Section -->
        <section class="section">
            <h2 class="section-title"> Year-over-Year Comparison</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"> Annual Claims Comparison</h3>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem;">
                        <div class="stat-mini" style="border-left:4px solid #D4AF37;">
                            <div style="font-size:0.9rem;color:var(--text-muted)">2025 YTD</div>
                            <div style="font-size:1.6rem;font-weight:700;color:#D4AF37" id="yoyClaims2025">-</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #7a8f7a;">
                            <div style="font-size:0.9rem;color:var(--text-muted)">2024</div>
                            <div style="font-size:1.6rem;font-weight:700;color:#7a8f7a" id="yoyClaims2024">-</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="yoyClaimsChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"> Annual Cost Comparison</h3>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem;">
                        <div class="stat-mini" style="border-left:4px solid #4CAF50;">
                            <div style="font-size:0.9rem;color:var(--text-muted)">2025 YTD</div>
                            <div style="font-size:1.6rem;font-weight:700;color:#4CAF50" id="yoyCost2025">-</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #7a8f7a;">
                            <div style="font-size:0.9rem;color:var(--text-muted)">2024</div>
                            <div style="font-size:1.6rem;font-weight:700;color:#7a8f7a" id="yoyCost2024">-</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="yoyCostChart"></canvas></div>
                </div>
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title"> Monthly YoY Trend</h3>
                        <span class="chart-badge">2025 vs 2024</span>
                    </div>
                    <div class="yoy-summary" style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1rem;">
                        <div style="text-align:center;padding:1rem;background:rgba(76,175,80,0.1);border-radius:10px;">
                            <div style="font-size:0.95rem;color:var(--text-muted)">Claims Change</div>
                            <div style="font-size:1.8rem;font-weight:700;color:#4CAF50" id="yoyClaimsChange">+12%</div>
                        </div>
                        <div style="text-align:center;padding:1rem;background:rgba(231,76,60,0.1);border-radius:10px;">
                            <div style="font-size:0.95rem;color:var(--text-muted)">Cost Change</div>
                            <div style="font-size:1.8rem;font-weight:700;color:#e74c3c" id="yoyCostChange">+8%</div>
                        </div>
                        <div style="text-align:center;padding:1rem;background:rgba(52,152,219,0.1);border-radius:10px;">
                            <div style="font-size:0.95rem;color:var(--text-muted)">Member Growth</div>
                            <div style="font-size:1.8rem;font-weight:700;color:#3498db" id="yoyMemberChange">+15%</div>
                        </div>
                        <div style="text-align:center;padding:1rem;background:rgba(212,175,55,0.1);border-radius:10px;">
                            <div style="font-size:0.95rem;color:var(--text-muted)">Cost/Member</div>
                            <div style="font-size:1.8rem;font-weight:700;color:#D4AF37" id="yoyCostPerMember">-5%</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="yoyTrendChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- TOP HOSPITALS/PROVIDERS Section -->
        <section class="section">
            <h2 class="section-title"> Top Hospitals & Providers</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"> Top 10 by Claims</h3>
                        <span class="chart-badge">Current Period</span>
                    </div>
                    <div class="chart-container tall"><canvas id="topHospitalsChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"> Top 10 by Cost</h3>
                    </div>
                    <div class="chart-container tall"><canvas id="topHospitalsCostChart"></canvas></div>
                </div>
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title"> Hospital Details</h3>
                    </div>
                    <div style="overflow-x:auto;">
                        <table class="data-table" id="hospitalsTable">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Hospital/Provider</th>
                                    <th>Claims</th>
                                    <th>Total Cost</th>
                                    <th>Avg Cost</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody id="hospitalsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- GEOGRAPHIC DISTRIBUTION Section -->
        <section class="section">
            <h2 class="section-title"> Geographic Distribution</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"> Claims by Region</h3>
                        <span class="chart-badge">Philippines</span>
                    </div>
                    <div class="chart-container"><canvas id="geoRegionChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"> Cost by Region</h3>
                    </div>
                    <div class="chart-container"><canvas id="geoCostChart"></canvas></div>
                </div>
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title"> Top Cities</h3>
                    </div>
                    <div class="stats-mini-grid" style="grid-template-columns: repeat(5, 1fr); margin-bottom:1rem;">
                        <div class="stat-mini" style="border-left:4px solid #4CAF50;">
                            <div style="font-size:1.8rem;font-weight:700;color:#4CAF50" id="geoManila">-</div>
                            <div style="font-size:0.9rem;color:var(--text-muted)">Metro Manila</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #2196F3;">
                            <div style="font-size:1.8rem;font-weight:700;color:#2196F3" id="geoCebu">-</div>
                            <div style="font-size:0.9rem;color:var(--text-muted)">Cebu</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #FF9800;">
                            <div style="font-size:1.8rem;font-weight:700;color:#FF9800" id="geoDavao">-</div>
                            <div style="font-size:0.9rem;color:var(--text-muted)">Davao</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37;">
                            <div style="font-size:1.8rem;font-weight:700;color:#D4AF37" id="geoIloilo">-</div>
                            <div style="font-size:0.9rem;color:var(--text-muted)">Iloilo</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #607D8B;">
                            <div style="font-size:1.8rem;font-weight:700;color:#607D8B" id="geoOther">-</div>
                            <div style="font-size:0.9rem;color:var(--text-muted)">Other</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="geoCitiesChart"></canvas></div>
                </div>
            </div>
        </section>

        <!--  -->
        <!-- FINANCE SECTION -->
        <!--  -->
        <div class="section-divider">
            <span class="section-divider-icon"></span>
            <span class="section-divider-text">FINANCE</span>
        </div>

        <!-- FEES BREAKDOWN Section -->
        <section class="section">
            <h2 class="section-title"> Fees & Charges Breakdown</h2>
            <div class="stats-mini-grid">
                <div class="stat-mini">
                    <div class="stat-mini-icon"></div>
                    <div class="stat-mini-value" id="auditFee">15%</div>
                    <div class="stat-mini-label">Audit Fee</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon"></div>
                    <div class="stat-mini-value" id="registrationFee">$24</div>
                    <div class="stat-mini-label">Registration Fee (Annual)</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon"></div>
                    <div class="stat-mini-value" id="monthlyFee">$9</div>
                    <div class="stat-mini-label">Monthly Fee (Annual)</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon"></div>
                    <div class="stat-mini-value" id="dentalFee" style="font-size:1.8rem">Yes</div>
                    <div class="stat-mini-label">Dental Coverage</div>
                    <div style="font-size:0.9rem;color:var(--text-muted);margin-top:0.25rem">(via CBMS)</div>
                </div>
            </div>
            <div class="chart-grid" style="margin-top:1.5rem">
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title"> Annualized Cost Breakdown</h3>
                        <span class="chart-badge">Per Member</span>
                    </div>
                    <div class="chart-container"><canvas id="costBreakdownChart"></canvas></div>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="comparison-banner">
                <div class="comparison-header">
                    <h2 class="section-title" style="margin:0"> Period Comparison</h2>
                    <span class="period-badge" id="cmpPeriodLabel">Q3 vs Q2 2025</span>
                </div>
                <div class="comparison-grid">
                    <div class="cmp-card">
                        <div class="cmp-label">Total Claims</div>
                        <div class="cmp-values">
                            <span class="cmp-current" id="cmpClaims">-</span>
                            <span class="cmp-previous" id="cmpClaimsPrev">-</span>
                        </div>
                        <span class="cmp-change" id="cmpClaimsChange">-</span>
                    </div>
                    <div class="cmp-card">
                        <div class="cmp-label">Total Members</div>
                        <div class="cmp-values">
                            <span class="cmp-current" id="cmpMembers">-</span>
                            <span class="cmp-previous" id="cmpMembersPrev">-</span>
                        </div>
                        <span class="cmp-change" id="cmpMembersChange">-</span>
                    </div>
                    <div class="cmp-card">
                        <div class="cmp-label">Approved (USD)</div>
                        <div class="cmp-values">
                            <span class="cmp-current" id="cmpApproved">-</span>
                            <span class="cmp-previous" id="cmpApprovedPrev">-</span>
                        </div>
                        <span class="cmp-change" id="cmpApprovedChange">-</span>
                    </div>
                    <div class="cmp-card">
                        <div class="cmp-label">Cost per Member</div>
                        <div class="cmp-values">
                            <span class="cmp-current" id="cmpCost">-</span>
                            <span class="cmp-previous" id="cmpCostPrev">-</span>
                        </div>
                        <span class="cmp-change" id="cmpCostChange">-</span>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="section">
            <h2 class="section-title"> Financial Analytics</h2>
            <div class="chart-grid">
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title"> Cost per Member Trend</h3>
                        <span class="chart-badge">Historical</span>
                    </div>
                    <div class="chart-container tall"><canvas id="costTrendChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"> Approved Amounts</h3>
                    </div>
                    <div class="chart-container"><canvas id="approvedChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"> Cost vs Target</h3>
                        <span class="chart-badge">Gauge</span>
                    </div>
                    <div class="gauge-container">
                        <canvas id="gaugeChart" width="200" height="200"></canvas>
                        <div class="gauge-value" id="gaugeValue">$0</div>
                        <div class="gauge-label">Cost per Member</div>
                        <div class="gauge-target">Target: <span>$50.00</span></div>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="section">
            <h2 class="section-title"> Claims Analysis</h2>
            <div class="chart-grid three">
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title"> Claims by Period</h3></div>
                    <div class="chart-container"><canvas id="claimsPeriodChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title"> Claims per 1000</h3></div>
                    <div class="chart-container"><canvas id="claims1000Chart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title"> Avg Claim Value</h3></div>
                    <div class="chart-container"><canvas id="avgClaimChart"></canvas></div>
                </div>
            </div>
        </section>
        
        <section class="section">
            <h2 class="section-title"> Plan Performance</h2>
            <div class="stats-mini-grid" style="margin-bottom:1.5rem">
                <div class="stat-mini">
                    <div class="stat-mini-icon"></div>
                    <div class="stat-mini-value" id="goldMembers">60%</div>
                    <div class="stat-mini-label">Gold Members</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon"></div>
                    <div class="stat-mini-value" id="platMembers">25%</div>
                    <div class="stat-mini-label">Platinum</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon"></div>
                    <div class="stat-mini-value" id="silverMembers">15%</div>
                    <div class="stat-mini-label">Silver</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon"></div>
                    <div class="stat-mini-value" id="totalActive">-</div>
                    <div class="stat-mini-label">Total Active</div>
                </div>
            </div>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"> Member Distribution</h3>
                        <span class="chart-badge">3D Pie</span>
                    </div>
                    <div class="chart-container"><canvas id="planPieChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title"> Cost by Plan</h3></div>
                    <div class="chart-container"><canvas id="planCostChart"></canvas></div>
                </div>
            </div>
        </section>
        
        <section class="section">
            <h2 class="section-title"> Utilization Metrics</h2>
            <div class="chart-grid three">
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title"> Utilization Trend</h3></div>
                    <div class="chart-container"><canvas id="utilizationChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title"> Key Metrics</h3></div>
                    <div style="padding:1rem 0">
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-label">Utilization Rate</span>
                                <span class="progress-value" id="utilValue">0%</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" id="utilBar" style="width:0%"></div></div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-label">Claims Ratio</span>
                                <span class="progress-value" id="claimsRatioValue">30%</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" id="claimsRatioBar" style="width:30%"></div></div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-label">Cost Efficiency</span>
                                <span class="progress-value" id="effValue">75%</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" id="effBar" style="width:75%"></div></div>
                        </div>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title"> AI Insights</h3></div>
                    <div class="insights-list" id="insightsList"></div>
                </div>
            </div>
        </section>
        
        <!--  -->
        <!-- CBMS STATISTICS SECTION -->
        <!--  -->
        <div class="section-divider">
            <span class="section-divider-icon"></span>
            <span class="section-divider-text">CBMS REPORT TOTALS</span>
        </div>
        
        <!-- CBMS Summary Stats -->
        <section class="section">
            <h2 class="section-title"> Report Summary</h2>
            <div class="cbms-stats-grid">
                <div class="cbms-stat-card">
                    <div class="cbms-stat-icon"></div>
                    <div class="cbms-stat-value" id="cbmsOrganisations">-</div>
                    <div class="cbms-stat-label">Organisations</div>
                </div>
                <div class="cbms-stat-card">
                    <div class="cbms-stat-icon"></div>
                    <div class="cbms-stat-value" id="cbmsClaims">4,002</div>
                    <div class="cbms-stat-label">Total Claims</div>
                </div>
                <div class="cbms-stat-card">
                    <div class="cbms-stat-icon"></div>
                    <div class="cbms-stat-value" id="cbmsMembers">9,544</div>
                    <div class="cbms-stat-label">Total Members</div>
                </div>
                <div class="cbms-stat-card highlight-gold">
                    <div class="cbms-stat-icon"></div>
                    <div class="cbms-stat-value" id="cbmsApproved">18,612,794</div>
                    <div class="cbms-stat-label">Approved Amount</div>
                </div>
                <div class="cbms-stat-card">
                    <div class="cbms-stat-icon"></div>
                    <div class="cbms-stat-value" id="cbmsInvoiced">0</div>
                    <div class="cbms-stat-label">Invoiced Amount</div>
                </div>
                <div class="cbms-stat-card highlight-green">
                    <div class="cbms-stat-icon"></div>
                    <div class="cbms-stat-value" id="cbmsTotalAmount">18,612,794</div>
                    <div class="cbms-stat-label">Total Amount</div>
                </div>
            </div>
        </section>
        
        <!-- CBMS Financial Details -->
        <section class="section">
            <h2 class="section-title"> Financial Breakdown</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"> Ex Gratia & Totals</h3>
                    </div>
                    <div class="cbms-detail-grid">
                        <div class="cbms-detail-item">
                            <span class="cbms-detail-label">Ex Gratia</span>
                            <span class="cbms-detail-value" id="cbmsExGratia">0.00</span>
                        </div>
                        <div class="cbms-detail-item">
                            <span class="cbms-detail-label">Total incl Ex Gratia</span>
                            <span class="cbms-detail-value" id="cbmsTotalInclExGratia">18,612,794</span>
                        </div>
                        <div class="cbms-detail-item">
                            <span class="cbms-detail-label">Average incl ExGr</span>
                            <span class="cbms-detail-value" id="cbmsAvgInclExGr">4,650.87</span>
                        </div>
                        <div class="cbms-detail-item">
                            <span class="cbms-detail-label">Net Average</span>
                            <span class="cbms-detail-value" id="cbmsNetAvg">4,650.87</span>
                        </div>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title"> Per Capita & Payments</h3>
                    </div>
                    <div class="cbms-detail-grid">
                        <div class="cbms-detail-item highlight">
                            <span class="cbms-detail-label">Per Capita</span>
                            <span class="cbms-detail-value gold" id="cbmsPerCapita">1,950.21</span>
                        </div>
                        <div class="cbms-detail-item">
                            <span class="cbms-detail-label">Paid to HM</span>
                            <span class="cbms-detail-value" id="cbmsPaidToHM">13,110,793</span>
                        </div>
                        <div class="cbms-detail-item">
                            <span class="cbms-detail-label">Charged to Customer</span>
                            <span class="cbms-detail-value" id="cbmsChargedCustomer">10,080,773</span>
                        </div>
                        <div class="cbms-detail-item">
                            <span class="cbms-detail-label">Fees to Customer</span>
                            <span class="cbms-detail-value" id="cbmsFeesCustomer">1,501,664</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- CBMS Total to Customer -->
        <section class="section">
            <div class="cbms-total-banner">
                <div class="cbms-total-label"> TOTAL TO CUSTOMER</div>
                <div class="cbms-total-value" id="cbmsTotalToCustomer">11,582,437.09</div>
                <div class="cbms-total-subtext">Combined charges and fees billed to customers</div>
            </div>
        </section>
        
        <section class="section">
            <div class="data-table-container">
                <div class="table-header">
                    <h3 class="section-title" style="margin:0"> Historical Data</h3>
                    <input type="text" class="table-search" placeholder="Search..." id="tableSearch">
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th><th>Period</th><th>Members</th><th>Claims</th>
                            <th>PHP</th><th>USD</th><th>Cost/Member</th><th>Util %</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable"></tbody>
                </table>
            </div>
        </section>
    </main>
    
    <!-- Email Center Modal -->
    <div class="email-center-modal hidden" id="emailCenterModal">
        <div class="email-center-box">
            <div class="email-center-header">
                <h2> Email Center</h2>
                <button class="email-center-close" onclick="closeEmailCenter()"></button>
            </div>
            <div class="email-center-content">
                <!-- Tabs -->
                <div class="email-tabs">
                    <button class="email-tab active" onclick="switchEmailTab('compose')"> Compose</button>
                    <button class="email-tab" onclick="switchEmailTab('templates')"> Templates</button>
                    <button class="email-tab" onclick="switchEmailTab('history')"> History</button>
                    <button class="email-tab" onclick="switchEmailTab('bulk')" style="background: linear-gradient(135deg, #ff6b6b, #ee5a5a);"> Bulk Send</button>
                    <button class="email-tab" onclick="switchEmailTab('scheduler')" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2);"> Scheduler</button>
                </div>
                
                <!-- Compose Tab -->
                <div id="emailTabCompose" class="email-tab-content">
                    <div class="email-form-group">
                        <label> Select Template</label>
                        <select class="email-select" id="emailTemplate" onchange="handleTemplateChange()">
                            <option value="">-- Select a template --</option>
                            <optgroup label=" Contract">
                                <option value="contract_01">New Contract Documents</option>
                            </optgroup>
                            <optgroup label=" Client Communication">
                                <option value="welcome_01">Welcome New Client</option>
                                <option value="meeting_01">Post-Meeting Follow-up</option>
                            </optgroup>
                            <optgroup label=" Renewals">
                                <option value="renewal_01">Contract Renewal Reminder</option>
                            </optgroup>
                            <optgroup label=" Financial">
                                <option value="balance_01">Outstanding Balance</option>
                                <option value="revolving_01">Revolving Fund Alert</option>
                            </optgroup>
                            <optgroup label=" Wishes">
                                <option value="wishes_01">Holiday Wishes</option>
                                <option value="wishes_02">Easter Wishes</option>
                                <option value="wishes_03">Birthday Wishes</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="email-form-group">
                        <label> Select Client</label>
                        <select class="email-select" id="emailClient" onchange="loadClientContacts()">
                            <option value="">-- Select a client --</option>
                        </select>
                    </div>
                    
                    <!-- Meeting Options - Shows only for meeting_01 template -->
                    <div id="meetingOptionsBox" style="display: none; background: var(--bg-dark); border: 1px solid #9c27b0; border-radius: 10px; padding: 1rem; margin-bottom: 1rem;">
                        <h4 style="color: #9c27b0; margin: 0 0 1rem 0;"> Meeting Follow-up Options</h4>
                        
                        <div class="email-form-group" style="margin-bottom: 1rem;">
                            <label> Greeting Type</label>
                            <select class="email-select" id="meetingGreeting" onchange="updateMeetingPreview()">
                                <option value="personal"> Personal (Contact Name)</option>
                                <option value="company"> Company (Client Name + Team)</option>
                                <option value="generic"> Generic (Dear All)</option>
                            </select>
                        </div>
                        
                        <div class="email-form-group" style="margin-bottom: 0;">
                            <label> Team Members who attended the meeting</label>
                            <div class="email-recipients-box" id="teamMembersList" style="max-height: 200px;">
                                <p style="color: var(--text-muted); text-align: center; padding: 1rem;">Loading team members...</p>
                            </div>
                            <div class="email-actions" style="margin-top: 0.5rem;">
                                <button class="email-action-btn" onclick="selectAllTeamMembers()"> Select All</button>
                                <button class="email-action-btn" onclick="clearAllTeamMembers()"> Clear All</button>
                                <span style="color: var(--text-muted); font-size: 0.85rem; margin-left: 1rem;" id="teamMemberCount">0 selected</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="email-form-group">
                        <label> Recipients</label>
                        <div class="email-recipients-box" id="emailRecipients">
                            <p style="color: var(--text-muted); text-align: center; padding: 1rem;">
                                Select a client to see available contacts
                            </p>
                        </div>
                        <div class="email-actions">
                            <button class="email-action-btn" onclick="selectAllRecipients()"> Select All</button>
                            <button class="email-action-btn" onclick="selectByRole('Primary')"> Primary Only</button>
                            <button class="email-action-btn" onclick="selectByRole('Finance')"> Finance</button>
                            <button class="email-action-btn" onclick="selectByRole('Operations')"> Operations</button>
                            <button class="email-action-btn" onclick="clearAllRecipients()"> Clear All</button>
                        </div>
                    </div>
                    
                    <div class="email-form-group">
                        <label> Subject</label>
                        <input type="text" class="email-input" id="emailSubject" placeholder="Email subject...">
                    </div>
                    
                    <div class="email-form-group">
                        <label> Additional Email (optional)</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="email" class="email-input" id="emailAdditional" placeholder="additional@email.com" style="flex:1;">
                            <button class="email-action-btn" onclick="addAdditionalEmail()" style="padding: 0.8rem 1rem;">Add</button>
                        </div>
                    </div>
                    
                    <div class="email-form-group">
                        <label> Message Preview</label>
                        <div class="email-preview-box" id="emailPreviewBox">
                            <p style="color: #999; text-align: center;">Select a template to see preview</p>
                        </div>
                    </div>
                    
                    <div id="emailStatus"></div>
                    
                    <div class="email-btn-row">
                        <button class="email-btn email-btn-preview" onclick="previewEmail()"> Preview</button>
                        <button class="email-btn email-btn-send" id="emailSendBtn" onclick="sendEmail()" disabled>
                             Send Email
                        </button>
                    </div>
                </div>
                
                <!-- Templates Tab -->
                <div id="emailTabTemplates" class="email-tab-content" style="display:none;">
                    <div class="email-form-group">
                        <label> Filter by Category</label>
                        <select class="email-select" id="templateFilter" onchange="filterTemplates()">
                            <option value="all">All Templates</option>
                            <option value="contract"> Contract</option>
                            <option value="client"> Client</option>
                            <option value="finance"> Financial</option>
                            <option value="alert"> Alerts</option>
                            <option value="wishes"> Wishes</option>
                        </select>
                    </div>
                    <div id="templatesList">
                        <!-- Templates will be loaded here -->
                    </div>
                </div>
                
                <!-- History Tab -->
                <div id="emailTabHistory" class="email-tab-content" style="display:none;">
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--bg-dark);">
                                    <th style="padding: 0.75rem; text-align: left; color: var(--text-secondary);">Date</th>
                                    <th style="padding: 0.75rem; text-align: left; color: var(--text-secondary);">Client</th>
                                    <th style="padding: 0.75rem; text-align: left; color: var(--text-secondary);">Template</th>
                                    <th style="padding: 0.75rem; text-align: left; color: var(--text-secondary);">Recipients</th>
                                    <th style="padding: 0.75rem; text-align: left; color: var(--text-secondary);">Status</th>
                                </tr>
                            </thead>
                            <tbody id="emailHistoryBody">
                                <tr>
                                    <td colspan="5" style="padding: 2rem; text-align: center; color: var(--text-muted);">
                                        Loading email history...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Bulk Send Tab -->
                <div id="emailTabBulk" class="email-tab-content" style="display:none;">
                    <div style="background: linear-gradient(135deg, #ff6b6b22, #ee5a5a11); border: 1px solid #ff6b6b; border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="color: #ff6b6b; margin: 0 0 0.5rem 0;"> Bulk Send -     Clients</h3>
                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.9rem;">   email    clients   click!</p>
                    </div>
                    
                    <div class="email-form-group">
                        <label> Select Template</label>
                        <select class="email-select" id="bulkTemplate" onchange="handleBulkTemplateChange()">
                            <option value="">-- Select a template --</option>
                            <optgroup label=" Wishes (  Bulk)">
                                <option value="wishes_01">Holiday Wishes</option>
                                <option value="wishes_02">Easter Wishes</option>
                                <option value="wishes_03">Birthday Wishes</option>
                            </optgroup>
                            <optgroup label=" Contract">
                                <option value="contract_01">New Contract Documents</option>
                                <option value="renewal_01">Contract Renewal Reminder</option>
                            </optgroup>
                            <optgroup label=" Client Communication">
                                <option value="welcome_01">Welcome New Client</option>
                                <option value="meeting_01">Post-Meeting Follow-up</option>
                            </optgroup>
                            <optgroup label=" Financial">
                                <option value="balance_01">Outstanding Balance</option>
                                <option value="revolving_01">Revolving Fund Alert</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="email-form-group">
                        <label> Select Recipients Role</label>
                        <select class="email-select" id="bulkRole">
                            <option value="Primary">Primary Contacts Only (1 per client)</option>
                            <option value="All">All Contacts (2-3 per client)</option>
                            <option value="Finance">Finance Contacts Only</option>
                            <option value="Operations">Operations Contacts Only</option>
                        </select>
                    </div>
                    
                    <div class="email-form-group">
                        <label> Select Clients</label>
                        <div class="email-recipients-box" id="bulkClientsList" style="max-height: 250px;">
                            <!-- Will be populated with all clients -->
                        </div>
                        <div class="email-actions">
                            <button class="email-action-btn" onclick="selectAllBulkClients()"> Select All</button>
                            <button class="email-action-btn" onclick="clearAllBulkClients()"> Clear All</button>
                            <span style="color: var(--text-muted); font-size: 0.85rem; margin-left: 1rem;" id="bulkClientCount">0 clients selected</span>
                        </div>
                    </div>
                    
                    <div class="email-form-group">
                        <label> Subject (    client)</label>
                        <input type="text" class="email-input" id="bulkSubject" placeholder="Email subject..." readonly>
                    </div>
                    
                    <div id="bulkStatus"></div>
                    
                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 10px; padding: 1rem; margin: 1rem 0;">
                        <p style="margin: 0; color: #856404; font-size: 0.9rem;">
                             <strong>:</strong>   <span id="bulkTotalEmails">0</span> emails. 
                             email         client.
                        </p>
                    </div>
                    
                    <div class="email-btn-row">
                        <button class="email-btn email-btn-preview" onclick="previewBulkEmail()"> Preview Sample</button>
                        <button class="email-btn email-btn-send" id="bulkSendBtn" onclick="sendBulkEmail()" disabled style="background: linear-gradient(135deg, #ff6b6b, #ee5a5a);">
                             Send to ALL Selected
                        </button>
                    </div>
                </div>
                
                <!-- Scheduler Tab -->
                <div id="emailTabScheduler" class="email-tab-content" style="display:none;">
                    <div style="background: linear-gradient(135deg, #9c27b022, #7b1fa211); border: 1px solid #9c27b0; border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="color: #9c27b0; margin: 0 0 0.5rem 0;"> Email Scheduler</h3>
                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.9rem;"> emails       </p>
                    </div>
                    
                    <!-- Schedule New Email -->
                    <div style="background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h4 style="color: var(--text-primary); margin: 0 0 1rem 0;">   Email</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="email-form-group" style="margin-bottom: 0;">
                                <label> Template</label>
                                <select class="email-select" id="scheduleTemplate">
                                    <option value="">-- Select template --</option>
                                    <optgroup label=" Wishes">
                                        <option value="wishes_01">Holiday Wishes</option>
                                        <option value="wishes_02">Easter Wishes</option>
                                        <option value="wishes_03">Birthday Wishes</option>
                                    </optgroup>
                                    <optgroup label=" Contract">
                                        <option value="contract_01">New Contract Documents</option>
                                        <option value="renewal_01">Contract Renewal Reminder</option>
                                    </optgroup>
                                    <optgroup label=" Client Communication">
                                        <option value="welcome_01">Welcome New Client</option>
                                        <option value="meeting_01">Post-Meeting Follow-up</option>
                                    </optgroup>
                                    <optgroup label=" Financial">
                                        <option value="balance_01">Outstanding Balance</option>
                                        <option value="revolving_01">Revolving Fund Alert</option>
                                    </optgroup>
                                </select>
                            </div>
                            
                            <div class="email-form-group" style="margin-bottom: 0;">
                                <label> Client</label>
                                <select class="email-select" id="scheduleClient" onchange="loadSchedulerContacts()">
                                    <option value="">-- Select client --</option>
                                    <option value="ALL"> ALL CLIENTS</option>
                                </select>
                            </div>
                            
                            <div class="email-form-group" style="margin-bottom: 0;">
                                <label> </label>
                                <input type="date" class="email-input" id="scheduleDate">
                            </div>
                            
                            <div class="email-form-group" style="margin-bottom: 0;">
                                <label> </label>
                                <input type="time" class="email-input" id="scheduleTime" value="09:00">
                            </div>
                        </div>
                        
                        <!-- Contacts Selection Box -->
                        <div id="scheduleContactsBox" style="display: none; margin-top: 1rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 10px; padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <label style="color: var(--text-primary); font-weight: 600;">  Recipients</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="email-action-btn" onclick="selectAllScheduleContacts()"> All</button>
                                    <button class="email-action-btn" onclick="selectScheduleByRole('Primary')"> Primary</button>
                                    <button class="email-action-btn" onclick="selectScheduleByRole('Finance')"> Finance</button>
                                    <button class="email-action-btn" onclick="selectScheduleByRole('Operations')"> Ops</button>
                                    <button class="email-action-btn" onclick="clearAllScheduleContacts()"> Clear</button>
                                </div>
                            </div>
                            <div class="email-recipients-box" id="scheduleContactsList" style="max-height: 200px;">
                                <!-- Contacts will be loaded here -->
                            </div>
                            <div style="margin-top: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">
                                <span id="scheduleContactCount">0</span> contacts selected
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div class="email-form-group" style="margin-bottom: 0;">
                                <label> Notes (optional)</label>
                                <input type="text" class="email-input" id="scheduleNotes" placeholder="Add a note...">
                            </div>
                            <div></div>
                        </div>
                        
                        <div id="scheduleStatus" style="margin-top: 1rem;"></div>
                        
                        <div style="margin-top: 1rem; text-align: right;">
                            <button class="email-btn" onclick="addScheduledEmail()" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2); color: white;">
                                 Schedule Email
                            </button>
                        </div>
                    </div>
                    
                    <!-- Scheduled Emails List -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="color: var(--text-primary); margin: 0;">  Emails</h4>
                            <button class="email-action-btn" onclick="loadScheduledEmails()"> Refresh</button>
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: var(--bg-dark);">
                                        <th style="padding: 0.75rem; text-align: left; color: var(--text-secondary);"> Date/Time</th>
                                        <th style="padding: 0.75rem; text-align: left; color: var(--text-secondary);"> Client</th>
                                        <th style="padding: 0.75rem; text-align: left; color: var(--text-secondary);"> Template</th>
                                        <th style="padding: 0.75rem; text-align: left; color: var(--text-secondary);"> Role</th>
                                        <th style="padding: 0.75rem; text-align: left; color: var(--text-secondary);">Status</th>
                                        <th style="padding: 0.75rem; text-align: center; color: var(--text-secondary);">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="scheduledEmailsBody">
                                    <tr>
                                        <td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-muted);">
                                            Loading scheduled emails...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Contract Center Modal -->
    <div class="contract-center-modal hidden" id="contractCenterModal">
        <div class="contract-center-box">
            <div class="contract-center-header">
                <h2> Contract Center</h2>
                <button class="contract-center-close" onclick="closeContractCenter()"></button>
            </div>
            <div class="contract-center-content">
                <div class="contract-stats">
                    <div class="contract-stat-card"><div class="contract-stat-value" id="contractStatTotal">0</div><div class="contract-stat-label">Total Contracts</div></div>
                    <div class="contract-stat-card"><div class="contract-stat-value" id="contractStatActive">0</div><div class="contract-stat-label">Active</div></div>
                    <div class="contract-stat-card"><div class="contract-stat-value" id="contractStatPending">0</div><div class="contract-stat-label">Pending</div></div>
                    <div class="contract-stat-card warning"><div class="contract-stat-value" id="contractStatExpiring">0</div><div class="contract-stat-label"> Expiring Soon</div></div>
                </div>
                
                <div class="contract-tabs">
                    <button class="contract-tab active" onclick="switchContractTab('list')"> All Contracts</button>
                    <button class="contract-tab" onclick="switchContractTab('create')"> Create New</button>
                    <button class="contract-tab" onclick="switchContractTab('templates')"> Templates</button>
                </div>
                
                <div id="contractTabList" class="contract-tab-content">
                    <div class="contract-filter-bar">
                        <div class="contract-filter-group"><label>Status</label><select id="contractFilterStatus" onchange="filterContracts()"><option value="">All</option><option value="draft">Draft</option><option value="sent">Sent</option><option value="signed">Signed</option><option value="active">Active</option></select></div>
                        <div class="contract-filter-group"><label>Type</label><select id="contractFilterType" onchange="filterContracts()"><option value="">All</option><option value="ASA">ASA</option><option value="NDA">NDA</option><option value="DPA">DPA</option></select></div>
                        <div class="contract-filter-group"><label>Client</label><select id="contractFilterClient" onchange="filterContracts()"><option value="">All</option></select></div>
                        <div class="contract-filter-group"><label>Search</label><input type="text" id="contractFilterSearch" placeholder="Search..." onkeyup="filterContracts()"></div>
                    </div>
                    <div class="contract-table-wrapper">
                        <table class="contract-table">
                            <thead><tr><th>ID</th><th>Client</th><th>Type</th><th>Status</th><th>Ver</th><th>Effective</th><th>Expiry</th><th>Actions</th></tr></thead>
                            <tbody id="contractTableBody"><tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--text-muted);">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="contractTabCreate" class="contract-tab-content" style="display:none;">
                    <!-- Client Selection -->
                    <div class="contract-form-group">
                        <label> Select Client</label>
                        <div style="display:flex;gap:0.5rem;">
                            <select class="contract-select" id="newContractClient" style="flex:1;"><option value="">-- Select Client --</option></select>
                            <button class="contract-btn contract-btn-secondary" onclick="openAddClientModal()" style="white-space:nowrap;"> New Client</button>
                        </div>
                    </div>
                    
                    <!-- Document Types -->
                    <div class="contract-form-group"><label> Document Types</label>
                        <div class="contract-checkbox-group">
                            <label class="contract-checkbox-label"><input type="checkbox" id="newContractASA" checked onchange="toggleFinancialTerms()"><span class="contract-type ASA">ASA</span> Administrative Services Agreement</label>
                            <label class="contract-checkbox-label"><input type="checkbox" id="newContractNDA" checked><span class="contract-type NDA">NDA</span> Non-Disclosure Agreement</label>
                            <label class="contract-checkbox-label"><input type="checkbox" id="newContractDPA" checked><span class="contract-type DPA">DPA</span> Data Processing Agreement</label>
                        </div>
                    </div>
                    
                    <!-- Contract Dates -->
                    <div class="contract-form-group">
                        <label> Contract Dates</label>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;">
                            <div><label style="font-size:0.8rem;color:var(--text-muted);">Effective Date</label><input type="date" class="contract-input" id="contractEffectiveDate"></div>
                            <div><label style="font-size:0.8rem;color:var(--text-muted);">Expiry Date</label><input type="date" class="contract-input" id="contractExpiryDate"></div>
                            <div style="display:flex;align-items:end;"><label class="contract-checkbox-label"><input type="checkbox" id="contractAutoRenewal" checked> Auto Renewal</label></div>
                        </div>
                    </div>
                    
                    <!-- Financial Terms (for ASA) -->
                    <div class="financial-terms-box" id="financialTermsBox">
                        <div class="financial-terms-title"> Financial Terms (for ASA)</div>
                        
                        <!-- Plan Members -->
                        <div style="margin-bottom:1.5rem;">
                            <label style="font-weight:600;margin-bottom:0.75rem;display:block;"> Anticipated Members by Plan</label>
                            <div class="financial-grid">
                                <div class="contract-form-group"><label> POLARIS GOLD (80/40)</label><input type="number" class="contract-input" id="finGold" value="0" min="0" placeholder="persons"></div>
                                <div class="contract-form-group"><label> POLARIS PLATINUM (180/40)</label><input type="number" class="contract-input" id="finPlatinum" value="0" min="0" placeholder="persons"></div>
                                <div class="contract-form-group"><label> POLARIS DIAMOND (360/60)</label><input type="number" class="contract-input" id="finDiamond" value="0" min="0" placeholder="persons"></div>
                                <div class="contract-form-group"><label> POLARIS DENTAL BENEFITS</label><input type="number" class="contract-input" id="finDentalMembers" value="0" min="0" placeholder="persons"></div>
                            </div>
                        </div>
                        
                        <!-- Fee Schedule -->
                        <div style="margin-bottom:1.5rem;">
                            <label style="font-weight:600;margin-bottom:0.75rem;display:block;"> Fee Schedule</label>
                            <div class="financial-grid">
                                <div class="contract-form-group"><label>Enrollment Fee (per person)</label><div style="display:flex;align-items:center;"><span style="padding:0 0.5rem;color:var(--text-muted);">USD</span><input type="number" class="contract-input" id="finEnrollmentFee" value="0" min="0" step="0.01"></div></div>
                                <div class="contract-form-group"><label>Plan Management Fee (per person/month)</label><div style="display:flex;align-items:center;"><span style="padding:0 0.5rem;color:var(--text-muted);">USD</span><input type="number" class="contract-input" id="finManagementFee" value="0" min="0" step="0.01"></div></div>
                                <div class="contract-form-group"><label>Plan Management Minimum (per month)</label><div style="display:flex;align-items:center;"><span style="padding:0 0.5rem;color:var(--text-muted);">USD</span><input type="number" class="contract-input" id="finManagementMin" value="0" min="0" step="0.01"></div></div>
                                <div class="contract-form-group"><label>Claim Processing Fee (% of claim)</label><div style="display:flex;align-items:center;"><input type="number" class="contract-input" id="finClaimFee" value="0" min="0" max="100" step="0.1"><span style="padding:0 0.5rem;color:var(--text-muted);">%</span></div></div>
                                <div class="contract-form-group"><label>Dental Benefit Fee (per person)</label><div style="display:flex;align-items:center;"><span style="padding:0 0.5rem;color:var(--text-muted);">USD</span><input type="number" class="contract-input" id="finDentalFee" value="0" min="0" step="0.01"></div></div>
                            </div>
                        </div>
                        
                        <!-- Fund & Running Cost -->
                        <div>
                            <label style="font-weight:600;margin-bottom:0.75rem;display:block;"> Fund & Running Cost</label>
                            <div class="financial-grid">
                                <div class="contract-form-group"><label>Fund Amount (for Contract Year)</label><div style="display:flex;align-items:center;"><span style="padding:0 0.5rem;color:var(--text-muted);">USD</span><input type="number" class="contract-input" id="finFund" value="0" min="0" step="0.01" onchange="updateFirstWarning()"></div></div>
                                <div class="contract-form-group"><label>Running Cost (for Contract Year)</label><div style="display:flex;align-items:center;"><span style="padding:0 0.5rem;color:var(--text-muted);">USD</span><input type="number" class="contract-input" id="finRunning" value="0" min="0" step="0.01"></div></div>
                                <div class="contract-form-group"><label>First Warning Amount (60%)</label><div style="display:flex;align-items:center;"><span style="padding:0 0.5rem;color:var(--text-muted);">USD</span><input type="number" class="contract-input" id="finFirstWarning" value="0" readonly style="background:var(--bg-dark);"></div></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="createContractStatus"></div>
                    <div class="contract-btn-row"><button class="contract-btn contract-btn-secondary" onclick="switchContractTab('list')">Cancel</button><button class="contract-btn contract-btn-primary" onclick="createNewContract()"> Generate Contract(s)</button></div>
                </div>
                
                <div id="contractTabTemplates" class="contract-tab-content" style="display:none;"><p style="color:var(--text-muted);margin-bottom:1rem;">Master templates for generating contracts.</p><div id="templatesListContainer"></div></div>
                
                <div id="contractDetailsView" style="display:none;">
                    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;"><button class="contract-btn contract-btn-secondary" onclick="closeContractDetails()" style="padding:0.5rem 1rem;"> Back</button><h3 id="contractDetailsTitle" style="margin:0;"></h3></div>
                    <div class="contract-details-grid"><div class="contract-details-section"><h4> Contract Info</h4><div id="contractInfoDetails"></div></div><div class="contract-details-section"><h4> Dates</h4><div id="contractDatesDetails"></div></div></div>
                    <div class="contract-details-section" style="margin-top:1.5rem;" id="contractFinancialsSection"><h4> Financial Terms</h4><div id="contractFinancialsDetails"></div></div>
                    <div class="contract-details-section" style="margin-top:1.5rem;"><h4> Version History</h4><div id="contractHistoryDetails"></div></div>
                    <div class="contract-btn-row" style="margin-top:1.5rem;"><a id="contractFolderLink" href="#" target="_blank" class="contract-btn contract-btn-secondary" style="text-decoration:none;"> Open Folder</a><a id="contractDocLink" href="#" target="_blank" class="contract-btn contract-btn-secondary" style="text-decoration:none;"> Open Document</a><button id="contractActionBtn" class="contract-btn contract-btn-primary"></button></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Offers Center Modal -->
    <div class="offers-center-modal hidden" id="offersCenterModal">
        <div class="offers-center-box">
            <div class="offers-center-header">
                <h2> Offers Center</h2>
                <button class="offers-center-close" onclick="closeOffersCenter()"></button>
            </div>
            <div class="offers-center-content">
                <!-- Stats -->
                <div class="offers-stats">
                    <div class="offer-stat-card total"><div class="offer-stat-value" id="offerStatTotal">0</div><div class="offer-stat-label">Total Offers</div></div>
                    <div class="offer-stat-card draft"><div class="offer-stat-value" id="offerStatDraft">0</div><div class="offer-stat-label">Draft</div></div>
                    <div class="offer-stat-card sent"><div class="offer-stat-value" id="offerStatSent">0</div><div class="offer-stat-label">Sent</div></div>
                    <div class="offer-stat-card accepted"><div class="offer-stat-value" id="offerStatAccepted">0</div><div class="offer-stat-label">Accepted</div></div>
                    <div class="offer-stat-card rejected"><div class="offer-stat-value" id="offerStatRejected">0</div><div class="offer-stat-label">Rejected</div></div>
                </div>
                
                <!-- Tabs -->
                <div class="offers-tabs">
                    <button class="offers-tab active" onclick="switchOffersTab('list')"> All Offers</button>
                    <button class="offers-tab" onclick="switchOffersTab('create')"> Create New Offer</button>
                </div>
                
                <!-- Tab: All Offers -->
                <div id="offersTabList" class="offers-tab-content">
                    <div style="background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden;">
                        <table class="offers-table">
                            <thead>
                                <tr>
                                    <th>Offer ID</th>
                                    <th>Client</th>
                                    <th>Date</th>
                                    <th>Members</th>
                                    <th>Total USD</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="offersTableBody">
                                <tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted);">Loading offers...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Tab: Create New Offer - POLARIS V4 EXACT INTERFACE -->
                <div id="offersTabCreate" class="offers-tab-content" style="display:none;">
                    <div style="background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%); border-radius: 12px; overflow: hidden;">
                        
                        <!-- POLARIS HEADER -->
                        <div style="background: #1e3a5f; color: white; padding: 15px 25px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 40px; height: 40px; background: #d4a843; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px;"></div>
                                <div>
                                    <h1 style="font-size: 20px; font-weight: 600; margin: 0;">POLARIS <span style="color: #d4a843;">Offer Creator</span></h1>
                                    <p style="font-size: 11px; opacity: 0.8; margin: 0;">TPA Healthcare Solutions</p>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 25px;">
                                <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 8px 18px; border-radius: 8px;">
                                    <div style="font-size: 10px; opacity: 0.8; text-transform: uppercase;">Offer ID</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #d4a843;" id="offerDisplayId">OFF-2026-0001</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 11px; opacity: 0.8;">Created Date</div>
                                    <div style="font-size: 16px; font-weight: 600;" id="offerCreatedDate"></div>
                                </div>
                            </div>
                        </div>

                        <!-- MAIN CONTENT -->
                        <div style="background: white; padding: 25px; border-radius: 0 0 12px 12px;">
                            
                            <!-- Select Client Section -->
                            <div style="margin-bottom: 25px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #d4a843;">
                                    <div style="width: 32px; height: 32px; background: #1e3a5f; color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center;"></div>
                                    <h2 style="color: #1e3a5f; font-size: 18px; margin: 0;">Select Client</h2>
                                </div>
                                <select id="offerClientSelect" onchange="handleOfferClientChange()" style="width: 100%; padding: 15px; font-size: 16px; border: 2px solid #dee2e6; border-radius: 8px; background: white; cursor: pointer; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%231e3a5f%22 stroke-width=%222%22><polyline points=%226 9 12 15 18 9%22/></svg>'); background-repeat: no-repeat; background-position: right 15px center; background-size: 20px;">
                                    <option value="">-- Select a client or enter new --</option>
                                    <option value="new">+ Add New Client</option>
                                </select>
                                <!-- Client form is now in the Add New Client modal -->
                            </div>

                            <!-- Population Tier Section -->
                            <div style="margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%); border-radius: 12px; border: 2px solid #d4a843;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="color: #1e3a5f; font-size: 16px; margin: 0;"> Population Tier (affects pricing)</h3>
                                    <div id="currentTierBadge" style="background: #d4a843; color: #1e3a5f; padding: 5px 15px; border-radius: 20px; font-weight: 600; font-size: 14px;">Tier 1: 1-500 members</div>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="offer-tier-btn active" data-tier="1" data-min="1" data-max="500" onclick="selectOfferTier(this)" style="flex: 1; padding: 15px 12px; border: 2px solid #1e3a5f; border-radius: 8px; background: #1e3a5f; color: white; cursor: pointer; text-align: center; transition: all 0.3s;">
                                        <div style="font-weight: 600; font-size: 15px;">1 - 500</div>
                                        <div style="font-size: 11px; opacity: 0.8;">Standard</div>
                                    </button>
                                    <button class="offer-tier-btn" data-tier="2" data-min="501" data-max="750" onclick="selectOfferTier(this)" style="flex: 1; padding: 15px 12px; border: 2px solid #dee2e6; border-radius: 8px; background: white; color: #333; cursor: pointer; text-align: center; transition: all 0.3s;">
                                        <div style="font-weight: 600; font-size: 15px;">501 - 750</div>
                                        <div style="font-size: 11px; opacity: 0.7;">Tier 2</div>
                                    </button>
                                    <button class="offer-tier-btn" data-tier="3" data-min="751" data-max="1100" onclick="selectOfferTier(this)" style="flex: 1; padding: 15px 12px; border: 2px solid #dee2e6; border-radius: 8px; background: white; color: #333; cursor: pointer; text-align: center; transition: all 0.3s;">
                                        <div style="font-weight: 600; font-size: 15px;">751 - 1100</div>
                                        <div style="font-size: 11px; opacity: 0.7;">Tier 3</div>
                                    </button>
                                    <button class="offer-tier-btn" data-tier="4" data-min="1101" data-max="9999" onclick="selectOfferTier(this)" style="flex: 1; padding: 15px 12px; border: 2px solid #dee2e6; border-radius: 8px; background: white; color: #333; cursor: pointer; text-align: center; transition: all 0.3s;">
                                        <div style="font-weight: 600; font-size: 15px;">1100+</div>
                                        <div style="font-size: 11px; opacity: 0.7;">Enterprise</div>
                                    </button>
                                </div>
                            </div>

                            <!-- Select Health Plans Section -->
                            <div style="margin-bottom: 25px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #d4a843;">
                                    <div style="width: 32px; height: 32px; background: #1e3a5f; color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center;"></div>
                                    <h2 style="color: #1e3a5f; font-size: 18px; margin: 0;">Select Health Plans</h2>
                                </div>
                                <div id="offerPlansGrid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                    <!-- Plans will be rendered here by JavaScript -->
                                </div>
                            </div>

                            <!-- Custom Plans Section -->
                            <div style="margin-bottom: 25px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #6f42c1;">
                                    <div style="width: 32px; height: 32px; background: #6f42c1; color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center;"></div>
                                    <h2 style="color: #1e3a5f; font-size: 18px; margin: 0;">Custom Plans</h2>
                                </div>
                                <div onclick="openCustomPlanModal()" style="border: 2px dashed #6f42c1; border-radius: 12px; padding: 25px; text-align: center; cursor: pointer; background: linear-gradient(135deg, #f8f5ff 0%, #efe8ff 100%); transition: all 0.3s;">
                                    <div style="font-size: 36px; margin-bottom: 8px; color: #6f42c1;"></div>
                                    <div style="font-size: 16px; font-weight: 600; color: #6f42c1; margin-bottom: 5px;">Create Custom Plan</div>
                                    <div style="font-size: 13px; color: #666;">Define your own benefits and pricing</div>
                                </div>
                                <div id="customPlansContainer" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                                    <!-- Custom plans will be rendered here -->
                                </div>
                            </div>

                            <!-- Dental Benefits Section -->
                            <div style="margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, #e8f4f8 0%, #d4e8f0 100%); border-radius: 12px; border: 2px solid #b8d4e3;">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <input type="checkbox" id="offerDentalCheckbox" onchange="calculateOfferTotals()" style="width: 22px; height: 22px; cursor: pointer; accent-color: #1e3a5f;">
                                    <div style="flex: 1;">
                                        <h3 style="color: #1e3a5f; margin: 0 0 5px 0; font-size: 16px;"> Dental Benefits Plan</h3>
                                        <p style="color: #666; font-size: 13px; margin: 0;">Comprehensive dental coverage including prophylaxis, fillings, extractions, and consultations through accredited providers.</p>
                                    </div>
                                    <div style="font-size: 22px; font-weight: 700; color: #1e3a5f;">
                                        $9.50<span style="font-size: 13px; font-weight: normal;">/member/year</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Validity Section -->
                            <div style="margin-bottom: 25px; padding: 12px 20px; background: #f8f9fa; border-radius: 10px; display: flex; align-items: center; gap: 12px;">
                                <span style="font-weight: 500; color: #1e3a5f;"> Offer Valid for</span>
                                <input type="number" id="offerValidityDays" value="30" min="1" max="90" onchange="updateOfferValidityDate()" style="width: 70px; padding: 8px; border: 2px solid #dee2e6; border-radius: 6px; text-align: center; font-size: 15px; font-weight: 600;">
                                <span style="color: #666;">days</span>
                                <span style="margin-left: auto; color: #1e3a5f; font-weight: 600;">Expires: <span id="offerExpiryDate"></span></span>
                            </div>

                            <!-- Cost Summary Section -->
                            <div style="background: linear-gradient(135deg, #1e3a5f 0%, #2c4a6e 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); flex-wrap: wrap; gap: 15px;">
                                    <h2 style="font-size: 20px; margin: 0;"> Cost Summary</h2>
                                    <div style="background: #d4a843; color: #1e3a5f; padding: 12px 28px; border-radius: 25px; font-weight: 700; font-size: 18px;">
                                        <span id="offerTotalPrincipals">0</span> Principals + <span id="offerTotalDependents">0</span> Dependents = <span id="offerGrandTotalMembers" style="font-size: 22px;">0</span> Members
                                    </div>
                                </div>

                                <!-- Plan Breakdown -->
                                <div id="offerPlanBreakdown" style="margin-bottom: 20px;"></div>

                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                        <div style="font-size: 11px; opacity: 0.8; margin-bottom: 5px; text-transform: uppercase;">Registration Fees</div>
                                        <div style="font-size: 22px; font-weight: 700;">$<span id="offerRegTotal">0</span></div>
                                    </div>
                                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                        <div style="font-size: 11px; opacity: 0.8; margin-bottom: 5px; text-transform: uppercase;">Fund Deposits</div>
                                        <div style="font-size: 22px; font-weight: 700;">$<span id="offerFundTotal">0</span></div>
                                    </div>
                                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                        <div style="font-size: 11px; opacity: 0.8; margin-bottom: 5px; text-transform: uppercase;">Dental Benefits</div>
                                        <div style="font-size: 22px; font-weight: 700;">$<span id="offerDentalTotal">0</span></div>
                                    </div>
                                </div>

                                <div style="background: #d4a843; color: #1e3a5f; padding: 18px 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <div style="font-size: 16px; font-weight: 600;">TOTAL ANNUAL COST</div>
                                    <div style="font-size: 28px; font-weight: 700;">$<span id="offerAnnualTotal">0</span></div>
                                </div>
                            </div>

                            <!-- Action Buttons - EXACTLY LIKE POLARIS V4 -->
                            <div style="display: grid; grid-template-columns: 1fr 1.5fr 1fr 1fr; gap: 12px;">
                                <button onclick="resetOfferForm()" style="padding: 14px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #6c757d; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s;">
                                     Reset
                                </button>
                                <button onclick="generateOfferEmailPreview()" style="padding: 14px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #d4a843; color: #1e3a5f; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s;">
                                     Generate Offer Email
                                </button>
                                <button onclick="generateOfferDocument()" style="padding: 14px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #1e3a5f; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s;">
                                     Generate Offer Document
                                </button>
                                <button onclick="saveOfferDraft()" style="padding: 14px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #28a745; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s;">
                                     Save Offer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Custom Plan Modal -->
                <div id="customPlanModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center;">
                    <div style="background: white; width: 90%; max-width: 700px; border-radius: 12px; overflow: hidden; max-height: 90vh; overflow-y: auto;">
                        <div style="background: #6f42c1; color: white; padding: 18px 25px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0;">
                            <h3 style="margin: 0; font-size: 18px;"> Create Custom Plan</h3>
                            <button onclick="closeCustomPlanModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        <div style="padding: 25px;">
                            <!-- Plan Name -->
                            <div style="margin-bottom: 18px;">
                                <label style="display: block; font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 6px; font-weight: 500;">Plan Name *</label>
                                <input type="text" id="customPlanName" placeholder="e.g., EXECUTIVE PLUS" style="width: 100%; padding: 12px 15px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 15px;">
                            </div>
                            
                            <!-- Benefits Section -->
                            <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 18px;">
                                <h4 style="margin: 0 0 12px 0; color: #1e3a5f; font-size: 14px;"> BENEFIT LIMITS</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Annual Max Benefit - MBL (PHP)</label>
                                        <input type="number" id="customMBL" placeholder="e.g., 200000" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Outpatient Limit - OPBL (PHP)</label>
                                        <input type="number" id="customOPBL" placeholder="e.g., 60000" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Fees Section (from ASA Contract) -->
                            <div style="background: #fff9e6; padding: 15px; border-radius: 8px; margin-bottom: 18px; border: 1px solid #d4a843;">
                                <h4 style="margin: 0 0 12px 0; color: #1e3a5f; font-size: 14px;"> TPA FEES (per ASA Contract)</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Enrollment/Registration Fee (USD)</label>
                                        <input type="number" id="customRegFee" placeholder="e.g., 24" step="0.01" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Fund Deposit (USD)</label>
                                        <input type="number" id="customFundDeposit" placeholder="e.g., 50" step="0.01" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Plan Management Fee (USD/month)</label>
                                        <input type="number" id="customMgmtFee" placeholder="e.g., 1.50" step="0.01" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Min. Monthly Management (USD)</label>
                                        <input type="number" id="customMgmtMin" placeholder="e.g., 500" step="0.01" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Claim Processing Fee (%)</label>
                                        <input type="number" id="customClaimFee" placeholder="e.g., 5" step="0.1" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Dental Benefit Fee (USD/year)</label>
                                        <input type="number" id="customDentalFee" placeholder="e.g., 9.50" step="0.01" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Room & Conditions -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Room Type</label>
                                    <select id="customRoomType" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                                        <option value="Ward">Ward</option>
                                        <option value="Semi-Private">Semi-Private</option>
                                        <option value="Private" selected>Private</option>
                                        <option value="Suite">Suite</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Room Rate (PHP/day)</label>
                                    <input type="number" id="customRoomRate" placeholder="e.g., 3000" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                                </div>
                            </div>
                        </div>
                        <div style="padding: 15px 25px; background: #f8f9fa; display: flex; gap: 12px; justify-content: flex-end; position: sticky; bottom: 0;">
                            <button onclick="closeCustomPlanModal()" style="padding: 12px 25px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #6c757d; color: white;">Cancel</button>
                            <button onclick="saveCustomPlan()" style="padding: 12px 25px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #6f42c1; color: white;">Save Custom Plan</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Report Builder Modal -->
    <div class="report-builder-modal hidden" id="reportBuilderModal">
        <div class="report-builder-box">
            <div class="rb-header" style="position:relative">
                <h2> Report Builder</h2>
                <p>  </p>
                <button class="rb-close" onclick="closeReportBuilder()"></button>
            </div>
            
            <div class="rb-content">
                <!-- Period Selection -->
                <div class="rb-section">
                    <div class="rb-section-title">  </div>
                    <div class="rb-period-grid">
                        <div class="rb-select-group">
                            <label></label>
                            <select class="rb-select" id="rbFromPeriod">
                                <option value=""> </option>
                                <option value="2025-Q1">Q1 2025</option>
                                <option value="2025-Q2">Q2 2025</option>
                                <option value="2025-Q3" selected>Q3 2025</option>
                                <option value="2025-Q4">Q4 2025</option>
                            </select>
                        </div>
                        <div class="rb-select-group">
                            <label></label>
                            <select class="rb-select" id="rbToPeriod">
                                <option value=""> </option>
                                <option value="2025-Q1">Q1 2025</option>
                                <option value="2025-Q2">Q2 2025</option>
                                <option value="2025-Q3" selected>Q3 2025</option>
                                <option value="2025-Q4">Q4 2025</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Templates -->
                <div class="rb-section">
                    <div class="rb-section-title">  </div>
                    <div class="rb-templates">
                        <div class="rb-template-btn" onclick="selectTemplate('board')">
                            <span></span>
                            <div>Board Meeting</div>
                        </div>
                        <div class="rb-template-btn" onclick="selectTemplate('monthly')">
                            <span></span>
                            <div> </div>
                        </div>
                        <div class="rb-template-btn" onclick="selectTemplate('executive')">
                            <span></span>
                            <div>Executive Summary</div>
                        </div>
                        <div class="rb-template-btn" onclick="selectTemplate('full')">
                            <span></span>
                            <div> </div>
                        </div>
                    </div>
                </div>
                
                <!-- Report Sections -->
                <div class="rb-section">
                    <div class="rb-section-title">  </div>
                    <div class="rb-sections-list">
                        <label class="rb-section-item selected">
                            <input type="checkbox" id="sec_executive" checked>
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title">Executive Summary</div>
                                <div class="rb-section-item-desc">  KPIs</div>
                            </div>
                            <span class="rb-section-item-badge">1 </span>
                        </label>
                        <label class="rb-section-item selected">
                            <input type="checkbox" id="sec_inout" checked>
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title"> Inpatient vs Outpatient</div>
                                <div class="rb-section-item-desc">   </div>
                            </div>
                            <span class="rb-section-item-badge">1 </span>
                        </label>
                        <label class="rb-section-item selected">
                            <input type="checkbox" id="sec_claims" checked>
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title"> Claims Analysis</div>
                                <div class="rb-section-item-desc">  </div>
                            </div>
                            <span class="rb-section-item-badge">1 </span>
                        </label>
                        <label class="rb-section-item selected">
                            <input type="checkbox" id="sec_cost" checked>
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title"> Cost Breakdown</div>
                                <div class="rb-section-item-desc">   </div>
                            </div>
                            <span class="rb-section-item-badge">1 </span>
                        </label>
                        <label class="rb-section-item">
                            <input type="checkbox" id="sec_members">
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title"> Principal vs Dependent</div>
                                <div class="rb-section-item-desc">   </div>
                            </div>
                            <span class="rb-section-item-badge">1 </span>
                        </label>
                        <label class="rb-section-item">
                            <input type="checkbox" id="sec_movement">
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title"> Member Movement</div>
                                <div class="rb-section-item-desc">, , </div>
                            </div>
                            <span class="rb-section-item-badge">1 </span>
                        </label>
                        <label class="rb-section-item">
                            <input type="checkbox" id="sec_plans">
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title"> Plan Performance</div>
                                <div class="rb-section-item-desc">   </div>
                            </div>
                            <span class="rb-section-item-badge">1 </span>
                        </label>
                        <label class="rb-section-item">
                            <input type="checkbox" id="sec_history">
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title"> Historical Data</div>
                                <div class="rb-section-item-desc">   </div>
                            </div>
                            <span class="rb-section-item-badge">2-3 </span>
                        </label>
                        <label class="rb-section-item">
                            <input type="checkbox" id="sec_trends">
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title"> Trends & Charts</div>
                                <div class="rb-section-item-desc">  </div>
                            </div>
                            <span class="rb-section-item-badge">2 </span>
                        </label>
                    </div>
                </div>
                
                <!-- Export Format -->
                <div class="rb-section">
                    <div class="rb-section-title">  </div>
                    <div class="rb-formats">
                        <div class="rb-format-btn selected" onclick="selectFormat('pdf')" id="formatPdf">
                            <span></span>
                            <div>PDF</div>
                        </div>
                        <div class="rb-format-btn" onclick="selectFormat('excel')" id="formatExcel">
                            <span></span>
                            <div>Excel</div>
                        </div>
                        <div class="rb-format-btn" onclick="selectFormat('both')" id="formatBoth">
                            <span></span>
                            <div>PDF + Excel</div>
                        </div>
                    </div>
                </div>
                
                <!-- Info Box -->
                <div class="rb-info-box">
                    <span></span>
                    <div>
                        <strong>:</strong>           .
                    </div>
                </div>
            </div>
            
            <div class="rb-footer">
                <button class="rb-btn rb-btn-cancel" onclick="closeReportBuilder()"></button>
                <button class="rb-btn rb-btn-preview" onclick="previewReport()"> </button>
                <button class="rb-btn rb-btn-generate" onclick="generateReport()">  </button>
            </div>
        </div>
    </div>

    <!-- Report Generation Modal -->
    <div class="report-modal hidden" id="reportModal">
        <div class="report-box">
            <div style="font-size:3rem;margin-bottom:1rem"></div>
            <h3 style="font-size:1.25rem;font-weight:700;margin-bottom:0.5rem" id="reportTitle">Generating Report...</h3>
            <p style="color:var(--text-secondary);margin-bottom:1rem" id="reportStatus">Preparing your personalized report</p>
            <div class="report-progress">
                <div class="report-progress-bar" id="reportProgressBar" style="width:0%"></div>
            </div>
            <p style="color:var(--text-muted);font-size:0.85rem" id="reportStep">Initializing...</p>
        </div>
    </div>
    
    <footer class="footer" id="mainFooter" style="display:none">
        <p> 2025 Polaris Financial Services. All rights reserved.</p>
        <p style="margin-top:0.5rem">Last updated: <span id="lastUpdated">-</span></p>
    </footer>
    
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxsUTp8W3R7J59r5q1bGY93dSTO8CGzrRxatcRt4PAaTUEoxVxFbEPccRjaT6OekBrn/exec';
        let currentUser = null, charts = {};
        let allClientsData = []; // Store all clients data
        let selectedClient = 'all'; // Current selection
        let compareMode = false;
        let compareClientA = null, compareClientB = null;
        
        // Quarter selection state
        let selectedQuarters = ['Q3']; // Default: Q3 selected
        let quarterCompareMode = false;
        
        // Mock quarter data (will come from API)
        const quarterData = {
            'Q1': { members: 1047, claims: 424, approved_usd: 27635, cost_per_member: 26.39 },
            'Q2': { members: 314, claims: 31, approved_usd: 1718, cost_per_member: 5.47 },
            'Q3': { members: 684, claims: 72, approved_usd: 5330, cost_per_member: 7.79 },
            'Q4': { members: 520, claims: 58, approved_usd: 4200, cost_per_member: 8.08 }
        };
        
        function toggleQuarter(quarter) {
            if (quarterCompareMode) {
                // Multi-select mode
                const index = selectedQuarters.indexOf(quarter);
                if (index > -1) {
                    // Deselect (but keep at least one)
                    if (selectedQuarters.length > 1) {
                        selectedQuarters.splice(index, 1);
                    }
                } else {
                    // Select
                    selectedQuarters.push(quarter);
                }
            } else {
                // Single select mode
                selectedQuarters = [quarter];
            }
            
            updateQuarterUI();
            loadDataForSelectedQuarters();
        }
        
        function toggleQuarterCompare() {
            quarterCompareMode = !quarterCompareMode;
            const btn = document.getElementById('quarterCompareBtn');
            
            if (quarterCompareMode) {
                btn.classList.add('active');
                btn.innerHTML = '<span></span> Compare Mode ON';
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<span></span> Compare Quarters';
                // Reset to single selection (keep first)
                selectedQuarters = [selectedQuarters[0]];
            }
            
            updateQuarterUI();
        }
        
        function updateQuarterUI() {
            // Update button states
            document.querySelectorAll('.quarter-btn').forEach(btn => {
                const q = btn.dataset.quarter;
                btn.classList.remove('active', 'compare-selected');
                
                if (selectedQuarters.includes(q)) {
                    if (quarterCompareMode && selectedQuarters.length > 1) {
                        btn.classList.add('compare-selected');
                    } else {
                        btn.classList.add('active');
                    }
                }
            });
            
            // Update badge
            const badge = document.getElementById('selectedQuartersBadge');
            if (selectedQuarters.length === 1) {
                badge.textContent = `${selectedQuarters[0]} 2025`;
            } else {
                badge.textContent = selectedQuarters.sort().join(' vs ') + ' 2025';
            }
        }
        
        function loadDataForSelectedQuarters() {
            const q = selectedQuarters[0];
            const data = quarterData[q];
            
            if (selectedQuarters.length === 1) {
                // Single quarter - show normal data
                document.getElementById('kpiMembers').textContent = fmt(data.members);
                document.getElementById('kpiClaims').textContent = fmt(data.claims);
                document.getElementById('kpiApproved').textContent = '$' + fmt(data.approved_usd);
                document.getElementById('kpiCost').textContent = '$' + data.cost_per_member.toFixed(2);
                
                // Hide comparison trends
                document.querySelectorAll('.kpi-trend').forEach(el => {
                    if (!el.textContent.includes('Target')) {
                        el.style.display = 'none';
                    }
                });
            } else {
                // Multiple quarters - show comparison
                const totals = { members: 0, claims: 0, approved_usd: 0 };
                selectedQuarters.forEach(q => {
                    totals.members += quarterData[q].members;
                    totals.claims += quarterData[q].claims;
                    totals.approved_usd += quarterData[q].approved_usd;
                });
                const avgCost = totals.members > 0 ? totals.approved_usd / totals.members : 0;
                
                document.getElementById('kpiMembers').textContent = fmt(totals.members);
                document.getElementById('kpiClaims').textContent = fmt(totals.claims);
                document.getElementById('kpiApproved').textContent = '$' + fmt(totals.approved_usd);
                document.getElementById('kpiCost').textContent = '$' + avgCost.toFixed(2);
                
                // Show comparison info
                const [q1, q2] = selectedQuarters.sort();
                const d1 = quarterData[q1], d2 = quarterData[q2];
                
                // Calculate changes
                const memberChange = ((d2.members - d1.members) / d1.members * 100).toFixed(1);
                const claimsChange = ((d2.claims - d1.claims) / d1.claims * 100).toFixed(1);
                
                // Show trends
                const membersTrend = document.getElementById('kpiMembersTrend');
                const claimsTrend = document.getElementById('kpiClaimsTrend');
                
                membersTrend.style.display = 'block';
                membersTrend.innerHTML = `${memberChange > 0 ? '' : ''} ${Math.abs(memberChange)}%`;
                membersTrend.className = `kpi-trend ${memberChange < 0 ? 'down' : 'up'}`;
                
                claimsTrend.style.display = 'block';
                claimsTrend.innerHTML = `${claimsChange > 0 ? '' : ''} ${Math.abs(claimsChange)}%`;
                claimsTrend.className = `kpi-trend ${claimsChange > 0 ? 'up' : 'down'}`;
            }
            
            // Create mock current period data for charts
            const mockCurrent = {
                period: '2025-' + q,
                period_label: q + ' 2025',
                members: data.members,
                claims: data.claims,
                approved_usd: data.approved_usd,
                cost_per_member: data.cost_per_member
            };
            
            // Build mock all_periods from quarterData
            const mockPeriods = Object.entries(quarterData).map(([key, val]) => ({
                period: '2025-' + key,
                period_label: key + ' 2025',
                members: val.members,
                claims: val.claims,
                approved_usd: val.approved_usd,
                cost_per_member: val.cost_per_member
            })).sort((a, b) => a.period.localeCompare(b.period));
            
            // Update utilization
            const util = mockCurrent.members > 0 ? (mockCurrent.claims / mockCurrent.members * 100) : 0;
            document.getElementById('kpiUtilization').textContent = util.toFixed(1) + '%';
            if (document.getElementById('totalActive')) {
                document.getElementById('totalActive').textContent = fmt(mockCurrent.members);
            }
            
            // Calculate inpatient/outpatient/ex gratia
            const inpatientCases = Math.round(mockCurrent.claims * 0.22);
            const outpatientCases = Math.round(mockCurrent.claims * 0.70);
            const exGratiaCases = mockCurrent.claims - inpatientCases - outpatientCases;
            const inpatientCostVal = Math.round(mockCurrent.approved_usd * 0.60);
            const outpatientCostVal = Math.round(mockCurrent.approved_usd * 0.32);
            const exGratiaCostVal = mockCurrent.approved_usd - inpatientCostVal - outpatientCostVal;
            
            document.getElementById('inpatientCases').textContent = fmt(inpatientCases);
            document.getElementById('outpatientCases').textContent = fmt(outpatientCases);
            document.getElementById('exGratiaCases').textContent = fmt(exGratiaCases);
            document.getElementById('inpatientCost').textContent = '$' + fmt(inpatientCostVal);
            document.getElementById('outpatientCost').textContent = '$' + fmt(outpatientCostVal);
            document.getElementById('exGratiaCost').textContent = '$' + fmt(exGratiaCostVal);
            
            // Principal/Dependent
            const principalMembers = Math.round(mockCurrent.members * 0.4);
            const dependentMembers = mockCurrent.members - principalMembers;
            document.getElementById('principalCount').textContent = fmt(principalMembers);
            document.getElementById('dependentCount').textContent = fmt(dependentMembers);
            
            // Member Movement
            const newEnroll = Math.round(mockCurrent.members * 0.08);
            const cancelled = Math.round(mockCurrent.members * 0.03);
            document.getElementById('newEnrollments').textContent = '+' + newEnroll;
            document.getElementById('cancellations').textContent = '-' + cancelled;
            document.getElementById('netChange').textContent = (newEnroll - cancelled > 0 ? '+' : '') + (newEnroll - cancelled);
            
            // Create all charts
            try { createCharts(mockPeriods, mockCurrent); } catch(e) { console.error('createCharts error:', e); }
            try { createInOutCharts(mockPeriods, inpatientCases, outpatientCases, exGratiaCases, inpatientCostVal, outpatientCostVal, exGratiaCostVal); } catch(e) { console.error('createInOutCharts error:', e); }
            try { createMemberTypeCharts(principalMembers, dependentMembers, mockCurrent.claims); } catch(e) { console.error('createMemberTypeCharts error:', e); }
            try { createMovementCharts(mockPeriods); } catch(e) { console.error('createMovementCharts error:', e); }
            try { createCostBreakdownChart(mockCurrent); } catch(e) { console.error('createCostBreakdownChart error:', e); }
            try { createCategoryCharts(mockCurrent); } catch(e) { console.error('createCategoryCharts error:', e); }
            try { createYoYCharts(mockPeriods); } catch(e) { console.error('createYoYCharts error:', e); }
            try { createHospitalCharts(); } catch(e) { console.error('createHospitalCharts error:', e); }
            try { createGeoCharts(); } catch(e) { console.error('createGeoCharts error:', e); }
            
            // Update metrics and insights
            try { updateMetrics(util); } catch(e) { console.error('updateMetrics error:', e); }
            try { updateTable(mockPeriods); } catch(e) { console.error('updateTable error:', e); }
        }
        
        // Mock clients list (will come from API)
        const clientsList = [
            { id: 'all', name: ' All Clients (Company Total)' },
            { id: 'almi_tankers', name: 'Almi Tankers' },
            { id: 'arcadia', name: 'Arcadia Shipmanagement' },
            { id: 'centrofin', name: 'Centrofin Management' },
            { id: 'chartworld', name: 'Chartworld Shipping' },
            { id: 'costamare', name: 'Costamare' },
            { id: 'danaos', name: 'Danaos Shipping' },
            { id: 'delta_tankers', name: 'Delta Tankers' },
            { id: 'dynacom', name: 'Dynacom Tankers' },
            { id: 'eastern_med', name: 'Eastern Mediterranean' },
            { id: 'eurobulk', name: 'Eurobulk' },
            { id: 'latsco', name: 'Latsco Marine' },
            { id: 'minerva', name: 'Minerva Marine' },
            { id: 'navios', name: 'Navios Maritime' },
            { id: 'neda_maritime', name: 'Neda Maritime' },
            { id: 'olympic', name: 'Olympic Shipping' },
            { id: 'prime_marine', name: 'Prime Marine' },
            { id: 'sea_pioneer', name: 'Sea Pioneer Shipping' },
            { id: 'seanergy', name: 'Seanergy Maritime' },
            { id: 'star_bulk', name: 'Star Bulk Carriers' },
            { id: 'tsakos', name: 'Tsakos Energy Navigation' }
        ];
        
        // Global Chart.js defaults for larger, more readable fonts
        Chart.defaults.font.size = 14;
        Chart.defaults.font.family = "'Open Sans', sans-serif";
        Chart.defaults.color = '#b8c9b8';
        Chart.defaults.plugins.legend.labels.font = { size: 14, weight: 'bold' };
        Chart.defaults.plugins.legend.labels.padding = 25;
        Chart.defaults.plugins.legend.labels.boxWidth = 18;
        Chart.defaults.plugins.legend.labels.boxHeight = 18;
        Chart.defaults.plugins.tooltip.titleFont = { size: 14, weight: 'bold' };
        Chart.defaults.plugins.tooltip.bodyFont = { size: 13 };
        Chart.defaults.scale.ticks.font = { size: 13, weight: '600' };
        
        function populateClientSelector() {
            const selector = document.getElementById('clientSelector');
            const compareA = document.getElementById('compareClientA');
            const compareB = document.getElementById('compareClientB');
            
            selector.innerHTML = clientsList.map(c => 
                `<option value="${c.id}">${c.name}</option>`
            ).join('');
            
            // Populate compare selectors (without "All")
            const clientsOnly = clientsList.filter(c => c.id !== 'all');
            compareA.innerHTML = clientsOnly.map(c => 
                `<option value="${c.id}">${c.name}</option>`
            ).join('');
            compareB.innerHTML = clientsOnly.map(c => 
                `<option value="${c.id}" ${c.id === 'arcadia' ? 'selected' : ''}>${c.name}</option>`
            ).join('');
        }
        
        function handleClientChange() {
            const selector = document.getElementById('clientSelector');
            selectedClient = selector.value;
            const clientName = clientsList.find(c => c.id === selectedClient)?.name || 'All Clients';
            
            document.getElementById('clientFilterBadge').textContent = clientName.replace(' ', '');
            
            // Reload dashboard with new client data
            loadData();
        }
        
        function toggleCompareMode() {
            compareMode = !compareMode;
            const panel = document.getElementById('comparePanel');
            const btn = document.getElementById('compareModeBtn');
            
            if (compareMode) {
                panel.style.display = 'block';
                btn.classList.add('active');
                btn.innerHTML = '<span></span> Cancel';
            } else {
                panel.style.display = 'none';
                btn.classList.remove('active');
                btn.innerHTML = '<span></span> Compare';
            }
        }
        
        function applyComparison() {
            compareClientA = document.getElementById('compareClientA').value;
            compareClientB = document.getElementById('compareClientB').value;
            
            const nameA = clientsList.find(c => c.id === compareClientA)?.name || compareClientA;
            const nameB = clientsList.find(c => c.id === compareClientB)?.name || compareClientB;
            
            document.getElementById('clientFilterBadge').textContent = `${nameA} vs ${nameB}`;
            
            // TODO: Load comparison data
            alert(`Comparing: ${nameA} vs ${nameB}\n\nComparison view coming soon!`);
            toggleCompareMode();
        }
        
        async function handleLogin() {
            const u = document.getElementById('loginUsername').value.trim();
            const p = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            const btn = document.querySelector('.login-btn');
            
            if (!u) { errorEl.textContent = 'Please enter username'; return; }
            if (!p) { errorEl.textContent = 'Please enter password'; return; }
            
            btn.textContent = 'Signing in...';
            btn.disabled = true;
            errorEl.textContent = '';
            
            try {
                const response = await fetch(`${API_URL}?action=login&username=${encodeURIComponent(u)}&password=${encodeURIComponent(p)}`);
                const data = await response.json();
                
                if (data.success && data.user && data.user.role === 'admin') {
                    currentUser = data.user;
                    localStorage.setItem('polaris_admin_user', JSON.stringify(currentUser));
                    showDashboard();
                } else if (data.success && data.user && data.user.role !== 'admin') {
                    errorEl.textContent = 'Access denied. Admin credentials required.';
                    btn.textContent = 'Sign In';
                    btn.disabled = false;
                } else {
                    errorEl.textContent = data.message || 'Invalid username or password';
                    btn.textContent = 'Sign In';
                    btn.disabled = false;
                }
            } catch (err) {
                console.error('Login error:', err);
                errorEl.textContent = 'Connection error. Please try again.';
                btn.textContent = 'Sign In';
                btn.disabled = false;
            }
        }
        
        function handleLogout() { 
            localStorage.removeItem('polaris_admin_user'); 
            currentUser = null;
            location.reload(); 
        }
        
        // Report Builder State
        let reportConfig = {
            fromPeriod: '2025-Q3',
            toPeriod: '2025-Q3',
            format: 'pdf',
            sections: {
                executive: true,
                inout: true,
                claims: true,
                cost: true,
                members: false,
                movement: false,
                plans: false,
                history: false,
                trends: false
            }
        };
        
        function openActiveMembers() {
            // For admin, open with selected client or all
            const clientSelector = document.getElementById('clientSelector');
            const clientId = clientSelector ? clientSelector.value : 'all';
            const url = 'https://apostolos-bizou.github.io/polaris-member-tracker/?client=' + encodeURIComponent(clientId);
            window.open(url, '_blank');
        }
        
        // 
        // EMAIL CENTER FUNCTIONS
        // 
        
        let emailTemplates = [];
        let clientContacts = [];
        let selectedTemplate = null;
        let selectedContacts = [];
        
        function openEmailCenter() {
            document.getElementById('emailCenterModal').classList.remove('hidden');
            populateEmailClients();
            loadEmailTemplates();
            loadEmailHistory();
        }
        
        function closeEmailCenter() {
            document.getElementById('emailCenterModal').classList.add('hidden');
        }
        
        function switchEmailTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.email-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide content
            document.getElementById('emailTabCompose').style.display = tab === 'compose' ? 'block' : 'none';
            document.getElementById('emailTabTemplates').style.display = tab === 'templates' ? 'block' : 'none';
            document.getElementById('emailTabHistory').style.display = tab === 'history' ? 'block' : 'none';
            document.getElementById('emailTabBulk').style.display = tab === 'bulk' ? 'block' : 'none';
            document.getElementById('emailTabScheduler').style.display = tab === 'scheduler' ? 'block' : 'none';
            
            if (tab === 'templates') loadTemplatesList();
            if (tab === 'bulk') populateBulkClients();
            if (tab === 'scheduler') { populateSchedulerClients(); loadScheduledEmails(); }
        }
        
        function populateEmailClients() {
            const select = document.getElementById('emailClient');
            select.innerHTML = '<option value="">-- Select a client --</option>';
            
            // Use clientsList (same as main dropdown) - filter out "all"
            const clients = clientsList.filter(c => c.id !== 'all');
            
            if (clients && clients.length > 0) {
                clients.forEach(client => {
                    const opt = document.createElement('option');
                    opt.value = client.id;
                    opt.textContent = client.name.replace(' ', '');
                    select.appendChild(opt);
                });
                console.log('Email clients loaded:', clients.length);
            } else {
                console.log('No clients found in clientsList');
            }
        }
        
        async function loadEmailTemplates() {
            try {
                const response = await fetch(`${API_URL}?action=getEmailTemplates`);
                const data = await response.json();
                if (data.success) {
                    emailTemplates = data.data || [];
                }
            } catch (err) {
                console.error('Error loading templates:', err);
                // Use default templates
                emailTemplates = [
                    { template_id: 'contract_01', template_name: 'New Contract Documents', category: 'contract', subject: 'Your Polaris Health Insurance Contract - {{client_name}}' },
                    { template_id: 'welcome_01', template_name: 'Welcome New Client', category: 'client', subject: 'Welcome to Polaris Financial Services, {{client_name}}!' },
                    { template_id: 'meeting_01', template_name: 'Post-Meeting Follow-up', category: 'client', subject: 'Thank You for Meeting with Polaris - Next Steps' },
                    { template_id: 'renewal_01', template_name: 'Contract Renewal Reminder', category: 'contract', subject: 'Contract Renewal Notice - {{client_name}}' },
                    { template_id: 'balance_01', template_name: 'Outstanding Balance', category: 'finance', subject: 'Payment Reminder - Outstanding Balance' },
                    { template_id: 'revolving_01', template_name: 'Revolving Fund Alert', category: 'alert', subject: 'URGENT: Revolving Fund Below 50%' },
                    { template_id: 'wishes_01', template_name: 'Holiday Wishes', category: 'wishes', subject: 'Season\'s Greetings from Polaris!' },
                    { template_id: 'wishes_02', template_name: 'Easter Wishes', category: 'wishes', subject: 'Happy Easter from Polaris!' },
                    { template_id: 'wishes_03', template_name: 'Birthday Wishes', category: 'wishes', subject: 'Happy Birthday from Polaris!' },
                ];
            }
        }
        
        async function loadClientContacts() {
            const clientId = document.getElementById('emailClient').value;
            const container = document.getElementById('emailRecipients');
            
            if (!clientId) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Select a client to see available contacts</p>';
                updateSendButton();
                return;
            }
            
            container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Loading contacts...</p>';
            
            try {
                const response = await fetch(`${API_URL}?action=getClientContacts&client_id=${clientId}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    clientContacts = data.data;
                    renderContacts();
                } else {
                    // Fallback - show message to add email manually
                    clientContacts = [];
                    container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">No contacts found. Use "Additional Email" below to add recipients.</p>';
                }
            } catch (err) {
                console.error('Error loading contacts:', err);
                // Fallback - allow manual email entry
                clientContacts = [];
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Could not load contacts. Use "Additional Email" below.</p>';
            }
            
            updateSendButton();
        }
        
        function renderContacts() {
            const container = document.getElementById('emailRecipients');
            
            if (clientContacts.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">No contacts available</p>';
                return;
            }
            
            container.innerHTML = clientContacts.map((contact, idx) => `
                <div class="email-recipient-item">
                    <input type="checkbox" id="contact_${idx}" onchange="updateSelectedContacts()">
                    <div class="email-recipient-info">
                        <div class="email-recipient-name">${contact.contact_name}</div>
                        <div class="email-recipient-email">${contact.email}</div>
                    </div>
                    <span class="email-recipient-role">${contact.role}</span>
                </div>
            `).join('');
        }
        
        function updateSelectedContacts() {
            selectedContacts = [];
            clientContacts.forEach((contact, idx) => {
                const checkbox = document.getElementById(`contact_${idx}`);
                if (checkbox && checkbox.checked) {
                    selectedContacts.push(contact);
                }
            });
            updateSendButton();
        }
        
        function selectAllRecipients() {
            clientContacts.forEach((_, idx) => {
                const checkbox = document.getElementById(`contact_${idx}`);
                if (checkbox) checkbox.checked = true;
            });
            updateSelectedContacts();
        }
        
        function clearAllRecipients() {
            clientContacts.forEach((_, idx) => {
                const checkbox = document.getElementById(`contact_${idx}`);
                if (checkbox) checkbox.checked = false;
            });
            updateSelectedContacts();
        }
        
        function selectByRole(role) {
            clientContacts.forEach((contact, idx) => {
                const checkbox = document.getElementById(`contact_${idx}`);
                if (checkbox) {
                    checkbox.checked = contact.role === role || contact.role === 'Primary';
                }
            });
            updateSelectedContacts();
        }
        
        function addAdditionalEmail() {
            const input = document.getElementById('emailAdditional');
            const email = input.value.trim();
            
            if (!email || !email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }
            
            // Add to contacts
            clientContacts.push({
                contact_name: email.split('@')[0],
                email: email,
                role: 'Additional'
            });
            
            renderContacts();
            input.value = '';
            
            // Select the new contact
            setTimeout(() => {
                const lastCheckbox = document.getElementById(`contact_${clientContacts.length - 1}`);
                if (lastCheckbox) {
                    lastCheckbox.checked = true;
                    updateSelectedContacts();
                }
            }, 100);
        }
        
        function handleTemplateChange() {
            const templateId = document.getElementById('emailTemplate').value;
            const template = emailTemplates.find(t => t.template_id === templateId);
            
            // Show/hide meeting options for meeting_01 template
            const meetingBox = document.getElementById('meetingOptionsBox');
            if (templateId === 'meeting_01') {
                meetingBox.style.display = 'block';
                loadTeamMembers();
            } else {
                meetingBox.style.display = 'none';
            }
            
            if (template) {
                selectedTemplate = template;
                document.getElementById('emailSubject').value = template.subject;
                updatePreview();
            } else {
                selectedTemplate = null;
                document.getElementById('emailSubject').value = '';
                document.getElementById('emailPreviewBox').innerHTML = '<p style="color: #999; text-align: center;">Select a template to see preview</p>';
            }
            
            updateSendButton();
        }
        
        function updatePreview() {
            const previewBox = document.getElementById('emailPreviewBox');
            
            if (!selectedTemplate) {
                previewBox.innerHTML = '<p style="color: #999; text-align: center;">Select a template to see preview</p>';
                return;
            }
            
            // Get client data for placeholders
            const clientId = document.getElementById('emailClient').value;
            const client = dashboardData?.clients?.find(c => c.client_id === clientId);
            
            let preview = selectedTemplate.body_html || getDefaultTemplateBody(selectedTemplate.template_id);
            
            // Replace placeholders
            if (client) {
                preview = preview.replace(/\{\{client_name\}\}/g, client.client_name || '');
                preview = preview.replace(/\{\{contact_name\}\}/g, client.contact_name || 'Valued Customer');
            }
            preview = preview.replace(/\{\{current_date\}\}/g, new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }));
            preview = preview.replace(/\{\{year\}\}/g, new Date().getFullYear());
            preview = preview.replace(/\{\{portal_url\}\}/g, 'https://polaris-portal.com');
            
            // Meeting template specific placeholders
            if (selectedTemplate.template_id === 'meeting_01') {
                preview = preview.replace(/\{\{greeting\}\}/g, getGreetingText());
                preview = preview.replace(/\{\{attendees_text\}\}/g, buildAttendeesText() || '[Select team members above]');
                preview = preview.replace(/\{\{signatures\}\}/g, buildSignaturesHTML() || '[Select team members above]');
            }
            
            // Show preview
            previewBox.innerHTML = preview || '<p>Template preview not available</p>';
        }
        
        function getDefaultTemplateBody(templateId) {
            const bodies = {
                'wishes_01': '<div style="font-family: Arial; color: #333;"><p>Dear {{contact_name}},</p><p>Season\'s Greetings from Polaris Financial Services!</p><p>Wishing you and {{client_name}} a wonderful holiday season.</p><br><p>Best Regards,<br><strong> POLARIS Financial Services</strong></p></div>',
                'wishes_02': '<div style="font-family: Arial; color: #333;"><p>Dear {{contact_name}},</p><p>Happy Easter from Polaris!</p><p>Wishing you peace and joy this Easter season.</p><br><p>Best Regards,<br><strong> POLARIS Financial Services</strong></p></div>',
                'wishes_03': '<div style="font-family: Arial; color: #333;"><p>Dear {{contact_name}},</p><p>Happy Birthday!</p><p>Wishing you a wonderful day filled with joy!</p><br><p>Best Regards,<br><strong> POLARIS Financial Services</strong></p></div>',
                'welcome_01': '<div style="font-family: Arial; color: #333;"><p>Dear {{contact_name}},</p><p>Welcome to Polaris Financial Services!</p><p>We are thrilled to have <strong>{{client_name}}</strong> as our partner.</p><p>Your portal access credentials are:</p><div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px 0;"><p style="margin: 5px 0;"><strong>Portal URL:</strong> {{portal_url}}</p><p style="margin: 5px 0;"><strong>Username:</strong> {{username}}</p><p style="margin: 5px 0;"><strong>Password:</strong> {{password}}</p></div><p>Please keep these credentials secure and do not share them with unauthorized persons.</p><br><p>Best Regards,<br><strong> POLARIS Financial Services</strong></p></div>',
                'renewal_01': '<div style="font-family: Arial; color: #333;"><p>Dear {{contact_name}},</p><p>This is a reminder that your contract is approaching renewal.</p><p>Please contact us to discuss renewal options.</p><br><p>Best Regards,<br><strong> POLARIS Financial Services</strong></p></div>',
                'balance_01': '<div style="font-family: Arial; color: #333;"><p>Dear {{contact_name}},</p><p>This is a reminder regarding an outstanding balance on your account.</p><p>Please arrange payment at your earliest convenience.</p><br><p>Best Regards,<br><strong> POLARIS Financial Services</strong></p></div>',
                'revolving_01': '<div style="font-family: Arial; color: #333;"><p>Dear {{contact_name}},</p><p><strong> URGENT:</strong> The revolving fund for {{client_name}} has fallen below 50%.</p><p>Please replenish to ensure uninterrupted service.</p><br><p>Best Regards,<br><strong> POLARIS Financial Services</strong></p></div>',
                'meeting_01': '<div style="font-family: Arial; color: #333;">{{greeting}}<br><br><p>Following the meeting you had with:</p>{{attendees_text}}<p>I would like to sincerely thank you for the time you dedicated and for the opportunity to connect with you.</p><p>We trust the meeting achieved providing you with a clear overview of our services and operational approach, while also setting the basis for the mutual trust and transparency we aim to build with our partners.</p><p>We represent Polaris Financial Services Ltd (<a href="http://www.polaris-finance.com">www.polaris-finance.com</a>) and our corporate arm in the Philippines, Polaris Administration Services, Inc.</p><p>Polaris provides a specialized private healthcare service for seafarers and their families, offering access to primary and secondary medical care through an extensive network of private physicians, diagnostic centers, and hospitals across the Philippines.</p><p>Our model incorporates key safeguards commonly found in traditional insurance, while maintaining a 3050% lower cost, enabled by our actuarial management system and agreements with private healthcare providers.</p><h4>In summary:</h4><ol><li><strong>Flexible Claims Handling:</strong> Ability to manage and settle ex gratia claims in coordination with the client.</li><li><strong>Regular Reporting:</strong> Quarterly updates ensuring complete transparency.</li><li><strong>Predictable Costs:</strong> Consistent average cost without renewal fluctuations.</li><li><strong>Revolving Fund:</strong> Deposited funds remain the property of the principal, with remaining balances returned in case of non renewal.</li></ol><h4>Attached, please find the program files referenced during our meeting:</h4><ol><li>Gold: 8040</li><li>Platinum: 18040</li><li>Diamond: 36060</li><li>Dental Benefits</li><li>24/7 Helpline  covering and supporting all of the above services and programs for seafarers and their families</li></ol><p>Once again, thank you for your time. We look forward to continuing our dialogue and exploring potential collaboration.</p><br><p>Kind regards,</p><br>{{signatures}}</div>',
            };
            return bodies[templateId] || '<p>Template body not available</p>';
        }
        
        function previewEmail() {
            updatePreview();
            // Scroll to preview
            document.getElementById('emailPreviewBox').scrollIntoView({ behavior: 'smooth' });
        }
        
        function updateSendButton() {
            const btn = document.getElementById('emailSendBtn');
            const hasTemplate = document.getElementById('emailTemplate').value;
            const hasClient = document.getElementById('emailClient').value;
            const hasRecipients = selectedContacts.length > 0;
            
            btn.disabled = !(hasTemplate && hasClient && hasRecipients);
        }
        
        async function sendEmail() {
            const btn = document.getElementById('emailSendBtn');
            const statusDiv = document.getElementById('emailStatus');
            
            btn.disabled = true;
            btn.innerHTML = ' Sending...';
            statusDiv.innerHTML = '';
            
            const emailData = {
                template_id: document.getElementById('emailTemplate').value,
                client_id: document.getElementById('emailClient').value,
                subject: document.getElementById('emailSubject').value,
                recipients: selectedContacts.map(c => c.email).join(','),
                sent_by: currentUser?.username || 'admin'
            };
            
            try {
                // Use GET request with URL parameters to avoid CORS issues
                const params = new URLSearchParams({
                    action: 'sendEmail',
                    template_id: emailData.template_id,
                    client_id: emailData.client_id,
                    subject: emailData.subject,
                    recipients: emailData.recipients,
                    sent_by: emailData.sent_by
                });
                
                // Add meeting specific data if meeting_01 template
                if (emailData.template_id === 'meeting_01') {
                    params.append('greeting', getGreetingText());
                    params.append('attendees_text', buildAttendeesText());
                    params.append('signatures_html', buildSignaturesHTML());
                }
                
                const response = await fetch(`${API_URL}?${params.toString()}`);
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = '<div class="email-status success"> Email sent successfully to ' + selectedContacts.length + ' recipient(s)!</div>';
                    // Clear form
                    setTimeout(() => {
                        document.getElementById('emailTemplate').value = '';
                        document.getElementById('emailClient').value = '';
                        document.getElementById('emailRecipients').innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Select a client to see available contacts</p>';
                        document.getElementById('emailSubject').value = '';
                        document.getElementById('emailPreviewBox').innerHTML = '<p style="color: #999; text-align: center;">Select a template to see preview</p>';
                        document.getElementById('meetingOptionsBox').style.display = 'none';
                        selectedContacts = [];
                        selectedTeamMembers = [];
                        loadEmailHistory();
                    }, 2000);
                } else {
                    statusDiv.innerHTML = '<div class="email-status error"> ' + (result.error || 'Failed to send email') + '</div>';
                }
            } catch (err) {
                console.error('Send email error:', err);
                statusDiv.innerHTML = '<div class="email-status error"> Error sending email. Please try again.</div>';
            }
            
            btn.disabled = false;
            btn.innerHTML = ' Send Email';
            updateSendButton();
        }
        
        function loadTemplatesList() {
            const container = document.getElementById('templatesList');
            const filter = document.getElementById('templateFilter').value;
            
            let filtered = emailTemplates;
            if (filter !== 'all') {
                filtered = emailTemplates.filter(t => t.category === filter);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 2rem;">No templates found</p>';
                return;
            }
            
            container.innerHTML = filtered.map(t => `
                <div class="template-card" onclick="useTemplate('${t.template_id}')">
                    <div class="template-card-title">${getCategoryIcon(t.category)} ${t.template_name}</div>
                    <span class="template-card-category">${t.category}</span>
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">${t.subject}</p>
                </div>
            `).join('');
        }
        
        function getCategoryIcon(category) {
            const icons = {
                'contract': '',
                'client': '',
                'finance': '',
                'alert': '',
                'wishes': ''
            };
            return icons[category] || '';
        }
        
        function filterTemplates() {
            loadTemplatesList();
        }
        
        function useTemplate(templateId) {
            // Switch to compose tab and select template
            document.querySelectorAll('.email-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.email-tab').classList.add('active');
            
            document.getElementById('emailTabCompose').style.display = 'block';
            document.getElementById('emailTabTemplates').style.display = 'none';
            document.getElementById('emailTabHistory').style.display = 'none';
            
            document.getElementById('emailTemplate').value = templateId;
            handleTemplateChange();
        }
        
        async function loadEmailHistory() {
            const tbody = document.getElementById('emailHistoryBody');
            
            try {
                const response = await fetch(`${API_URL}?action=getEmailHistory`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    tbody.innerHTML = data.data.slice(0, 20).map(log => `
                        <tr>
                            <td style="padding: 0.75rem; color: var(--text-secondary);">${log.sent_date || '-'}</td>
                            <td style="padding: 0.75rem; color: var(--text-primary);">${log.client_id || '-'}</td>
                            <td style="padding: 0.75rem; color: var(--text-secondary);">${log.template_id || '-'}</td>
                            <td style="padding: 0.75rem; color: var(--text-muted); font-size: 0.85rem;">${log.recipients || '-'}</td>
                            <td style="padding: 0.75rem;">
                                <span style="color: ${log.status === 'sent' ? '#4CAF50' : '#e74c3c'};">
                                    ${log.status === 'sent' ? ' Sent' : ' Failed'}
                                </span>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="padding: 2rem; text-align: center; color: var(--text-muted);">No email history yet</td></tr>';
                }
            } catch (err) {
                console.error('Error loading history:', err);
                tbody.innerHTML = '<tr><td colspan="5" style="padding: 2rem; text-align: center; color: var(--text-muted);">No email history yet</td></tr>';
            }
        }
        
        // 
        // MEETING FOLLOW-UP / TEAM MEMBERS FUNCTIONS
        // 
        
        let teamMembers = [];
        let selectedTeamMembers = [];
        
        async function loadTeamMembers() {
            const container = document.getElementById('teamMembersList');
            
            try {
                const response = await fetch(`${API_URL}?action=getTeamMembers`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    teamMembers = data.data.filter(m => m.is_active === 'TRUE');
                    renderTeamMembers();
                } else {
                    // Fallback with sample data
                    teamMembers = [
                        { member_id: 'TM001', name: 'Mr. Kagkelaris', title: 'General Manager', phone: '+30 210 XXX XXXX', email: 'kagkelaris@polaris-finance.com' },
                        { member_id: 'TM002', name: 'Mr. Koutsiouris', title: 'Business Director', phone: '+30 210 XXX XXXX', email: 'koutsiouris@polaris-finance.com' }
                    ];
                    renderTeamMembers();
                }
            } catch (err) {
                console.error('Error loading team members:', err);
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Error loading team members</p>';
            }
        }
        
        function renderTeamMembers() {
            const container = document.getElementById('teamMembersList');
            
            container.innerHTML = teamMembers.map((member, idx) => `
                <div class="email-recipient-item">
                    <input type="checkbox" id="team_${idx}" data-member-id="${member.member_id}" onchange="updateTeamMemberSelection()">
                    <div class="email-recipient-info">
                        <div class="email-recipient-name">${member.name}</div>
                        <div class="email-recipient-email">${member.title}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateTeamMemberSelection() {
            selectedTeamMembers = [];
            teamMembers.forEach((member, idx) => {
                const checkbox = document.getElementById(`team_${idx}`);
                if (checkbox && checkbox.checked) {
                    selectedTeamMembers.push(member);
                }
            });
            document.getElementById('teamMemberCount').textContent = selectedTeamMembers.length + ' selected';
            updateMeetingPreview();
        }
        
        function selectAllTeamMembers() {
            teamMembers.forEach((_, idx) => {
                const checkbox = document.getElementById(`team_${idx}`);
                if (checkbox) checkbox.checked = true;
            });
            updateTeamMemberSelection();
        }
        
        function clearAllTeamMembers() {
            teamMembers.forEach((_, idx) => {
                const checkbox = document.getElementById(`team_${idx}`);
                if (checkbox) checkbox.checked = false;
            });
            updateTeamMemberSelection();
        }
        
        function buildAttendeesText() {
            if (selectedTeamMembers.length === 0) return '';
            
            // Build vertical list with bullet points and line breaks
            const bulletList = selectedTeamMembers.map(m => 
                ` our ${m.title}, ${m.name}`
            ).join('<br>');
            
            return `<br>${bulletList}<br>`;
        }
        
        function buildSignaturesHTML() {
            if (selectedTeamMembers.length === 0) return '';
            
            return selectedTeamMembers.map(m => `
                <div style="margin-bottom: 15px;">
                    <p style="margin: 0; font-weight: bold;">${m.name}</p>
                    <p style="margin: 2px 0; color: #666;">${m.title}</p>
                    <p style="margin: 2px 0;">&#128222; ${m.phone || ''}</p>
                    <p style="margin: 2px 0;">&#128231; ${m.email || ''}</p>
                </div>
            `).join('');
        }
        
        function getGreetingText() {
            const greetingType = document.getElementById('meetingGreeting').value;
            const clientId = document.getElementById('emailClient').value;
            const client = clientsList.find(c => c.id === clientId);
            
            switch(greetingType) {
                case 'personal':
                    // Get first selected contact name
                    if (selectedContacts.length > 0) {
                        return `Dear ${selectedContacts[0].contact_name},`;
                    }
                    return 'Dear Sir/Madam,';
                case 'company':
                    if (client) {
                        return `Dear ${client.name.replace(' ', '')} Team,`;
                    }
                    return 'Dear Team,';
                case 'generic':
                default:
                    return 'Dear All,';
            }
        }
        
        function updateMeetingPreview() {
            if (selectedTemplate?.template_id === 'meeting_01') {
                updatePreview();
            }
        }
        
        // 
        // BULK SEND FUNCTIONS
        // 
        
        let selectedBulkClients = [];
        
        function populateBulkClients() {
            const container = document.getElementById('bulkClientsList');
            const clients = clientsList.filter(c => c.id !== 'all');
            
            if (clients.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">No clients available</p>';
                return;
            }
            
            container.innerHTML = clients.map((client, idx) => `
                <div class="email-recipient-item">
                    <input type="checkbox" id="bulk_client_${idx}" data-client-id="${client.id}" onchange="updateBulkSelection()">
                    <div class="email-recipient-info">
                        <div class="email-recipient-name">${client.name.replace(' ', '')}</div>
                    </div>
                </div>
            `).join('');
            
            updateBulkSelection();
        }
        
        function selectAllBulkClients() {
            document.querySelectorAll('[id^="bulk_client_"]').forEach(cb => cb.checked = true);
            updateBulkSelection();
        }
        
        function clearAllBulkClients() {
            document.querySelectorAll('[id^="bulk_client_"]').forEach(cb => cb.checked = false);
            updateBulkSelection();
        }
        
        function updateBulkSelection() {
            selectedBulkClients = [];
            document.querySelectorAll('[id^="bulk_client_"]').forEach(cb => {
                if (cb.checked) {
                    selectedBulkClients.push(cb.dataset.clientId);
                }
            });
            
            const count = selectedBulkClients.length;
            document.getElementById('bulkClientCount').textContent = count + ' clients selected';
            
            // Calculate total emails based on role
            const role = document.getElementById('bulkRole').value;
            let emailsPerClient = role === 'All' ? 2.5 : 1; // Average
            const totalEmails = Math.round(count * emailsPerClient);
            document.getElementById('bulkTotalEmails').textContent = totalEmails;
            
            // Enable/disable send button
            const hasTemplate = document.getElementById('bulkTemplate').value;
            document.getElementById('bulkSendBtn').disabled = !(hasTemplate && count > 0);
        }
        
        function handleBulkTemplateChange() {
            const templateId = document.getElementById('bulkTemplate').value;
            const template = emailTemplates.find(t => t.template_id === templateId);
            
            if (template) {
                document.getElementById('bulkSubject').value = template.subject;
            } else {
                document.getElementById('bulkSubject').value = '';
            }
            
            updateBulkSelection();
        }
        
        function previewBulkEmail() {
            const templateId = document.getElementById('bulkTemplate').value;
            if (!templateId) {
                alert('Please select a template first');
                return;
            }
            
            // Switch to compose tab with first client for preview
            if (selectedBulkClients.length > 0) {
                document.getElementById('emailTemplate').value = templateId;
                document.getElementById('emailClient').value = selectedBulkClients[0];
                handleTemplateChange();
                loadClientContacts();
            }
            
            // Switch to compose tab
            document.querySelectorAll('.email-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.email-tab').classList.add('active');
            document.getElementById('emailTabCompose').style.display = 'block';
            document.getElementById('emailTabBulk').style.display = 'none';
        }
        
        async function sendBulkEmail() {
            const btn = document.getElementById('bulkSendBtn');
            const statusDiv = document.getElementById('bulkStatus');
            const templateId = document.getElementById('bulkTemplate').value;
            const role = document.getElementById('bulkRole').value;
            
            if (!templateId || selectedBulkClients.length === 0) {
                statusDiv.innerHTML = '<div class="email-status error"> Please select template and clients</div>';
                return;
            }
            
            // Confirm
            const confirmMsg = `Are you sure you want to send emails to ${selectedBulkClients.length} clients?`;
            if (!confirm(confirmMsg)) return;
            
            btn.disabled = true;
            btn.innerHTML = ' Sending...';
            statusDiv.innerHTML = '<div class="email-status" style="background: rgba(33,150,243,0.2); color: #2196F3;"> Sending emails... Please wait...</div>';
            
            let successCount = 0;
            let failCount = 0;
            const template = emailTemplates.find(t => t.template_id === templateId);
            
            // Send to each client
            for (const clientId of selectedBulkClients) {
                try {
                    // Get contacts for this client
                    const response = await fetch(`${API_URL}?action=getClientContacts&client_id=${clientId}`);
                    const data = await response.json();
                    
                    let recipients = [];
                    if (data.success && data.data && data.data.length > 0) {
                        if (role === 'All') {
                            recipients = data.data.map(c => c.email);
                        } else {
                            recipients = data.data.filter(c => c.role === role || c.role === 'Primary').map(c => c.email);
                        }
                    }
                    
                    if (recipients.length === 0) {
                        console.log('No recipients for client:', clientId);
                        failCount++;
                        continue;
                    }
                    
                    // Send email
                    const params = new URLSearchParams({
                        action: 'sendEmail',
                        template_id: templateId,
                        client_id: clientId,
                        subject: template?.subject || 'Message from Polaris',
                        recipients: recipients.join(','),
                        sent_by: currentUser?.username || 'admin'
                    });
                    
                    const sendResponse = await fetch(`${API_URL}?${params.toString()}`);
                    const sendResult = await sendResponse.json();
                    
                    if (sendResult.success) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                    
                    // Update status
                    statusDiv.innerHTML = `<div class="email-status" style="background: rgba(33,150,243,0.2); color: #2196F3;"> Sending... ${successCount + failCount}/${selectedBulkClients.length} clients processed</div>`;
                    
                    // Small delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (err) {
                    console.error('Error sending to client:', clientId, err);
                    failCount++;
                }
            }
            
            // Final status
            if (failCount === 0) {
                statusDiv.innerHTML = `<div class="email-status success"> Successfully sent to all ${successCount} clients!</div>`;
            } else {
                statusDiv.innerHTML = `<div class="email-status" style="background: rgba(255,193,7,0.2); color: #FFC107;"> Sent: ${successCount} | Failed: ${failCount}</div>`;
            }
            
            btn.disabled = false;
            btn.innerHTML = ' Send to ALL Selected';
            
            // Refresh history
            loadEmailHistory();
        }
        
        // 
        // SCHEDULER FUNCTIONS
        // 
        
        function populateSchedulerClients() {
            const select = document.getElementById('scheduleClient');
            select.innerHTML = '<option value="">-- Select client --</option><option value="ALL"> ALL CLIENTS</option>';
            
            const clients = clientsList.filter(c => c.id !== 'all');
            clients.forEach(client => {
                const opt = document.createElement('option');
                opt.value = client.id;
                opt.textContent = client.name.replace(' ', '');
                select.appendChild(opt);
            });
            
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('scheduleDate').value = tomorrow.toISOString().split('T')[0];
            
            // Hide contacts box initially
            document.getElementById('scheduleContactsBox').style.display = 'none';
        }
        
        let scheduleContacts = [];
        let selectedScheduleContacts = [];
        
        async function loadSchedulerContacts() {
            const clientId = document.getElementById('scheduleClient').value;
            const contactsBox = document.getElementById('scheduleContactsBox');
            const contactsList = document.getElementById('scheduleContactsList');
            
            if (!clientId || clientId === 'ALL') {
                contactsBox.style.display = 'none';
                scheduleContacts = [];
                selectedScheduleContacts = [];
                return;
            }
            
            contactsBox.style.display = 'block';
            contactsList.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Loading contacts...</p>';
            
            try {
                const response = await fetch(`${API_URL}?action=getClientContacts&client_id=${clientId}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    scheduleContacts = data.data;
                    renderScheduleContacts();
                } else {
                    scheduleContacts = [];
                    contactsList.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">No contacts found for this client</p>';
                }
            } catch (err) {
                console.error('Error loading contacts:', err);
                contactsList.innerHTML = '<p style="color: var(--danger); text-align: center; padding: 1rem;">Error loading contacts</p>';
            }
            
            updateScheduleContactCount();
        }
        
        function renderScheduleContacts() {
            const container = document.getElementById('scheduleContactsList');
            
            if (scheduleContacts.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">No contacts available</p>';
                return;
            }
            
            container.innerHTML = scheduleContacts.map((contact, idx) => `
                <div class="email-recipient-item">
                    <input type="checkbox" id="schedule_contact_${idx}" data-email="${contact.email}" onchange="updateScheduleContactSelection()">
                    <div class="email-recipient-info">
                        <div class="email-recipient-name">${contact.contact_name}</div>
                        <div class="email-recipient-email">${contact.email}</div>
                    </div>
                    <span class="email-recipient-role">${contact.role}</span>
                </div>
            `).join('');
        }
        
        function updateScheduleContactSelection() {
            selectedScheduleContacts = [];
            scheduleContacts.forEach((contact, idx) => {
                const checkbox = document.getElementById(`schedule_contact_${idx}`);
                if (checkbox && checkbox.checked) {
                    selectedScheduleContacts.push(contact.email);
                }
            });
            updateScheduleContactCount();
        }
        
        function updateScheduleContactCount() {
            document.getElementById('scheduleContactCount').textContent = selectedScheduleContacts.length;
        }
        
        function selectAllScheduleContacts() {
            scheduleContacts.forEach((_, idx) => {
                const checkbox = document.getElementById(`schedule_contact_${idx}`);
                if (checkbox) checkbox.checked = true;
            });
            updateScheduleContactSelection();
        }
        
        function clearAllScheduleContacts() {
            scheduleContacts.forEach((_, idx) => {
                const checkbox = document.getElementById(`schedule_contact_${idx}`);
                if (checkbox) checkbox.checked = false;
            });
            updateScheduleContactSelection();
        }
        
        function selectScheduleByRole(role) {
            scheduleContacts.forEach((contact, idx) => {
                const checkbox = document.getElementById(`schedule_contact_${idx}`);
                if (checkbox) {
                    checkbox.checked = contact.role === role || contact.role === 'Primary';
                }
            });
            updateScheduleContactSelection();
        }
        
        async function addScheduledEmail() {
            const template = document.getElementById('scheduleTemplate').value;
            const client = document.getElementById('scheduleClient').value;
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            const notes = document.getElementById('scheduleNotes').value;
            const statusDiv = document.getElementById('scheduleStatus');
            
            // Validation
            if (!template || !client || !date || !time) {
                statusDiv.innerHTML = '<div class="email-status error"> Please fill in all required fields</div>';
                return;
            }
            
            // Check contacts selection (not for ALL)
            if (client !== 'ALL' && selectedScheduleContacts.length === 0) {
                statusDiv.innerHTML = '<div class="email-status error"> Please select at least one contact</div>';
                return;
            }
            
            // Check if date is in the future
            const scheduledDateTime = new Date(date + 'T' + time);
            if (scheduledDateTime <= new Date()) {
                statusDiv.innerHTML = '<div class="email-status error"> Scheduled time must be in the future</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="email-status" style="background: rgba(33,150,243,0.2); color: #2196F3;"> Adding to schedule...</div>';
            
            try {
                const params = new URLSearchParams({
                    action: 'addScheduledEmail',
                    template_id: template,
                    client_id: client,
                    scheduled_date: date,
                    scheduled_time: time,
                    recipients: client === 'ALL' ? 'ALL' : selectedScheduleContacts.join(','),
                    notes: notes,
                    created_by: currentUser?.username || 'admin'
                });
                
                const response = await fetch(`${API_URL}?${params.toString()}`);
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = '<div class="email-status success"> Email scheduled successfully!</div>';
                    
                    // Clear form
                    document.getElementById('scheduleTemplate').value = '';
                    document.getElementById('scheduleClient').value = '';
                    document.getElementById('scheduleNotes').value = '';
                    document.getElementById('scheduleContactsBox').style.display = 'none';
                    selectedScheduleContacts = [];
                    scheduleContacts = [];
                    
                    // Refresh list
                    loadScheduledEmails();
                    
                    // Clear status after 3 seconds
                    setTimeout(() => { statusDiv.innerHTML = ''; }, 3000);
                } else {
                    statusDiv.innerHTML = '<div class="email-status error"> ' + (result.error || 'Failed to schedule') + '</div>';
                }
            } catch (err) {
                console.error('Schedule error:', err);
                statusDiv.innerHTML = '<div class="email-status error"> Error scheduling email</div>';
            }
        }
        
        async function loadScheduledEmails() {
            const tbody = document.getElementById('scheduledEmailsBody');
            
            try {
                const response = await fetch(`${API_URL}?action=getScheduledEmails`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    // Sort by date ascending (soonest first)
                    const sorted = data.data.sort((a, b) => {
                        const dateA = new Date(a.scheduled_date + 'T' + a.scheduled_time);
                        const dateB = new Date(b.scheduled_date + 'T' + b.scheduled_time);
                        return dateA - dateB;
                    });
                    
                    tbody.innerHTML = sorted.map(item => {
                        const isPast = new Date(item.scheduled_date + 'T' + item.scheduled_time) < new Date();
                        const statusColor = item.status === 'sent' ? '#4CAF50' : 
                                           item.status === 'cancelled' ? '#9e9e9e' :
                                           isPast ? '#ff9800' : '#2196F3';
                        const statusText = item.status === 'sent' ? ' Sent' : 
                                          item.status === 'cancelled' ? ' Cancelled' :
                                          isPast ? ' Pending' : ' Scheduled';
                        
                        return `
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.75rem; color: var(--text-primary);">
                                    <strong>${item.scheduled_date}</strong><br>
                                    <span style="color: var(--text-muted); font-size: 0.85rem;">${item.scheduled_time}</span>
                                </td>
                                <td style="padding: 0.75rem; color: var(--text-secondary);">
                                    ${item.client_id === 'ALL' ? ' ALL CLIENTS' : item.client_id}
                                </td>
                                <td style="padding: 0.75rem; color: var(--text-secondary);">${item.template_id}</td>
                                <td style="padding: 0.75rem; color: var(--text-muted);">${item.recipient_role || 'Primary'}</td>
                                <td style="padding: 0.75rem;">
                                    <span style="color: ${statusColor}; font-weight: 500;">${statusText}</span>
                                </td>
                                <td style="padding: 0.75rem; text-align: center;">
                                    ${item.status === 'pending' ? `
                                        <button onclick="cancelScheduledEmail('${item.schedule_id}')" 
                                                style="background: #f44336; color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 5px; cursor: pointer; font-size: 0.8rem;">
                                             Cancel
                                        </button>
                                    ` : '-'}
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-muted);">No scheduled emails</td></tr>';
                }
            } catch (err) {
                console.error('Error loading scheduled emails:', err);
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-muted);">Error loading scheduled emails</td></tr>';
            }
        }
        
        async function cancelScheduledEmail(scheduleId) {
            if (!confirm('Are you sure you want to cancel this scheduled email?')) return;
            
            try {
                const response = await fetch(`${API_URL}?action=cancelScheduledEmail&schedule_id=${scheduleId}`);
                const result = await response.json();
                
                if (result.success) {
                    loadScheduledEmails();
                } else {
                    alert('Failed to cancel: ' + (result.error || 'Unknown error'));
                }
            } catch (err) {
                console.error('Cancel error:', err);
                alert('Error cancelling scheduled email');
            }
        }
        
        // 
        // END EMAIL CENTER FUNCTIONS
        // 
        
        function openReportBuilder() {
            document.getElementById('reportBuilderModal').classList.remove('hidden');
            updateSectionStyles();
        }
        
        function closeReportBuilder() {
            document.getElementById('reportBuilderModal').classList.add('hidden');
        }
        
        function selectTemplate(template) {
            // Remove active from all
            document.querySelectorAll('.rb-template-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Set sections based on template
            const templates = {
                board: { executive: true, inout: true, claims: true, cost: true, members: false, movement: false, plans: false, history: false, trends: false },
                monthly: { executive: true, inout: true, claims: true, cost: true, members: true, movement: true, plans: false, history: false, trends: false },
                executive: { executive: true, inout: false, claims: false, cost: true, members: false, movement: false, plans: false, history: false, trends: false },
                full: { executive: true, inout: true, claims: true, cost: true, members: true, movement: true, plans: true, history: true, trends: true }
            };
            
            reportConfig.sections = { ...templates[template] };
            
            // Update checkboxes
            Object.keys(reportConfig.sections).forEach(key => {
                const checkbox = document.getElementById('sec_' + key);
                if (checkbox) checkbox.checked = reportConfig.sections[key];
            });
            
            updateSectionStyles();
        }
        
        function selectFormat(format) {
            reportConfig.format = format;
            document.querySelectorAll('.rb-format-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('format' + format.charAt(0).toUpperCase() + format.slice(1)).classList.add('selected');
        }
        
        function updateSectionStyles() {
            document.querySelectorAll('.rb-section-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }
        
        // Add event listeners to checkboxes
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.rb-section-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const key = checkbox.id.replace('sec_', '');
                    reportConfig.sections[key] = checkbox.checked;
                    updateSectionStyles();
                });
            });
        });
        
        function previewReport() {
            const selectedSections = Object.entries(reportConfig.sections).filter(([k, v]) => v).map(([k]) => k);
            const pages = selectedSections.length + 1; // +1 for cover
            alert(`  \n\n` +
                  `: ${reportConfig.fromPeriod} - ${reportConfig.toPeriod}\n` +
                  `: ${selectedSections.length}\n` +
                  ` : ${pages}\n` +
                  `: ${reportConfig.format.toUpperCase()}`);
        }
        
        async function generateReport() {
            closeReportBuilder();
            
            // Get selected sections
            const sections = reportConfig.sections;
            
            // Call appropriate generator based on format
            if (reportConfig.format === 'pdf' || reportConfig.format === 'both') {
                await generateCustomPDF(sections);
            }
            
            if (reportConfig.format === 'excel' || reportConfig.format === 'both') {
                generateExcelReport();
            }
        }
        
        function generateExcelReport() {
            alert(' Excel export   !\n\n      PDF .');
        }
        
        async function generateCustomPDF(sections) {
            const modal = document.getElementById('reportModal');
            const progressBar = document.getElementById('reportProgressBar');
            const stepText = document.getElementById('reportStep');
            const statusText = document.getElementById('reportStatus');
            const titleText = document.getElementById('reportTitle');
            
            modal.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressBar.style.background = 'linear-gradient(90deg, #B8860B, #D4AF37)';
            titleText.textContent = 'Generating Report...';
            statusText.textContent = 'Preparing your custom report';
            
            const updateProgress = (percent, step) => {
                progressBar.style.width = percent + '%';
                stepText.textContent = step;
            };
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 12;
                const contentWidth = pageWidth - (margin * 2);
                
                const clientName = currentUser.username || currentUser.client_id || 'Client';
                const periodLabel = document.getElementById('periodBadge')?.textContent || 'Q3 2025';
                const reportDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                
                // Colors
                const purple = [0, 150, 136]; // Now teal instead of purple
                const purpleLight = [77, 182, 172]; // Teal light
                const green = [27, 94, 32];
                const greenLight = [76, 175, 80];
                const gold = [212, 175, 55];
                const blue = [25, 118, 210];
                const blueLight = [66, 165, 245];
                const red = [211, 47, 47];
                const redLight = [239, 83, 80];
                const orange = [255, 152, 0];
                const teal = [0, 150, 136];
                const textDark = [33, 33, 33];
                const textMuted = [117, 117, 117];
                const bgLight = [250, 250, 252];
                
                // Helper: Draw progress bar
                const drawProgressBar = (x, y, width, height, percent, color1, color2) => {
                    doc.setFillColor(230, 230, 235);
                    doc.roundedRect(x, y, width, height, height/2, height/2, 'F');
                    const fillWidth = (percent / 100) * width;
                    if (fillWidth > 0) {
                        doc.setFillColor(...color1);
                        doc.roundedRect(x, y, Math.max(fillWidth, height), height, height/2, height/2, 'F');
                    }
                };
                
                // Helper: Draw donut chart
                const drawDonut = (cx, cy, outerR, innerR, segments) => {
                    let startAngle = -Math.PI / 2;
                    segments.forEach(seg => {
                        const endAngle = startAngle + (seg.percent / 100) * Math.PI * 2;
                        doc.setFillColor(...seg.color);
                        
                        // Draw arc segment (approximation with polygon)
                        const points = [];
                        for (let a = startAngle; a <= endAngle; a += 0.1) {
                            points.push([cx + Math.cos(a) * outerR, cy + Math.sin(a) * outerR]);
                        }
                        for (let a = endAngle; a >= startAngle; a -= 0.1) {
                            points.push([cx + Math.cos(a) * innerR, cy + Math.sin(a) * innerR]);
                        }
                        
                        if (points.length > 2) {
                            doc.setFillColor(...seg.color);
                            // Simple filled arc
                            const midAngle = (startAngle + endAngle) / 2;
                            const midR = (outerR + innerR) / 2;
                            // Draw as thick arc
                            for (let r = innerR; r <= outerR; r += 0.5) {
                                for (let a = startAngle; a <= endAngle; a += 0.02) {
                                    const px = cx + Math.cos(a) * r;
                                    const py = cy + Math.sin(a) * r;
                                    doc.circle(px, py, 0.3, 'F');
                                }
                            }
                        }
                        startAngle = endAngle;
                    });
                    // Center circle
                    doc.setFillColor(255, 255, 255);
                    doc.circle(cx, cy, innerR, 'F');
                };
                
                // Helper: Mini KPI card
                const drawMiniKPI = (x, y, w, h, icon, label, value, color) => {
                    doc.setFillColor(...bgLight);
                    doc.roundedRect(x, y, w, h, 3, 3, 'F');
                    doc.setFillColor(...color);
                    doc.roundedRect(x, y, 4, h, 2, 2, 'F');
                    
                    doc.setFontSize(7);
                    doc.setTextColor(...textMuted);
                    doc.text(label.toUpperCase(), x + 8, y + 8);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...color);
                    doc.text(value, x + 8, y + 18);
                    doc.setFont('helvetica', 'normal');
                };
                
                // Get all values
                const totalMembers = document.getElementById('kpiMembers')?.textContent || '8,547';
                const totalClaims = document.getElementById('kpiClaims')?.textContent || '1,234';
                const approvedAmount = document.getElementById('kpiApproved')?.textContent || '$156,789';
                const costPerMember = document.getElementById('kpiCost')?.textContent || '$67.83';
                const utilization = document.getElementById('kpiUtilization')?.textContent || '14.4%';
                const inpatientCases = document.getElementById('inpatientCases')?.textContent || '308';
                const outpatientCases = document.getElementById('outpatientCases')?.textContent || '926';
                const inpatientCost = document.getElementById('inpatientCost')?.textContent || '$101,913';
                const outpatientCost = document.getElementById('outpatientCost')?.textContent || '$54,876';
                const principalCount = document.getElementById('principalCount')?.textContent || '3,419';
                const dependentCount = document.getElementById('dependentCount')?.textContent || '5,128';
                const newEnroll = document.getElementById('newEnrollments')?.textContent || '+684';
                const cancelled = document.getElementById('cancellations')?.textContent || '-256';
                const netChange = document.getElementById('netChange')?.textContent || '+428';
                
                let totalSections = Object.values(sections).filter(v => v).length;
                let sectionsDone = 0;
                
                // ==================== PAGE 1: COVER ====================
                updateProgress(5, 'Creating cover page...');
                await new Promise(r => setTimeout(r, 80));
                
                // Full page gradient header
                doc.setFillColor(...purple);
                doc.rect(0, 0, pageWidth, 100, 'F');
                
                // Decorative circles
                doc.setFillColor(140, 50, 180);
                doc.circle(180, 20, 40, 'F');
                doc.setFillColor(100, 20, 140);
                doc.circle(200, 80, 25, 'F');
                doc.setFillColor(160, 70, 200);
                doc.circle(20, 90, 15, 'F');
                
                // Gold accent bar
                doc.setFillColor(...gold);
                doc.rect(0, 98, pageWidth, 4, 'F');
                
                // Logo area
                doc.setFillColor(255, 255, 255);
                doc.roundedRect(margin, 15, 50, 20, 3, 3, 'F');
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...purple);
                doc.text('POLARIS', margin + 8, 27);
                
                // Main title
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(36);
                doc.setFont('helvetica', 'bold');
                doc.text('Analytics Report', margin, 60);
                
                doc.setFontSize(16);
                doc.setFont('helvetica', 'normal');
                doc.text(clientName, margin, 75);
                doc.setFontSize(12);
                doc.text(periodLabel + '    ' + reportDate, margin, 88);
                
                // Quick stats row
                let yPos = 115;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('QUICK OVERVIEW', margin, yPos);
                
                yPos += 8;
                const quickStats = [
                    { label: 'Members', value: totalMembers, color: green },
                    { label: 'Claims', value: totalClaims, color: blue },
                    { label: 'Approved', value: approvedAmount, color: gold },
                    { label: 'Cost/Member', value: costPerMember, color: purple }
                ];
                
                const statWidth = (contentWidth - 15) / 4;
                quickStats.forEach((stat, i) => {
                    const x = margin + (i * (statWidth + 5));
                    doc.setFillColor(...stat.color);
                    doc.roundedRect(x, yPos, statWidth, 28, 3, 3, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'normal');
                    doc.text(stat.label.toUpperCase(), x + 5, yPos + 9);
                    doc.setFontSize(13);
                    doc.setFont('helvetica', 'bold');
                    doc.text(stat.value, x + 5, yPos + 21);
                });
                
                // Report contents
                yPos += 45;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('REPORT CONTENTS', margin, yPos);
                
                yPos += 8;
                const sectionNames = {
                    executive: { name: 'Executive Summary', icon: '' },
                    inout: { name: 'Inpatient vs Outpatient', icon: '' },
                    claims: { name: 'Claims Analysis', icon: '' },
                    cost: { name: 'Cost Breakdown', icon: '' },
                    members: { name: 'Member Analysis', icon: '' },
                    movement: { name: 'Member Movement', icon: '' },
                    plans: { name: 'Plan Performance', icon: '' },
                    history: { name: 'Historical Data', icon: '' },
                    trends: { name: 'Trends', icon: '' }
                };
                
                let col = 0;
                Object.entries(sections).forEach(([key, enabled]) => {
                    if (enabled && sectionNames[key]) {
                        const x = margin + (col % 2) * (contentWidth / 2);
                        doc.setFillColor(...bgLight);
                        doc.roundedRect(x, yPos, contentWidth / 2 - 5, 12, 2, 2, 'F');
                        doc.setFillColor(...purple);
                        doc.circle(x + 6, yPos + 6, 3, 'F');
                        doc.setFontSize(9);
                        doc.setTextColor(...textDark);
                        doc.text(sectionNames[key].name, x + 14, yPos + 8);
                        col++;
                        if (col % 2 === 0) yPos += 15;
                    }
                });
                
                // Bottom decorative bar
                doc.setFillColor(...purple);
                doc.rect(0, pageHeight - 15, pageWidth, 15, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.text('Confidential    Polaris Financial Services    ' + reportDate, pageWidth / 2, pageHeight - 6, { align: 'center' });
                
                // ==================== PAGE 2: EXECUTIVE SUMMARY ====================
                if (sections.executive) {
                    sectionsDone++;
                    updateProgress(10 + (sectionsDone / totalSections * 70), 'Building Executive Summary...');
                    await new Promise(r => setTimeout(r, 80));
                    doc.addPage();
                    
                    // Header bar
                    doc.setFillColor(...purple);
                    doc.rect(0, 0, pageWidth, 22, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Executive Summary', margin, 14);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text(periodLabel, pageWidth - margin, 14, { align: 'right' });
                    
                    yPos = 32;
                    
                    // KPI Cards Row 1
                    const kpiW = (contentWidth - 10) / 3;
                    const kpis = [
                        { label: 'Total Members', value: totalMembers, sub: '+5.2% vs last period', color: green, subColor: greenLight },
                        { label: 'Total Claims', value: totalClaims, sub: '+12.3% vs last period', color: blue, subColor: red },
                        { label: 'Approved Amount', value: approvedAmount, sub: 'USD Equivalent', color: gold, subColor: textMuted }
                    ];
                    
                    kpis.forEach((kpi, i) => {
                        const x = margin + (i * (kpiW + 5));
                        
                        // Card background
                        doc.setFillColor(...bgLight);
                        doc.roundedRect(x, yPos, kpiW, 38, 4, 4, 'F');
                        
                        // Top color bar
                        doc.setFillColor(...kpi.color);
                        doc.roundedRect(x, yPos, kpiW, 5, 4, 4, 'F');
                        doc.rect(x, yPos + 3, kpiW, 2, 'F');
                        
                        // Label
                        doc.setFontSize(7);
                        doc.setTextColor(...textMuted);
                        doc.text(kpi.label.toUpperCase(), x + 6, yPos + 14);
                        
                        // Value
                        doc.setFontSize(16);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...kpi.color);
                        doc.text(kpi.value, x + 6, yPos + 26);
                        
                        // Sub text
                        doc.setFontSize(6);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(...kpi.subColor);
                        doc.text(kpi.sub, x + 6, yPos + 34);
                    });
                    
                    yPos += 48;
                    
                    // KPI Cards Row 2
                    const kpis2 = [
                        { label: 'Cost per Member', value: costPerMember, color: purple },
                        { label: 'Utilization Rate', value: utilization, color: teal },
                        { label: 'Avg Claim Value', value: '$127.05', color: orange }
                    ];
                    
                    kpis2.forEach((kpi, i) => {
                        const x = margin + (i * (kpiW + 5));
                        doc.setFillColor(...bgLight);
                        doc.roundedRect(x, yPos, kpiW, 32, 4, 4, 'F');
                        doc.setFillColor(...kpi.color);
                        doc.roundedRect(x, yPos, 4, 32, 2, 2, 'F');
                        
                        doc.setFontSize(7);
                        doc.setTextColor(...textMuted);
                        doc.text(kpi.label.toUpperCase(), x + 10, yPos + 12);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...kpi.color);
                        doc.text(kpi.value, x + 10, yPos + 25);
                    });
                    
                    yPos += 42;
                    
                    // Performance Metrics Section
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('PERFORMANCE METRICS', margin, yPos);
                    
                    yPos += 8;
                    
                    const metrics = [
                        { label: 'Claims Processing Rate', value: 94, target: 95, color: green },
                        { label: 'Cost Efficiency', value: 78, target: 80, color: blue },
                        { label: 'Member Satisfaction', value: 88, target: 85, color: purple },
                        { label: 'Network Utilization', value: 72, target: 75, color: orange }
                    ];
                    
                    metrics.forEach((m, i) => {
                        const y = yPos + (i * 18);
                        
                        // Background
                        doc.setFillColor(...bgLight);
                        doc.roundedRect(margin, y, contentWidth, 15, 2, 2, 'F');
                        
                        // Label
                        doc.setFontSize(8);
                        doc.setTextColor(...textDark);
                        doc.setFont('helvetica', 'normal');
                        doc.text(m.label, margin + 5, y + 10);
                        
                        // Progress bar
                        const barX = margin + 70;
                        const barW = 80;
                        drawProgressBar(barX, y + 5, barW, 5, m.value, m.color, m.color);
                        
                        // Value
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...m.color);
                        doc.text(m.value + '%', barX + barW + 5, y + 10);
                        
                        // Target
                        doc.setFontSize(6);
                        doc.setTextColor(...textMuted);
                        doc.text('Target: ' + m.target + '%', barX + barW + 20, y + 10);
                    });
                    
                    yPos += 80;
                    
                    // Period Comparison
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('PERIOD COMPARISON', margin, yPos);
                    
                    yPos += 6;
                    
                    // Table
                    const headers = ['Metric', 'Current', 'Previous', 'Change'];
                    const colWidths = [50, 35, 35, 40];
                    
                    // Header row
                    doc.setFillColor(...purple);
                    doc.roundedRect(margin, yPos, contentWidth, 10, 2, 2, 'F');
                    doc.rect(margin, yPos + 5, contentWidth, 5, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    
                    let xPos = margin + 5;
                    headers.forEach((h, i) => {
                        doc.text(h, xPos, yPos + 7);
                        xPos += colWidths[i];
                    });
                    
                    yPos += 10;
                    
                    const rows = [
                        ['Total Claims', '1,234', '1,099', '+12.3%', greenLight],
                        ['Members', '8,547', '8,119', '+5.2%', greenLight],
                        ['Approved (USD)', '$156,789', '$142,350', '+10.1%', greenLight],
                        ['Cost/Member', '$67.83', '$62.45', '+8.6%', redLight]
                    ];
                    
                    rows.forEach((row, ri) => {
                        const y = yPos + (ri * 12);
                        doc.setFillColor(ri % 2 === 0 ? 250 : 245, ri % 2 === 0 ? 250 : 248, 252);
                        doc.rect(margin, y, contentWidth, 12, 'F');
                        
                        xPos = margin + 5;
                        row.slice(0, 4).forEach((cell, ci) => {
                            if (ci === 3) {
                                doc.setTextColor(...row[4]);
                                doc.setFont('helvetica', 'bold');
                            } else if (ci === 0) {
                                doc.setTextColor(...textDark);
                                doc.setFont('helvetica', 'bold');
                            } else {
                                doc.setTextColor(...textDark);
                                doc.setFont('helvetica', 'normal');
                            }
                            doc.setFontSize(8);
                            doc.text(cell, xPos, y + 8);
                            xPos += colWidths[ci];
                        });
                    });
                    
                    // Footer
                    doc.setFillColor(...purple);
                    doc.rect(0, pageHeight - 8, pageWidth, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6);
                    doc.text('Page 2    Polaris Financial Services    Confidential', pageWidth / 2, pageHeight - 3, { align: 'center' });
                }
                
                // ==================== PAGE 3: INPATIENT VS OUTPATIENT ====================
                if (sections.inout) {
                    sectionsDone++;
                    updateProgress(10 + (sectionsDone / totalSections * 70), 'Adding Inpatient/Outpatient...');
                    await new Promise(r => setTimeout(r, 80));
                    doc.addPage();
                    
                    // Header
                    doc.setFillColor(...purple);
                    doc.rect(0, 0, pageWidth, 22, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Inpatient vs Outpatient Analysis', margin, 14);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text(periodLabel, pageWidth - margin, 14, { align: 'right' });
                    
                    yPos = 32;
                    
                    // Main stats boxes
                    const boxW = (contentWidth - 10) / 2;
                    
                    // Inpatient Box
                    doc.setFillColor(...red);
                    doc.roundedRect(margin, yPos, boxW, 55, 5, 5, 'F');
                    
                    // Inner lighter box
                    doc.setFillColor(239, 154, 154);
                    doc.roundedRect(margin + boxW - 45, yPos + 5, 40, 45, 3, 3, 'F');
                    doc.setFontSize(8);
                    doc.setTextColor(...red);
                    doc.text('25%', margin + boxW - 30, yPos + 30);
                    doc.setFontSize(6);
                    doc.text('of cases', margin + boxW - 33, yPos + 38);
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text('INPATIENT', margin + 8, yPos + 14);
                    doc.setFontSize(26);
                    doc.setFont('helvetica', 'bold');
                    doc.text(inpatientCases, margin + 8, yPos + 35);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Cases', margin + 8, yPos + 45);
                    
                    // Outpatient Box
                    doc.setFillColor(...blue);
                    doc.roundedRect(margin + boxW + 10, yPos, boxW, 55, 5, 5, 'F');
                    
                    doc.setFillColor(144, 202, 249);
                    doc.roundedRect(margin + boxW + 10 + boxW - 45, yPos + 5, 40, 45, 3, 3, 'F');
                    doc.setFontSize(8);
                    doc.setTextColor(...blue);
                    doc.text('75%', margin + boxW + 10 + boxW - 30, yPos + 30);
                    doc.setFontSize(6);
                    doc.text('of cases', margin + boxW + 10 + boxW - 33, yPos + 38);
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text('OUTPATIENT', margin + boxW + 18, yPos + 14);
                    doc.setFontSize(26);
                    doc.setFont('helvetica', 'bold');
                    doc.text(outpatientCases, margin + boxW + 18, yPos + 35);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Cases', margin + boxW + 18, yPos + 45);
                    
                    yPos += 65;
                    
                    // Cost Comparison
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('COST ANALYSIS', margin, yPos);
                    
                    yPos += 8;
                    
                    // Visual bar comparison
                    const totalCostVal = 156789;
                    const inCostVal = 101913;
                    const outCostVal = 54876;
                    const inPct = (inCostVal / totalCostVal * 100).toFixed(0);
                    const outPct = (outCostVal / totalCostVal * 100).toFixed(0);
                    
                    // Stacked bar
                    doc.setFillColor(...red);
                    const inBarW = (inCostVal / totalCostVal) * contentWidth;
                    doc.roundedRect(margin, yPos, inBarW, 25, 3, 3, 'F');
                    doc.rect(margin + inBarW - 5, yPos, 5, 25, 'F');
                    
                    doc.setFillColor(...blue);
                    doc.roundedRect(margin + inBarW, yPos, contentWidth - inBarW, 25, 3, 3, 'F');
                    doc.rect(margin + inBarW, yPos, 5, 25, 'F');
                    
                    // Labels on bar
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Inpatient ' + inPct + '%', margin + 8, yPos + 10);
                    doc.text(inpatientCost, margin + 8, yPos + 19);
                    
                    doc.text('Outpatient ' + outPct + '%', margin + inBarW + 8, yPos + 10);
                    doc.text(outpatientCost, margin + inBarW + 8, yPos + 19);
                    
                    yPos += 35;
                    
                    // Detailed breakdown table
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('DETAILED BREAKDOWN', margin, yPos);
                    
                    yPos += 8;
                    
                    const detailHeaders = ['Category', 'Cases', 'Cost', 'Avg/Case', '% Total'];
                    const detailWidths = [40, 30, 40, 35, 30];
                    
                    doc.setFillColor(...purple);
                    doc.roundedRect(margin, yPos, contentWidth, 10, 2, 2, 'F');
                    doc.rect(margin, yPos + 5, contentWidth, 5, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    
                    xPos = margin + 3;
                    detailHeaders.forEach((h, i) => {
                        doc.text(h, xPos, yPos + 7);
                        xPos += detailWidths[i];
                    });
                    
                    yPos += 10;
                    
                    const detailRows = [
                        { data: ['Inpatient', '308', '$101,913', '$330.89', '65%'], color: red },
                        { data: ['Outpatient', '926', '$54,876', '$59.26', '35%'], color: blue },
                        { data: ['TOTAL', '1,234', '$156,789', '$127.05', '100%'], color: purple, bold: true }
                    ];
                    
                    detailRows.forEach((row, ri) => {
                        const y = yPos + (ri * 14);
                        
                        if (row.bold) {
                            doc.setFillColor(240, 235, 245);
                        } else {
                            doc.setFillColor(ri % 2 === 0 ? 255 : 250, ri % 2 === 0 ? 248 : 245, ri % 2 === 0 ? 248 : 250);
                        }
                        doc.roundedRect(margin, y, contentWidth, 14, ri === detailRows.length - 1 ? 2 : 0, ri === detailRows.length - 1 ? 2 : 0, 'F');
                        
                        // Color indicator
                        doc.setFillColor(...row.color);
                        doc.roundedRect(margin, y, 3, 14, 1, 1, 'F');
                        
                        xPos = margin + 6;
                        row.data.forEach((cell, ci) => {
                            doc.setFontSize(8);
                            if (ci === 0 || row.bold) {
                                doc.setFont('helvetica', 'bold');
                                doc.setTextColor(...row.color);
                            } else {
                                doc.setFont('helvetica', 'normal');
                                doc.setTextColor(...textDark);
                            }
                            doc.text(cell, xPos, y + 9);
                            xPos += detailWidths[ci];
                        });
                    });
                    
                    yPos += 55;
                    
                    // Trends mini section
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('MONTHLY TREND', margin, yPos);
                    
                    yPos += 8;
                    
                    // Simple bar chart
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                    const barWidth = (contentWidth - 30) / 6;
                    
                    doc.setFillColor(...bgLight);
                    doc.roundedRect(margin, yPos, contentWidth, 50, 3, 3, 'F');
                    
                    const inData = [45, 52, 38, 61, 55, 51];
                    const outData = [120, 135, 142, 128, 155, 154];
                    const maxVal = 160;
                    
                    months.forEach((m, i) => {
                        const x = margin + 15 + (i * barWidth);
                        const inH = (inData[i] / maxVal) * 35;
                        const outH = (outData[i] / maxVal) * 35;
                        
                        // Outpatient bar
                        doc.setFillColor(...blue);
                        doc.roundedRect(x, yPos + 45 - outH, barWidth * 0.35, outH, 1, 1, 'F');
                        
                        // Inpatient bar
                        doc.setFillColor(...red);
                        doc.roundedRect(x + barWidth * 0.4, yPos + 45 - inH, barWidth * 0.35, inH, 1, 1, 'F');
                        
                        // Month label
                        doc.setFontSize(6);
                        doc.setTextColor(...textMuted);
                        doc.text(m, x + barWidth * 0.2, yPos + 48);
                    });
                    
                    // Legend
                    doc.setFillColor(...red);
                    doc.rect(margin + contentWidth - 60, yPos + 5, 8, 4, 'F');
                    doc.setFillColor(...blue);
                    doc.rect(margin + contentWidth - 60, yPos + 12, 8, 4, 'F');
                    doc.setFontSize(6);
                    doc.setTextColor(...textDark);
                    doc.text('Inpatient', margin + contentWidth - 50, yPos + 8);
                    doc.text('Outpatient', margin + contentWidth - 50, yPos + 15);
                    
                    // Footer
                    doc.setFillColor(...purple);
                    doc.rect(0, pageHeight - 8, pageWidth, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6);
                    doc.text('Page 3    Polaris Financial Services    Confidential', pageWidth / 2, pageHeight - 3, { align: 'center' });
                }
                
                // ==================== PAGE 4: CLAIMS ANALYSIS ====================
                if (sections.claims) {
                    sectionsDone++;
                    updateProgress(10 + (sectionsDone / totalSections * 70), 'Building Claims Analysis...');
                    await new Promise(r => setTimeout(r, 80));
                    doc.addPage();
                    
                    // Header
                    doc.setFillColor(...purple);
                    doc.rect(0, 0, pageWidth, 22, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Claims Analysis', margin, 14);
                    
                    yPos = 32;
                    
                    // Claims overview cards
                    const claimCards = [
                        { label: 'Total Claims', value: totalClaims, icon: '', color: blue },
                        { label: 'Approved', value: approvedAmount, icon: '', color: green },
                        { label: 'Avg Claim', value: '$127.05', icon: '', color: gold },
                        { label: 'Pending', value: '23', icon: '', color: orange }
                    ];
                    
                    const cardW = (contentWidth - 15) / 4;
                    claimCards.forEach((card, i) => {
                        const x = margin + (i * (cardW + 5));
                        doc.setFillColor(...card.color);
                        doc.roundedRect(x, yPos, cardW, 40, 4, 4, 'F');
                        
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'normal');
                        doc.text(card.label.toUpperCase(), x + 5, yPos + 12);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text(card.value, x + 5, yPos + 28);
                    });
                    
                    yPos += 52;
                    
                    // Claims by category
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('CLAIMS BY CATEGORY', margin, yPos);
                    
                    yPos += 8;
                    
                    const categories = [
                        { name: 'Consultation', count: 412, amount: '$28,450', pct: 33, color: blue },
                        { name: 'Laboratory', count: 289, amount: '$22,340', pct: 23, color: green },
                        { name: 'Pharmacy', count: 234, amount: '$18,920', pct: 19, color: purple },
                        { name: 'Hospitalization', count: 156, amount: '$52,430', pct: 13, color: red },
                        { name: 'Emergency', count: 89, amount: '$24,120', pct: 7, color: orange },
                        { name: 'Others', count: 54, amount: '$10,529', pct: 5, color: teal }
                    ];
                    
                    categories.forEach((cat, i) => {
                        const y = yPos + (i * 16);
                        
                        doc.setFillColor(...bgLight);
                        doc.roundedRect(margin, y, contentWidth, 14, 2, 2, 'F');
                        
                        // Color bar
                        doc.setFillColor(...cat.color);
                        doc.roundedRect(margin, y, 3, 14, 1, 1, 'F');
                        
                        // Name
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...cat.color);
                        doc.text(cat.name, margin + 8, y + 9);
                        
                        // Count
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(...textDark);
                        doc.text(cat.count + ' claims', margin + 50, y + 9);
                        
                        // Progress bar
                        drawProgressBar(margin + 90, y + 4, 50, 5, cat.pct, cat.color, cat.color);
                        
                        // Amount
                        doc.setFont('helvetica', 'bold');
                        doc.text(cat.amount, margin + 145, y + 9);
                        
                        // Percentage
                        doc.setTextColor(...cat.color);
                        doc.text(cat.pct + '%', margin + contentWidth - 15, y + 9);
                    });
                    
                    yPos += 105;
                    
                    // Claims trend
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('CLAIMS PROCESSING STATUS', margin, yPos);
                    
                    yPos += 8;
                    
                    doc.setFillColor(...bgLight);
                    doc.roundedRect(margin, yPos, contentWidth, 45, 3, 3, 'F');
                    
                    // Status breakdown
                    const statuses = [
                        { name: 'Approved', value: 1156, pct: 94, color: green },
                        { name: 'Pending', value: 23, pct: 2, color: orange },
                        { name: 'Under Review', value: 32, pct: 3, color: blue },
                        { name: 'Denied', value: 23, pct: 1, color: red }
                    ];
                    
                    const statusW = (contentWidth - 20) / 4;
                    statuses.forEach((s, i) => {
                        const x = margin + 5 + (i * statusW);
                        
                        doc.setFillColor(...s.color);
                        doc.circle(x + 8, yPos + 15, 5, 'F');
                        
                        doc.setFontSize(7);
                        doc.setTextColor(...textMuted);
                        doc.text(s.name, x + 18, yPos + 13);
                        
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...s.color);
                        doc.text(s.value.toString(), x + 18, yPos + 26);
                        
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'normal');
                        doc.text(s.pct + '%', x + 18, yPos + 35);
                    });
                    
                    // Footer
                    doc.setFillColor(...purple);
                    doc.rect(0, pageHeight - 8, pageWidth, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6);
                    doc.text('Page 4    Polaris Financial Services    Confidential', pageWidth / 2, pageHeight - 3, { align: 'center' });
                }
                
                // ==================== PAGE 5: COST BREAKDOWN ====================
                if (sections.cost) {
                    sectionsDone++;
                    updateProgress(10 + (sectionsDone / totalSections * 70), 'Adding Cost Breakdown...');
                    await new Promise(r => setTimeout(r, 80));
                    doc.addPage();
                    
                    // Header
                    doc.setFillColor(...purple);
                    doc.rect(0, 0, pageWidth, 22, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Cost Breakdown', margin, 14);
                    
                    yPos = 32;
                    
                    // Main cost display
                    doc.setFillColor(...green);
                    doc.roundedRect(margin, yPos, contentWidth, 50, 5, 5, 'F');
                    
                    // Decorative element
                    doc.setFillColor(56, 142, 60);
                    doc.circle(margin + contentWidth - 30, yPos + 25, 35, 'F');
                    doc.setFillColor(76, 175, 80);
                    doc.circle(margin + contentWidth - 25, yPos + 20, 20, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text('TOTAL COST PER MEMBER', margin + 12, yPos + 18);
                    doc.setFontSize(32);
                    doc.setFont('helvetica', 'bold');
                    doc.text(costPerMember, margin + 12, yPos + 42);
                    
                    yPos += 60;
                    
                    // Cost components
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('COST COMPONENTS', margin, yPos);
                    
                    yPos += 8;
                    
                    const costNum = 67.83;
                    const components = [
                        { name: 'Base Claims Cost', value: (costNum * 0.70).toFixed(2), pct: 70, color: green },
                        { name: 'Audit Fee (15%)', value: (costNum * 0.105).toFixed(2), pct: 10.5, color: gold },
                        { name: 'Administrative', value: '8.50', pct: 12.5, color: blue },
                        { name: 'Registration Fee', value: '2.00', pct: 3, color: purple },
                        { name: 'Service Fee', value: '0.75', pct: 1, color: orange },
                        { name: 'Other Fees', value: '2.10', pct: 3, color: teal }
                    ];
                    
                    components.forEach((comp, i) => {
                        const y = yPos + (i * 20);
                        
                        doc.setFillColor(...bgLight);
                        doc.roundedRect(margin, y, contentWidth, 18, 2, 2, 'F');
                        
                        // Color indicator
                        doc.setFillColor(...comp.color);
                        doc.roundedRect(margin + 3, y + 3, 12, 12, 2, 2, 'F');
                        
                        // Name
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...textDark);
                        doc.text(comp.name, margin + 20, y + 12);
                        
                        // Progress bar
                        drawProgressBar(margin + 80, y + 6, 60, 5, comp.pct, comp.color, comp.color);
                        
                        // Value
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...comp.color);
                        doc.text('$' + comp.value, margin + 150, y + 12);
                    });
                    
                    yPos += 130;
                    
                    // Cost trend mini chart
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('COST TREND (6 MONTHS)', margin, yPos);
                    
                    yPos += 8;
                    
                    doc.setFillColor(...bgLight);
                    doc.roundedRect(margin, yPos, contentWidth, 55, 3, 3, 'F');
                    
                    // Draw line chart
                    const costData = [58.2, 61.4, 63.8, 65.2, 66.5, 67.83];
                    const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                    const chartMargin = 25;
                    const chartW = contentWidth - chartMargin * 2;
                    const chartH = 35;
                    const minCost = 55;
                    const maxCost = 75;
                    
                    // Grid lines
                    doc.setDrawColor(220, 220, 220);
                    doc.setLineWidth(0.2);
                    for (let i = 0; i <= 4; i++) {
                        const gy = yPos + 8 + (i * chartH / 4);
                        doc.line(margin + chartMargin, gy, margin + chartMargin + chartW, gy);
                    }
                    
                    // Y-axis labels
                    doc.setFontSize(6);
                    doc.setTextColor(...textMuted);
                    doc.text('$75', margin + 5, yPos + 10);
                    doc.text('$65', margin + 5, yPos + 27);
                    doc.text('$55', margin + 5, yPos + 44);
                    
                    // Draw line
                    doc.setDrawColor(...green);
                    doc.setLineWidth(1);
                    
                    costData.forEach((val, i) => {
                        const x = margin + chartMargin + (i * chartW / 5);
                        const y = yPos + 8 + ((maxCost - val) / (maxCost - minCost)) * chartH;
                        
                        if (i > 0) {
                            const prevX = margin + chartMargin + ((i - 1) * chartW / 5);
                            const prevY = yPos + 8 + ((maxCost - costData[i-1]) / (maxCost - minCost)) * chartH;
                            doc.line(prevX, prevY, x, y);
                        }
                        
                        // Point
                        doc.setFillColor(...green);
                        doc.circle(x, y, 2, 'F');
                        
                        // Month label
                        doc.setFontSize(6);
                        doc.setTextColor(...textMuted);
                        doc.text(monthLabels[i], x - 4, yPos + 52);
                    });
                    
                    // Footer
                    doc.setFillColor(...purple);
                    doc.rect(0, pageHeight - 8, pageWidth, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6);
                    doc.text('Page 5    Polaris Financial Services    Confidential', pageWidth / 2, pageHeight - 3, { align: 'center' });
                }
                
                // ==================== FINALIZE ====================
                updateProgress(95, 'Finalizing...');
                await new Promise(r => setTimeout(r, 100));
                
                // ==================== SAVE ====================
                updateProgress(100, 'Complete!');
                titleText.textContent = 'Report Ready!';
                statusText.textContent = 'Your custom report has been generated';
                stepText.textContent = 'Downloading...';
                
                await new Promise(r => setTimeout(r, 500));
                
                const fileName = `Polaris_Report_${clientName.replace(/\s+/g, '_')}_${periodLabel.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 1500);
                
            } catch (error) {
                console.error('Report error:', error);
                titleText.textContent = 'Error';
                statusText.textContent = 'Failed to generate report';
                stepText.textContent = error.message;
                progressBar.style.background = '#e74c3c';
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 3000);
            }
        }
        
        // Store dashboard data globally for report
        let dashboardData = null;
        
        async function generateClientReport() {
            const modal = document.getElementById('reportModal');
            const progressBar = document.getElementById('reportProgressBar');
            const stepText = document.getElementById('reportStep');
            const statusText = document.getElementById('reportStatus');
            const titleText = document.getElementById('reportTitle');
            
            modal.classList.remove('hidden');
            
            const updateProgress = (percent, step) => {
                progressBar.style.width = percent + '%';
                stepText.textContent = step;
            };
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);
                
                // Get current data
                const clientName = currentUser.username || currentUser.client_id || 'Client';
                const periodLabel = document.getElementById('periodBadge')?.textContent || 'Current Period';
                const reportDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                
                // Colors
                const greenDark = [27, 94, 32];
                const greenLight = [46, 125, 50];
                const gold = [212, 175, 55];
                const textDark = [30, 30, 30];
                const textMuted = [120, 120, 120];
                
                // ==================== PAGE 1: COVER ====================
                updateProgress(10, 'Creating cover page...');
                await new Promise(r => setTimeout(r, 200));
                
                // Green header bar
                doc.setFillColor(...greenDark);
                doc.rect(0, 0, pageWidth, 60, 'F');
                
                // Gold accent line
                doc.setFillColor(...gold);
                doc.rect(0, 58, pageWidth, 4, 'F');
                
                // Company name
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(28);
                doc.setFont('helvetica', 'bold');
                doc.text('POLARIS', margin, 30);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'normal');
                doc.text('FINANCIAL SERVICES', margin, 40);
                
                // Report title
                doc.setTextColor(...textDark);
                doc.setFontSize(32);
                doc.setFont('helvetica', 'bold');
                doc.text('Client Analytics Report', margin, 100);
                
                // Client name
                doc.setFontSize(20);
                doc.setTextColor(...greenDark);
                doc.text(clientName, margin, 120);
                
                // Period
                doc.setFontSize(14);
                doc.setTextColor(...textMuted);
                doc.text('Period: ' + periodLabel, margin, 135);
                doc.text('Generated: ' + reportDate, margin, 145);
                
                // Decorative box
                doc.setDrawColor(...greenDark);
                doc.setLineWidth(0.5);
                doc.rect(margin, 160, contentWidth, 80);
                
                doc.setFontSize(12);
                doc.setTextColor(...textDark);
                doc.text('This report contains:', margin + 5, 175);
                
                const contents = [
                    ' Executive Summary & KPIs',
                    ' Period Comparison Analysis',
                    ' Inpatient vs Outpatient Breakdown',
                    ' Principal vs Dependent Analysis',
                    ' Cost Analysis & Trends',
                    ' Member Movement Statistics',
                    ' Historical Data'
                ];
                
                contents.forEach((item, i) => {
                    doc.text(item, margin + 5, 188 + (i * 7));
                });
                
                // Footer
                doc.setFontSize(10);
                doc.setTextColor(...textMuted);
                doc.text('Confidential - For authorized use only', pageWidth / 2, 280, { align: 'center' });
                doc.text(' 2025 Polaris Financial Services', pageWidth / 2, 287, { align: 'center' });
                
                // ==================== PAGE 2: EXECUTIVE SUMMARY ====================
                updateProgress(25, 'Building executive summary...');
                await new Promise(r => setTimeout(r, 200));
                doc.addPage();
                
                // Header
                doc.setFillColor(...greenDark);
                doc.rect(0, 0, pageWidth, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Executive Summary', margin, 17);
                
                // KPI boxes
                const kpis = [
                    { label: 'Total Members', value: document.getElementById('kpiMembers')?.textContent || '-', icon: '' },
                    { label: 'Total Claims', value: document.getElementById('kpiClaims')?.textContent || '-', icon: '' },
                    { label: 'Approved Amount', value: document.getElementById('kpiApproved')?.textContent || '-', icon: '' },
                    { label: 'Cost per Member', value: document.getElementById('kpiCost')?.textContent || '-', icon: '' },
                    { label: 'Utilization Rate', value: document.getElementById('kpiUtilization')?.textContent || '-', icon: '' }
                ];
                
                let yPos = 40;
                const boxWidth = (contentWidth - 10) / 2;
                const boxHeight = 30;
                
                kpis.forEach((kpi, i) => {
                    const col = i % 2;
                    const row = Math.floor(i / 2);
                    const x = margin + (col * (boxWidth + 10));
                    const y = yPos + (row * (boxHeight + 8));
                    
                    // Box
                    doc.setFillColor(245, 250, 245);
                    doc.setDrawColor(...greenLight);
                    doc.roundedRect(x, y, boxWidth, boxHeight, 3, 3, 'FD');
                    
                    // Label
                    doc.setFontSize(9);
                    doc.setTextColor(...textMuted);
                    doc.text(kpi.label, x + 5, y + 10);
                    
                    // Value
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...greenDark);
                    doc.text(kpi.value, x + 5, y + 23);
                });
                
                // Period Comparison Section
                yPos = 165;
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Period Comparison', margin, yPos);
                
                doc.setDrawColor(...gold);
                doc.setLineWidth(1);
                doc.line(margin, yPos + 3, margin + 50, yPos + 3);
                
                yPos += 15;
                
                const comparisons = [
                    { label: 'Claims', current: document.getElementById('cmpClaims')?.textContent, prev: document.getElementById('cmpClaimsPrev')?.textContent },
                    { label: 'Members', current: document.getElementById('cmpMembers')?.textContent, prev: document.getElementById('cmpMembersPrev')?.textContent },
                    { label: 'Approved (USD)', current: document.getElementById('cmpApproved')?.textContent, prev: document.getElementById('cmpApprovedPrev')?.textContent },
                    { label: 'Cost/Member', current: document.getElementById('cmpCost')?.textContent, prev: document.getElementById('cmpCostPrev')?.textContent }
                ];
                
                // Table header
                doc.setFillColor(...greenDark);
                doc.rect(margin, yPos, contentWidth, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Metric', margin + 5, yPos + 7);
                doc.text('Current', margin + 70, yPos + 7);
                doc.text('Previous', margin + 120, yPos + 7);
                
                yPos += 10;
                
                comparisons.forEach((cmp, i) => {
                    const rowY = yPos + (i * 12);
                    doc.setFillColor(i % 2 === 0 ? 250 : 245, i % 2 === 0 ? 250 : 248, i % 2 === 0 ? 250 : 245);
                    doc.rect(margin, rowY, contentWidth, 12, 'F');
                    
                    doc.setTextColor(...textDark);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.text(cmp.label, margin + 5, rowY + 8);
                    doc.setFont('helvetica', 'bold');
                    doc.text(cmp.current || '-', margin + 70, rowY + 8);
                    doc.setTextColor(...textMuted);
                    doc.text(cmp.prev || '-', margin + 120, rowY + 8);
                });
                
                // ==================== PAGE 3: INPATIENT/OUTPATIENT ====================
                updateProgress(45, 'Adding inpatient/outpatient analysis...');
                await new Promise(r => setTimeout(r, 200));
                doc.addPage();
                
                // Header
                doc.setFillColor(...greenDark);
                doc.rect(0, 0, pageWidth, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Inpatient vs Outpatient Analysis', margin, 17);
                
                yPos = 40;
                
                // Stats boxes
                const inpatientCases = document.getElementById('inpatientCases')?.textContent || '-';
                const outpatientCases = document.getElementById('outpatientCases')?.textContent || '-';
                const inpatientCost = document.getElementById('inpatientCost')?.textContent || '-';
                const outpatientCost = document.getElementById('outpatientCost')?.textContent || '-';
                
                // Inpatient Box
                doc.setFillColor(231, 76, 60);
                doc.roundedRect(margin, yPos, 85, 50, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.text('INPATIENT', margin + 10, yPos + 15);
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.text(inpatientCases, margin + 10, yPos + 32);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cases', margin + 10, yPos + 42);
                
                // Outpatient Box
                doc.setFillColor(52, 152, 219);
                doc.roundedRect(margin + 95, yPos, 85, 50, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.text('OUTPATIENT', margin + 105, yPos + 15);
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.text(outpatientCases, margin + 105, yPos + 32);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cases', margin + 105, yPos + 42);
                
                yPos += 65;
                
                // Cost comparison
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Cost Analysis', margin, yPos);
                
                yPos += 15;
                
                doc.setFillColor(250, 245, 245);
                doc.setDrawColor(231, 76, 60);
                doc.roundedRect(margin, yPos, 85, 35, 3, 3, 'FD');
                doc.setTextColor(231, 76, 60);
                doc.setFontSize(10);
                doc.text('Inpatient Cost', margin + 10, yPos + 12);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(inpatientCost, margin + 10, yPos + 27);
                
                doc.setFillColor(245, 250, 255);
                doc.setDrawColor(52, 152, 219);
                doc.roundedRect(margin + 95, yPos, 85, 35, 3, 3, 'FD');
                doc.setTextColor(52, 152, 219);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Outpatient Cost', margin + 105, yPos + 12);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(outpatientCost, margin + 105, yPos + 27);
                
                // ==================== PAGE 4: PRINCIPAL/DEPENDENT ====================
                updateProgress(60, 'Adding member type analysis...');
                await new Promise(r => setTimeout(r, 200));
                
                yPos += 55;
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Principal vs Dependent Analysis', margin, yPos);
                
                doc.setDrawColor(...gold);
                doc.setLineWidth(1);
                doc.line(margin, yPos + 3, margin + 70, yPos + 3);
                
                yPos += 20;
                
                const principalCount = document.getElementById('principalCount')?.textContent || '-';
                const dependentCount = document.getElementById('dependentCount')?.textContent || '-';
                const principalCost = document.getElementById('principalCost')?.textContent || '-';
                const dependentCost = document.getElementById('dependentCost')?.textContent || '-';
                
                // Principal Box
                doc.setFillColor(...greenDark);
                doc.roundedRect(margin, yPos, 85, 50, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.text('SEAFARERS (Principal)', margin + 8, yPos + 15);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(principalCount, margin + 10, yPos + 32);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cost: ' + principalCost, margin + 10, yPos + 44);
                
                // Dependent Box
                doc.setFillColor(...gold);
                doc.roundedRect(margin + 95, yPos, 85, 50, 3, 3, 'F');
                doc.setTextColor(30, 30, 30);
                doc.setFontSize(11);
                doc.text('DEPENDENTS', margin + 105, yPos + 15);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(dependentCount, margin + 105, yPos + 32);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cost: ' + dependentCost, margin + 105, yPos + 44);
                
                // ==================== PAGE 4: MEMBER MOVEMENT ====================
                updateProgress(75, 'Adding member movement...');
                await new Promise(r => setTimeout(r, 200));
                doc.addPage();
                
                // Header
                doc.setFillColor(...greenDark);
                doc.rect(0, 0, pageWidth, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Member Movement & Fees', margin, 17);
                
                yPos = 40;
                
                const newEnroll = document.getElementById('newEnrollments')?.textContent || '-';
                const cancelled = document.getElementById('cancellations')?.textContent || '-';
                const netChange = document.getElementById('netChange')?.textContent || '-';
                
                // Movement boxes
                doc.setFillColor(76, 175, 80);
                doc.roundedRect(margin, yPos, 55, 45, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.text('NEW ENROLLMENTS', margin + 5, yPos + 12);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(newEnroll, margin + 5, yPos + 32);
                
                doc.setFillColor(231, 76, 60);
                doc.roundedRect(margin + 62, yPos, 55, 45, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('CANCELLATIONS', margin + 67, yPos + 12);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(cancelled, margin + 67, yPos + 32);
                
                doc.setFillColor(...gold);
                doc.roundedRect(margin + 124, yPos, 55, 45, 3, 3, 'F');
                doc.setTextColor(30, 30, 30);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('NET CHANGE', margin + 129, yPos + 12);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(netChange, margin + 129, yPos + 32);
                
                // Fees Section
                yPos += 65;
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Fees & Charges', margin, yPos);
                
                doc.setDrawColor(...gold);
                doc.setLineWidth(1);
                doc.line(margin, yPos + 3, margin + 40, yPos + 3);
                
                yPos += 15;
                
                const fees = [
                    { label: 'Audit Fee', value: '15%' },
                    { label: 'Registration Fee (Annual)', value: '$24' },
                    { label: 'Monthly Fee (Annual)', value: '$9' }
                ];
                
                fees.forEach((fee, i) => {
                    const rowY = yPos + (i * 18);
                    doc.setFillColor(i % 2 === 0 ? 250 : 245, 250, i % 2 === 0 ? 250 : 245);
                    doc.roundedRect(margin, rowY, contentWidth, 15, 2, 2, 'F');
                    
                    doc.setFontSize(11);
                    doc.setTextColor(...textDark);
                    doc.setFont('helvetica', 'normal');
                    doc.text(fee.label, margin + 5, rowY + 10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...greenDark);
                    doc.text(fee.value, margin + contentWidth - 30, rowY + 10);
                });
                
                // ==================== FINAL PAGE: FOOTER ====================
                updateProgress(90, 'Finalizing report...');
                await new Promise(r => setTimeout(r, 200));
                
                // Add footer to all pages
                const totalPages = doc.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(9);
                    doc.setTextColor(...textMuted);
                    doc.text(`Page ${i} of ${totalPages}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                    if (i > 1) {
                        doc.text('Polaris Financial Services - Confidential', margin, pageHeight - 10);
                    }
                }
                
                // ==================== SAVE ====================
                updateProgress(100, 'Complete!');
                titleText.textContent = 'Report Ready!';
                statusText.textContent = 'Your report has been generated successfully';
                stepText.textContent = 'Downloading...';
                
                await new Promise(r => setTimeout(r, 500));
                
                // Save PDF
                const fileName = `Polaris_Report_${clientName.replace(/\s+/g, '_')}_${periodLabel.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
                
                // Close modal after delay
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 1500);
                
            } catch (error) {
                console.error('Report generation error:', error);
                titleText.textContent = 'Error';
                statusText.textContent = 'Failed to generate report';
                stepText.textContent = error.message;
                progressBar.style.background = '#e74c3c';
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 3000);
            }
        }
        
        async function generateMonthlyReport() {
            const modal = document.getElementById('reportModal');
            const progressBar = document.getElementById('reportProgressBar');
            const stepText = document.getElementById('reportStep');
            const statusText = document.getElementById('reportStatus');
            const titleText = document.getElementById('reportTitle');
            
            modal.classList.remove('hidden');
            progressBar.style.background = 'linear-gradient(90deg, var(--polaris-green), var(--polaris-gold))';
            
            const updateProgress = (percent, step) => {
                progressBar.style.width = percent + '%';
                stepText.textContent = step;
            };
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);
                
                // Get data
                const clientName = currentUser.username || currentUser.client_id || 'All Clients';
                const periodLabel = document.getElementById('periodBadge')?.textContent || 'Current Period';
                const reportDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                const monthName = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                // Colors
                const greenDark = [27, 94, 32];
                const greenLight = [46, 125, 50];
                const gold = [212, 175, 55];
                const blue = [21, 101, 192];
                const blueDark = [13, 71, 161];
                const red = [211, 47, 47];
                const textDark = [30, 30, 30];
                const textMuted = [120, 120, 120];
                
                // ==================== PAGE 1: COVER ====================
                updateProgress(5, 'Creating cover page...');
                await new Promise(r => setTimeout(r, 150));
                
                // Blue header for monthly report
                doc.setFillColor(...blue);
                doc.rect(0, 0, pageWidth, 70, 'F');
                
                // Gold accent
                doc.setFillColor(...gold);
                doc.rect(0, 68, pageWidth, 4, 'F');
                
                // Title
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'normal');
                doc.text('POLARIS FINANCIAL SERVICES', margin, 25);
                
                doc.setFontSize(32);
                doc.setFont('helvetica', 'bold');
                doc.text('Monthly Report', margin, 45);
                
                doc.setFontSize(18);
                doc.setFont('helvetica', 'normal');
                doc.text(periodLabel, margin, 58);
                
                // Report info box
                doc.setFillColor(250, 250, 250);
                doc.roundedRect(margin, 85, contentWidth, 50, 3, 3, 'F');
                
                doc.setFontSize(11);
                doc.setTextColor(...textMuted);
                doc.text('Report Details', margin + 10, 98);
                
                doc.setFontSize(12);
                doc.setTextColor(...textDark);
                doc.setFont('helvetica', 'bold');
                doc.text('Client:', margin + 10, 112);
                doc.text('Period:', margin + 10, 124);
                doc.setFont('helvetica', 'normal');
                doc.text(clientName, margin + 50, 112);
                doc.text(periodLabel, margin + 50, 124);
                
                doc.setTextColor(...textMuted);
                doc.setFontSize(10);
                doc.text('Generated: ' + reportDate, margin + 10, 130);
                
                // Contents
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Report Contents', margin, 160);
                
                doc.setDrawColor(...blue);
                doc.setLineWidth(1);
                doc.line(margin, 164, margin + 45, 164);
                
                const contents = [
                    { num: '01', title: 'Executive Summary', desc: 'Key performance indicators overview' },
                    { num: '02', title: 'Inpatient vs Outpatient', desc: 'Case distribution and cost analysis' },
                    { num: '03', title: 'Claims Analysis', desc: 'Detailed claims breakdown by category' },
                    { num: '04', title: 'Cost Breakdown', desc: 'Comprehensive cost analysis and fees' }
                ];
                
                let yPos = 175;
                contents.forEach((item, i) => {
                    doc.setFillColor(...blue);
                    doc.roundedRect(margin, yPos, 20, 20, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(item.num, margin + 6, yPos + 13);
                    
                    doc.setTextColor(...textDark);
                    doc.setFontSize(12);
                    doc.text(item.title, margin + 28, yPos + 8);
                    doc.setTextColor(...textMuted);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text(item.desc, margin + 28, yPos + 16);
                    
                    yPos += 28;
                });
                
                // Footer
                doc.setFontSize(9);
                doc.setTextColor(...textMuted);
                doc.text('Confidential - For internal use only', pageWidth / 2, 285, { align: 'center' });
                
                // ==================== PAGE 2: EXECUTIVE SUMMARY ====================
                updateProgress(20, 'Building executive summary...');
                await new Promise(r => setTimeout(r, 150));
                doc.addPage();
                
                // Header
                doc.setFillColor(...blue);
                doc.rect(0, 0, pageWidth, 30, 'F');
                doc.setFillColor(...gold);
                doc.rect(0, 28, pageWidth, 3, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text('MONTHLY REPORT | ' + periodLabel, margin, 12);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('01. Executive Summary', margin, 23);
                
                yPos = 45;
                
                // Key Metrics Title
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Key Performance Indicators', margin, yPos);
                
                yPos += 10;
                
                // KPI Grid (2x3)
                const kpis = [
                    { label: 'Total Members', value: document.getElementById('kpiMembers')?.textContent || '-', color: greenDark, icon: 'MEMBERS' },
                    { label: 'Total Claims', value: document.getElementById('kpiClaims')?.textContent || '-', color: blue, icon: 'CLAIMS' },
                    { label: 'Approved Amount', value: document.getElementById('kpiApproved')?.textContent || '-', color: greenLight, icon: 'APPROVED' },
                    { label: 'Cost per Member', value: document.getElementById('kpiCost')?.textContent || '-', color: gold, icon: 'COST' },
                    { label: 'Utilization Rate', value: document.getElementById('kpiUtilization')?.textContent || '-', color: blue, icon: 'UTIL' },
                    { label: 'Inpatient Cases', value: document.getElementById('inpatientCases')?.textContent || '-', color: red, icon: 'INPAT' }
                ];
                
                const kpiBoxWidth = (contentWidth - 10) / 2;
                const kpiBoxHeight = 35;
                
                kpis.forEach((kpi, i) => {
                    const col = i % 2;
                    const row = Math.floor(i / 2);
                    const x = margin + (col * (kpiBoxWidth + 10));
                    const y = yPos + (row * (kpiBoxHeight + 8));
                    
                    // Box with left accent
                    doc.setFillColor(248, 250, 252);
                    doc.roundedRect(x, y, kpiBoxWidth, kpiBoxHeight, 2, 2, 'F');
                    doc.setFillColor(...kpi.color);
                    doc.rect(x, y, 4, kpiBoxHeight, 'F');
                    
                    // Label
                    doc.setFontSize(9);
                    doc.setTextColor(...textMuted);
                    doc.setFont('helvetica', 'normal');
                    doc.text(kpi.label.toUpperCase(), x + 10, y + 12);
                    
                    // Value
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...kpi.color);
                    doc.text(kpi.value, x + 10, y + 28);
                });
                
                // Period Comparison
                yPos += (kpiBoxHeight + 8) * 3 + 15;
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Period Comparison', margin, yPos);
                
                yPos += 8;
                
                // Comparison table
                const compHeaders = ['Metric', 'Current Period', 'Previous Period', 'Change'];
                const compData = [
                    ['Claims', document.getElementById('cmpClaims')?.textContent || '-', document.getElementById('cmpClaimsPrev')?.textContent || '-', document.getElementById('cmpClaimsChange')?.textContent || '-'],
                    ['Members', document.getElementById('cmpMembers')?.textContent || '-', document.getElementById('cmpMembersPrev')?.textContent || '-', document.getElementById('cmpMembersChange')?.textContent || '-'],
                    ['Approved (USD)', document.getElementById('cmpApproved')?.textContent || '-', document.getElementById('cmpApprovedPrev')?.textContent || '-', document.getElementById('cmpApprovedChange')?.textContent || '-'],
                    ['Cost/Member', document.getElementById('cmpCost')?.textContent || '-', document.getElementById('cmpCostPrev')?.textContent || '-', document.getElementById('cmpCostChange')?.textContent || '-']
                ];
                
                const colWidths = [45, 45, 45, 40];
                
                // Header row
                doc.setFillColor(...blue);
                doc.rect(margin, yPos, contentWidth, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                
                let xPos = margin + 5;
                compHeaders.forEach((h, i) => {
                    doc.text(h, xPos, yPos + 7);
                    xPos += colWidths[i];
                });
                
                yPos += 10;
                
                // Data rows
                compData.forEach((row, rowIdx) => {
                    doc.setFillColor(rowIdx % 2 === 0 ? 250 : 245, 250, rowIdx % 2 === 0 ? 252 : 248);
                    doc.rect(margin, yPos, contentWidth, 10, 'F');
                    
                    xPos = margin + 5;
                    row.forEach((cell, colIdx) => {
                        if (colIdx === 0) {
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(...textDark);
                        } else if (colIdx === 3) {
                            // Change column - color based on value
                            const isPositive = cell.includes('+') || cell.includes('');
                            const isNegative = cell.includes('-') || cell.includes('');
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(isPositive ? 76 : isNegative ? 211 : 120, isPositive ? 175 : isNegative ? 47 : 120, isPositive ? 80 : isNegative ? 47 : 120);
                        } else {
                            doc.setFont('helvetica', 'normal');
                            doc.setTextColor(...textDark);
                        }
                        doc.setFontSize(9);
                        doc.text(cell, xPos, yPos + 7);
                        xPos += colWidths[colIdx];
                    });
                    
                    yPos += 10;
                });
                
                // ==================== PAGE 3: INPATIENT VS OUTPATIENT ====================
                updateProgress(40, 'Adding inpatient/outpatient analysis...');
                await new Promise(r => setTimeout(r, 150));
                doc.addPage();
                
                // Header
                doc.setFillColor(...blue);
                doc.rect(0, 0, pageWidth, 30, 'F');
                doc.setFillColor(...gold);
                doc.rect(0, 28, pageWidth, 3, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text('MONTHLY REPORT | ' + periodLabel, margin, 12);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('02. Inpatient vs Outpatient', margin, 23);
                
                yPos = 45;
                
                // Get values
                const inpatientCases = document.getElementById('inpatientCases')?.textContent || '0';
                const outpatientCases = document.getElementById('outpatientCases')?.textContent || '0';
                const inpatientCost = document.getElementById('inpatientCost')?.textContent || '$0';
                const outpatientCost = document.getElementById('outpatientCost')?.textContent || '$0';
                
                // Overview boxes
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Case Distribution', margin, yPos);
                
                yPos += 8;
                
                // Inpatient big box
                doc.setFillColor(211, 47, 47);
                doc.roundedRect(margin, yPos, 85, 60, 4, 4, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('INPATIENT', margin + 10, yPos + 15);
                doc.setFontSize(28);
                doc.setFont('helvetica', 'bold');
                doc.text(inpatientCases, margin + 10, yPos + 38);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cases', margin + 10, yPos + 50);
                
                // Outpatient big box
                doc.setFillColor(25, 118, 210);
                doc.roundedRect(margin + 95, yPos, 85, 60, 4, 4, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('OUTPATIENT', margin + 105, yPos + 15);
                doc.setFontSize(28);
                doc.setFont('helvetica', 'bold');
                doc.text(outpatientCases, margin + 105, yPos + 38);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cases', margin + 105, yPos + 50);
                
                yPos += 75;
                
                // Cost Analysis
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Cost Analysis', margin, yPos);
                
                yPos += 10;
                
                // Cost comparison table
                doc.setFillColor(...blue);
                doc.rect(margin, yPos, contentWidth, 12, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Category', margin + 5, yPos + 8);
                doc.text('Total Cost', margin + 70, yPos + 8);
                doc.text('% of Total', margin + 130, yPos + 8);
                
                yPos += 12;
                
                // Parse costs for percentage calculation
                const inCostNum = parseFloat(inpatientCost.replace(/[^0-9.]/g, '')) || 0;
                const outCostNum = parseFloat(outpatientCost.replace(/[^0-9.]/g, '')) || 0;
                const totalCost = inCostNum + outCostNum;
                const inPct = totalCost > 0 ? ((inCostNum / totalCost) * 100).toFixed(1) : '0';
                const outPct = totalCost > 0 ? ((outCostNum / totalCost) * 100).toFixed(1) : '0';
                
                // Inpatient row
                doc.setFillColor(255, 235, 238);
                doc.rect(margin, yPos, contentWidth, 15, 'F');
                doc.setFillColor(211, 47, 47);
                doc.rect(margin, yPos, 4, 15, 'F');
                doc.setTextColor(...textDark);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Inpatient', margin + 10, yPos + 10);
                doc.text(inpatientCost, margin + 70, yPos + 10);
                doc.setTextColor(211, 47, 47);
                doc.text(inPct + '%', margin + 130, yPos + 10);
                
                yPos += 15;
                
                // Outpatient row
                doc.setFillColor(227, 242, 253);
                doc.rect(margin, yPos, contentWidth, 15, 'F');
                doc.setFillColor(25, 118, 210);
                doc.rect(margin, yPos, 4, 15, 'F');
                doc.setTextColor(...textDark);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Outpatient', margin + 10, yPos + 10);
                doc.text(outpatientCost, margin + 70, yPos + 10);
                doc.setTextColor(25, 118, 210);
                doc.text(outPct + '%', margin + 130, yPos + 10);
                
                yPos += 15;
                
                // Total row
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPos, contentWidth, 15, 'F');
                doc.setTextColor(...textDark);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL', margin + 10, yPos + 10);
                doc.text('$' + totalCost.toLocaleString(), margin + 70, yPos + 10);
                doc.text('100%', margin + 130, yPos + 10);
                
                yPos += 30;
                
                // Visual bar
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Cost Distribution', margin, yPos);
                
                yPos += 8;
                
                const barWidth = contentWidth;
                const barHeight = 20;
                const inBarWidth = totalCost > 0 ? (inCostNum / totalCost) * barWidth : barWidth / 2;
                
                doc.setFillColor(211, 47, 47);
                doc.roundedRect(margin, yPos, inBarWidth, barHeight, 2, 2, 'F');
                doc.setFillColor(25, 118, 210);
                doc.roundedRect(margin + inBarWidth, yPos, barWidth - inBarWidth, barHeight, 2, 2, 'F');
                
                // Labels on bar
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                if (inBarWidth > 30) doc.text('Inpatient ' + inPct + '%', margin + 5, yPos + 13);
                if (barWidth - inBarWidth > 30) doc.text('Outpatient ' + outPct + '%', margin + inBarWidth + 5, yPos + 13);
                
                // ==================== PAGE 4: CLAIMS ANALYSIS ====================
                updateProgress(60, 'Building claims analysis...');
                await new Promise(r => setTimeout(r, 150));
                doc.addPage();
                
                // Header
                doc.setFillColor(...blue);
                doc.rect(0, 0, pageWidth, 30, 'F');
                doc.setFillColor(...gold);
                doc.rect(0, 28, pageWidth, 3, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text('MONTHLY REPORT | ' + periodLabel, margin, 12);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('03. Claims Analysis', margin, 23);
                
                yPos = 45;
                
                // Claims Overview
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Claims Overview', margin, yPos);
                
                yPos += 10;
                
                const totalClaims = document.getElementById('kpiClaims')?.textContent || '0';
                const approvedAmount = document.getElementById('kpiApproved')?.textContent || '$0';
                const claimsNum = parseInt(totalClaims.replace(/,/g, '')) || 1;
                const approvedNum = parseFloat(approvedAmount.replace(/[^0-9.]/g, '')) || 0;
                const avgClaim = claimsNum > 0 ? (approvedNum / claimsNum).toFixed(2) : '0';
                
                // Claims metrics boxes
                const claimMetrics = [
                    { label: 'Total Claims', value: totalClaims, color: blue },
                    { label: 'Approved Amount', value: approvedAmount, color: greenDark },
                    { label: 'Average Claim', value: '$' + avgClaim, color: gold }
                ];
                
                const metricWidth = (contentWidth - 20) / 3;
                
                claimMetrics.forEach((m, i) => {
                    const x = margin + (i * (metricWidth + 10));
                    
                    doc.setFillColor(248, 250, 252);
                    doc.setDrawColor(...m.color);
                    doc.setLineWidth(0.5);
                    doc.roundedRect(x, yPos, metricWidth, 40, 3, 3, 'FD');
                    
                    doc.setFontSize(8);
                    doc.setTextColor(...textMuted);
                    doc.setFont('helvetica', 'normal');
                    doc.text(m.label.toUpperCase(), x + 5, yPos + 12);
                    
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...m.color);
                    doc.text(m.value, x + 5, yPos + 30);
                });
                
                yPos += 55;
                
                // Claims by Type
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Claims by Type', margin, yPos);
                
                yPos += 10;
                
                const claimTypes = [
                    { type: 'Inpatient Claims', count: inpatientCases, pct: '25%', color: [211, 47, 47] },
                    { type: 'Outpatient Claims', count: outpatientCases, pct: '75%', color: [25, 118, 210] }
                ];
                
                claimTypes.forEach((ct, i) => {
                    doc.setFillColor(250, 250, 252);
                    doc.roundedRect(margin, yPos, contentWidth, 25, 2, 2, 'F');
                    doc.setFillColor(...ct.color);
                    doc.rect(margin, yPos, 5, 25, 'F');
                    
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text(ct.type, margin + 12, yPos + 10);
                    
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...textMuted);
                    doc.text(ct.count + ' claims (' + ct.pct + ')', margin + 12, yPos + 19);
                    
                    // Progress bar
                    const pctNum = parseFloat(ct.pct) || 0;
                    const barStartX = margin + 120;
                    const barMaxWidth = 50;
                    
                    doc.setFillColor(230, 230, 230);
                    doc.roundedRect(barStartX, yPos + 8, barMaxWidth, 8, 2, 2, 'F');
                    doc.setFillColor(...ct.color);
                    doc.roundedRect(barStartX, yPos + 8, (pctNum / 100) * barMaxWidth, 8, 2, 2, 'F');
                    
                    yPos += 30;
                });
                
                // ==================== PAGE 5: COST BREAKDOWN ====================
                updateProgress(80, 'Creating cost breakdown...');
                await new Promise(r => setTimeout(r, 150));
                doc.addPage();
                
                // Header
                doc.setFillColor(...blue);
                doc.rect(0, 0, pageWidth, 30, 'F');
                doc.setFillColor(...gold);
                doc.rect(0, 28, pageWidth, 3, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text('MONTHLY REPORT | ' + periodLabel, margin, 12);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('04. Cost Breakdown', margin, 23);
                
                yPos = 45;
                
                // Cost Summary
                const costPerMember = document.getElementById('kpiCost')?.textContent || '$0';
                const costNum = parseFloat(costPerMember.replace(/[^0-9.]/g, '')) || 0;
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Cost per Member Analysis', margin, yPos);
                
                yPos += 10;
                
                // Big cost display
                doc.setFillColor(245, 250, 245);
                doc.setDrawColor(...greenDark);
                doc.setLineWidth(1);
                doc.roundedRect(margin, yPos, contentWidth, 50, 4, 4, 'FD');
                
                doc.setFontSize(12);
                doc.setTextColor(...textMuted);
                doc.text('TOTAL COST PER MEMBER', margin + 10, yPos + 18);
                
                doc.setFontSize(32);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...greenDark);
                doc.text(costPerMember, margin + 10, yPos + 40);
                
                // Target indicator
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...textMuted);
                doc.text('Target: $50.00', margin + 120, yPos + 40);
                
                yPos += 65;
                
                // Cost Components
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Cost Components', margin, yPos);
                
                yPos += 10;
                
                const baseCost = costNum * 0.70;
                const auditFee = baseCost * 0.15;
                const regFee = 24;
                const monthlyFee = 9;
                
                const costComponents = [
                    { label: 'Base Claims Cost', value: '$' + baseCost.toFixed(2), pct: '70%', color: greenDark },
                    { label: 'Audit Fee (15%)', value: '$' + auditFee.toFixed(2), pct: '10.5%', color: gold },
                    { label: 'Registration Fee', value: '$' + regFee.toFixed(2), pct: 'Annual', color: blue },
                    { label: 'Monthly Service Fee', value: '$' + monthlyFee.toFixed(2), pct: 'Annual', color: [156, 39, 176] }
                ];
                
                costComponents.forEach((cc, i) => {
                    doc.setFillColor(250, 250, 252);
                    doc.roundedRect(margin, yPos, contentWidth, 20, 2, 2, 'F');
                    doc.setFillColor(...cc.color);
                    doc.rect(margin, yPos, 4, 20, 'F');
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...textDark);
                    doc.text(cc.label, margin + 10, yPos + 13);
                    
                    doc.setFont('helvetica', 'bold');
                    doc.text(cc.value, margin + 100, yPos + 13);
                    
                    doc.setTextColor(...textMuted);
                    doc.setFontSize(9);
                    doc.text(cc.pct, margin + 150, yPos + 13);
                    
                    yPos += 24;
                });
                
                yPos += 10;
                
                // Total bar
                doc.setFillColor(...greenDark);
                doc.roundedRect(margin, yPos, contentWidth, 25, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL ANNUALIZED COST', margin + 10, yPos + 16);
                doc.text(costPerMember + ' per member', margin + 120, yPos + 16);
                
                // ==================== ADD PAGE NUMBERS ====================
                updateProgress(95, 'Finalizing...');
                await new Promise(r => setTimeout(r, 150));
                
                const totalPages = doc.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(...textMuted);
                    doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
                    if (i > 1) {
                        doc.text('Polaris Financial Services | Confidential', margin, pageHeight - 10);
                    }
                }
                
                // ==================== SAVE ====================
                updateProgress(100, 'Complete!');
                titleText.textContent = 'Monthly Report Ready!';
                statusText.textContent = 'Your report has been generated';
                stepText.textContent = 'Downloading...';
                
                await new Promise(r => setTimeout(r, 500));
                
                const fileName = `Polaris_Monthly_Report_${periodLabel.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 1500);
                
            } catch (error) {
                console.error('Report error:', error);
                titleText.textContent = 'Error';
                statusText.textContent = 'Failed to generate report';
                stepText.textContent = error.message;
                progressBar.style.background = '#e74c3c';
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 3000);
            }
        }
        
        async function showDashboard() {
            const loginModal = document.getElementById('loginModal');
            const mainContent = document.getElementById('mainContent');
            const mainFooter = document.getElementById('mainFooter');
            const loadingScreen = document.getElementById('loadingScreen');
            
            if (loginModal) loginModal.classList.add('hidden');
            if (mainContent) mainContent.style.display = 'block';
            if (mainFooter) mainFooter.style.display = 'block';
            if (loadingScreen) loadingScreen.classList.add('hidden');
            
            // Populate client selector
            populateClientSelector();
            
            // Always load mock data first to ensure charts render
            loadDataForSelectedQuarters();
            
            const lastUpdated = document.getElementById('lastUpdated');
            if (lastUpdated) lastUpdated.textContent = new Date().toLocaleString();
            
            // Then try API (if available, it will update with real data)
            try {
                await loadData();
            } catch(e) {
                console.error('Load data error:', e);
            }
        }
        
        async function loadData() {
            try {
                const r = await fetch(`${API_URL}?action=getMasterComparison`);
                const d = await r.json();
                if (d.success) updateDashboard(d.data);
            } catch(e) { 
                console.error('API not available, using mock data:', e); 
            }
        }
        
        function updateDashboard(data) {
            if (!data.current_period) return;
            const c = data.current_period, p = data.previous_period, ch = data.changes, periods = data.all_periods || [];
            
            // Update quarter data from API
            if (c.period_label) {
                const q = c.period_label.replace(' 2025', '').replace('2025-', '');
                if (quarterData[q]) {
                    quarterData[q] = {
                        members: c.members,
                        claims: c.claims,
                        approved_usd: c.approved_usd,
                        cost_per_member: c.cost_per_member
                    };
                }
            }
            
            if (p && document.getElementById('cmpPeriodLabel')) {
                document.getElementById('cmpPeriodLabel').textContent = `${c.period_label} vs ${p.period_label}`;
            }
            
            document.getElementById('kpiMembers').textContent = fmt(c.members);
            document.getElementById('kpiClaims').textContent = fmt(c.claims);
            document.getElementById('kpiApproved').textContent = '$' + fmt(c.approved_usd);
            document.getElementById('kpiCost').textContent = '$' + c.cost_per_member.toFixed(2);
            const util = c.members > 0 ? (c.claims / c.members * 100) : 0;
            document.getElementById('kpiUtilization').textContent = util.toFixed(1) + '%';
            document.getElementById('totalActive').textContent = fmt(c.members);
            
            if (ch) {
                setTrend('kpiMembersTrend', ch.members);
                setTrend('kpiClaimsTrend', ch.claims);
                setTrend('kpiApprovedTrend', ch.approved_usd);
                setTrend('kpiCostTrend', ch.cost_per_member);
            }
            
            if (p && ch) {
                document.getElementById('cmpClaims').textContent = fmt(c.claims);
                document.getElementById('cmpClaimsPrev').textContent = fmt(p.claims);
                setChange('cmpClaimsChange', ch.claims);
                document.getElementById('cmpMembers').textContent = fmt(c.members);
                document.getElementById('cmpMembersPrev').textContent = fmt(p.members);
                setChange('cmpMembersChange', ch.members);
                document.getElementById('cmpApproved').textContent = '$' + fmt(c.approved_usd);
                document.getElementById('cmpApprovedPrev').textContent = '$' + fmt(p.approved_usd);
                setChange('cmpApprovedChange', ch.approved_usd);
                document.getElementById('cmpCost').textContent = '$' + c.cost_per_member.toFixed(2);
                document.getElementById('cmpCostPrev').textContent = '$' + p.cost_per_member.toFixed(2);
                setChange('cmpCostChange', ch.cost_per_member);
            }
            
            // NEW: Inpatient/Outpatient/Ex Gratia data (mock - will come from CBMS/Excel)
            const inpatientPct = 22;
            const outpatientPct = 70;
            const exGratiaPct = 8;
            const inpatientCases = Math.round(c.claims * 0.22);
            const outpatientCases = Math.round(c.claims * 0.70);
            const exGratiaCases = c.claims - inpatientCases - outpatientCases;
            const inpatientCostVal = Math.round(c.approved_usd * 0.60);
            const outpatientCostVal = Math.round(c.approved_usd * 0.32);
            const exGratiaCostVal = c.approved_usd - inpatientCostVal - outpatientCostVal;
            
            document.getElementById('inpatientCases').textContent = fmt(inpatientCases);
            document.getElementById('outpatientCases').textContent = fmt(outpatientCases);
            document.getElementById('exGratiaCases').textContent = fmt(exGratiaCases);
            document.getElementById('inpatientCost').textContent = '$' + fmt(inpatientCostVal);
            document.getElementById('outpatientCost').textContent = '$' + fmt(outpatientCostVal);
            document.getElementById('exGratiaCost').textContent = '$' + fmt(exGratiaCostVal);
            
            // NEW: Principal/Dependent data (mock - will come from CBMS)
            const principalPct = 40;
            const dependentPct = 60;
            const principalMembers = Math.round(c.members * 0.4);
            const dependentMembers = c.members - principalMembers;
            
            document.getElementById('principalCount').textContent = fmt(principalMembers);
            document.getElementById('dependentCount').textContent = fmt(dependentMembers);
            
            // NEW: Member Movement (mock - will come from CBMS)
            const newEnroll = Math.round(c.members * 0.08);
            const cancelled = Math.round(c.members * 0.03);
            document.getElementById('newEnrollments').textContent = '+' + newEnroll;
            document.getElementById('cancellations').textContent = '-' + cancelled;
            document.getElementById('netChange').textContent = (newEnroll - cancelled > 0 ? '+' : '') + (newEnroll - cancelled);
            
            try { createCharts(periods, c); } catch(e) { console.error('createCharts error:', e); }
            try { createInOutCharts(periods, inpatientCases, outpatientCases, exGratiaCases, inpatientCostVal, outpatientCostVal, exGratiaCostVal); } catch(e) { console.error('createInOutCharts error:', e); }
            try { createMemberTypeCharts(principalMembers, dependentMembers, c.claims); } catch(e) { console.error('createMemberTypeCharts error:', e); }
            try { createMovementCharts(periods); } catch(e) { console.error('createMovementCharts error:', e); }
            try { createCostBreakdownChart(c); } catch(e) { console.error('createCostBreakdownChart error:', e); }
            
            // NEW: Additional charts - temporarily disabled for debugging
            try {
                createCategoryCharts(c);
                createYoYCharts(periods);
                createHospitalCharts();
                createGeoCharts();
            } catch(e) {
                console.error('New charts error:', e);
            }
            
            updateMetrics(util);
            updateInsights(ch);
            updateTable(periods);
        }
        
        function createInOutCharts(periods, inCases, outCases, exGratiaCases, inCost, outCost, exGratiaCost) {
            // Inpatient/Outpatient/Ex Gratia Pie
            const ctx1 = document.getElementById('inOutPieChart').getContext('2d');
            if (charts.inOutPie) charts.inOutPie.destroy();
            
            const redGrad = ctx1.createLinearGradient(0, 0, 0, 300);
            redGrad.addColorStop(0, '#EF5350');
            redGrad.addColorStop(1, '#B71C1C');
            const blueGrad = ctx1.createLinearGradient(0, 0, 0, 300);
            blueGrad.addColorStop(0, '#42A5F5');
            blueGrad.addColorStop(1, '#1565C0');
            const purpleGrad = ctx1.createLinearGradient(0, 0, 0, 300);
            purpleGrad.addColorStop(0, '#FFD700');
            purpleGrad.addColorStop(1, '#B8860B');
            
            charts.inOutPie = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Inpatient', 'Outpatient', 'Ex Gratia'],
                    datasets: [{ 
                        data: [inCases, outCases, exGratiaCases], 
                        backgroundColor: [redGrad, blueGrad, purpleGrad], 
                        borderWidth: 3,
                        borderColor: ['#B71C1C', '#0D47A1', '#8B7500'],
                        hoverOffset: 15,
                        hoverBorderWidth: 4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '55%', 
                    plugins: { 
                        legend: { display: true, position: 'bottom', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20, boxWidth: 16, boxHeight: 16 } }
                    }
                }
            });
            
            // Cost Comparison Bar
            const ctx2 = document.getElementById('inOutCostChart').getContext('2d');
            if (charts.inOutCost) charts.inOutCost.destroy();
            
            const barRedGrad = ctx2.createLinearGradient(0, 0, 0, 250);
            barRedGrad.addColorStop(0, '#EF9A9A');
            barRedGrad.addColorStop(0.3, '#EF5350');
            barRedGrad.addColorStop(1, '#C62828');
            const barBlueGrad = ctx2.createLinearGradient(0, 0, 0, 250);
            barBlueGrad.addColorStop(0, '#90CAF9');
            barBlueGrad.addColorStop(0.3, '#42A5F5');
            barBlueGrad.addColorStop(1, '#1565C0');
            const barPurpleGrad = ctx2.createLinearGradient(0, 0, 0, 250);
            barPurpleGrad.addColorStop(0, '#FFE082');
            barPurpleGrad.addColorStop(0.3, '#DAA520');
            barPurpleGrad.addColorStop(1, '#B8860B');
            
            charts.inOutCost = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Inpatient', 'Outpatient', 'Ex Gratia'],
                    datasets: [{ 
                        data: [inCost, outCost, exGratiaCost], 
                        backgroundColor: [barRedGrad, barBlueGrad, barPurpleGrad], 
                        borderRadius: { topLeft: 8, topRight: 8, bottomLeft: 0, bottomRight: 0 },
                        borderWidth: 2,
                        borderColor: ['#B71C1C', '#0D47A1', '#8B7500'],
                        barPercentage: 0.7
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { weight: 'bold', size: 10 } } }, 
                        y: { grid: { color: 'rgba(30,58,30,0.5)' }, ticks: { color: '#7a8f7a', callback: v => '$' + fmt(v) } } 
                    }
                }
            });
            
            // Trend Chart with Ex Gratia
            const ctx3 = document.getElementById('inOutTrendChart').getContext('2d');
            if (charts.inOutTrend) charts.inOutTrend.destroy();
            
            const fillRed = ctx3.createLinearGradient(0, 0, 0, 200);
            fillRed.addColorStop(0, 'rgba(231,76,60,0.4)');
            fillRed.addColorStop(1, 'rgba(231,76,60,0.05)');
            const fillBlue = ctx3.createLinearGradient(0, 0, 0, 200);
            fillBlue.addColorStop(0, 'rgba(52,152,219,0.4)');
            fillBlue.addColorStop(1, 'rgba(52,152,219,0.05)');
            const fillGold = ctx3.createLinearGradient(0, 0, 0, 200);
            fillGold.addColorStop(0, 'rgba(212,175,55,0.4)');
            fillGold.addColorStop(1, 'rgba(212,175,55,0.05)');
            
            charts.inOutTrend = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: periods.map(p => p.period_label),
                    datasets: [
                        { 
                            label: 'Inpatient', 
                            data: periods.map(p => Math.round(p.claims * 0.22)), 
                            borderColor: '#e74c3c', 
                            backgroundColor: fillRed, 
                            fill: true, 
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: '#e74c3c',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 7
                        },
                        { 
                            label: 'Outpatient', 
                            data: periods.map(p => Math.round(p.claims * 0.70)), 
                            borderColor: '#3498db', 
                            backgroundColor: fillBlue, 
                            fill: true, 
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: '#3498db',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 7
                        },
                        { 
                            label: 'Ex Gratia', 
                            data: periods.map(p => Math.round(p.claims * 0.08)), 
                            borderColor: '#D4AF37', 
                            backgroundColor: fillGold, 
                            fill: true, 
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: '#D4AF37',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 7
                        }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: true, position: 'top', labels: { color: '#b8c9b8', font: { weight: 'bold', size: 11 } } }
                    }, 
                    scales: { 
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8' } }, 
                        y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } } 
                    }
                }
            });
        }
        
        function createMemberTypeCharts(principal, dependent, claims) {
            // Member Type Pie - Doughnut
            const ctx1 = document.getElementById('memberTypePieChart').getContext('2d');
            if (charts.memberPie) charts.memberPie.destroy();
            
            // Create gradient for 3D effect
            const greenGrad = ctx1.createLinearGradient(0, 0, 0, 300);
            greenGrad.addColorStop(0, '#4CAF50');
            greenGrad.addColorStop(1, '#1B5E20');
            const goldGrad = ctx1.createLinearGradient(0, 0, 0, 300);
            goldGrad.addColorStop(0, '#FFD700');
            goldGrad.addColorStop(1, '#B8860B');
            
            charts.memberPie = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Seafarers', 'Dependents'],
                    datasets: [{ 
                        data: [principal, dependent], 
                        backgroundColor: [greenGrad, goldGrad], 
                        borderWidth: 3,
                        borderColor: ['#1B5E20', '#8B7500'],
                        hoverOffset: 15,
                        hoverBorderWidth: 4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '55%', 
                    plugins: { 
                        legend: { display: true, position: 'bottom', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20, boxWidth: 16, boxHeight: 16 } }
                    },
                    animation: { animateRotate: true, animateScale: true }
                }
            });
            
            // Claims by Member Type - Bar Chart
            const ctx2 = document.getElementById('memberTypeClaimsChart').getContext('2d');
            if (charts.memberClaims) charts.memberClaims.destroy();
            
            const principalClaims = Math.round(claims * 0.55);
            const dependentClaims = claims - principalClaims;
            
            // Update stat values
            document.getElementById('principalClaims').textContent = fmt(principalClaims);
            document.getElementById('dependentClaims').textContent = fmt(dependentClaims);
            
            charts.memberClaims = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Seafarer Claims', 'Dependent Claims'],
                    datasets: [{ 
                        data: [principalClaims, dependentClaims], 
                        backgroundColor: [greenGrad, goldGrad], 
                        borderWidth: 3,
                        borderColor: ['#1B5E20', '#8B7500'],
                        hoverOffset: 15
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '55%', 
                    plugins: { 
                        legend: { display: true, position: 'bottom', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20 } }
                    }
                }
            });
        }
        
        function createMovementCharts(periods) {
            // Movement Compare Chart - Side by side bars (Enrollments vs Cancellations)
            const ctx1 = document.getElementById('movementCompareChart').getContext('2d');
            if (charts.movementCompare) charts.movementCompare.destroy();
            
            const enrollGrad = ctx1.createLinearGradient(0, 0, 0, 250);
            enrollGrad.addColorStop(0, '#A5D6A7');
            enrollGrad.addColorStop(0.5, '#66BB6A');
            enrollGrad.addColorStop(1, '#2E7D32');
            
            const cancelGrad = ctx1.createLinearGradient(0, 0, 0, 250);
            cancelGrad.addColorStop(0, '#EF9A9A');
            cancelGrad.addColorStop(0.5, '#EF5350');
            cancelGrad.addColorStop(1, '#C62828');
            
            charts.movementCompare = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: periods.map(p => p.period_label),
                    datasets: [
                        { 
                            label: 'New Enrollments',
                            data: periods.map(p => Math.round(p.members * 0.08)), 
                            backgroundColor: enrollGrad, 
                            borderRadius: 6,
                            borderWidth: 2,
                            borderColor: '#1B5E20',
                            barPercentage: 0.8,
                            categoryPercentage: 0.7
                        },
                        { 
                            label: 'Cancellations',
                            data: periods.map(p => Math.round(p.members * 0.03)), 
                            backgroundColor: cancelGrad,
                            borderRadius: 6,
                            borderWidth: 2,
                            borderColor: '#B71C1C',
                            barPercentage: 0.8,
                            categoryPercentage: 0.7
                        }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { 
                            display: true, 
                            position: 'top', 
                            labels: { 
                                color: '#b8c9b8', 
                                font: { size: 13, weight: 'bold' },
                                usePointStyle: true,
                                pointStyle: 'rectRounded'
                            } 
                        } 
                    }, 
                    scales: { 
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 12, weight: 'bold' } } }, 
                        y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', font: { size: 12 } } } 
                    }
                }
            });
            
            // Movement Trend Chart - Combined line chart with net change
            const ctx2 = document.getElementById('movementTrendChart').getContext('2d');
            if (charts.movementTrend) charts.movementTrend.destroy();
            
            const netGrad = ctx2.createLinearGradient(0, 0, 0, 250);
            netGrad.addColorStop(0, 'rgba(212,175,55,0.4)');
            netGrad.addColorStop(1, 'rgba(212,175,55,0.05)');
            
            charts.movementTrend = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: periods.map(p => p.period_label),
                    datasets: [
                        { 
                            label: 'Enrollments',
                            data: periods.map(p => Math.round(p.members * 0.08)), 
                            borderColor: '#4CAF50', 
                            backgroundColor: 'rgba(76,175,80,0.1)',
                            fill: false,
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: '#4CAF50',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 8
                        },
                        { 
                            label: 'Cancellations',
                            data: periods.map(p => Math.round(p.members * 0.03)), 
                            borderColor: '#e74c3c', 
                            backgroundColor: 'rgba(231,76,60,0.1)',
                            fill: false,
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: '#e74c3c',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 8
                        },
                        { 
                            label: 'Net Change',
                            data: periods.map(p => Math.round(p.members * 0.05)), 
                            borderColor: '#FFD700', 
                            backgroundColor: netGrad, 
                            fill: true, 
                            tension: 0.4,
                            borderWidth: 4,
                            pointBackgroundColor: '#FFD700',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 3,
                            pointRadius: 6,
                            pointHoverRadius: 10
                        }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { 
                            display: true, 
                            position: 'top', 
                            labels: { 
                                color: '#b8c9b8', 
                                font: { size: 13, weight: 'bold' },
                                usePointStyle: true 
                            } 
                        } 
                    }, 
                    scales: { 
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 12, weight: 'bold' } } }, 
                        y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', font: { size: 12 } } } 
                    }
                }
            });
            
            // Full Width Trend Chart
            const ctx3 = document.getElementById('movementFullTrendChart').getContext('2d');
            if (charts.movementFullTrend) charts.movementFullTrend.destroy();
            
            const fillGreen = ctx3.createLinearGradient(0, 0, 0, 200);
            fillGreen.addColorStop(0, 'rgba(76,175,80,0.3)');
            fillGreen.addColorStop(1, 'rgba(76,175,80,0.05)');
            const fillRed = ctx3.createLinearGradient(0, 0, 0, 200);
            fillRed.addColorStop(0, 'rgba(231,76,60,0.3)');
            fillRed.addColorStop(1, 'rgba(231,76,60,0.05)');
            
            charts.movementFullTrend = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: periods.map(p => p.period_label),
                    datasets: [
                        { 
                            label: 'New Enrollments',
                            data: periods.map(p => Math.round(p.members * 0.08)), 
                            borderColor: '#4CAF50', 
                            backgroundColor: fillGreen,
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: '#4CAF50',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 10
                        },
                        { 
                            label: 'Cancellations',
                            data: periods.map(p => Math.round(p.members * 0.03)), 
                            borderColor: '#e74c3c', 
                            backgroundColor: fillRed,
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: '#e74c3c',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 10
                        }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { 
                            display: true, 
                            position: 'top', 
                            labels: { 
                                color: '#b8c9b8', 
                                font: { size: 14, weight: 'bold' },
                                usePointStyle: true,
                                padding: 25
                            } 
                        } 
                    }, 
                    scales: { 
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 13, weight: 'bold' } } }, 
                        y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', font: { size: 12 } } } 
                    }
                }
            });
        }
        
        function createCostBreakdownChart(current) {
            const ctx = document.getElementById('costBreakdownChart').getContext('2d');
            if (charts.costBreakdown) charts.costBreakdown.destroy();
            
            // 3D Shadow plugin
            const shadow3D = {
                id: 'shadow3D',
                beforeDraw: (chart) => {
                    const ctx = chart.ctx;
                    ctx.save();
                    ctx.shadowColor = 'rgba(0,0,0,0.4)';
                    ctx.shadowBlur = 12;
                    ctx.shadowOffsetX = 6;
                    ctx.shadowOffsetY = 6;
                }
            };
            
            const baseCost = current.cost_per_member * 0.7;
            const auditFee = baseCost * 0.15;
            const regFee = 24;
            const monthlyFee = 9;
            
            // Create gradients for 3D effect
            const greenGrad = ctx.createLinearGradient(0, 0, 0, 300);
            greenGrad.addColorStop(0, '#66BB6A');
            greenGrad.addColorStop(0.5, '#43A047');
            greenGrad.addColorStop(1, '#2E7D32');
            
            const goldGrad = ctx.createLinearGradient(0, 0, 0, 300);
            goldGrad.addColorStop(0, '#FFE082');
            goldGrad.addColorStop(0.5, '#FFD54F');
            goldGrad.addColorStop(1, '#FFC107');
            
            const blueGrad = ctx.createLinearGradient(0, 0, 0, 300);
            blueGrad.addColorStop(0, '#64B5F6');
            blueGrad.addColorStop(0.5, '#42A5F5');
            blueGrad.addColorStop(1, '#1E88E5');
            
            const purpleGrad = ctx.createLinearGradient(0, 0, 0, 300);
            purpleGrad.addColorStop(0, '#4DD0E1');
            purpleGrad.addColorStop(0.5, '#00BCD4');
            purpleGrad.addColorStop(1, '#00838F');
            
            const redGrad = ctx.createLinearGradient(0, 0, 0, 300);
            redGrad.addColorStop(0, '#EF5350');
            redGrad.addColorStop(0.5, '#E53935');
            redGrad.addColorStop(1, '#C62828');
            
            charts.costBreakdown = new Chart(ctx, {
                type: 'bar',
                plugins: [shadow3D],
                data: {
                    labels: ['Base Claims', 'Audit Fee', 'Registration', 'Monthly', 'Total'],
                    datasets: [{
                        data: [baseCost, auditFee, regFee, monthlyFee, current.cost_per_member],
                        backgroundColor: [greenGrad, goldGrad, blueGrad, purpleGrad, redGrad],
                        borderRadius: { topLeft: 8, topRight: 8, bottomLeft: 0, bottomRight: 0 },
                        borderWidth: 2,
                        borderColor: ['#1B5E20', '#F57F17', '#1565C0', '#006064', '#B71C1C'],
                        barPercentage: 0.7
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { weight: 'bold', size: 10 } } }, 
                        y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', callback: v => '$' + v.toFixed(0) } } 
                    } 
                }
            });
        }
        
        // ============ NEW SECTIONS CHARTS ============
        
        function createCategoryCharts(current) {
            // Mock data - will come from Excel/CBMS
            const categories = [
                { name: 'Medical', cases: 450, cost: 125000, color: '#4CAF50' },
                { name: 'Dental', cases: 180, cost: 28000, color: '#2196F3' },
                { name: 'Maternity', cases: 45, cost: 85000, color: '#E91E63' },
                { name: 'Optical', cases: 120, cost: 15000, color: '#FF9800' },
                { name: 'Laboratory', cases: 280, cost: 42000, color: '#D4AF37' },
                { name: 'Other', cases: 95, cost: 18000, color: '#607D8B' }
            ];
            
            // Update stat values
            document.getElementById('catMedical').textContent = categories[0].cases;
            document.getElementById('catDental').textContent = categories[1].cases;
            document.getElementById('catMaternity').textContent = categories[2].cases;
            document.getElementById('catOptical').textContent = categories[3].cases;
            document.getElementById('catLab').textContent = categories[4].cases;
            document.getElementById('catOther').textContent = categories[5].cases;
            
            // Category Pie Chart
            const ctx1 = document.getElementById('categoryPieChart').getContext('2d');
            if (charts.categoryPie) charts.categoryPie.destroy();
            charts.categoryPie = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: categories.map(c => c.name),
                    datasets: [{
                        data: categories.map(c => c.cases),
                        backgroundColor: categories.map(c => c.color),
                        borderWidth: 2,
                        borderColor: '#0a1a0a',
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '55%',
                    plugins: { legend: { display: true, position: 'right', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20, boxWidth: 16, boxHeight: 16 } } }
                }
            });
            
            // Category Cost Bar Chart
            const ctx2 = document.getElementById('categoryCostChart').getContext('2d');
            if (charts.categoryCost) charts.categoryCost.destroy();
            charts.categoryCost = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: categories.map(c => c.name),
                    datasets: [{
                        data: categories.map(c => c.cost),
                        backgroundColor: categories.map(c => c.color + 'CC'),
                        borderColor: categories.map(c => c.color),
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', callback: v => '$' + fmt(v) } },
                        y: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 10 } } }
                    }
                }
            });
            
            // Category Trend Chart
            const ctx3 = document.getElementById('categoryTrendChart').getContext('2d');
            if (charts.categoryTrend) charts.categoryTrend.destroy();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            charts.categoryTrend = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: categories.slice(0, 4).map(cat => ({
                        label: cat.name,
                        data: months.map(() => Math.round(cat.cases / 6 * (0.8 + Math.random() * 0.4))),
                        borderColor: cat.color,
                        backgroundColor: cat.color + '20',
                        fill: false,
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 4
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'top', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20 } } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8' } },
                        y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } }
                    }
                }
            });
        }
        
        function createYoYCharts(periods) {
            // Mock YoY data
            const data2024 = { claims: 3850, cost: 285000, members: 980 };
            const data2025 = { claims: 4320, cost: 312000, members: 1127 };
            
            // Update YoY stats
            document.getElementById('yoyClaims2025').textContent = fmt(data2025.claims);
            document.getElementById('yoyClaims2024').textContent = fmt(data2024.claims);
            document.getElementById('yoyCost2025').textContent = '$' + fmt(data2025.cost);
            document.getElementById('yoyCost2024').textContent = '$' + fmt(data2024.cost);
            
            const claimsChange = ((data2025.claims - data2024.claims) / data2024.claims * 100).toFixed(0);
            const costChange = ((data2025.cost - data2024.cost) / data2024.cost * 100).toFixed(0);
            const memberChange = ((data2025.members - data2024.members) / data2024.members * 100).toFixed(0);
            const costPerMember2024 = data2024.cost / data2024.members;
            const costPerMember2025 = data2025.cost / data2025.members;
            const cpmChange = ((costPerMember2025 - costPerMember2024) / costPerMember2024 * 100).toFixed(0);
            
            document.getElementById('yoyClaimsChange').textContent = (claimsChange > 0 ? '+' : '') + claimsChange + '%';
            document.getElementById('yoyCostChange').textContent = (costChange > 0 ? '+' : '') + costChange + '%';
            document.getElementById('yoyMemberChange').textContent = (memberChange > 0 ? '+' : '') + memberChange + '%';
            document.getElementById('yoyCostPerMember').textContent = (cpmChange > 0 ? '+' : '') + cpmChange + '%';
            
            // YoY Claims Chart
            const ctx1 = document.getElementById('yoyClaimsChart').getContext('2d');
            if (charts.yoyClaims) charts.yoyClaims.destroy();
            charts.yoyClaims = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Q1', 'Q2', 'Q3', 'Q4'],
                    datasets: [
                        { label: '2024', data: [920, 980, 1050, 900], backgroundColor: 'rgba(122,143,122,0.7)', borderRadius: 4 },
                        { label: '2025', data: [1080, 1150, 1090, null], backgroundColor: 'rgba(212,175,55,0.8)', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'top', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20 } } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8' } },
                        y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } }
                    }
                }
            });
            
            // YoY Cost Chart
            const ctx2 = document.getElementById('yoyCostChart').getContext('2d');
            if (charts.yoyCost) charts.yoyCost.destroy();
            charts.yoyCost = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Q1', 'Q2', 'Q3', 'Q4'],
                    datasets: [
                        { label: '2024', data: [68000, 72000, 78000, 67000], backgroundColor: 'rgba(122,143,122,0.7)', borderRadius: 4 },
                        { label: '2025', data: [82000, 95000, 88000, null], backgroundColor: 'rgba(76,175,80,0.8)', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'top', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20 } } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8' } },
                        y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', callback: v => '$' + fmt(v) } }
                    }
                }
            });
            
            // YoY Trend Chart
            const ctx3 = document.getElementById('yoyTrendChart').getContext('2d');
            if (charts.yoyTrend) charts.yoyTrend.destroy();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'];
            charts.yoyTrend = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        { 
                            label: '2025', 
                            data: [320, 380, 410, 350, 420, 380, 390, 410, 360],
                            borderColor: '#D4AF37',
                            backgroundColor: 'rgba(212,175,55,0.2)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: 5
                        },
                        { 
                            label: '2024', 
                            data: [280, 320, 350, 310, 380, 340, 360, 390, 320],
                            borderColor: '#7a8f7a',
                            backgroundColor: 'rgba(122,143,122,0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'top', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20 } } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8' } },
                        y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } }
                    }
                }
            });
        }
        
        function createHospitalCharts() {
            // Mock hospital data - will come from CBMS
            const hospitals = [
                { name: 'St. Luke\'s BGC', claims: 185, cost: 452000 },
                { name: 'Makati Medical', claims: 156, cost: 380000 },
                { name: 'The Medical City', claims: 142, cost: 325000 },
                { name: 'Asian Hospital', claims: 128, cost: 298000 },
                { name: 'Manila Doctors', claims: 115, cost: 245000 },
                { name: 'Cardinal Santos', claims: 98, cost: 215000 },
                { name: 'Chong Hua Cebu', claims: 87, cost: 178000 },
                { name: 'UERM', claims: 76, cost: 145000 },
                { name: 'PGH', claims: 68, cost: 98000 },
                { name: 'Others', claims: 315, cost: 480000 }
            ];
            
            const totalCost = hospitals.reduce((a, h) => a + h.cost, 0);
            
            // Top Hospitals by Claims
            const ctx1 = document.getElementById('topHospitalsChart').getContext('2d');
            if (charts.topHospitals) charts.topHospitals.destroy();
            charts.topHospitals = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: hospitals.map(h => h.name),
                    datasets: [{
                        data: hospitals.map(h => h.claims),
                        backgroundColor: 'rgba(76,175,80,0.7)',
                        borderColor: '#4CAF50',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } },
                        y: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 9 } } }
                    }
                }
            });
            
            // Top Hospitals by Cost
            const ctx2 = document.getElementById('topHospitalsCostChart').getContext('2d');
            if (charts.topHospitalsCost) charts.topHospitalsCost.destroy();
            charts.topHospitalsCost = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: hospitals.map(h => h.name),
                    datasets: [{
                        data: hospitals.map(h => h.cost),
                        backgroundColor: 'rgba(212,175,55,0.7)',
                        borderColor: '#D4AF37',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', callback: v => '$' + fmt(v) } },
                        y: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 9 } } }
                    }
                }
            });
            
            // Hospital Table
            const tbody = document.getElementById('hospitalsTableBody');
            tbody.innerHTML = hospitals.map((h, i) => `
                <tr>
                    <td><span style="background:${i < 3 ? '#D4AF37' : '#2E7D32'};color:#000;padding:2px 8px;border-radius:10px;font-weight:bold">${i + 1}</span></td>
                    <td><strong>${h.name}</strong></td>
                    <td>${h.claims}</td>
                    <td>$${fmt(h.cost)}</td>
                    <td>$${fmt(Math.round(h.cost / h.claims))}</td>
                    <td>${(h.cost / totalCost * 100).toFixed(1)}%</td>
                </tr>
            `).join('');
        }
        
        function createGeoCharts() {
            // Mock geographic data - will come from CBMS
            const regions = [
                { name: 'NCR', claims: 580, cost: 1250000, color: '#4CAF50' },
                { name: 'Central Visayas', claims: 245, cost: 485000, color: '#2196F3' },
                { name: 'Davao Region', claims: 165, cost: 320000, color: '#FF9800' },
                { name: 'Western Visayas', claims: 125, cost: 215000, color: '#D4AF37' },
                { name: 'Central Luzon', claims: 95, cost: 165000, color: '#E91E63' },
                { name: 'Other Regions', claims: 160, cost: 280000, color: '#607D8B' }
            ];
            
            // Update city stats
            document.getElementById('geoManila').textContent = '580';
            document.getElementById('geoCebu').textContent = '185';
            document.getElementById('geoDavao').textContent = '165';
            document.getElementById('geoIloilo').textContent = '95';
            document.getElementById('geoOther').textContent = '345';
            
            // Region Pie Chart
            const ctx1 = document.getElementById('geoRegionChart').getContext('2d');
            if (charts.geoRegion) charts.geoRegion.destroy();
            charts.geoRegion = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: regions.map(r => r.name),
                    datasets: [{
                        data: regions.map(r => r.claims),
                        backgroundColor: regions.map(r => r.color),
                        borderWidth: 2,
                        borderColor: '#0a1a0a',
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '55%',
                    plugins: { legend: { display: true, position: 'right', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20, boxWidth: 16, boxHeight: 16 } } }
                }
            });
            
            // Region Cost Chart
            const ctx2 = document.getElementById('geoCostChart').getContext('2d');
            if (charts.geoCost) charts.geoCost.destroy();
            charts.geoCost = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: regions.map(r => r.name),
                    datasets: [{
                        data: regions.map(r => r.cost),
                        backgroundColor: regions.map(r => r.color + 'CC'),
                        borderColor: regions.map(r => r.color),
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', callback: v => '$' + fmt(v) } },
                        y: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 9 } } }
                    }
                }
            });
            
            // Cities Bar Chart
            const ctx3 = document.getElementById('geoCitiesChart').getContext('2d');
            if (charts.geoCities) charts.geoCities.destroy();
            const cities = [
                { name: 'Manila', claims: 285 },
                { name: 'Quezon City', claims: 165 },
                { name: 'Cebu City', claims: 145 },
                { name: 'Davao City', claims: 125 },
                { name: 'Makati', claims: 95 },
                { name: 'Pasig', claims: 85 },
                { name: 'Iloilo City', claims: 75 },
                { name: 'Taguig', claims: 65 }
            ];
            charts.geoCities = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: cities.map(c => c.name),
                    datasets: [{
                        data: cities.map(c => c.claims),
                        backgroundColor: [
                            '#4CAF50', '#66BB6A', '#2196F3', '#FF9800', 
                            '#D4AF37', '#E91E63', '#00BCD4', '#607D8B'
                        ],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 13, weight: 'bold' } } },
                        y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', font: { size: 12 } } }
                    }
                }
            });
        }
        
        function setTrend(id, ch) {
            const el = document.getElementById(id);
            if (!ch || ch.percentage === null) { el.textContent = 'N/A'; return; }
            el.innerHTML = `${ch.percentage > 0 ? '' : ''} ${Math.abs(ch.percentage).toFixed(1)}%`;
            // For costs: down is good (green), up is bad (red)
            // For members/claims: up can be either based on context
            el.className = `kpi-trend ${ch.percentage <= 0 ? 'down' : 'up'}`;
        }
        
        function setChange(id, ch) {
            const el = document.getElementById(id);
            if (!ch || ch.percentage === null) { el.textContent = 'N/A'; return; }
            el.innerHTML = `${ch.percentage > 0 ? '' : ''} ${Math.abs(ch.percentage).toFixed(1)}%`;
            el.className = `cmp-change ${ch.percentage >= 0 ? 'positive' : 'negative'}`;
        }
        
        function createCharts(periods, current) {
            const labels = periods.map(p => p.period_label);
            
            // 3D Shadow plugin
            const shadow3D = {
                id: 'shadow3D',
                beforeDraw: (chart) => {
                    const ctx = chart.ctx;
                    ctx.save();
                    ctx.shadowColor = 'rgba(0,0,0,0.4)';
                    ctx.shadowBlur = 12;
                    ctx.shadowOffsetX = 5;
                    ctx.shadowOffsetY = 5;
                }
            };
            
            const opts = {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(13,31,13,0.95)', borderColor: '#D4AF37', borderWidth: 2, titleFont: { weight: 'bold' } } }
            };
            
            // Cost Trend - 3D Line
            const ctx1 = document.getElementById('costTrendChart').getContext('2d');
            if (charts.cost) charts.cost.destroy();
            const grad = ctx1.createLinearGradient(0, 0, 0, 350);
            grad.addColorStop(0, 'rgba(255,215,0,0.5)'); grad.addColorStop(1, 'rgba(255,215,0,0.02)');
            charts.cost = new Chart(ctx1, {
                type: 'line',
                data: { 
                    labels, 
                    datasets: [{ 
                        data: periods.map(p => p.cost_per_member), 
                        borderColor: '#FFD700', 
                        backgroundColor: grad, 
                        fill: true, 
                        tension: 0.4, 
                        pointRadius: 6, 
                        pointHoverRadius: 10,
                        pointBackgroundColor: '#FFD700',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3,
                        borderWidth: 4 
                    }] 
                },
                options: { ...opts, scales: { x: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#b8c9b8' } }, y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#D4AF37', font: { weight: 'bold' }, callback: v => '$' + v } } } }
            });
            
            // Approved - 3D Bars
            const ctx2 = document.getElementById('approvedChart').getContext('2d');
            if (charts.approved) charts.approved.destroy();
            const approvedGrad = ctx2.createLinearGradient(0, 0, 0, 300);
            approvedGrad.addColorStop(0, '#81C784');
            approvedGrad.addColorStop(0.5, '#4CAF50');
            approvedGrad.addColorStop(1, '#2E7D32');
            charts.approved = new Chart(ctx2, {
                type: 'bar',
                plugins: [shadow3D],
                data: { 
                    labels, 
                    datasets: [{ 
                        data: periods.map(p => p.approved_usd), 
                        backgroundColor: approvedGrad, 
                        borderColor: '#1B5E20', 
                        borderWidth: 2, 
                        borderRadius: { topLeft: 8, topRight: 8, bottomLeft: 0, bottomRight: 0 },
                        barPercentage: 0.7
                    }] 
                },
                options: { ...opts, scales: { x: { grid: { display: false }, ticks: { color: '#b8c9b8' } }, y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', callback: v => '$' + fmt(v) } } } }
            });
            
            // Gauge - Enhanced 3D
            const canvas = document.getElementById('gaugeChart');
            const gctx = canvas.getContext('2d');
            const pct = Math.min(current.cost_per_member / 100, 1);
            gctx.clearRect(0, 0, 200, 200);
            
            // Outer shadow ring
            gctx.shadowColor = 'rgba(0,0,0,0.5)';
            gctx.shadowBlur = 15;
            gctx.shadowOffsetX = 5;
            gctx.shadowOffsetY = 5;
            
            // Background ring
            gctx.beginPath(); gctx.arc(100, 100, 75, Math.PI * 0.75, Math.PI * 2.25); 
            gctx.lineWidth = 22; gctx.strokeStyle = '#1e3a1e'; gctx.lineCap = 'round'; gctx.stroke();
            
            // Gradient ring
            const gg = gctx.createLinearGradient(0, 0, 200, 0); 
            gg.addColorStop(0, '#4CAF50'); gg.addColorStop(0.5, '#FFD700'); gg.addColorStop(1, '#f44336');
            gctx.beginPath(); gctx.arc(100, 100, 75, Math.PI * 0.75, Math.PI * 0.75 + Math.PI * 1.5 * pct); 
            gctx.lineWidth = 18; gctx.strokeStyle = gg; gctx.lineCap = 'round'; gctx.stroke();
            
            // Reset shadow
            gctx.shadowColor = 'transparent';
            document.getElementById('gaugeValue').textContent = '$' + current.cost_per_member.toFixed(2);
            
            // Claims by Period - 3D Bars
            const ctx3 = document.getElementById('claimsPeriodChart').getContext('2d');
            if (charts.claimsPeriod) charts.claimsPeriod.destroy();
            const claimsGrad = ctx3.createLinearGradient(0, 0, 0, 250);
            claimsGrad.addColorStop(0, '#FFE082');
            claimsGrad.addColorStop(0.5, '#FFD54F');
            claimsGrad.addColorStop(1, '#FFC107');
            charts.claimsPeriod = new Chart(ctx3, {
                type: 'bar',
                plugins: [shadow3D],
                data: { 
                    labels, 
                    datasets: [{ 
                        data: periods.map(p => p.claims), 
                        backgroundColor: claimsGrad, 
                        borderColor: '#F57F17',
                        borderWidth: 2,
                        borderRadius: { topLeft: 6, topRight: 6, bottomLeft: 0, bottomRight: 0 },
                        barPercentage: 0.6
                    }] 
                },
                options: { ...opts, scales: { x: { grid: { display: false }, ticks: { color: '#b8c9b8' } }, y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } } } }
            });
            
            // Claims per 1000 - 3D Line
            const ctx4 = document.getElementById('claims1000Chart').getContext('2d');
            if (charts.claims1000) charts.claims1000.destroy();
            const blueGrad = ctx4.createLinearGradient(0, 0, 0, 200);
            blueGrad.addColorStop(0, 'rgba(66,165,245,0.5)');
            blueGrad.addColorStop(1, 'rgba(66,165,245,0.02)');
            charts.claims1000 = new Chart(ctx4, {
                type: 'line',
                data: { 
                    labels, 
                    datasets: [{ 
                        data: periods.map(p => p.members > 0 ? p.claims / p.members * 1000 : 0), 
                        borderColor: '#42A5F5', 
                        backgroundColor: blueGrad, 
                        fill: true, 
                        tension: 0.4,
                        borderWidth: 4,
                        pointRadius: 5,
                        pointBackgroundColor: '#42A5F5',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 8
                    }] 
                },
                options: { ...opts, scales: { x: { grid: { display: false }, ticks: { color: '#b8c9b8' } }, y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } } } }
            });
            
            // Avg Claim - 3D Line
            const ctx5 = document.getElementById('avgClaimChart').getContext('2d');
            if (charts.avgClaim) charts.avgClaim.destroy();
            const orangeGrad = ctx5.createLinearGradient(0, 0, 0, 200);
            orangeGrad.addColorStop(0, 'rgba(255,152,0,0.5)');
            orangeGrad.addColorStop(1, 'rgba(255,152,0,0.02)');
            charts.avgClaim = new Chart(ctx5, {
                type: 'line',
                data: { 
                    labels, 
                    datasets: [{ 
                        data: periods.map(p => p.claims > 0 ? p.approved_usd / p.claims : 0), 
                        borderColor: '#FF9800', 
                        backgroundColor: orangeGrad, 
                        fill: true, 
                        tension: 0.4,
                        borderWidth: 4,
                        pointRadius: 5,
                        pointBackgroundColor: '#FF9800',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 8
                    }] 
                },
                options: { ...opts, scales: { x: { grid: { display: false }, ticks: { color: '#b8c9b8' } }, y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', callback: v => '$' + v.toFixed(0) } } } }
            });
            
            // Plan Pie - 3D Doughnut
            const ctx6 = document.getElementById('planPieChart').getContext('2d');
            if (charts.planPie) charts.planPie.destroy();
            const goldPlanGrad = ctx6.createLinearGradient(0, 0, 0, 300);
            goldPlanGrad.addColorStop(0, '#FFE57F');
            goldPlanGrad.addColorStop(1, '#FFB300');
            const platGrad = ctx6.createLinearGradient(0, 0, 0, 300);
            platGrad.addColorStop(0, '#F5F5F5');
            platGrad.addColorStop(1, '#BDBDBD');
            const silverGrad = ctx6.createLinearGradient(0, 0, 0, 300);
            silverGrad.addColorStop(0, '#E0E0E0');
            silverGrad.addColorStop(1, '#9E9E9E');
            charts.planPie = new Chart(ctx6, {
                type: 'doughnut',
                plugins: [shadow3D],
                data: { 
                    labels: ['Gold', 'Platinum', 'Silver'], 
                    datasets: [{ 
                        data: [60, 25, 15], 
                        backgroundColor: [goldPlanGrad, platGrad, silverGrad], 
                        borderColor: ['#FF8F00', '#757575', '#616161'], 
                        borderWidth: 3, 
                        hoverOffset: 15 
                    }] 
                },
                options: { ...opts, cutout: '55%', plugins: { legend: { display: true, position: 'bottom', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20 } } } }
            });
            
            // Plan Cost - 3D Horizontal Bars
            const ctx7 = document.getElementById('planCostChart').getContext('2d');
            if (charts.planCost) charts.planCost.destroy();
            charts.planCost = new Chart(ctx7, {
                type: 'bar',
                plugins: [shadow3D],
                data: { 
                    labels: ['Gold', 'Platinum', 'Silver'], 
                    datasets: [{ 
                        data: [65, 85, 35], 
                        backgroundColor: [goldPlanGrad, platGrad, silverGrad],
                        borderColor: ['#FF8F00', '#757575', '#616161'],
                        borderWidth: 2,
                        borderRadius: 6 
                    }] 
                },
                options: { ...opts, indexAxis: 'y', scales: { x: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', callback: v => '$' + v } }, y: { grid: { display: false }, ticks: { color: '#fff', font: { weight: 'bold' } } } } }
            });
            
            // Utilization - 3D Line
            const ctx8 = document.getElementById('utilizationChart').getContext('2d');
            if (charts.util) charts.util.destroy();
            const greenGrad = ctx8.createLinearGradient(0, 0, 0, 200);
            greenGrad.addColorStop(0, 'rgba(76,175,80,0.5)');
            greenGrad.addColorStop(1, 'rgba(76,175,80,0.02)');
            charts.util = new Chart(ctx8, {
                type: 'line',
                data: { 
                    labels, 
                    datasets: [{ 
                        data: periods.map(p => p.members > 0 ? p.claims / p.members * 100 : 0), 
                        borderColor: '#4CAF50', 
                        backgroundColor: greenGrad, 
                        fill: true, 
                        tension: 0.4,
                        borderWidth: 4,
                        pointRadius: 5,
                        pointBackgroundColor: '#4CAF50',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 8
                    }] 
                },
                options: { ...opts, scales: { x: { grid: { display: false }, ticks: { color: '#b8c9b8' } }, y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', callback: v => v + '%' } } } }
            });
        }
        
        function updateMetrics(util) {
            document.getElementById('utilValue').textContent = util.toFixed(1) + '%';
            document.getElementById('utilBar').style.width = Math.min(util * 2, 100) + '%';
        }
        
        function updateInsights(ch) {
            const list = document.getElementById('insightsList');
            const insights = [];
            if (ch) {
                // Check cost - good if decreased (negative percentage)
                if (ch.cost && ch.cost.percentage !== null) {
                    if (ch.cost.percentage < 0) insights.push({ type: 'success', icon: '', title: 'Cost Improvement', desc: `Cost decreased by ${Math.abs(ch.cost.percentage).toFixed(1)}%` });
                    else if (ch.cost.percentage > 10) insights.push({ type: 'danger', icon: '', title: 'Cost Alert', desc: `Cost increased by ${ch.cost.percentage.toFixed(1)}%` });
                }
                // Check members - good if increased
                if (ch.members && ch.members.percentage !== null && ch.members.percentage > 0) {
                    insights.push({ type: 'success', icon: '', title: 'Growth', desc: `Members grew by ${ch.members.percentage.toFixed(1)}%` });
                }
                // Check claims - warning if increased significantly
                if (ch.claims && ch.claims.percentage !== null && ch.claims.percentage > 5) {
                    insights.push({ type: 'warning', icon: '!', title: 'Claims Up', desc: `Claims increased by ${ch.claims.percentage.toFixed(1)}%` });
                }
            }
            while (insights.length < 3) insights.push({ type: 'info', icon: '', title: 'Analysis', desc: 'Continue monitoring trends' });
            list.innerHTML = insights.slice(0, 3).map(i => `
                <div class="insight-item ${i.type}">
                    <div class="insight-icon">${i.icon}</div>
                    <div><div class="insight-title">${i.title}</div><div class="insight-desc">${i.desc}</div></div>
                </div>
            `).join('');
        }
        
        function updateTable(periods) {
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = periods.map((p, i) => {
                const rank = periods.length - i;
                const cls = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
                const util = p.members > 0 ? (p.claims / p.members * 100).toFixed(1) : 0;
                return `<tr>
                    <td><div class="rank-badge ${cls}">${rank}</div></td>
                    <td><strong>${p.period_label}</strong></td>
                    <td>${fmt(p.members)}</td>
                    <td>${fmt(p.claims)}</td>
                    <td>${fmt(p.approved_php)}</td>
                    <td class="currency">$${fmt(p.approved_usd)}</td>
                    <td class="currency">$${p.cost_per_member.toFixed(2)}</td>
                    <td>${util}%</td>
                </tr>`;
            }).reverse().join('');
        }
        
        function fmt(n) { return n === undefined ? '-' : n.toLocaleString('en-US', { maximumFractionDigits: 0 }); }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check for existing session
            const savedUser = localStorage.getItem('polaris_admin_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    if (currentUser && currentUser.role === 'admin') {
                        showDashboard();
                        return;
                    }
                } catch (e) {
                    localStorage.removeItem('polaris_admin_user');
                }
            }
            // Show login modal
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('hidden');
            
            // Allow Enter key to submit
            document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            document.getElementById('loginUsername').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') document.getElementById('loginPassword').focus();
            });
        });

        // 
        // CONTRACT CENTER FUNCTIONS
        // 
        let allContractsData = [];
        let currentContractDetails = null;
        
        // Check if running in Google Apps Script environment
        const isGoogleAppsScript = typeof google !== 'undefined' && google.script && google.script.run;
        
        // Web App API URL for Vercel deployment
        const CONTRACT_API_URL = 'https://script.google.com/macros/s/AKfycbxsUTp8W3R7J59r5q1bGY93dSTO8CGzrRxatcRt4PAaTUEoxVxFbEPccRjaT6OekBrn/exec';
        
        // API Helper function
        async function callContractAPI(action, params = {}) {
            const url = new URL(CONTRACT_API_URL);
            url.searchParams.append('action', action);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            
            try {
                const response = await fetch(url.toString());
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return null;
            }
        }
        
        // API helper using GET request (to avoid CORS issues with POST)
        async function postContractAPIWithCallback(action, data, callback) {
            try {
                // Convert nested data to flat structure for GET request
                let params = new URLSearchParams();
                params.append('action', action);
                
                // For createClient, flatten the clientData
                if (action === 'createClient' && data.clientData) {
                    params.append('data', JSON.stringify(data.clientData));
                }
                // For createContractWithDocuments, flatten the params
                else if (action === 'createContractWithDocuments' && data.params) {
                    params.append('data', JSON.stringify(data.params));
                }
                // For updateStatus
                else if (action === 'updateStatus') {
                    params.append('contractId', data.contractId || '');
                    params.append('newStatus', data.newStatus || '');
                    params.append('notes', data.notes || '');
                    params.append('updatedBy', data.updatedBy || 'System');
                }
                else {
                    params.append('data', JSON.stringify(data));
                }
                
                const url = CONTRACT_API_URL + '?' + params.toString();
                console.log('API Request:', action, url.substring(0, 200) + '...');
                
                const response = await fetch(url);
                const result = await response.json();
                
                console.log('API Response:', result);
                
                if (callback) callback(result);
                return result;
            } catch (error) {
                console.error('API Error:', error);
                if (callback) callback({ success: false, error: error.toString() });
                return { success: false, error: error.toString() };
            }
        }

        // 
        // CLIENT MANAGEMENT FUNCTIONS
        // 
        
        function openAddClientModal() {
            document.getElementById('addClientModal').classList.remove('hidden');
            clearClientForm();
        }
        
        function closeAddClientModal() {
            const modal = document.getElementById('addClientModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }
        }
        
        function clearClientForm() {
            ['clientName', 'clientCountry', 'clientTIN', 'clientRegAddress', 'clientOpAddress', 'clientVAT',
             'clientContactPerson', 'clientCapacity', 'clientEmail', 'clientPhone', 'clientMobile', 'clientFax',
             'clientSignatoryName', 'clientSignatoryTitle'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('addClientStatus').innerHTML = '';
        }
        
        async function saveNewClient() {
            const clientName = document.getElementById('clientName').value.trim();
            const contactPerson = document.getElementById('clientContactPerson').value.trim();
            const email = document.getElementById('clientEmail').value.trim();
            const signatoryName = document.getElementById('clientSignatoryName').value.trim();
            const signatoryTitle = document.getElementById('clientSignatoryTitle').value.trim();
            
            // Validation
            if (!clientName) { showClientStatus('Company Name is required', 'error'); return; }
            if (!contactPerson) { showClientStatus('Contact Person is required', 'error'); return; }
            if (!email) { showClientStatus('Email is required', 'error'); return; }
            if (!signatoryName || !signatoryTitle) { showClientStatus('Signatory Name and Title are required', 'error'); return; }
            
            const clientData = {
                client_name: clientName,
                country: document.getElementById('clientCountry').value.trim(),
                tin_number: document.getElementById('clientTIN').value.trim(),
                registered_address: document.getElementById('clientRegAddress').value.trim(),
                operating_address: document.getElementById('clientOpAddress').value.trim(),
                vat_number: document.getElementById('clientVAT').value.trim(),
                contact_person: contactPerson,
                contact_capacity: document.getElementById('clientCapacity').value.trim(),
                email: email,
                phone: document.getElementById('clientPhone').value.trim(),
                mobile: document.getElementById('clientMobile').value.trim(),
                fax: document.getElementById('clientFax').value.trim(),
                authorized_signatory_name: signatoryName,
                authorized_signatory_title: signatoryTitle
            };
            
            showClientStatus('Saving client...', 'info');
            
            if (isGoogleAppsScript) {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            showClientStatus(' ' + result.message, 'success');
                            loadClientsForContractDropdowns();
                            setTimeout(() => {
                                closeAddClientModal();
                                // Select the newly created client
                                document.getElementById('newContractClient').value = result.client_id;
                            }, 1500);
                        } else {
                            showClientStatus('Error: ' + result.error, 'error');
                        }
                    })
                    .withFailureHandler(function(e) { showClientStatus('Error: ' + e.message, 'error'); })
                    .createClient(clientData);
            } else {
                // Use API call
                postContractAPIWithCallback('createClient', { clientData: clientData }, function(result) {
                    if (result && result.success) {
                        showClientStatus(' ' + result.message, 'success');
                        loadClientsForContractDropdowns();
                        setTimeout(() => {
                            closeAddClientModal();
                            if (result.client_id) {
                                document.getElementById('newContractClient').value = result.client_id;
                            }
                        }, 1500);
                    } else {
                        // Optimistic update - assume success if no error
                        showClientStatus(' Client saved. Refreshing...', 'success');
                        setTimeout(() => {
                            loadClientsForContractDropdowns();
                            closeAddClientModal();
                        }, 2000);
                    }
                });
            }
        }
        
        function showClientStatus(message, type) {
            const colors = {
                success: { bg: 'rgba(76,175,80,0.2)', text: '#4CAF50' },
                error: { bg: 'rgba(231,76,60,0.2)', text: '#e74c3c' },
                info: { bg: 'rgba(33,150,243,0.2)', text: '#2196F3' }
            };
            const style = colors[type] || colors.info;
            document.getElementById('addClientStatus').innerHTML = 
                `<div style="background:${style.bg};color:${style.text};padding:0.75rem;border-radius:8px;text-align:center;">${message}</div>`;
        }
        
        // Update First Warning Amount when Fund changes
        function updateFirstWarning() {
            const fund = parseFloat(document.getElementById('finFund').value) || 0;
            document.getElementById('finFirstWarning').value = (fund * 0.6).toFixed(2);
        }

        function openContractCenter() {
            document.getElementById('contractCenterModal').classList.remove('hidden');
            loadContractStats(); loadContracts(); loadClientsForContractDropdowns();
        }
        function closeContractCenter() { document.getElementById('contractCenterModal').classList.add('hidden'); }

        function switchContractTab(tabName) {
            document.querySelectorAll('.contract-tab-content').forEach(t => t.style.display = 'none');
            document.getElementById('contractDetailsView').style.display = 'none';
            const map = {'list':'contractTabList','create':'contractTabCreate','templates':'contractTabTemplates'};
            document.getElementById(map[tabName]).style.display = 'block';
            document.querySelectorAll('.contract-tab').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            if(tabName==='templates') loadContractTemplates();
        }
        function toggleFinancialTerms() { document.getElementById('financialTermsBox').style.display = document.getElementById('newContractASA').checked ? 'block' : 'none'; }

        async function loadContractStats() {
            if (isGoogleAppsScript) {
                google.script.run.withSuccessHandler(function(s) {
                    document.getElementById('contractStatTotal').textContent = s.total||0;
                    document.getElementById('contractStatActive').textContent = s.byStatus.active||0;
                    document.getElementById('contractStatPending').textContent = (s.byStatus.draft||0)+(s.byStatus.sent||0)+(s.byStatus.negotiating||0);
                    document.getElementById('contractStatExpiring').textContent = s.expiringSoon||0;
                }).withFailureHandler(function(e){console.error(e);}).getContractDashboardStats();
            } else {
                // Use Web App API
                const stats = await callContractAPI('getStats');
                if (stats) {
                    document.getElementById('contractStatTotal').textContent = stats.total || 0;
                    document.getElementById('contractStatActive').textContent = stats.byStatus?.active || 0;
                    document.getElementById('contractStatPending').textContent = (stats.byStatus?.draft || 0) + (stats.byStatus?.sent || 0) + (stats.byStatus?.negotiating || 0);
                    document.getElementById('contractStatExpiring').textContent = stats.expiringSoon || 0;
                }
            }
        }

        async function loadContracts() {
            const tbody = document.getElementById('contractTableBody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--text-muted);">Loading...</td></tr>';
            
            if (isGoogleAppsScript) {
                google.script.run.withSuccessHandler(function(c) { allContractsData = c; renderContractsTable(c); }).withFailureHandler(function(e){console.error(e);tbody.innerHTML='<tr><td colspan="8" style="text-align:center;color:#e74c3c;">Error loading</td></tr>';}).getAllContracts();
            } else {
                // Use Web App API
                const contracts = await callContractAPI('getContracts');
                if (contracts && Array.isArray(contracts)) {
                    allContractsData = contracts;
                    renderContractsTable(contracts);
                } else if (contracts && contracts.error) {
                    console.error('API Error:', contracts.error);
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#e74c3c;">Error: ' + contracts.error + '</td></tr>';
                } else {
                    allContractsData = [];
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#e74c3c;">Error loading contracts</td></tr>';
                }
            }
        }

        function renderContractsTable(contracts) {
            const tbody = document.getElementById('contractTableBody');
            if(!contracts||contracts.length===0) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--text-muted);">No contracts found</td></tr>'; return; }
            tbody.innerHTML = contracts.map(c => `<tr>
                <td><a href="#" onclick="viewContractDetails('${c.contract_id}');return false;" style="color:var(--polaris-gold);text-decoration:none;font-weight:500;">${c.contract_id}</a></td>
                <td>${c.client_name||'-'}</td>
                <td><span class="contract-type ${c.doc_type}">${c.doc_type}</span></td>
                <td><span class="contract-status ${c.status}">${c.status}</span></td>
                <td style="text-align:center;">v${c.version||1}</td>
                <td>${formatContractDate(c.effective_date)}</td>
                <td>${formatContractDate(c.expiry_date)}</td>
                <td>
                    <button class="contract-action-btn view" onclick="viewContractDetails('${c.contract_id}')" title="View"></button>
                    ${c.current_doc_url?`<a href="${c.current_doc_url}" target="_blank" class="contract-action-btn download" title="Document"></a>`:''}
                    ${c.gdrive_folder_url?`<a href="${c.gdrive_folder_url}" target="_blank" class="contract-action-btn edit" title="Folder"></a>`:''}
                </td>
            </tr>`).join('');
        }

        function filterContracts() {
            let filtered = allContractsData;
            const status = document.getElementById('contractFilterStatus').value;
            const type = document.getElementById('contractFilterType').value;
            const client = document.getElementById('contractFilterClient').value;
            const search = document.getElementById('contractFilterSearch').value.toLowerCase();
            if(status) filtered = filtered.filter(c=>c.status===status);
            if(type) filtered = filtered.filter(c=>c.doc_type===type);
            if(client) filtered = filtered.filter(c=>c.client_id===client);
            if(search) filtered = filtered.filter(c=>c.contract_id.toLowerCase().includes(search)||(c.client_name&&c.client_name.toLowerCase().includes(search)));
            renderContractsTable(filtered);
        }

        async function loadClientsForContractDropdowns() {
            const populateDropdowns = (clients) => {
                const filterSel = document.getElementById('contractFilterClient');
                const createSel = document.getElementById('newContractClient');
                filterSel.innerHTML = '<option value="">All Clients</option>';
                createSel.innerHTML = '<option value="">-- Select Client --</option>';
                
                if (clients && clients.length > 0) {
                    clients.forEach(c => {
                        filterSel.innerHTML += `<option value="${c.client_id}">${c.client_name}</option>`;
                        createSel.innerHTML += `<option value="${c.client_id}" data-name="${c.client_name}">${c.client_name}</option>`;
                    });
                } else {
                    // If no clients from API, get unique clients from loaded contracts
                    const uniqueClients = {};
                    allContractsData.forEach(c => {
                        if (c.client_id && c.client_name && !uniqueClients[c.client_id]) {
                            uniqueClients[c.client_id] = c.client_name;
                        }
                    });
                    Object.keys(uniqueClients).forEach(id => {
                        filterSel.innerHTML += `<option value="${id}">${uniqueClients[id]}</option>`;
                        createSel.innerHTML += `<option value="${id}" data-name="${uniqueClients[id]}">${uniqueClients[id]}</option>`;
                    });
                }
            };
            
            if (isGoogleAppsScript) {
                google.script.run.withSuccessHandler(populateDropdowns).withFailureHandler(function(e){console.error(e);}).getClientsForContracts();
            } else {
                // Use Web App API
                const clients = await callContractAPI('getAllClients');
                populateDropdowns(clients || []);
            }
        }

        async function createNewContract() {
            const sel = document.getElementById('newContractClient');
            const clientId = sel.value;
            const clientName = sel.options[sel.selectedIndex]?.dataset?.name || sel.options[sel.selectedIndex]?.textContent;
            if(!clientId) { showContractStatus('Please select a client','error'); return; }
            const docTypes = [];
            if(document.getElementById('newContractASA').checked) docTypes.push('ASA');
            if(document.getElementById('newContractNDA').checked) docTypes.push('NDA');
            if(document.getElementById('newContractDPA').checked) docTypes.push('DPA');
            if(docTypes.length===0) { showContractStatus('Please select at least one document type','error'); return; }
            
            // Build params with all fields
            const params = {
                client_id: clientId, 
                client_name: clientName, 
                doc_types: docTypes, 
                created_by: 'Admin Dashboard',
                // Contract dates
                contract_dates: {
                    effective_date: document.getElementById('contractEffectiveDate').value || '',
                    expiry_date: document.getElementById('contractExpiryDate').value || '',
                    auto_renewal: document.getElementById('contractAutoRenewal').checked
                }
            };
            
            // Add financials if ASA is selected
            if(docTypes.includes('ASA')) {
                params.plans = {
                    gold: parseInt(document.getElementById('finGold').value) || 0,
                    platinum: parseInt(document.getElementById('finPlatinum').value) || 0,
                    diamond: parseInt(document.getElementById('finDiamond').value) || 0,
                    dental: parseInt(document.getElementById('finDentalMembers').value) || 0
                };
                params.financials = {
                    enrollment_fee: parseFloat(document.getElementById('finEnrollmentFee').value) || 0,
                    plan_management_fee: parseFloat(document.getElementById('finManagementFee').value) || 0,
                    plan_management_minimum: parseFloat(document.getElementById('finManagementMin').value) || 0,
                    claim_processing_fee: parseFloat(document.getElementById('finClaimFee').value) || 0,
                    dental_benefit_fee: parseFloat(document.getElementById('finDentalFee').value) || 0,
                    fund_amount: parseFloat(document.getElementById('finFund').value) || 0,
                    running_cost: parseFloat(document.getElementById('finRunning').value) || 0
                };
            }
            
            showContractStatus('Creating contract(s) and generating documents...','info');
            
            if (isGoogleAppsScript) {
                google.script.run.withSuccessHandler(function(result) {
                    if(result.success) {
                        showContractStatus(' ' + result.message,'success');
                        loadContractStats(); loadContracts();
                        resetContractForm();
                        setTimeout(()=>document.querySelector('.contract-tab').click(), 2000);
                    } else { showContractStatus('Error: '+(result.error||'Unknown error'),'error'); }
                }).withFailureHandler(function(e){showContractStatus('Error: '+e.message,'error');}).createContractWithDocuments(params);
            } else {
                // Use JSONP callback approach
                postContractAPIWithCallback('createContractWithDocuments', { params: params }, function(result) {
                    if (result && result.success) {
                        showContractStatus(' ' + result.message, 'success');
                        loadContractStats(); loadContracts();
                        resetContractForm();
                        setTimeout(()=>document.querySelector('.contract-tab').click(), 2000);
                    } else {
                        // Optimistic - assume it worked
                        showContractStatus(` Contract creation sent for ${clientName}. Refreshing...`, 'success');
                        setTimeout(() => {
                            loadContractStats();
                            loadContracts();
                            resetContractForm();
                            document.querySelector('.contract-tab').click();
                        }, 3000);
                    }
                });
            }
        }
        
        function resetContractForm() {
            document.getElementById('newContractClient').value = '';
            document.getElementById('contractEffectiveDate').value = '';
            document.getElementById('contractExpiryDate').value = '';
            document.getElementById('contractAutoRenewal').checked = true;
            ['finGold','finPlatinum','finDiamond','finDentalMembers','finEnrollmentFee','finManagementFee',
             'finManagementMin','finClaimFee','finDentalFee','finFund','finRunning','finFirstWarning'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '0';
            });
        }

        function showContractStatus(message, type) {
            const colors = {success:{bg:'rgba(76,175,80,0.2)',text:'#4CAF50'},error:{bg:'rgba(231,76,60,0.2)',text:'#e74c3c'},info:{bg:'rgba(33,150,243,0.2)',text:'#2196F3'}};
            const style = colors[type]||colors.info;
            document.getElementById('createContractStatus').innerHTML = `<div style="background:${style.bg};color:${style.text};padding:1rem;border-radius:10px;margin-top:1rem;text-align:center;">${message}</div>`;
        }

        function viewContractDetails(contractId) {
            document.querySelectorAll('.contract-tab-content').forEach(t=>t.style.display='none');
            document.getElementById('contractDetailsView').style.display = 'block';
            
            if (isGoogleAppsScript) {
                google.script.run.withSuccessHandler(function(contract) { currentContractDetails=contract; renderContractDetails(contract); }).withFailureHandler(function(e){console.error(e);}).getContractWithFinancials(contractId);
            } else {
                // Use Web App API
                callContractAPI('getContract', { contractId: contractId }).then(contract => {
                    if (contract) {
                        currentContractDetails = contract;
                        renderContractDetails(contract);
                    } else {
                        // Fallback to local data
                        const localContract = allContractsData.find(c => c.contract_id === contractId);
                        currentContractDetails = localContract;
                        renderContractDetails(localContract);
                    }
                });
            }
        }

        function renderContractDetails(c) {
            if(!c) { document.getElementById('contractInfoDetails').innerHTML = '<p style="color:#e74c3c;">Contract not found</p>'; return; }
            document.getElementById('contractDetailsTitle').textContent = `${c.doc_type} - ${c.client_name}`;
            document.getElementById('contractInfoDetails').innerHTML = `
                <div class="contract-detail-row"><span class="contract-detail-label">Contract ID</span><span class="contract-detail-value">${c.contract_id}</span></div>
                <div class="contract-detail-row"><span class="contract-detail-label">Type</span><span class="contract-detail-value"><span class="contract-type ${c.doc_type}">${c.doc_type}</span></span></div>
                <div class="contract-detail-row"><span class="contract-detail-label">Status</span><span class="contract-detail-value"><span class="contract-status ${c.status}">${c.status}</span></span></div>
                <div class="contract-detail-row"><span class="contract-detail-label">Version</span><span class="contract-detail-value">v${c.version||1}</span></div>
                <div class="contract-detail-row"><span class="contract-detail-label">Created</span><span class="contract-detail-value">${formatContractDate(c.created_date)}</span></div>`;
            document.getElementById('contractDatesDetails').innerHTML = `
                <div class="contract-detail-row"><span class="contract-detail-label">Effective Date</span><span class="contract-detail-value">${formatContractDate(c.effective_date)||'Not set'}</span></div>
                <div class="contract-detail-row"><span class="contract-detail-label">Expiry Date</span><span class="contract-detail-value">${formatContractDate(c.expiry_date)||'Not set'}</span></div>
                <div class="contract-detail-row"><span class="contract-detail-label">Signed Date</span><span class="contract-detail-value">${formatContractDate(c.signed_date)||'Not signed'}</span></div>
                <div class="contract-detail-row"><span class="contract-detail-label">Auto Renewal</span><span class="contract-detail-value">${c.auto_renewal==='TRUE'?' Yes':' No'}</span></div>`;
            
            if(c.financials) {
                document.getElementById('contractFinancialsSection').style.display='block';
                document.getElementById('contractFinancialsDetails').innerHTML = `<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;">
                    <div><span class="contract-detail-label"> Gold</span><br><strong>${c.financials.plan_gold_members||0}</strong></div>
                    <div><span class="contract-detail-label"> Platinum</span><br><strong>${c.financials.plan_platinum_members||0}</strong></div>
                    <div><span class="contract-detail-label"> Diamond</span><br><strong>${c.financials.plan_diamond_members||0}</strong></div>
                    <div><span class="contract-detail-label">Fund Amount</span><br><strong>$${(c.financials.fund_amount||0).toLocaleString()}</strong></div>
                    <div><span class="contract-detail-label">Running Cost</span><br><strong>$${(c.financials.running_cost_annual||0).toLocaleString()}</strong></div>
                    <div><span class="contract-detail-label">Dental</span><br><strong>${c.financials.has_dental==='TRUE'?' Yes':' No'}</strong></div></div>`;
            } else { document.getElementById('contractFinancialsSection').style.display='none'; }
            
            if(c.history&&c.history.length>0) {
                document.getElementById('contractHistoryDetails').innerHTML = c.history.map(h=>`
                    <div style="display:flex;align-items:center;gap:1rem;padding:0.75rem;background:var(--bg-dark);border-radius:8px;margin-bottom:0.5rem;">
                        <div style="width:8px;height:8px;background:var(--polaris-gold);border-radius:50%;"></div>
                        <div style="flex:1;"><div style="font-weight:500;text-transform:capitalize;">${h.action}</div><div style="font-size:0.8rem;color:var(--text-muted);">${h.notes||''}</div></div>
                        <div style="font-size:0.8rem;color:var(--text-muted);">${formatContractDate(h.action_date)}</div>
                    </div>`).join('');
            } else { document.getElementById('contractHistoryDetails').innerHTML = '<p style="color:var(--text-muted);">No history yet</p>'; }
            
            document.getElementById('contractFolderLink').href = c.gdrive_folder_url||'#';
            document.getElementById('contractFolderLink').style.display = c.gdrive_folder_url?'inline-block':'none';
            document.getElementById('contractDocLink').href = c.current_doc_url||'#';
            document.getElementById('contractDocLink').style.display = c.current_doc_url?'inline-block':'none';
            
            const actionBtn = document.getElementById('contractActionBtn');
            actionBtn.style.display = 'inline-block';
            switch(c.status) {
                case 'draft': actionBtn.textContent=' Mark as Sent'; actionBtn.onclick=()=>updateContractStatusFromUI(c.contract_id,'sent'); break;
                case 'sent': case 'negotiating': actionBtn.textContent=' Mark as Signed'; actionBtn.onclick=()=>updateContractStatusFromUI(c.contract_id,'signed'); break;
                case 'signed': actionBtn.textContent=' Activate'; actionBtn.onclick=()=>updateContractStatusFromUI(c.contract_id,'active'); break;
                default: actionBtn.style.display='none';
            }
        }

        function closeContractDetails() {
            document.getElementById('contractDetailsView').style.display='none';
            document.getElementById('contractTabList').style.display='block';
            document.querySelectorAll('.contract-tab').forEach(b=>b.classList.remove('active'));
            document.querySelector('.contract-tab').classList.add('active');
        }

        async function updateContractStatusFromUI(contractId, newStatus) {
            if (isGoogleAppsScript) {
                google.script.run.withSuccessHandler(function(result) {
                    if(result.success) { loadContractStats(); loadContracts(); viewContractDetails(contractId); }
                }).withFailureHandler(function(e){console.error(e);}).updateContractStatus(contractId, newStatus, 'Updated from dashboard', 'Admin');
            } else {
                // Use Web App API - POST via form
                try {
                    const iframe = document.createElement('iframe');
                    iframe.name = 'statusApiFrame';
                    iframe.style.display = 'none';
                    document.body.appendChild(iframe);
                    
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = CONTRACT_API_URL;
                    form.target = 'statusApiFrame';
                    
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'payload';
                    input.value = JSON.stringify({ 
                        action: 'updateStatus', 
                        contractId: contractId, 
                        newStatus: newStatus,
                        notes: 'Updated from dashboard',
                        updatedBy: 'Admin'
                    });
                    form.appendChild(input);
                    
                    document.body.appendChild(form);
                    form.submit();
                    
                    setTimeout(() => {
                        document.body.removeChild(form);
                        document.body.removeChild(iframe);
                        loadContractStats();
                        loadContracts();
                        viewContractDetails(contractId);
                    }, 1500);
                } catch (error) {
                    console.error('Error updating status:', error);
                }
            }
        }

        async function loadContractTemplates() {
            const container = document.getElementById('templatesListContainer');
            container.innerHTML = '<p style="color:var(--text-muted);">Loading templates...</p>';
            
            const renderTemplates = (templates) => {
                if(!templates||templates.length===0) { container.innerHTML='<p style="color:var(--text-muted);">No templates found</p>'; return; }
                const colors = {'ASA':'#1a365d','NDA':'#7c3aed','DPA':'#0891b2'};
                container.innerHTML = templates.map(t=>`
                    <div style="background:var(--bg-dark);border:1px solid var(--border-color);border-radius:12px;padding:1rem;margin-bottom:0.75rem;display:flex;align-items:center;justify-content:space-between;">
                        <div style="display:flex;align-items:center;gap:1rem;">
                            <div style="width:50px;height:50px;background:${colors[t.template_type]||'#64748b'};border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;">${t.template_type}</div>
                            <div><div style="font-weight:600;">${t.template_name}</div><div style="font-size:0.85rem;color:var(--text-muted);">${t.description||'No description'}</div><div style="font-size:0.75rem;color:var(--text-muted);margin-top:0.25rem;">Version ${t.version}</div></div>
                        </div>
                        ${t.gdrive_file_url?`<a href="${t.gdrive_file_url}" target="_blank" class="contract-btn contract-btn-secondary" style="padding:0.5rem 1rem;text-decoration:none;"> Download</a>`:'<span style="color:var(--text-muted);font-size:0.85rem;">No file uploaded</span>'}
                    </div>`).join('');
            };
            
            if (isGoogleAppsScript) {
                google.script.run.withSuccessHandler(renderTemplates).withFailureHandler(function(e){container.innerHTML='<p style="color:#e74c3c;">Error loading templates</p>';}).getActiveContractTemplates();
            } else {
                // Use Web App API
                const templates = await callContractAPI('getTemplates');
                renderTemplates(templates || []);
            }
        }

        function formatContractDate(dateValue) {
            if(!dateValue) return '-';
            const date = new Date(dateValue);
            if(isNaN(date.getTime())) return '-';
            return date.toLocaleDateString('en-GB', {day:'2-digit',month:'2-digit',year:'numeric'});
        }

        // 
        // OFFERS MODULE - POLARIS V4 INTERFACE
        // 
        
        let offersData = [];
        let currentOfferTier = 1;
        let customPlans = JSON.parse(localStorage.getItem('polarisCustomPlans') || '[]');
        const DENTAL_FEE = 9.50;
        
        // Standard Plans Data (will be replaced by API data if available)
        const OFFER_PLANS = {
            silver: { id: 'silver', name: 'SILVER', limits: '40/20', mbl: 40000, reg: 24, fund: [20, 18, 16, 14], color: '#6c757d' },
            gold: { id: 'gold', name: 'GOLD', limits: '80/40', mbl: 80000, reg: 24, fund: [45, 42, 39, 36], color: '#d4a843' },
            goldplus: { id: 'goldplus', name: 'GOLD+', limits: '100/40', mbl: 100000, reg: 24, fund: [50, 47, 44, 41], color: '#b8860b' },
            goldplusplus: { id: 'goldplusplus', name: 'GOLD++', limits: '150/50', mbl: 150000, reg: 28, fund: [55, 52, 49, 46], color: '#8b6914' },
            platinum: { id: 'platinum', name: 'PLATINUM', limits: '180/40', mbl: 180000, reg: 24, fund: [50, 47, 44, 41], color: '#5a6268' },
            diamond: { id: 'diamond', name: 'DIAMOND', limits: '360/60', mbl: 360000, reg: 40, fund: [100, 95, 90, 85], color: '#17a2b8' }
        };
        
        function openOffersCenter() {
            document.getElementById('offersCenterModal').classList.remove('hidden');
            loadOfferStats();
            loadOffers();
            loadOfferClients();
            renderOfferPlanCards();
            renderCustomPlans();
            updateOfferValidityDate();
            generateOfferDisplayId();
            updateOfferCreatedDate();
        }
        
        function closeOffersCenter() {
            document.getElementById('offersCenterModal').classList.add('hidden');
        }
        
        function generateOfferDisplayId() {
            const year = new Date().getFullYear();
            const num = String(Math.floor(Math.random() * 9999) + 1).padStart(4, '0');
            const el = document.getElementById('offerDisplayId');
            if (el) el.textContent = `OFF-${year}-${num}`;
        }
        
        function updateOfferCreatedDate() {
            const el = document.getElementById('offerCreatedDate');
            if (el) el.textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        
        function switchOffersTab(tab) {
            // Hide all tabs and remove active class
            document.querySelectorAll('.offers-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.offers-tab-content').forEach(c => c.style.display = 'none');
            
            // Find the correct tab button and activate it
            const tabButtons = document.querySelectorAll('.offers-tab');
            tabButtons.forEach(btn => {
                if ((tab === 'list' && btn.textContent.includes('All Offers')) || 
                    (tab === 'create' && btn.textContent.includes('Create New Offer'))) {
                    btn.classList.add('active');
                }
            });
            
            // Show the correct tab content
            const tabId = 'offersTab' + tab.charAt(0).toUpperCase() + tab.slice(1);
            const tabContent = document.getElementById(tabId);
            if (tabContent) {
                tabContent.style.display = 'block';
            }
            
            if (tab === 'create') {
                renderOfferPlanCards();
                renderCustomPlans();
                updateOfferValidityDate();
                generateOfferDisplayId();
                updateOfferCreatedDate();
            }
        }
        
        async function loadOfferStats() {
            try {
                const response = await fetch(API_URL + '?action=getOfferStats');
                const result = await response.json();
                if (result.success && result.data) {
                    const stats = result.data;
                    document.getElementById('offerStatTotal').textContent = stats.total || 0;
                    document.getElementById('offerStatDraft').textContent = stats.draft || 0;
                    document.getElementById('offerStatSent').textContent = stats.sent || 0;
                    document.getElementById('offerStatAccepted').textContent = stats.accepted || 0;
                    document.getElementById('offerStatRejected').textContent = stats.rejected || 0;
                }
            } catch (e) {
                console.error('Error loading offer stats:', e);
            }
        }
        
        async function loadOffers() {
            const tbody = document.getElementById('offersTableBody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted);">Loading...</td></tr>';
            
            try {
                const response = await fetch(API_URL + '?action=getOffers');
                const result = await response.json();
                
                if (result.success && result.data) {
                    offersData = result.data;
                    renderOffersTable();
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted);">No offers found</td></tr>';
                }
            } catch (e) {
                console.error('Error loading offers:', e);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:#e74c3c;">Error loading offers</td></tr>';
            }
        }
        
        function renderOffersTable() {
            const tbody = document.getElementById('offersTableBody');
            
            if (!offersData || offersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted);">No offers yet. Create your first offer!</td></tr>';
                return;
            }
            
            tbody.innerHTML = offersData.map(offer => `
                <tr>
                    <td><strong>${offer.offer_id}</strong></td>
                    <td>${offer.client_name || 'N/A'}</td>
                    <td>${formatContractDate(offer.offer_date)}</td>
                    <td>${offer.total_members || 0}</td>
                    <td><strong>$${(offer.grand_total_usd || 0).toLocaleString()}</strong></td>
                    <td><span class="offer-status ${offer.status}">${offer.status}</span></td>
                    <td>
                        <button onclick="viewOffer('${offer.offer_id}')" class="contract-btn contract-btn-secondary" style="padding:0.4rem 0.75rem;font-size:0.8rem;"></button>
                        ${offer.status === 'draft' ? `<button onclick="sendOffer('${offer.offer_id}')" class="contract-btn contract-btn-primary" style="padding:0.4rem 0.75rem;font-size:0.8rem;margin-left:0.25rem;"></button>` : ''}
                    </td>
                </tr>
            `).join('');
        }
        
        async function loadOfferClients() {
            const select = document.getElementById('offerClientSelect');
            // Keep first two options
            const firstOptions = '<option value="">-- Select a client or enter new --</option><option value="new">+ Add New Client</option>';
            select.innerHTML = firstOptions;
            
            try {
                const response = await fetch(API_URL + '?action=getClients');
                const clients = await response.json();
                
                if (Array.isArray(clients)) {
                    clients.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.client_id;
                        option.textContent = c.client_name;
                        option.dataset.email = c.contact_email || c.email || '';
                        option.dataset.contact = c.contact_person || c.contact_name || '';
                        select.appendChild(option);
                    });
                }
            } catch (e) {
                console.error('Error loading clients:', e);
            }
        }
        
        function handleOfferClientChange() {
            const select = document.getElementById('offerClientSelect');
            console.log('handleOfferClientChange called, value:', select.value);
            if (select.value === 'new') {
                console.log('Opening Add Client Modal...');
                // Open the Add New Client modal
                const modal = document.getElementById('addClientModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.style.display = 'flex';
                    console.log('Modal opened');
                } else {
                    console.error('addClientModal not found!');
                }
                // Reset selection so user can select again after closing
                select.value = '';
            }
        }
        
        // Override saveNewClient to also update Offers dropdown
        const originalSaveNewClient = saveNewClient;
        async function saveNewClientWithOffersUpdate() {
            const clientName = document.getElementById('clientName').value.trim();
            const contactPerson = document.getElementById('clientContactPerson').value.trim();
            const email = document.getElementById('clientEmail').value.trim();
            const signatoryName = document.getElementById('clientSignatoryName').value.trim();
            const signatoryTitle = document.getElementById('clientSignatoryTitle').value.trim();
            
            // Validation
            if (!clientName) { showClientStatus('Company Name is required', 'error'); return; }
            if (!contactPerson) { showClientStatus('Contact Person is required', 'error'); return; }
            if (!email) { showClientStatus('Email is required', 'error'); return; }
            if (!signatoryName || !signatoryTitle) { showClientStatus('Signatory Name and Title are required', 'error'); return; }
            
            const clientData = {
                client_name: clientName,
                country: document.getElementById('clientCountry').value.trim(),
                tin_number: document.getElementById('clientTIN').value.trim(),
                registered_address: document.getElementById('clientRegAddress').value.trim(),
                operating_address: document.getElementById('clientOpAddress').value.trim(),
                vat_number: document.getElementById('clientVAT').value.trim(),
                contact_person: contactPerson,
                contact_capacity: document.getElementById('clientCapacity').value.trim(),
                email: email,
                phone: document.getElementById('clientPhone').value.trim(),
                mobile: document.getElementById('clientMobile').value.trim(),
                fax: document.getElementById('clientFax').value.trim(),
                authorized_signatory_name: signatoryName,
                authorized_signatory_title: signatoryTitle
            };
            
            showClientStatus('Saving client...', 'info');
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'createClient', clientData: clientData })
                });
                const result = await response.json();
                
                if (result.success) {
                    showClientStatus(' ' + result.message, 'success');
                    // Reload both dropdowns
                    loadClientsForContractDropdowns();
                    loadOfferClients(); // Also reload Offers dropdown
                    setTimeout(() => {
                        closeAddClientModal();
                        // Select the newly created client in Offers if that was the source
                        if (result.client_id) {
                            const offerSelect = document.getElementById('offerClientSelect');
                            if (offerSelect) {
                                setTimeout(() => {
                                    offerSelect.value = result.client_id;
                                }, 500);
                            }
                        }
                    }, 1500);
                } else {
                    showClientStatus('Error: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (e) {
                showClientStatus('Error: ' + e.message, 'error');
            }
        }
        
        function selectOfferTier(btn) {
            document.querySelectorAll('.offer-tier-btn').forEach(b => {
                b.style.background = 'white';
                b.style.color = '#333';
            });
            btn.style.background = '#1e3a5f';
            btn.style.color = 'white';
            
            currentOfferTier = parseInt(btn.dataset.tier);
            const min = btn.dataset.min;
            const max = btn.dataset.max === '9999' ? '+' : btn.dataset.max;
            document.getElementById('currentTierBadge').textContent = `Tier ${currentOfferTier}: ${min}-${max} members`;
            
            renderOfferPlanCards();
            calculateOfferTotals();
        }
        
        function renderOfferPlanCards() {
            const container = document.getElementById('offerPlansGrid');
            const tierIndex = currentOfferTier - 1;
            
            container.innerHTML = Object.values(OFFER_PLANS).map(plan => `
                <div class="offer-plan-card" id="offerPlan_${plan.id}" data-plan="${plan.id}" style="border: 2px solid #dee2e6; border-radius: 12px; overflow: hidden; transition: all 0.3s ease;">
                    <div style="background: ${plan.color}; color: white; padding: 18px 22px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 20px; font-weight: 700;">POLARIS ${plan.name}</div>
                            <div style="font-size: 13px; opacity: 0.9;">${plan.limits}  PHP ${plan.mbl.toLocaleString()} MBL</div>
                        </div>
                        <input type="checkbox" class="offer-plan-checkbox" data-plan="${plan.id}" onchange="toggleOfferPlan('${plan.id}')" style="width: 28px; height: 28px; cursor: pointer;">
                    </div>
                    <div style="padding: 22px; background: white;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 18px;">
                            <div style="background: #f8f9fa; padding: 14px; border-radius: 8px; text-align: center;">
                                <div style="color: #666; font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Registration</div>
                                <div style="font-weight: 700; color: #1e3a5f; font-size: 20px;">$${plan.reg}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 14px; border-radius: 8px; text-align: center;">
                                <div style="color: #666; font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Fund Deposit</div>
                                <div style="font-weight: 700; color: #1e3a5f; font-size: 20px;">$${plan.fund[tierIndex]}</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                            <div style="text-align: center;">
                                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 6px; text-transform: uppercase; font-weight: 500;">Principals</label>
                                <input type="number" class="offer-principals" data-plan="${plan.id}" value="0" min="0" oninput="debouncedUpdatePlan('${plan.id}')" style="width: 100%; padding: 14px; border: 2px solid #dee2e6; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700;">
                            </div>
                            <div style="text-align: center;">
                                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 6px; text-transform: uppercase; font-weight: 500;">Dependents</label>
                                <input type="number" class="offer-dependents" data-plan="${plan.id}" value="0" min="0" oninput="debouncedUpdatePlan('${plan.id}')" style="width: 100%; padding: 14px; border: 2px solid #dee2e6; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700;">
                            </div>
                            <div style="text-align: center;">
                                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 6px; text-transform: uppercase; font-weight: 500;">Total</label>
                                <input type="text" class="offer-total" data-plan="${plan.id}" value="0" readonly style="width: 100%; padding: 14px; border: 2px solid #1e3a5f; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; background: #1e3a5f; color: white;">
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Debounce function to prevent rapid re-calculations
        let updatePlanTimeout = null;
        function debouncedUpdatePlan(planId) {
            if (updatePlanTimeout) clearTimeout(updatePlanTimeout);
            updatePlanTimeout = setTimeout(() => {
                updateOfferPlanTotal(planId);
            }, 200);
        }
        
        function toggleOfferPlan(planId) {
            const card = document.getElementById('offerPlan_' + planId);
            const checkbox = card.querySelector('.offer-plan-checkbox');
            
            if (checkbox.checked) {
                card.style.borderColor = '#d4a843';
                card.style.boxShadow = '0 5px 20px rgba(212, 168, 67, 0.3)';
            } else {
                card.style.borderColor = '#dee2e6';
                card.style.boxShadow = 'none';
            }
            
            calculateOfferTotals();
        }
        
        // Custom Plans Functions
        function openCustomPlanModal() {
            document.getElementById('customPlanModal').style.display = 'flex';
        }
        
        function closeCustomPlanModal() {
            document.getElementById('customPlanModal').style.display = 'none';
            // Clear all fields
            const fields = ['customPlanName', 'customMBL', 'customOPBL', 'customRegFee', 'customFundDeposit', 
                           'customMgmtFee', 'customMgmtMin', 'customClaimFee', 'customDentalFee', 'customRoomRate'];
            fields.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        }
        
        function saveCustomPlan() {
            const name = document.getElementById('customPlanName').value.trim();
            const mbl = parseInt(document.getElementById('customMBL').value) || 0;
            const opbl = parseInt(document.getElementById('customOPBL').value) || 0;
            const reg = parseFloat(document.getElementById('customRegFee').value) || 0;
            const fund = parseFloat(document.getElementById('customFundDeposit').value) || 0;
            const mgmtFee = parseFloat(document.getElementById('customMgmtFee').value) || 0;
            const mgmtMin = parseFloat(document.getElementById('customMgmtMin').value) || 0;
            const claimFee = parseFloat(document.getElementById('customClaimFee').value) || 0;
            const dentalFee = parseFloat(document.getElementById('customDentalFee').value) || 9.50;
            const roomType = document.getElementById('customRoomType').value;
            const roomRate = parseFloat(document.getElementById('customRoomRate').value) || 0;
            
            if (!name || !mbl || !reg || !fund) {
                alert('Please fill in required fields: Plan Name, MBL, Registration Fee, Fund Deposit');
                return;
            }
            
            const customPlan = {
                id: 'custom_' + Date.now(),
                name: name.toUpperCase(),
                limits: `${mbl/1000}/${opbl/1000}`,
                mbl: mbl,
                opbl: opbl,
                reg: reg,
                fund: [fund, fund * 0.95, fund * 0.9, fund * 0.85],
                mgmtFee: mgmtFee,
                mgmtMin: mgmtMin,
                claimFee: claimFee,
                dentalFee: dentalFee,
                roomType: roomType,
                roomRate: roomRate,
                color: '#6f42c1'
            };
            
            customPlans.push(customPlan);
            localStorage.setItem('polarisCustomPlans', JSON.stringify(customPlans));
            
            renderCustomPlans();
            closeCustomPlanModal();
        }
        
        function renderCustomPlans() {
            const container = document.getElementById('customPlansContainer');
            if (!container) return;
            
            const tierIndex = currentOfferTier - 1;
            
            if (customPlans.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = customPlans.map(plan => `
                <div class="offer-plan-card" id="offerPlan_${plan.id}" data-plan="${plan.id}" style="border: 2px solid #dee2e6; border-radius: 12px; overflow: hidden; background: white;">
                    <div style="background: #6f42c1; color: white; padding: 18px 22px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 20px; font-weight: 700;">POLARIS ${plan.name}</div>
                            <div style="font-size: 13px; opacity: 0.9;">${plan.limits}  PHP ${plan.mbl.toLocaleString()} MBL</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" class="offer-plan-checkbox" data-plan="${plan.id}" onchange="toggleOfferPlan('${plan.id}')" style="width: 28px; height: 28px; cursor: pointer;">
                            <button onclick="deleteCustomPlan('${plan.id}')" style="background: #dc3545; color: white; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 18px;">&times;</button>
                        </div>
                    </div>
                    <div style="padding: 22px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 18px;">
                            <div style="background: #f8f9fa; padding: 14px; border-radius: 8px; text-align: center;">
                                <div style="color: #666; font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Registration</div>
                                <div style="font-weight: 700; color: #1e3a5f; font-size: 20px;">$${plan.reg}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 14px; border-radius: 8px; text-align: center;">
                                <div style="color: #666; font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Fund Deposit</div>
                                <div style="font-weight: 700; color: #1e3a5f; font-size: 20px;">$${plan.fund[tierIndex].toFixed(0)}</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                            <div style="text-align: center;">
                                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 6px; text-transform: uppercase; font-weight: 500;">Principals</label>
                                <input type="number" class="offer-principals" data-plan="${plan.id}" value="0" min="0" oninput="debouncedUpdatePlan('${plan.id}')" style="width: 100%; padding: 14px; border: 2px solid #dee2e6; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700;">
                            </div>
                            <div style="text-align: center;">
                                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 6px; text-transform: uppercase; font-weight: 500;">Dependents</label>
                                <input type="number" class="offer-dependents" data-plan="${plan.id}" value="0" min="0" oninput="debouncedUpdatePlan('${plan.id}')" style="width: 100%; padding: 14px; border: 2px solid #dee2e6; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700;">
                            </div>
                            <div style="text-align: center;">
                                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 6px; text-transform: uppercase; font-weight: 500;">Total</label>
                                <input type="text" class="offer-total" data-plan="${plan.id}" value="0" readonly style="width: 100%; padding: 14px; border: 2px solid #1e3a5f; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; background: #1e3a5f; color: white;">
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function deleteCustomPlan(planId) {
            if (confirm('Delete this custom plan?')) {
                customPlans = customPlans.filter(p => p.id !== planId);
                localStorage.setItem('polarisCustomPlans', JSON.stringify(customPlans));
                renderCustomPlans();
                calculateOfferTotals();
            }
        }
        
        function getAllPlans() {
            const all = { ...OFFER_PLANS };
            customPlans.forEach(cp => { all[cp.id] = cp; });
            return all;
        }
        
        function updateOfferPlanTotal(planId) {
            const card = document.getElementById('offerPlan_' + planId);
            if (!card) return;
            const principals = parseInt(card.querySelector('.offer-principals').value) || 0;
            const dependents = parseInt(card.querySelector('.offer-dependents').value) || 0;
            const total = principals + dependents;
            
            card.querySelector('.offer-total').value = total;
            
            // Auto-check if members entered
            const checkbox = card.querySelector('.offer-plan-checkbox');
            if (total > 0 && !checkbox.checked) {
                checkbox.checked = true;
                toggleOfferPlan(planId);
            }
            
            calculateOfferTotals();
        }
        
        function calculateOfferTotals() {
            const tierIndex = currentOfferTier - 1;
            const allPlans = getAllPlans();
            let totalPrincipals = 0;
            let totalDependents = 0;
            let regTotal = 0;
            let fundTotal = 0;
            let breakdownHTML = '';
            
            Object.values(allPlans).forEach(plan => {
                const card = document.getElementById('offerPlan_' + plan.id);
                if (!card) return;
                
                const checkbox = card.querySelector('.offer-plan-checkbox');
                if (checkbox && checkbox.checked) {
                    const principals = parseInt(card.querySelector('.offer-principals').value) || 0;
                    const dependents = parseInt(card.querySelector('.offer-dependents').value) || 0;
                    const total = principals + dependents;
                    
                    if (total > 0) {
                        totalPrincipals += principals;
                        totalDependents += dependents;
                        
                        const fundValue = Array.isArray(plan.fund) ? plan.fund[tierIndex] : plan.fund;
                        const pRegTotal = total * plan.reg;
                        const pFundTotal = total * fundValue;
                        regTotal += pRegTotal;
                        fundTotal += pFundTotal;
                        
                        breakdownHTML += `<div style="display:grid;grid-template-columns:2fr 0.8fr 0.8fr 0.8fr 1fr 1fr 1fr;gap:8px;padding:12px 15px;background:rgba(255,255,255,0.08);border-bottom:1px solid rgba(255,255,255,0.1);font-size:14px;">
                            <div><strong>POLARIS ${plan.name}</strong><br><span style="opacity:0.7;font-size:12px;">${plan.limits}</span></div>
                            <div style="text-align:right;">${principals.toLocaleString()}</div>
                            <div style="text-align:right;">${dependents.toLocaleString()}</div>
                            <div style="text-align:right;font-weight:600;">${total.toLocaleString()}</div>
                            <div style="text-align:right;">$${pRegTotal.toLocaleString()}</div>
                            <div style="text-align:right;">$${pFundTotal.toLocaleString()}</div>
                            <div style="text-align:right;color:#d4a843;font-weight:bold;">$${(pRegTotal + pFundTotal).toLocaleString()}</div>
                        </div>`;
                    }
                }
            });
            
            const grandTotalMembers = totalPrincipals + totalDependents;
            const dentalIncluded = document.getElementById('offerDentalCheckbox')?.checked || false;
            const dentalTotal = dentalIncluded ? grandTotalMembers * DENTAL_FEE : 0;
            const annualTotal = regTotal + fundTotal + dentalTotal;
            
            // Update display
            document.getElementById('offerTotalPrincipals').textContent = totalPrincipals.toLocaleString();
            document.getElementById('offerTotalDependents').textContent = totalDependents.toLocaleString();
            document.getElementById('offerGrandTotalMembers').textContent = grandTotalMembers.toLocaleString();
            document.getElementById('offerRegTotal').textContent = regTotal.toLocaleString();
            document.getElementById('offerFundTotal').textContent = fundTotal.toLocaleString();
            document.getElementById('offerDentalTotal').textContent = dentalTotal.toLocaleString();
            document.getElementById('offerAnnualTotal').textContent = annualTotal.toLocaleString();
            
            // Update plan breakdown
            const breakdownContainer = document.getElementById('offerPlanBreakdown');
            if (breakdownHTML) {
                breakdownContainer.innerHTML = `<div style="background:rgba(0,0,0,0.2);padding:10px 15px;font-size:11px;text-transform:uppercase;display:grid;grid-template-columns:2fr 0.8fr 0.8fr 0.8fr 1fr 1fr 1fr;gap:8px;opacity:0.8;">
                    <div>Plan</div><div style="text-align:right;">Principals</div><div style="text-align:right;">Dependents</div><div style="text-align:right;">Members</div><div style="text-align:right;">Reg Fee</div><div style="text-align:right;">Fund Dep</div><div style="text-align:right;">Subtotal</div>
                </div>${breakdownHTML}`;
            } else {
                breakdownContainer.innerHTML = '';
            }
            
            // Auto-select tier based on total
            autoSelectOfferTier(grandTotalMembers);
        }
        
        function autoSelectOfferTier(total) {
            // Don't auto-select if total is 0 or very small
            if (total < 10) return;
            
            let newTier;
            if (total <= 500) newTier = 1;
            else if (total <= 750) newTier = 2;
            else if (total <= 1100) newTier = 3;
            else newTier = 4;
            
            // Only update if tier actually changed AND we're not already in a calculation
            if (newTier !== currentOfferTier) {
                // Just update the badge text, don't re-render cards
                const badge = document.getElementById('currentTierBadge');
                if (badge) {
                    const tierRanges = {1: '1-500', 2: '501-750', 3: '751-1100', 4: '1100+'};
                    badge.textContent = `Tier ${newTier}: ${tierRanges[newTier]} members`;
                }
                // Update button styles without triggering selectOfferTier
                document.querySelectorAll('.offer-tier-btn').forEach(btn => {
                    const btnTier = parseInt(btn.dataset.tier);
                    if (btnTier === newTier) {
                        btn.style.background = '#1e3a5f';
                        btn.style.color = 'white';
                        btn.style.borderColor = '#1e3a5f';
                    } else {
                        btn.style.background = 'white';
                        btn.style.color = '#333';
                        btn.style.borderColor = '#dee2e6';
                    }
                });
                currentOfferTier = newTier;
            }
        }
        
        function updateOfferValidityDate() {
            const daysInput = document.getElementById('offerValidityDays');
            if (!daysInput) return;
            
            const days = parseInt(daysInput.value) || 30;
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + days);
            
            const expirySpan = document.getElementById('offerExpiryDate');
            if (expirySpan) {
                expirySpan.textContent = expiryDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
        }
        
        function getOfferClientName() {
            const select = document.getElementById('offerClientSelect');
            if (select.value === '' || select.value === 'new') return 'Prospective Client';
            return select.options[select.selectedIndex].text;
        }
        
        function getSelectedOfferPlans() {
            const selected = [];
            const tierIndex = currentOfferTier - 1;
            
            Object.values(OFFER_PLANS).forEach(plan => {
                const card = document.getElementById('offerPlan_' + plan.id);
                if (!card) return;
                
                const checkbox = card.querySelector('.offer-plan-checkbox');
                if (checkbox && checkbox.checked) {
                    const principals = parseInt(card.querySelector('.offer-principals').value) || 0;
                    const dependents = parseInt(card.querySelector('.offer-dependents').value) || 0;
                    const total = principals + dependents;
                    
                    if (total > 0) {
                        selected.push({
                            program_id: plan.id,
                            plan: plan.name,
                            limits: plan.limits,
                            mbl: plan.mbl,
                            principals,
                            dependents,
                            total,
                            regFee: plan.reg,
                            fundDeposit: plan.fund[tierIndex]
                        });
                    }
                }
            });
            
            return selected;
        }
        
        function resetOfferForm() {
            // Reset client selection
            document.getElementById('offerClientSelect').value = '';
            
            // Reset tier
            currentOfferTier = 1;
            document.querySelectorAll('.offer-tier-btn').forEach((btn, i) => {
                if (i === 0) {
                    btn.style.background = '#1e3a5f';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#333';
                }
            });
            document.getElementById('currentTierBadge').textContent = 'Tier 1: 1-500 members';
            
            // Reset dental
            const dentalCheckbox = document.getElementById('offerDentalCheckbox');
            if (dentalCheckbox) dentalCheckbox.checked = false;
            
            // Reset validity
            const validityInput = document.getElementById('offerValidityDays');
            if (validityInput) validityInput.value = 30;
            updateOfferValidityDate();
            
            // Reset notes
            const notesField = document.getElementById('offerNotes');
            if (notesField) notesField.value = '';
            
            // Re-render plan cards (this resets all values)
            renderOfferPlanCards();
            calculateOfferTotals();
        }
        
        async function saveOfferDraft() {
            const plans = getSelectedOfferPlans();
            if (plans.length === 0) {
                alert('Please select at least one plan with members.');
                return;
            }
            
            const clientSelect = document.getElementById('offerClientSelect');
            let clientId = clientSelect.value;
            let clientName = getOfferClientName();
            let contactPerson = '';
            let contactEmail = '';
            
            if (clientId === 'new' || clientId === '') {
                // No client selected - offer can still be saved as draft
                clientName = 'Prospective Client';
                contactPerson = '';
                contactEmail = '';
                clientId = '';
            } else if (clientId) {
                const selectedOption = clientSelect.options[clientSelect.selectedIndex];
                contactEmail = selectedOption.dataset.email || '';
                contactPerson = selectedOption.dataset.contact || '';
            }
            
            const offerData = {
                client_id: clientId,
                client_name: clientName,
                contact_person: contactPerson,
                contact_email: contactEmail,
                tier: currentOfferTier,
                includes_dental: document.getElementById('offerDentalCheckbox')?.checked || false,
                validity_days: parseInt(document.getElementById('offerValidityDays')?.value) || 30,
                notes: document.getElementById('offerNotes')?.value || '',
                items: plans,
                created_by: 'Admin'
            };
            
            try {
                const response = await fetch(API_URL + '?action=createOffer&data=' + encodeURIComponent(JSON.stringify(offerData)));
                const result = await response.json();
                
                if (result.success) {
                    alert(' Offer saved successfully!\n\nOffer ID: ' + result.offer_id + '\nTotal Members: ' + result.total_members + '\nGrand Total: $' + result.grand_total.toLocaleString());
                    resetOfferForm();
                    switchOffersTab('list');
                    loadOfferStats();
                    loadOffers();
                } else {
                    alert(' Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Error saving offer:', e);
                alert(' Error saving offer: ' + e.message);
            }
        }
        
        function generateOfferEmailPreview() {
            const plans = getSelectedOfferPlans();
            if (plans.length === 0) {
                alert('Please select at least one plan with members.');
                return;
            }
            
            // For now, show a simple preview
            const clientName = getOfferClientName();
            const totalMembers = document.getElementById('offerGrandTotalMembers').textContent;
            const annualTotal = document.getElementById('offerAnnualTotal').textContent;
            
            alert(` EMAIL PREVIEW\n\nTo: ${clientName}\n\nDear Sir/Madam,\n\nWe are pleased to present our healthcare proposal:\n\n Total Members: ${totalMembers}\n Annual Investment: $${annualTotal}\n\n[Full email functionality coming soon!]`);
        }
        
        function saveAndSendOffer() {
            alert(' Save & Send functionality coming soon!\n\nFor now, please save as draft.');
            saveOfferDraft();
        }
        
        function viewOffer(offerId) {
            alert('View offer: ' + offerId + '\n\nDetailed view coming soon!');
        }
        
        async function sendOffer(offerId) {
            if (!confirm('Mark offer ' + offerId + ' as sent?')) return;
            
            try {
                const response = await fetch(API_URL + '?action=updateOfferStatus&offerId=' + offerId + '&status=sent&notes=Sent from dashboard');
                const result = await response.json();
                
                if (result.success) {
                    alert(' Offer marked as sent!');
                    loadOfferStats();
                    loadOffers();
                } else {
                    alert(' Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Error:', e);
                alert(' Error: ' + e.message);
            }
        }
    </script>
<!-- ADD NEW CLIENT MODAL - Outside all other modals -->
<div id="addClientModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:99999; align-items:center; justify-content:center;">
    <div style="background:#1a2332; border:1px solid #2d3748; border-radius:16px; width:90%; max-width:800px; max-height:90vh; overflow-y:auto;">
        <div style="background:linear-gradient(135deg, #1E3A5F, #2d5a87); padding:1.5rem 2rem; display:flex; justify-content:space-between; align-items:center; border-radius:16px 16px 0 0;">
            <h2 style="color:white; margin:0; font-size:1.5rem;"> Add New Client</h2>
            <button onclick="closeAddClientModal()" style="background:rgba(255,255,255,0.2); border:none; color:white; width:36px; height:36px; border-radius:50%; cursor:pointer; font-size:1.2rem;"></button>
        </div>
        <div style="padding:1.5rem 2rem;">
            <!-- Company Info -->
            <div style="margin-bottom:1.5rem;">
                <h4 style="color:#d4a843; margin-bottom:1rem;"> Company Information</h4>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                    <div style="grid-column:span 2;"><label style="display:block; color:#a0aec0; font-size:0.85rem; margin-bottom:0.5rem;">Company Name *</label><input type="text" id="clientName" placeholder="e.g., Alpha Marine Ltd" style="width:100%; padding:0.75rem; background:#2d3748; border:1px solid #4a5568; border-radius:8px; color:white; font-size:1rem;"></div>
                    <div><label style="display:block; color:#a0aec0; font-size:0.85rem; margin-bottom:0.5rem;">Country *</label><input type="text" id="clientCountry" placeholder="e.g., Greece" style="width:100%; padding:0.75rem; background:#2d3748; border:1px solid #4a5568; border-radius:8px; color:white; font-size:1rem;"></div>
                    <div><label style="display:block; color:#a0aec0; font-size:0.85rem; margin-bottom:0.5rem;">TIN Number</label><input type="text" id="clientTIN" placeholder="Tax Identification Number" style="width:100%; padding:0.75rem; background:#2d3748; border:1px solid #4a5568; border-radius:8px; color:white; font-size:1rem;"></div>
                    <div style="grid-column:span 2;"><label style="display:block; color:#a0aec0; font-size:0.85rem; margin-bottom:0.5rem;">Registered Address</label><input type="text" id="clientRegAddress" placeholder="Full registered address" style="width:100%; padding:0.75rem; background:#2d3748; border:1px solid #4a5568; border-radius:8px; color:white; font-size:1rem;"></div>
                    <div style="grid-column:span 2;"><label style="display:block; color:#a0aec0; font-size:0.85rem; margin-bottom:0.5rem;">Operating Address</label><input type="text" id="clientOpAddress" placeholder="Operating address (if different)" style="width:100%; padding:0.75rem; background:#2d3748; border:1px solid #4a5568; border-radius:8px; color:white; font-size:1rem;"></div>
                    <div><label style="display:block; color:#a0aec0; font-size:0.85rem; margin-bottom:0.5rem;">VAT Number</label><input type="text" id="clientVAT" placeholder="Value Added Tax number" style="width:100%; padding:0.75rem; background:#2d3748; border:1px solid #4a5568; border-radius:8px; color:white; font-size:1rem;"></div>
                </div>
            </div>
            
            <!-- Contact Info -->
            <div style="margin-bottom:1.5rem;">
                <h4 style="color:#d4a843; margin-bottom:1rem;"> Contact Information</h4>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                    <div><label style="display:block; color:#a0aec0; font-size:0.85rem; margin-bottom:0.5rem;">Contact Person *</label><input type="text" id="clientContactPerson" placeholder="Full name" style="width:100%; padding:0.75rem; background:#2d3748; border:1px solid #4a5568; border-radius:8px; color:white; font-size:1rem;"></div>
                    <div><label style="display:block; color:#a0aec0; font-size:0.85rem; margin-bottom:0.5rem;">Capacity / Title</label><input type="text" id="clientCapacity" placeholder="e.g., Fleet Manager" style="width:100%; padding:0.75rem; background:#2d3748; border:1px solid #4a5568; border-radius:8px; color:white; font-size:1rem;"></div>
                    <div><label style="display:block; color:#a0aec0; font-size:0.85rem; margin-bottom:0.5rem;">Email *</label><input type="email" id="clientEmail" placeholder="email@company.com" style="width:100%; padding:0.75rem; background:#2d3748; border:1px solid #4a5568; border-radius:8px; color:white; font-size:1rem;"></div>
                    <div><label style="display:block; color:#a0aec0; font-size:0.85rem; margin-bottom:0.5rem;">Phone</label><input type="text" id="clientPhone" placeholder="+30 xxx xxx xxxx" style="width:100%; padding:0.75rem; background:#2d3748; border:1px solid #4a5568; border-radius:8px; color:white; font-size:1rem;"></div>
                    <div><label style="display:block; color:#a0aec0; font-size:0.85rem; margin-bottom:0.5rem;">Mobile</label><input type="text" id="clientMobile" placeholder="+30 xxx xxx xxxx" style="width:100%; padding:0.75rem; background:#2d3748; border:1px solid #4a5568; border-radius:8px; color:white; font-size:1rem;"></div>
                    <div><label style="display:block; color:#a0aec0; font-size:0.85rem; margin-bottom:0.5rem;">Fax</label><input type="text" id="clientFax" placeholder="+30 xxx xxx xxxx" style="width:100%; padding:0.75rem; background:#2d3748; border:1px solid #4a5568; border-radius:8px; color:white; font-size:1rem;"></div>
                </div>
            </div>
            
            <!-- Signatory Info -->
            <div style="margin-bottom:1.5rem;">
                <h4 style="color:#d4a843; margin-bottom:1rem;"> Authorized Signatory</h4>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                    <div><label style="display:block; color:#a0aec0; font-size:0.85rem; margin-bottom:0.5rem;">Signatory Name *</label><input type="text" id="clientSignatoryName" placeholder="Full legal name" style="width:100%; padding:0.75rem; background:#2d3748; border:1px solid #4a5568; border-radius:8px; color:white; font-size:1rem;"></div>
                    <div><label style="display:block; color:#a0aec0; font-size:0.85rem; margin-bottom:0.5rem;">Signatory Title *</label><input type="text" id="clientSignatoryTitle" placeholder="e.g., CEO, Director" style="width:100%; padding:0.75rem; background:#2d3748; border:1px solid #4a5568; border-radius:8px; color:white; font-size:1rem;"></div>
                </div>
            </div>
            
            <div id="addClientStatus" style="margin-top:1rem;"></div>
            
            <div style="display:flex; gap:1rem; justify-content:flex-end; margin-top:1.5rem;">
                <button onclick="closeAddClientModal()" style="padding:0.75rem 1.5rem; background:#4a5568; color:white; border:none; border-radius:8px; cursor:pointer; font-size:1rem;">Cancel</button>
                <button onclick="saveNewClientWithOffersUpdate()" style="padding:0.75rem 1.5rem; background:#27ae60; color:white; border:none; border-radius:8px; cursor:pointer; font-size:1rem; font-weight:600;"> Save Client</button>
            </div>
        </div>
    </div>
</div>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polaris Financial Services - Admin Dashboard v26</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Google Identity Services for Gmail API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --polaris-green: #1B5E20;
            --polaris-green-light: #2E7D32;
            --polaris-gold: #D4AF37;
            --gold-plan: #FFD700;
            --platinum-plan: #E5E4E2;
            --silver-plan: #C0C0C0;
            --bg-dark: #3d5a80;
            --bg-card: #0d1f2d;
            --text-primary: #ffffff;
            --text-secondary: #b8d4e8;
            --text-muted: #7aa0c0;
            --border-color: #2d5070;
            --success: #4CAF50;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --polaris-navy: #0a1628;
            --polaris-navy-light: #1e3a5f;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Open Sans', sans-serif;
            background: #3d5a80;
            color: var(--text-primary);
            min-height: 100vh;
        }
        h1, h2, h3 { font-family: 'Montserrat', sans-serif; }
        
        .bg-pattern {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(ellipse at 20% 20%, rgba(27, 94, 32, 0.15) 0%, transparent 50%),
                        radial-gradient(ellipse at 80% 80%, rgba(212, 175, 55, 0.08) 0%, transparent 50%);
        }
        
        /* ═══════════════════════════════════════════════════════════════════════════
           IMPRESSIVE WELCOME LOADING SCREEN
           ═══════════════════════════════════════════════════════════════════════════ */
        .welcome-loading-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #0a1628 0%, #1e3a5f 50%, #0a1628 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100000;
            overflow: hidden;
        }
        .welcome-loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.8s ease, visibility 0.8s ease;
        }
        
        /* Animated Background Stars */
        .stars-container {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        .star {
            position: absolute;
            width: 3px;
            height: 3px;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s infinite;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        
        /* Animated Compass/North Star */
        .polaris-star {
            position: absolute;
            top: 15%;
            width: 120px;
            height: 120px;
            animation: pulseStar 2s ease-in-out infinite, rotateStar 20s linear infinite;
        }
        .polaris-star::before {
            content: '✦';
            font-size: 100px;
            color: var(--polaris-gold);
            text-shadow: 0 0 30px var(--polaris-gold), 0 0 60px var(--polaris-gold), 0 0 90px rgba(212,175,55,0.5);
            filter: drop-shadow(0 0 20px var(--polaris-gold));
        }
        @keyframes pulseStar {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.3); }
        }
        @keyframes rotateStar {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* 3D Welcome Text */
        .welcome-content {
            text-align: center;
            z-index: 10;
            perspective: 1000px;
        }
        
        .welcome-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            font-weight: 300;
            color: rgba(255,255,255,0.7);
            letter-spacing: 8px;
            text-transform: uppercase;
            margin-bottom: 1rem;
            animation: fadeInDown 1s ease forwards;
            opacity: 0;
        }
        
        .welcome-main-text {
            font-family: 'Montserrat', sans-serif;
            font-size: 4.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, #ffffff 0%, #d4af37 50%, #ffffff 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
            animation: fadeInUp 1s 0.3s ease forwards, shimmer 3s linear infinite;
            opacity: 0;
            transform-style: preserve-3d;
            letter-spacing: 2px;
        }
        
        .welcome-polaris {
            display: block;
            font-size: 6rem;
            font-weight: 900;
            background: linear-gradient(135deg, #d4af37 0%, #f5d76e 30%, #d4af37 50%, #f5d76e 70%, #d4af37 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: fadeIn3D 1.2s 0.5s ease forwards, shimmer 2s linear infinite;
            opacity: 0;
            text-shadow: 0 10px 30px rgba(212,175,55,0.3);
            filter: drop-shadow(0 5px 15px rgba(212,175,55,0.4));
        }
        
        .welcome-team {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem;
            font-weight: 300;
            color: white;
            letter-spacing: 15px;
            text-transform: uppercase;
            margin-top: 0.5rem;
            animation: fadeInUp 1s 0.7s ease forwards;
            opacity: 0;
        }
        
        .welcome-tagline {
            font-size: 1.2rem;
            color: var(--polaris-gold);
            margin-top: 2rem;
            font-weight: 500;
            letter-spacing: 3px;
            animation: fadeInUp 1s 1s ease forwards;
            opacity: 0;
        }
        
        /* Sailing Ship Loading */
        .welcome-ship-container {
            margin-top: 3rem;
            width: 80%;
            max-width: 800px;
            position: relative;
            animation: fadeInUp 1s 1.2s ease forwards;
            opacity: 0;
        }
        .welcome-ship-track {
            position: relative;
            height: 50px;
            display: flex;
            align-items: center;
            overflow: visible;
        }
        .welcome-ship {
            position: absolute;
            left: -10%;
            animation: sailShipSlow 20s linear infinite, shipBob 2s ease-in-out infinite;
            filter: drop-shadow(0 8px 20px rgba(212,175,55,0.6));
            z-index: 10;
        }
        .welcome-ship svg {
            width: 70px;
            height: 45px;
        }
        .welcome-ship-wake {
            position: absolute;
            left: -10%;
            bottom: 5px;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(212,175,55,0.4), rgba(212,175,55,0.1));
            border-radius: 3px;
            animation: wakeTrailSlow 20s linear infinite;
            width: 20%;
        }
        .welcome-ship-sea {
            position: relative;
            width: 100%;
            height: 30px;
            overflow: visible;
        }
        .welcome-ship-sea svg {
            width: 100%;
            height: 100%;
        }
        .ship-wave {
            animation: waveMove 3s linear infinite;
        }
        .ship-wave.wave2 {
            animation: waveMove 4s linear infinite reverse;
        }
        
        @keyframes sailShipSlow {
            0% { left: -12%; }
            100% { left: 100%; }
        }
        @keyframes shipBob {
            0%, 100% { transform: translateY(0) rotate(-1deg); }
            50% { transform: translateY(-4px) rotate(1deg); }
        }
        @keyframes wakeTrailSlow {
            0% { left: -30%; opacity: 0; }
            3% { opacity: 0.8; }
            97% { opacity: 0.8; }
            100% { left: 80%; opacity: 0; }
        }
        @keyframes waveMove {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50px); }
        }
        
        /* Old loading bar - hidden */
        .welcome-loader {
            display: none;
        }
        .welcome-loader-bar {
            display: none;
        }
        
        .welcome-loading-text {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.5);
            animation: fadeInUp 1s 1.4s ease forwards;
            opacity: 0;
        }
        
        /* Fullscreen Button on Welcome */
        .welcome-fullscreen-btn {
            margin-top: 2rem;
            padding: 1rem 2.5rem;
            background: linear-gradient(135deg, var(--polaris-gold), #f5d76e);
            color: var(--polaris-navy);
            border: none;
            border-radius: 50px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            animation: fadeInUp 1s 2s ease forwards, pulseGlow 2s ease-in-out infinite;
            opacity: 0;
            transition: all 0.3s;
            box-shadow: 0 10px 40px rgba(212,175,55,0.4);
        }
        .welcome-fullscreen-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 50px rgba(212,175,55,0.6);
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 10px 40px rgba(212,175,55,0.4); }
            50% { box-shadow: 0 10px 60px rgba(212,175,55,0.7); }
        }
        
        /* Fullscreen Toggle Button */
        .fullscreen-toggle-btn {
            position: fixed;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            background: rgba(0,0,0,0.3);
            color: var(--polaris-gold);
            border: 1px solid rgba(212,175,55,0.3);
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        .fullscreen-toggle-btn:hover {
            background: rgba(212,175,55,0.2);
            border-color: var(--polaris-gold);
            transform: scale(1.1);
        }
        
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn3D {
            from { opacity: 0; transform: translateZ(-100px) rotateX(20deg); }
            to { opacity: 1; transform: translateZ(0) rotateX(0); }
        }
        @keyframes shimmer {
            to { background-position: 200% center; }
        }
        @keyframes loadProgress {
            0% { width: 0%; }
            20% { width: 20%; }
            50% { width: 60%; }
            80% { width: 85%; }
            100% { width: 100%; }
        }
        
        /* Polaris Star - Welcome Screen */
        .polaris-star-welcome {
            position: absolute;
            top: 10%;
            font-size: 100px;
            color: var(--polaris-gold);
            text-shadow: 
                0 0 30px var(--polaris-gold), 
                0 0 60px var(--polaris-gold), 
                0 0 90px rgba(212,175,55,0.5),
                0 0 120px rgba(212,175,55,0.3);
            animation: pulseStarWelcome 2s ease-in-out infinite, rotateStarSlow 30s linear infinite;
            z-index: 5;
        }
        @keyframes pulseStarWelcome {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.15); filter: brightness(1.4); }
        }
        @keyframes rotateStarSlow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Particles Container */
        .particles-container {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
        }
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--polaris-gold);
            border-radius: 50%;
            opacity: 0;
            animation: floatParticle 8s ease-in-out infinite;
        }
        @keyframes floatParticle {
            0% { transform: translateY(100vh) scale(0); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { transform: translateY(-100px) scale(1); opacity: 0; }
        }
        
        /* Welcome Waves */
        .welcome-waves {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 200px;
            z-index: 2;
        }
        .welcome-waves svg {
            width: 100%;
            height: 100%;
        }
        
        /* Stars Container */
        .stars-container {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkleStar 3s ease-in-out infinite;
        }
        @keyframes twinkleStar {
            0%, 100% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        
        /* ═══════════════════════════════════════════════════════════════════════════
           MAIN DASHBOARD
           ═══════════════════════════════════════════════════════════════════════════ */
        .main-dashboard {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #0a1628 0%, #1e3a5f 100%);
            z-index: 9998;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .main-dashboard.hidden {
            display: none;
        }
        
        /* Dashboard Header */
        .dashboard-header {
            padding: 1.5rem 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(212,175,55,0.2);
        }
        .dashboard-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .dashboard-logo-icon {
            font-size: 2.5rem;
            color: var(--polaris-gold);
            animation: pulseStar 3s ease-in-out infinite;
        }
        .dashboard-logo-text {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
        }
        .dashboard-logo-text span {
            color: var(--polaris-gold);
        }
        .dashboard-user {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: rgba(255,255,255,0.8);
        }
        .dashboard-user-avatar {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--polaris-gold), #f5d76e);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--polaris-navy);
            font-size: 1.2rem;
        }
        
        /* Dashboard Stats Bar */
        .dashboard-stats-bar {
            display: flex;
            justify-content: center;
            gap: 3rem;
            padding: 1.5rem;
            background: rgba(0,0,0,0.1);
        }
        .dashboard-stat {
            text-align: center;
        }
        .dashboard-stat-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--polaris-gold);
            text-shadow: 0 0 20px rgba(212,175,55,0.3);
        }
        .dashboard-stat-label {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 0.3rem;
        }
        
        /* Dashboard Cards Container */
        .dashboard-cards-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2rem;
            max-width: 1400px;
            width: 100%;
        }
        
        /* Dashboard Card */
        .dashboard-card {
            background: linear-gradient(145deg, rgba(30,58,95,0.8), rgba(10,22,40,0.9));
            border: 1px solid rgba(212,175,55,0.2);
            border-radius: 24px;
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, transparent 0%, rgba(212,175,55,0.1) 100%);
            opacity: 0;
            transition: opacity 0.4s;
        }
        .dashboard-card:hover {
            transform: translateY(-10px) scale(1.02);
            border-color: var(--polaris-gold);
            box-shadow: 0 20px 60px rgba(212,175,55,0.3), 0 0 40px rgba(212,175,55,0.1);
        }
        .dashboard-card:hover::before {
            opacity: 1;
        }
        .dashboard-card:hover .dashboard-card-icon {
            transform: scale(1.1) rotateY(10deg);
            text-shadow: 0 0 40px currentColor;
        }
        
        .dashboard-card-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            transition: all 0.4s;
            display: block;
        }
        .dashboard-card-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
        }
        .dashboard-card-desc {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.5);
        }
        .dashboard-card-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--polaris-gold);
            color: var(--polaris-navy);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
        }
        
        /* Card Colors */
        .dashboard-card.clients .dashboard-card-icon { color: #3498db; }
        .dashboard-card.members .dashboard-card-icon { color: #3498db; }
        .dashboard-card.offers .dashboard-card-icon { color: #27ae60; }
        .dashboard-card.contracts .dashboard-card-icon { color: #9b59b6; }
        .dashboard-card.email .dashboard-card-icon { color: #e74c3c; }
        .dashboard-card.comparison .dashboard-card-icon { color: #8b5cf6; }
        .dashboard-card.reports .dashboard-card-icon { color: #f39c12; }
        .dashboard-card.calculator .dashboard-card-icon { color: #1abc9c; }
        .dashboard-card.settings .dashboard-card-icon { color: #95a5a6; }
        .dashboard-card.proposal .dashboard-card-icon { color: #27ae60; }
        .dashboard-card.compare .dashboard-card-icon { color: #e67e22; }
        .dashboard-card.followups .dashboard-card-icon { color: #27ae60; }
        
        /* Dashboard Stars Background */
        .dashboard-stars-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }
        .dashboard-particles-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
            overflow: hidden;
        }
        .dashboard-cards-container {
            position: relative;
        }
        .dashboard-cards {
            position: relative;
            z-index: 10;
        }
        .dashboard-star {
            position: absolute;
            background: rgba(212, 175, 55, 0.8);
            border-radius: 50%;
            animation: dashboardTwinkle 4s ease-in-out infinite;
            box-shadow: 0 0 6px rgba(212, 175, 55, 0.5);
        }
        @keyframes dashboardTwinkle {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        .dashboard-particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: var(--polaris-gold);
            border-radius: 50%;
            opacity: 0;
            animation: dashboardFloat 10s ease-in-out infinite;
        }
        @keyframes dashboardFloat {
            0% { transform: translateY(100%) translateX(0); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(-100%) translateX(20px); opacity: 0; }
        }
        
        /* Dashboard Footer */
        .dashboard-footer {
            padding: 1rem;
            text-align: center;
            color: rgba(255,255,255,0.4);
            font-size: 0.85rem;
            background: rgba(0,0,0,0.2);
        }
        .dashboard-footer span {
            color: var(--polaris-gold);
        }
        
        /* Back to Dashboard Button - Top Right */
        .back-to-dashboard-btn {
            position: fixed;
            top: 1rem;
            right: 60px;
            background: linear-gradient(135deg, var(--polaris-gold), #f5d76e);
            color: var(--polaris-navy);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(212,175,55,0.4);
            z-index: 99999;
            transition: all 0.3s;
            display: none;
            backdrop-filter: blur(5px);
        }
        .back-to-dashboard-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(212,175,55,0.5);
        }
        .back-to-dashboard-btn.visible {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        /* ═══════════════════════════════════════════════════════════════════════════
           OLD LOADING SCREEN (keep for fallback)
           ═══════════════════════════════════════════════════════════════════════════ */
        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); display: none; flex-direction: column;
            align-items: center; justify-content: center; z-index: 10000;
            transition: opacity 0.5s;
        }
        .loading-screen.hidden { opacity: 0; visibility: hidden; }
        .loader-ring {
            width: 80px; height: 80px; border: 3px solid var(--border-color);
            border-top-color: var(--polaris-gold); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 1.5rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.7; } 
        }
        @keyframes statusSlideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .login-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: flex;
            align-items: center; justify-content: center; z-index: 9999;
        }
        .login-modal.hidden { display: none; }
        .login-box {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 20px; padding: 3rem; width: 100%; max-width: 420px;
        }
        .login-box::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--polaris-green), var(--polaris-gold));
        }
        .login-title {
            font-size: 1.75rem; font-weight: 700; text-align: center;
            margin-bottom: 0.5rem;
        }
        .login-subtitle {
            text-align: center; color: var(--text-secondary);
            margin-bottom: 2rem;
        }
        .login-input {
            width: 100%; background: var(--bg-dark);
            border: 1px solid var(--border-color); border-radius: 10px;
            padding: 1rem; color: var(--text-primary);
            font-family: inherit; margin-bottom: 1rem;
        }
        .login-input:focus { outline: none; border-color: var(--polaris-green); }
        .login-btn {
            width: 100%; background: linear-gradient(135deg, var(--polaris-green), var(--polaris-green-light));
            border: none; border-radius: 10px; padding: 1rem;
            color: white; font-family: 'Montserrat', sans-serif;
            font-weight: 700; cursor: pointer; transition: transform 0.3s;
        }
        .login-btn:hover { transform: translateY(-2px); }
        .login-error { color: var(--danger); text-align: center; margin-top: 1rem; }
        
        .header {
            background: rgba(10, 26, 10, 0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem; position: sticky; top: 0; z-index: 100;
        }
        .header-content {
            max-width: 1600px; margin: 0 auto;
            display: flex; align-items: center; justify-content: space-between;
            padding-left: 0;
        }
        .logo-section { display: flex; align-items: center; gap: 0.75rem; margin-left: -1rem; }
        .polaris-star {
            font-size: 2rem;
            background: linear-gradient(135deg, #FFD700, #FFA000, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 8px rgba(255,215,0,0.5));
            animation: starGlow 2s ease-in-out infinite alternate;
        }
        @keyframes starGlow {
            from { filter: drop-shadow(0 0 5px rgba(255,215,0,0.4)); }
            to { filter: drop-shadow(0 0 12px rgba(255,215,0,0.7)); }
        }
        .polaris-text {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4rem;
            font-weight: 800;
            letter-spacing: 2px;
            background: linear-gradient(135deg, #D4AF37, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .logo-section img { height: 40px; }
        .portal-badge {
            background: var(--polaris-gold); color: var(--bg-dark);
            padding: 0.3rem 0.8rem; border-radius: 15px;
            font-size: 0.7rem; font-weight: 700;
        }
        .user-section { display: flex; align-items: center; gap: 0.6rem; }
        .client-badge {
            display: flex; align-items: center; gap: 0.5rem;
            background: var(--bg-card); border: 1px solid var(--border-color);
            padding: 0.4rem 1rem 0.4rem 0.4rem; border-radius: 25px;
        }
        .client-avatar {
            width: 32px; height: 32px; border-radius: 50%;
            background: var(--polaris-green); display: flex;
            align-items: center; justify-content: center; font-weight: 700;
        }
        .logout-btn {
            background: transparent; border: 1px solid var(--border-color);
            color: var(--text-secondary); padding: 0.5rem 1rem;
            border-radius: 8px; cursor: pointer;
        }
        .logout-btn:hover { background: var(--danger); border-color: var(--danger); color: white; }
        
        /* Admin Dashboard - Client Selector */
        .client-selector-wrapper {
            display: flex; align-items: center; gap: 0.75rem;
        }
        .client-selector {
            background: var(--bg-dark); border: 2px solid var(--border-color);
            color: var(--text-primary); padding: 0.6rem 1rem;
            border-radius: 10px; font-family: inherit; font-size: 0.9rem;
            min-width: 250px; cursor: pointer;
            transition: all 0.3s;
        }
        .client-selector:focus { outline: none; border-color: var(--polaris-gold); }
        .client-selector:hover { border-color: var(--polaris-green); }
        .compare-btn {
            display: flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, #d4a843, #b8860b);
            color: #1e3a5f; padding: 0.6rem 1.25rem;
            border: none; border-radius: 25px; cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem; font-weight: 700;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(212,168,67,0.3);
        }
        .compare-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(212,168,67,0.5); }
        .compare-btn.active { background: linear-gradient(135deg, #E65100, #FF9800); color: white; }
        .active-members-btn {
            display: flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, var(--polaris-gold), #FFA000);
            color: var(--bg-dark); padding: 0.6rem 1.25rem;
            border-radius: 25px; text-decoration: none;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem; font-weight: 700;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(212,175,55,0.3);
            cursor: pointer; border: none;
        }
        .active-members-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212,175,55,0.5);
        }
        .admin-badge { background: linear-gradient(135deg, var(--polaris-green), #4CAF50); color: white; }
        .admin-avatar { background: linear-gradient(135deg, #FFD700, #FFA000) !important; color: var(--bg-dark) !important; }
        
        /* Compare Panel */
        .compare-panel {
            background: rgba(10, 26, 10, 0.98); border-bottom: 2px solid var(--polaris-gold);
            padding: 1.5rem; position: sticky; top: 70px; z-index: 99;
            backdrop-filter: blur(10px);
        }
        .compare-panel-content {
            max-width: 800px; margin: 0 auto; text-align: center;
        }
        .compare-panel h3 { color: var(--polaris-gold); margin-bottom: 1rem; font-size: 1.2rem; }
        .compare-selectors {
            display: flex; align-items: center; justify-content: center; gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .compare-select-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .compare-select-group label { color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; }
        .compare-select {
            background: var(--bg-dark); border: 2px solid var(--border-color);
            color: var(--text-primary); padding: 0.75rem 1.25rem;
            border-radius: 10px; font-size: 1rem; min-width: 220px;
        }
        .compare-vs {
            font-family: 'Montserrat', sans-serif; font-weight: 800;
            font-size: 1.5rem; color: var(--polaris-gold);
            padding: 0 1rem;
        }
        .compare-apply-btn {
            background: linear-gradient(135deg, var(--polaris-green), #4CAF50);
            color: white; border: none; padding: 0.75rem 2rem;
            border-radius: 25px; font-weight: 700; cursor: pointer;
            margin-right: 1rem; transition: all 0.3s;
        }
        .compare-apply-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(46,125,50,0.4); }
        .compare-cancel-btn {
            background: transparent; border: 2px solid var(--border-color);
            color: var(--text-secondary); padding: 0.7rem 1.5rem;
            border-radius: 25px; cursor: pointer; transition: all 0.3s;
        }
        .compare-cancel-btn:hover { border-color: var(--danger); color: var(--danger); }
        
        /* Section Dividers */
        .section-divider {
            display: flex; align-items: center; justify-content: center; gap: 1rem;
            margin: 3rem 0 2rem; padding: 1rem 0;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(90deg, transparent, rgba(46,125,50,0.1), transparent);
        }
        .section-divider-icon { font-size: 2rem; }
        .section-divider-text {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4rem; font-weight: 800;
            letter-spacing: 3px; text-transform: uppercase;
            background: linear-gradient(135deg, var(--polaris-gold), #FFD700);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .client-filter-badge {
            background: linear-gradient(135deg, var(--polaris-green), #4CAF50);
            color: white; padding: 0.3rem 0.8rem; border-radius: 15px;
            font-size: 0.85rem; font-weight: 600; margin-left: 0.5rem;
        }
        
        /* Quarter Selector Bar */
        .quarter-selector-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(10, 26, 10, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1rem 1.5rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }
        .quarter-selector-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .quarter-label {
            color: var(--text-muted);
            font-size: 0.95rem;
            font-weight: 600;
        }
        .quarter-buttons {
            display: flex;
            gap: 0.5rem;
        }
        .quarter-btn {
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.6rem 1.25rem;
            border-radius: 10px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .quarter-btn:hover {
            border-color: var(--polaris-gold);
            color: var(--polaris-gold);
        }
        .quarter-btn.active {
            background: linear-gradient(135deg, var(--polaris-green), #4CAF50);
            border-color: var(--polaris-green);
            color: white;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3);
        }
        .quarter-btn.compare-selected {
            background: linear-gradient(135deg, #1565C0, #1976D2);
            border-color: #1976D2;
            color: white;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
        }
        .quarter-selector-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .quarter-compare-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: transparent;
            border: 2px solid #1976D2;
            color: #42A5F5;
            padding: 0.6rem 1.25rem;
            border-radius: 10px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        .quarter-compare-btn:hover {
            background: rgba(25, 118, 210, 0.1);
        }
        .quarter-compare-btn.active {
            background: linear-gradient(135deg, #1565C0, #1976D2);
            border-color: #1976D2;
            color: white;
        }
        .selected-quarters-badge {
            background: linear-gradient(135deg, var(--polaris-gold), #FFD700);
            color: var(--bg-dark);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
        }
        
        .active-members-btn {
            display: flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, var(--polaris-gold), #FFA000);
            color: var(--bg-dark); padding: 0.6rem 1.25rem;
            border-radius: 25px; text-decoration: none;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem; font-weight: 700;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(212,175,55,0.3);
        }
        .active-members-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212,175,55,0.5);
        }
        .report-btn {
            display: flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, #2E7D32, #4CAF50);
            color: white; padding: 0.6rem 1.25rem;
            border: none; border-radius: 25px; cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem; font-weight: 700;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(46,125,50,0.3);
        }
        .report-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(46,125,50,0.5);
        }
        .reports-btn {
            display: flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, #B8860B, #D4AF37);
            color: white; padding: 0.6rem 1.25rem;
            border: none; border-radius: 25px; cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem; font-weight: 700;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(123,31,162,0.3);
        }
        .reports-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(123,31,162,0.5);
        }
        .email-center-btn {
            display: flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, #d4a843, #b8860b);
            color: #1e3a5f; padding: 0.6rem 1.25rem;
            border: none; border-radius: 25px; cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem; font-weight: 700;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(212,168,67,0.3);
        }
        .email-center-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212,168,67,0.5);
        }
        
        /* Unified Header Action Buttons */
        .header-action-btn {
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            background: linear-gradient(135deg, #d4a843, #b8860b);
            color: #1e3a5f; padding: 0.6rem 1rem;
            border: none; border-radius: 25px; cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.8rem; font-weight: 700;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(212,168,67,0.3);
            min-width: 120px; white-space: nowrap;
        }
        .header-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212,168,67,0.5);
        }
        
        /* Email Center Modal - Modal Size (not fullscreen) */
        .email-center-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex;
            align-items: center; justify-content: center; z-index: 9999;
            backdrop-filter: blur(5px);
        }
        .email-center-modal.hidden { display: none; }
        .email-center-box {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 20px; width: 95%; max-width: 1200px; max-height: 90vh;
            overflow: hidden; position: relative;
            display: flex; flex-direction: column;
        }
        .email-center-header {
            background: linear-gradient(135deg, #1565C0, #1976D2);
            padding: 1.2rem 2rem; display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }
        .email-center-header h2 { color: white; font-size: 1.5rem; margin: 0; }
        .email-center-close {
            background: rgba(255,255,255,0.2); border: none; color: white;
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
            font-size: 1.3rem; transition: all 0.3s;
        }
        .email-center-close:hover { background: rgba(255,255,255,0.3); }
        .email-center-content {
            padding: 1.5rem 2rem; flex: 1; overflow-y: auto; max-height: calc(90vh - 80px);
        }
        .email-tabs {
            display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;
        }
        .email-tab {
            padding: 0.6rem 1.2rem; background: var(--bg-dark); border: 1px solid var(--border-color);
            border-radius: 20px; color: var(--text-secondary); cursor: pointer;
            font-size: 0.85rem; transition: all 0.3s;
        }
        .email-tab:hover { background: var(--border-color); }
        .email-tab.active {
            background: linear-gradient(135deg, #1565C0, #1976D2);
            color: white; border-color: transparent;
        }
        .email-form-group {
            margin-bottom: 1.25rem;
        }
        .email-form-group label {
            display: block; color: var(--text-secondary); margin-bottom: 0.5rem;
            font-size: 0.9rem; font-weight: 600;
        }
        .email-select, .email-input, .email-textarea {
            width: 100%; padding: 0.8rem 1rem; background: var(--bg-dark);
            border: 1px solid var(--border-color); border-radius: 10px;
            color: var(--text-primary); font-family: inherit; font-size: 0.95rem;
        }
        .email-select:focus, .email-input:focus, .email-textarea:focus {
            outline: none; border-color: #1976D2;
        }
        .email-textarea { min-height: 150px; resize: vertical; }
        .email-recipients-box {
            background: var(--bg-dark); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 1rem; max-height: 200px; overflow-y: auto;
        }
        .email-recipient-item {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem;
            border-radius: 8px; margin-bottom: 0.25rem; transition: background 0.2s;
        }
        .email-recipient-item:hover { background: rgba(255,255,255,0.05); }
        .email-recipient-item input[type="checkbox"] {
            width: 18px; height: 18px; cursor: pointer;
        }
        .email-recipient-info { flex: 1; }
        .email-recipient-name { color: var(--text-primary); font-weight: 500; }
        .email-recipient-email { color: var(--text-muted); font-size: 0.8rem; }
        .email-recipient-role {
            font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 10px;
            background: var(--border-color); color: var(--text-secondary);
        }
        .email-actions {
            display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap;
        }
        .email-action-btn {
            padding: 0.4rem 0.8rem; background: var(--border-color); border: none;
            border-radius: 15px; color: var(--text-secondary); cursor: pointer;
            font-size: 0.8rem; transition: all 0.2s;
        }
        .email-action-btn:hover { background: #1976D2; color: white; }
        .email-preview-box {
            background: #fff; border-radius: 10px; padding: 1.5rem;
            color: #333; max-height: 300px; overflow-y: auto;
        }
        .email-btn-row {
            display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end;
        }
        .email-btn {
            padding: 0.8rem 2rem; border: none; border-radius: 25px;
            font-family: 'Montserrat', sans-serif; font-weight: 700;
            cursor: pointer; transition: all 0.3s;
        }
        .email-btn-preview {
            background: var(--border-color); color: var(--text-primary);
        }
        .email-btn-preview:hover { background: #3d5a80; }
        .email-btn-send {
            background: linear-gradient(135deg, #1565C0, #1976D2); color: white;
        }
        .email-btn-send:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(21,101,192,0.4); }
        .email-btn-send:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .email-status {
            padding: 1rem; border-radius: 10px; margin-top: 1rem; text-align: center;
        }
        .email-status.success { background: rgba(76,175,80,0.2); color: #4CAF50; }
        .email-status.error { background: rgba(231,76,60,0.2); color: #e74c3c; }
        .template-card {
            background: var(--bg-dark); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 1rem; margin-bottom: 0.75rem;
            cursor: pointer; transition: all 0.2s;
        }
        .template-card:hover { border-color: #1976D2; transform: translateX(5px); }
        .template-card.selected { border-color: #1976D2; background: rgba(25,118,210,0.1); }
        .template-card-title { color: var(--text-primary); font-weight: 600; margin-bottom: 0.25rem; }
        .template-card-category {
            font-size: 0.75rem; color: var(--text-muted);
            background: var(--border-color); padding: 0.2rem 0.5rem;
            border-radius: 10px; display: inline-block;
        }
        
        /* ═══════════════════════════════════════════════════════════════════════════
           CONTRACT CENTER - FULL SCREEN REDESIGN
           ═══════════════════════════════════════════════════════════════════════════ */
        
        /* Contract Center Modal - FULL SCREEN */
        .contract-center-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, #0a1628 0%, #1e3a5f 50%, #0d2137 100%);
            display: flex; align-items: stretch; justify-content: stretch; 
            z-index: 9999; padding: 0; margin: 0; overflow: hidden; 
        }
        .contract-center-modal.hidden { display: none; }
        .contract-center-modal * { scrollbar-width: thin; scrollbar-color: var(--polaris-gold) rgba(255,255,255,0.1); }
        .contract-center-modal *::-webkit-scrollbar { width: 6px; height: 6px; }
        .contract-center-modal *::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .contract-center-modal *::-webkit-scrollbar-thumb { background: var(--polaris-gold); border-radius: 3px; }
        
        .contract-center-box { 
            background: transparent;
            width: 100%; height: 100%; max-width: 100%; max-height: 100%; 
            overflow: hidden; position: relative; display: flex; flex-direction: column; 
        }
        
        /* Header */
        .contract-center-header { 
            background: linear-gradient(135deg, rgba(30,58,95,0.95), rgba(10,22,40,0.98));
            padding: 1rem 2rem; 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid rgba(212,175,55,0.3);
            backdrop-filter: blur(10px);
        }
        .contract-center-header h2 { color: white; font-size: 1.4rem; margin: 0; font-family: 'Montserrat', sans-serif; }
        .contract-center-header h2 span { color: var(--polaris-gold); }
        .contract-center-close { 
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; width: 36px; height: 36px; border-radius: 8px; 
            cursor: pointer; font-size: 1.2rem; transition: all 0.3s; 
        }
        .contract-center-close:hover { background: rgba(231,76,60,0.5); border-color: #e74c3c; }
        
        /* Main Content Area */
        .contract-center-content { 
            padding: 1.5rem 2rem; flex: 1; overflow-y: auto; overflow-x: hidden;
            background: transparent;
        }
        
        /* KPI Stats Grid - 6 columns */
        .contract-kpi-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1.25rem;
            margin-bottom: 2rem;
        }
        .contract-kpi-card {
            background: linear-gradient(145deg, rgba(30,58,95,0.6), rgba(10,22,40,0.8));
            border: 1px solid rgba(212,175,55,0.2);
            border-radius: 20px;
            padding: 1.75rem 1.25rem;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .contract-kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, transparent, var(--polaris-gold), transparent);
        }
        .contract-kpi-card:hover {
            transform: translateY(-5px);
            border-color: var(--polaris-gold);
            box-shadow: 0 15px 40px rgba(212,175,55,0.25);
        }
        .contract-kpi-card.warning::before { background: linear-gradient(90deg, transparent, #f39c12, transparent); }
        .contract-kpi-card.success::before { background: linear-gradient(90deg, transparent, #27ae60, transparent); }
        .contract-kpi-card.danger::before { background: linear-gradient(90deg, transparent, #e74c3c, transparent); }
        .contract-kpi-card.info::before { background: linear-gradient(90deg, transparent, #3498db, transparent); }
        .contract-kpi-icon { font-size: 2.25rem; margin-bottom: 0.75rem; }
        .contract-kpi-value { 
            font-family: 'Montserrat', sans-serif;
            font-size: 3rem; font-weight: 800; 
            color: var(--polaris-gold); 
            line-height: 1.1;
            text-shadow: 0 0 30px rgba(212,175,55,0.4);
        }
        .contract-kpi-label { 
            font-size: 0.95rem; color: rgba(255,255,255,0.7); 
            margin-top: 0.6rem; text-transform: uppercase; letter-spacing: 1.5px;
            font-weight: 600;
        }
        .contract-kpi-trend {
            font-size: 0.9rem;
            padding: 0.35rem 0.75rem;
            border-radius: 12px;
            margin-top: 0.6rem;
            display: inline-block;
            font-weight: 600;
        }
        .contract-kpi-trend.up { background: rgba(39,174,96,0.25); color: #27ae60; }
        .contract-kpi-trend.down { background: rgba(231,76,60,0.25); color: #e74c3c; }
        
        /* Tabs Navigation */
        .contract-tabs-nav {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            background: rgba(0,0,0,0.2);
            padding: 0.75rem;
            border-radius: 18px;
            flex-wrap: wrap;
        }
        .contract-tab-btn {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            border-radius: 14px;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }
        .contract-tab-btn:hover { 
            background: rgba(255,255,255,0.1); 
            color: white;
        }
        .contract-tab-btn.active { 
            background: linear-gradient(135deg, var(--polaris-gold), #f5d76e);
            color: var(--polaris-navy);
        }
        .contract-tab-btn .badge {
            background: rgba(231,76,60,0.8);
            color: white;
            padding: 0.25rem 0.7rem;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 700;
        }
        .contract-tab-btn.active .badge {
            background: var(--polaris-navy);
            color: var(--polaris-gold);
        }
        
        /* Filter Bar */
        .contract-filter-bar { 
            display: flex; gap: 1.25rem; margin-bottom: 2rem; flex-wrap: wrap; align-items: flex-end;
            background: rgba(0,0,0,0.2);
            padding: 1.5rem;
            border-radius: 16px;
        }
        .contract-filter-group { flex: 1; min-width: 170px; }
        .contract-filter-group label { 
            display: block; font-size: 0.9rem; color: rgba(255,255,255,0.6); 
            margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 1px;
            font-weight: 600;
        }
        .contract-filter-group select, 
        .contract-filter-group input { 
            width: 100%; padding: 0.9rem 1.25rem; 
            background: rgba(30,58,95,0.5); 
            border: 1px solid rgba(212,175,55,0.2); 
            border-radius: 10px; color: white; font-size: 1.05rem;
            transition: all 0.3s;
        }
        .contract-filter-group select:focus,
        .contract-filter-group input:focus {
            outline: none;
            border-color: var(--polaris-gold);
            box-shadow: 0 0 15px rgba(212,175,55,0.2);
        }
        .contract-filter-btn {
            padding: 0.9rem 1.75rem;
            background: linear-gradient(135deg, var(--polaris-gold), #f5d76e);
            color: var(--polaris-navy);
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .contract-filter-btn:hover { transform: scale(1.05); }
        .contract-filter-btn.clear {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        /* Table Wrapper */
        .contract-table-wrapper { 
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(212,175,55,0.15); 
            border-radius: 20px; 
            overflow: hidden;
        }
        
        /* Table */
        .contract-table { width: 100%; border-collapse: collapse; min-width: 900px; }
        .contract-table th { 
            background: rgba(30,58,95,0.8);
            padding: 1.25rem 1.5rem; text-align: left; 
            font-size: 0.95rem; color: var(--polaris-gold); 
            font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px;
            border-bottom: 2px solid rgba(212,175,55,0.3);
        }
        .contract-table td { 
            padding: 1rem 1.25rem; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            font-size: 0.9rem;
            color: rgba(255,255,255,0.9);
        }
        .contract-table tbody tr { 
            transition: all 0.3s;
            cursor: pointer;
        }
        .contract-table tbody tr:hover { 
            background: rgba(212,175,55,0.1);
        }
        .contract-table tbody tr:hover td {
            color: white;
        }
        
        /* Status Badges */
        .contract-status { 
            display: inline-flex; align-items: center; gap: 0.3rem;
            padding: 0.4rem 0.9rem; border-radius: 20px; 
            font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .contract-status.draft { background: rgba(100,100,100,0.3); color: #aaa; }
        .contract-status.sent { background: rgba(52,152,219,0.25); color: #5dade2; }
        .contract-status.pending { background: rgba(243,156,18,0.25); color: #f5b041; }
        .contract-status.signed { background: rgba(46,204,113,0.25); color: #58d68d; }
        .contract-status.active { background: rgba(39,174,96,0.3); color: #2ecc71; border: 1px solid rgba(39,174,96,0.5); }
        .contract-status.expired { background: rgba(231,76,60,0.25); color: #ec7063; }
        .contract-status.expiring { background: rgba(243,156,18,0.3); color: #f39c12; animation: pulse 2s infinite; }
        .contract-status.no-contract { background: #e74c3c; color: white; border: 1px solid #c0392b; font-weight: 600; }
        .contract-status.completed { background: rgba(46,204,113,0.25); color: #58d68d; }
        
        /* Type Badges */
        .contract-type { 
            display: inline-block; padding: 0.3rem 0.6rem; 
            border-radius: 6px; font-size: 0.7rem; font-weight: 700;
            letter-spacing: 0.5px;
        }
        .contract-type.ASA { background: linear-gradient(135deg, #1a365d, #2c5282); color: white; }
        .contract-type.NDA { background: linear-gradient(135deg, #7c3aed, #a855f7); color: white; }
        .contract-type.DPA { background: linear-gradient(135deg, #0891b2, #22d3ee); color: white; }
        .contract-type.MSA { background: linear-gradient(135deg, #059669, #34d399); color: white; }
        
        /* Action Buttons */
        .contract-actions {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }
        .contract-action-btn { 
            padding: 0.4rem 0.7rem; border: none; border-radius: 6px; 
            cursor: pointer; font-size: 0.75rem; transition: all 0.2s; 
            text-decoration: none; display: inline-flex; align-items: center; gap: 0.3rem;
            font-weight: 600;
        }
        .contract-action-btn.view { background: rgba(52,152,219,0.2); color: #3498db; }
        .contract-action-btn.folder { background: rgba(212,175,55,0.2); color: var(--polaris-gold); }
        .contract-action-btn.download { background: rgba(46,204,113,0.2); color: #2ecc71; }
        .contract-action-btn.edit { background: rgba(243,156,18,0.2); color: #f39c12; }
        .contract-action-btn:hover { transform: scale(1.1); filter: brightness(1.2); }
        
        /* Client Info in Table */
        .contract-client-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .contract-client-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--polaris-gold), #f5d76e);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--polaris-navy);
            font-size: 0.9rem;
        }
        .contract-client-name {
            font-weight: 600;
            color: white;
        }
        .contract-client-company {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.5);
        }
        
        /* Offers Center Button */
        .offers-center-btn {
            display: flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, #d4a843, #b8860b);
            color: #1e3a5f; padding: 0.6rem 1.25rem;
            border: none; border-radius: 25px; cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem; font-weight: 700;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(212,168,67,0.3);
        }
        .offers-center-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(212,168,67,0.5); }
        
        /* Offers Center Modal */
        .offers-center-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; align-items: stretch; justify-content: stretch; z-index: 9999; padding: 0; margin: 0; overflow: hidden; }
        .offers-center-modal.hidden { display: none; }
        .offers-center-modal * { scrollbar-width: none; -ms-overflow-style: none; }
        .offers-center-modal *::-webkit-scrollbar { display: none; }
        .offers-center-box { background: var(--bg-card); border: none; border-radius: 0; width: 100%; height: 100%; max-width: 100%; max-height: 100%; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        .offers-center-header { background: linear-gradient(135deg, #1E3A5F, #2d5a87); padding: 1.25rem 2rem; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .offers-center-header h2 { color: white; font-size: 1.3rem; margin: 0; }
        .offers-center-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.1rem; transition: all 0.3s; }
        .offers-center-close:hover { background: rgba(255,255,255,0.3); }
        .offers-center-content { padding: 1.5rem 2rem; flex: 1; overflow-y: auto; overflow-x: hidden; scrollbar-width: none; -ms-overflow-style: none; }
        .offers-center-content::-webkit-scrollbar { display: none; }
        .offers-stats { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.75rem; margin-bottom: 1rem; }
        .offer-stat-card { background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 10px; padding: 1.25rem 0.75rem; text-align: center; }
        .offer-stat-card.draft { border-left: 3px solid #6c757d; }
        .offer-stat-card.sent { border-left: 3px solid #3498db; }
        .offer-stat-card.accepted { border-left: 3px solid #27ae60; }
        .offer-stat-card.rejected { border-left: 3px solid #e74c3c; }
        .offer-stat-card.total { border-left: 3px solid var(--polaris-gold); }
        .offer-stat-value { font-size: 1.75rem; font-weight: 700; color: var(--text-primary); line-height: 1.2; }
        .offer-stat-label { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; }
        .offers-tabs { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .offers-tab { padding: 0.75rem 1.5rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 20px; color: var(--text-secondary); cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
        .offers-tab:hover { background: var(--border-color); }
        .offers-tab.active { background: linear-gradient(135deg, #1E3A5F, #2d5a87); color: white; border-color: transparent; }
        
        /* Program Cards for Offer Creator */
        .program-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .program-card { background: var(--bg-dark); border: 2px solid var(--border-color); border-radius: 12px; padding: 1.25rem; transition: all 0.3s; }
        .program-card:hover { border-color: var(--polaris-gold); }
        .program-card.selected { border-color: var(--polaris-gold); background: rgba(212,175,55,0.1); }
        .program-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .program-card-name { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); }
        .program-card-limits { font-size: 0.8rem; color: var(--polaris-gold); background: rgba(212,175,55,0.2); padding: 0.25rem 0.5rem; border-radius: 10px; }
        .program-card-details { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem; }
        .program-card-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        .program-input-group { display: flex; flex-direction: column; gap: 0.25rem; }
        .program-input-group label { font-size: 0.75rem; color: var(--text-muted); }
        .program-input-group input { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem; color: var(--text-primary); font-size: 0.9rem; width: 100%; }
        .program-input-group input:focus { outline: none; border-color: var(--polaris-gold); }
        
        /* Cost Summary Box */
        .cost-summary-box { background: linear-gradient(135deg, #1E3A5F, #0d2137); border: 2px solid var(--polaris-gold); border-radius: 16px; padding: 1.5rem; margin-top: 1.5rem; }
        .cost-summary-title { font-size: 1.1rem; font-weight: 700; color: var(--polaris-gold); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .cost-summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem; }
        .cost-summary-item { text-align: center; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 10px; }
        .cost-summary-item-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; }
        .cost-summary-item-value { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); }
        .cost-summary-total { display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 2px solid rgba(212,175,55,0.3); }
        .cost-summary-total-label { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); }
        .cost-summary-total-value { font-size: 2rem; font-weight: 800; color: var(--polaris-gold); }
        
        /* Offers Table */
        .offers-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .offers-table th { background: rgba(0,0,0,0.3); padding: 1rem; text-align: left; font-size: 0.85rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
        .offers-table td { padding: 1rem; border-top: 1px solid var(--border-color); }
        .offers-table tbody tr:hover { background: rgba(255,255,255,0.05); }
        .offer-status { padding: 0.3rem 0.75rem; border-radius: 15px; font-size: 0.8rem; font-weight: 600; }
        .offer-status.draft { background: rgba(108,117,125,0.2); color: #adb5bd; }
        .offer-status.sent { background: rgba(52,152,219,0.2); color: #3498db; }
        .offer-status.accepted { background: rgba(39,174,96,0.2); color: #27ae60; }
        .offer-status.rejected { background: rgba(231,76,60,0.2); color: #e74c3c; }
        .offer-status.expired { background: rgba(243,156,18,0.2); color: #f39c12; }
        .offer-status.pending_signature { background: #9b59b6; color: white; }
        .offer-status.signed { background: rgba(26,188,156,0.2); color: #1abc9c; }
        .offer-status.converted { background: rgba(212,168,67,0.2); color: #d4a843; }
        
        .contract-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
        .contract-stat-card { background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; text-align: center; }
        .contract-stat-card.warning { border-color: #f39c12; }
        .contract-stat-value { font-size: 2.5rem; font-weight: 700; color: var(--polaris-gold); }
        .contract-stat-label { font-size: 0.9rem; color: var(--text-muted); margin-top: 0.5rem; }
        .contract-tabs { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .contract-tab { padding: 0.75rem 1.5rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 20px; color: var(--text-secondary); cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
        .contract-tab:hover { background: var(--border-color); }
        .contract-tab.active { background: linear-gradient(135deg, #1a365d, #2c5282); color: white; border-color: transparent; }
        .contract-table-wrapper { 
            background: var(--bg-dark); 
            border: 1px solid var(--border-color); 
            border-radius: 12px; 
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            flex: 1; 
            min-height: 300px; 
        }
        .contract-table { width: 100%; border-collapse: collapse; min-width: 700px; }
        .contract-table th { background: rgba(0,0,0,0.3); padding: 1rem 1.25rem; text-align: left; font-size: 0.85rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .contract-table td { padding: 1rem 1.25rem; border-top: 1px solid var(--border-color); font-size: 0.95rem; }
        .contract-table tbody tr:hover { background: rgba(255,255,255,0.05); }
        .contract-status { display: inline-block; padding: 0.35rem 0.9rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: capitalize; }
        .contract-status.draft { background: rgba(100,100,100,0.3); color: #aaa; }
        .contract-status.sent { background: rgba(33,150,243,0.2); color: #2196F3; }
        .contract-status.negotiating { background: rgba(255,152,0,0.2); color: #FF9800; }
        .contract-status.signed { background: rgba(76,175,80,0.2); color: #4CAF50; }
        .contract-status.pending { background: rgba(255,152,0,0.2); color: #FF9800; }
        .contract-status.active { background: rgba(76,175,80,0.3); color: #81C784; }
        .contract-status.expired { background: rgba(244,67,54,0.2); color: #F44336; }
        .contract-type { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        .contract-type.ASA { background: #1a365d; color: white; }
        .contract-type.NDA { background: #7c3aed; color: white; }
        .contract-type.DPA { background: #0891b2; color: white; }
        .contract-action-btn { padding: 0.3rem 0.6rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; transition: all 0.2s; margin-right: 0.25rem; text-decoration: none; display: inline-block; }
        .contract-action-btn.view { background: rgba(33,150,243,0.2); color: #2196F3; }
        .contract-action-btn.edit { background: rgba(255,152,0,0.2); color: #FF9800; }
        .contract-action-btn.download { background: rgba(76,175,80,0.2); color: #4CAF50; }
        .contract-action-btn:hover { transform: scale(1.05); }
        .contract-form-group { margin-bottom: 1.25rem; }
        .contract-form-group label { display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 600; }
        .contract-select, .contract-input { width: 100%; padding: 0.8rem 1rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem; }
        .contract-select:focus, .contract-input:focus { outline: none; border-color: #2c5282; }
        .contract-checkbox-group { display: flex; gap: 1.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
        .contract-checkbox-label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: var(--text-primary); }
        .contract-checkbox-label input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .financial-terms-box { background: rgba(26,54,93,0.3); border: 1px solid #2c5282; border-radius: 12px; padding: 1.25rem; margin-top: 1rem; }
        .financial-terms-title { color: #63b3ed; font-weight: 600; margin-bottom: 1rem; }
        .financial-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .financial-grid .contract-form-group { margin-bottom: 0; }
        .contract-btn-row { display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end; }
        .contract-btn { padding: 0.8rem 2rem; border: none; border-radius: 25px; font-family: 'Montserrat', sans-serif; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .contract-btn-secondary { background: var(--border-color); color: var(--text-primary); }
        .contract-btn-secondary:hover { background: #3d5a80; }
        .contract-btn-primary { background: linear-gradient(135deg, #1a365d, #2c5282); color: white; }
        .contract-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(26,54,93,0.4); }
        .contract-filter-bar { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: flex-end; }
        .contract-filter-group { flex: 1; min-width: 150px; }
        .contract-filter-group label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem; }
        .contract-filter-group select, .contract-filter-group input { width: 100%; padding: 0.5rem 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.85rem; }
        .contract-center-btn { background: linear-gradient(135deg, #d4a843, #b8860b); border: none; color: #1e3a5f; padding: 0.6rem 1.25rem; border-radius: 25px; cursor: pointer; font-weight: 700; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s; font-family: 'Montserrat', sans-serif; font-size: 0.85rem; box-shadow: 0 4px 15px rgba(212,168,67,0.3); }
        
        /* ═══════════════════════════════════════════════════════════════════════════
           CLIENT FOLDER VIEW - FULL ANALYTICS DASHBOARD
           ═══════════════════════════════════════════════════════════════════════════ */
        
        .client-folder-view {
            display: none;
            animation: fadeInUp 0.5s ease;
            max-width: 100%;
            overflow-x: hidden;
            padding: 1rem;
        }
        .client-folder-view.active { display: block; }
        
        /* Client Header - LARGE & IMPRESSIVE */
        .client-folder-header {
            background: linear-gradient(135deg, rgba(30,58,95,0.95), rgba(10,22,40,0.98));
            border: 2px solid rgba(212,175,55,0.4);
            border-radius: 20px;
            padding: 2rem 2.5rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1.5rem;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }
        .client-folder-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .client-folder-avatar {
            width: 90px;
            height: 90px;
            background: linear-gradient(135deg, var(--polaris-gold), #f5d76e);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--polaris-navy);
            box-shadow: 0 12px 30px rgba(212,175,55,0.5);
            flex-shrink: 0;
        }
        .client-folder-details h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2rem;
            color: white;
            margin: 0 0 0.5rem 0;
        }
        .client-folder-details h2 span { color: var(--polaris-gold); font-weight: 400; }
        .client-folder-meta {
            display: flex;
            gap: 2rem;
            color: rgba(255,255,255,0.8);
            font-size: 1rem;
            flex-wrap: wrap;
        }
        .client-folder-meta span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .client-folder-meta strong {
            color: var(--polaris-gold);
            font-size: 1.2rem;
        }
        .client-folder-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .client-folder-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }
        .client-folder-btn.primary {
            background: linear-gradient(135deg, var(--polaris-gold), #f5d76e);
            color: var(--polaris-navy);
        }
        .client-folder-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
        }
        .client-folder-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,0.3); }
        
        /* Quick Stats Row - LARGE IMPRESSIVE CARDS */
        .client-quick-stats {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .client-quick-stat {
            background: linear-gradient(145deg, rgba(30,58,95,0.6), rgba(10,22,40,0.8));
            border: 2px solid rgba(212,175,55,0.3);
            border-radius: 20px;
            padding: 2rem 1.5rem;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .client-quick-stat::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--polaris-gold), #f5d76e);
        }
        .client-quick-stat:hover {
            border-color: var(--polaris-gold);
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(212,175,55,0.25);
        }
        .client-quick-stat-icon { font-size: 2.5rem; margin-bottom: 1rem; }
        .client-quick-stat-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.8rem;
            font-weight: 800;
            color: var(--polaris-gold);
            line-height: 1.1;
            text-shadow: 0 2px 10px rgba(212,175,55,0.3);
        }
        .client-quick-stat-label {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.8);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-top: 0.75rem;
            font-weight: 700;
        }
        
        /* Analytics Sections - LARGER */
        .client-analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .client-analytics-section {
            background: linear-gradient(145deg, rgba(30,58,95,0.5), rgba(10,22,40,0.7));
            border: 2px solid rgba(212,175,55,0.25);
            border-radius: 20px;
            padding: 1.5rem;
            transition: all 0.3s;
            overflow: hidden;
        }
        .client-analytics-section:hover {
            border-color: rgba(212,175,55,0.5);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .client-analytics-section.full-width {
            grid-column: span 2;
        }
        .client-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid rgba(212,175,55,0.3);
        }
        .client-section-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--polaris-gold);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .client-section-action {
            padding: 0.6rem 1.2rem;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: rgba(255,255,255,0.85);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        .client-section-action:hover {
            background: var(--polaris-gold);
            color: var(--polaris-navy);
        }
        
        /* Mini KPI Cards inside sections - LARGER */
        .client-mini-kpis {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }
        .client-mini-kpi {
            background: rgba(0,0,0,0.35);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .client-mini-kpi-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
        }
        .client-mini-kpi-label {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.7);
            margin-top: 0.4rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .client-mini-kpi.highlight .client-mini-kpi-value {
            color: var(--polaris-gold);
        }
        
        /* Comparison Bars - LARGER */
        .client-comparison-bars {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }
        .client-comparison-row {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .client-comparison-label {
            width: 100px;
            font-size: 1rem;
            color: rgba(255,255,255,0.9);
            font-weight: 700;
        }
        .client-comparison-bar-bg {
            flex: 1;
            height: 40px;
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        .client-comparison-bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 1s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 1rem;
            font-size: 1rem;
            font-weight: 800;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        .client-comparison-bar-fill.inpatient { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        .client-comparison-bar-fill.outpatient { background: linear-gradient(90deg, #27ae60, #1e8449); }
        .client-comparison-bar-fill.principal { background: linear-gradient(90deg, #3498db, #2980b9); }
        .client-comparison-bar-fill.dependent { background: linear-gradient(90deg, #9b59b6, #8e44ad); }
        .client-comparison-value {
            width: 100px;
            text-align: right;
            font-weight: 800;
            color: var(--polaris-gold);
            font-size: 1.1rem;
        }
        
        /* Data Table inside Client Folder - LARGER */
        .client-data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .client-data-table th {
            background: rgba(30,58,95,0.7);
            padding: 1rem 1.25rem;
            text-align: left;
            font-size: 0.9rem;
            color: var(--polaris-gold);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            border-bottom: 2px solid rgba(212,175,55,0.4);
            font-weight: 700;
        }
        .client-data-table td {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 1rem;
            color: rgba(255,255,255,0.9);
        }
        .client-data-table tbody tr:hover {
            background: rgba(212,175,55,0.15);
        }
        
        /* Hospital/Provider Cards - LARGER */
        .client-provider-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        .client-provider-card {
            background: rgba(0,0,0,0.35);
            border-radius: 12px;
            padding: 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
        }
        .client-provider-card:hover {
            border-color: rgba(212,175,55,0.4);
            background: rgba(0,0,0,0.4);
        }
        .client-provider-info h4 {
            font-size: 1.1rem;
            color: white;
            margin: 0 0 0.4rem 0;
            font-weight: 700;
        }
        .client-provider-info span {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
        }
        .client-provider-stats {
            text-align: right;
        }
        .client-provider-amount {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            color: var(--polaris-gold);
            font-size: 1.4rem;
        }
        .client-provider-claims {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.7);
            margin-top: 0.25rem;
        }
        
        /* Financial Breakdown - LARGER IMPRESSIVE */
        .client-financial-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }
        .client-financial-item {
            background: rgba(0,0,0,0.35);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            border-left: 5px solid var(--polaris-gold);
            transition: all 0.3s;
        }
        .client-financial-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .client-financial-item.green { border-left-color: #27ae60; }
        .client-financial-item.blue { border-left-color: #3498db; }
        .client-financial-item.orange { border-left-color: #f39c12; }
        .client-financial-item.red { border-left-color: #e74c3c; }
        .client-financial-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            color: white;
        }
        .client-financial-label {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.75);
            margin-top: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        /* Year over Year - LARGER */
        .client-yoy-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        .client-yoy-item {
            text-align: center;
            padding: 1.25rem;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .client-yoy-year {
            font-size: 0.95rem;
            color: rgba(255,255,255,0.8);
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        .client-yoy-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            color: white;
        }
        .client-yoy-change {
            font-size: 0.85rem;
            padding: 0.3rem 0.75rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            display: inline-block;
            font-weight: 700;
        }
        .client-yoy-change.up { background: rgba(39,174,96,0.35); color: #2ecc71; }
        .client-yoy-change.down { background: rgba(231,76,60,0.35); color: #e74c3c; }
        
        /* Utilization Donut placeholder */
        .client-utilization-chart {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 150px;
            background: rgba(0,0,0,0.15);
            border-radius: 12px;
            color: rgba(255,255,255,0.6);
            font-size: 1rem;
        }
        
        /* Contracts List in Client Folder - LARGER */
        .client-contracts-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .client-contract-item {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .client-contract-item:hover {
            background: rgba(212,175,55,0.15);
            border-color: rgba(212,175,55,0.3);
        }
        .client-contract-info {
            display: flex;
            align-items: center;
            gap: 1.25rem;
        }
        .client-contract-type {
            padding: 0.6rem 1rem;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 700;
        }
        .client-contract-details h4 {
            font-size: 1.15rem;
            color: white;
            margin: 0 0 0.35rem 0;
        }
        .client-contract-details span {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.6);
        }
        
        /* Back Button - LARGER */
        .client-folder-back {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.9rem 1.5rem;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.25);
            border-radius: 12px;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
            margin-bottom: 1rem;
        }
        .client-folder-back:hover {
            background: var(--polaris-gold);
            color: var(--polaris-navy);
            border-color: var(--polaris-gold);
        }
        
        /* Geographic Distribution */
        .client-geo-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .client-geo-item {
            display: flex;
            align-items: center;
            gap: 2rem;
            padding: 1.5rem 2rem;
            background: rgba(0,0,0,0.25);
            border-radius: 18px;
        }
        .client-geo-flag { font-size: 3.5rem; }
        .client-geo-info { flex: 1; }
        .client-geo-country {
            font-size: 1.5rem;
            color: rgba(255,255,255,0.95);
            margin-bottom: 0.75rem;
            font-weight: 700;
        }
        .client-geo-bar {
            height: 16px;
            background: rgba(255,255,255,0.12);
            border-radius: 8px;
            overflow: hidden;
        }
        .client-geo-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--polaris-gold), #f5d76e);
            border-radius: 8px;
            transition: width 1s ease;
        }
        .client-geo-value {
            font-weight: 800;
            color: var(--polaris-gold);
            min-width: 100px;
            text-align: right;
            font-size: 2.4rem;
        }
        
        /* Fees & Charges */
        .client-fees-breakdown {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .client-fee-row {
            display: flex;
            justify-content: space-between;
            padding: 1.75rem 2rem;
            background: rgba(0,0,0,0.25);
            border-radius: 18px;
        }
        .client-fee-row.total {
            background: rgba(212,175,55,0.25);
            border: 3px solid rgba(212,175,55,0.5);
            margin-top: 1rem;
        }
        .client-fee-label {
            color: rgba(255,255,255,0.85);
            font-size: 1.4rem;
            font-weight: 600;
        }
        .client-fee-value {
            font-weight: 800;
            font-size: 1.8rem;
        }
        .client-fee-row.total .client-fee-label,
        .client-fee-row.total .client-fee-value {
            font-weight: 800;
            font-size: 1.6rem;
        }
        
        /* Plan Performance Cards */
        .client-plan-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
        }
        .client-plan-card {
            background: rgba(0,0,0,0.3);
            border-radius: 24px;
            padding: 2.5rem;
            border-left: 6px solid var(--polaris-gold);
        }
        .client-plan-name {
            font-weight: 800;
            color: white;
            font-size: 1.7rem;
            margin-bottom: 0.75rem;
        }
        .client-plan-members {
            font-size: 1.25rem;
            color: rgba(255,255,255,0.65);
            margin-bottom: 1.5rem;
        }
        .client-plan-stats {
            display: flex;
            gap: 2rem;
        }
        .client-plan-stat {
            display: flex;
            flex-direction: column;
        }
        .client-plan-stat .label {
            font-size: 1rem;
            color: rgba(255,255,255,0.65);
            text-transform: uppercase;
            font-weight: 600;
        }
        .client-plan-stat .value {
            font-weight: 800;
            color: var(--polaris-gold);
            font-size: 2rem;
        }
        
        /* Utilization Metrics */
        .client-utilization-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
        }
        .client-util-metric {
            text-align: center;
        }
        .client-util-circle {
            width: 150px;
            height: 150px;
            margin: 0 auto 1.25rem;
            border-radius: 50%;
            background: conic-gradient(
                var(--polaris-gold) calc(var(--percent) * 1%),
                rgba(255,255,255,0.1) calc(var(--percent) * 1%)
            );
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .client-util-circle::before {
            content: '';
            position: absolute;
            width: 115px;
            height: 115px;
            background: linear-gradient(145deg, rgba(30,58,95,0.9), rgba(10,22,40,0.95));
            border-radius: 50%;
        }
        .client-util-circle span {
            position: relative;
            z-index: 1;
            font-weight: 800;
            color: var(--polaris-gold);
            font-size: 2.2rem;
        }
        .client-util-circle.success { background: conic-gradient(#27ae60 calc(var(--percent) * 1%), rgba(255,255,255,0.1) calc(var(--percent) * 1%)); }
        .client-util-circle.success span { color: #27ae60; }
        .client-util-circle.warning { background: conic-gradient(#f39c12 calc(var(--percent) * 1%), rgba(255,255,255,0.1) calc(var(--percent) * 1%)); }
        .client-util-circle.warning span { color: #f39c12; }
        .client-util-circle.danger { background: conic-gradient(#e74c3c calc(var(--percent) * 1%), rgba(255,255,255,0.1) calc(var(--percent) * 1%)); }
        .client-util-circle.danger span { color: #e74c3c; }
        .client-util-label {
            font-size: 1.25rem;
            color: rgba(255,255,255,0.75);
            font-weight: 700;
        }
        
        /* Period Comparison */
        .client-period-select {
            padding: 0.8rem 1.25rem;
            background: rgba(30,58,95,0.5);
            border: 2px solid rgba(212,175,55,0.35);
            border-radius: 12px;
            color: white;
            font-size: 1.15rem;
            font-weight: 600;
        }
        .client-period-comparison {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2rem;
        }
        .client-period-item {
            background: rgba(0,0,0,0.3);
            border-radius: 24px;
            padding: 2rem;
            text-align: center;
        }
        .client-period-metric {
            font-size: 1.2rem;
            color: rgba(255,255,255,0.65);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 1.5rem;
            font-weight: 700;
        }
        .client-period-values {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .client-period-values .period1,
        .client-period-values .period2 {
            font-weight: 800;
            color: white;
            font-size: 1.8rem;
        }
        .client-period-values .vs {
            color: rgba(255,255,255,0.45);
            font-size: 1.2rem;
        }
        .client-period-values .change {
            padding: 0.5rem 1rem;
            border-radius: 14px;
            font-size: 1.2rem;
            font-weight: 700;
        }
        .client-period-values .change.up {
            background: rgba(39,174,96,0.25);
            color: #27ae60;
        }
        .client-period-values .change.down {
            background: rgba(231,76,60,0.25);
            color: #e74c3c;
        }
        
        /* Report Summary */
        .client-report-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2rem;
        }
        .client-report-card {
            background: rgba(0,0,0,0.3);
            border-radius: 24px;
            padding: 2.5rem;
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
        }
        .client-report-card.highlight {
            background: rgba(212,175,55,0.25);
            border: 3px solid rgba(212,175,55,0.5);
        }
        .client-report-icon {
            font-size: 3.5rem;
        }
        .client-report-content {
            flex: 1;
        }
        .client-report-title {
            font-size: 1.15rem;
            color: rgba(255,255,255,0.65);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 0.75rem;
            font-weight: 700;
        }
        .client-report-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--polaris-gold);
        }
        .client-report-note {
            font-size: 1.2rem;
            color: rgba(255,255,255,0.65);
            margin-top: 0.75rem;
        }
        
        /* Responsive for new sections */
        @media (max-width: 1200px) {
            .client-plan-cards { grid-template-columns: repeat(2, 1fr); }
            .client-utilization-grid { grid-template-columns: repeat(2, 1fr); }
            .client-period-comparison { grid-template-columns: repeat(2, 1fr); }
            .client-report-summary { grid-template-columns: repeat(2, 1fr); }
            .client-quick-stat-value { font-size: 4rem; }
            .client-mini-kpi-value { font-size: 3rem; }
            .client-yoy-value { font-size: 3.5rem; }
            .client-financial-value { font-size: 2.5rem; }
        }
        @media (max-width: 768px) {
            .client-plan-cards { grid-template-columns: 1fr; }
            .client-utilization-grid { grid-template-columns: repeat(2, 1fr); }
            .client-period-comparison { grid-template-columns: 1fr; }
            .client-report-summary { grid-template-columns: 1fr; }
            .client-quick-stat-value { font-size: 3rem; }
            .client-mini-kpi-value { font-size: 2.5rem; }
            .client-quick-stats { grid-template-columns: repeat(2, 1fr); }
            .client-yoy-value { font-size: 2.5rem; }
            .client-financial-value { font-size: 2rem; }
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .client-analytics-grid { grid-template-columns: 1fr; }
            .client-analytics-section.full-width { grid-column: span 1; }
            .contract-kpi-grid { grid-template-columns: repeat(3, 1fr); }
            .client-quick-stats { grid-template-columns: repeat(3, 1fr); }
            .contract-kpi-value { font-size: 2.5rem; }
        }
        @media (max-width: 768px) {
            .contract-kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .client-quick-stats { grid-template-columns: repeat(2, 1fr); }
            .client-folder-header { flex-direction: column; gap: 1rem; text-align: center; }
            .client-folder-info { flex-direction: column; }
            .client-mini-kpis { grid-template-columns: 1fr; }
            .client-financial-grid { grid-template-columns: repeat(2, 1fr); }
            .contract-kpi-value { font-size: 2rem; }
        }
        .contract-center-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(212,168,67,0.5); }
        .contract-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .contract-details-section { background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.25rem; }
        .contract-details-section h4 { color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 1rem; }
        .contract-detail-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color); }
        .contract-detail-row:last-child { border-bottom: none; }
        .contract-detail-label { color: var(--text-muted); font-size: 0.9rem; }
        .contract-detail-value { color: var(--text-primary); font-weight: 500; }
        @media (max-width: 768px) { .contract-stats { grid-template-columns: repeat(2, 1fr); } .contract-details-grid { grid-template-columns: 1fr; } .financial-grid { grid-template-columns: 1fr; } }
        
        /* ═══════════════════════════════════════════════════════════════════
           RENEWALS DASHBOARD MODAL
           ═══════════════════════════════════════════════════════════════════ */
        .renewals-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: flex;
            align-items: stretch; justify-content: stretch;
            z-index: 9999; padding: 0; margin: 0; overflow: hidden;
        }
        .renewals-modal.hidden { display: none; }
        .renewals-modal * { scrollbar-width: none; -ms-overflow-style: none; }
        .renewals-modal *::-webkit-scrollbar { display: none; }
        
        .renewals-box {
            background: var(--bg-card); border: none; border-radius: 0;
            width: 100%; height: 100%; max-width: 100%; max-height: 100%;
            overflow: hidden; position: relative; display: flex; flex-direction: column;
        }
        
        .renewals-header {
            background: linear-gradient(135deg, #1B5E20, #2E7D32);
            padding: 0.75rem 2rem;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }
        .renewals-header h2 { color: white; font-size: 1.3rem; margin: 0; display: flex; align-items: center; gap: 0.5rem; }
        .renewals-header-actions { display: flex; gap: 0.75rem; align-items: center; }
        .renewals-close {
            background: rgba(255,255,255,0.2); border: none; color: white;
            width: 32px; height: 32px; border-radius: 50%;
            cursor: pointer; font-size: 1.1rem; transition: all 0.3s;
        }
        .renewals-close:hover { background: rgba(255,255,255,0.3); }
        
        /* Modal Dashboard Button - next to close button */
        .modal-dashboard-btn {
            background: linear-gradient(135deg, var(--polaris-gold), #f5d76e);
            color: var(--polaris-navy);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.3s;
            margin-right: 0.5rem;
        }
        .modal-dashboard-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(212,175,55,0.4);
        }
        .modal-header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .renewals-content { padding: 1.5rem 2rem; flex: 1; overflow-y: auto; overflow-x: hidden; }
        
        /* KPI Cards */
        .renewals-kpis { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .renewals-kpi {
            background: var(--bg-dark); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 1.25rem; text-align: center;
            position: relative; overflow: hidden;
        }
        .renewals-kpi::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; }
        .renewals-kpi.members::before { background: linear-gradient(90deg, #4CAF50, #8BC34A); }
        .renewals-kpi.revenue::before { background: linear-gradient(90deg, #D4AF37, #FFD700); }
        .renewals-kpi.pending::before { background: linear-gradient(90deg, #2196F3, #03A9F4); }
        .renewals-kpi.expiring::before { background: linear-gradient(90deg, #FF9800, #F44336); }
        
        .renewals-kpi-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .renewals-kpi-value { font-size: 2rem; font-weight: 800; color: var(--text-primary); }
        .renewals-kpi-label { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem; }
        .renewals-kpi-trend { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.75rem; font-weight: 600; margin-top: 0.5rem; }
        .renewals-kpi-trend.up { background: rgba(76,175,80,0.2); color: #4CAF50; }
        .renewals-kpi-trend.down { background: rgba(244,67,54,0.2); color: #F44336; }
        .renewals-kpi-trend.neutral { background: rgba(158,158,158,0.2); color: #9E9E9E; }
        
        /* ═══════════════════════════════════════════════════════════ */
        /* CEO/CFO FINANCIAL DASHBOARD - CYPRUS TAX COMPLIANCE */
        /* ═══════════════════════════════════════════════════════════ */
        
        .ceo-finance-section {
            background: linear-gradient(145deg, rgba(15,35,60,0.95), rgba(5,15,30,0.98));
            border: 2px solid rgba(212,175,55,0.3);
            border-radius: 28px;
            padding: 2.5rem;
            margin-bottom: 2.5rem;
            position: relative;
            overflow: hidden;
        }
        .ceo-finance-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #D4AF37, #FFD700, #D4AF37);
        }
        .ceo-finance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid rgba(212,175,55,0.2);
        }
        .ceo-finance-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            color: var(--polaris-gold);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .ceo-finance-title .flag { font-size: 2.5rem; }
        .ceo-finance-subtitle {
            font-size: 1rem;
            color: rgba(255,255,255,0.6);
            margin-top: 0.5rem;
        }
        .ceo-finance-period {
            background: rgba(212,175,55,0.15);
            border: 1px solid rgba(212,175,55,0.3);
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            color: var(--polaris-gold);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Financial KPI Grid */
        .ceo-kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }
        .ceo-kpi-card {
            background: linear-gradient(145deg, rgba(30,58,95,0.5), rgba(10,25,45,0.7));
            border: 2px solid rgba(212,175,55,0.2);
            border-radius: 20px;
            padding: 2rem 1.5rem;
            text-align: center;
            position: relative;
            transition: all 0.3s;
        }
        .ceo-kpi-card:hover {
            transform: translateY(-5px);
            border-color: var(--polaris-gold);
            box-shadow: 0 15px 40px rgba(212,175,55,0.2);
        }
        .ceo-kpi-card.highlight {
            background: linear-gradient(145deg, rgba(212,175,55,0.15), rgba(212,175,55,0.05));
            border-color: rgba(212,175,55,0.5);
        }
        .ceo-kpi-card.profit { border-left: 5px solid #27ae60; }
        .ceo-kpi-card.tax { border-left: 5px solid #e74c3c; }
        .ceo-kpi-card.revenue { border-left: 5px solid #3498db; }
        .ceo-kpi-card.expense { border-left: 5px solid #f39c12; }
        .ceo-kpi-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }
        .ceo-kpi-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 3rem;
            font-weight: 800;
            color: var(--polaris-gold);
            line-height: 1.1;
            margin-bottom: 0.5rem;
        }
        .ceo-kpi-card.profit .ceo-kpi-value { color: #27ae60; }
        .ceo-kpi-card.tax .ceo-kpi-value { color: #e74c3c; }
        .ceo-kpi-card.revenue .ceo-kpi-value { color: #3498db; }
        .ceo-kpi-card.expense .ceo-kpi-value { color: #f39c12; }
        .ceo-kpi-label {
            font-size: 1rem;
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        .ceo-kpi-sublabel {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.5);
            margin-top: 0.25rem;
        }
        .ceo-kpi-trend {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 700;
            margin-top: 0.75rem;
        }
        .ceo-kpi-trend.up { background: rgba(39,174,96,0.2); color: #27ae60; }
        .ceo-kpi-trend.down { background: rgba(231,76,60,0.2); color: #e74c3c; }
        
        /* Financial Sections Grid */
        .ceo-sections-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
        }
        .ceo-section-card {
            background: rgba(0,0,0,0.25);
            border: 1px solid rgba(212,175,55,0.15);
            border-radius: 20px;
            padding: 2rem;
        }
        .ceo-section-card.full-width {
            grid-column: span 3;
        }
        .ceo-section-card.half-width {
            grid-column: span 2;
        }
        .ceo-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(212,175,55,0.2);
        }
        .ceo-section-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--polaris-gold);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        /* Tax Breakdown Table */
        .ceo-tax-table {
            width: 100%;
            border-collapse: collapse;
        }
        .ceo-tax-table th {
            background: rgba(30,58,95,0.5);
            padding: 1.25rem 1.5rem;
            text-align: left;
            font-size: 0.95rem;
            color: var(--polaris-gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            border-bottom: 2px solid rgba(212,175,55,0.3);
        }
        .ceo-tax-table td {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            font-size: 1.15rem;
            color: rgba(255,255,255,0.9);
        }
        .ceo-tax-table tr:hover {
            background: rgba(212,175,55,0.08);
        }
        .ceo-tax-table tr.total {
            background: rgba(212,175,55,0.15);
            font-weight: 700;
        }
        .ceo-tax-table tr.total td {
            color: var(--polaris-gold);
            font-size: 1.3rem;
            border-top: 2px solid rgba(212,175,55,0.3);
        }
        .ceo-tax-table .amount {
            text-align: right;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
        }
        .ceo-tax-table .amount.positive { color: #27ae60; }
        .ceo-tax-table .amount.negative { color: #e74c3c; }
        
        /* Cyprus Tax Info Box */
        .ceo-tax-info {
            background: linear-gradient(145deg, rgba(231,76,60,0.1), rgba(231,76,60,0.05));
            border: 1px solid rgba(231,76,60,0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        .ceo-tax-info-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            color: #e74c3c;
            font-weight: 700;
            font-size: 1.1rem;
        }
        .ceo-tax-info-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .ceo-tax-info-item:last-child { border-bottom: none; }
        .ceo-tax-info-label { color: rgba(255,255,255,0.7); }
        .ceo-tax-info-value { 
            font-weight: 700; 
            color: white;
            font-family: 'Montserrat', sans-serif;
        }
        
        /* Cash Flow Bars */
        .ceo-cashflow-bars {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .ceo-cashflow-row {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .ceo-cashflow-label {
            width: 180px;
            font-size: 1.1rem;
            color: rgba(255,255,255,0.8);
            font-weight: 600;
        }
        .ceo-cashflow-bar-bg {
            flex: 1;
            height: 40px;
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            overflow: hidden;
        }
        .ceo-cashflow-bar-fill {
            height: 100%;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 1rem;
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            transition: width 1s ease;
        }
        .ceo-cashflow-bar-fill.inflow { background: linear-gradient(90deg, #27ae60, #2ecc71); }
        .ceo-cashflow-bar-fill.outflow { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        .ceo-cashflow-bar-fill.net { background: linear-gradient(90deg, var(--polaris-gold), #f5d76e); color: var(--polaris-navy); }
        .ceo-cashflow-value {
            width: 150px;
            text-align: right;
            font-weight: 800;
            font-size: 1.5rem;
            font-family: 'Montserrat', sans-serif;
        }
        .ceo-cashflow-value.positive { color: #27ae60; }
        .ceo-cashflow-value.negative { color: #e74c3c; }
        .ceo-cashflow-value.gold { color: var(--polaris-gold); }
        
        /* Ratio Cards */
        .ceo-ratio-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.25rem;
        }
        .ceo-ratio-card {
            background: rgba(0,0,0,0.2);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
        }
        .ceo-ratio-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
            margin-bottom: 0.5rem;
        }
        .ceo-ratio-card.success .ceo-ratio-value { color: #27ae60; }
        .ceo-ratio-card.warning .ceo-ratio-value { color: #f39c12; }
        .ceo-ratio-card.danger .ceo-ratio-value { color: #e74c3c; }
        .ceo-ratio-label {
            font-size: 0.95rem;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .ceo-ratio-target {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.4);
            margin-top: 0.5rem;
        }
        
        /* Accountant Notes */
        .ceo-notes {
            background: linear-gradient(145deg, rgba(52,152,219,0.1), rgba(52,152,219,0.05));
            border: 1px solid rgba(52,152,219,0.3);
            border-radius: 16px;
            padding: 1.5rem;
        }
        .ceo-notes-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            color: #3498db;
            font-weight: 700;
            font-size: 1.1rem;
        }
        .ceo-notes-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem 0;
            color: rgba(255,255,255,0.8);
            font-size: 1rem;
            line-height: 1.5;
        }
        .ceo-notes-item::before {
            content: '•';
            color: #3498db;
            font-weight: bold;
        }
        
        /* Responsive */
        @media (max-width: 1400px) {
            .ceo-kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .ceo-sections-grid { grid-template-columns: 1fr; }
            .ceo-section-card.full-width,
            .ceo-section-card.half-width { grid-column: span 1; }
            .ceo-ratio-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .ceo-kpi-grid { grid-template-columns: 1fr; }
            .ceo-kpi-value { font-size: 2.5rem; }
            .ceo-ratio-grid { grid-template-columns: 1fr; }
            .ceo-cashflow-label { width: 120px; font-size: 0.95rem; }
            .ceo-cashflow-value { width: 100px; font-size: 1.2rem; }
        }
        
        /* Pipeline Section */
        .renewals-section { background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; }
        .renewals-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .renewals-section-title { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; }
        
        /* Pipeline Kanban */
        .pipeline-kanban { 
            display: grid; 
            grid-template-columns: repeat(6, 1fr); 
            gap: 0.75rem; 
            min-height: 300px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .pipeline-column { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 0.75rem; display: flex; flex-direction: column; }
        .pipeline-column-header { padding: 0.5rem; margin-bottom: 0.75rem; border-radius: 8px; text-align: center; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .pipeline-column.draft .pipeline-column-header { background: rgba(108,117,125,0.3); color: #adb5bd; }
        .pipeline-column.sent .pipeline-column-header { background: rgba(33,150,243,0.3); color: #64B5F6; }
        .pipeline-column.followup1 .pipeline-column-header { background: rgba(156,39,176,0.3); color: #CE93D8; }
        .pipeline-column.followup2 .pipeline-column-header { background: rgba(255,152,0,0.3); color: #FFB74D; }
        .pipeline-column.followup3 .pipeline-column-header { background: rgba(244,67,54,0.3); color: #EF5350; }
        .pipeline-column.accepted .pipeline-column-header { background: rgba(76,175,80,0.3); color: #81C784; }
        .pipeline-column-count { display: inline-block; background: rgba(255,255,255,0.2); padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.7rem; margin-left: 0.5rem; }
        .pipeline-column-body { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; }
        
        .pipeline-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem; cursor: pointer; transition: all 0.2s; }
        .pipeline-card:hover { border-color: var(--polaris-gold); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .pipeline-card-client { font-weight: 600; font-size: 0.85rem; color: var(--text-primary); margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .pipeline-card-amount { font-size: 0.95rem; font-weight: 700; color: var(--polaris-gold); }
        .pipeline-card-date { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem; }
        .pipeline-card-days { display: inline-block; padding: 0.15rem 0.4rem; border-radius: 8px; font-size: 0.65rem; font-weight: 600; margin-top: 0.25rem; }
        .pipeline-card-days.urgent { background: rgba(244,67,54,0.2); color: #EF5350; }
        .pipeline-card-days.warning { background: rgba(255,152,0,0.2); color: #FFB74D; }
        .pipeline-card-days.normal { background: rgba(76,175,80,0.2); color: #81C784; }
        
        /* Expiring Contracts */
        .expiring-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .expiring-tab { padding: 0.5rem 1rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 20px; color: var(--text-secondary); cursor: pointer; font-size: 0.85rem; transition: all 0.3s; }
        .expiring-tab:hover { border-color: var(--polaris-gold); }
        .expiring-tab.active { background: linear-gradient(135deg, #FF9800, #F57C00); border-color: transparent; color: white; }
        .expiring-tab .count { display: inline-block; background: rgba(255,255,255,0.2); padding: 0.1rem 0.4rem; border-radius: 10px; font-size: 0.75rem; margin-left: 0.25rem; }
        
        .expiring-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .expiring-table th { background: rgba(0,0,0,0.3); padding: 0.75rem 1rem; text-align: left; font-size: 0.8rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
        .expiring-table td { padding: 0.75rem 1rem; border-top: 1px solid var(--border-color); font-size: 0.9rem; }
        .expiring-table tbody tr:hover { background: rgba(255,255,255,0.05); }
        
        .days-badge { display: inline-block; padding: 0.25rem 0.6rem; border-radius: 15px; font-size: 0.75rem; font-weight: 600; }
        .days-badge.critical { background: rgba(244,67,54,0.2); color: #EF5350; }
        .days-badge.warning { background: rgba(255,152,0,0.2); color: #FFB74D; }
        .days-badge.ok { background: rgba(76,175,80,0.2); color: #81C784; }
        
        /* Notes Section */
        .notes-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .notes-list { max-height: 300px; overflow-y: auto; }
        .note-item { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; }
        .note-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .note-item-client { font-weight: 600; font-size: 0.9rem; color: var(--text-primary); }
        .note-item-date { font-size: 0.75rem; color: var(--text-muted); }
        .note-item-type { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.7rem; font-weight: 600; margin-bottom: 0.25rem; }
        .note-item-type.followup { background: rgba(33,150,243,0.2); color: #64B5F6; }
        .note-item-type.reminder { background: rgba(255,152,0,0.2); color: #FFB74D; }
        .note-item-type.action { background: rgba(76,175,80,0.2); color: #81C784; }
        .note-item-content { font-size: 0.85rem; color: var(--text-secondary); }
        
        /* ═══════════════════════════════════════════════════════════════
           PIPELINE BAR CHART STYLES
           ═══════════════════════════════════════════════════════════════ */
        .pipeline-summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        @media (max-width: 768px) { .pipeline-summary-grid { grid-template-columns: 1fr; } }
        
        .pipeline-bars { padding: 0.5rem 0; }
        .pipeline-bar-row { 
            display: grid; 
            grid-template-columns: 100px 1fr 50px; 
            align-items: center; 
            gap: 0.75rem; 
            margin-bottom: 0.6rem;
            padding: 0.3rem 0;
        }
        .bar-label { font-size: 0.85rem; color: var(--text-secondary); }
        .bar-container { 
            height: 22px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 4px; 
            overflow: hidden;
            position: relative;
        }
        .bar-fill { 
            height: 100%; 
            border-radius: 4px; 
            transition: width 0.5s ease;
            background: linear-gradient(90deg, #4a5568, #718096);
        }
        .bar-fill.draft { background: linear-gradient(90deg, #4a5568, #718096); }
        .bar-fill.sent { background: linear-gradient(90deg, #2196F3, #64B5F6); }
        .bar-fill.followup1 { background: linear-gradient(90deg, #FF9800, #FFB74D); }
        .bar-fill.followup2 { background: linear-gradient(90deg, #FF5722, #FF8A65); }
        .bar-fill.followup3 { background: linear-gradient(90deg, #f44336, #E57373); }
        .bar-fill.accepted { background: linear-gradient(90deg, #4CAF50, #81C784); }
        .bar-count { 
            font-size: 0.9rem; 
            font-weight: 700; 
            color: var(--text-primary); 
            text-align: right;
        }
        
        /* ═══════════════════════════════════════════════════════════════
           ACTION REQUIRED STYLES
           ═══════════════════════════════════════════════════════════════ */
        .action-required-list { padding: 0.5rem 0; }
        .action-item { 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .action-item:hover { border-color: var(--polaris-gold); transform: translateX(5px); }
        .action-item.warning { border-left: 3px solid #FF9800; }
        .action-item.call { border-left: 3px solid #E91E63; }
        .action-item.expiring { border-left: 3px solid #9C27B0; }
        .action-item.renewal { border-left: 3px solid #00BCD4; }
        .action-icon { font-size: 1.2rem; }
        .action-text { flex: 1; font-size: 0.9rem; color: var(--text-secondary); }
        .action-count { 
            font-size: 1rem; 
            font-weight: 700; 
            color: var(--polaris-gold);
            background: rgba(212,168,67,0.15);
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
        }
        
        /* ═══════════════════════════════════════════════════════════════
           DETAILED VIEW TABLE STYLES
           ═══════════════════════════════════════════════════════════════ */
        .detailed-view-table { width: 100%; border-collapse: collapse; min-width: 700px; }
        .detailed-view-table th { 
            background: rgba(0,0,0,0.3); 
            padding: 0.75rem 1rem; 
            text-align: left; 
            font-size: 0.8rem; 
            color: var(--text-muted); 
            font-weight: 600; 
            text-transform: uppercase;
            border-bottom: 2px solid var(--border-color);
        }
        .detailed-view-table td { 
            padding: 0.75rem 1rem; 
            border-top: 1px solid var(--border-color); 
            font-size: 0.9rem; 
            vertical-align: middle;
        }
        .detailed-view-table tbody tr:hover { background: rgba(255,255,255,0.05); }
        .detailed-view-table .stage-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .stage-badge.draft { background: rgba(158,158,158,0.2); color: #BDBDBD; }
        .stage-badge.sent { background: rgba(33,150,243,0.2); color: #64B5F6; }
        .stage-badge.followup1, .stage-badge.followup2 { background: rgba(255,152,0,0.2); color: #FFB74D; }
        .stage-badge.followup3 { background: rgba(244,67,54,0.2); color: #EF5350; }
        .stage-badge.accepted { background: rgba(76,175,80,0.2); color: #81C784; }
        
        .last-note-cell { max-width: 150px; }
        .last-note-icon { margin-right: 0.3rem; }
        .last-note-date { color: var(--text-muted); font-size: 0.8rem; }
        .next-action-date { 
            display: inline-block;
            padding: 0.2rem 0.5rem;
            background: rgba(212,168,67,0.15);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--polaris-gold);
        }
        
        /* ═══════════════════════════════════════════════════════════════
           TOTALS ROW STYLES
           ═══════════════════════════════════════════════════════════════ */
        .detailed-view-totals {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 2rem;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, rgba(30,58,95,0.5), rgba(20,40,70,0.5));
            border: 1px solid var(--border-color);
            border-top: 2px solid var(--polaris-gold);
            border-radius: 0 0 10px 10px;
            margin-top: -1px;
        }
        .total-item { display: flex; align-items: center; gap: 0.5rem; }
        .total-icon { font-size: 1.3rem; }
        .total-value { 
            font-size: 1.3rem; 
            font-weight: 700; 
            color: var(--polaris-gold);
        }
        .total-label { 
            font-size: 0.85rem; 
            color: var(--text-muted);
            margin-left: 0.25rem;
        }
        .total-divider { 
            color: var(--border-color); 
            font-size: 1.5rem; 
            font-weight: 300;
        }
        
        @media (max-width: 576px) {
            .detailed-view-totals { 
                flex-direction: column; 
                gap: 0.75rem; 
                align-items: flex-start;
            }
            .total-divider { display: none; }
        }
        
        /* Add Note Form */
        .add-note-form { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; padding: 1rem; }
        .add-note-form h4 { font-size: 0.95rem; color: var(--text-primary); margin-bottom: 0.75rem; }
        .note-presets { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; }
        .note-preset { padding: 0.4rem 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 15px; color: var(--text-secondary); font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
        .note-preset:hover { border-color: var(--polaris-gold); color: var(--polaris-gold); }
        .note-textarea { width: 100%; min-height: 80px; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem; color: var(--text-primary); font-family: inherit; font-size: 0.9rem; resize: vertical; }
        .note-textarea:focus { outline: none; border-color: var(--polaris-gold); }
        .note-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 0.75rem; }
        .note-btn { padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .note-btn-cancel { background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-secondary); }
        .note-btn-save { background: linear-gradient(135deg, #1B5E20, #2E7D32); border: none; color: white; }
        
        /* Export Buttons */
        .renewals-export-btn { padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; }
        .renewals-export-btn.pdf { background: rgba(244,67,54,0.2); border: 1px solid #EF5350; color: #EF5350; }
        .renewals-export-btn.excel { background: rgba(76,175,80,0.2); border: 1px solid #4CAF50; color: #4CAF50; }
        .renewals-export-btn:hover { transform: translateY(-2px); }
        
        @media (max-width: 1200px) {
            .renewals-kpis { grid-template-columns: repeat(2, 1fr); }
            .pipeline-kanban { grid-template-columns: repeat(3, 1fr); }
            .notes-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .renewals-kpis { grid-template-columns: 1fr; }
            .pipeline-kanban { grid-template-columns: repeat(2, 1fr); }
        }

        /* Report Builder Modal */
        .report-builder-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex;
            align-items: center; justify-content: center; z-index: 9999;
            backdrop-filter: blur(5px);
        }
        .report-builder-modal.hidden { display: none; }
        .report-builder-box {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 24px; padding: 0; width: 100%; max-width: 800px;
            max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;
        }
        .rb-header {
            background: linear-gradient(135deg, #1B5E20, #2E7D32);
            padding: 1.5rem 2rem; color: white;
        }
        .rb-header h2 { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem; }
        .rb-header p { font-size: 0.9rem; opacity: 0.9; }
        .rb-close {
            position: absolute; top: 1rem; right: 1.5rem;
            background: rgba(255,255,255,0.2); border: none;
            width: 36px; height: 36px; border-radius: 50%;
            color: white; font-size: 1.25rem; cursor: pointer;
            transition: background 0.3s;
        }
        .rb-close:hover { background: rgba(255,255,255,0.3); }
        .rb-content {
            padding: 2rem; overflow-y: auto; flex: 1;
        }
        .rb-section { margin-bottom: 2rem; }
        .rb-section:last-child { margin-bottom: 0; }
        .rb-section-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem; font-weight: 700; color: var(--text-primary);
            margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;
        }
        
        /* Period Selection */
        .rb-period-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;
        }
        .rb-select-group label {
            display: block; font-size: 0.8rem; color: var(--text-muted);
            margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .rb-select {
            width: 100%; background: var(--bg-dark); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 0.8rem 1rem; color: var(--text-primary);
            font-family: inherit; font-size: 0.95rem; cursor: pointer;
        }
        .rb-select:focus { outline: none; border-color: #D4AF37; }
        
        /* Quick Templates */
        .rb-templates {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem;
        }
        .rb-template-btn {
            background: var(--bg-dark); border: 2px solid var(--border-color);
            border-radius: 12px; padding: 1rem; text-align: center;
            cursor: pointer; transition: all 0.3s; color: var(--text-primary);
        }
        .rb-template-btn:hover {
            border-color: #D4AF37; background: rgba(212,175,55,0.1);
        }
        .rb-template-btn.active {
            border-color: #D4AF37; background: rgba(212,175,55,0.15);
        }
        .rb-template-btn span { display: block; font-size: 1.5rem; margin-bottom: 0.5rem; }
        .rb-template-btn div { font-size: 0.85rem; font-weight: 600; }
        
        /* Report Sections */
        .rb-sections-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .rb-section-item {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg-dark); border: 2px solid var(--border-color);
            border-radius: 12px; padding: 1rem 1.25rem; cursor: pointer;
            transition: all 0.3s;
        }
        .rb-section-item:hover { border-color: rgba(212,175,55,0.5); }
        .rb-section-item.selected {
            border-color: #D4AF37; background: rgba(212,175,55,0.1);
        }
        .rb-section-item input[type="checkbox"] {
            width: 20px; height: 20px; accent-color: #D4AF37;
            margin-right: 1rem; cursor: pointer;
        }
        .rb-section-item-content { flex: 1; }
        .rb-section-item-title { font-weight: 600; font-size: 0.95rem; }
        .rb-section-item-desc { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.2rem; }
        .rb-section-item-badge {
            background: rgba(33,150,243,0.2); color: #2196F3;
            padding: 0.3rem 0.75rem; border-radius: 20px;
            font-size: 0.75rem; font-weight: 600;
        }
        
        /* Export Format */
        .rb-formats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .rb-format-btn {
            background: var(--bg-dark); border: 2px solid var(--border-color);
            border-radius: 16px; padding: 1.5rem; text-align: center;
            cursor: pointer; transition: all 0.3s;
        }
        .rb-format-btn:hover { border-color: #D4AF37; }
        .rb-format-btn.selected {
            border-color: #D4AF37; background: rgba(212,175,55,0.1);
        }
        .rb-format-btn span { display: block; font-size: 2.5rem; margin-bottom: 0.5rem; }
        .rb-format-btn div { font-size: 1rem; font-weight: 600; color: var(--text-primary); }
        
        /* Info Box */
        .rb-info-box {
            background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.3);
            border-radius: 12px; padding: 1rem 1.25rem;
            display: flex; align-items: flex-start; gap: 0.75rem;
        }
        .rb-info-box span { font-size: 1.5rem; }
        .rb-info-box div { font-size: 0.85rem; color: var(--text-secondary); }
        .rb-info-box strong { color: var(--polaris-gold); }
        
        /* Footer Actions */
        .rb-footer {
            padding: 1.5rem 2rem; border-top: 1px solid var(--border-color);
            display: flex; gap: 1rem; background: var(--bg-dark);
        }
        .rb-btn {
            flex: 1; padding: 1rem; border-radius: 12px; font-family: 'Montserrat', sans-serif;
            font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .rb-btn-cancel {
            background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-secondary);
        }
        .rb-btn-cancel:hover { background: var(--border-color); }
        .rb-btn-preview {
            background: transparent; border: 2px solid #D4AF37; color: #D4AF37;
        }
        .rb-btn-preview:hover { background: rgba(212,175,55,0.1); }
        .rb-btn-generate {
            background: linear-gradient(135deg, #1B5E20, #2E7D32); border: none; color: white;
            box-shadow: 0 4px 15px rgba(27,94,32,0.3);
        }
        .rb-btn-generate:hover {
            transform: translateY(-2px); box-shadow: 0 8px 25px rgba(27,94,32,0.4);
        }
        
        @media (max-width: 768px) {
            .rb-templates { grid-template-columns: repeat(2, 1fr); }
            .rb-formats { grid-template-columns: 1fr; }
            .rb-period-grid { grid-template-columns: 1fr; }
        }
        
        /* Report Modal */
        .report-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex;
            align-items: center; justify-content: center; z-index: 9999;
        }
        .report-modal.hidden { display: none; }
        .report-box {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 20px; padding: 2rem; width: 100%; max-width: 500px;
            text-align: center;
        }
        .report-progress {
            width: 100%; height: 8px; background: var(--bg-dark);
            border-radius: 4px; margin: 1.5rem 0; overflow: hidden;
        }
        .report-progress-bar {
            height: 100%; background: linear-gradient(90deg, var(--polaris-green), var(--polaris-gold));
            border-radius: 4px; transition: width 0.3s;
        }
        
        .main-content { max-width: 1600px; margin: 0 auto; padding: 2rem; }
        
        .page-header { margin-bottom: 2rem; }
        .page-title {
            font-size: 1.75rem; font-weight: 700;
            display: flex; align-items: center; gap: 0.75rem;
        }
        .page-subtitle { color: var(--text-secondary); margin-top: 0.5rem; }
        .period-badge {
            display: inline-block; background: var(--bg-card);
            border: 1px solid var(--polaris-gold); color: var(--polaris-gold);
            padding: 0.4rem 1rem; border-radius: 20px;
            font-family: 'Montserrat', sans-serif; font-weight: 600;
        }
        
        .section { margin-bottom: 2.5rem; }
        .section-title {
            font-size: 1.6rem; 
            font-weight: 800;
            margin-bottom: 1.5rem; 
            display: flex; 
            align-items: center; 
            gap: 0.75rem;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-color);
            position: relative;
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, var(--polaris-gold), var(--polaris-green));
        }
        
        /* CBMS Statistics Styles */
        .cbms-stats-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1.25rem;
        }
        .cbms-stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s;
        }
        .cbms-stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .cbms-stat-card.highlight-gold {
            border-color: var(--polaris-gold);
            background: linear-gradient(135deg, var(--bg-card), rgba(212,175,55,0.1));
        }
        .cbms-stat-card.highlight-green {
            border-color: var(--polaris-green);
            background: linear-gradient(135deg, var(--bg-card), rgba(46,125,50,0.1));
        }
        .cbms-stat-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }
        .cbms-stat-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--polaris-gold);
            margin-bottom: 0.5rem;
        }
        .cbms-stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .cbms-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .cbms-detail-item {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .cbms-detail-item.highlight {
            background: linear-gradient(135deg, rgba(212,175,55,0.15), rgba(212,175,55,0.05));
            border: 1px solid rgba(212,175,55,0.3);
        }
        .cbms-detail-label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .cbms-detail-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .cbms-detail-value.gold {
            color: var(--polaris-gold);
        }
        .cbms-total-banner {
            background: linear-gradient(135deg, var(--polaris-green), #4CAF50);
            border-radius: 20px;
            padding: 2.5rem;
            text-align: center;
            box-shadow: 0 10px 40px rgba(46,125,50,0.3);
        }
        .cbms-total-label {
            font-size: 1rem;
            color: rgba(255,255,255,0.9);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 0.75rem;
        }
        .cbms-total-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 3rem;
            font-weight: 800;
            color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .cbms-total-subtext {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
            margin-top: 0.5rem;
        }
        @media (max-width: 1200px) {
            .cbms-stats-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 768px) {
            .cbms-stats-grid { grid-template-columns: repeat(2, 1fr); }
            .cbms-detail-grid { grid-template-columns: 1fr; }
        }
        
        .kpi-grid {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 1.25rem; margin-bottom: 2rem;
        }
        .kpi-card {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 16px; padding: 1.5rem;
            transition: transform 0.3s, box-shadow 0.3s;
            text-align: center;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        .kpi-card::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 100%; height: 4px; border-radius: 16px 16px 0 0;
            background: linear-gradient(90deg, var(--polaris-green), var(--polaris-gold));
        }
        .kpi-icon { font-size: 2rem; margin-bottom: 0.75rem; }
        .kpi-label {
            font-size: 0.75rem; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem;
        }
        .kpi-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.75rem; font-weight: 800;
            color: var(--polaris-gold);
        }
        .kpi-trend {
            display: inline-flex; align-items: center; gap: 0.3rem;
            margin-top: 0.5rem; padding: 0.25rem 0.6rem;
            border-radius: 15px; font-size: 0.8rem; font-weight: 600;
        }
        .kpi-trend.up { background: rgba(231, 76, 60, 0.15); color: var(--danger); }
        .kpi-trend.down { background: rgba(76, 175, 80, 0.15); color: var(--success); }
        
        .comparison-banner {
            background: linear-gradient(135deg, var(--bg-card), rgba(27, 94, 32, 0.2));
            border: 1px solid var(--border-color); border-radius: 20px;
            padding: 2rem; margin-bottom: 2rem;
        }
        .comparison-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 1.5rem;
        }
        .comparison-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.25rem;
        }
        .cmp-card {
            background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.75rem;
            text-align: center;
        }
        .cmp-label {
            font-size: 0.95rem; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1rem;
            font-weight: 600;
        }
        .cmp-values { display: flex; align-items: baseline; justify-content: center; gap: 0.75rem; margin-bottom: 0.75rem; }
        .cmp-current { font-family: 'Montserrat', sans-serif; font-size: 2rem; font-weight: 700; }
        .cmp-previous { font-size: 1.1rem; color: var(--text-muted); text-decoration: line-through; }
        .cmp-change {
            display: inline-flex; align-items: center; gap: 0.25rem;
            padding: 0.4rem 0.8rem; border-radius: 15px;
            font-size: 1rem; font-weight: 600;
        }
        .cmp-change.positive { background: rgba(76, 175, 80, 0.2); color: var(--success); }
        .cmp-change.negative { background: rgba(231, 76, 60, 0.2); color: var(--danger); }
        
        .chart-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.25rem;
        }
        .chart-grid.three { grid-template-columns: repeat(3, 1fr); }
        .chart-card {
            background: linear-gradient(145deg, var(--bg-card), rgba(10,20,10,0.95));
            border: 1px solid var(--border-color);
            border-radius: 16px; padding: 1.5rem;
            box-shadow: 
                0 10px 30px rgba(0,0,0,0.4),
                0 5px 15px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .chart-card:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 15px 40px rgba(0,0,0,0.5),
                0 8px 20px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255,255,255,0.08);
        }
        .chart-card.wide { grid-column: span 2; }
        .chart-card.full { grid-column: span 3; }
        .chart-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 1.25rem;
        }
        .chart-title { font-size: 1.15rem; font-weight: 700; }
        .chart-badge {
            background: rgba(212, 175, 55, 0.2); color: var(--polaris-gold);
            padding: 0.3rem 0.75rem; border-radius: 12px;
            font-size: 0.85rem; font-weight: 600;
        }
        .chart-container { height: 280px; position: relative; }
        .chart-container.tall { height: 350px; }
        
        .gauge-container {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; height: 260px;
        }
        .gauge-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem; font-weight: 800;
            color: var(--polaris-gold); margin-top: 1rem;
        }
        .gauge-label { color: var(--text-muted); margin-top: 0.25rem; }
        .gauge-target { color: var(--text-secondary); margin-top: 0.5rem; }
        .gauge-target span { color: var(--polaris-gold); font-weight: 600; }
        
        .stats-mini-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;
        }
        .stat-mini {
            background: linear-gradient(145deg, var(--bg-card), rgba(8,18,8,0.95));
            border: 1px solid var(--border-color);
            border-radius: 12px; padding: 1.25rem; text-align: center;
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.35),
                0 4px 10px rgba(0,0,0,0.25),
                inset 0 1px 0 rgba(255,255,255,0.05);
            transition: transform 0.3s;
        }
        .stat-mini:hover {
            transform: translateY(-2px) scale(1.02);
        }
        .stat-mini-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .stat-mini-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.6rem; font-weight: 700; color: var(--polaris-gold);
        }
        .stat-mini-label { font-size: 0.9rem; color: var(--text-muted); margin-top: 0.25rem; font-weight: 500; }
        
        .progress-item { margin-bottom: 1.5rem; }
        .progress-header { display: flex; justify-content: space-between; margin-bottom: 0.75rem; }
        .progress-label { font-size: 1.1rem; font-weight: 500; }
        .progress-value { font-family: 'Montserrat', sans-serif; color: var(--polaris-gold); font-weight: 700; font-size: 1.2rem; }
        .progress-bar {
            height: 10px; background: var(--bg-dark);
            border-radius: 5px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; border-radius: 5px;
            background: linear-gradient(90deg, var(--polaris-green), var(--polaris-gold));
            transition: width 1s ease-out;
        }
        
        .insights-list { display: flex; flex-direction: column; gap: 1rem; }
        .insight-item {
            display: flex; align-items: flex-start; gap: 1rem;
            padding: 1rem 1.25rem; background: rgba(0,0,0,0.2);
            border-radius: 10px; border-left: 4px solid var(--polaris-green);
        }
        .insight-item.success { border-left-color: var(--success); }
        .insight-item.warning { border-left-color: var(--warning); }
        .insight-item.danger { border-left-color: var(--danger); }
        .insight-icon { font-size: 1.5rem; }
        .insight-title { font-weight: 700; font-size: 1.1rem; }
        .insight-desc { font-size: 1rem; color: var(--text-secondary); margin-top: 0.25rem; }
        
        .data-table-container {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 16px; overflow: hidden;
        }
        .table-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 1.5rem; border-bottom: 1px solid var(--border-color);
        }
        .table-search {
            background: var(--bg-dark); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 0.6rem 1rem;
            color: var(--text-primary); width: 220px; font-size: 1rem;
        }
        .data-table { width: 100%; border-collapse: collapse; font-size: 1.05rem; }
        .data-table th {
            text-align: left; padding: 1.25rem 1rem;
            font-size: 1rem; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px;
            background: var(--bg-dark); border-bottom: 1px solid var(--border-color);
            font-weight: 700;
        }
        .data-table td { padding: 1.25rem 1rem; border-bottom: 1px solid var(--border-color); font-size: 1.05rem; }
        .data-table tr:hover td { background: rgba(46, 125, 50, 0.1); }
        .rank-badge {
            width: 36px; height: 36px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 1rem;
        }
        .rank-badge.gold { background: var(--gold-plan); color: var(--bg-dark); }
        .rank-badge.silver { background: var(--silver-plan); color: var(--bg-dark); }
        .rank-badge.bronze { background: #CD7F32; color: white; }
        .currency { font-family: 'Montserrat', sans-serif; color: var(--polaris-gold); font-weight: 600; font-size: 1.1rem; }
        
        .footer {
            text-align: center; padding: 2rem;
            border-top: 1px solid var(--border-color); margin-top: 2rem;
            color: var(--text-muted); font-size: 0.85rem;
        }
        
        @media (max-width: 1200px) {
            .kpi-grid { grid-template-columns: repeat(3, 1fr); }
            .chart-grid, .chart-grid.three { grid-template-columns: 1fr; }
            .chart-card.wide, .chart-card.full { grid-column: span 1; }
            .comparison-grid { grid-template-columns: repeat(2, 1fr); }
            .cbms-stats-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 768px) {
            .kpi-grid, .comparison-grid, .stats-mini-grid, .cbms-stats-grid { grid-template-columns: 1fr; }
            .cbms-detail-grid { grid-template-columns: 1fr; }
            .header-content { flex-direction: column; gap: 1rem; }
            .user-section { 
                flex-wrap: wrap; 
                justify-content: center; 
                width: 100%;
            }
            .client-selector-wrapper { 
                width: 100%; 
                flex-direction: column;
            }
            .client-selector { 
                width: 100%; 
                min-width: unset; 
            }
            .compare-btn { 
                width: 100%; 
                justify-content: center; 
            }
            .quarter-selector-bar {
                flex-direction: column;
                gap: 0.75rem;
            }
            .quarter-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            .main-content {
                padding: 1rem;
            }
        }
        
        /* ═══════════════════════════════════════════════════════════════════
           COMPREHENSIVE RESPONSIVE DESIGN - Mobile First
           ═══════════════════════════════════════════════════════════════════ */
        
        /* Extra Large Screens (1400px+) */
        @media (min-width: 1400px) {
            .main-content { max-width: 1800px; }
            .kpi-grid { grid-template-columns: repeat(5, 1fr); }
            .chart-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        /* Large Screens (1200px - 1399px) */
        @media (max-width: 1399px) {
            .main-content { padding: 1.5rem; }
            .kpi-grid { grid-template-columns: repeat(5, 1fr); gap: 1rem; }
        }
        
        /* Medium-Large Screens (992px - 1199px) */
        @media (max-width: 1199px) {
            .kpi-grid { grid-template-columns: repeat(3, 1fr); }
            .kpi-card { padding: 1.25rem; }
            .kpi-value { font-size: 1.5rem; }
            .chart-grid, .chart-grid.three { grid-template-columns: 1fr; }
            .chart-card.wide, .chart-card.full { grid-column: span 1; }
            .analysis-grid { grid-template-columns: 1fr; }
            .movement-grid { grid-template-columns: 1fr; }
        }
        
        /* Tablets (768px - 991px) */
        @media (max-width: 991px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            .user-section {
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.5rem;
                width: 100%;
            }
            .user-section button {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }
            .kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
            .kpi-card { padding: 1rem; }
            .kpi-value { font-size: 1.35rem; }
            .kpi-label { font-size: 0.7rem; }
            .main-content { padding: 1rem; }
            .section-header h2 { font-size: 1rem; }
            
            /* Sidebar adjustments */
            .sidebar { width: 60px; }
            .sidebar .nav-text { display: none; }
            .sidebar .nav-btn { justify-content: center; padding: 1rem; }
            .main-wrapper { margin-left: 60px; }
        }
        
        /* Small Tablets / Large Phones (576px - 767px) */
        @media (max-width: 767px) {
            .header {
                position: relative;
                z-index: 100;
            }
            .header-content {
                padding: 0.75rem;
            }
            .logo-section {
                flex-wrap: wrap;
                justify-content: center;
            }
            .polaris-text { font-size: 1.25rem; }
            .user-section {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            .user-section button {
                width: 100%;
                justify-content: center;
                padding: 0.6rem;
                font-size: 0.75rem;
            }
            .user-section button span {
                display: none;
            }
            .kpi-grid { grid-template-columns: 1fr 1fr; gap: 0.5rem; }
            .kpi-card { padding: 0.75rem; }
            .kpi-value { font-size: 1.2rem; }
            .kpi-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
            .quarter-selector-bar {
                flex-direction: column;
                gap: 0.5rem;
            }
            .quarter-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            .quarter-btn {
                padding: 0.4rem 0.75rem;
                font-size: 0.75rem;
            }
            .chart-card {
                padding: 1rem;
            }
            .chart-card h3 {
                font-size: 0.9rem;
            }
            
            /* Sidebar as bottom nav on mobile */
            .sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                top: auto;
                width: 100%;
                height: 60px;
                flex-direction: row;
                justify-content: space-around;
                padding: 0;
                z-index: 1000;
            }
            .sidebar .nav-btn {
                flex-direction: column;
                padding: 0.5rem;
                font-size: 0.65rem;
                gap: 0.2rem;
            }
            .sidebar .nav-btn span:first-child {
                font-size: 1.25rem;
            }
            .sidebar .nav-text {
                display: block;
                font-size: 0.6rem;
            }
            .main-wrapper {
                margin-left: 0;
                margin-bottom: 60px;
            }
            
            /* Analysis sections */
            .analysis-grid, .movement-grid {
                grid-template-columns: 1fr;
            }
            .stats-row {
                flex-direction: column;
                gap: 0.5rem;
            }
            .stat-box {
                min-width: unset;
                width: 100%;
            }
        }
        
        /* Mobile Phones (max-width: 575px) */
        @media (max-width: 575px) {
            body { font-size: 14px; }
            .main-content { padding: 0.75rem; }
            .kpi-grid { 
                grid-template-columns: 1fr; 
                gap: 0.5rem;
            }
            .kpi-card {
                display: flex;
                align-items: center;
                gap: 1rem;
                padding: 1rem;
                text-align: left;
            }
            .kpi-icon { 
                margin-bottom: 0; 
                font-size: 2rem;
            }
            .kpi-content {
                flex: 1;
            }
            .kpi-value { font-size: 1.5rem; }
            .header-content {
                padding: 0.5rem;
            }
            .polaris-star { font-size: 1.5rem; }
            .polaris-text { font-size: 1rem; }
            .portal-badge { 
                font-size: 0.6rem; 
                padding: 0.2rem 0.5rem;
            }
            .user-section {
                grid-template-columns: repeat(3, 1fr);
            }
            .user-section button {
                padding: 0.5rem;
                font-size: 0.7rem;
            }
            .chart-card {
                padding: 0.75rem;
                margin-bottom: 0.5rem;
            }
            .section-header {
                padding: 0.75rem 0;
            }
            .section-header h2 {
                font-size: 0.9rem;
            }
            
            /* Modal adjustments */
            .contract-center-box,
            .offers-center-box {
                width: 100%;
                height: 100%;
                max-height: 100%;
                border-radius: 0;
            }
            .contract-center-header,
            .offers-center-header {
                padding: 1rem;
            }
            .contract-center-header h2,
            .offers-center-header h2 {
                font-size: 1.1rem;
            }
        }
        
        /* Very Small Phones (max-width: 375px) */
        @media (max-width: 375px) {
            .user-section {
                grid-template-columns: repeat(2, 1fr);
            }
            .kpi-value { font-size: 1.25rem; }
            .sidebar .nav-btn {
                padding: 0.4rem;
            }
            .sidebar .nav-text {
                font-size: 0.55rem;
            }
        }
        
        /* Chart Container Scroll for Mobile */
        @media (max-width: 767px) {
            .chart-card canvas,
            .chart-card .chart-container,
            .chart-container {
                min-width: 100%;
                max-width: 100%;
            }
            
            /* Horizontal scroll for wide charts */
            .chart-scroll-container {
                overflow-x: auto;
                overflow-y: hidden;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
                padding-bottom: 10px;
            }
            
            .chart-scroll-container::-webkit-scrollbar {
                height: 6px;
            }
            
            .chart-scroll-container::-webkit-scrollbar-track {
                background: rgba(255,255,255,0.1);
                border-radius: 3px;
            }
            
            .chart-scroll-container::-webkit-scrollbar-thumb {
                background: var(--polaris-gold);
                border-radius: 3px;
            }
            
            /* Make wide charts scrollable */
            .chart-card {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .chart-card canvas {
                min-width: 500px; /* Force minimum width for bar charts */
            }
            
            /* Keep donut/pie charts at 100% */
            .chart-card.pie-chart canvas,
            .chart-card.donut-chart canvas,
            .chart-card[data-chart-type="doughnut"] canvas,
            .chart-card[data-chart-type="pie"] canvas {
                min-width: 100%;
                max-width: 100%;
            }
        }
        
        /* Touch-friendly scroll hint */
        @media (max-width: 767px) {
            .chart-card::after {
                content: '';
                position: absolute;
                right: 0;
                top: 50%;
                transform: translateY(-50%);
                width: 30px;
                height: 60px;
                background: linear-gradient(to right, transparent, rgba(30, 58, 95, 0.8));
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.3s;
            }
            
            .chart-card.scrollable::after {
                opacity: 1;
            }
        }
        
        /* Landscape Mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .sidebar {
                width: 50px;
                height: 100%;
                flex-direction: column;
                bottom: auto;
                top: 0;
            }
            .sidebar .nav-text { display: none; }
            .main-wrapper {
                margin-left: 50px;
                margin-bottom: 0;
            }
        }
        
        /* ═══════════════════════════════════════════════════════════════
           COMPREHENSIVE RESPONSIVE STYLES
           ═══════════════════════════════════════════════════════════════ */
        
        /* Horizontal scroll wrapper for tables and wide content */
        .scroll-horizontal {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--polaris-gold) transparent;
        }
        .scroll-horizontal::-webkit-scrollbar {
            height: 6px;
        }
        .scroll-horizontal::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }
        .scroll-horizontal::-webkit-scrollbar-thumb {
            background: var(--polaris-gold);
            border-radius: 3px;
        }
        
        /* ═══ TABLET LANDSCAPE (992px - 1199px) ═══ */
        @media (max-width: 1199px) {
            .header { padding: 0.5rem 1rem; }
            .header-action-btn { 
                padding: 0.5rem 0.8rem; 
                font-size: 0.75rem; 
                min-width: 100px;
            }
            .kpi-grid { grid-template-columns: repeat(3, 1fr); gap: 1rem; }
            .chart-grid { grid-template-columns: 1fr; }
            .pipeline-kanban { 
                display: flex; 
                overflow-x: auto; 
                -webkit-overflow-scrolling: touch;
                gap: 1rem;
                padding-bottom: 1rem;
            }
            .pipeline-column { 
                min-width: 200px; 
                flex-shrink: 0; 
            }
            .renewals-grid { grid-template-columns: 1fr 1fr; }
        }
        
        /* ═══ TABLET PORTRAIT (768px - 991px) ═══ */
        @media (max-width: 991px) {
            .header-content { flex-wrap: wrap; gap: 0.5rem; }
            .user-section { 
                flex-wrap: wrap; 
                justify-content: center;
                gap: 0.4rem;
            }
            .header-action-btn { 
                padding: 0.4rem 0.6rem; 
                font-size: 0.7rem; 
                min-width: 90px;
            }
            .header-action-btn span:first-child { display: none; }
            .logo-section { margin-left: 0; }
            .polaris-text { font-size: 1.2rem; }
            .polaris-star { font-size: 1.5rem; }
            .kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 0.8rem; }
            .kpi-card { padding: 1rem; }
            .kpi-value { font-size: 1.5rem; }
            .sidebar { width: 60px; }
            .sidebar .nav-text { display: none; }
            .main-wrapper { margin-left: 60px; }
            .renewals-grid { grid-template-columns: 1fr; }
            .renewals-content { padding: 1rem; }
            .expiring-section, .notes-section { padding: 1rem; }
            .client-selector { max-width: 150px; font-size: 0.75rem; }
        }
        
        /* ═══ MOBILE LANDSCAPE (576px - 767px) ═══ */
        @media (max-width: 767px) {
            .header { 
                padding: 0.5rem; 
                position: sticky;
                top: 0;
                z-index: 1000;
            }
            .header-content {
                flex-direction: column;
                gap: 0.5rem;
            }
            .logo-section {
                width: 100%;
                justify-content: center;
                margin-left: 0;
            }
            .user-section {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
                gap: 0.3rem;
            }
            .header-action-btn {
                padding: 0.4rem 0.5rem;
                font-size: 0.65rem;
                min-width: auto;
                border-radius: 15px;
            }
            .client-selector-wrapper { 
                width: 100%; 
                margin-top: 0.3rem;
            }
            .client-selector { width: 100%; max-width: none; }
            .logout-btn { display: none; }
            .sidebar { 
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                top: auto;
                width: 100%;
                height: 60px;
                flex-direction: row;
                justify-content: space-around;
                padding: 0.5rem;
                z-index: 999;
            }
            .sidebar .nav-btn { 
                flex-direction: column;
                padding: 0.5rem;
                font-size: 0.6rem;
                gap: 0.2rem;
            }
            .sidebar .nav-btn span:first-child { font-size: 1.2rem; }
            .sidebar .nav-text { display: block; font-size: 0.55rem; }
            .main-wrapper { 
                margin-left: 0; 
                margin-bottom: 70px;
                padding: 0.5rem;
            }
            .main-content { padding: 0.5rem; }
            .kpi-grid { 
                grid-template-columns: repeat(2, 1fr); 
                gap: 0.5rem; 
            }
            .kpi-card { padding: 0.8rem; }
            .kpi-value { font-size: 1.3rem; }
            .kpi-label { font-size: 0.65rem; }
            .chart-card { padding: 1rem; }
            .section-header { font-size: 1rem; }
            
            /* Tables horizontal scroll */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -0.5rem;
                padding: 0 0.5rem;
            }
            .expiring-table { min-width: 600px; }
            .offers-table { min-width: 800px; }
            .contracts-table { min-width: 700px; }
            
            /* Pipeline horizontal scroll */
            .pipeline-kanban {
                display: flex;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                gap: 0.8rem;
                padding-bottom: 1rem;
                scroll-snap-type: x mandatory;
            }
            .pipeline-column {
                min-width: 160px;
                flex-shrink: 0;
                scroll-snap-align: start;
            }
            
            /* Modals */
            .renewals-modal, .email-center-modal, .offers-modal, .contract-center-modal {
                padding: 0;
            }
            .renewals-content, .email-center-box, .offers-container, .contract-center-box {
                width: 100%;
                height: 100%;
                max-width: none;
                border-radius: 0;
                margin: 0;
            }
            .renewals-header, .offers-header {
                padding: 0.8rem;
                flex-wrap: wrap;
            }
            .renewals-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                flex-wrap: nowrap;
            }
            .renewals-tab {
                white-space: nowrap;
                padding: 0.4rem 0.8rem;
                font-size: 0.75rem;
            }
        }
        
        /* ═══ MOBILE PORTRAIT (<576px) ═══ */
        @media (max-width: 575px) {
            .header { padding: 0.4rem; }
            .polaris-text { font-size: 1rem; letter-spacing: 1px; }
            .polaris-star { font-size: 1.3rem; }
            .user-section { gap: 0.25rem; }
            .header-action-btn {
                padding: 0.35rem 0.4rem;
                font-size: 0.6rem;
                border-radius: 12px;
            }
            .kpi-grid { 
                grid-template-columns: 1fr 1fr;
                gap: 0.4rem;
            }
            .kpi-card { 
                padding: 0.6rem; 
                border-radius: 10px;
            }
            .kpi-value { font-size: 1.1rem; }
            .kpi-label { font-size: 0.6rem; }
            .kpi-icon { font-size: 1.2rem; }
            .chart-card { 
                padding: 0.8rem; 
                margin-bottom: 0.5rem;
            }
            .section-header { 
                font-size: 0.9rem; 
                margin-bottom: 0.8rem;
            }
            
            /* Renewals specific */
            .renewals-kpi-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.4rem;
            }
            .renewals-kpi-card { padding: 0.6rem; }
            .renewals-kpi-value { font-size: 1.2rem; }
            .renewals-kpi-label { font-size: 0.6rem; }
            
            .expiring-tabs {
                display: flex;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                gap: 0.3rem;
            }
            .expiring-tab {
                padding: 0.4rem 0.6rem;
                font-size: 0.7rem;
                white-space: nowrap;
            }
            
            /* Pipeline columns */
            .pipeline-column { min-width: 140px; }
            .pipeline-column-header { 
                font-size: 0.7rem; 
                padding: 0.5rem;
            }
            .pipeline-card {
                padding: 0.5rem;
                font-size: 0.75rem;
            }
            .pipeline-card-client { font-size: 0.8rem; }
            .pipeline-card-amount { font-size: 0.9rem; }
            
            /* Email section */
            .email-compose-section, .note-compose-section {
                padding: 0.8rem;
            }
            .note-compose-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            /* Buttons */
            .note-btn { 
                padding: 0.4rem 0.6rem; 
                font-size: 0.7rem; 
            }
            
            /* Sidebar bottom nav */
            .sidebar {
                height: 55px;
            }
            .sidebar .nav-btn {
                padding: 0.3rem;
            }
            .sidebar .nav-btn span:first-child { font-size: 1rem; }
            .sidebar .nav-text { font-size: 0.5rem; }
        }
        
        /* ═══ EXTRA SMALL (<400px) ═══ */
        @media (max-width: 400px) {
            .header-action-btn {
                padding: 0.3rem;
                font-size: 0.55rem;
            }
            .header-action-btn span:first-child { 
                font-size: 0.9rem; 
            }
            .polaris-text { font-size: 0.9rem; }
            .kpi-value { font-size: 1rem; }
            .pipeline-column { min-width: 120px; }
        }
        
        /* ═══ LANDSCAPE ORIENTATION ═══ */
        @media (max-height: 500px) and (orientation: landscape) {
            .header { 
                padding: 0.3rem 1rem;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
            }
            .sidebar { display: none; }
            .main-wrapper { 
                margin-left: 0; 
                margin-top: 50px;
                margin-bottom: 0;
            }
            .kpi-grid { grid-template-columns: repeat(4, 1fr); }
            .kpi-card { padding: 0.5rem; }
            .kpi-value { font-size: 1.2rem; }
            .renewals-modal, .email-center-modal {
                padding: 0;
            }
            .renewals-content {
                height: 100vh;
                overflow-y: auto;
            }
        }
        
        /* ═══════════════════════════════════════════════════════════════════════════
           COMPREHENSIVE RESPONSIVE DESIGN
           ═══════════════════════════════════════════════════════════════════════════ */
        
        /* Horizontal Scroll Container with Arrows */
        .scroll-container {
            position: relative;
            overflow: hidden;
        }
        .scroll-content {
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: thin;
            scrollbar-color: var(--polaris-gold) rgba(255,255,255,0.1);
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        .scroll-content::-webkit-scrollbar {
            height: 8px;
        }
        .scroll-content::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }
        .scroll-content::-webkit-scrollbar-thumb {
            background: var(--polaris-gold);
            border-radius: 4px;
        }
        .scroll-content::-webkit-scrollbar-thumb:hover {
            background: #f5d76e;
        }
        .scroll-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--polaris-gold), #f5d76e);
            color: var(--polaris-navy);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }
        .scroll-arrow:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        .scroll-arrow.left { left: 10px; }
        .scroll-arrow.right { right: 10px; }
        .scroll-arrow.visible { display: flex; }
        
        /* Welcome Screen Responsive */
        @media (max-width: 768px) {
            .welcome-title {
                font-size: 1rem;
                letter-spacing: 4px;
            }
            .welcome-main-text {
                font-size: 2.5rem;
            }
            .welcome-polaris {
                font-size: 3.5rem;
            }
            .welcome-team {
                font-size: 1.5rem;
                letter-spacing: 8px;
            }
            .welcome-tagline {
                font-size: 1rem;
                letter-spacing: 2px;
            }
            .welcome-ship-container {
                width: 70%;
                max-width: 500px;
            }
            .welcome-ship svg {
                width: 55px;
                height: 36px;
            }
            .polaris-star-welcome {
                font-size: 60px;
                top: 8%;
            }
        }
        
        @media (max-width: 480px) {
            .welcome-title {
                font-size: 0.8rem;
                letter-spacing: 2px;
            }
            .welcome-main-text {
                font-size: 2rem;
            }
            .welcome-polaris {
                font-size: 2.5rem;
            }
            .welcome-team {
                font-size: 1.2rem;
                letter-spacing: 5px;
            }
            .welcome-tagline {
                font-size: 0.85rem;
            }
            .welcome-ship-container {
                width: 85%;
                max-width: 350px;
            }
            .welcome-ship svg {
                width: 45px;
                height: 30px;
            }
            .polaris-star-welcome {
                font-size: 40px;
                top: 5%;
            }
        }
        
        /* Main Dashboard Responsive */
        @media (max-width: 1200px) {
            .dashboard-cards {
                grid-template-columns: repeat(4, 1fr);
                gap: 1.5rem;
            }
            .dashboard-stats-bar {
                gap: 2rem;
                flex-wrap: wrap;
            }
        }
        
        @media (max-width: 992px) {
            .dashboard-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 1.25rem;
            }
            .dashboard-header {
                padding: 1rem 1.5rem;
                flex-direction: column;
                gap: 1rem;
            }
            .dashboard-stats-bar {
                gap: 1.5rem;
                padding: 1rem;
            }
            .dashboard-stat-value {
                font-size: 2rem;
            }
            .dashboard-stat-label {
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
                padding: 0 0.5rem;
            }
            .dashboard-card {
                padding: 1.5rem 1rem;
                border-radius: 16px;
            }
            .dashboard-card-icon {
                font-size: 2.5rem;
                margin-bottom: 1rem;
            }
            .dashboard-card-title {
                font-size: 1.1rem;
            }
            .dashboard-card-desc {
                font-size: 0.75rem;
            }
            .dashboard-stats-bar {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 1rem;
            }
            .dashboard-stat-value {
                font-size: 1.5rem;
            }
            .dashboard-logo-text {
                font-size: 1.4rem;
            }
            .dashboard-logo-icon {
                font-size: 2rem;
            }
            .dashboard-cards-container {
                padding: 1rem 0.5rem;
            }
        }
        
        @media (max-width: 576px) {
            .dashboard-cards {
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
            }
            .dashboard-card {
                padding: 1.25rem 0.75rem;
            }
            .dashboard-card-icon {
                font-size: 2rem;
            }
            .dashboard-card-title {
                font-size: 0.95rem;
            }
            .dashboard-card-desc {
                font-size: 0.7rem;
                display: none;
            }
            .dashboard-stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }
            .dashboard-stat:nth-child(5) {
                grid-column: span 2;
            }
            .dashboard-stat-value {
                font-size: 1.3rem;
            }
            .dashboard-stat-label {
                font-size: 0.65rem;
                letter-spacing: 1px;
            }
            .dashboard-footer {
                font-size: 0.7rem;
                padding: 0.75rem;
            }
            .dashboard-user-avatar {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
            #dashboardUserName {
                display: none;
            }
        }
        
        /* Back to Dashboard Button Responsive */
        @media (max-width: 768px) {
            .back-to-dashboard-btn {
                top: 1rem;
                right: 50px;
                padding: 0.4rem 0.8rem;
                font-size: 0.75rem;
            }
            .fullscreen-toggle-btn {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
        }
        @media (max-width: 480px) {
            .back-to-dashboard-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.7rem;
                right: 45px;
            }
            .back-to-dashboard-btn span {
                display: none;
            }
            .fullscreen-toggle-btn {
                width: 32px;
                height: 32px;
            }
        }
        
        /* Header Responsive */
        @media (max-width: 1400px) {
            .header-content {
                padding: 0 1rem;
            }
            .header-action-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
                min-width: auto;
            }
        }
        
        @media (max-width: 1200px) {
            .user-section {
                flex-wrap: wrap;
                justify-content: flex-end;
                gap: 0.5rem;
            }
            .header-action-btn span {
                display: none;
            }
            .header-action-btn::before {
                content: attr(data-icon);
            }
        }
        
        @media (max-width: 992px) {
            .header {
                padding: 0.5rem 0;
            }
            .header-content {
                flex-direction: column;
                gap: 0.75rem;
            }
            .user-section {
                width: 100%;
                justify-content: center;
                overflow-x: auto;
                padding-bottom: 0.5rem;
            }
            .client-selector-wrapper {
                width: 100%;
                justify-content: center;
            }
            .client-selector {
                max-width: 300px;
            }
        }
        
        @media (max-width: 768px) {
            .header-action-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.7rem;
                border-radius: 20px;
            }
            .logo-section .polaris-star {
                font-size: 1.5rem;
            }
            .logo-section .polaris-text {
                font-size: 1.2rem;
            }
            .logout-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.75rem;
            }
        }
        
        /* Tables Responsive - Horizontal Scroll */
        .table-responsive {
            position: relative;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 -1rem;
            padding: 0 1rem;
        }
        .table-responsive table {
            min-width: 800px;
        }
        .table-responsive::-webkit-scrollbar {
            height: 8px;
        }
        .table-responsive::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }
        .table-responsive::-webkit-scrollbar-thumb {
            background: var(--polaris-gold);
            border-radius: 4px;
        }
        
        /* Offers Table Scroll */
        .offers-table-scroll {
            overflow-x: auto;
            overflow-y: visible;
        }
        .offers-table-scroll .offers-table {
            min-width: 900px;
        }
        
        /* Pipeline Scroll */
        .pipeline-scroll-container {
            position: relative;
        }
        .pipeline-scroll-content {
            overflow-x: auto;
            overflow-y: visible;
            padding-bottom: 10px;
        }
        .pipeline-scroll-content .pipeline-kanban {
            display: flex;
            gap: 1rem;
            min-width: max-content;
        }
        .pipeline-scroll-content .pipeline-column {
            min-width: 200px;
            flex-shrink: 0;
        }
        
        /* Offers Center Responsive */
        @media (max-width: 1200px) {
            .offers-table-wrapper {
                overflow-x: auto;
            }
            .offers-table {
                min-width: 1000px;
            }
        }
        
        @media (max-width: 992px) {
            .offers-header {
                flex-direction: column;
                gap: 1rem;
            }
            .offers-filters {
                flex-wrap: wrap;
                justify-content: center;
            }
            .offers-tabs {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
        
        @media (max-width: 768px) {
            .offers-box {
                padding: 1rem;
                margin: 0.5rem;
                border-radius: 16px;
            }
            .offers-tab {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
            .offers-filter {
                min-width: 120px;
                font-size: 0.8rem;
            }
        }
        
        /* Modals Responsive */
        @media (max-width: 992px) {
            .modal-box, .offers-box, .contracts-box, .email-center-box {
                width: 95%;
                max-width: none;
                margin: 1rem;
                max-height: 90vh;
            }
        }
        
        @media (max-width: 768px) {
            .modal-box, .offers-box, .contracts-box, .email-center-box {
                width: 100%;
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
                height: 100vh;
            }
        }
        
        /* Forms Responsive */
        @media (max-width: 768px) {
            .form-row, .form-group-row {
                flex-direction: column;
            }
            .form-group {
                width: 100% !important;
            }
            input, select, textarea {
                font-size: 16px !important; /* Prevent zoom on iOS */
            }
        }
        
        /* Charts Responsive */
        @media (max-width: 992px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .chart-card {
                min-height: 300px;
            }
            .chart-card.wide, .chart-card.full {
                grid-column: span 1;
            }
        }
        
        @media (max-width: 768px) {
            .chart-card {
                padding: 1rem;
                overflow-x: auto;
            }
            .chart-card canvas {
                min-width: 400px;
            }
        }
        
        /* KPI Cards Responsive */
        @media (max-width: 1200px) {
            .kpi-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            .kpi-card {
                padding: 1rem;
            }
            .kpi-value {
                font-size: 1.5rem;
            }
            .kpi-label {
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .kpi-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* Pipeline Kanban Responsive */
        @media (max-width: 1200px) {
            .pipeline-kanban {
                overflow-x: auto;
                padding-bottom: 1rem;
            }
            .pipeline-column {
                min-width: 250px;
                flex-shrink: 0;
            }
        }
        
        /* Contracts Center Responsive */
        @media (max-width: 992px) {
            .contracts-table-wrapper {
                overflow-x: auto;
            }
            .contracts-table {
                min-width: 900px;
            }
        }
        
        @media (max-width: 768px) {
            .contracts-box {
                padding: 1rem;
            }
            .contract-header {
                flex-direction: column;
                gap: 1rem;
            }
        }
        
        /* Email Center Responsive */
        @media (max-width: 992px) {
            .email-center-content {
                flex-direction: column;
            }
            .email-sidebar, .email-main {
                width: 100%;
                max-height: 50vh;
            }
        }
        
        @media (max-width: 768px) {
            .email-center-box {
                padding: 1rem;
            }
        }
        
        /* Send Documents Modal Responsive */
        @media (max-width: 768px) {
            .send-docs-content {
                padding: 1rem;
            }
            .docs-grid {
                grid-template-columns: 1fr;
            }
            .send-docs-footer {
                flex-direction: column;
                gap: 0.75rem;
            }
            .send-docs-footer button {
                width: 100%;
            }
        }
        
        /* View Offer Modal Responsive */
        @media (max-width: 992px) {
            .view-offer-content {
                flex-direction: column;
            }
            .view-offer-main, .view-offer-sidebar {
                width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .view-offer-box {
                padding: 1rem;
            }
            .offer-detail-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Report Builder Responsive */
        @media (max-width: 992px) {
            .rb-content {
                flex-direction: column;
            }
            .rb-sidebar, .rb-main {
                width: 100%;
            }
        }
        
        /* Follow Ups / Renewals Responsive */
        @media (max-width: 992px) {
            .renewals-kpis {
                grid-template-columns: repeat(2, 1fr);
            }
            .pipeline-kanban {
                display: flex;
                overflow-x: auto;
                gap: 1rem;
                padding: 1rem 0;
            }
            .pipeline-column {
                min-width: 280px;
            }
        }
        
        @media (max-width: 768px) {
            .renewals-header {
                flex-direction: column;
                gap: 1rem;
            }
            .renewals-header-actions {
                flex-wrap: wrap;
                justify-content: center;
            }
            .renewals-kpis {
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
            }
            .renewals-kpi {
                padding: 1rem;
            }
            .renewals-kpi-value {
                font-size: 1.5rem;
            }
        }
        
        /* Tabs Responsive */
        @media (max-width: 768px) {
            .tabs {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            .tab-btn {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
                flex: 1 1 auto;
                min-width: 100px;
                text-align: center;
            }
        }
        
        /* Buttons Responsive */
        @media (max-width: 576px) {
            .action-btn, .btn {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
            .btn-group {
                flex-direction: column;
                width: 100%;
            }
            .btn-group button {
                width: 100%;
            }
        }
        
        /* Calculator Tab Responsive */
        @media (max-width: 992px) {
            .calculator-content {
                flex-direction: column;
            }
            .calculator-form, .calculator-results {
                width: 100%;
            }
        }
        
        /* Landscape Mode Adjustments */
        @media (max-height: 600px) and (orientation: landscape) {
            .dashboard-cards {
                grid-template-columns: repeat(4, 1fr);
                gap: 1rem;
            }
            .dashboard-card {
                padding: 1rem;
            }
            .dashboard-card-icon {
                font-size: 2rem;
                margin-bottom: 0.5rem;
            }
            .dashboard-card-title {
                font-size: 1rem;
            }
            .dashboard-card-desc {
                display: none;
            }
            .dashboard-stats-bar {
                padding: 0.75rem;
            }
            .dashboard-stat-value {
                font-size: 1.5rem;
            }
            .dashboard-header {
                padding: 0.75rem 1.5rem;
            }
        }
        
        /* Touch-friendly adjustments */
        @media (pointer: coarse) {
            .dashboard-card {
                min-height: 120px;
            }
            .btn, .action-btn, button {
                min-height: 44px;
            }
            input, select {
                min-height: 44px;
            }
        }
        
        /* ═══════════════════════════════════════════════════════════════════════════════
           COMPREHENSIVE RESPONSIVE STYLES - MOBILE, TABLET, DESKTOP
           ═══════════════════════════════════════════════════════════════════════════════ */
        
        /* Global responsive helpers */
        .scroll-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--polaris-gold) rgba(255,255,255,0.1);
        }
        .scroll-container::-webkit-scrollbar {
            height: 8px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background: var(--polaris-gold);
            border-radius: 4px;
        }
        
        /* Hide scrollbar arrows on touch devices */
        @media (hover: none) {
            .scroll-hint { display: flex !important; }
        }
        
        /* ═══════════════════════════════════════════════════════════════════════════════
           LARGE DESKTOP (1400px+)
           ═══════════════════════════════════════════════════════════════════════════════ */
        @media (min-width: 1400px) {
            .kpi-grid { grid-template-columns: repeat(5, 1fr); }
            .ceo-kpi-grid { grid-template-columns: repeat(4, 1fr); }
            .ceo-sections-grid { grid-template-columns: repeat(3, 1fr); }
            .chart-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        /* ═══════════════════════════════════════════════════════════════════════════════
           DESKTOP (1200px - 1399px)
           ═══════════════════════════════════════════════════════════════════════════════ */
        @media (max-width: 1399px) {
            .kpi-grid { grid-template-columns: repeat(4, 1fr); }
            .ceo-kpi-grid { grid-template-columns: repeat(4, 1fr); }
            .ceo-sections-grid { grid-template-columns: repeat(3, 1fr); }
        }
        
        /* ═══════════════════════════════════════════════════════════════════════════════
           SMALL DESKTOP / LARGE TABLET (992px - 1199px)
           ═══════════════════════════════════════════════════════════════════════════════ */
        @media (max-width: 1199px) {
            .kpi-grid { grid-template-columns: repeat(3, 1fr); gap: 1rem; }
            .ceo-kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 1rem; }
            .ceo-sections-grid { grid-template-columns: repeat(2, 1fr); gap: 1rem; }
            .chart-grid { grid-template-columns: 1fr; }
            .stats-mini-grid { grid-template-columns: repeat(3, 1fr); }
            
            .header-content { padding: 0 1rem; }
            .header-action-btn { padding: 0.4rem 0.8rem; font-size: 0.75rem; }
            .client-selector { max-width: 180px; font-size: 0.8rem; }
            
            /* Modals */
            .email-center-box,
            .contract-center-box,
            .offers-center-box,
            .renewals-box,
            .rb-box {
                width: 98%;
                max-width: none;
                margin: 1rem;
            }
        }
        
        /* ═══════════════════════════════════════════════════════════════════════════════
           TABLET (768px - 991px)
           ═══════════════════════════════════════════════════════════════════════════════ */
        @media (max-width: 991px) {
            /* Header */
            .header-content {
                flex-wrap: wrap;
                gap: 0.5rem;
                padding: 0.5rem;
            }
            .header-action-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.7rem;
            }
            .header-action-btn span {
                display: none;
            }
            .user-section {
                flex-wrap: wrap;
                gap: 0.3rem;
            }
            .client-selector-wrapper {
                order: -1;
                width: 100%;
            }
            .client-selector {
                max-width: 100%;
                width: 100%;
            }
            
            /* KPIs */
            .kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
            .ceo-kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
            .ceo-sections-grid { grid-template-columns: 1fr; gap: 0.75rem; }
            .stats-mini-grid { grid-template-columns: repeat(2, 1fr); }
            
            /* CEO Finance Section */
            .ceo-finance-header {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }
            .ceo-kpi-card {
                padding: 1rem;
            }
            .ceo-kpi-value {
                font-size: 1.5rem;
            }
            .ceo-section-card {
                padding: 1rem;
            }
            
            /* Charts - horizontal scroll */
            .chart-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .chart-container canvas {
                min-width: 500px;
            }
            
            /* Tables - horizontal scroll */
            .data-table-wrapper,
            .offers-table-wrapper,
            .contracts-table-wrapper,
            .email-history-table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .data-table,
            .offers-table,
            .contracts-table,
            .email-history-table {
                min-width: 800px;
            }
            
            /* Global nav buttons */
            .global-nav-buttons {
                right: 50px !important;
            }
            .global-nav-btn {
                padding: 0.4rem 0.8rem !important;
                font-size: 0.75rem !important;
            }
            .fullscreen-toggle-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
        }
        
        /* ═══════════════════════════════════════════════════════════════════════════════
           MOBILE LANDSCAPE & SMALL TABLET (576px - 767px)
           ═══════════════════════════════════════════════════════════════════════════════ */
        @media (max-width: 767px) {
            /* Header becomes minimal */
            .header {
                padding: 0.5rem;
            }
            .header-content {
                justify-content: space-between;
            }
            .logo-section {
                display: none;
            }
            .polaris-star, .polaris-text {
                display: none;
            }
            .header-action-btn {
                padding: 0.3rem 0.5rem;
                font-size: 0.65rem;
                border-radius: 6px;
            }
            .header-action-btn span {
                font-size: 0.9rem;
            }
            .logout-btn {
                padding: 0.3rem 0.5rem;
                font-size: 0.7rem;
            }
            
            /* Global nav buttons - stack vertically on small screens */
            .global-nav-buttons {
                flex-direction: column;
                right: 45px !important;
                top: 0.5rem !important;
            }
            .global-nav-btn {
                padding: 0.3rem 0.6rem !important;
                font-size: 0.7rem !important;
            }
            .fullscreen-toggle-btn {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
                right: 0.5rem;
                top: 0.5rem;
            }
            
            /* KPIs - single or double column */
            .kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
            .ceo-kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
            .kpi-card, .ceo-kpi-card {
                padding: 0.75rem;
            }
            .kpi-value, .ceo-kpi-value {
                font-size: 1.3rem;
            }
            .kpi-label, .ceo-kpi-label {
                font-size: 0.65rem;
            }
            
            /* CEO Sections - single column with scroll */
            .ceo-sections-grid {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }
            .ceo-section-card {
                padding: 0.75rem;
            }
            .ceo-section-card.half-width {
                width: 100%;
            }
            
            /* Stats mini grid */
            .stats-mini-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            .stat-mini {
                padding: 0.5rem;
            }
            .stat-mini-value {
                font-size: 1rem;
            }
            
            /* Page title */
            .page-title {
                font-size: 1.2rem;
            }
            .page-subtitle {
                font-size: 0.75rem;
            }
            
            /* Sections */
            .section {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            .section-title {
                font-size: 1rem;
            }
            
            /* Charts - force horizontal scroll */
            .chart-grid {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }
            .chart-card {
                padding: 0.75rem;
            }
            .chart-container {
                overflow-x: auto;
                padding-bottom: 10px;
            }
            .chart-container canvas {
                min-width: 400px;
                height: 200px !important;
            }
            
            /* Tables - force horizontal scroll with indicator */
            .data-table-wrapper,
            .offers-table-wrapper,
            .contracts-table-wrapper {
                position: relative;
            }
            .data-table-wrapper::after,
            .offers-table-wrapper::after,
            .contracts-table-wrapper::after {
                content: '← Scroll →';
                position: absolute;
                bottom: -20px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 0.7rem;
                color: var(--text-muted);
                opacity: 0.7;
            }
            
            /* Modals - full screen */
            .email-center-modal,
            .contract-center-modal,
            .offers-center-modal,
            .renewals-modal,
            .report-builder-modal {
                padding: 0;
            }
            .email-center-box,
            .contract-center-box,
            .offers-center-box,
            .renewals-box,
            .rb-box {
                width: 100%;
                height: 100%;
                max-height: 100vh;
                border-radius: 0;
                margin: 0;
            }
            .email-center-header,
            .contract-center-header,
            .offers-center-header,
            .renewals-header,
            .rb-header {
                padding: 0.5rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            .email-center-header h2,
            .contract-center-header h2,
            .offers-center-header h2,
            .renewals-header h2 {
                font-size: 1rem;
            }
            
            /* Offers tabs - horizontal scroll */
            .offers-tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                gap: 0.25rem;
            }
            .offers-tab {
                white-space: nowrap;
                padding: 0.4rem 0.6rem;
                font-size: 0.7rem;
            }
            
            /* Email tabs - horizontal scroll */
            .email-tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }
            .email-tab {
                white-space: nowrap;
                padding: 0.4rem 0.6rem;
                font-size: 0.7rem;
            }
            
            /* Quarter selector */
            .quarter-selector-bar {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.5rem;
            }
            .quarter-buttons {
                flex-wrap: wrap;
            }
            .quarter-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.7rem;
            }
            
            /* Dashboard cards grid */
            .dashboard-cards-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            .dashboard-card {
                padding: 1rem;
                min-height: 100px;
            }
            .dashboard-card-icon {
                font-size: 2rem;
            }
            .dashboard-card-title {
                font-size: 0.9rem;
            }
            .dashboard-card-desc {
                font-size: 0.7rem;
            }
            
            /* Welcome screen */
            .welcome-content h1 {
                font-size: 2rem;
            }
            .welcome-subtitle {
                font-size: 0.9rem;
            }
            .welcome-fullscreen-btn {
                padding: 0.75rem 1.5rem;
                font-size: 0.9rem;
            }
        }
        
        /* ═══════════════════════════════════════════════════════════════════════════════
           MOBILE PORTRAIT (max-width: 575px)
           ═══════════════════════════════════════════════════════════════════════════════ */
        @media (max-width: 575px) {
            /* Header - icon only */
            .header-action-btn {
                width: 36px;
                height: 36px;
                padding: 0;
                justify-content: center;
            }
            .header-action-btn span {
                display: inline;
                font-size: 1rem;
            }
            
            /* Hide text, show only icons */
            .user-section {
                gap: 0.25rem;
            }
            
            /* Global nav - smaller */
            .global-nav-buttons {
                top: 0.3rem !important;
                right: 40px !important;
                gap: 0.3rem !important;
            }
            .global-nav-btn {
                padding: 0.25rem 0.5rem !important;
                font-size: 0.65rem !important;
            }
            .fullscreen-toggle-btn {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }
            
            /* KPIs - single column for very small screens */
            .kpi-grid { grid-template-columns: 1fr 1fr; gap: 0.4rem; }
            .ceo-kpi-grid { grid-template-columns: 1fr 1fr; gap: 0.4rem; }
            .kpi-card, .ceo-kpi-card {
                padding: 0.5rem;
            }
            .kpi-value, .ceo-kpi-value {
                font-size: 1.1rem;
            }
            .kpi-label, .ceo-kpi-label {
                font-size: 0.6rem;
            }
            .kpi-icon, .ceo-kpi-icon {
                font-size: 1.2rem;
            }
            
            /* CEO Tax table */
            .ceo-tax-table td {
                padding: 0.4rem;
                font-size: 0.75rem;
            }
            .ceo-tax-table .amount {
                font-size: 0.8rem;
            }
            
            /* Cash flow bars */
            .ceo-cash-flow-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }
            
            /* Key ratios grid */
            .ceo-ratios-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.4rem;
            }
            .ceo-ratio-card {
                padding: 0.5rem;
            }
            .ceo-ratio-value {
                font-size: 1.2rem;
            }
            .ceo-ratio-label {
                font-size: 0.6rem;
            }
            
            /* Stats mini - single column */
            .stats-mini-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* Dashboard cards */
            .dashboard-cards-grid {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }
            .dashboard-card {
                padding: 0.75rem;
                min-height: 80px;
            }
            .dashboard-card-icon {
                font-size: 1.5rem;
            }
            .dashboard-card-title {
                font-size: 0.75rem;
            }
            .dashboard-card-desc {
                display: none;
            }
            
            /* Page header */
            .page-header {
                padding: 0.5rem;
            }
            .page-title {
                font-size: 1rem;
            }
            .client-filter-badge {
                font-size: 0.65rem;
                padding: 0.2rem 0.4rem;
            }
            
            /* Comparison panel */
            .compare-panel-content {
                padding: 1rem;
            }
            .compare-selectors {
                flex-direction: column;
            }
            .compare-vs {
                transform: rotate(90deg);
            }
            
            /* Modal close buttons */
            .email-center-close,
            .contract-center-close,
            .offers-center-close,
            .renewals-close,
            .rb-close {
                width: 32px;
                height: 32px;
                font-size: 1rem;
            }
        }
        
        /* ═══════════════════════════════════════════════════════════════════════════════
           VERY SMALL MOBILE (max-width: 375px)
           ═══════════════════════════════════════════════════════════════════════════════ */
        @media (max-width: 375px) {
            .kpi-grid { grid-template-columns: 1fr; }
            .ceo-kpi-grid { grid-template-columns: 1fr; }
            .kpi-card, .ceo-kpi-card {
                padding: 0.75rem;
            }
            .kpi-value, .ceo-kpi-value {
                font-size: 1.5rem;
            }
            
            .dashboard-cards-grid {
                grid-template-columns: 1fr;
            }
            .dashboard-card {
                padding: 1rem;
            }
            .dashboard-card-desc {
                display: block;
            }
            
            .global-nav-buttons {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                top: auto !important;
                flex-direction: row !important;
                justify-content: center;
                background: var(--bg-card);
                padding: 0.5rem;
                border-top: 1px solid rgba(255,255,255,0.1);
                gap: 0.5rem !important;
            }
            .global-nav-btn {
                flex: 1;
                text-align: center;
            }
            .fullscreen-toggle-btn {
                position: fixed;
                bottom: 60px;
                right: 0.5rem;
                top: auto;
            }
        }
        
        /* ═══════════════════════════════════════════════════════════════════════════════
           LANDSCAPE MODE SPECIAL HANDLING
           ═══════════════════════════════════════════════════════════════════════════════ */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 0.25rem 0.5rem;
            }
            .kpi-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 0.5rem;
            }
            .ceo-kpi-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 0.5rem;
            }
            .kpi-card, .ceo-kpi-card {
                padding: 0.5rem;
            }
            .kpi-value, .ceo-kpi-value {
                font-size: 1rem;
            }
            
            /* Enable horizontal scroll for sections */
            .ceo-sections-grid {
                display: flex;
                flex-direction: row;
                overflow-x: auto;
                gap: 1rem;
                padding-bottom: 10px;
            }
            .ceo-section-card {
                min-width: 280px;
                flex-shrink: 0;
            }
            
            /* Charts side by side with scroll */
            .chart-grid {
                display: flex;
                flex-direction: row;
                overflow-x: auto;
                gap: 1rem;
            }
            .chart-card {
                min-width: 400px;
                flex-shrink: 0;
            }
            
            /* Welcome screen compact */
            .welcome-content h1 {
                font-size: 1.5rem;
            }
            .welcome-kpis-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            .polaris-star-welcome {
                font-size: 2rem;
            }
        }
        
        /* ═══════════════════════════════════════════════════════════════════════════════
           TOUCH DEVICE OPTIMIZATIONS
           ═══════════════════════════════════════════════════════════════════════════════ */
        @media (hover: none) and (pointer: coarse) {
            /* Larger touch targets */
            .btn, button, .action-btn, .quarter-btn, .offers-tab, .email-tab {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Remove hover effects that don't work on touch */
            .kpi-card:hover,
            .ceo-kpi-card:hover,
            .chart-card:hover,
            .dashboard-card:hover {
                transform: none;
            }
            
            /* Add active states instead */
            .kpi-card:active,
            .ceo-kpi-card:active,
            .chart-card:active,
            .dashboard-card:active {
                transform: scale(0.98);
                opacity: 0.9;
            }
            
            /* Scroll indicators */
            .scroll-container::before {
                content: '←';
                position: absolute;
                left: 5px;
                top: 50%;
                transform: translateY(-50%);
                color: var(--polaris-gold);
                font-size: 1.2rem;
                opacity: 0.5;
                pointer-events: none;
                animation: pulse 1.5s infinite;
            }
            .scroll-container::after {
                content: '→';
                position: absolute;
                right: 5px;
                top: 50%;
                transform: translateY(-50%);
                color: var(--polaris-gold);
                font-size: 1.2rem;
                opacity: 0.5;
                pointer-events: none;
                animation: pulse 1.5s infinite;
            }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }
        
        /* ═══════════════════════════════════════════════════════════════════════════════
           SAFE AREA INSETS (for notched phones)
           ═══════════════════════════════════════════════════════════════════════════════ */
        @supports (padding: max(0px)) {
            .header {
                padding-top: max(0.5rem, env(safe-area-inset-top));
                padding-left: max(0.5rem, env(safe-area-inset-left));
                padding-right: max(0.5rem, env(safe-area-inset-right));
            }
            .main-content {
                padding-bottom: max(1rem, env(safe-area-inset-bottom));
            }
            .global-nav-buttons {
                right: max(60px, calc(60px + env(safe-area-inset-right))) !important;
            }
        }
        
        /* Print Styles */
        @media print {
            .sidebar, .header, .user-section { display: none; }
            .main-wrapper { margin: 0; }
            .main-content { padding: 0; }
            .chart-card { break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <!-- Fullscreen Toggle Button (always visible) -->
    <button class="fullscreen-toggle-btn" id="fullscreenToggleBtn" onclick="toggleFullscreen()" title="Toggle Fullscreen (F11)">⛶</button>
    
    <!-- Global Navigation Buttons (always visible) -->
    <div class="global-nav-buttons" id="globalNavButtons" style="position:fixed; top:1rem; right:60px; display:flex; gap:0.5rem; z-index:99999;">
        <button class="global-nav-btn" id="dashboardBtn" onclick="goToDashboard()" style="display:none; background:linear-gradient(135deg, #3498db, #2980b9); color:white; border:none; padding:0.5rem 1rem; border-radius:8px; font-family:'Montserrat',sans-serif; font-weight:700; font-size:0.85rem; cursor:pointer; box-shadow:0 4px 15px rgba(52,152,219,0.4);">
            🏠 Dashboard
        </button>
        <button class="global-nav-btn" id="mainDashboardBtn" onclick="goToMainDashboard()" style="display:none; background:linear-gradient(135deg, var(--polaris-gold), #f5d76e); color:var(--polaris-navy); border:none; padding:0.5rem 1rem; border-radius:8px; font-family:'Montserrat',sans-serif; font-weight:700; font-size:0.85rem; cursor:pointer; box-shadow:0 4px 15px rgba(212,175,55,0.4);">
            📊 Main Dashboard
        </button>
    </div>
    
    <!-- ═══════════════════════════════════════════════════════════════════════════
         IMPRESSIVE WELCOME LOADING SCREEN
         ═══════════════════════════════════════════════════════════════════════════ -->
    <div class="welcome-loading-screen" id="welcomeLoadingScreen">
        <!-- Animated Stars Background -->
        <div class="stars-container" id="starsContainer"></div>
        
        <!-- Floating Particles -->
        <div class="particles-container" id="particlesContainer"></div>
        
        <!-- Polaris North Star -->
        <div class="polaris-star-welcome">✦</div>
        
        <!-- Main Welcome Content -->
        <div class="welcome-content">
            <div class="welcome-title">WELCOME TO THE NEW</div>
            <div class="welcome-main-text">
                <span class="welcome-polaris">POLARIS</span>
            </div>
            <div class="welcome-team">TEAM</div>
            <div class="welcome-tagline">Fast • Fair • Flexible</div>
            
            <!-- Loading Progress - Sailing Ship -->
            <div class="welcome-ship-container">
                <div class="welcome-ship-track">
                    <div class="welcome-ship-wake"></div>
                    <div class="welcome-ship" id="welcomeShip">
                        <svg width="70" height="45" viewBox="0 0 70 45" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <!-- Ship Hull - Bow (front/pointy) on RIGHT -->
                            <path d="M2 32 L8 38 L52 38 L68 32 L52 32 L48 25 L12 25 L8 32 Z" fill="#1e3a5f" stroke="#d4af37" stroke-width="1.5"/>
                            <!-- Bow Point -->
                            <path d="M52 38 L68 32 L52 32" fill="#2d5a87" stroke="#d4af37" stroke-width="1"/>
                            <!-- Ship Deck -->
                            <rect x="15" y="18" width="30" height="7" rx="1" fill="#2d5a87" stroke="#d4af37" stroke-width="1"/>
                            <!-- Bridge/Cabin - positioned toward the back (left) -->
                            <rect x="12" y="8" width="18" height="10" rx="1" fill="#1e3a5f" stroke="#d4af37" stroke-width="1"/>
                            <!-- Windows -->
                            <rect x="14" y="10" width="4" height="4" rx="0.5" fill="#f5d76e"/>
                            <rect x="20" y="10" width="4" height="4" rx="0.5" fill="#f5d76e"/>
                            <rect x="26" y="10" width="4" height="4" rx="0.5" fill="#f5d76e"/>
                            <!-- Funnel with smoke - at the back -->
                            <rect x="17" y="2" width="6" height="6" fill="#c0392b"/>
                            <rect x="16" y="0" width="8" height="3" fill="#922b21"/>
                            <!-- Smoke puffs going back/left -->
                            <circle cx="15" cy="0" r="2.5" fill="rgba(255,255,255,0.4)">
                                <animate attributeName="cx" values="15;8;2" dur="2s" repeatCount="indefinite"/>
                                <animate attributeName="opacity" values="0.5;0.3;0" dur="2s" repeatCount="indefinite"/>
                            </circle>
                            <circle cx="12" cy="-2" r="2" fill="rgba(255,255,255,0.3)">
                                <animate attributeName="cx" values="12;5;-2" dur="2.5s" repeatCount="indefinite"/>
                                <animate attributeName="opacity" values="0.4;0.2;0" dur="2.5s" repeatCount="indefinite"/>
                            </circle>
                            <!-- Mast -->
                            <rect x="38" y="5" width="2" height="13" fill="#d4af37"/>
                            <!-- Flag pointing LEFT (backwards/trailing) -->
                            <path d="M38 5 L28 8 L38 11" fill="#c0392b"/>
                        </svg>
                    </div>
                </div>
                <div class="welcome-ship-sea">
                    <svg viewBox="0 0 400 30" preserveAspectRatio="none">
                        <path class="ship-wave" d="M0,15 Q25,5 50,15 T100,15 T150,15 T200,15 T250,15 T300,15 T350,15 T400,15" stroke="rgba(212,175,55,0.4)" stroke-width="2" fill="none"/>
                        <path class="ship-wave wave2" d="M0,20 Q25,10 50,20 T100,20 T150,20 T200,20 T250,20 T300,20 T350,20 T400,20" stroke="rgba(212,175,55,0.2)" stroke-width="1.5" fill="none"/>
                    </svg>
                </div>
            </div>
            <div class="welcome-loading-text" id="welcomeLoadingText">Initializing system...</div>
            
            <!-- Enter Fullscreen Button -->
            <button class="welcome-fullscreen-btn" id="welcomeFullscreenBtn" onclick="enterFullscreenAndContinue()">
                ⛶ Click to Enter Full Screen
            </button>
        </div>
        
        <!-- Animated Waves at Bottom -->
        <div class="welcome-waves">
            <svg viewBox="0 0 1440 320" preserveAspectRatio="none">
                <path fill="rgba(212,175,55,0.1)" d="M0,192L48,176C96,160,192,128,288,133.3C384,139,480,181,576,186.7C672,192,768,160,864,165.3C960,171,1056,213,1152,218.7C1248,224,1344,192,1392,176L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z">
                    <animate attributeName="d" dur="10s" repeatCount="indefinite" values="M0,192L48,176C96,160,192,128,288,133.3C384,139,480,181,576,186.7C672,192,768,160,864,165.3C960,171,1056,213,1152,218.7C1248,224,1344,192,1392,176L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z;M0,160L48,181.3C96,203,192,245,288,250.7C384,256,480,224,576,213.3C672,203,768,213,864,202.7C960,192,1056,160,1152,165.3C1248,171,1344,213,1392,234.7L1440,256L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z;M0,192L48,176C96,160,192,128,288,133.3C384,139,480,181,576,186.7C672,192,768,160,864,165.3C960,171,1056,213,1152,218.7C1248,224,1344,192,1392,176L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"/>
                </path>
                <path fill="rgba(212,175,55,0.05)" d="M0,256L48,240C96,224,192,192,288,181.3C384,171,480,181,576,197.3C672,213,768,235,864,229.3C960,224,1056,192,1152,181.3C1248,171,1344,181,1392,186.7L1440,192L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z">
                    <animate attributeName="d" dur="8s" repeatCount="indefinite" values="M0,256L48,240C96,224,192,192,288,181.3C384,171,480,181,576,197.3C672,213,768,235,864,229.3C960,224,1056,192,1152,181.3C1248,171,1344,181,1392,186.7L1440,192L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z;M0,224L48,213.3C96,203,192,181,288,186.7C384,192,480,224,576,234.7C672,245,768,235,864,213.3C960,192,1056,160,1152,165.3C1248,171,1344,213,1392,234.7L1440,256L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z;M0,256L48,240C96,224,192,192,288,181.3C384,171,480,181,576,197.3C672,213,768,235,864,229.3C960,224,1056,192,1152,181.3C1248,171,1344,181,1392,186.7L1440,192L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"/>
                </path>
            </svg>
        </div>
    </div>
    
    <!-- ═══════════════════════════════════════════════════════════════════════════
         MAIN DASHBOARD
         ═══════════════════════════════════════════════════════════════════════════ -->
    <div class="main-dashboard hidden" id="mainDashboard">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="dashboard-logo">
                <span class="dashboard-logo-icon">✦</span>
                <span class="dashboard-logo-text">POLARIS <span>Portal</span></span>
            </div>
            <div class="dashboard-user">
                <span id="dashboardUserName">Welcome, Admin</span>
                <div class="dashboard-user-avatar" id="dashboardUserAvatar">A</div>
            </div>
        </div>
        
        <!-- Stats Bar -->
        <div class="dashboard-stats-bar">
            <div class="dashboard-stat">
                <div class="dashboard-stat-value" id="dashStatClients">--</div>
                <div class="dashboard-stat-label">Active Clients</div>
            </div>
            <div class="dashboard-stat">
                <div class="dashboard-stat-value" id="dashStatOffers">--</div>
                <div class="dashboard-stat-label">Open Offers</div>
            </div>
            <div class="dashboard-stat">
                <div class="dashboard-stat-value" id="dashStatContracts">--</div>
                <div class="dashboard-stat-label">Active Contracts</div>
            </div>
            <div class="dashboard-stat">
                <div class="dashboard-stat-value" id="dashStatMembers">--</div>
                <div class="dashboard-stat-label">Total Members</div>
            </div>
            <div class="dashboard-stat">
                <div class="dashboard-stat-value" id="dashStatPending">--</div>
                <div class="dashboard-stat-label">Pending Signatures</div>
            </div>
        </div>
        
        <!-- Dashboard Cards -->
        <div class="dashboard-cards-container">
            <!-- Stars Background for Dashboard -->
            <div class="dashboard-stars-container" id="dashboardStarsContainer"></div>
            <div class="dashboard-particles-container" id="dashboardParticlesContainer"></div>
            
            <div class="dashboard-cards">
                <!-- ROW 1 -->
                
                <!-- Active Members -->
                <div class="dashboard-card members" onclick="enterModule('members')">
                    <span class="dashboard-card-icon">👥</span>
                    <div class="dashboard-card-title">Active Members</div>
                    <div class="dashboard-card-desc">View & manage enrolled members</div>
                </div>
                
                <!-- New Proposal -->
                <div class="dashboard-card proposal" onclick="enterModule('newproposal')">
                    <span class="dashboard-card-icon">📝</span>
                    <div class="dashboard-card-title">New Proposal</div>
                    <div class="dashboard-card-desc">Create healthcare proposal</div>
                </div>
                
                <!-- Comparison Quotes -->
                <div class="dashboard-card comparison" onclick="enterModule('comparison')">
                    <span class="dashboard-card-icon">📊</span>
                    <div class="dashboard-card-title">Comparison Quotes</div>
                    <div class="dashboard-card-desc">Multi-plan comparisons</div>
                </div>
                
                <!-- Offers -->
                <div class="dashboard-card offers" onclick="enterModule('offers')">
                    <span class="dashboard-card-badge" id="dashOffersNotif"></span>
                    <span class="dashboard-card-icon">📋</span>
                    <div class="dashboard-card-title">Offers</div>
                    <div class="dashboard-card-desc">Healthcare proposals & quotes</div>
                </div>
                
                <!-- ROW 2 -->
                
                <!-- Contracts -->
                <div class="dashboard-card contracts" onclick="enterModule('contracts')">
                    <span class="dashboard-card-icon">📄</span>
                    <div class="dashboard-card-title">Contracts</div>
                    <div class="dashboard-card-desc">Active agreements</div>
                </div>
                
                <!-- Email Center -->
                <div class="dashboard-card email" onclick="enterModule('email')">
                    <span class="dashboard-card-icon">📧</span>
                    <div class="dashboard-card-title">Email Center</div>
                    <div class="dashboard-card-desc">Send documents & templates</div>
                </div>
                
                <!-- Reports -->
                <div class="dashboard-card reports" onclick="enterModule('reports')">
                    <span class="dashboard-card-icon">📈</span>
                    <div class="dashboard-card-title">Reports</div>
                    <div class="dashboard-card-desc">Analytics & insights</div>
                </div>
                
                <!-- Follow Ups -->
                <div class="dashboard-card followups" onclick="enterModule('followups')">
                    <span class="dashboard-card-icon">📋</span>
                    <div class="dashboard-card-title">Follow Ups</div>
                    <div class="dashboard-card-desc">Pipeline & renewals tracking</div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Footer -->
        <div class="dashboard-footer">
            <span>✦</span> POLARIS Financial Services • Third Party Healthcare Administrator • <span>Fast • Fair • Flexible</span>
        </div>
    </div>
    
    <!-- Back to Dashboard Button - REMOVED (using global nav buttons now) -->
    
    <!-- Old Loading Screen (hidden) -->
    <div class="loading-screen" id="loadingScreen" style="display:none;">
        <div class="loader-ring"></div>
        <div style="color: var(--text-secondary); letter-spacing: 2px;" id="loadingText">LOADING DASHBOARD</div>
        <div id="loadingProgress" style="margin-top: 20px; width: 300px; display: none;">
            <div style="background: rgba(255,255,255,0.1); border-radius: 10px; height: 8px; overflow: hidden;">
                <div id="loadingBar" style="background: linear-gradient(90deg, #d4af37, #f4d03f); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
            </div>
            <div id="loadingDetails" style="color: var(--text-muted); font-size: 0.75rem; margin-top: 10px; text-align: center;"></div>
        </div>
    </div>
    
    <div class="login-modal hidden" id="loginModal">
        <div class="login-box">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 3rem; color: var(--polaris-gold); margin-bottom: 0.5rem;">✦</div>
                <div style="font-family: 'Montserrat', sans-serif; font-size: 1.5rem; font-weight: 700; letter-spacing: 3px;">POLARIS</div>
                <div style="color: var(--text-muted); font-size: 0.8rem; letter-spacing: 2px;">FINANCIAL SERVICES</div>
            </div>
            <h2 class="login-title">Admin Dashboard</h2>
            <p class="login-subtitle">Sign in with your admin credentials</p>
            <input type="text" class="login-input" id="loginUsername" placeholder="Username" autocomplete="username">
            <input type="password" class="login-input" id="loginPassword" placeholder="Password" autocomplete="current-password">
            <button class="login-btn" onclick="handleLogin()">Sign In</button>
            <p class="login-error" id="loginError"></p>
            <p style="text-align: center; margin-top: 1.5rem; color: var(--text-muted); font-size: 0.8rem;">
                Authorized personnel only
            </p>
        </div>
    </div>
    
    <header class="header" id="mainHeader">
        <div class="header-content">
            <div class="logo-section">
                <div class="polaris-star">✦</div>
                <span class="polaris-text">POLARIS</span>
            </div>
            <div class="user-section">
                <button onclick="openEmailCenter()" class="header-action-btn">
                    <span>📧</span> Email Center
                </button>
                <button onclick="openOffersCenter()" class="header-action-btn">
                    <span>📋</span> All Offers
                </button>
                <button onclick="openContractCenter()" class="header-action-btn">
                    <span>📄</span> Contracts
                </button>
                <button onclick="openReportBuilder()" class="header-action-btn">
                    <span>📊</span> Reports
                </button>
                <button onclick="window.open('https://polaris.cfserver3.net/', '_blank')" class="header-action-btn">
                    <span>👥</span> Active Members
                </button>
                <button onclick="openRenewals()" class="header-action-btn" style="background: linear-gradient(135deg, #1B5E20, #2E7D32); color: white;">
                    <span>📋</span> Follow Up
                </button>
                <div class="client-selector-wrapper">
                    <select id="clientSelector" class="client-selector" onchange="handleClientChange()">
                        <option value="all">🏢 All Clients (Company Total)</option>
                    </select>
                    <button class="compare-btn" onclick="toggleCompareMode()" id="compareModeBtn">
                        <span>⚖️</span> Compare
                    </button>
                </div>
                <button class="logout-btn" onclick="handleLogout()">Sign Out</button>
            </div>
        </div>
    </header>
    
    <!-- Compare Mode Panel -->
    <div id="comparePanel" class="compare-panel" style="display:none">
        <div class="compare-panel-content">
            <h3>📊 Compare Clients</h3>
            <div class="compare-selectors">
                <div class="compare-select-group">
                    <label>Client A</label>
                    <select id="compareClientA" class="compare-select"></select>
                </div>
                <div class="compare-vs">VS</div>
                <div class="compare-select-group">
                    <label>Client B</label>
                    <select id="compareClientB" class="compare-select"></select>
                </div>
            </div>
            <button class="compare-apply-btn" onclick="applyComparison()">Apply Comparison</button>
            <button class="compare-cancel-btn" onclick="toggleCompareMode()">Cancel</button>
        </div>
    </div>
    
    <main class="main-content" id="mainContent" style="display:none">
        <div class="page-header">
            <h1 class="page-title">🏢 Admin Dashboard</h1>
            <p class="page-subtitle">
                Company-wide analytics and insights
                <span class="client-filter-badge" id="clientFilterBadge">All Clients</span>
            </p>
        </div>
        
        <!-- Quarter Selector Bar -->
        <div class="quarter-selector-bar">
            <div class="quarter-selector-left">
                <span class="quarter-label">📅 Select Period:</span>
                <div class="quarter-buttons">
                    <button class="quarter-btn" data-quarter="Q1" onclick="toggleQuarter('Q1')">Q1 2025</button>
                    <button class="quarter-btn" data-quarter="Q2" onclick="toggleQuarter('Q2')">Q2 2025</button>
                    <button class="quarter-btn active" data-quarter="Q3" onclick="toggleQuarter('Q3')">Q3 2025</button>
                    <button class="quarter-btn" data-quarter="Q4" onclick="toggleQuarter('Q4')">Q4 2025</button>
                </div>
            </div>
            <div class="quarter-selector-right">
                <button class="quarter-compare-btn" id="quarterCompareBtn" onclick="toggleQuarterCompare()">
                    <span>⚖️</span> Compare Quarters
                </button>
                <span class="selected-quarters-badge" id="selectedQuartersBadge">Q3 2025</span>
            </div>
        </div>
        
        <!-- ═══════════════════════════════════════════════════════════ -->
        <!-- BUSINESS STRATEGY SECTION -->
        <!-- ═══════════════════════════════════════════════════════════ -->
        <div class="section-divider">
            <span class="section-divider-icon">📈</span>
            <span class="section-divider-text">BUSINESS STRATEGY</span>
        </div>
        
        <section class="section">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon">👥</div>
                    <div class="kpi-label">Total Members</div>
                    <div class="kpi-value" id="kpiMembers">-</div>
                    <div class="kpi-trend" id="kpiMembersTrend">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">📋</div>
                    <div class="kpi-label">Total Claims</div>
                    <div class="kpi-value" id="kpiClaims">-</div>
                    <div class="kpi-trend" id="kpiClaimsTrend">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">💵</div>
                    <div class="kpi-label">Approved Amount</div>
                    <div class="kpi-value" id="kpiApproved">-</div>
                    <div class="kpi-trend" id="kpiApprovedTrend">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">📈</div>
                    <div class="kpi-label">Cost per Member</div>
                    <div class="kpi-value" id="kpiCost">-</div>
                    <div class="kpi-trend" id="kpiCostTrend">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">🎯</div>
                    <div class="kpi-label">Utilization Rate</div>
                    <div class="kpi-value" id="kpiUtilization">-</div>
                    <div class="kpi-trend" style="background:rgba(255,255,255,0.1);color:var(--text-secondary)">Target: 15%</div>
                </div>
            </div>
        </section>
        
        <!-- INPATIENT vs OUTPATIENT Section - TOP PRIORITY -->
        <section class="section">
            <h2 class="section-title">🏥 Inpatient vs Outpatient Analysis</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">📊 Cases Distribution</h3>
                        <span class="chart-badge">Current Period</span>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem; grid-template-columns: repeat(3, 1fr);">
                        <div class="stat-mini" style="border-left:4px solid #e74c3c">
                            <div class="stat-mini-icon">🏨</div>
                            <div class="stat-mini-value" id="inpatientCases">-</div>
                            <div class="stat-mini-label">Inpatient Cases</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #3498db">
                            <div class="stat-mini-icon">🏃</div>
                            <div class="stat-mini-value" id="outpatientCases">-</div>
                            <div class="stat-mini-label">Outpatient Cases</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37">
                            <div class="stat-mini-icon">🎁</div>
                            <div class="stat-mini-value" id="exGratiaCases">-</div>
                            <div class="stat-mini-label">Ex Gratia Cases</div>
                        </div>
                    </div>
                    <div class="chart-container short"><canvas id="inOutPieChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">💰 Cost Comparison</h3>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem; grid-template-columns: repeat(3, 1fr);">
                        <div class="stat-mini" style="border-left:4px solid #e74c3c">
                            <div class="stat-mini-icon">💵</div>
                            <div class="stat-mini-value" id="inpatientCost">-</div>
                            <div class="stat-mini-label">Inpatient Cost</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #3498db">
                            <div class="stat-mini-icon">💵</div>
                            <div class="stat-mini-value" id="outpatientCost">-</div>
                            <div class="stat-mini-label">Outpatient Cost</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37">
                            <div class="stat-mini-icon">💵</div>
                            <div class="stat-mini-value" id="exGratiaCost">-</div>
                            <div class="stat-mini-label">Ex Gratia Cost</div>
                        </div>
                    </div>
                    <div class="chart-container short"><canvas id="inOutCostChart"></canvas></div>
                </div>
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title">📈 Inpatient vs Outpatient Trend</h3>
                    </div>
                    <div class="chart-container"><canvas id="inOutTrendChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- PRINCIPAL vs DEPENDENT Section -->
        <section class="section">
            <h2 class="section-title">👥 Principal vs Dependent Analysis</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">👤 Member Type Distribution</h3>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem">
                        <div class="stat-mini" style="border-left:4px solid #2E7D32">
                            <div class="stat-mini-icon">⚓</div>
                            <div class="stat-mini-value" id="principalCount">-</div>
                            <div class="stat-mini-label">Seafarers (Principal)</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37">
                            <div class="stat-mini-icon">👨‍👩‍👧</div>
                            <div class="stat-mini-value" id="dependentCount">-</div>
                            <div class="stat-mini-label">Dependents</div>
                        </div>
                    </div>
                    <div class="chart-container short"><canvas id="memberTypePieChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">📊 Claims by Member Type</h3>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem">
                        <div class="stat-mini" style="border-left:4px solid #2E7D32">
                            <div class="stat-mini-icon">⚓</div>
                            <div class="stat-mini-value" id="principalClaims">-</div>
                            <div class="stat-mini-label">Seafarer Claims</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37">
                            <div class="stat-mini-icon">👨‍👩‍👧</div>
                            <div class="stat-mini-value" id="dependentClaims">-</div>
                            <div class="stat-mini-label">Dependent Claims</div>
                        </div>
                    </div>
                    <div class="chart-container short"><canvas id="memberTypeClaimsChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- MEMBER MOVEMENT Section -->
        <section class="section">
            <h2 class="section-title">📈 Member Movement</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">📊 Movement Summary</h3>
                        <span class="chart-badge">Current Period</span>
                    </div>
                    <div class="stats-mini-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom:1rem;">
                        <div class="stat-mini" style="border-left:4px solid #4CAF50">
                            <div style="font-size:2.2rem;color:#4CAF50;font-family:Montserrat;font-weight:800" id="newEnrollments">+0</div>
                            <div style="color:var(--text-muted);font-size:0.9rem;margin-top:0.25rem">New Members</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #e74c3c">
                            <div style="font-size:2.2rem;color:#e74c3c;font-family:Montserrat;font-weight:800" id="cancellations">-0</div>
                            <div style="color:var(--text-muted);font-size:0.9rem;margin-top:0.25rem">Cancelled</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37">
                            <div style="font-size:2.2rem;color:#D4AF37;font-family:Montserrat;font-weight:800" id="netChange">0</div>
                            <div style="color:var(--text-muted);font-size:0.9rem;margin-top:0.25rem">Net Growth</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="movementCompareChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">📈 Movement Trend</h3>
                        <span class="chart-badge">Quarterly</span>
                    </div>
                    <div class="chart-container"><canvas id="movementTrendChart"></canvas></div>
                </div>
            </div>
            <div class="chart-grid" style="grid-template-columns: 1fr; margin-top: 1.25rem;">
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title">📉 Enrollment vs Cancellation Trend</h3>
                        <span class="chart-badge">All Periods</span>
                    </div>
                    <div class="chart-container" style="height: 300px;"><canvas id="movementFullTrendChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- CLAIMS BY CATEGORY Section -->
        <section class="section">
            <h2 class="section-title">📊 Claims by Category</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">🏥 Category Distribution</h3>
                        <span class="chart-badge">Current Period</span>
                    </div>
                    <div class="chart-container"><canvas id="categoryPieChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">💰 Cost by Category</h3>
                    </div>
                    <div class="chart-container"><canvas id="categoryCostChart"></canvas></div>
                </div>
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title">📈 Category Trend</h3>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem; grid-template-columns: repeat(6, 1fr);">
                        <div class="stat-mini" style="border-left:4px solid #4CAF50; padding:0.75rem;">
                            <div style="font-size:1.4rem;font-weight:700;color:#4CAF50" id="catMedical">-</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Medical</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #2196F3; padding:0.75rem;">
                            <div style="font-size:1.4rem;font-weight:700;color:#2196F3" id="catDental">-</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Dental</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #E91E63; padding:0.75rem;">
                            <div style="font-size:1.4rem;font-weight:700;color:#E91E63" id="catMaternity">-</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Maternity</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #FF9800; padding:0.75rem;">
                            <div style="font-size:1.4rem;font-weight:700;color:#FF9800" id="catOptical">-</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Optical</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37; padding:0.75rem;">
                            <div style="font-size:1.4rem;font-weight:700;color:#D4AF37" id="catLab">-</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Laboratory</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #607D8B; padding:0.75rem;">
                            <div style="font-size:1.4rem;font-weight:700;color:#607D8B" id="catOther">-</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Other</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="categoryTrendChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- YEAR-OVER-YEAR COMPARISON Section -->
        <section class="section">
            <h2 class="section-title">📈 Year-over-Year Comparison</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">📊 Annual Claims Comparison</h3>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem;">
                        <div class="stat-mini" style="border-left:4px solid #D4AF37;">
                            <div style="font-size:0.9rem;color:var(--text-muted)">2025 YTD</div>
                            <div style="font-size:1.6rem;font-weight:700;color:#D4AF37" id="yoyClaims2025">-</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #7a8f7a;">
                            <div style="font-size:0.9rem;color:var(--text-muted)">2024</div>
                            <div style="font-size:1.6rem;font-weight:700;color:#7a8f7a" id="yoyClaims2024">-</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="yoyClaimsChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">💰 Annual Cost Comparison</h3>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem;">
                        <div class="stat-mini" style="border-left:4px solid #4CAF50;">
                            <div style="font-size:0.9rem;color:var(--text-muted)">2025 YTD</div>
                            <div style="font-size:1.6rem;font-weight:700;color:#4CAF50" id="yoyCost2025">-</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #7a8f7a;">
                            <div style="font-size:0.9rem;color:var(--text-muted)">2024</div>
                            <div style="font-size:1.6rem;font-weight:700;color:#7a8f7a" id="yoyCost2024">-</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="yoyCostChart"></canvas></div>
                </div>
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title">📈 Monthly YoY Trend</h3>
                        <span class="chart-badge">2025 vs 2024</span>
                    </div>
                    <div class="yoy-summary" style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1rem;">
                        <div style="text-align:center;padding:1rem;background:rgba(76,175,80,0.1);border-radius:10px;">
                            <div style="font-size:0.95rem;color:var(--text-muted)">Claims Change</div>
                            <div style="font-size:1.8rem;font-weight:700;color:#4CAF50" id="yoyClaimsChange">+12%</div>
                        </div>
                        <div style="text-align:center;padding:1rem;background:rgba(231,76,60,0.1);border-radius:10px;">
                            <div style="font-size:0.95rem;color:var(--text-muted)">Cost Change</div>
                            <div style="font-size:1.8rem;font-weight:700;color:#e74c3c" id="yoyCostChange">+8%</div>
                        </div>
                        <div style="text-align:center;padding:1rem;background:rgba(52,152,219,0.1);border-radius:10px;">
                            <div style="font-size:0.95rem;color:var(--text-muted)">Member Growth</div>
                            <div style="font-size:1.8rem;font-weight:700;color:#3498db" id="yoyMemberChange">-</div>
                        </div>
                        <div style="text-align:center;padding:1rem;background:rgba(212,175,55,0.1);border-radius:10px;">
                            <div style="font-size:0.95rem;color:var(--text-muted)">Cost/Member</div>
                            <div style="font-size:1.8rem;font-weight:700;color:#D4AF37" id="yoyCostPerMember">-5%</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="yoyTrendChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- TOP HOSPITALS/PROVIDERS Section -->
        <section class="section">
            <h2 class="section-title">🏥 Top Hospitals & Providers</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">🏆 Top 10 by Claims</h3>
                        <span class="chart-badge">Current Period</span>
                    </div>
                    <div class="chart-container tall"><canvas id="topHospitalsChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">💰 Top 10 by Cost</h3>
                    </div>
                    <div class="chart-container tall"><canvas id="topHospitalsCostChart"></canvas></div>
                </div>
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title">📋 Hospital Details</h3>
                    </div>
                    <div style="overflow-x:auto;">
                        <table class="data-table" id="hospitalsTable">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Hospital/Provider</th>
                                    <th>Claims</th>
                                    <th>Total Cost</th>
                                    <th>Avg Cost</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody id="hospitalsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- GEOGRAPHIC DISTRIBUTION Section -->
        <section class="section">
            <h2 class="section-title">🌍 Geographic Distribution</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">📍 Claims by Region</h3>
                        <span class="chart-badge">Philippines</span>
                    </div>
                    <div class="chart-container"><canvas id="geoRegionChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">💰 Cost by Region</h3>
                    </div>
                    <div class="chart-container"><canvas id="geoCostChart"></canvas></div>
                </div>
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title">🏙️ Top Cities</h3>
                    </div>
                    <div class="stats-mini-grid" style="grid-template-columns: repeat(5, 1fr); margin-bottom:1rem;">
                        <div class="stat-mini" style="border-left:4px solid #4CAF50;">
                            <div style="font-size:1.8rem;font-weight:700;color:#4CAF50" id="geoManila">-</div>
                            <div style="font-size:0.9rem;color:var(--text-muted)">Metro Manila</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #2196F3;">
                            <div style="font-size:1.8rem;font-weight:700;color:#2196F3" id="geoCebu">-</div>
                            <div style="font-size:0.9rem;color:var(--text-muted)">Cebu</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #FF9800;">
                            <div style="font-size:1.8rem;font-weight:700;color:#FF9800" id="geoDavao">-</div>
                            <div style="font-size:0.9rem;color:var(--text-muted)">Davao</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37;">
                            <div style="font-size:1.8rem;font-weight:700;color:#D4AF37" id="geoIloilo">-</div>
                            <div style="font-size:0.9rem;color:var(--text-muted)">Iloilo</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #607D8B;">
                            <div style="font-size:1.8rem;font-weight:700;color:#607D8B" id="geoOther">-</div>
                            <div style="font-size:0.9rem;color:var(--text-muted)">Other</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="geoCitiesChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════ -->
        <!-- FINANCE SECTION -->
        <!-- ═══════════════════════════════════════════════════════════ -->
        <div class="section-divider">
            <span class="section-divider-icon">💰</span>
            <span class="section-divider-text">FINANCE</span>
        </div>

        <!-- FEES BREAKDOWN Section -->
        <section class="section">
            <h2 class="section-title">💳 Fees & Charges Breakdown</h2>
            <div class="stats-mini-grid">
                <div class="stat-mini">
                    <div class="stat-mini-icon">📋</div>
                    <div class="stat-mini-value" id="auditFee">15%</div>
                    <div class="stat-mini-label">Audit Fee</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon">📝</div>
                    <div class="stat-mini-value" id="registrationFee">$24</div>
                    <div class="stat-mini-label">Registration Fee (Annual)</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon">📅</div>
                    <div class="stat-mini-value" id="monthlyFee">$9</div>
                    <div class="stat-mini-label">Monthly Fee (Annual)</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon">🦷</div>
                    <div class="stat-mini-value" id="dentalFee" style="font-size:1.8rem">Yes</div>
                    <div class="stat-mini-label">Dental Coverage</div>
                    <div style="font-size:0.9rem;color:var(--text-muted);margin-top:0.25rem">(via CBMS)</div>
                </div>
            </div>
            <div class="chart-grid" style="margin-top:1.5rem">
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title">📊 Annualized Cost Breakdown</h3>
                        <span class="chart-badge">Per Member</span>
                    </div>
                    <div class="chart-container"><canvas id="costBreakdownChart"></canvas></div>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="comparison-banner">
                <div class="comparison-header">
                    <h2 class="section-title" style="margin:0">📊 Period Comparison</h2>
                    <span class="period-badge" id="cmpPeriodLabel">Q3 vs Q2 2025</span>
                </div>
                <div class="comparison-grid">
                    <div class="cmp-card">
                        <div class="cmp-label">Total Claims</div>
                        <div class="cmp-values">
                            <span class="cmp-current" id="cmpClaims">-</span>
                            <span class="cmp-previous" id="cmpClaimsPrev">-</span>
                        </div>
                        <span class="cmp-change" id="cmpClaimsChange">-</span>
                    </div>
                    <div class="cmp-card">
                        <div class="cmp-label">Total Members</div>
                        <div class="cmp-values">
                            <span class="cmp-current" id="cmpMembers">-</span>
                            <span class="cmp-previous" id="cmpMembersPrev">-</span>
                        </div>
                        <span class="cmp-change" id="cmpMembersChange">-</span>
                    </div>
                    <div class="cmp-card">
                        <div class="cmp-label">Approved (USD)</div>
                        <div class="cmp-values">
                            <span class="cmp-current" id="cmpApproved">-</span>
                            <span class="cmp-previous" id="cmpApprovedPrev">-</span>
                        </div>
                        <span class="cmp-change" id="cmpApprovedChange">-</span>
                    </div>
                    <div class="cmp-card">
                        <div class="cmp-label">Cost per Member</div>
                        <div class="cmp-values">
                            <span class="cmp-current" id="cmpCost">-</span>
                            <span class="cmp-previous" id="cmpCostPrev">-</span>
                        </div>
                        <span class="cmp-change" id="cmpCostChange">-</span>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="section">
            <h2 class="section-title">💰 Financial Analytics</h2>
            <div class="chart-grid">
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title">📈 Cost per Member Trend</h3>
                        <span class="chart-badge">Historical</span>
                    </div>
                    <div class="chart-container tall"><canvas id="costTrendChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">💵 Approved Amounts</h3>
                    </div>
                    <div class="chart-container"><canvas id="approvedChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">🎯 Cost vs Target</h3>
                        <span class="chart-badge">Gauge</span>
                    </div>
                    <div class="gauge-container">
                        <canvas id="gaugeChart" width="200" height="200"></canvas>
                        <div class="gauge-value" id="gaugeValue">$0</div>
                        <div class="gauge-label">Cost per Member</div>
                        <div class="gauge-target">Target: <span>$50.00</span></div>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="section">
            <h2 class="section-title">📋 Claims Analysis</h2>
            <div class="chart-grid three">
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">📊 Claims by Period</h3></div>
                    <div class="chart-container"><canvas id="claimsPeriodChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">🏥 Claims per 1000</h3></div>
                    <div class="chart-container"><canvas id="claims1000Chart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">💊 Avg Claim Value</h3></div>
                    <div class="chart-container"><canvas id="avgClaimChart"></canvas></div>
                </div>
            </div>
        </section>
        
        <section class="section">
            <h2 class="section-title">🏆 Plan Performance</h2>
            <div class="stats-mini-grid" style="margin-bottom:1.5rem">
                <div class="stat-mini">
                    <div class="stat-mini-icon">🥇</div>
                    <div class="stat-mini-value" id="goldMembers">-</div>
                    <div class="stat-mini-label">Gold Members</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon">💎</div>
                    <div class="stat-mini-value" id="platMembers">-</div>
                    <div class="stat-mini-label">Platinum</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon">🥈</div>
                    <div class="stat-mini-value" id="silverMembers">-</div>
                    <div class="stat-mini-label">Silver</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon">📊</div>
                    <div class="stat-mini-value" id="totalActive">-</div>
                    <div class="stat-mini-label">Total Active</div>
                </div>
            </div>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">📊 Member Distribution</h3>
                        <span class="chart-badge">3D Pie</span>
                    </div>
                    <div class="chart-container"><canvas id="planPieChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">💰 Cost by Plan</h3></div>
                    <div class="chart-container"><canvas id="planCostChart"></canvas></div>
                </div>
            </div>
        </section>
        
        <section class="section">
            <h2 class="section-title">📈 Utilization Metrics</h2>
            <div class="chart-grid three">
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">📊 Utilization Trend</h3></div>
                    <div class="chart-container"><canvas id="utilizationChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">🏥 Key Metrics</h3></div>
                    <div style="padding:1rem 0">
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-label">Utilization Rate</span>
                                <span class="progress-value" id="utilValue">0%</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" id="utilBar" style="width:0%"></div></div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-label">Claims Ratio</span>
                                <span class="progress-value" id="claimsRatioValue">0%</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" id="claimsRatioBar" style="width:0%"></div></div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-label">Cost Efficiency</span>
                                <span class="progress-value" id="effValue">0%</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" id="effBar" style="width:0%"></div></div>
                        </div>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">💡 AI Insights</h3></div>
                    <div class="insights-list" id="insightsList"></div>
                </div>
            </div>
        </section>
        
        <!-- ═══════════════════════════════════════════════════════════ -->
        <!-- CEO/CFO FINANCIAL DASHBOARD - CYPRUS TAX COMPLIANCE -->
        <!-- ═══════════════════════════════════════════════════════════ -->
        <div class="section-divider">
            <span class="section-divider-icon">🇨🇾</span>
            <span class="section-divider-text">CEO/CFO FINANCIAL DASHBOARD</span>
        </div>
        
        <section class="ceo-finance-section">
            <div class="ceo-finance-header">
                <div>
                    <div class="ceo-finance-title">
                        <span class="flag">🇨🇾</span>
                        Cyprus Financial Overview
                    </div>
                    <div class="ceo-finance-subtitle">Polaris Financial Services Ltd • Tax Jurisdiction: Cyprus (12.5% CIT)</div>
                </div>
                <div class="ceo-finance-period">
                    <span>📅</span>
                    <span id="ceoFinancePeriod">YTD 2025</span>
                </div>
            </div>
            
            <!-- Main Financial KPIs -->
            <div class="ceo-kpi-grid">
                <div class="ceo-kpi-card revenue">
                    <div class="ceo-kpi-icon">💰</div>
                    <div class="ceo-kpi-value" id="ceoGrossRevenue">$0</div>
                    <div class="ceo-kpi-label">Gross Revenue</div>
                    <div class="ceo-kpi-sublabel">Premiums + Admin Fees</div>
                    <div class="ceo-kpi-trend up" id="ceoRevenueTrend">↑ 12.5%</div>
                </div>
                <div class="ceo-kpi-card expense">
                    <div class="ceo-kpi-icon">📤</div>
                    <div class="ceo-kpi-value" id="ceoTotalExpenses">$0</div>
                    <div class="ceo-kpi-label">Total Expenses</div>
                    <div class="ceo-kpi-sublabel">Claims + Operating Costs</div>
                    <div class="ceo-kpi-trend down" id="ceoExpenseTrend">↓ 3.2%</div>
                </div>
                <div class="ceo-kpi-card profit highlight">
                    <div class="ceo-kpi-icon">📈</div>
                    <div class="ceo-kpi-value" id="ceoNetProfit">$0</div>
                    <div class="ceo-kpi-label">Net Profit</div>
                    <div class="ceo-kpi-sublabel">Before Tax (EBIT)</div>
                    <div class="ceo-kpi-trend up" id="ceoProfitTrend">↑ 18.7%</div>
                </div>
                <div class="ceo-kpi-card tax">
                    <div class="ceo-kpi-icon">🏛️</div>
                    <div class="ceo-kpi-value" id="ceoTaxLiability">$0</div>
                    <div class="ceo-kpi-label">Tax Liability</div>
                    <div class="ceo-kpi-sublabel">Cyprus CIT @ 12.5%</div>
                    <div class="ceo-kpi-trend" id="ceoTaxTrend">Q4 Due</div>
                </div>
            </div>
            
            <!-- Financial Sections -->
            <div class="ceo-sections-grid">
                
                <!-- Revenue Breakdown -->
                <div class="ceo-section-card">
                    <div class="ceo-section-header">
                        <div class="ceo-section-title">
                            <span>💵</span> Revenue Breakdown
                        </div>
                    </div>
                    <table class="ceo-tax-table">
                        <tbody>
                            <tr>
                                <td>Premium Collections</td>
                                <td class="amount positive" id="ceoPremiumRevenue">$0</td>
                            </tr>
                            <tr>
                                <td>Admin Fees</td>
                                <td class="amount positive" id="ceoAdminFeeRevenue">$0</td>
                            </tr>
                            <tr>
                                <td>Stop-Loss Fees</td>
                                <td class="amount positive" id="ceoStopLossRevenue">$0</td>
                            </tr>
                            <tr>
                                <td>Network Access Fees</td>
                                <td class="amount positive" id="ceoNetworkRevenue">$0</td>
                            </tr>
                            <tr>
                                <td>Claims Processing Fees</td>
                                <td class="amount positive" id="ceoProcessingRevenue">$0</td>
                            </tr>
                            <tr class="total">
                                <td><strong>Total Revenue</strong></td>
                                <td class="amount" id="ceoTotalRevenue">$0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Expense Breakdown -->
                <div class="ceo-section-card">
                    <div class="ceo-section-header">
                        <div class="ceo-section-title">
                            <span>📉</span> Expense Breakdown
                        </div>
                    </div>
                    <table class="ceo-tax-table">
                        <tbody>
                            <tr>
                                <td>Claims Paid (Hospitals)</td>
                                <td class="amount negative" id="ceoClaimsPaid">$0</td>
                            </tr>
                            <tr>
                                <td>Ex Gratia Payments</td>
                                <td class="amount negative" id="ceoExGratia">$0</td>
                            </tr>
                            <tr>
                                <td>Provider Network Costs</td>
                                <td class="amount negative" id="ceoProviderCosts">$0</td>
                            </tr>
                            <tr>
                                <td>Operating Expenses</td>
                                <td class="amount negative" id="ceoOperatingExp">$0</td>
                            </tr>
                            <tr>
                                <td>Bank & Transaction Fees</td>
                                <td class="amount negative" id="ceoBankFees">$0</td>
                            </tr>
                            <tr class="total">
                                <td><strong>Total Expenses</strong></td>
                                <td class="amount" id="ceoTotalExpensesSum">$0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Cyprus Tax Obligations -->
                <div class="ceo-section-card">
                    <div class="ceo-section-header">
                        <div class="ceo-section-title">
                            <span>🇨🇾</span> Cyprus Tax Obligations
                        </div>
                    </div>
                    <table class="ceo-tax-table">
                        <tbody>
                            <tr>
                                <td>Taxable Income (EBIT)</td>
                                <td class="amount" id="ceoTaxableIncome">$0</td>
                            </tr>
                            <tr>
                                <td>Corporate Tax (12.5%)</td>
                                <td class="amount negative" id="ceoCorporateTax">$0</td>
                            </tr>
                            <tr>
                                <td>SDC Contribution (2.65%)</td>
                                <td class="amount negative" id="ceoSDC">$0</td>
                            </tr>
                            <tr>
                                <td>GHS Contribution (2.9%)</td>
                                <td class="amount negative" id="ceoGHS">$0</td>
                            </tr>
                            <tr class="total">
                                <td><strong>Total Tax Liability</strong></td>
                                <td class="amount negative" id="ceoTotalTax">$0</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="ceo-tax-info">
                        <div class="ceo-tax-info-header">
                            <span>⚠️</span> Tax Calendar Reminders
                        </div>
                        <div class="ceo-tax-info-item">
                            <span class="ceo-tax-info-label">Provisional Tax Payment</span>
                            <span class="ceo-tax-info-value" id="ceoProvisionalDue">31 July / 31 Dec</span>
                        </div>
                        <div class="ceo-tax-info-item">
                            <span class="ceo-tax-info-label">Annual Return Due</span>
                            <span class="ceo-tax-info-value" id="ceoAnnualDue">31 March 2026</span>
                        </div>
                        <div class="ceo-tax-info-item">
                            <span class="ceo-tax-info-label">VAT Returns (Quarterly)</span>
                            <span class="ceo-tax-info-value" id="ceoVATDue">10th of following month</span>
                        </div>
                    </div>
                </div>
                
                <!-- Cash Flow Analysis -->
                <div class="ceo-section-card half-width">
                    <div class="ceo-section-header">
                        <div class="ceo-section-title">
                            <span>💸</span> Cash Flow Analysis
                        </div>
                    </div>
                    <div class="ceo-cashflow-bars">
                        <div class="ceo-cashflow-row">
                            <div class="ceo-cashflow-label">Cash Inflows</div>
                            <div class="ceo-cashflow-bar-bg">
                                <div class="ceo-cashflow-bar-fill inflow" id="ceoCashInflowBar" style="width: 0%;">0%</div>
                            </div>
                            <div class="ceo-cashflow-value positive" id="ceoCashInflow">$0</div>
                        </div>
                        <div class="ceo-cashflow-row">
                            <div class="ceo-cashflow-label">Cash Outflows</div>
                            <div class="ceo-cashflow-bar-bg">
                                <div class="ceo-cashflow-bar-fill outflow" id="ceoCashOutflowBar" style="width: 0%;">0%</div>
                            </div>
                            <div class="ceo-cashflow-value negative" id="ceoCashOutflow">$0</div>
                        </div>
                        <div class="ceo-cashflow-row">
                            <div class="ceo-cashflow-label">Net Cash Position</div>
                            <div class="ceo-cashflow-bar-bg">
                                <div class="ceo-cashflow-bar-fill net" id="ceoNetCashBar" style="width: 0%;">0%</div>
                            </div>
                            <div class="ceo-cashflow-value gold" id="ceoNetCash">$0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Key Financial Ratios -->
                <div class="ceo-section-card">
                    <div class="ceo-section-header">
                        <div class="ceo-section-title">
                            <span>📊</span> Key Ratios
                        </div>
                    </div>
                    <div class="ceo-ratio-grid">
                        <div class="ceo-ratio-card" id="ceoGrossMarginCard">
                            <div class="ceo-ratio-value" id="ceoGrossMargin">0%</div>
                            <div class="ceo-ratio-label">Gross Margin</div>
                            <div class="ceo-ratio-target">Target: >30%</div>
                        </div>
                        <div class="ceo-ratio-card" id="ceoLossRatioCard">
                            <div class="ceo-ratio-value" id="ceoLossRatio">0%</div>
                            <div class="ceo-ratio-label">Loss Ratio</div>
                            <div class="ceo-ratio-target">Target: <70%</div>
                        </div>
                        <div class="ceo-ratio-card" id="ceoCombinedRatioCard">
                            <div class="ceo-ratio-value" id="ceoCombinedRatio">0%</div>
                            <div class="ceo-ratio-label">Combined Ratio</div>
                            <div class="ceo-ratio-target">Target: <95%</div>
                        </div>
                        <div class="ceo-ratio-card" id="ceoARPMCard">
                            <div class="ceo-ratio-value" id="ceoARPM">$0</div>
                            <div class="ceo-ratio-label">ARPM</div>
                            <div class="ceo-ratio-target">Avg Rev/Member</div>
                        </div>
                    </div>
                </div>
                
                <!-- Accountant Notes -->
                <div class="ceo-section-card full-width">
                    <div class="ceo-section-header">
                        <div class="ceo-section-title">
                            <span>📋</span> CFO Notes & Action Items
                        </div>
                    </div>
                    <div class="ceo-notes">
                        <div class="ceo-notes-header">
                            <span>💡</span> Key Financial Observations
                        </div>
                        <div class="ceo-notes-item" id="ceoNote1">
                            Connect claims data to generate financial analysis.
                        </div>
                        <div class="ceo-notes-item" id="ceoNote2">
                            No revenue data available.
                        </div>
                        <div class="ceo-notes-item" id="ceoNote3">
                            Tax calculations pending data.
                        </div>
                        <div class="ceo-notes-item" id="ceoNote4">
                            VAT analysis requires transaction data.
                        </div>
                        <div class="ceo-notes-item" id="ceoNote5">
                            Transfer pricing documentation pending.
                        </div>
                    </div>
                </div>
                
            </div>
        </section>
        
        <!-- ═══════════════════════════════════════════════════════════ -->
        <!-- CBMS STATISTICS SECTION -->
        <!-- ═══════════════════════════════════════════════════════════ -->
        <div class="section-divider">
            <span class="section-divider-icon">📋</span>
            <span class="section-divider-text">CBMS REPORT TOTALS</span>
        </div>
        
        <!-- CBMS Summary Stats -->
        <section class="section">
            <h2 class="section-title">📊 Report Summary</h2>
            <div class="cbms-stats-grid">
                <div class="cbms-stat-card">
                    <div class="cbms-stat-icon">🏢</div>
                    <div class="cbms-stat-value" id="cbmsOrganisations">-</div>
                    <div class="cbms-stat-label">Organisations</div>
                </div>
                <div class="cbms-stat-card">
                    <div class="cbms-stat-icon">📋</div>
                    <div class="cbms-stat-value" id="cbmsClaims">-</div>
                    <div class="cbms-stat-label">Total Claims</div>
                </div>
                <div class="cbms-stat-card">
                    <div class="cbms-stat-icon">👥</div>
                    <div class="cbms-stat-value" id="cbmsMembers">-</div>
                    <div class="cbms-stat-label">Total Members</div>
                </div>
                <div class="cbms-stat-card highlight-gold">
                    <div class="cbms-stat-icon">💰</div>
                    <div class="cbms-stat-value" id="cbmsApproved">₱0</div>
                    <div class="cbms-stat-label">Approved Amount</div>
                </div>
                <div class="cbms-stat-card">
                    <div class="cbms-stat-icon">📄</div>
                    <div class="cbms-stat-value" id="cbmsInvoiced">₱0</div>
                    <div class="cbms-stat-label">Invoiced Amount</div>
                </div>
                <div class="cbms-stat-card highlight-green">
                    <div class="cbms-stat-icon">💵</div>
                    <div class="cbms-stat-value" id="cbmsTotalAmount">₱0</div>
                    <div class="cbms-stat-label">Total Amount</div>
                </div>
            </div>
        </section>
        
        <!-- CBMS Financial Details -->
        <section class="section">
            <h2 class="section-title">💳 Financial Breakdown</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">📈 Ex Gratia & Totals</h3>
                    </div>
                    <div class="cbms-detail-grid">
                        <div class="cbms-detail-item">
                            <span class="cbms-detail-label">Ex Gratia</span>
                            <span class="cbms-detail-value" id="cbmsExGratia">₱0</span>
                        </div>
                        <div class="cbms-detail-item">
                            <span class="cbms-detail-label">Total incl Ex Gratia</span>
                            <span class="cbms-detail-value" id="cbmsTotalInclExGratia">₱0</span>
                        </div>
                        <div class="cbms-detail-item">
                            <span class="cbms-detail-label">Average incl ExGr</span>
                            <span class="cbms-detail-value" id="cbmsAvgInclExGr">₱0</span>
                        </div>
                        <div class="cbms-detail-item">
                            <span class="cbms-detail-label">Net Average</span>
                            <span class="cbms-detail-value" id="cbmsNetAvg">₱0</span>
                        </div>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">💰 Per Capita & Payments</h3>
                    </div>
                    <div class="cbms-detail-grid">
                        <div class="cbms-detail-item highlight">
                            <span class="cbms-detail-label">Per Capita</span>
                            <span class="cbms-detail-value gold" id="cbmsPerCapita">₱0</span>
                        </div>
                        <div class="cbms-detail-item">
                            <span class="cbms-detail-label">Paid to HM</span>
                            <span class="cbms-detail-value" id="cbmsPaidToHM">₱0</span>
                        </div>
                        <div class="cbms-detail-item">
                            <span class="cbms-detail-label">Charged to Customer</span>
                            <span class="cbms-detail-value" id="cbmsChargedCustomer">₱0</span>
                        </div>
                        <div class="cbms-detail-item">
                            <span class="cbms-detail-label">Fees to Customer</span>
                            <span class="cbms-detail-value" id="cbmsFeesCustomer">₱0</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- CBMS Total to Customer -->
        <section class="section">
            <div class="cbms-total-banner">
                <div class="cbms-total-label">💎 TOTAL TO CUSTOMER</div>
                <div class="cbms-total-value" id="cbmsTotalToCustomer">₱11,582,437.09</div>
                <div class="cbms-total-subtext">Combined charges and fees billed to customers</div>
            </div>
        </section>
        
        <section class="section">
            <div class="data-table-container">
                <div class="table-header">
                    <h3 class="section-title" style="margin:0">📅 Historical Data</h3>
                    <input type="text" class="table-search" placeholder="Search..." id="tableSearch">
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th><th>Period</th><th>Members</th><th>Claims</th>
                            <th>PHP</th><th>USD</th><th>Cost/Member</th><th>Util %</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable"></tbody>
                </table>
            </div>
        </section>
    </main>
    
    <!-- Email Center Modal -->
    <div class="email-center-modal hidden" id="emailCenterModal">
        <div class="email-center-box">
            <div class="email-center-header">
                <div style="display:flex; align-items:center; gap:1rem;">
                    
                    <h2>📧 Email Center</h2>
                </div>
                <div style="display:flex; gap:0.5rem; align-items:center;">
                    <button class="email-center-close" onclick="closeEmailCenter()">✕</button>
                </div>
            </div>
            <div class="email-center-content">
                <!-- Tabs -->
                <div class="email-tabs">
                    <button class="email-tab active" onclick="switchEmailTab('compose')">✉️ Compose</button>
                    <button class="email-tab" onclick="switchEmailTab('templates')">📝 Templates</button>
                    <button class="email-tab" onclick="switchEmailTab('history')">📋 History</button>
                    <button class="email-tab" onclick="switchEmailTab('bulk')" style="background: linear-gradient(135deg, #ff6b6b, #ee5a5a);">🚀 Bulk Send</button>
                    <button class="email-tab" onclick="switchEmailTab('scheduler')" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2);">⏰ Scheduler</button>
                    <button class="email-tab" onclick="openSendDocsFromEmailCenter()" style="background: linear-gradient(135deg, #d4a843, #c49932);">📨 Send Docs</button>
                </div>
                
                <!-- Compose Tab -->
                <div id="emailTabCompose" class="email-tab-content">
                    <div class="email-form-group">
                        <label>📝 Select Template</label>
                        <select class="email-select" id="emailTemplate" onchange="handleTemplateChange()">
                            <option value="">-- Select a template --</option>
                            <optgroup label="📄 Contract">
                                <option value="contract_01">New Contract Documents</option>
                            </optgroup>
                            <optgroup label="👥 Client Communication">
                                <option value="welcome_01">Welcome New Client</option>
                                <option value="meeting_01">Post-Meeting Follow-up</option>
                            </optgroup>
                            <optgroup label="📋 Follow Up">
                                <option value="renewal_01">Contract Renewal Reminder</option>
                            </optgroup>
                            <optgroup label="💰 Financial">
                                <option value="balance_01">Outstanding Balance</option>
                                <option value="revolving_01">Revolving Fund Alert</option>
                            </optgroup>
                            <optgroup label="🎉 Wishes">
                                <option value="wishes_01">Holiday Wishes</option>
                                <option value="wishes_02">Easter Wishes</option>
                                <option value="wishes_03">Birthday Wishes</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="email-form-group">
                        <label>🏢 Select Client</label>
                        <select class="email-select" id="emailClient" onchange="loadClientContacts()">
                            <option value="">-- Select a client --</option>
                        </select>
                    </div>
                    
                    <!-- Meeting Options - Shows only for meeting_01 template -->
                    <div id="meetingOptionsBox" style="display: none; background: var(--bg-dark); border: 1px solid #9c27b0; border-radius: 10px; padding: 1rem; margin-bottom: 1rem;">
                        <h4 style="color: #9c27b0; margin: 0 0 1rem 0;">🤝 Meeting Follow-up Options</h4>
                        
                        <div class="email-form-group" style="margin-bottom: 1rem;">
                            <label>👋 Greeting Type</label>
                            <select class="email-select" id="meetingGreeting" onchange="updateMeetingPreview()">
                                <option value="personal">👤 Personal (Contact Name)</option>
                                <option value="company">🏢 Company (Client Name + Team)</option>
                                <option value="generic">👥 Generic (Dear All)</option>
                            </select>
                        </div>
                        
                        <div class="email-form-group" style="margin-bottom: 0;">
                            <label>👥 Team Members who attended the meeting</label>
                            <div class="email-recipients-box" id="teamMembersList" style="max-height: 200px;">
                                <p style="color: var(--text-muted); text-align: center; padding: 1rem;">Loading team members...</p>
                            </div>
                            <div class="email-actions" style="margin-top: 0.5rem;">
                                <button class="email-action-btn" onclick="selectAllTeamMembers()">☑️ Select All</button>
                                <button class="email-action-btn" onclick="clearAllTeamMembers()">✖️ Clear All</button>
                                <span style="color: var(--text-muted); font-size: 0.85rem; margin-left: 1rem;" id="teamMemberCount">0 selected</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="email-form-group">
                        <label>👥 Recipients</label>
                        <div class="email-recipients-box" id="emailRecipients">
                            <p style="color: var(--text-muted); text-align: center; padding: 1rem;">
                                Select a client to see available contacts
                            </p>
                        </div>
                        <div class="email-actions">
                            <button class="email-action-btn" onclick="selectAllRecipients()">☑️ Select All</button>
                            <button class="email-action-btn" onclick="selectByRole('Primary')">👤 Primary Only</button>
                            <button class="email-action-btn" onclick="selectByRole('Finance')">💰 Finance</button>
                            <button class="email-action-btn" onclick="selectByRole('Operations')">⚙️ Operations</button>
                            <button class="email-action-btn" onclick="clearAllRecipients()">✖️ Clear All</button>
                        </div>
                    </div>
                    
                    <div class="email-form-group">
                        <label>📌 Subject</label>
                        <input type="text" class="email-input" id="emailSubject" placeholder="Email subject...">
                    </div>
                    
                    <div class="email-form-group">
                        <label>➕ Additional Email (optional)</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="email" class="email-input" id="emailAdditional" placeholder="additional@email.com" style="flex:1;">
                            <button class="email-action-btn" onclick="addAdditionalEmail()" style="padding: 0.8rem 1rem;">Add</button>
                        </div>
                    </div>
                    
                    <div class="email-form-group">
                        <label>📝 Message Preview</label>
                        <div class="email-preview-box" id="emailPreviewBox">
                            <p style="color: #999; text-align: center;">Select a template to see preview</p>
                        </div>
                    </div>
                    
                    <div id="emailStatus"></div>
                    
                    <div class="email-btn-row">
                        <button class="email-btn email-btn-preview" onclick="previewEmail()">👁️ Preview</button>
                        <button class="email-btn email-btn-send" id="emailSendBtn" onclick="sendEmail()" disabled>
                            📤 Send Email
                        </button>
                    </div>
                </div>
                
                <!-- Templates Tab -->
                <div id="emailTabTemplates" class="email-tab-content" style="display:none;">
                    <div class="email-form-group">
                        <label>🔍 Filter by Category</label>
                        <select class="email-select" id="templateFilter" onchange="filterTemplates()">
                            <option value="all">All Templates</option>
                            <option value="contract">📄 Contract</option>
                            <option value="client">👥 Client</option>
                            <option value="finance">💰 Financial</option>
                            <option value="alert">🚨 Alerts</option>
                            <option value="wishes">🎉 Wishes</option>
                        </select>
                    </div>
                    <div id="templatesList">
                        <!-- Templates will be loaded here -->
                    </div>
                </div>
                
                <!-- History Tab -->
                <div id="emailTabHistory" class="email-tab-content" style="display:none;">
                    <div style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #1E3A5F, #2d5a87);">
                                    <th style="padding: 1rem 1.5rem; text-align: left; color: #94A3B8; font-size: 0.85rem; font-weight: 600; text-transform: uppercase;">Date</th>
                                    <th style="padding: 1rem 1.5rem; text-align: left; color: #94A3B8; font-size: 0.85rem; font-weight: 600; text-transform: uppercase;">Client</th>
                                    <th style="padding: 1rem 1.5rem; text-align: left; color: #94A3B8; font-size: 0.85rem; font-weight: 600; text-transform: uppercase;">Subject</th>
                                    <th style="padding: 1rem 1.5rem; text-align: left; color: #94A3B8; font-size: 0.85rem; font-weight: 600; text-transform: uppercase;">Recipients</th>
                                    <th style="padding: 1rem 1.5rem; text-align: left; color: #94A3B8; font-size: 0.85rem; font-weight: 600; text-transform: uppercase;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="emailHistoryBody">
                                <tr>
                                    <td colspan="5" style="padding: 2rem; text-align: center; color: var(--text-muted);">
                                        Loading email history...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Bulk Send Tab -->
                <div id="emailTabBulk" class="email-tab-content" style="display:none;">
                    <div style="background: linear-gradient(135deg, #ff6b6b22, #ee5a5a11); border: 1px solid #ff6b6b; border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="color: #ff6b6b; margin: 0 0 0.5rem 0;">🚀 Bulk Send - Αποστολή σε ΟΛΟΥΣ τους Clients</h3>
                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.9rem;">Στείλε το ίδιο email σε όλους τους clients με ένα click!</p>
                    </div>
                    
                    <div class="email-form-group">
                        <label>📝 Select Template</label>
                        <select class="email-select" id="bulkTemplate" onchange="handleBulkTemplateChange()">
                            <option value="">-- Select a template --</option>
                            <optgroup label="🎉 Wishes (Προτείνεται για Bulk)">
                                <option value="wishes_01">Holiday Wishes</option>
                                <option value="wishes_02">Easter Wishes</option>
                                <option value="wishes_03">Birthday Wishes</option>
                            </optgroup>
                            <optgroup label="📄 Contract">
                                <option value="contract_01">New Contract Documents</option>
                                <option value="renewal_01">Contract Renewal Reminder</option>
                            </optgroup>
                            <optgroup label="👥 Client Communication">
                                <option value="welcome_01">Welcome New Client</option>
                                <option value="meeting_01">Post-Meeting Follow-up</option>
                            </optgroup>
                            <optgroup label="💰 Financial">
                                <option value="balance_01">Outstanding Balance</option>
                                <option value="revolving_01">Revolving Fund Alert</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="email-form-group">
                        <label>👥 Select Recipients Role</label>
                        <select class="email-select" id="bulkRole">
                            <option value="Primary">Primary Contacts Only (1 per client)</option>
                            <option value="All">All Contacts (2-3 per client)</option>
                            <option value="Finance">Finance Contacts Only</option>
                            <option value="Operations">Operations Contacts Only</option>
                        </select>
                    </div>
                    
                    <div class="email-form-group">
                        <label>🏢 Select Clients</label>
                        <div class="email-recipients-box" id="bulkClientsList" style="max-height: 200px;">
                            <!-- Will be populated with all clients -->
                        </div>
                        <div class="email-actions">
                            <button class="email-action-btn" onclick="selectAllBulkClients()">☑️ Select All</button>
                            <button class="email-action-btn" onclick="clearAllBulkClients()">✖️ Clear All</button>
                            <span style="color: var(--text-muted); font-size: 0.85rem; margin-left: 1rem;" id="bulkClientCount">0 clients selected</span>
                        </div>
                    </div>
                    
                    <div class="email-form-group">
                        <label>📌 Subject (θα προσαρμοστεί για κάθε client)</label>
                        <input type="text" class="email-input" id="bulkSubject" placeholder="Email subject..." readonly>
                    </div>
                    
                    <div id="bulkStatus"></div>
                    
                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 10px; padding: 1rem; margin: 1rem 0;">
                        <p style="margin: 0; color: #856404; font-size: 0.9rem;">
                            ⚠️ <strong>Προσοχή:</strong> Θα σταλούν <span id="bulkTotalEmails">0</span> emails. 
                            Κάθε email θα προσαρμοστεί αυτόματα με τα στοιχεία του κάθε client.
                        </p>
                    </div>
                    
                    <div class="email-btn-row">
                        <button class="email-btn email-btn-preview" onclick="previewBulkEmail()">👁️ Preview Sample</button>
                        <button class="email-btn email-btn-send" id="bulkSendBtn" onclick="sendBulkEmail()" disabled style="background: linear-gradient(135deg, #ff6b6b, #ee5a5a);">
                            🚀 Send to ALL Selected
                        </button>
                    </div>
                </div>
                
                <!-- Scheduler Tab -->
                <div id="emailTabScheduler" class="email-tab-content" style="display:none;">
                    <div style="background: linear-gradient(135deg, #9c27b022, #7b1fa211); border: 1px solid #9c27b0; border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="color: #9c27b0; margin: 0 0 0.5rem 0;">⏰ Email Scheduler</h3>
                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.9rem;">Προγραμμάτισε emails για αποστολή σε συγκεκριμένη ημερομηνία και ώρα</p>
                    </div>
                    
                    <!-- Schedule New Email -->
                    <div style="background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h4 style="color: var(--text-primary); margin: 0 0 1rem 0;">➕ Νέο Προγραμματισμένο Email</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="email-form-group" style="margin-bottom: 0;">
                                <label>📝 Template</label>
                                <select class="email-select" id="scheduleTemplate">
                                    <option value="">-- Select template --</option>
                                    <optgroup label="🎉 Wishes">
                                        <option value="wishes_01">Holiday Wishes</option>
                                        <option value="wishes_02">Easter Wishes</option>
                                        <option value="wishes_03">Birthday Wishes</option>
                                    </optgroup>
                                    <optgroup label="📄 Contract">
                                        <option value="contract_01">New Contract Documents</option>
                                        <option value="renewal_01">Contract Renewal Reminder</option>
                                    </optgroup>
                                    <optgroup label="👥 Client Communication">
                                        <option value="welcome_01">Welcome New Client</option>
                                        <option value="meeting_01">Post-Meeting Follow-up</option>
                                    </optgroup>
                                    <optgroup label="💰 Financial">
                                        <option value="balance_01">Outstanding Balance</option>
                                        <option value="revolving_01">Revolving Fund Alert</option>
                                    </optgroup>
                                </select>
                            </div>
                            
                            <div class="email-form-group" style="margin-bottom: 0;">
                                <label>🏢 Client</label>
                                <select class="email-select" id="scheduleClient" onchange="loadSchedulerContacts()">
                                    <option value="">-- Select client --</option>
                                    <option value="ALL">📢 ALL CLIENTS</option>
                                </select>
                            </div>
                            
                            <div class="email-form-group" style="margin-bottom: 0;">
                                <label>📅 Ημερομηνία</label>
                                <input type="date" class="email-input" id="scheduleDate">
                            </div>
                            
                            <div class="email-form-group" style="margin-bottom: 0;">
                                <label>🕐 Ώρα</label>
                                <input type="time" class="email-input" id="scheduleTime" value="09:00">
                            </div>
                        </div>
                        
                        <!-- Contacts Selection Box -->
                        <div id="scheduleContactsBox" style="display: none; margin-top: 1rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 10px; padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <label style="color: var(--text-primary); font-weight: 600;">👥 Επιλογή Recipients</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="email-action-btn" onclick="selectAllScheduleContacts()">☑️ All</button>
                                    <button class="email-action-btn" onclick="selectScheduleByRole('Primary')">👤 Primary</button>
                                    <button class="email-action-btn" onclick="selectScheduleByRole('Finance')">💰 Finance</button>
                                    <button class="email-action-btn" onclick="selectScheduleByRole('Operations')">⚙️ Ops</button>
                                    <button class="email-action-btn" onclick="clearAllScheduleContacts()">✖️ Clear</button>
                                </div>
                            </div>
                            <div class="email-recipients-box" id="scheduleContactsList" style="max-height: 200px;">
                                <!-- Contacts will be loaded here -->
                            </div>
                            <div style="margin-top: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">
                                <span id="scheduleContactCount">0</span> contacts selected
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div class="email-form-group" style="margin-bottom: 0;">
                                <label>📝 Notes (optional)</label>
                                <input type="text" class="email-input" id="scheduleNotes" placeholder="Add a note...">
                            </div>
                            <div></div>
                        </div>
                        
                        <div id="scheduleStatus" style="margin-top: 1rem;"></div>
                        
                        <div style="margin-top: 1rem; text-align: right;">
                            <button class="email-btn" onclick="addScheduledEmail()" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2); color: white;">
                                ➕ Schedule Email
                            </button>
                        </div>
                    </div>
                    
                    <!-- Scheduled Emails List -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="color: var(--text-primary); margin: 0;">📋 Προγραμματισμένα Emails</h4>
                            <button class="email-action-btn" onclick="loadScheduledEmails()">🔄 Refresh</button>
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: var(--bg-dark);">
                                        <th style="padding: 0.75rem; text-align: left; color: var(--text-secondary);">📅 Date/Time</th>
                                        <th style="padding: 0.75rem; text-align: left; color: var(--text-secondary);">🏢 Client</th>
                                        <th style="padding: 0.75rem; text-align: left; color: var(--text-secondary);">📝 Template</th>
                                        <th style="padding: 0.75rem; text-align: left; color: var(--text-secondary);">👥 Role</th>
                                        <th style="padding: 0.75rem; text-align: left; color: var(--text-secondary);">Status</th>
                                        <th style="padding: 0.75rem; text-align: center; color: var(--text-secondary);">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="scheduledEmailsBody">
                                    <tr>
                                        <td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-muted);">
                                            Loading scheduled emails...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Send Documents Tab -->
                <div id="emailTabSenddocs" class="email-tab-content" style="display:none;">
                    <div style="background: linear-gradient(135deg, #d4a84322, #c4993211); border: 1px solid #d4a843; border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="color: #d4a843; margin: 0 0 0.5rem 0;">📨 Send Documents to Client</h3>
                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.9rem;">Επίλεξε client, έγγραφα και programs για αποστολή μέσω email</p>
                    </div>
                    
                    <!-- Two Column Layout -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        
                        <!-- LEFT COLUMN -->
                        <div>
                            <!-- Client Search Section -->
                            <div style="background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 10px; padding: 1.25rem; margin-bottom: 1rem;">
                                <h4 style="color: #d4a843; margin: 0 0 1rem 0;">🔍 Search Client</h4>
                                <div class="email-form-group" style="margin-bottom: 0;">
                                    <div style="position: relative;">
                                        <input type="text" class="email-input" id="sendDocsClientSearch" 
                                               placeholder="Type to search clients..." 
                                               onkeyup="searchSendDocsClients(this.value)"
                                               autocomplete="off"
                                               style="padding-right: 40px;">
                                        <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);">🔍</span>
                                    </div>
                                    <div id="sendDocsClientDropdown" style="display: none; position: absolute; z-index: 100; width: calc(100% - 2.5rem); max-height: 250px; overflow-y: auto; background: var(--bg-card); border: 1px solid #d4a843; border-radius: 8px; margin-top: 4px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
                                        <!-- Search results will appear here -->
                                    </div>
                                </div>
                                <!-- Selected Client Display -->
                                <div id="sendDocsSelectedClient" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(212,175,67,0.1); border: 1px solid #d4a843; border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="color: #d4a843; font-weight: 600; font-size: 1.1rem;" id="sendDocsClientName">Client Name</div>
                                            <div style="color: var(--text-muted); font-size: 0.85rem;" id="sendDocsClientEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="9efbf3fff7f2defdf2f7fbf0eab0fdf1f3">[email&#160;protected]</a></div>
                                        </div>
                                        <button onclick="clearSendDocsClient()" style="background: rgba(231,76,60,0.2); border: none; color: #e74c3c; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">✕ Clear</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Contract Documents Section -->
                            <div style="background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 10px; padding: 1.25rem; margin-bottom: 1rem;">
                                <h4 style="color: var(--text-primary); margin: 0 0 1rem 0;">📄 Contract Documents</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                    <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#d4a843'" onmouseout="this.style.borderColor=this.querySelector('input').checked?'#4CAF50':'var(--border-color)'" onclick="this.style.borderColor=this.querySelector('input').checked?'var(--border-color)':'#4CAF50'">
                                        <input type="checkbox" name="emailDoc" value="NDA" onchange="updateSendDocsEmailCount()" style="width: 20px; height: 20px; accent-color: #4CAF50;">
                                        <div><div style="color: white; font-weight: 600;">🔒 NDA</div><div style="color: var(--text-muted); font-size: 0.75rem;">Non-Disclosure</div></div>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#d4a843'" onmouseout="this.style.borderColor=this.querySelector('input').checked?'#4CAF50':'var(--border-color)'" onclick="this.style.borderColor=this.querySelector('input').checked?'var(--border-color)':'#4CAF50'">
                                        <input type="checkbox" name="emailDoc" value="DPA" onchange="updateSendDocsEmailCount()" style="width: 20px; height: 20px; accent-color: #4CAF50;">
                                        <div><div style="color: white; font-weight: 600;">🛡️ DPA</div><div style="color: var(--text-muted); font-size: 0.75rem;">Data Processing</div></div>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#d4a843'" onmouseout="this.style.borderColor=this.querySelector('input').checked?'#4CAF50':'var(--border-color)'" onclick="this.style.borderColor=this.querySelector('input').checked?'var(--border-color)':'#4CAF50'">
                                        <input type="checkbox" name="emailDoc" value="ASA" onchange="updateSendDocsEmailCount()" style="width: 20px; height: 20px; accent-color: #4CAF50;">
                                        <div><div style="color: white; font-weight: 600;">📋 ASA</div><div style="color: var(--text-muted); font-size: 0.75rem;">Admin Services</div></div>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#d4a843'" onmouseout="this.style.borderColor=this.querySelector('input').checked?'#4CAF50':'var(--border-color)'" onclick="this.style.borderColor=this.querySelector('input').checked?'var(--border-color)':'#4CAF50'">
                                        <input type="checkbox" name="emailDoc" value="PROPOSAL" onchange="updateSendDocsEmailCount()" style="width: 20px; height: 20px; accent-color: #4CAF50;">
                                        <div><div style="color: white; font-weight: 600;">💼 Proposal</div><div style="color: var(--text-muted); font-size: 0.75rem;">TPA Services</div></div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Program Brochures Section -->
                            <div style="background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 10px; padding: 1.25rem; margin-bottom: 1rem;">
                                <h4 style="color: var(--text-primary); margin: 0 0 1rem 0;">📋 Program Brochures</h4>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">
                                    <label style="display: flex; flex-direction: column; align-items: center; padding: 10px 6px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center;" class="program-brochure-item">
                                        <input type="checkbox" name="emailProg" value="Silver" onchange="updateSendDocsEmailCount()" style="width: 18px; height: 18px; accent-color: #4CAF50; margin-bottom: 6px;">
                                        <span style="font-size: 1.5rem;">🥈</span>
                                        <span style="color: white; font-size: 0.8rem; font-weight: 600;">Silver</span>
                                    </label>
                                    <label style="display: flex; flex-direction: column; align-items: center; padding: 10px 6px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center;" class="program-brochure-item">
                                        <input type="checkbox" name="emailProg" value="Gold" onchange="updateSendDocsEmailCount()" style="width: 18px; height: 18px; accent-color: #4CAF50; margin-bottom: 6px;">
                                        <span style="font-size: 1.5rem;">🥇</span>
                                        <span style="color: white; font-size: 0.8rem; font-weight: 600;">Gold</span>
                                    </label>
                                    <label style="display: flex; flex-direction: column; align-items: center; padding: 10px 6px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center;" class="program-brochure-item">
                                        <input type="checkbox" name="emailProg" value="Gold Plus" onchange="updateSendDocsEmailCount()" style="width: 18px; height: 18px; accent-color: #4CAF50; margin-bottom: 6px;">
                                        <span style="font-size: 1.5rem;">🥇+</span>
                                        <span style="color: white; font-size: 0.8rem; font-weight: 600;">Gold+</span>
                                    </label>
                                    <label style="display: flex; flex-direction: column; align-items: center; padding: 10px 6px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center;" class="program-brochure-item">
                                        <input type="checkbox" name="emailProg" value="Gold Plus Plus" onchange="updateSendDocsEmailCount()" style="width: 18px; height: 18px; accent-color: #4CAF50; margin-bottom: 6px;">
                                        <span style="font-size: 1.5rem;">🥇++</span>
                                        <span style="color: white; font-size: 0.8rem; font-weight: 600;">Gold++</span>
                                    </label>
                                    <label style="display: flex; flex-direction: column; align-items: center; padding: 10px 6px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center;" class="program-brochure-item">
                                        <input type="checkbox" name="emailProg" value="Platinum" onchange="updateSendDocsEmailCount()" style="width: 18px; height: 18px; accent-color: #4CAF50; margin-bottom: 6px;">
                                        <span style="font-size: 1.5rem;">💎</span>
                                        <span style="color: white; font-size: 0.8rem; font-weight: 600;">Platinum</span>
                                    </label>
                                    <label style="display: flex; flex-direction: column; align-items: center; padding: 10px 6px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center;" class="program-brochure-item">
                                        <input type="checkbox" name="emailProg" value="Diamond" onchange="updateSendDocsEmailCount()" style="width: 18px; height: 18px; accent-color: #4CAF50; margin-bottom: 6px;">
                                        <span style="font-size: 1.5rem;">💠</span>
                                        <span style="color: white; font-size: 0.8rem; font-weight: 600;">Diamond</span>
                                    </label>
                                    <label style="display: flex; flex-direction: column; align-items: center; padding: 10px 6px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center;" class="program-brochure-item">
                                        <input type="checkbox" name="emailProg" value="Dental" onchange="updateSendDocsEmailCount()" style="width: 18px; height: 18px; accent-color: #4CAF50; margin-bottom: 6px;">
                                        <span style="font-size: 1.5rem;">🦷</span>
                                        <span style="color: white; font-size: 0.8rem; font-weight: 600;">Dental</span>
                                    </label>
                                    <!-- Other/Custom - Split into Drive and Local -->
                                    <div style="display: flex; flex-direction: row; background: linear-gradient(135deg, rgba(212,175,55,0.15), rgba(212,175,55,0.05)); border: 2px dashed #d4af37; border-radius: 8px; overflow: hidden;" class="program-brochure-item split-item-small">
                                        <div onclick="openDriveFolder(event)" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px 4px; cursor: pointer; border-right: 1px solid rgba(212,175,55,0.3); transition: all 0.2s;" class="split-btn-small">
                                            <span style="font-size: 1.3rem;">☁️</span>
                                            <span style="color: #d4af37; font-size: 0.65rem; font-weight: 600;">Drive</span>
                                        </div>
                                        <div onclick="openLocalFiles(event)" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px 4px; cursor: pointer; transition: all 0.2s;" class="split-btn-small">
                                            <span style="font-size: 1.3rem;">💻</span>
                                            <span style="color: #d4af37; font-size: 0.65rem; font-weight: 600;">Local</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Signature Options -->
                            <div style="background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 10px; padding: 1.25rem;">
                                <h4 style="color: var(--text-primary); margin: 0 0 1rem 0;">✍️ Signature Options</h4>
                                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 10px; padding: 10px 16px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer;">
                                        <input type="checkbox" id="emailDocsSignCheck" onchange="toggleEmailDocsSignature()" style="width: 20px; height: 20px; accent-color: #9c27b0;">
                                        <span style="color: white; font-weight: 600;">Sign Documents</span>
                                    </label>
                                    <select id="emailDocsSignatory" disabled style="flex: 1; padding: 10px 14px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 8px; color: white; font-size: 0.95rem;">
                                        <option value="">-- Select Signatory --</option>
                                        <option value="apostolos_kagelaris">Apostolos Kagelaris (CEO)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- RIGHT COLUMN -->
                        <div>
                            <!-- Recipients Section -->
                            <div style="background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 10px; padding: 1.25rem; margin-bottom: 1rem;">
                                <h4 style="color: var(--text-primary); margin: 0 0 1rem 0;">👥 Recipients</h4>
                                <div class="email-recipients-box" id="emailDocsRecipients" style="min-height: 100px; max-height: 150px;">
                                    <p style="color: var(--text-muted); text-align: center; padding: 1.5rem;">
                                        🔍 Search and select a client first
                                    </p>
                                </div>
                                <div style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;">
                                    <button onclick="selectAllEmailDocsRecipients()" class="email-action-btn">☑️ All</button>
                                    <button onclick="selectEmailDocsRecipientsByRole('Primary')" class="email-action-btn">👤 Primary</button>
                                    <button onclick="selectEmailDocsRecipientsByRole('Finance')" class="email-action-btn">💰 Finance</button>
                                    <button onclick="clearAllEmailDocsRecipients()" class="email-action-btn">✖️ Clear</button>
                                </div>
                            </div>
                            
                            <!-- Email Template Section -->
                            <div style="background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 10px; padding: 1.25rem; margin-bottom: 1rem;">
                                <h4 style="color: var(--text-primary); margin: 0 0 1rem 0;">📝 Email Template</h4>
                                <select class="email-select" id="emailDocsTemplate" onchange="updateEmailDocsPreview()">
                                    <option value="">-- Select Template --</option>
                                    <optgroup label="📄 Document Delivery">
                                        <option value="initial_contact">Initial Contact (NDA)</option>
                                        <option value="proposal_submission">Proposal Submission</option>
                                        <option value="contract_documents">Contract Documents (DPA + ASA)</option>
                                        <option value="program_info">Program Information Only</option>
                                        <option value="full_package">Full Package Delivery</option>
                                    </optgroup>
                                    <optgroup label="📋 Follow-up">
                                        <option value="followup_nda">Follow-up: NDA Signed?</option>
                                        <option value="followup_proposal">Follow-up: Proposal Review</option>
                                        <option value="followup_decision">Follow-up: Decision Pending</option>
                                    </optgroup>
                                </select>
                            </div>
                            
                            <!-- Email Body (Editable) -->
                            <div style="background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 10px; padding: 1.25rem; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h4 style="color: var(--text-primary); margin: 0;">✏️ Email Body</h4>
                                    <span style="font-size: 0.75rem; color: #4CAF50; background: rgba(76,175,80,0.2); padding: 4px 10px; border-radius: 10px;">✎ Editable</span>
                                </div>
                                <!-- Mini Toolbar -->
                                <div style="display: flex; gap: 6px; margin-bottom: 8px; padding: 8px; background: var(--bg-card); border-radius: 6px;">
                                    <button onclick="formatEmailDocsText('bold')" style="padding: 6px 10px; background: var(--border-color); border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: bold;">B</button>
                                    <button onclick="formatEmailDocsText('italic')" style="padding: 6px 10px; background: var(--border-color); border: none; border-radius: 4px; color: white; cursor: pointer; font-style: italic;">I</button>
                                    <button onclick="formatEmailDocsText('underline')" style="padding: 6px 10px; background: var(--border-color); border: none; border-radius: 4px; color: white; cursor: pointer; text-decoration: underline;">U</button>
                                    <button onclick="formatEmailDocsText('insertUnorderedList')" style="padding: 6px 10px; background: var(--border-color); border: none; border-radius: 4px; color: white; cursor: pointer;">• List</button>
                                    <button onclick="resetEmailDocsTemplate()" style="padding: 6px 10px; background: #e74c3c; border: none; border-radius: 4px; color: white; cursor: pointer; margin-left: auto;">↺ Reset</button>
                                </div>
                                <div id="emailDocsPreview" contenteditable="true" style="background: #ffffff; border-radius: 8px; padding: 1rem; color: #333; min-height: 180px; max-height: 250px; overflow-y: auto; cursor: text; outline: none; border: 2px solid transparent;" onfocus="this.style.borderColor='#1976D2'" onblur="this.style.borderColor='transparent'">
                                    <p style="color: #999; text-align: center;">Select a template to see preview</p>
                                </div>
                            </div>
                            
                            <!-- Status & Actions -->
                            <div id="emailDocsStatus" style="margin-bottom: 1rem;"></div>
                            
                            <div style="background: linear-gradient(135deg, #1e3a5f, #2d5a87); border-radius: 10px; padding: 1.25rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <span style="color: #4CAF50; font-weight: 600;" id="emailDocsAttachCount">📎 0 attachments selected</span>
                                </div>
                                <div style="display: flex; gap: 1rem;">
                                    <button onclick="saveEmailDocsDraft()" style="flex: 1; padding: 14px 20px; background: linear-gradient(135deg, #f39c12, #e67e22); border: none; border-radius: 8px; color: white; font-weight: 700; cursor: pointer; font-size: 1rem;">
                                        💾 Save Draft
                                    </button>
                                    <button onclick="sendEmailDocs()" id="emailDocsSendBtn" disabled style="flex: 1; padding: 14px 20px; background: linear-gradient(135deg, #27ae60, #2ecc71); border: none; border-radius: 8px; color: white; font-weight: 700; cursor: pointer; font-size: 1rem; opacity: 0.5;">
                                        📨 Send Documents
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="contract-center-modal hidden" id="contractCenterModal">
        <div class="contract-center-box">
            <div class="contract-center-header">
                <div style="display:flex; align-items:center; gap:1rem;">
                    <span style="font-size:1.5rem;">✦</span>
                    <h2>📄 Contract <span>Center</span></h2>
                </div>
                <div style="display:flex; gap:0.5rem; align-items:center;">
                    <button class="contract-center-close" onclick="closeContractCenter()">✕</button>
                </div>
            </div>
            <div class="contract-center-content">
                
                <!-- Main Contract List View -->
                <div id="contractMainView">
                    <!-- KPI Stats -->
                    <div class="contract-kpi-grid">
                        <div class="contract-kpi-card">
                            <div class="contract-kpi-icon">📊</div>
                            <div class="contract-kpi-value" id="contractKpiTotal">0</div>
                            <div class="contract-kpi-label">Total Contracts</div>
                        </div>
                        <div class="contract-kpi-card success">
                            <div class="contract-kpi-icon">✅</div>
                            <div class="contract-kpi-value" id="contractKpiActive">0</div>
                            <div class="contract-kpi-label">Active</div>
                            <div class="contract-kpi-trend up">↑ Running</div>
                        </div>
                        <div class="contract-kpi-card info">
                            <div class="contract-kpi-icon">✍️</div>
                            <div class="contract-kpi-value" id="contractKpiSigned">0</div>
                            <div class="contract-kpi-label">Signed</div>
                        </div>
                        <div class="contract-kpi-card">
                            <div class="contract-kpi-icon">📤</div>
                            <div class="contract-kpi-value" id="contractKpiSent">0</div>
                            <div class="contract-kpi-label">Sent</div>
                        </div>
                        <div class="contract-kpi-card">
                            <div class="contract-kpi-icon">📝</div>
                            <div class="contract-kpi-value" id="contractKpiDraft">0</div>
                            <div class="contract-kpi-label">Draft</div>
                        </div>
                        <div class="contract-kpi-card warning">
                            <div class="contract-kpi-icon">⚠️</div>
                            <div class="contract-kpi-value" id="contractKpiExpiring">0</div>
                            <div class="contract-kpi-label">Expiring Soon</div>
                            <div class="contract-kpi-trend down">Action Needed</div>
                        </div>
                    </div>
                    
                    <!-- Tabs -->
                    <div class="contract-tabs-nav">
                        <button class="contract-tab-btn active" onclick="switchContractTab('list')">
                            📋 All Contracts
                        </button>
                        <button class="contract-tab-btn" onclick="switchContractTab('active')">
                            ✅ Active <span class="badge" id="activeContractsBadge">0</span>
                        </button>
                        <button class="contract-tab-btn" onclick="switchContractTab('expiring')">
                            ⚠️ Expiring <span class="badge" id="expiringContractsBadge">0</span>
                        </button>
                        <button class="contract-tab-btn" onclick="closeContractCenter(); setTimeout(() => openOffersCenter(), 200);" style="background: linear-gradient(135deg, #d4a843, #c49932); color: #1e3a5f;">
                            📝 Proposals & Offers
                        </button>
                        <button class="contract-tab-btn" onclick="switchContractTab('templates')">
                            📁 Templates
                        </button>
                    </div>
                    
                    <!-- Tab: All Contracts -->
                    <div id="contractTabList" class="contract-tab-content">
                        <!-- Filters -->
                        <div class="contract-filter-bar">
                            <div class="contract-filter-group">
                                <label>Status</label>
                                <select id="contractFilterStatus" onchange="filterContracts()">
                                    <option value="">All Status</option>
                                    <option value="active">✅ Active</option>
                                    <option value="signed">✍️ Signed</option>
                                    <option value="sent">📤 Sent</option>
                                    <option value="draft">📝 Draft</option>
                                    <option value="expired">❌ Expired</option>
                                    <option value="No Contract">🚫 No Contract</option>
                                </select>
                            </div>
                            <div class="contract-filter-group">
                                <label>Type</label>
                                <select id="contractFilterType" onchange="filterContracts()">
                                    <option value="">All Types</option>
                                    <option value="ASA">ASA - Service Agreement</option>
                                    <option value="NDA">NDA - Non-Disclosure</option>
                                    <option value="DPA">DPA - Data Protection</option>
                                </select>
                            </div>
                            <div class="contract-filter-group">
                                <label>Client</label>
                                <select id="contractFilterClient" onchange="filterContracts()">
                                    <option value="">All Clients</option>
                                </select>
                            </div>
                            <div class="contract-filter-group">
                                <label>Date Range</label>
                                <select id="contractFilterDate" onchange="filterContracts()">
                                    <option value="">All Time</option>
                                    <option value="30">Last 30 Days</option>
                                    <option value="90">Last 90 Days</option>
                                    <option value="365">This Year</option>
                                </select>
                            </div>
                            <div class="contract-filter-group" style="flex: 2;">
                                <label>Search</label>
                                <input type="text" id="contractFilterSearch" placeholder="🔍 Search contracts..." onkeyup="filterContracts()">
                            </div>
                            <button class="contract-filter-btn clear" onclick="clearContractFilters()">✖ Clear</button>
                        </div>
                        
                        <!-- Results Count -->
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                            <span style="color:rgba(255,255,255,0.6); font-size:0.9rem;" id="contractResultCount">Showing all contracts</span>
                            <div style="display:flex; gap:0.5rem;">
                                <button onclick="exportContractsExcel()" style="padding:0.4rem 0.8rem; background:rgba(39,174,96,0.2); color:#27ae60; border:none; border-radius:6px; cursor:pointer; font-size:0.8rem;">📊 Export</button>
                            </div>
                        </div>
                        
                        <!-- Table -->
                        <div class="contract-table-wrapper">
                            <table class="contract-table">
                                <thead>
                                    <tr>
                                        <th>Client</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Version</th>
                                        <th>Created</th>
                                        <th>Expiry</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="contractTableBody">
                                    <tr><td colspan="7" style="text-align:center;padding:2rem;color:rgba(255,255,255,0.5);">Loading contracts...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Tab: Templates -->
                    <div id="contractTabTemplates" class="contract-tab-content" style="display:none;">
                        <div style="background:rgba(0,0,0,0.2); border-radius:16px; padding:2rem; text-align:center;">
                            <div style="font-size:3rem; margin-bottom:1rem;">📁</div>
                            <h3 style="color:var(--polaris-gold); margin-bottom:0.5rem;">Contract Templates</h3>
                            <p style="color:rgba(255,255,255,0.6); margin-bottom:1.5rem;">Master templates for generating contracts</p>
                            <div id="templatesListContainer"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Client Folder View (Hidden by default) -->
                <div class="client-folder-view" id="clientFolderView">
                    <button class="client-folder-back" onclick="closeClientFolder()">
                        ← Back to Contracts
                    </button>
                    
                    <!-- Client Header -->
                    <div class="client-folder-header">
                        <div class="client-folder-info">
                            <div class="client-folder-avatar" id="clientFolderAvatar">DS</div>
                            <div class="client-folder-details">
                                <h2 id="clientFolderName">Client Name <span>Portfolio</span></h2>
                                <div class="client-folder-meta">
                                    <span>📅 Client since: <strong id="clientFolderSince">2020</strong></span>
                                    <span>👥 Members: <strong id="clientFolderMembers">450</strong></span>
                                    <span>📄 Contracts: <strong id="clientFolderContracts">3</strong></span>
                                </div>
                            </div>
                        </div>
                        <div class="client-folder-actions">
                            <button class="client-folder-btn secondary" onclick="openClientGoogleFolder()">📁 Google Drive</button>
                            <button class="client-folder-btn secondary" onclick="emailClient()">📧 Email</button>
                            <button class="client-folder-btn primary" onclick="createNewContractForClient()">➕ New Contract</button>
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="client-quick-stats">
                        <div class="client-quick-stat">
                            <div class="client-quick-stat-icon">👥</div>
                            <div class="client-quick-stat-value" id="cfStatMembers">0</div>
                            <div class="client-quick-stat-label">Total Members</div>
                        </div>
                        <div class="client-quick-stat">
                            <div class="client-quick-stat-icon">📋</div>
                            <div class="client-quick-stat-value" id="cfStatClaims">0</div>
                            <div class="client-quick-stat-label">Total Claims</div>
                        </div>
                        <div class="client-quick-stat">
                            <div class="client-quick-stat-icon">💰</div>
                            <div class="client-quick-stat-value" id="cfStatApproved">$0</div>
                            <div class="client-quick-stat-label">Approved Amount</div>
                        </div>
                        <div class="client-quick-stat">
                            <div class="client-quick-stat-icon">📊</div>
                            <div class="client-quick-stat-value" id="cfStatUtilization">0%</div>
                            <div class="client-quick-stat-label">Utilization</div>
                        </div>
                        <div class="client-quick-stat">
                            <div class="client-quick-stat-icon">💵</div>
                            <div class="client-quick-stat-value" id="cfStatCostPerMember">$0</div>
                            <div class="client-quick-stat-label">Cost/Member</div>
                        </div>
                    </div>
                    
                    <!-- Analytics Grid -->
                    <div class="client-analytics-grid">
                        
                        <!-- Inpatient vs Outpatient -->
                        <div class="client-analytics-section">
                            <div class="client-section-header">
                                <div class="client-section-title">🏥 Inpatient vs Outpatient</div>
                            </div>
                            <div class="client-comparison-bars" id="cfInOutAnalysis">
                                <div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.5);">
                                    <div style="font-size:2rem;margin-bottom:0.5rem;">📊</div>
                                    No claims data available
                                </div>
                            </div>
                        </div>
                        
                        <!-- Principal vs Dependent -->
                        <div class="client-analytics-section">
                            <div class="client-section-header">
                                <div class="client-section-title">👤 Principal vs Dependent</div>
                            </div>
                            <div class="client-comparison-bars" id="cfPrincipalDependent">
                                <div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.5);">
                                    <div style="font-size:2rem;margin-bottom:0.5rem;">👥</div>
                                    No member data available
                                </div>
                            </div>
                        </div>
                        
                        <!-- Financial Breakdown -->
                        <div class="client-analytics-section">
                            <div class="client-section-header">
                                <div class="client-section-title">💰 Financial Breakdown</div>
                            </div>
                            <div class="client-financial-grid" id="cfFinancials">
                                <div class="client-financial-item green">
                                    <div class="client-financial-value" id="cfTotalPremium">$0</div>
                                    <div class="client-financial-label">Total Premium</div>
                                </div>
                                <div class="client-financial-item blue">
                                    <div class="client-financial-value" id="cfTotalClaims">$0</div>
                                    <div class="client-financial-label">Total Claims</div>
                                </div>
                                <div class="client-financial-item orange">
                                    <div class="client-financial-value" id="cfAdminFees">$0</div>
                                    <div class="client-financial-label">Admin Fees</div>
                                </div>
                                <div class="client-financial-item red">
                                    <div class="client-financial-value" id="cfLossRatio">0%</div>
                                    <div class="client-financial-label">Loss Ratio</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Year over Year -->
                        <div class="client-analytics-section">
                            <div class="client-section-header">
                                <div class="client-section-title">📈 Year-over-Year</div>
                            </div>
                            <div class="client-yoy-grid" id="cfYoY">
                                <div style="grid-column:span 3;text-align:center;padding:2rem;color:rgba(255,255,255,0.5);">
                                    <div style="font-size:2rem;margin-bottom:0.5rem;">📈</div>
                                    No historical data available
                                </div>
                            </div>
                        </div>
                        
                        <!-- Top Hospitals -->
                        <div class="client-analytics-section">
                            <div class="client-section-header">
                                <div class="client-section-title">🏥 Top Hospitals & Providers</div>
                            </div>
                            <div class="client-provider-cards" id="cfTopProviders">
                                <div style="grid-column:span 2;text-align:center;padding:2rem;color:rgba(255,255,255,0.5);">
                                    <div style="font-size:2rem;margin-bottom:0.5rem;">🏥</div>
                                    No provider data available
                                </div>
                            </div>
                        </div>
                        
                        <!-- Claims by Category -->
                        <div class="client-analytics-section">
                            <div class="client-section-header">
                                <div class="client-section-title">📋 Claims by Category</div>
                            </div>
                            <div class="client-mini-kpis" id="cfClaimsCategory">
                                <div class="client-mini-kpi">
                                    <div class="client-mini-kpi-value">0</div>
                                    <div class="client-mini-kpi-label">Consultation</div>
                                </div>
                                <div class="client-mini-kpi">
                                    <div class="client-mini-kpi-value">0</div>
                                    <div class="client-mini-kpi-label">Laboratory</div>
                                </div>
                                <div class="client-mini-kpi">
                                    <div class="client-mini-kpi-value">0</div>
                                    <div class="client-mini-kpi-label">Hospitalization</div>
                                </div>
                                <div class="client-mini-kpi">
                                    <div class="client-mini-kpi-value">0</div>
                                    <div class="client-mini-kpi-label">Dental</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Member Movement -->
                        <div class="client-analytics-section full-width">
                            <div class="client-section-header">
                                <div class="client-section-title">👥 Member Movement</div>
                            </div>
                            <div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.5);">
                                <div style="font-size:2rem;margin-bottom:0.5rem;">👥</div>
                                No member movement data available
                            </div>
                        </div>
                        
                        <!-- Geographic Distribution -->
                        <div class="client-analytics-section">
                            <div class="client-section-header">
                                <div class="client-section-title">🌍 Geographic Distribution</div>
                            </div>
                            <div class="client-geo-grid" id="cfGeoDistribution">
                                <div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.5);">
                                    <div style="font-size:2rem;margin-bottom:0.5rem;">🌍</div>
                                    No geographic data available
                                </div>
                            </div>
                        </div>
                        
                        <!-- Fees & Charges Breakdown -->
                        <div class="client-analytics-section">
                            <div class="client-section-header">
                                <div class="client-section-title">💳 Fees & Charges</div>
                            </div>
                            <div class="client-fees-breakdown" id="cfFeesBreakdown">
                                <div class="client-fee-row">
                                    <span class="client-fee-label">Admin Fee</span>
                                    <span class="client-fee-value" style="color:#3498db;">$0</span>
                                </div>
                                <div class="client-fee-row">
                                    <span class="client-fee-label">Claims Processing</span>
                                    <span class="client-fee-value" style="color:#27ae60;">$0</span>
                                </div>
                                <div class="client-fee-row">
                                    <span class="client-fee-label">Stop-Loss Premium</span>
                                    <span class="client-fee-value" style="color:#9b59b6;">$0</span>
                                </div>
                                <div class="client-fee-row total">
                                    <span class="client-fee-label">Total Charges</span>
                                    <span class="client-fee-value" style="color:var(--polaris-gold);">$0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Plan Performance -->
                        <div class="client-analytics-section">
                            <div class="client-section-header">
                                <div class="client-section-title">📊 Plan Performance</div>
                            </div>
                            <div class="client-plan-cards" id="cfPlanPerformance">
                                <div style="grid-column:span 3;text-align:center;padding:2rem;color:rgba(255,255,255,0.5);">
                                    <div style="font-size:2rem;margin-bottom:0.5rem;">📊</div>
                                    No plan data available
                                </div>
                            </div>
                        </div>
                        
                        <!-- Utilization Metrics -->
                        <div class="client-analytics-section">
                            <div class="client-section-header">
                                <div class="client-section-title">📈 Utilization Metrics</div>
                            </div>
                            <div class="client-utilization-grid" id="cfUtilization">
                                <div style="grid-column:span 4;text-align:center;padding:2rem;color:rgba(255,255,255,0.5);">
                                    <div style="font-size:2rem;margin-bottom:0.5rem;">📈</div>
                                    No utilization data available
                                </div>
                            </div>
                        </div>
                        
                        <!-- Period Comparison -->
                        <div class="client-analytics-section full-width">
                            <div class="client-section-header">
                                <div class="client-section-title">📅 Period Comparison</div>
                            </div>
                            <div class="client-period-comparison" id="cfPeriodComparison">
                                <div style="grid-column:span 4;text-align:center;padding:2rem;color:rgba(255,255,255,0.5);">
                                    <div style="font-size:2rem;margin-bottom:0.5rem;">📅</div>
                                    No comparison data available
                                </div>
                            </div>
                        </div>
                        
                        <!-- Historical Data -->
                        <div class="client-analytics-section full-width">
                            <div class="client-section-header">
                                <div class="client-section-title">📜 Historical Data</div>
                            </div>
                            <div style="text-align:center;padding:2rem;color:rgba(255,255,255,0.5);">
                                <div style="font-size:2rem;margin-bottom:0.5rem;">📜</div>
                                No historical data available
                            </div>
                        </div>
                        
                        <!-- Client Financial KPIs (Cyprus Tax View) -->
                        <div class="client-analytics-section full-width" style="background: linear-gradient(145deg, rgba(15,35,60,0.8), rgba(5,15,30,0.9)); border-color: rgba(212,175,55,0.3);">
                            <div class="client-section-header" style="border-bottom-color: rgba(212,175,55,0.3);">
                                <div class="client-section-title" style="font-size: 1.8rem;">
                                    <span>🇨🇾</span> Client Financial KPIs
                                </div>
                                <div style="display:flex; gap:0.75rem; align-items:center;">
                                    <span style="background:rgba(212,175,55,0.2); padding:0.5rem 1rem; border-radius:10px; color:var(--polaris-gold); font-size:0.9rem; font-weight:600;">Cyprus Tax View</span>
                                    <button class="client-section-action" style="background:rgba(231,76,60,0.3); color:#e74c3c;">📤 Export Tax Report</button>
                                </div>
                            </div>
                            
                            <!-- Client Financial KPIs Grid -->
                            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:1.5rem; margin-bottom:2rem;">
                                <div style="background:rgba(0,0,0,0.3); border-radius:20px; padding:2rem; text-align:center; border-left:5px solid #3498db;">
                                    <div style="font-size:2rem; margin-bottom:0.5rem;">💵</div>
                                    <div style="font-family:'Montserrat',sans-serif; font-size:2.5rem; font-weight:800; color:#3498db;" id="cfClientRevenue">$0</div>
                                    <div style="font-size:1rem; color:rgba(255,255,255,0.7); text-transform:uppercase; letter-spacing:1px;">Revenue from Client</div>
                                </div>
                                <div style="background:rgba(0,0,0,0.3); border-radius:20px; padding:2rem; text-align:center; border-left:5px solid #e74c3c;">
                                    <div style="font-size:2rem; margin-bottom:0.5rem;">📤</div>
                                    <div style="font-family:'Montserrat',sans-serif; font-size:2.5rem; font-weight:800; color:#e74c3c;" id="cfClientExpenses">$0</div>
                                    <div style="font-size:1rem; color:rgba(255,255,255,0.7); text-transform:uppercase; letter-spacing:1px;">Claims Paid</div>
                                </div>
                                <div style="background:rgba(0,0,0,0.3); border-radius:20px; padding:2rem; text-align:center; border-left:5px solid #27ae60;">
                                    <div style="font-size:2rem; margin-bottom:0.5rem;">📈</div>
                                    <div style="font-family:'Montserrat',sans-serif; font-size:2.5rem; font-weight:800; color:#27ae60;" id="cfClientProfit">$0</div>
                                    <div style="font-size:1rem; color:rgba(255,255,255,0.7); text-transform:uppercase; letter-spacing:1px;">Net Profit</div>
                                </div>
                                <div style="background:rgba(0,0,0,0.3); border-radius:20px; padding:2rem; text-align:center; border-left:5px solid var(--polaris-gold);">
                                    <div style="font-size:2rem; margin-bottom:0.5rem;">🏛️</div>
                                    <div style="font-family:'Montserrat',sans-serif; font-size:2.5rem; font-weight:800; color:var(--polaris-gold);" id="cfClientTax">$0</div>
                                    <div style="font-size:1rem; color:rgba(255,255,255,0.7); text-transform:uppercase; letter-spacing:1px;">Tax Contribution</div>
                                </div>
                            </div>
                            
                            <!-- Client Profitability Ratios -->
                            <div style="display:grid; grid-template-columns:repeat(5, 1fr); gap:1.25rem; margin-bottom:2rem;">
                                <div style="background:rgba(0,0,0,0.25); border-radius:16px; padding:1.5rem; text-align:center;">
                                    <div style="font-family:'Montserrat',sans-serif; font-size:2.2rem; font-weight:800; color:#27ae60;" id="cfClientLossRatio">0%</div>
                                    <div style="font-size:0.95rem; color:rgba(255,255,255,0.6); text-transform:uppercase;">Loss Ratio</div>
                                    <div style="font-size:0.8rem; color:rgba(255,255,255,0.4); margin-top:0.25rem;">Target: &lt;70%</div>
                                </div>
                                <div style="background:rgba(0,0,0,0.25); border-radius:16px; padding:1.5rem; text-align:center;">
                                    <div style="font-family:'Montserrat',sans-serif; font-size:2.2rem; font-weight:800; color:var(--polaris-gold);" id="cfClientMargin">0%</div>
                                    <div style="font-size:0.95rem; color:rgba(255,255,255,0.6); text-transform:uppercase;">Gross Margin</div>
                                    <div style="font-size:0.8rem; color:rgba(255,255,255,0.4); margin-top:0.25rem;">Target: &gt;30%</div>
                                </div>
                                <div style="background:rgba(0,0,0,0.25); border-radius:16px; padding:1.5rem; text-align:center;">
                                    <div style="font-family:'Montserrat',sans-serif; font-size:2.2rem; font-weight:800; color:#3498db;" id="cfClientARPM">$0</div>
                                    <div style="font-size:0.95rem; color:rgba(255,255,255,0.6); text-transform:uppercase;">ARPM</div>
                                    <div style="font-size:0.8rem; color:rgba(255,255,255,0.4); margin-top:0.25rem;">Avg Rev/Member</div>
                                </div>
                                <div style="background:rgba(0,0,0,0.25); border-radius:16px; padding:1.5rem; text-align:center;">
                                    <div style="font-family:'Montserrat',sans-serif; font-size:2.2rem; font-weight:800; color:#9b59b6;" id="cfClientCPM">$0</div>
                                    <div style="font-size:0.95rem; color:rgba(255,255,255,0.6); text-transform:uppercase;">CPM</div>
                                    <div style="font-size:0.8rem; color:rgba(255,255,255,0.4); margin-top:0.25rem;">Cost/Member</div>
                                </div>
                                <div style="background:rgba(0,0,0,0.25); border-radius:16px; padding:1.5rem; text-align:center;">
                                    <div style="font-family:'Montserrat',sans-serif; font-size:2.2rem; font-weight:800; color:#f39c12;" id="cfClientShare">0%</div>
                                    <div style="font-size:0.95rem; color:rgba(255,255,255,0.6); text-transform:uppercase;">Revenue Share</div>
                                    <div style="font-size:0.8rem; color:rgba(255,255,255,0.4); margin-top:0.25rem;">% of Total</div>
                                </div>
                            </div>
                            
                            <!-- CFO Note for this Client -->
                            <div style="background:linear-gradient(145deg, rgba(52,152,219,0.1), rgba(52,152,219,0.05)); border:1px solid rgba(52,152,219,0.3); border-radius:16px; padding:1.5rem;">
                                <div style="display:flex; align-items:center; gap:0.75rem; margin-bottom:0.75rem; color:#3498db; font-weight:700; font-size:1.1rem;">
                                    <span>💡</span> CFO Assessment
                                </div>
                                <div style="color:rgba(255,255,255,0.85); font-size:1.05rem; line-height:1.6;" id="cfClientCFONote">
                                    No financial analysis available. Connect claims data to generate assessment.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Report Summary -->
                        <div class="client-analytics-section full-width">
                            <div class="client-section-header">
                                <div class="client-section-title">📋 Report Summary</div>
                            </div>
                            <div class="client-report-summary" id="cfReportSummary">
                                <div class="client-report-card">
                                    <div class="client-report-icon">⭐</div>
                                    <div class="client-report-content">
                                        <div class="client-report-title">Client Status</div>
                                        <div class="client-report-value" id="cfClientStatus">-</div>
                                        <div class="client-report-note" id="cfClientSinceNote">-</div>
                                    </div>
                                </div>
                                <div class="client-report-card">
                                    <div class="client-report-icon">📈</div>
                                    <div class="client-report-content">
                                        <div class="client-report-title">Growth Trend</div>
                                        <div class="client-report-value" id="cfGrowthTrend">-</div>
                                        <div class="client-report-note">No data</div>
                                    </div>
                                </div>
                                <div class="client-report-card">
                                    <div class="client-report-icon">💰</div>
                                    <div class="client-report-content">
                                        <div class="client-report-title">Revenue Impact</div>
                                        <div class="client-report-value" id="cfRevenueImpact">$0</div>
                                        <div class="client-report-note">No data</div>
                                    </div>
                                </div>
                                <div class="client-report-card">
                                    <div class="client-report-icon">⚠️</div>
                                    <div class="client-report-content">
                                        <div class="client-report-title">Attention Items</div>
                                        <div class="client-report-value" id="cfAttentionItems">-</div>
                                        <div class="client-report-note">No alerts</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Contract Documents -->
                        <div class="client-analytics-section full-width">
                            <div class="client-section-header">
                                <div class="client-section-title">📄 Client Contracts</div>
                                <button class="client-section-action" onclick="createNewContractForClient()">➕ New</button>
                            </div>
                            <div class="client-contracts-list" id="cfContractsList">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                        
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    
    <!-- Offers Center Modal -->
    <div class="offers-center-modal hidden" id="offersCenterModal">
        <div class="offers-center-box">
            <div class="offers-center-header">
                <div style="display:flex; align-items:center; gap:1rem;">
                    
                    <h2>📝 Proposals & Offers</h2>
                    <div class="offers-tabs" style="margin-left: 2rem; margin-bottom: 0;">
                        <button class="offers-tab active" onclick="switchOffersTab('list')">📋 All Offers</button>
                        <button class="offers-tab" onclick="switchOffersTab('create')">📝 New Proposal</button>
                        <button class="offers-tab" onclick="switchOffersTab('compare')" style="background: linear-gradient(135deg, #8e44ad, #9b59b6); border-color: #8e44ad;">📊 Comparison Quote</button>
                    </div>
                </div>
                <div style="display:flex; gap:0.5rem; align-items:center;">
                    <button class="offers-center-close" onclick="closeOffersCenter()">✕</button>
                </div>
            </div>
            <div class="offers-center-content">
                <!-- Stats -->
                <div class="offers-stats">
                    <div class="offer-stat-card total"><div class="offer-stat-value" id="offerStatTotal">0</div><div class="offer-stat-label">Total Offers</div></div>
                    <div class="offer-stat-card draft"><div class="offer-stat-value" id="offerStatDraft">0</div><div class="offer-stat-label">Draft</div></div>
                    <div class="offer-stat-card sent"><div class="offer-stat-value" id="offerStatSent">0</div><div class="offer-stat-label">Sent</div></div>
                    <div class="offer-stat-card accepted"><div class="offer-stat-value" id="offerStatAccepted">0</div><div class="offer-stat-label">Accepted</div></div>
                    <div class="offer-stat-card rejected"><div class="offer-stat-value" id="offerStatRejected">0</div><div class="offer-stat-label">Rejected</div></div>
                </div>
                
                <!-- Tabs are in header -->
                
                <!-- Tab: All Offers -->
                <div id="offersTabList" class="offers-tab-content">
                    <!-- Search Bar -->
                    <div style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">🔍</span>
                            <input type="text" id="offerSearchClient" placeholder="Search by client name..." 
                                   style="padding: 0.6rem 1rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; color: white; font-size: 0.9rem; width: 200px;"
                                   oninput="filterOffers()">
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">📅 From:</span>
                            <input type="date" id="offerSearchDateFrom" 
                                   style="padding: 0.6rem 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; color: white; font-size: 0.9rem;"
                                   onchange="filterOffers()">
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">📅 To:</span>
                            <input type="date" id="offerSearchDateTo" 
                                   style="padding: 0.6rem 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; color: white; font-size: 0.9rem;"
                                   onchange="filterOffers()">
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">Status:</span>
                            <select id="offerSearchStatus" 
                                    style="padding: 0.6rem 0.75rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; color: white; font-size: 0.9rem;"
                                    onchange="filterOffers()">
                                <option value="">All</option>
                                <option value="draft">Draft</option>
                                <option value="sent">Sent</option>
                                <option value="accepted">Accepted</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                        <button onclick="clearOfferFilters()" style="padding: 0.6rem 1rem; background: #4a5568; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem;">
                            ✖ Clear
                        </button>
                        <span id="offerFilterCount" style="color: var(--text-muted); font-size: 0.85rem; margin-left: auto;"></span>
                    </div>
                    
                    <!-- Offers Table with Scroll Arrows -->
                    <div class="scroll-container" style="background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden;">
                        <button class="scroll-arrow left" onclick="this.nextElementSibling.scrollBy({left:-300,behavior:'smooth'})">◀</button>
                        <div class="scroll-content offers-table-scroll">
                            <table class="offers-table">
                                <thead>
                                    <tr>
                                        <th>Offer ID</th>
                                        <th>Client</th>
                                        <th>Date</th>
                                        <th>Members</th>
                                        <th>Total USD</th>
                                        <th>Status</th>
                                        <th>Actions & Documents</th>
                                    </tr>
                                </thead>
                                <tbody id="offersTableBody">
                                    <tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted);">Loading offers...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <button class="scroll-arrow right visible" onclick="this.previousElementSibling.scrollBy({left:300,behavior:'smooth'})">▶</button>
                    </div>
                </div>
                
                <!-- Tab: Create New Offer - POLARIS V4 EXACT INTERFACE -->
                <div id="offersTabCreate" class="offers-tab-content" style="display:none;">
                    <div style="background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%); border-radius: 12px; overflow: hidden;">
                        
                        <!-- POLARIS HEADER -->
                        <div style="background: #1e3a5f; color: white; padding: 15px 25px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 40px; height: 40px; background: #d4a843; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px;">✦</div>
                                <div>
                                    <h1 style="font-size: 20px; font-weight: 600; margin: 0;">POLARIS <span style="color: #d4a843;">Proposal Creator</span></h1>
                                    <p style="font-size: 11px; opacity: 0.8; margin: 0;">TPA Healthcare Solutions</p>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 25px;">
                                <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 8px 18px; border-radius: 8px;">
                                    <div style="font-size: 10px; opacity: 0.8; text-transform: uppercase;">Offer ID</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #d4a843;" id="offerDisplayId">OFF-2026-0001</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 11px; opacity: 0.8;">Created Date</div>
                                    <div style="font-size: 16px; font-weight: 600;" id="offerCreatedDate"></div>
                                </div>
                            </div>
                        </div>

                        <!-- MAIN CONTENT -->
                        <div style="background: white; padding: 25px; border-radius: 0 0 12px 12px;">
                            
                            <!-- Select Client Section -->
                            <div style="margin-bottom: 25px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #d4a843;">
                                    <div style="width: 32px; height: 32px; background: #1e3a5f; color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center;">👤</div>
                                    <h2 style="color: #1e3a5f; font-size: 18px; margin: 0;">Select Client</h2>
                                </div>
                                <select id="offerClientSelect" onchange="handleOfferClientChange()" style="width: 100%; padding: 15px; font-size: 16px; border: 2px solid #dee2e6; border-radius: 8px; background: white; cursor: pointer; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%231e3a5f%22 stroke-width=%222%22><polyline points=%226 9 12 15 18 9%22/></svg>'); background-repeat: no-repeat; background-position: right 15px center; background-size: 20px;">
                                    <option value="">-- Select a client or enter new --</option>
                                    <option value="new">+ Add New Client</option>
                                </select>
                                <!-- Client form is now in the Add New Client modal -->
                            </div>

                            <!-- Population Tier Section -->
                            <div style="margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%); border-radius: 12px; border: 2px solid #d4a843;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="color: #1e3a5f; font-size: 16px; margin: 0;">👥 Population Tier (affects pricing)</h3>
                                    <div id="currentTierBadge" style="background: #d4a843; color: #1e3a5f; padding: 5px 15px; border-radius: 20px; font-weight: 600; font-size: 14px;">Tier 1: 1-500 members</div>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="offer-tier-btn active" data-tier="1" data-min="1" data-max="500" onclick="selectOfferTier(this)" style="flex: 1; padding: 15px 12px; border: 2px solid #1e3a5f; border-radius: 8px; background: #1e3a5f; color: white; cursor: pointer; text-align: center; transition: all 0.3s;">
                                        <div style="font-weight: 600; font-size: 15px;">1 - 500</div>
                                        <div style="font-size: 11px; opacity: 0.8;">Standard</div>
                                    </button>
                                    <button class="offer-tier-btn" data-tier="2" data-min="501" data-max="750" onclick="selectOfferTier(this)" style="flex: 1; padding: 15px 12px; border: 2px solid #dee2e6; border-radius: 8px; background: white; color: #333; cursor: pointer; text-align: center; transition: all 0.3s;">
                                        <div style="font-weight: 600; font-size: 15px;">501 - 750</div>
                                        <div style="font-size: 11px; opacity: 0.7;">Tier 2</div>
                                    </button>
                                    <button class="offer-tier-btn" data-tier="3" data-min="751" data-max="1100" onclick="selectOfferTier(this)" style="flex: 1; padding: 15px 12px; border: 2px solid #dee2e6; border-radius: 8px; background: white; color: #333; cursor: pointer; text-align: center; transition: all 0.3s;">
                                        <div style="font-weight: 600; font-size: 15px;">751 - 1100</div>
                                        <div style="font-size: 11px; opacity: 0.7;">Tier 3</div>
                                    </button>
                                    <button class="offer-tier-btn" data-tier="4" data-min="1101" data-max="9999" onclick="selectOfferTier(this)" style="flex: 1; padding: 15px 12px; border: 2px solid #dee2e6; border-radius: 8px; background: white; color: #333; cursor: pointer; text-align: center; transition: all 0.3s;">
                                        <div style="font-weight: 600; font-size: 15px;">1100+</div>
                                        <div style="font-size: 11px; opacity: 0.7;">Enterprise</div>
                                    </button>
                                </div>
                            </div>

                            <!-- Select Health Plans Section -->
                            <div style="margin-bottom: 25px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #d4a843;">
                                    <div style="width: 32px; height: 32px; background: #1e3a5f; color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center;">📋</div>
                                    <h2 style="color: #1e3a5f; font-size: 18px; margin: 0;">Select Health Plans</h2>
                                </div>
                                <div id="offerPlansGrid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                    <!-- Plans will be rendered here by JavaScript -->
                                </div>
                            </div>

                            <!-- Custom Plans Section -->
                            <div style="margin-bottom: 25px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #6f42c1;">
                                    <div style="width: 32px; height: 32px; background: #6f42c1; color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center;">✨</div>
                                    <h2 style="color: #1e3a5f; font-size: 18px; margin: 0;">Custom Plans</h2>
                                </div>
                                <div onclick="openCustomPlanModal()" style="border: 2px dashed #6f42c1; border-radius: 12px; padding: 25px; text-align: center; cursor: pointer; background: linear-gradient(135deg, #f8f5ff 0%, #efe8ff 100%); transition: all 0.3s;">
                                    <div style="font-size: 36px; margin-bottom: 8px; color: #6f42c1;">➕</div>
                                    <div style="font-size: 16px; font-weight: 600; color: #6f42c1; margin-bottom: 5px;">Create Custom Plan</div>
                                    <div style="font-size: 13px; color: #666;">Define your own benefits and pricing</div>
                                </div>
                                <div id="customPlansContainer" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                                    <!-- Custom plans will be rendered here -->
                                </div>
                            </div>

                            <!-- Dental Benefits Section -->
                            <div style="margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, #e8f4f8 0%, #d4e8f0 100%); border-radius: 12px; border: 2px solid #b8d4e3;">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <input type="checkbox" id="offerDentalCheckbox" onchange="calculateOfferTotals()" style="width: 22px; height: 22px; cursor: pointer; accent-color: #1e3a5f;">
                                    <div style="flex: 1;">
                                        <h3 style="color: #1e3a5f; margin: 0 0 5px 0; font-size: 16px;">🦷 Dental Benefits Plan</h3>
                                        <p style="color: #666; font-size: 13px; margin: 0;">Comprehensive dental coverage including prophylaxis, fillings, extractions, and consultations through accredited providers.</p>
                                    </div>
                                    <div style="font-size: 22px; font-weight: 700; color: #1e3a5f;">
                                        $9.50<span style="font-size: 13px; font-weight: normal;">/member/year</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Validity Section -->
                            <div style="margin-bottom: 25px; padding: 12px 20px; background: #f8f9fa; border-radius: 10px; display: flex; align-items: center; gap: 12px;">
                                <span style="font-weight: 500; color: #1e3a5f;">📅 Offer Valid for</span>
                                <input type="number" id="offerValidityDays" value="30" min="1" max="90" onchange="updateOfferValidityDate()" style="width: 70px; padding: 8px; border: 2px solid #dee2e6; border-radius: 6px; text-align: center; font-size: 15px; font-weight: 600;">
                                <span style="color: #666;">days</span>
                                <span style="margin-left: auto; color: #1e3a5f; font-weight: 600;">Expires: <span id="offerExpiryDate"></span></span>
                            </div>

                            <!-- Cost Summary Section -->
                            <div style="background: linear-gradient(135deg, #1e3a5f 0%, #2c4a6e 100%); color: white; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); flex-wrap: wrap; gap: 15px;">
                                    <h2 style="font-size: 24px; margin: 0;">💰 Cost Summary</h2>
                                    <div style="background: #d4a843; color: #1e3a5f; padding: 14px 32px; border-radius: 25px; font-weight: 700; font-size: 20px;">
                                        <span id="offerTotalPrincipals">0</span> Principals + <span id="offerTotalDependents">0</span> Dependents = <span id="offerGrandTotalMembers" style="font-size: 26px;">0</span> Members
                                    </div>
                                </div>

                                <!-- Plan Breakdown -->
                                <div id="offerPlanBreakdown" style="margin-bottom: 20px;"></div>

                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; text-align: right;">
                                        <div style="font-size: 13px; opacity: 0.8; margin-bottom: 8px; text-transform: uppercase;">Registration Fees</div>
                                        <div style="font-size: 32px; font-weight: 700;">$<span id="offerRegTotal">0</span></div>
                                    </div>
                                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; text-align: right;">
                                        <div style="font-size: 13px; opacity: 0.8; margin-bottom: 8px; text-transform: uppercase;">Fund Deposits</div>
                                        <div style="font-size: 32px; font-weight: 700;">$<span id="offerFundTotal">0</span></div>
                                    </div>
                                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; text-align: right;">
                                        <div style="font-size: 13px; opacity: 0.8; margin-bottom: 8px; text-transform: uppercase;">Dental Benefits</div>
                                        <div style="font-size: 32px; font-weight: 700;">$<span id="offerDentalTotal">0</span></div>
                                    </div>
                                </div>

                                <div style="background: #d4a843; color: #1e3a5f; padding: 20px 25px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <div style="font-size: 20px; font-weight: 600;">TOTAL ANNUAL COST</div>
                                    <div style="font-size: 38px; font-weight: 700;">$<span id="offerAnnualTotal">0</span></div>
                                </div>
                            </div>

                            <!-- Action Buttons - EXACTLY LIKE POLARIS V4 -->
                            <div style="display: grid; grid-template-columns: 1fr 1.5fr 1fr 1fr; gap: 12px;">
                                <button onclick="resetOfferForm()" style="padding: 14px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #6c757d; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s;">
                                    🔄 Reset
                                </button>
                                <button onclick="generateOfferEmailPreview()" style="padding: 14px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #d4a843; color: #1e3a5f; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s;">
                                    📧 Generate Offer Email
                                </button>
                                <button onclick="generateOfferDocument()" style="padding: 14px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #1e3a5f; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s;">
                                    📄 Generate Offer Document
                                </button>
                                <button onclick="saveOfferDraft()" style="padding: 14px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #28a745; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s;">
                                    💾 Save Offer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Custom Plan Modal -->
                <div id="customPlanModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center;">
                    <div style="background: white; width: 90%; max-width: 700px; border-radius: 12px; overflow: hidden; max-height: 90vh; overflow-y: auto;">
                        <div style="background: #6f42c1; color: white; padding: 18px 25px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0;">
                            <h3 style="margin: 0; font-size: 18px;">✨ Create Custom Plan</h3>
                            <button onclick="closeCustomPlanModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        <div style="padding: 25px;">
                            <!-- Plan Name -->
                            <div style="margin-bottom: 18px;">
                                <label style="display: block; font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 6px; font-weight: 500;">Plan Name *</label>
                                <input type="text" id="customPlanName" placeholder="e.g., EXECUTIVE PLUS" style="width: 100%; padding: 12px 15px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 15px;">
                            </div>
                            
                            <!-- Benefits Section -->
                            <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 18px;">
                                <h4 style="margin: 0 0 12px 0; color: #1e3a5f; font-size: 14px;">📋 BENEFIT LIMITS</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Annual Max Benefit - MBL (PHP)</label>
                                        <input type="number" id="customMBL" placeholder="e.g., 200000" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Outpatient Limit - OPBL (PHP)</label>
                                        <input type="number" id="customOPBL" placeholder="e.g., 60000" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Fees Section (from ASA Contract) -->
                            <div style="background: #fff9e6; padding: 15px; border-radius: 8px; margin-bottom: 18px; border: 1px solid #d4a843;">
                                <h4 style="margin: 0 0 12px 0; color: #1e3a5f; font-size: 14px;">💰 TPA FEES (per ASA Contract)</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Enrollment/Registration Fee (USD)</label>
                                        <input type="number" id="customRegFee" placeholder="e.g., 24" step="0.01" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Fund Deposit (USD)</label>
                                        <input type="number" id="customFundDeposit" placeholder="e.g., 50" step="0.01" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Plan Management Fee (USD/month)</label>
                                        <input type="number" id="customMgmtFee" placeholder="e.g., 1.50" step="0.01" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Min. Monthly Management (USD)</label>
                                        <input type="number" id="customMgmtMin" placeholder="e.g., 500" step="0.01" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Claim Processing Fee (%)</label>
                                        <input type="number" id="customClaimFee" placeholder="e.g., 5" step="0.1" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Dental Benefit Fee (USD/year)</label>
                                        <input type="number" id="customDentalFee" placeholder="e.g., 9.50" step="0.01" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Room & Conditions -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Room Type</label>
                                    <select id="customRoomType" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                                        <option value="Ward">Ward</option>
                                        <option value="Semi-Private">Semi-Private</option>
                                        <option value="Private" selected>Private</option>
                                        <option value="Suite">Suite</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 4px;">Room Rate (PHP/day)</label>
                                    <input type="number" id="customRoomRate" placeholder="e.g., 3000" style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
                                </div>
                            </div>
                        </div>
                        <div style="padding: 15px 25px; background: #f8f9fa; display: flex; gap: 12px; justify-content: flex-end; position: sticky; bottom: 0;">
                            <button onclick="closeCustomPlanModal()" style="padding: 12px 25px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #6c757d; color: white;">Cancel</button>
                            <button onclick="saveCustomPlan()" style="padding: 12px 25px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #6f42c1; color: white;">Save Custom Plan</button>
                        </div>
                    </div>
                </div>
                
                <!-- Comparison Quote Tab Content -->
                <div id="offersTabCompare" class="offers-tab-content" style="display:none;">
                    <div style="background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%); border-radius: 12px; overflow: hidden;">
                        
                        <!-- HEADER -->
                        <div style="background: linear-gradient(135deg, #8e44ad, #9b59b6); color: white; padding: 20px 25px; border-radius: 12px 12px 0 0;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">📊</div>
                                <div>
                                    <h1 style="font-size: 22px; font-weight: 600; margin: 0;">Comparison Quote Generator</h1>
                                    <p style="font-size: 13px; opacity: 0.9; margin: 5px 0 0 0;">Compare multiple plan options side-by-side for your client</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- MAIN CONTENT -->
                        <div style="background: white; padding: 25px;">
                            
                            <!-- Step 1: Client & Population -->
                            <div style="margin-bottom: 25px; padding: 25px; background: #f8f9fa; border-radius: 12px; border: 2px solid #8e44ad;">
                                <h3 style="color: #8e44ad; margin: 0 0 20px 0; font-size: 20px; font-weight: 700;">📋 Step 1: Client & Population</h3>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                                    <div>
                                        <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px; font-weight: 600;">Client Name</label>
                                        <select id="compareClientSelect" style="width: 100%; padding: 14px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px;">
                                            <option value="">-- Select Client --</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px; font-weight: 600;">Principals (Seafarers)</label>
                                        <input type="number" id="comparePrincipals" value="100" min="1" style="width: 100%; padding: 14px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 18px; text-align: center; font-weight: 700;" oninput="updateComparisonPreview()">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 14px; color: #333; margin-bottom: 8px; font-weight: 600;">Dependents</label>
                                        <input type="number" id="compareDependents" value="500" min="0" style="width: 100%; padding: 14px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 18px; text-align: center; font-weight: 700;" oninput="updateComparisonPreview()">
                                    </div>
                                </div>
                                
                                <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #e8f4fd, #d1ecf1); border-radius: 8px; text-align: center;">
                                    <span style="font-size: 18px; color: #0c5460;">Total Members: </span>
                                    <span id="compareTotalMembers" style="font-size: 24px; font-weight: 700; color: #1e3a5f;">600</span>
                                    <span id="compareTierBadge" style="margin-left: 15px; background: #8e44ad; color: white; padding: 6px 16px; border-radius: 15px; font-size: 14px; font-weight: 600;">Tier 2</span>
                                </div>
                            </div>
                            
                            <!-- Step 2: Select Plans to Compare -->
                            <div style="margin-bottom: 25px; padding: 25px; background: #f8f9fa; border-radius: 12px; border: 2px solid #8e44ad;">
                                <h3 style="color: #8e44ad; margin: 0 0 20px 0; font-size: 20px; font-weight: 700;">📊 Step 2: Select Plans to Compare</h3>
                                
                                <div id="comparePlanOptions" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px;">
                                    <!-- Will be populated dynamically -->
                                </div>
                            </div>
                            
                            <!-- Step 3: Preview -->
                            <div style="margin-bottom: 25px; padding: 20px; background: #1e3a5f; border-radius: 12px; color: white;">
                                <h3 style="color: #d4a843; margin: 0 0 20px 0; font-size: 16px;">👁️ Preview: Side-by-Side Comparison</h3>
                                
                                <div id="comparisonPreview" style="overflow-x: auto;">
                                    <p style="text-align: center; opacity: 0.7;">Select at least 2 plans to see comparison</p>
                                </div>
                            </div>
                            
                            <!-- Actions - Same buttons as Create Offer -->
                            <div style="display: grid; grid-template-columns: 1fr 2fr 2fr 1fr; gap: 15px; margin-top: 20px;">
                                <button onclick="resetComparison()" style="padding: 15px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    🔄 Reset
                                </button>
                                <button onclick="generateComparisonOfferEmail()" style="padding: 15px 20px; background: linear-gradient(135deg, #D4A843, #c9952c); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    ✉️ Generate Offer Email
                                </button>
                                <button onclick="generateComparisonGoogleDoc()" style="padding: 15px 20px; background: linear-gradient(135deg, #1E3A5F, #2d5a87); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    📄 Generate Offer Document
                                </button>
                                <button onclick="saveComparisonOffer()" style="padding: 15px 20px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    💾 Save Offer
                                </button>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Report Builder Modal -->
    <div class="report-builder-modal hidden" id="reportBuilderModal">
        <div class="report-builder-box">
            <div class="rb-header" style="position:relative">
                <div style="display:flex; align-items:center; gap:1rem;">
                    
                    <div>
                        <h2 style="margin:0;">📊 Report Builder</h2>
                        <p style="margin:0.25rem 0 0 0; opacity:0.8;">Δημιουργήστε προσαρμοσμένες αναφορές</p>
                    </div>
                </div>
                <div style="display:flex; gap:0.5rem; align-items:center;">
                    <button class="rb-close" onclick="closeReportBuilder()">✕</button>
                </div>
            </div>
            
            <div class="rb-content">
                <!-- Period Selection -->
                <div class="rb-section">
                    <div class="rb-section-title">📅 Χρονική Περίοδος</div>
                    <div class="rb-period-grid">
                        <div class="rb-select-group">
                            <label>Από</label>
                            <select class="rb-select" id="rbFromPeriod">
                                <option value="">Επιλέξτε περίοδο</option>
                                <option value="2025-Q1">Q1 2025</option>
                                <option value="2025-Q2">Q2 2025</option>
                                <option value="2025-Q3" selected>Q3 2025</option>
                                <option value="2025-Q4">Q4 2025</option>
                            </select>
                        </div>
                        <div class="rb-select-group">
                            <label>Έως</label>
                            <select class="rb-select" id="rbToPeriod">
                                <option value="">Επιλέξτε περίοδο</option>
                                <option value="2025-Q1">Q1 2025</option>
                                <option value="2025-Q2">Q2 2025</option>
                                <option value="2025-Q3" selected>Q3 2025</option>
                                <option value="2025-Q4">Q4 2025</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Templates -->
                <div class="rb-section">
                    <div class="rb-section-title">⚡ Γρήγορα Πρότυπα</div>
                    <div class="rb-templates">
                        <div class="rb-template-btn" onclick="selectTemplate('board')">
                            <span>🎯</span>
                            <div>Board Meeting</div>
                        </div>
                        <div class="rb-template-btn" onclick="selectTemplate('monthly')">
                            <span>📈</span>
                            <div>Μηνιαία Ανασκόπηση</div>
                        </div>
                        <div class="rb-template-btn" onclick="selectTemplate('executive')">
                            <span>⚡</span>
                            <div>Executive Summary</div>
                        </div>
                        <div class="rb-template-btn" onclick="selectTemplate('full')">
                            <span>📊</span>
                            <div>Πλήρης Αναφορά</div>
                        </div>
                    </div>
                </div>
                
                <!-- Report Sections -->
                <div class="rb-section">
                    <div class="rb-section-title">📋 Ενότητες Αναφοράς</div>
                    <div class="rb-sections-list">
                        <label class="rb-section-item selected">
                            <input type="checkbox" id="sec_executive" checked>
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title">Executive Summary</div>
                                <div class="rb-section-item-desc">Συνοπτική παρουσίαση KPIs</div>
                            </div>
                            <span class="rb-section-item-badge">1 σελίδα</span>
                        </label>
                        <label class="rb-section-item selected">
                            <input type="checkbox" id="sec_inout" checked>
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title">🏥 Inpatient vs Outpatient</div>
                                <div class="rb-section-item-desc">Ανάλυση περιστατικών και κόστους</div>
                            </div>
                            <span class="rb-section-item-badge">1 σελίδα</span>
                        </label>
                        <label class="rb-section-item selected">
                            <input type="checkbox" id="sec_claims" checked>
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title">📋 Claims Analysis</div>
                                <div class="rb-section-item-desc">Λεπτομερής ανάλυση αξιώσεων</div>
                            </div>
                            <span class="rb-section-item-badge">1 σελίδα</span>
                        </label>
                        <label class="rb-section-item selected">
                            <input type="checkbox" id="sec_cost" checked>
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title">💰 Cost Breakdown</div>
                                <div class="rb-section-item-desc">Ανάλυση κόστους ανά κατηγορία</div>
                            </div>
                            <span class="rb-section-item-badge">1 σελίδα</span>
                        </label>
                        <label class="rb-section-item">
                            <input type="checkbox" id="sec_members">
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title">👥 Principal vs Dependent</div>
                                <div class="rb-section-item-desc">Ανάλυση ναυτικών και εξαρτωμένων</div>
                            </div>
                            <span class="rb-section-item-badge">1 σελίδα</span>
                        </label>
                        <label class="rb-section-item">
                            <input type="checkbox" id="sec_movement">
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title">📈 Member Movement</div>
                                <div class="rb-section-item-desc">Εγγραφές, ακυρώσεις, μεταβολές</div>
                            </div>
                            <span class="rb-section-item-badge">1 σελίδα</span>
                        </label>
                        <label class="rb-section-item">
                            <input type="checkbox" id="sec_plans">
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title">🏆 Plan Performance</div>
                                <div class="rb-section-item-desc">Απόδοση ανά τύπο πλάνου</div>
                            </div>
                            <span class="rb-section-item-badge">1 σελίδα</span>
                        </label>
                        <label class="rb-section-item">
                            <input type="checkbox" id="sec_history">
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title">📅 Historical Data</div>
                                <div class="rb-section-item-desc">Ιστορικά δεδομένα σε πίνακα</div>
                            </div>
                            <span class="rb-section-item-badge">2-3 σελίδες</span>
                        </label>
                        <label class="rb-section-item">
                            <input type="checkbox" id="sec_trends">
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title">📊 Trends & Charts</div>
                                <div class="rb-section-item-desc">Γραφήματα και τάσεις</div>
                            </div>
                            <span class="rb-section-item-badge">2 σελίδες</span>
                        </label>
                    </div>
                </div>
                
                <!-- Export Format -->
                <div class="rb-section">
                    <div class="rb-section-title">🎨 Μορφή Εξαγωγής</div>
                    <div class="rb-formats">
                        <div class="rb-format-btn selected" onclick="selectFormat('pdf')" id="formatPdf">
                            <span>📄</span>
                            <div>PDF</div>
                        </div>
                        <div class="rb-format-btn" onclick="selectFormat('excel')" id="formatExcel">
                            <span>📊</span>
                            <div>Excel</div>
                        </div>
                        <div class="rb-format-btn" onclick="selectFormat('both')" id="formatBoth">
                            <span>📦</span>
                            <div>PDF + Excel</div>
                        </div>
                    </div>
                </div>
                
                <!-- Info Box -->
                <div class="rb-info-box">
                    <span>💡</span>
                    <div>
                        <strong>Συμβουλή:</strong> Επιλέξτε μόνο τις ενότητες που χρειάζεστε για πιο γρήγορη δημιουργία αναφοράς.
                    </div>
                </div>
            </div>
            
            <div class="rb-footer">
                <button class="rb-btn rb-btn-cancel" onclick="closeReportBuilder()">Ακύρωση</button>
                <button class="rb-btn rb-btn-preview" onclick="previewReport()">🔍 Προεπισκόπηση</button>
                <button class="rb-btn rb-btn-generate" onclick="generateReport()">📄 Δημιουργία Αναφοράς</button>
            </div>
        </div>
    </div>

    <!-- Report Generation Modal -->
    <div class="report-modal hidden" id="reportModal">
        <div class="report-box">
            <div style="font-size:3rem;margin-bottom:1rem">📄</div>
            <h3 style="font-size:1.25rem;font-weight:700;margin-bottom:0.5rem" id="reportTitle">Generating Report...</h3>
            <p style="color:var(--text-secondary);margin-bottom:1rem" id="reportStatus">Preparing your personalized report</p>
            <div class="report-progress">
                <div class="report-progress-bar" id="reportProgressBar" style="width:0%"></div>
            </div>
            <p style="color:var(--text-muted);font-size:0.85rem" id="reportStep">Initializing...</p>
        </div>
    </div>
    
    <!-- GLOBAL STATUS INDICATOR - Fixed position, always visible -->
    <div id="globalStatusIndicator" style="
        display: none;
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 999999;
        padding: 1rem 2rem;
        background: linear-gradient(135deg, #1e3a5f, #2c5282);
        color: #90cdf4;
        border: 2px solid #3182ce;
        border-radius: 12px;
        font-size: 1.1rem;
        flex-direction: row;
        align-items: center;
        gap: 0.8rem;
        min-width: 350px;
        box-shadow: 0 8px 32px rgba(49,130,206,0.4);
    ">
        <span id="globalStatusIcon" style="font-size: 1.5rem;">📧</span>
        <span id="globalStatusText" style="font-weight: 600;">Processing...</span>
    </div>
    
    <!-- Footer removed -->
    
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbz3z8NkCjxMQSQe0AYvJL5Zo5RHEVCiauIa9fy6_3UBzuDRZON1JdyTQixWJP-w-ewH/exec';
        const EMAIL_TEMPLATES_FOLDER_ID = '1cj4aLgolPRwJvjRrkiNAUhQ7ZD_HRfE2';
        
        // ═══════════════════════════════════════════════════════════════════
        // SIMPLE MODAL MANAGEMENT - Back always returns to dashboard
        // ═══════════════════════════════════════════════════════════════════
        
        function closeAllModals() {
            const modals = [
                'emailCenterModal', 'contractCenterModal', 'offersCenterModal',
                'sendDocumentsModal', 'renewalsModal', 'reportBuilderModal',
                'addClientModal'
            ];
            modals.forEach(id => {
                const modal = document.getElementById(id);
                if (modal) {
                    modal.classList.add('hidden');
                    modal.style.display = 'none';
                }
            });
            // viewOfferModal is dynamically created, so remove it
            const viewOfferModal = document.getElementById('viewOfferModal');
            if (viewOfferModal) viewOfferModal.remove();
            
            // Reset body overflow
            document.body.style.overflow = '';
        }
        
        // ═══════════════════════════════════════════════════════════════════
        
        let currentUser = null, charts = {};
        let allClientsData = []; // Store all clients data
        let selectedClient = 'all'; // Current selection
        let compareMode = false;
        let compareClientA = null, compareClientB = null;
        
        // Quarter selection state
        let selectedQuarters = ['Q3']; // Default: Q3 selected
        let quarterCompareMode = false;
        
        // Mock quarter data (will come from API)
        const quarterData = {
            'Q1': { members: 1047, claims: 424, approved_usd: 27635, cost_per_member: 26.39 },
            'Q2': { members: 314, claims: 31, approved_usd: 1718, cost_per_member: 5.47 },
            'Q3': { members: 684, claims: 72, approved_usd: 5330, cost_per_member: 7.79 },
            'Q4': { members: 520, claims: 58, approved_usd: 4200, cost_per_member: 8.08 }
        };
        
        // ═══════════════════════════════════════════════════════════════════
        // NEW: REAL DATA LOADING FROM FinancialData, Claims_Categories SHEETS
        // ═══════════════════════════════════════════════════════════════════
        
        /**
         * Load all financial breakdowns from API
         * Reads from: FinancialData, Claims_Categories, Hospitals sheets
         */
        async function loadFinancialBreakdowns(clientId, period) {
            try {
                const params = new URLSearchParams({ action: 'getDashboardKPIs' });
                if (clientId) params.append('clientId', clientId);
                if (period) params.append('period', period);
                
                const response = await fetch(`${API_URL}?${params.toString()}`);
                const data = await response.json();
                
                if (data.error) {
                    console.warn('API returned error:', data.error);
                    return null;
                }
                
                return data;
            } catch (error) {
                console.error('loadFinancialBreakdowns error:', error);
                return null;
            }
        }
        
        /**
         * Update categories display from API data
         */
        function updateCategoriesDisplay(categories) {
            if (!categories || !Array.isArray(categories)) return;
            
            // Map category names to element IDs
            const categoryMap = {
                'Medical': 'catMedical',
                'Dental': 'catDental',
                'Optical': 'catOptical',
                'Laboratory': 'catLab',
                'Maternity': 'catMaternity',
                'Other': 'catOther'
            };
            
            categories.forEach(cat => {
                const elemId = categoryMap[cat.category];
                if (elemId) {
                    const elem = document.getElementById(elemId);
                    if (elem) elem.textContent = cat.cases.toLocaleString();
                }
            });
            
            // Update category chart if exists
            if (window.categoryChart) {
                window.categoryChart.data.labels = categories.map(c => c.category);
                window.categoryChart.data.datasets[0].data = categories.map(c => c.cases);
                window.categoryChart.update();
            }
        }
        
        /**
         * Update geographic display from API data
         */
        function updateGeographicDisplay(geoData) {
            if (!geoData) return;
            
            // Update region breakdown
            if (geoData.regions) {
                const regionMap = { 'NCR': 'geoNCR', 'Visayas': 'geoVisayas', 'Mindanao': 'geoMindanao' };
                geoData.regions.forEach(r => {
                    const elem = document.getElementById(regionMap[r.region]);
                    if (elem) elem.textContent = r.claimsPct + '%';
                });
            }
            
            // Update top hospitals
            if (geoData.topHospitals) {
                // Update city stats
                const cityElem = {
                    'Manila': document.getElementById('geoManila'),
                    'Quezon City': document.getElementById('geoManila'),
                    'Cebu City': document.getElementById('geoCebu'),
                    'Davao City': document.getElementById('geoDavao'),
                    'Iloilo City': document.getElementById('geoIloilo')
                };
                
                geoData.topHospitals.forEach(h => {
                    if (cityElem[h.city]) {
                        cityElem[h.city].textContent = h.claims.toLocaleString();
                    }
                });
            }
        }
        
        /**
         * Load client analytics for Client Folder View
         */
        async function loadClientAnalyticsData(clientId) {
            if (!clientId) return null;
            
            try {
                const response = await fetch(`${API_URL}?action=getClientKPISummary&clientId=${encodeURIComponent(clientId)}`);
                const data = await response.json();
                
                if (data.error) {
                    console.warn('Client analytics error:', data.error);
                    return null;
                }
                
                return data;
            } catch (error) {
                console.error('loadClientAnalyticsData error:', error);
                return null;
            }
        }
        
        /**
         * Populate Client Folder View with real data
         */
        async function populateClientFolderWithRealData(clientId) {
            const data = await loadClientAnalyticsData(clientId);
            console.log("📊 Client KPI data received:", data);
            if (!data) return;
            
            // Update summary stats
            const statMembers = document.getElementById('cfStatMembers');
            const statClaims = document.getElementById('cfStatClaims');
            const statApproved = document.getElementById('cfStatApproved');
            const statUtil = document.getElementById('cfStatUtilization');
            const statCost = document.getElementById('cfStatCostPerMember');
            
            if (statMembers && data.kpis) statMembers.textContent = (data.kpis.total_members || 0).toLocaleString();
            if (statClaims && data.kpis) statClaims.textContent = (data.kpis.total_claims || 0).toLocaleString();
            if (statApproved && data.kpis) statApproved.textContent = '$' + (data.kpis.total_cost_usd || 0).toLocaleString();
            if (statUtil && data.kpis) statUtil.textContent = (data.kpis.utilization_rate || 0) + '%';
            if (statCost && data.kpis) statCost.textContent = '$' + (data.kpis.cost_per_member || 0);
            
            // Update Inpatient vs Outpatient section
            const inOutContainer = document.getElementById('cfInOutAnalysis');
            if (inOutContainer && data.claimTypes) {
                inOutContainer.innerHTML = `
                    <div class="client-comparison-row">
                        <span class="client-comparison-label">Inpatient</span>
                        <div class="client-comparison-bar-bg">
                            <div class="client-comparison-bar-fill inpatient" style="width:${data.claimTypes.inpatientPct}%">${data.claimTypes.inpatientPct}%</div>
                        </div>
                        <span class="client-comparison-value">${data.claimTypes.inpatient}</span>
                    </div>
                    <div class="client-comparison-row">
                        <span class="client-comparison-label">Outpatient</span>
                        <div class="client-comparison-bar-bg">
                            <div class="client-comparison-bar-fill outpatient" style="width:${data.claimTypes.outpatientPct}%">${data.claimTypes.outpatientPct}%</div>
                        </div>
                        <span class="client-comparison-value">${data.claimTypes.outpatient}</span>
                    </div>
                `;
            }
            
            // Update Principal vs Dependent section
            const pdContainer = document.getElementById('cfPrincipalDependent');
            if (pdContainer && data.memberTypes) {
                pdContainer.innerHTML = `
                    <div class="client-comparison-row">
                        <span class="client-comparison-label">Principal</span>
                        <div class="client-comparison-bar-bg">
                            <div class="client-comparison-bar-fill principal" style="width:${data.memberTypes.principalPct}%">${data.memberTypes.principalPct}%</div>
                        </div>
                        <span class="client-comparison-value">${data.memberTypes.principal}</span>
                    </div>
                    <div class="client-comparison-row">
                        <span class="client-comparison-label">Dependent</span>
                        <div class="client-comparison-bar-bg">
                            <div class="client-comparison-bar-fill dependent" style="width:${data.memberTypes.dependentPct}%">${data.memberTypes.dependentPct}%</div>
                        </div>
                        <span class="client-comparison-value">${data.memberTypes.dependent}</span>
                    </div>
                `;
            }
            
            // Update Year over Year section
            const yoyContainer = document.getElementById('cfYoY');
            if (yoyContainer && data.yearOverYear && data.yearOverYear.length > 0) {
                let yoyHtml = '';
                data.yearOverYear.slice(-3).forEach((y, idx, arr) => {
                    const prevVal = idx > 0 ? arr[idx-1].approved_usd : y.approved_usd;
                    const change = prevVal > 0 ? Math.round((y.approved_usd - prevVal) / prevVal * 100) : 0;
                    const isUp = change >= 0;
                    yoyHtml += `
                        <div class="client-yoy-item">
                            <div class="client-yoy-year">${y.label}</div>
                            <div class="client-yoy-value">$${(y.approved_usd/1000).toFixed(0)}K</div>
                            <div class="client-yoy-change ${isUp ? 'up' : 'down'}">${isUp ? '↑' : '↓'} ${Math.abs(change)}%</div>
                        </div>
                    `;
                });
                yoyContainer.innerHTML = yoyHtml;
            }
            
            // Update Categories section
            if (data.categories && data.categories.categories) {
                const catContainer = document.getElementById('cfClaimsCategory');
                if (catContainer) {
                    let catHtml = '';
                    data.categories.categories.slice(0, 6).forEach((cat, idx) => {
                        catHtml += `
                            <div class="client-mini-kpi ${idx === 0 ? 'highlight' : ''}">
                                <div class="client-mini-kpi-value">${cat.cases.toLocaleString()}</div>
                                <div class="client-mini-kpi-label">${cat.category}</div>
                            </div>
                        `;
                    });
                    catContainer.innerHTML = catHtml;
                }
            }
            
            return data;
        }
        
        // ═══════════════════════════════════════════════════════════════════
        
        function toggleQuarter(quarter) {
            if (quarterCompareMode) {
                // Multi-select mode
                const index = selectedQuarters.indexOf(quarter);
                if (index > -1) {
                    // Deselect (but keep at least one)
                    if (selectedQuarters.length > 1) {
                        selectedQuarters.splice(index, 1);
                    }
                } else {
                    // Select
                    selectedQuarters.push(quarter);
                }
            } else {
                // Single select mode
                selectedQuarters = [quarter];
            }
            
            updateQuarterUI();
            loadDataForSelectedQuarters();
        }
        
        function toggleQuarterCompare() {
            quarterCompareMode = !quarterCompareMode;
            const btn = document.getElementById('quarterCompareBtn');
            
            if (quarterCompareMode) {
                btn.classList.add('active');
                btn.innerHTML = '<span>✓</span> Compare Mode ON';
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<span>⚖️</span> Compare Quarters';
                // Reset to single selection (keep first)
                selectedQuarters = [selectedQuarters[0]];
            }
            
            updateQuarterUI();
        }
        
        function updateQuarterUI() {
            // Update button states
            document.querySelectorAll('.quarter-btn').forEach(btn => {
                const q = btn.dataset.quarter;
                btn.classList.remove('active', 'compare-selected');
                
                if (selectedQuarters.includes(q)) {
                    if (quarterCompareMode && selectedQuarters.length > 1) {
                        btn.classList.add('compare-selected');
                    } else {
                        btn.classList.add('active');
                    }
                }
            });
            
            // Update badge
            const badge = document.getElementById('selectedQuartersBadge');
            if (selectedQuarters.length === 1) {
                badge.textContent = `${selectedQuarters[0]} 2025`;
            } else {
                badge.textContent = selectedQuarters.sort().join(' vs ') + ' 2025';
            }
        }
        
        function loadDataForSelectedQuarters() {
            const q = selectedQuarters[0];
            const data = quarterData[q];
            
            if (selectedQuarters.length === 1) {
                // Single quarter - show normal data
                document.getElementById('kpiMembers').textContent = fmt(data.members);
                document.getElementById('kpiClaims').textContent = fmt(data.claims);
                document.getElementById('kpiApproved').textContent = '$' + fmt(data.approved_usd);
                document.getElementById('kpiCost').textContent = '$' + data.cost_per_member.toFixed(2);
                
                // Hide comparison trends
                document.querySelectorAll('.kpi-trend').forEach(el => {
                    if (!el.textContent.includes('Target')) {
                        el.style.display = 'none';
                    }
                });
            } else {
                // Multiple quarters - show comparison
                const totals = { members: 0, claims: 0, approved_usd: 0 };
                selectedQuarters.forEach(q => {
                    totals.members += quarterData[q].members;
                    totals.claims += quarterData[q].claims;
                    totals.approved_usd += quarterData[q].approved_usd;
                });
                const avgCost = totals.members > 0 ? totals.approved_usd / totals.members : 0;
                
                document.getElementById('kpiMembers').textContent = fmt(totals.members);
                document.getElementById('kpiClaims').textContent = fmt(totals.claims);
                document.getElementById('kpiApproved').textContent = '$' + fmt(totals.approved_usd);
                document.getElementById('kpiCost').textContent = '$' + avgCost.toFixed(2);
                
                // Show comparison info
                const [q1, q2] = selectedQuarters.sort();
                const d1 = quarterData[q1], d2 = quarterData[q2];
                
                // Calculate changes
                const memberChange = ((d2.members - d1.members) / d1.members * 100).toFixed(1);
                const claimsChange = ((d2.claims - d1.claims) / d1.claims * 100).toFixed(1);
                
                // Show trends
                const membersTrend = document.getElementById('kpiMembersTrend');
                const claimsTrend = document.getElementById('kpiClaimsTrend');
                
                membersTrend.style.display = 'block';
                membersTrend.innerHTML = `${memberChange > 0 ? '↑' : '↓'} ${Math.abs(memberChange)}%`;
                membersTrend.className = `kpi-trend ${memberChange < 0 ? 'down' : 'up'}`;
                
                claimsTrend.style.display = 'block';
                claimsTrend.innerHTML = `${claimsChange > 0 ? '↑' : '↓'} ${Math.abs(claimsChange)}%`;
                claimsTrend.className = `kpi-trend ${claimsChange > 0 ? 'up' : 'down'}`;
            }
            
            // Create mock current period data for charts
            const mockCurrent = {
                period: '2025-' + q,
                period_label: q + ' 2025',
                members: data.members,
                claims: data.claims,
                approved_usd: data.approved_usd,
                cost_per_member: data.cost_per_member
            };
            
            // Build mock all_periods from quarterData
            const mockPeriods = Object.entries(quarterData).map(([key, val]) => ({
                period: '2025-' + key,
                period_label: key + ' 2025',
                members: val.members,
                claims: val.claims,
                approved_usd: val.approved_usd,
                cost_per_member: val.cost_per_member
            })).sort((a, b) => a.period.localeCompare(b.period));
            
            // Update utilization
            const util = mockCurrent.members > 0 ? (mockCurrent.claims / mockCurrent.members * 100) : 0;
            document.getElementById('kpiUtilization').textContent = util.toFixed(1) + '%';
            if (document.getElementById('totalActive')) {
                document.getElementById('totalActive').textContent = fmt(mockCurrent.members);
            }
            
            // Calculate inpatient/outpatient/ex gratia
            const inpatientCases = Math.round(mockCurrent.claims * 0.22);
            const outpatientCases = Math.round(mockCurrent.claims * 0.70);
            const exGratiaCases = mockCurrent.claims - inpatientCases - outpatientCases;
            const inpatientCostVal = Math.round(mockCurrent.approved_usd * 0.60);
            const outpatientCostVal = Math.round(mockCurrent.approved_usd * 0.32);
            const exGratiaCostVal = mockCurrent.approved_usd - inpatientCostVal - outpatientCostVal;
            
            document.getElementById('inpatientCases').textContent = fmt(inpatientCases);
            document.getElementById('outpatientCases').textContent = fmt(outpatientCases);
            document.getElementById('exGratiaCases').textContent = fmt(exGratiaCases);
            document.getElementById('inpatientCost').textContent = '$' + fmt(inpatientCostVal);
            document.getElementById('outpatientCost').textContent = '$' + fmt(outpatientCostVal);
            document.getElementById('exGratiaCost').textContent = '$' + fmt(exGratiaCostVal);
            
            // Principal/Dependent
            const principalMembers = Math.round(mockCurrent.members * 0.4);
            const dependentMembers = mockCurrent.members - principalMembers;
            document.getElementById('principalCount').textContent = fmt(principalMembers);
            document.getElementById('dependentCount').textContent = fmt(dependentMembers);
            
            // Member Movement
            const newEnroll = Math.round(mockCurrent.members * 0.08);
            const cancelled = Math.round(mockCurrent.members * 0.03);
            document.getElementById('newEnrollments').textContent = '+' + newEnroll;
            document.getElementById('cancellations').textContent = '-' + cancelled;
            document.getElementById('netChange').textContent = (newEnroll - cancelled > 0 ? '+' : '') + (newEnroll - cancelled);
            
            // Create all charts
            try { createCharts(mockPeriods, mockCurrent); } catch(e) { console.error('createCharts error:', e); }
            try { createInOutCharts(mockPeriods, inpatientCases, outpatientCases, exGratiaCases, inpatientCostVal, outpatientCostVal, exGratiaCostVal); } catch(e) { console.error('createInOutCharts error:', e); }
            try { createMemberTypeCharts(principalMembers, dependentMembers, mockCurrent.claims); } catch(e) { console.error('createMemberTypeCharts error:', e); }
            try { createMovementCharts(mockPeriods); } catch(e) { console.error('createMovementCharts error:', e); }
            try { createCostBreakdownChart(mockCurrent); } catch(e) { console.error('createCostBreakdownChart error:', e); }
            try { createCategoryCharts(mockCurrent); } catch(e) { console.error('createCategoryCharts error:', e); }
            try { createYoYCharts(mockPeriods); } catch(e) { console.error('createYoYCharts error:', e); }
            try { createHospitalCharts(); } catch(e) { console.error('createHospitalCharts error:', e); }
            try { createGeoCharts(); } catch(e) { console.error('createGeoCharts error:', e); }
            
            // Update metrics and insights
            try { updateMetrics(util); } catch(e) { console.error('updateMetrics error:', e); }
            try { updateTable(mockPeriods); } catch(e) { console.error('updateTable error:', e); }
        }
        
        // Mock clients list (will come from API)
        // Dynamic clientsList - loaded from API
        let clientsList = [
            { id: 'all', name: '🏢 All Clients (Company Total)' }
        ];
        

        // Load clients from API - use same approach as loadOfferClients which works
        async function loadClientsFromAPI() {
            try {
                // Check if we already have cached data
                if (window.cachedClientsData && window.cachedClientsData.length > 0) {
                    console.log('📦 Using cached clients data');
                    const clients = window.cachedClientsData;
                    clientsList = [{ id: 'all', name: '🏢 All Clients (Company Total)' }];
                    
                    clients.forEach((c, index) => {
                        const clientId = c.client_id || c.id || `client_${index}`;
                        // API returns contacts - use contact_name as display name
                        const clientName = c.client_name || c.contact_name || c.name || `Client ${index + 1}`;
                        if (clientId && clientName) {
                            clientsList.push({ id: clientId, name: clientName, data: c });
                        }
                    });
                    
                    console.log('✅ Clients loaded from cache:', clientsList.length - 1, 'clients');
                    populateClientSelector();
                    populateEmailClients();
                    return;
                }
                
                // Fetch from API
                const response = await fetch(`${API_URL}?action=getClients`);
                const result = await response.json();
                console.log('📦 API response:', result);
                
                // Parse the response
                const clients = result.data || result;
                console.log('📦 Clients array:', clients);
                
                if (clients && Array.isArray(clients) && clients.length > 0) {
                    // Cache the data
                    window.cachedClientsData = clients;
                    
                    // Log first client to debug
                    console.log('📋 First client:', JSON.stringify(clients[0], null, 2));
                    
                    clientsList = [{ id: 'all', name: '🏢 All Clients (Company Total)' }];
                    
                    clients.forEach((c, index) => {
                        // Use same field names as loadOfferClients which works
                        // API returns contacts - contact_name is the display name
                        const clientId = c.client_id || c.id || `client_${index}`;
                        const clientName = c.client_name || c.contact_name || c.name || `Client ${index + 1}`;
                        
                        console.log(`  Client ${index}: id="${clientId}", name="${clientName}"`);
                        
                        if (clientId && clientName) {
                            clientsList.push({
                                id: clientId,
                                name: clientName,
                                data: c
                            });
                        }
                    });
                    
                    console.log('✅ Clients loaded from API:', clientsList.length - 1, 'clients');
                    console.log('✅ clientsList:', clientsList);
                    
                    // Re-populate selectors after loading
                    populateClientSelector();
                    populateEmailClients();
                } else {
                    console.warn('⚠️ No clients found in API response');
                }
            } catch (e) {
                console.error('❌ Failed to load clients from API:', e);
            }
        }
        
        // Global Chart.js defaults for larger, more readable fonts
        Chart.defaults.font.size = 14;
        Chart.defaults.font.family = "'Open Sans', sans-serif";
        Chart.defaults.color = '#b8c9b8';
        Chart.defaults.plugins.legend.labels.font = { size: 14, weight: 'bold' };
        Chart.defaults.plugins.legend.labels.padding = 25;
        Chart.defaults.plugins.legend.labels.boxWidth = 18;
        Chart.defaults.plugins.legend.labels.boxHeight = 18;
        Chart.defaults.plugins.tooltip.titleFont = { size: 14, weight: 'bold' };
        Chart.defaults.plugins.tooltip.bodyFont = { size: 13 };
        Chart.defaults.scale.ticks.font = { size: 13, weight: '600' };
        
        function populateClientSelector() {
            console.log("🔄 populateClientSelector called with clientsList:", clientsList);
            
            const selector = document.getElementById("clientSelector");
            const compareA = document.getElementById("compareClientA");
            const compareB = document.getElementById("compareClientB");
            
            if (!selector) {
                console.error("❌ clientSelector element not found!");
                return;
            }
            
            if (clientsList.length <= 1) {
                console.warn("⚠️ clientsList only has All Clients - no real clients loaded");
            }
            
            // Build hierarchy map for visual indicators
            const allClients = window.cachedClientsData || [];
            const subsidiaryMap = {};
            allClients.forEach(function(c) {
                if (c.parent_client_id && c.parent_client_id !== "") {
                    if (!subsidiaryMap[c.parent_client_id]) subsidiaryMap[c.parent_client_id] = [];
                    subsidiaryMap[c.parent_client_id].push(c.client_id);
                }
            });
            
            // Generate options with hierarchy visual indicators (IDs unchanged)
            selector.innerHTML = clientsList.map(function(c) {
                let displayName = c.name;
                if (c.id === "all") {
                    displayName = "🏢 All Clients (Company Total)";
                } else {
                    const subs = subsidiaryMap[c.id];
                    const clientData = c.data || allClients.find(function(ac) { return ac.client_id === c.id; });
                    const isSubsidiary = clientData && clientData.parent_client_id && clientData.parent_client_id !== "";
                    
                    if (subs && subs.length > 0) {
                        displayName = "🏛️ " + c.name + " (+" + subs.length + " sub)";
                    } else if (isSubsidiary) {
                        displayName = "   └─ " + c.name;
                    } else {
                        displayName = "🏢 " + c.name;
                    }
                }
                return "<option value=\"" + c.id + "\">" + displayName + "</option>";
            }).join("");
            
            console.log("✅ Selector populated with", clientsList.length, "options (hierarchy-aware)");
            
            // Populate compare selectors (without "All") - keep original names
            const clientsOnly = clientsList.filter(function(c) { return c.id !== "all"; });
            if (compareA) {
                compareA.innerHTML = clientsOnly.map(function(c) {
                    return "<option value=\"" + c.id + "\">" + c.name + "</option>";
                }).join("");
            }
            if (compareB) {
                compareB.innerHTML = clientsOnly.map(function(c) {
                    return "<option value=\"" + c.id + "\" " + (c.id === "arcadia" ? "selected" : "") + ">" + c.name + "</option>";
                }).join("");
            }
        }

        
        function handleClientChange() {
            const selector = document.getElementById('clientSelector');
            selectedClient = selector.value;
            const clientName = clientsList.find(c => c.id === selectedClient)?.name || 'All Clients';
            
            document.getElementById('clientFilterBadge').textContent = clientName.replace('🏢 ', '');
            
            // Reload dashboard with new client data
            loadData();
            
            // Update CEO Dashboard based on selection
            if (selectedClient === 'all') {
                // Load company-wide dashboard
                loadCEODashboardFromAPI();
            } else {
                // Load specific client financials
                loadCEOFinancialsForClient(selectedClient);
            }
        }
        
        function toggleCompareMode() {
            compareMode = !compareMode;
            const panel = document.getElementById('comparePanel');
            const btn = document.getElementById('compareModeBtn');
            
            if (compareMode) {
                panel.style.display = 'block';
                btn.classList.add('active');
                btn.innerHTML = '<span>✕</span> Cancel';
            } else {
                panel.style.display = 'none';
                btn.classList.remove('active');
                btn.innerHTML = '<span>⚖️</span> Compare';
            }
        }
        
        function applyComparison() {
            compareClientA = document.getElementById('compareClientA').value;
            compareClientB = document.getElementById('compareClientB').value;
            
            const nameA = clientsList.find(c => c.id === compareClientA)?.name || compareClientA;
            const nameB = clientsList.find(c => c.id === compareClientB)?.name || compareClientB;
            
            document.getElementById('clientFilterBadge').textContent = `${nameA} vs ${nameB}`;
            
            // TODO: Load comparison data
            alert(`Comparing: ${nameA} vs ${nameB}\n\nComparison view coming soon!`);
            toggleCompareMode();
        }
        
        async function handleLogin() {
            const u = document.getElementById('loginUsername').value.trim();
            const p = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            const btn = document.querySelector('.login-btn');
            
            if (!u) { errorEl.textContent = 'Please enter username'; return; }
            if (!p) { errorEl.textContent = 'Please enter password'; return; }
            
            btn.textContent = 'Signing in...';
            btn.disabled = true;
            errorEl.textContent = '';
            
            try {
                const response = await fetch(`${API_URL}?action=login&username=${encodeURIComponent(u)}&password=${encodeURIComponent(p)}`);
                const data = await response.json();
                
                const userData = data.user || data.data;
                if (data.success && userData && userData.role === 'admin') {
                    currentUser = userData;
                    localStorage.setItem('polaris_admin_user', JSON.stringify(currentUser));
                    
                    // Use new welcome flow instead of showDashboard()
                    document.getElementById('loginModal').classList.add('hidden');
                    document.getElementById('welcomeLoadingScreen').classList.remove('hidden');
                    initWelcomeScreen();
                    
                    // Preload data then show dashboard
                    (async () => {
                        try {
                            await preloadAllDataWithProgress();
                            await loadClientsFromAPI();
                            populateClientSelector();
                            loadDataForSelectedQuarters();
                        } catch (e) {
                            console.error('Preload error:', e);
                        }
                        
                        // Transition to main dashboard
                        setTimeout(() => {
                            transitionToMainDashboard();
                        }, 3000);
                    })();
                } else if (data.success && userData && userData.role !== 'admin') {
                    errorEl.textContent = 'Access denied. Admin credentials required.';
                    btn.textContent = 'Sign In';
                    btn.disabled = false;
                } else {
                    errorEl.textContent = data.error || data.message || 'Invalid username or password';
                    btn.textContent = 'Sign In';
                    btn.disabled = false;
                }
            } catch (err) {
                console.error('Login error:', err);
                errorEl.textContent = 'Connection error. Please try again.';
                btn.textContent = 'Sign In';
                btn.disabled = false;
            }
        }
        
        function handleLogout() { 
            localStorage.removeItem('polaris_admin_user'); 
            currentUser = null;
            location.reload(); 
        }
        
        // Report Builder State
        let reportConfig = {
            fromPeriod: '2025-Q3',
            toPeriod: '2025-Q3',
            format: 'pdf',
            sections: {
                executive: true,
                inout: true,
                claims: true,
                cost: true,
                members: false,
                movement: false,
                plans: false,
                history: false,
                trends: false
            }
        };
        
        function openActiveMembers() {
            // For admin, open with selected client or all
            const clientSelector = document.getElementById('clientSelector');
            const clientId = clientSelector ? clientSelector.value : 'all';
            const url = 'https://apostolos-bizou.github.io/polaris-member-tracker/?client=' + encodeURIComponent(clientId);
            window.open(url, '_blank');
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // EMAIL CENTER FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════════════
        
        let emailTemplates = [];
        let clientContacts = [];
        let selectedTemplate = null;
        let selectedContacts = [];
        
        function openEmailCenter() {
            document.getElementById('emailCenterModal').classList.remove('hidden');
            document.getElementById('dashboardBtn').style.display = 'flex';
            document.getElementById('mainDashboardBtn').style.display = 'flex';
            populateEmailClients();
            loadEmailTemplates();
            loadEmailHistory();
        }
        
        function closeEmailCenter() {
            document.getElementById('emailCenterModal').classList.add('hidden');
        }
        
        function switchEmailTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.email-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide content
            document.getElementById('emailTabCompose').style.display = tab === 'compose' ? 'block' : 'none';
            document.getElementById('emailTabTemplates').style.display = tab === 'templates' ? 'block' : 'none';
            document.getElementById('emailTabHistory').style.display = tab === 'history' ? 'block' : 'none';
            document.getElementById('emailTabBulk').style.display = tab === 'bulk' ? 'block' : 'none';
            document.getElementById('emailTabScheduler').style.display = tab === 'scheduler' ? 'block' : 'none';
            document.getElementById('emailTabSenddocs').style.display = tab === 'senddocs' ? 'block' : 'none';
            
            if (tab === 'templates') loadTemplatesList();
            if (tab === 'bulk') populateBulkClients();
            if (tab === 'scheduler') { populateSchedulerClients(); loadScheduledEmails(); }
            if (tab === 'senddocs') { initSendDocsTab(); }
        }
        
        function populateEmailClients() {
            const select = document.getElementById('emailClient');
            select.innerHTML = '<option value="">-- Select a client --</option>';
            
            // Use clientsList (same as main dropdown) - filter out "all"
            const clients = clientsList.filter(c => c.id !== 'all');
            
            if (clients && clients.length > 0) {
                clients.forEach(client => {
                    const opt = document.createElement('option');
                    opt.value = client.id;
                    opt.textContent = client.name.replace('🏢 ', '');
                    select.appendChild(opt);
                });
                console.log('Email clients loaded:', clients.length);
            } else {
                console.log('No clients found in clientsList');
            }
        }
        
        async function loadEmailTemplates() {
            try {
                const response = await fetch(`${API_URL}?action=getEmailTemplates`);
                const data = await response.json();
                if (data.success) {
                    emailTemplates = data.data || [];
                }
            } catch (err) {
                console.error('Error loading templates:', err);
                // Use default templates
                emailTemplates = [
                    { template_id: 'contract_01', template_name: 'New Contract Documents', category: 'contract', subject: 'Your Polaris Health Insurance Contract - {{client_name}}' },
                    { template_id: 'welcome_01', template_name: 'Welcome New Client', category: 'client', subject: 'Welcome to Polaris Financial Services, {{client_name}}!' },
                    { template_id: 'meeting_01', template_name: 'Post-Meeting Follow-up', category: 'client', subject: 'Thank You for Meeting with Polaris - Next Steps' },
                    { template_id: 'renewal_01', template_name: 'Contract Renewal Reminder', category: 'contract', subject: 'Contract Renewal Notice - {{client_name}}' },
                    { template_id: 'balance_01', template_name: 'Outstanding Balance', category: 'finance', subject: 'Payment Reminder - Outstanding Balance' },
                    { template_id: 'revolving_01', template_name: 'Revolving Fund Alert', category: 'alert', subject: 'URGENT: Revolving Fund Below 50%' },
                    { template_id: 'wishes_01', template_name: 'Holiday Wishes', category: 'wishes', subject: 'Season\'s Greetings from Polaris!' },
                    { template_id: 'wishes_02', template_name: 'Easter Wishes', category: 'wishes', subject: 'Happy Easter from Polaris!' },
                    { template_id: 'wishes_03', template_name: 'Birthday Wishes', category: 'wishes', subject: 'Happy Birthday from Polaris!' },
                ];
            }
        }
        
        async function loadClientContacts() {
            const clientId = document.getElementById('emailClient').value;
            const container = document.getElementById('emailRecipients');
            
            if (!clientId) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Select a client to see available contacts</p>';
                updateSendButton();
                return;
            }
            
            container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Loading contacts...</p>';
            
            try {
                const response = await fetch(`${API_URL}?action=getClientContacts&clientId=${clientId}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    clientContacts = data.data;
                    renderContacts();
                } else {
                    // Fallback - show message to add email manually
                    clientContacts = [];
                    container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">No contacts found. Use "Additional Email" below to add recipients.</p>';
                }
            } catch (err) {
                console.error('Error loading contacts:', err);
                // Fallback - allow manual email entry
                clientContacts = [];
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Could not load contacts. Use "Additional Email" below.</p>';
            }
            
            updateSendButton();
        }
        
        function renderContacts() {
            const container = document.getElementById('emailRecipients');
            
            if (clientContacts.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">No contacts available</p>';
                return;
            }
            
            container.innerHTML = clientContacts.map((contact, idx) => `
                <div class="email-recipient-item">
                    <input type="checkbox" id="contact_${idx}" onchange="updateSelectedContacts()">
                    <div class="email-recipient-info">
                        <div class="email-recipient-name">${contact.name || contact.contact_name || 'Contact'}</div>
                        <div class="email-recipient-email">${contact.email}</div>
                    </div>
                    <span class="email-recipient-role">${contact.role || 'Primary'}</span>
                </div>
            `).join('');
        }
        
        function updateSelectedContacts() {
            selectedContacts = [];
            clientContacts.forEach((contact, idx) => {
                const checkbox = document.getElementById(`contact_${idx}`);
                if (checkbox && checkbox.checked) {
                    selectedContacts.push(contact);
                }
            });
            updateSendButton();
        }
        
        function selectAllRecipients() {
            clientContacts.forEach((_, idx) => {
                const checkbox = document.getElementById(`contact_${idx}`);
                if (checkbox) checkbox.checked = true;
            });
            updateSelectedContacts();
        }
        
        function clearAllRecipients() {
            clientContacts.forEach((_, idx) => {
                const checkbox = document.getElementById(`contact_${idx}`);
                if (checkbox) checkbox.checked = false;
            });
            updateSelectedContacts();
        }
        
        function selectByRole(role) {
            clientContacts.forEach((contact, idx) => {
                const checkbox = document.getElementById(`contact_${idx}`);
                if (checkbox) {
                    checkbox.checked = contact.role === role || contact.role === 'Primary';
                }
            });
            updateSelectedContacts();
        }
        
        function addAdditionalEmail() {
            const input = document.getElementById('emailAdditional');
            const email = input.value.trim();
            
            if (!email || !email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }
            
            // Add to contacts
            clientContacts.push({
                contact_name: email.split('@')[0],
                email: email,
                role: 'Additional'
            });
            
            renderContacts();
            input.value = '';
            
            // Select the new contact
            setTimeout(() => {
                const lastCheckbox = document.getElementById(`contact_${clientContacts.length - 1}`);
                if (lastCheckbox) {
                    lastCheckbox.checked = true;
                    updateSelectedContacts();
                }
            }, 100);
        }
        
        function handleTemplateChange() {
            const templateId = document.getElementById('emailTemplate').value;
            const template = emailTemplates.find(t => t.template_id === templateId);
            
            // Show/hide meeting options for meeting_01 template
            const meetingBox = document.getElementById('meetingOptionsBox');
            if (templateId === 'meeting_01') {
                meetingBox.style.display = 'block';
                loadTeamMembers();
            } else {
                meetingBox.style.display = 'none';
            }
            
            if (template) {
                selectedTemplate = template;
                document.getElementById('emailSubject').value = template.subject;
                updatePreview();
            } else {
                selectedTemplate = null;
                document.getElementById('emailSubject').value = '';
                document.getElementById('emailPreviewBox').innerHTML = '<p style="color: #999; text-align: center;">Select a template to see preview</p>';
            }
            
            updateSendButton();
        }
        
        function updatePreview() {
            const previewBox = document.getElementById('emailPreviewBox');
            
            if (!selectedTemplate) {
                previewBox.innerHTML = '<p style="color: #999; text-align: center;">Select a template to see preview</p>';
                return;
            }
            
            // Get client data for placeholders
            const clientId = document.getElementById('emailClient').value;
            const client = dashboardData?.clients?.find(c => c.client_id === clientId);
            
            let preview = selectedTemplate.body_html || getDefaultTemplateBody(selectedTemplate.template_id);
            
            // Replace placeholders
            if (client) {
                preview = preview.replace(/\{\{client_name\}\}/g, client.client_name || '');
                preview = preview.replace(/\{\{contact_name\}\}/g, client.contact_name || 'Valued Customer');
            }
            preview = preview.replace(/\{\{current_date\}\}/g, new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }));
            preview = preview.replace(/\{\{year\}\}/g, new Date().getFullYear());
            preview = preview.replace(/\{\{portal_url\}\}/g, 'https://polaris-portal.com');
            
            // Meeting template specific placeholders
            if (selectedTemplate.template_id === 'meeting_01') {
                preview = preview.replace(/\{\{greeting\}\}/g, getGreetingText());
                preview = preview.replace(/\{\{attendees_text\}\}/g, buildAttendeesText() || '[Select team members above]');
                preview = preview.replace(/\{\{signatures\}\}/g, buildSignaturesHTML() || '[Select team members above]');
            }
            
            // Show preview
            previewBox.innerHTML = preview || '<p>Template preview not available</p>';
        }
        
        function getDefaultTemplateBody(templateId) {
            const bodies = {
                'wishes_01': '<div style="font-family: Arial; color: #333;"><p>Dear {{contact_name}},</p><p>Season\'s Greetings from Polaris Financial Services!</p><p>Wishing you and {{client_name}} a wonderful holiday season.</p><br><p>Best Regards,<br><strong>✦ POLARIS Financial Services</strong></p></div>',
                'wishes_02': '<div style="font-family: Arial; color: #333;"><p>Dear {{contact_name}},</p><p>Happy Easter from Polaris!</p><p>Wishing you peace and joy this Easter season.</p><br><p>Best Regards,<br><strong>✦ POLARIS Financial Services</strong></p></div>',
                'wishes_03': '<div style="font-family: Arial; color: #333;"><p>Dear {{contact_name}},</p><p>Happy Birthday!</p><p>Wishing you a wonderful day filled with joy!</p><br><p>Best Regards,<br><strong>✦ POLARIS Financial Services</strong></p></div>',
                'welcome_01': '<div style="font-family: Arial; color: #333;"><p>Dear {{contact_name}},</p><p>Welcome to Polaris Financial Services!</p><p>We are thrilled to have <strong>{{client_name}}</strong> as our partner.</p><p>Your portal access credentials are:</p><div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px 0;"><p style="margin: 5px 0;"><strong>Portal URL:</strong> {{portal_url}}</p><p style="margin: 5px 0;"><strong>Username:</strong> {{username}}</p><p style="margin: 5px 0;"><strong>Password:</strong> {{password}}</p></div><p>Please keep these credentials secure and do not share them with unauthorized persons.</p><br><p>Best Regards,<br><strong>✦ POLARIS Financial Services</strong></p></div>',
                'renewal_01': '<div style="font-family: Arial; color: #333;"><p>Dear {{contact_name}},</p><p>This is a reminder that your contract is approaching renewal.</p><p>Please contact us to discuss renewal options.</p><br><p>Best Regards,<br><strong>✦ POLARIS Financial Services</strong></p></div>',
                'balance_01': '<div style="font-family: Arial; color: #333;"><p>Dear {{contact_name}},</p><p>This is a reminder regarding an outstanding balance on your account.</p><p>Please arrange payment at your earliest convenience.</p><br><p>Best Regards,<br><strong>✦ POLARIS Financial Services</strong></p></div>',
                'revolving_01': '<div style="font-family: Arial; color: #333;"><p>Dear {{contact_name}},</p><p><strong>⚠️ URGENT:</strong> The revolving fund for {{client_name}} has fallen below 50%.</p><p>Please replenish to ensure uninterrupted service.</p><br><p>Best Regards,<br><strong>✦ POLARIS Financial Services</strong></p></div>',
                'meeting_01': '<div style="font-family: Arial; color: #333;">{{greeting}}<br><br><p>Following the meeting you had with:</p>{{attendees_text}}<p>I would like to sincerely thank you for the time you dedicated and for the opportunity to connect with you.</p><p>We trust the meeting achieved providing you with a clear overview of our services and operational approach, while also setting the basis for the mutual trust and transparency we aim to build with our partners.</p><p>We represent Polaris Financial Services Ltd (<a href="http://www.polaris-finance.com">www.polaris-finance.com</a>) and our corporate arm in the Philippines, Polaris Administration Services, Inc.</p><p>Polaris provides a specialized private healthcare service for seafarers and their families, offering access to primary and secondary medical care through an extensive network of private physicians, diagnostic centers, and hospitals across the Philippines.</p><p>Our model incorporates key safeguards commonly found in traditional insurance, while maintaining a 30–50% lower cost, enabled by our actuarial management system and agreements with private healthcare providers.</p><h4>In summary:</h4><ol><li><strong>Flexible Claims Handling:</strong> Ability to manage and settle ex gratia claims in coordination with the client.</li><li><strong>Regular Reporting:</strong> Quarterly updates ensuring complete transparency.</li><li><strong>Predictable Costs:</strong> Consistent average cost without renewal fluctuations.</li><li><strong>Revolving Fund:</strong> Deposited funds remain the property of the principal, with remaining balances returned in case of non renewal.</li></ol><h4>Attached, please find the program files referenced during our meeting:</h4><ol><li>Gold: 80–40</li><li>Platinum: 180–40</li><li>Diamond: 360–60</li><li>Dental Benefits</li><li>24/7 Helpline – covering and supporting all of the above services and programs for seafarers and their families</li></ol><p>Once again, thank you for your time. We look forward to continuing our dialogue and exploring potential collaboration.</p><br><p>Kind regards,</p><br>{{signatures}}</div>',
            };
            return bodies[templateId] || '<p>Template body not available</p>';
        }
        
        async function previewEmail() {
            const templateId = document.getElementById('emailTemplate').value;
            const clientId = document.getElementById('emailClient').value;
            const previewBox = document.getElementById('emailPreviewBox');
            
            if (!templateId) {
                previewBox.innerHTML = '<p style="color: #999; text-align: center;">Select a template to see preview</p>';
                return;
            }
            
            if (!clientId) {
                // Use local preview if no client selected
                updatePreview();
                return;
            }
            
            previewBox.innerHTML = '<p style="color: #999; text-align: center;">Loading preview...</p>';
            
            try {
                const response = await fetch(`${API_URL}?action=previewEmail&templateId=${templateId}&clientId=${clientId}`);
                const data = await response.json();
                
                if (data.success && data.preview) {
                    // Update subject field
                    document.getElementById('emailSubject').value = data.preview.subject || '';
                    
                    // Show preview body using iframe for proper HTML rendering
                    previewBox.innerHTML = '';
                    const iframe = document.createElement('iframe');
                    iframe.style.cssText = 'width:100%;height:450px;border:none;background:#fff;border-radius:8px;';
                    previewBox.appendChild(iframe);
                    
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    iframeDoc.open();
                    iframeDoc.write(data.preview.body);
                    iframeDoc.close();
                } else {
                    previewBox.innerHTML = `<div class="email-status error">❌ ${data.error || 'Template not found'}</div>`;
                }
            } catch (err) {
                console.error('Preview error:', err);
                // Fallback to local preview
                updatePreview();
            }
        }
        
        function updateSendButton() {
            const btn = document.getElementById('emailSendBtn');
            const hasTemplate = document.getElementById('emailTemplate').value;
            const hasClient = document.getElementById('emailClient').value;
            const hasRecipients = selectedContacts.length > 0;
            
            btn.disabled = !(hasTemplate && hasClient && hasRecipients);
        }
        
        async function sendEmail() {
            const btn = document.getElementById('emailSendBtn');
            const statusDiv = document.getElementById('emailStatus');
            
            btn.disabled = true;
            btn.innerHTML = '📤 Sending...';
            statusDiv.innerHTML = '';
            
            const emailData = {
                template_id: document.getElementById('emailTemplate').value,
                client_id: document.getElementById('emailClient').value,
                subject: document.getElementById('emailSubject').value,
                recipients: selectedContacts.map(c => c.email).join(','),
                sent_by: currentUser?.username || 'admin'
            };
            
            try {
                // Use GET request with URL parameters to avoid CORS issues
                const params = new URLSearchParams({
                    action: 'sendEmail',
                    templateId: emailData.template_id,
                    clientId: emailData.client_id,
                    subject: emailData.subject,
                    recipients: emailData.recipients,
                    sent_by: emailData.sent_by
                });
                
                // Add meeting specific data if meeting_01 template
                if (emailData.template_id === 'meeting_01') {
                    params.append('greeting', getGreetingText());
                    params.append('attendees_text', buildAttendeesText());
                    params.append('signatures_html', buildSignaturesHTML());
                }
                
                const response = await fetch(`${API_URL}?${params.toString()}`);
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = '<div class="email-status success">✅ Email sent successfully to ' + selectedContacts.length + ' recipient(s)!</div>';
                    // Clear form
                    setTimeout(() => {
                        document.getElementById('emailTemplate').value = '';
                        document.getElementById('emailClient').value = '';
                        document.getElementById('emailRecipients').innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Select a client to see available contacts</p>';
                        document.getElementById('emailSubject').value = '';
                        document.getElementById('emailPreviewBox').innerHTML = '<p style="color: #999; text-align: center;">Select a template to see preview</p>';
                        document.getElementById('meetingOptionsBox').style.display = 'none';
                        selectedContacts = [];
                        selectedTeamMembers = [];
                        loadEmailHistory();
                    }, 2000);
                } else {
                    statusDiv.innerHTML = '<div class="email-status error">❌ ' + (result.error || 'Failed to send email') + '</div>';
                }
            } catch (err) {
                console.error('Send email error:', err);
                statusDiv.innerHTML = '<div class="email-status error">❌ Error sending email. Please try again.</div>';
            }
            
            btn.disabled = false;
            btn.innerHTML = '📤 Send Email';
            updateSendButton();
        }
        
        function loadTemplatesList() {
            const container = document.getElementById('templatesList');
            const filter = document.getElementById('templateFilter').value;
            
            let filtered = emailTemplates;
            if (filter !== 'all') {
                filtered = emailTemplates.filter(t => t.category === filter);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 2rem;">No templates found</p>';
                return;
            }
            
            container.innerHTML = filtered.map(t => `
                <div class="template-card" onclick="useTemplate('${t.template_id}')">
                    <div class="template-card-title">${getCategoryIcon(t.category)} ${t.template_name}</div>
                    <span class="template-card-category">${t.category}</span>
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">${t.subject}</p>
                </div>
            `).join('');
        }
        
        function getCategoryIcon(category) {
            const icons = {
                'contract': '📄',
                'client': '👥',
                'finance': '💰',
                'alert': '🚨',
                'wishes': '🎉'
            };
            return icons[category] || '📧';
        }
        
        function filterTemplates() {
            loadTemplatesList();
        }
        
        function useTemplate(templateId) {
            // Switch to compose tab and select template
            document.querySelectorAll('.email-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.email-tab').classList.add('active');
            
            document.getElementById('emailTabCompose').style.display = 'block';
            document.getElementById('emailTabTemplates').style.display = 'none';
            document.getElementById('emailTabHistory').style.display = 'none';
            
            document.getElementById('emailTemplate').value = templateId;
            handleTemplateChange();
        }
        
        async function loadEmailHistory() {
            const tbody = document.getElementById('emailHistoryBody');
            if (!tbody) return;
            
            try {
                console.log('Loading email history...');
                
                // Build clients map from cached data or fetch
                let clientsMap = {};
                if (cachedClientsData && cachedClientsData.length > 0) {
                    cachedClientsData.forEach(c => {
                        clientsMap[c.client_id] = c.client_name || c.contact_name || 'Unknown';
                    });
                } else {
                    try {
                        const clientsResp = await fetch(`${API_URL}?action=getClients`);
                        const clientsData = await clientsResp.json();
                        const clientList = clientsData.data || clientsData;
                        if (Array.isArray(clientList)) {
                            clientList.forEach(c => {
                                clientsMap[c.client_id] = c.client_name || c.contact_name || 'Unknown';
                            });
                        }
                    } catch (e) {
                        console.log('Could not load clients for mapping');
                    }
                }
                
                // Use cached email history if available
                let historyData = null;
                if (window.cachedEmailHistory && window.cachedEmailHistory.length > 0) {
                    console.log('Using cached email history');
                    historyData = window.cachedEmailHistory;
                } else {
                    const response = await fetch(`${API_URL}?action=getEmailHistory`);
                    const data = await response.json();
                    if (data.success && data.data) {
                        historyData = data.data;
                        window.cachedEmailHistory = data.data;
                    }
                }
                
                if (historyData && historyData.length > 0) {
                    tbody.innerHTML = historyData.slice(0, 50).map(log => {
                        const clientName = clientsMap[log.client_id] || log.client_name || log.client_id || '-';
                        return `
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 1rem; color: var(--text-secondary); font-size: 0.9rem;">${log.sent_date || '-'}</td>
                            <td style="padding: 1rem; color: #d4a843; font-weight: 600;">${clientName}</td>
                            <td style="padding: 1rem; color: var(--text-primary); max-width: 350px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${log.subject || log.template_id || ''}">${log.subject || log.template_id || '-'}</td>
                            <td style="padding: 1rem; color: var(--text-muted); font-size: 0.9rem; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${log.recipients || ''}">${log.recipients || '-'}</td>
                            <td style="padding: 1rem;">
                                <span style="padding: 0.3rem 0.75rem; border-radius: 6px; font-size: 0.85rem; background: ${log.status === 'sent' ? 'rgba(76,175,80,0.2)' : 'rgba(244,67,54,0.2)'}; color: ${log.status === 'sent' ? '#4CAF50' : '#e74c3c'};">
                                    ${log.status === 'sent' ? '✅ Sent' : '❌ Failed'}
                                </span>
                            </td>
                        </tr>
                    `;}).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="padding: 2rem; text-align: center; color: var(--text-muted);">No email history yet</td></tr>';
                }
            } catch (err) {
                console.error('Error loading email history:', err);
                tbody.innerHTML = '<tr><td colspan="5" style="padding: 2rem; text-align: center; color: var(--text-muted);">Error loading email history</td></tr>';
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // MEETING FOLLOW-UP / TEAM MEMBERS FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════════════
        
        let teamMembers = [];
        let selectedTeamMembers = [];
        
        async function loadTeamMembers() {
            const container = document.getElementById('teamMembersList');
            
            try {
                const response = await fetch(`${API_URL}?action=getTeamMembers`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    teamMembers = data.data.filter(m => m.is_active === 'TRUE');
                    renderTeamMembers();
                } else {
                    // Fallback with sample data
                    teamMembers = [
                        { member_id: 'TM001', name: 'Mr. Kagkelaris', title: 'General Manager', phone: '+30 210 XXX XXXX', email: 'kagkelaris@polaris-finance.com' },
                        { member_id: 'TM002', name: 'Mr. Koutsiouris', title: 'Business Director', phone: '+30 210 XXX XXXX', email: 'koutsiouris@polaris-finance.com' }
                    ];
                    renderTeamMembers();
                }
            } catch (err) {
                console.error('Error loading team members:', err);
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Error loading team members</p>';
            }
        }
        
        function renderTeamMembers() {
            const container = document.getElementById('teamMembersList');
            
            container.innerHTML = teamMembers.map((member, idx) => `
                <div class="email-recipient-item">
                    <input type="checkbox" id="team_${idx}" data-member-id="${member.member_id}" onchange="updateTeamMemberSelection()">
                    <div class="email-recipient-info">
                        <div class="email-recipient-name">${member.name}</div>
                        <div class="email-recipient-email">${member.title}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateTeamMemberSelection() {
            selectedTeamMembers = [];
            teamMembers.forEach((member, idx) => {
                const checkbox = document.getElementById(`team_${idx}`);
                if (checkbox && checkbox.checked) {
                    selectedTeamMembers.push(member);
                }
            });
            document.getElementById('teamMemberCount').textContent = selectedTeamMembers.length + ' selected';
            updateMeetingPreview();
        }
        
        function selectAllTeamMembers() {
            teamMembers.forEach((_, idx) => {
                const checkbox = document.getElementById(`team_${idx}`);
                if (checkbox) checkbox.checked = true;
            });
            updateTeamMemberSelection();
        }
        
        function clearAllTeamMembers() {
            teamMembers.forEach((_, idx) => {
                const checkbox = document.getElementById(`team_${idx}`);
                if (checkbox) checkbox.checked = false;
            });
            updateTeamMemberSelection();
        }
        
        function buildAttendeesText() {
            if (selectedTeamMembers.length === 0) return '';
            
            // Build vertical list with bullet points and line breaks
            const bulletList = selectedTeamMembers.map(m => 
                `• our ${m.title}, ${m.name}`
            ).join('<br>');
            
            return `<br>${bulletList}<br>`;
        }
        
        function buildSignaturesHTML() {
            if (selectedTeamMembers.length === 0) return '';
            
            return selectedTeamMembers.map(m => `
                <div style="margin-bottom: 15px;">
                    <p style="margin: 0; font-weight: bold;">${m.name}</p>
                    <p style="margin: 2px 0; color: #666;">${m.title}</p>
                    <p style="margin: 2px 0;">&#128222; ${m.phone || ''}</p>
                    <p style="margin: 2px 0;">&#128231; ${m.email || ''}</p>
                </div>
            `).join('');
        }
        
        function getGreetingText() {
            const greetingType = document.getElementById('meetingGreeting').value;
            const clientId = document.getElementById('emailClient').value;
            const client = clientsList.find(c => c.id === clientId);
            
            switch(greetingType) {
                case 'personal':
                    // Get first selected contact name
                    if (selectedContacts.length > 0) {
                        return `Dear ${selectedContacts[0].contact_name},`;
                    }
                    return 'Dear Sir/Madam,';
                case 'company':
                    if (client) {
                        return `Dear ${client.name.replace('🏢 ', '')} Team,`;
                    }
                    return 'Dear Team,';
                case 'generic':
                default:
                    return 'Dear All,';
            }
        }
        
        function updateMeetingPreview() {
            if (selectedTemplate?.template_id === 'meeting_01') {
                updatePreview();
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // BULK SEND FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════════════
        
        let selectedBulkClients = [];
        
        function populateBulkClients() {
            const container = document.getElementById('bulkClientsList');
            const clients = clientsList.filter(c => c.id !== 'all');
            
            if (clients.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">No clients available</p>';
                return;
            }
            
            container.innerHTML = clients.map((client, idx) => `
                <div class="email-recipient-item">
                    <input type="checkbox" id="bulk_client_${idx}" data-client-id="${client.id}" onchange="updateBulkSelection()">
                    <div class="email-recipient-info">
                        <div class="email-recipient-name">${client.name.replace('🏢 ', '')}</div>
                    </div>
                </div>
            `).join('');
            
            updateBulkSelection();
        }
        
        function selectAllBulkClients() {
            document.querySelectorAll('[id^="bulk_client_"]').forEach(cb => cb.checked = true);
            updateBulkSelection();
        }
        
        function clearAllBulkClients() {
            document.querySelectorAll('[id^="bulk_client_"]').forEach(cb => cb.checked = false);
            updateBulkSelection();
        }
        
        function updateBulkSelection() {
            selectedBulkClients = [];
            document.querySelectorAll('[id^="bulk_client_"]').forEach(cb => {
                if (cb.checked) {
                    selectedBulkClients.push(cb.dataset.clientId);
                }
            });
            
            const count = selectedBulkClients.length;
            document.getElementById('bulkClientCount').textContent = count + ' clients selected';
            
            // Calculate total emails based on role
            const role = document.getElementById('bulkRole').value;
            let emailsPerClient = role === 'All' ? 2.5 : 1; // Average
            const totalEmails = Math.round(count * emailsPerClient);
            document.getElementById('bulkTotalEmails').textContent = totalEmails;
            
            // Enable/disable send button
            const hasTemplate = document.getElementById('bulkTemplate').value;
            document.getElementById('bulkSendBtn').disabled = !(hasTemplate && count > 0);
        }
        
        function handleBulkTemplateChange() {
            const templateId = document.getElementById('bulkTemplate').value;
            const template = emailTemplates.find(t => t.template_id === templateId);
            
            if (template) {
                document.getElementById('bulkSubject').value = template.subject;
            } else {
                document.getElementById('bulkSubject').value = '';
            }
            
            updateBulkSelection();
        }
        
        function previewBulkEmail() {
            const templateId = document.getElementById('bulkTemplate').value;
            if (!templateId) {
                alert('Please select a template first');
                return;
            }
            
            // Switch to compose tab with first client for preview
            if (selectedBulkClients.length > 0) {
                document.getElementById('emailTemplate').value = templateId;
                document.getElementById('emailClient').value = selectedBulkClients[0];
                handleTemplateChange();
                loadClientContacts();
            }
            
            // Switch to compose tab
            document.querySelectorAll('.email-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.email-tab').classList.add('active');
            document.getElementById('emailTabCompose').style.display = 'block';
            document.getElementById('emailTabBulk').style.display = 'none';
        }
        
        async function sendBulkEmail() {
            const btn = document.getElementById('bulkSendBtn');
            const statusDiv = document.getElementById('bulkStatus');
            const templateId = document.getElementById('bulkTemplate').value;
            const role = document.getElementById('bulkRole').value;
            
            if (!templateId || selectedBulkClients.length === 0) {
                statusDiv.innerHTML = '<div class="email-status error">❌ Please select template and clients</div>';
                return;
            }
            
            // Confirm
            const confirmMsg = `Are you sure you want to send emails to ${selectedBulkClients.length} clients?`;
            if (!confirm(confirmMsg)) return;
            
            btn.disabled = true;
            btn.innerHTML = '🚀 Sending...';
            statusDiv.innerHTML = '<div class="email-status" style="background: rgba(33,150,243,0.2); color: #2196F3;">📤 Sending emails... Please wait...</div>';
            
            let successCount = 0;
            let failCount = 0;
            const template = emailTemplates.find(t => t.template_id === templateId);
            
            // Send to each client
            for (const clientId of selectedBulkClients) {
                try {
                    // Get contacts for this client
                    const response = await fetch(`${API_URL}?action=getClientContacts&clientId=${clientId}`);
                    const data = await response.json();
                    
                    let recipients = [];
                    if (data.success && data.data && data.data.length > 0) {
                        if (role === 'All') {
                            recipients = data.data.map(c => c.email);
                        } else {
                            recipients = data.data.filter(c => c.role === role || c.role === 'Primary').map(c => c.email);
                        }
                    }
                    
                    if (recipients.length === 0) {
                        console.log('No recipients for client:', clientId);
                        failCount++;
                        continue;
                    }
                    
                    // Send email
                    const params = new URLSearchParams({
                        action: 'sendEmail',
                        template_id: templateId,
                        client_id: clientId,
                        subject: template?.subject || 'Message from Polaris',
                        recipients: recipients.join(','),
                        sent_by: currentUser?.username || 'admin'
                    });
                    
                    const sendResponse = await fetch(`${API_URL}?${params.toString()}`);
                    const sendResult = await sendResponse.json();
                    
                    if (sendResult.success) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                    
                    // Update status
                    statusDiv.innerHTML = `<div class="email-status" style="background: rgba(33,150,243,0.2); color: #2196F3;">📤 Sending... ${successCount + failCount}/${selectedBulkClients.length} clients processed</div>`;
                    
                    // Small delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (err) {
                    console.error('Error sending to client:', clientId, err);
                    failCount++;
                }
            }
            
            // Final status
            if (failCount === 0) {
                statusDiv.innerHTML = `<div class="email-status success">✅ Successfully sent to all ${successCount} clients!</div>`;
            } else {
                statusDiv.innerHTML = `<div class="email-status" style="background: rgba(255,193,7,0.2); color: #FFC107;">⚠️ Sent: ${successCount} | Failed: ${failCount}</div>`;
            }
            
            btn.disabled = false;
            btn.innerHTML = '🚀 Send to ALL Selected';
            
            // Refresh history
            loadEmailHistory();
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // SCHEDULER FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════════════
        
        function populateSchedulerClients() {
            const select = document.getElementById('scheduleClient');
            select.innerHTML = '<option value="">-- Select client --</option><option value="ALL">📢 ALL CLIENTS</option>';
            
            const clients = clientsList.filter(c => c.id !== 'all');
            clients.forEach(client => {
                const opt = document.createElement('option');
                opt.value = client.id;
                opt.textContent = client.name.replace('🏢 ', '');
                select.appendChild(opt);
            });
            
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('scheduleDate').value = tomorrow.toISOString().split('T')[0];
            
            // Hide contacts box initially
            document.getElementById('scheduleContactsBox').style.display = 'none';
        }
        
        let scheduleContacts = [];
        let selectedScheduleContacts = [];
        
        async function loadSchedulerContacts() {
            const clientId = document.getElementById('scheduleClient').value;
            const contactsBox = document.getElementById('scheduleContactsBox');
            const contactsList = document.getElementById('scheduleContactsList');
            
            if (!clientId || clientId === 'ALL') {
                contactsBox.style.display = 'none';
                scheduleContacts = [];
                selectedScheduleContacts = [];
                return;
            }
            
            contactsBox.style.display = 'block';
            contactsList.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Loading contacts...</p>';
            
            try {
                const response = await fetch(`${API_URL}?action=getClientContacts&clientId=${clientId}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    scheduleContacts = data.data;
                    renderScheduleContacts();
                } else {
                    scheduleContacts = [];
                    contactsList.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">No contacts found for this client</p>';
                }
            } catch (err) {
                console.error('Error loading contacts:', err);
                contactsList.innerHTML = '<p style="color: var(--danger); text-align: center; padding: 1rem;">Error loading contacts</p>';
            }
            
            updateScheduleContactCount();
        }
        
        function renderScheduleContacts() {
            const container = document.getElementById('scheduleContactsList');
            
            if (scheduleContacts.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">No contacts available</p>';
                return;
            }
            
            container.innerHTML = scheduleContacts.map((contact, idx) => `
                <div class="email-recipient-item">
                    <input type="checkbox" id="schedule_contact_${idx}" data-email="${contact.email}" onchange="updateScheduleContactSelection()">
                    <div class="email-recipient-info">
                        <div class="email-recipient-name">${contact.contact_name}</div>
                        <div class="email-recipient-email">${contact.email}</div>
                    </div>
                    <span class="email-recipient-role">${contact.role}</span>
                </div>
            `).join('');
        }
        
        function updateScheduleContactSelection() {
            selectedScheduleContacts = [];
            scheduleContacts.forEach((contact, idx) => {
                const checkbox = document.getElementById(`schedule_contact_${idx}`);
                if (checkbox && checkbox.checked) {
                    selectedScheduleContacts.push(contact.email);
                }
            });
            updateScheduleContactCount();
        }
        
        function updateScheduleContactCount() {
            document.getElementById('scheduleContactCount').textContent = selectedScheduleContacts.length;
        }
        
        function selectAllScheduleContacts() {
            scheduleContacts.forEach((_, idx) => {
                const checkbox = document.getElementById(`schedule_contact_${idx}`);
                if (checkbox) checkbox.checked = true;
            });
            updateScheduleContactSelection();
        }
        
        function clearAllScheduleContacts() {
            scheduleContacts.forEach((_, idx) => {
                const checkbox = document.getElementById(`schedule_contact_${idx}`);
                if (checkbox) checkbox.checked = false;
            });
            updateScheduleContactSelection();
        }
        
        function selectScheduleByRole(role) {
            scheduleContacts.forEach((contact, idx) => {
                const checkbox = document.getElementById(`schedule_contact_${idx}`);
                if (checkbox) {
                    checkbox.checked = contact.role === role || contact.role === 'Primary';
                }
            });
            updateScheduleContactSelection();
        }
        
        async function addScheduledEmail() {
            const template = document.getElementById('scheduleTemplate').value;
            const client = document.getElementById('scheduleClient').value;
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            const notes = document.getElementById('scheduleNotes').value;
            const statusDiv = document.getElementById('scheduleStatus');
            
            // Validation
            if (!template || !client || !date || !time) {
                statusDiv.innerHTML = '<div class="email-status error">❌ Please fill in all required fields</div>';
                return;
            }
            
            // Check contacts selection (not for ALL)
            if (client !== 'ALL' && selectedScheduleContacts.length === 0) {
                statusDiv.innerHTML = '<div class="email-status error">❌ Please select at least one contact</div>';
                return;
            }
            
            // Check if date is in the future
            const scheduledDateTime = new Date(date + 'T' + time);
            if (scheduledDateTime <= new Date()) {
                statusDiv.innerHTML = '<div class="email-status error">❌ Scheduled time must be in the future</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="email-status" style="background: rgba(33,150,243,0.2); color: #2196F3;">⏳ Adding to schedule...</div>';
            
            try {
                const params = new URLSearchParams({
                    action: 'addScheduledEmail',
                    template_id: template,
                    client_id: client,
                    scheduled_date: date,
                    scheduled_time: time,
                    recipients: client === 'ALL' ? 'ALL' : selectedScheduleContacts.join(','),
                    notes: notes,
                    created_by: currentUser?.username || 'admin'
                });
                
                const response = await fetch(`${API_URL}?${params.toString()}`);
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = '<div class="email-status success">✅ Email scheduled successfully!</div>';
                    
                    // Clear form
                    document.getElementById('scheduleTemplate').value = '';
                    document.getElementById('scheduleClient').value = '';
                    document.getElementById('scheduleNotes').value = '';
                    document.getElementById('scheduleContactsBox').style.display = 'none';
                    selectedScheduleContacts = [];
                    scheduleContacts = [];
                    
                    // Refresh list
                    loadScheduledEmails();
                    
                    // Clear status after 3 seconds
                    setTimeout(() => { statusDiv.innerHTML = ''; }, 3000);
                } else {
                    statusDiv.innerHTML = '<div class="email-status error">❌ ' + (result.error || 'Failed to schedule') + '</div>';
                }
            } catch (err) {
                console.error('Schedule error:', err);
                statusDiv.innerHTML = '<div class="email-status error">❌ Error scheduling email</div>';
            }
        }
        
        async function loadScheduledEmails() {
            const tbody = document.getElementById('scheduledEmailsBody');
            
            try {
                const response = await fetch(`${API_URL}?action=getScheduledEmails`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    // Sort by date ascending (soonest first)
                    const sorted = data.data.sort((a, b) => {
                        const dateA = new Date(a.scheduled_date + 'T' + a.scheduled_time);
                        const dateB = new Date(b.scheduled_date + 'T' + b.scheduled_time);
                        return dateA - dateB;
                    });
                    
                    tbody.innerHTML = sorted.map(item => {
                        const isPast = new Date(item.scheduled_date + 'T' + item.scheduled_time) < new Date();
                        const statusColor = item.status === 'sent' ? '#4CAF50' : 
                                           item.status === 'cancelled' ? '#9e9e9e' :
                                           isPast ? '#ff9800' : '#2196F3';
                        const statusText = item.status === 'sent' ? '✅ Sent' : 
                                          item.status === 'cancelled' ? '❌ Cancelled' :
                                          isPast ? '⚠️ Pending' : '⏰ Scheduled';
                        
                        return `
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.75rem; color: var(--text-primary);">
                                    <strong>${item.scheduled_date}</strong><br>
                                    <span style="color: var(--text-muted); font-size: 0.85rem;">${item.scheduled_time}</span>
                                </td>
                                <td style="padding: 0.75rem; color: var(--text-secondary);">
                                    ${item.client_id === 'ALL' ? '📢 ALL CLIENTS' : item.client_id}
                                </td>
                                <td style="padding: 0.75rem; color: var(--text-secondary);">${item.template_id}</td>
                                <td style="padding: 0.75rem; color: var(--text-muted);">${item.recipient_role || 'Primary'}</td>
                                <td style="padding: 0.75rem;">
                                    <span style="color: ${statusColor}; font-weight: 500;">${statusText}</span>
                                </td>
                                <td style="padding: 0.75rem; text-align: center;">
                                    ${item.status === 'pending' ? `
                                        <button onclick="cancelScheduledEmail('${item.schedule_id}')" 
                                                style="background: #f44336; color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 5px; cursor: pointer; font-size: 0.8rem;">
                                            ❌ Cancel
                                        </button>
                                    ` : '-'}
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-muted);">No scheduled emails</td></tr>';
                }
            } catch (err) {
                console.error('Error loading scheduled emails:', err);
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-muted);">Error loading scheduled emails</td></tr>';
            }
        }
        
        async function cancelScheduledEmail(scheduleId) {
            if (!confirm('Are you sure you want to cancel this scheduled email?')) return;
            
            try {
                const response = await fetch(`${API_URL}?action=cancelScheduledEmail&schedule_id=${scheduleId}`);
                const result = await response.json();
                
                if (result.success) {
                    loadScheduledEmails();
                } else {
                    alert('Failed to cancel: ' + (result.error || 'Unknown error'));
                }
            } catch (err) {
                console.error('Cancel error:', err);
                alert('Error cancelling scheduled email');
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // SEND DOCUMENTS TAB FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════════════
        
        let selectedSendDocsClient = null;
        let sendDocsOriginalTemplate = '';
        
        function initSendDocsTab() {
            // Clear previous state
            clearSendDocsClient();
            document.getElementById('sendDocsClientSearch').value = '';
            document.querySelectorAll('#emailTabSenddocs input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.getElementById('emailDocsTemplate').value = '';
            document.getElementById('emailDocsPreview').innerHTML = '<p style="color: #999; text-align: center;">Select a template to see preview</p>';
            updateSendDocsEmailCount();
        }
        
        function searchSendDocsClients(query) {
            const dropdown = document.getElementById('sendDocsClientDropdown');
            
            if (query.length < 2) {
                dropdown.style.display = 'none';
                return;
            }
            
            // Filter clients - search in company name and contact name
            const filtered = clientsList.filter(c => {
                if (c.id === 'all') return false;
                const companyName = c.data?.client_name || c.name || '';
                const contactName = c.data?.contact_name || '';
                return companyName.toLowerCase().includes(query.toLowerCase()) ||
                       contactName.toLowerCase().includes(query.toLowerCase());
            });
            
            if (filtered.length === 0) {
                dropdown.innerHTML = '<div style="padding: 1rem; color: var(--text-muted); text-align: center;">No clients found</div>';
            } else {
                dropdown.innerHTML = filtered.slice(0, 10).map(c => {
                    // ALWAYS use client_name from data - this is the COMPANY name
                    const companyName = (c.data?.client_name || c.name || 'Unknown').replace('🏢 ', '');
                    const contactName = c.data?.contact_name || '';
                    return `
                    <div onclick="selectSendDocsClient('${c.id}', '${companyName.replace(/'/g, "\\'")}', this)" 
                         style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.2s;"
                         onmouseover="this.style.background='rgba(212,175,67,0.2)'"
                         onmouseout="this.style.background='transparent'">
                        <div style="color: #d4af37; font-weight: 600;">🏢 ${companyName}</div>
                        ${contactName ? `<div style="color: #7aa0c0; font-size: 0.8rem; margin-top: 2px;">👤 ${contactName}</div>` : ''}
                    </div>
                `}).join('');
            }
            
            dropdown.style.display = 'block';
        }
        
        async function selectSendDocsClient(clientId, clientName, element) {
            // Hide dropdown
            document.getElementById('sendDocsClientDropdown').style.display = 'none';
            document.getElementById('sendDocsClientSearch').value = '';
            
            // Store selection
            selectedSendDocsClient = { id: clientId, name: clientName };
            
            // Show selected client - loading first
            const selectedDiv = document.getElementById('sendDocsSelectedClient');
            document.getElementById('sendDocsClientName').textContent = 'Loading...';
            selectedDiv.style.display = 'block';
            
            // ALWAYS fetch fresh client data from API
            let clientData = null;
            try {
                const response = await fetch(`${API_URL}?action=getClients`);
                const result = await response.json();
                if (result.success && result.data) {
                    window.cachedClientsData = result.data; // Update cache
                    clientData = result.data.find(c => c.client_id === clientId);
                }
            } catch (e) {
                console.log('Could not fetch client data:', e);
            }
            
            if (clientData) {
                // ALWAYS use client_name from database - this is the COMPANY name
                document.getElementById('sendDocsClientName').textContent = clientData.client_name || clientName.replace('🏢 ', '');
                document.getElementById('sendDocsClientEmail').textContent = clientData.contact_email || clientData.email || 'No email on file';
                selectedSendDocsClient.email = clientData.contact_email || clientData.email;
                selectedSendDocsClient.data = clientData;
            } else {
                document.getElementById('sendDocsClientName').textContent = clientName.replace('🏢 ', '');
                document.getElementById('sendDocsClientEmail').textContent = 'No email on file';
            }
            
            // Load contacts for recipients
            await loadSendDocsContacts(clientId);
            
            // Update count
            updateSendDocsEmailCount();
        }
        
        async function loadSendDocsContacts(clientId) {
            const container = document.getElementById('emailDocsRecipients');
            container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Loading contacts...</p>';
            
            try {
                const response = await fetch(`${API_URL}?action=getClientContacts&client_id=${clientId}`);
                const result = await response.json();
                
                if (result.success && result.contacts && result.contacts.length > 0) {
                    container.innerHTML = result.contacts.map((contact, idx) => `
                        <div class="email-recipient-item">
                            <input type="checkbox" id="emailDocsRecip_${idx}" checked onchange="updateSendDocsEmailCount()">
                            <div class="email-recipient-info">
                                <div class="email-recipient-name">${contact.contact_name || 'Unknown'}</div>
                                <div class="email-recipient-email">${contact.email || 'No email'}</div>
                            </div>
                            <span class="email-recipient-role">${contact.role || 'Contact'}</span>
                        </div>
                    `).join('');
                } else {
                    // Try to get from selected client data
                    const client = selectedSendDocsClient?.data;
                    if (client && client.email) {
                        container.innerHTML = `
                            <div class="email-recipient-item">
                                <input type="checkbox" id="emailDocsRecip_0" checked onchange="updateSendDocsEmailCount()">
                                <div class="email-recipient-info">
                                    <div class="email-recipient-name">${client.contact_name || client.client_name || 'Primary Contact'}</div>
                                    <div class="email-recipient-email">${client.email}</div>
                                </div>
                                <span class="email-recipient-role">Primary</span>
                            </div>
                        `;
                    } else {
                        container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">No contacts found for this client</p>';
                    }
                }
            } catch (err) {
                console.error('Error loading contacts:', err);
                container.innerHTML = '<p style="color: #e74c3c; text-align: center; padding: 1rem;">Error loading contacts</p>';
            }
            
            updateSendDocsEmailCount();
        }
        
        function clearSendDocsClient() {
            selectedSendDocsClient = null;
            document.getElementById('sendDocsSelectedClient').style.display = 'none';
            document.getElementById('emailDocsRecipients').innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1.5rem;">🔍 Search and select a client first</p>';
            updateSendDocsEmailCount();
        }
        
        function selectAllEmailDocsRecipients() {
            document.querySelectorAll('#emailDocsRecipients input[type="checkbox"]').forEach(cb => cb.checked = true);
            updateSendDocsEmailCount();
        }
        
        function selectEmailDocsRecipientsByRole(role) {
            document.querySelectorAll('#emailDocsRecipients .email-recipient-item').forEach(item => {
                const roleSpan = item.querySelector('.email-recipient-role');
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (roleSpan && roleSpan.textContent.includes(role)) {
                    checkbox.checked = true;
                }
            });
            updateSendDocsEmailCount();
        }
        
        function clearAllEmailDocsRecipients() {
            document.querySelectorAll('#emailDocsRecipients input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateSendDocsEmailCount();
        }
        
        function toggleEmailDocsSignature() {
            const checkbox = document.getElementById('emailDocsSignCheck');
            const signatory = document.getElementById('emailDocsSignatory');
            signatory.disabled = !checkbox.checked;
            if (!checkbox.checked) signatory.value = '';
        }
        
        function updateSendDocsEmailCount() {
            let count = 0;
            
            // Count documents
            document.querySelectorAll('input[name="emailDoc"]:checked').forEach(() => count++);
            
            // Count programs
            document.querySelectorAll('input[name="emailProg"]:checked').forEach(() => count++);
            
            // Update display
            document.getElementById('emailDocsAttachCount').textContent = `📎 ${count} attachment${count !== 1 ? 's' : ''} selected`;
            
            // Enable/disable send button
            const hasClient = selectedSendDocsClient !== null;
            const hasRecipients = document.querySelectorAll('#emailDocsRecipients input[type="checkbox"]:checked').length > 0;
            const hasTemplate = document.getElementById('emailDocsTemplate').value !== '';
            const hasAttachments = count > 0;
            
            const sendBtn = document.getElementById('emailDocsSendBtn');
            const canSend = hasClient && hasRecipients && hasTemplate && hasAttachments;
            sendBtn.disabled = !canSend;
            sendBtn.style.opacity = canSend ? '1' : '0.5';
        }
        
        // Send Docs specific templates (for document delivery)
        const sendDocsTemplates = {
            'initial_contact': {
                subject: 'Non-Disclosure Agreement - {{client_name}}',
                body: `<div style="font-family: Arial, sans-serif; color: #333; line-height: 1.6;">
                    <p>Dear {{contact_name}},</p>
                    <p>Thank you for your interest in <strong>Polaris Financial Services</strong> healthcare solutions for your seafarers.</p>
                    <p>As a first step in our partnership discussions, please find attached our <strong>Non-Disclosure Agreement (NDA)</strong>.</p>
                    <p>Once signed and returned, we will be able to share:</p>
                    <ul>
                        <li>Detailed program information and coverage options</li>
                        <li>Customized pricing tailored to {{client_name}}'s specific needs</li>
                        <li>Our comprehensive healthcare proposal</li>
                    </ul>
                    <p>Please review the NDA at your earliest convenience. Should you have any questions or require any modifications, please don't hesitate to reach out.</p>
                    <p>We look forward to the opportunity of working with {{client_name}}.</p>
                    <br>
                    <p>Best regards,</p>
                    <p><strong>✦ POLARIS Financial Services</strong><br>
                    Healthcare Solutions for the Maritime Industry</p>
                </div>`
            },
            'proposal_submission': {
                subject: 'Healthcare TPA Proposal - {{client_name}}',
                body: `<div style="font-family: Arial, sans-serif; color: #333; line-height: 1.6;">
                    <p>Dear {{contact_name}},</p>
                    <p>Following our recent discussions, we are pleased to present our comprehensive <strong>Healthcare TPA Proposal</strong> for {{client_name}}.</p>
                    <p>The attached proposal includes:</p>
                    <ul>
                        <li>Detailed coverage options and benefit structures</li>
                        <li>Competitive pricing based on your specific requirements</li>
                        <li>Program comparisons to help you select the best fit</li>
                        <li>Implementation timeline and onboarding process</li>
                    </ul>
                    <p>We have also attached the relevant program brochures for your reference, providing detailed information about coverage limits, benefits, and features.</p>
                    <p>We would welcome the opportunity to discuss the proposal in detail and answer any questions you may have. Please let us know your availability for a follow-up call.</p>
                    <br>
                    <p>Best regards,</p>
                    <p><strong>✦ POLARIS Financial Services</strong><br>
                    Healthcare Solutions for the Maritime Industry</p>
                </div>`
            },
            'contract_documents': {
                subject: 'Contract Documents - {{client_name}}',
                body: `<div style="font-family: Arial, sans-serif; color: #333; line-height: 1.6;">
                    <p>Dear {{contact_name}},</p>
                    <p>We are delighted to move forward with {{client_name}}'s enrollment in our healthcare program.</p>
                    <p>Please find attached the following contract documents for your review and signature:</p>
                    <ul>
                        <li><strong>Data Processing Agreement (DPA)</strong> - Ensuring GDPR compliance and data protection</li>
                        <li><strong>Administrative Services Agreement (ASA)</strong> - Our main service contract outlining terms and conditions</li>
                    </ul>
                    <p><strong>Next Steps:</strong></p>
                    <ol>
                        <li>Review both documents carefully</li>
                        <li>Sign where indicated</li>
                        <li>Return the signed copies to us</li>
                        <li>We will countersign and return your copies</li>
                    </ol>
                    <p>Once we receive the signed documents, we will initiate the onboarding process and provide you with access to our member portal.</p>
                    <p>Please don't hesitate to contact us if you have any questions about the agreements.</p>
                    <br>
                    <p>Best regards,</p>
                    <p><strong>✦ POLARIS Financial Services</strong><br>
                    Healthcare Solutions for the Maritime Industry</p>
                </div>`
            },
            'program_info': {
                subject: 'Healthcare Program Information - {{client_name}}',
                body: `<div style="font-family: Arial, sans-serif; color: #333; line-height: 1.6;">
                    <p>Dear {{contact_name}},</p>
                    <p>As requested, please find attached detailed brochures for the healthcare programs we discussed.</p>
                    <p>Each brochure contains comprehensive information about:</p>
                    <ul>
                        <li>Coverage limits (annual and per illness/accident)</li>
                        <li>Included benefits and services</li>
                        <li>Network of healthcare providers</li>
                        <li>Claims process and support</li>
                    </ul>
                    <p>Our programs are designed specifically for the maritime industry, providing comprehensive coverage for seafarers and their dependents in the Philippines.</p>
                    <p>If you would like to discuss which program best suits {{client_name}}'s needs, please don't hesitate to contact us.</p>
                    <br>
                    <p>Best regards,</p>
                    <p><strong>✦ POLARIS Financial Services</strong><br>
                    Healthcare Solutions for the Maritime Industry</p>
                </div>`
            },
            'full_package': {
                subject: 'Complete Document Package - {{client_name}}',
                body: `<div style="font-family: Arial, sans-serif; color: #333; line-height: 1.6;">
                    <p>Dear {{contact_name}},</p>
                    <p>Please find attached a complete package of documents for {{client_name}}:</p>
                    <h4 style="color: #1e3a5f;">📄 Contract Documents:</h4>
                    <ul>
                        <li><strong>Non-Disclosure Agreement (NDA)</strong></li>
                        <li><strong>Data Processing Agreement (DPA)</strong></li>
                        <li><strong>Administrative Services Agreement (ASA)</strong></li>
                        <li><strong>Healthcare TPA Proposal</strong></li>
                    </ul>
                    <h4 style="color: #1e3a5f;">📋 Program Brochures:</h4>
                    <ul>
                        <li>Detailed coverage information for selected programs</li>
                    </ul>
                    <p>We recommend reviewing each document carefully. The NDA should be signed first before we can proceed with the formal proposal discussion.</p>
                    <p>Please contact us for any clarifications or questions about the documents.</p>
                    <br>
                    <p>Best regards,</p>
                    <p><strong>✦ POLARIS Financial Services</strong><br>
                    Healthcare Solutions for the Maritime Industry</p>
                </div>`
            },
            'followup_nda': {
                subject: 'Follow-up: NDA for {{client_name}}',
                body: `<div style="font-family: Arial, sans-serif; color: #333; line-height: 1.6;">
                    <p>Dear {{contact_name}},</p>
                    <p>I hope this message finds you well.</p>
                    <p>I wanted to follow up on the <strong>Non-Disclosure Agreement</strong> we sent previously for {{client_name}}.</p>
                    <p>Once we receive the signed NDA, we will be able to share:</p>
                    <ul>
                        <li>Our detailed healthcare proposal with customized pricing</li>
                        <li>Program options tailored to your crew's needs</li>
                        <li>Implementation timeline and next steps</li>
                    </ul>
                    <p>If you have any questions about the NDA or need any modifications to the agreement, please let me know and I'll be happy to assist.</p>
                    <p>Looking forward to your response.</p>
                    <br>
                    <p>Best regards,</p>
                    <p><strong>✦ POLARIS Financial Services</strong><br>
                    Healthcare Solutions for the Maritime Industry</p>
                </div>`
            },
            'followup_proposal': {
                subject: 'Follow-up: Proposal Review - {{client_name}}',
                body: `<div style="font-family: Arial, sans-serif; color: #333; line-height: 1.6;">
                    <p>Dear {{contact_name}},</p>
                    <p>I wanted to check in regarding the healthcare proposal we submitted for {{client_name}}.</p>
                    <p>Have you had a chance to review the coverage options and pricing? I would be happy to:</p>
                    <ul>
                        <li>Schedule a call to discuss any questions</li>
                        <li>Provide additional information about specific programs</li>
                        <li>Adjust the proposal based on your feedback</li>
                        <li>Arrange a presentation for your team</li>
                    </ul>
                    <p>We are committed to finding the best healthcare solution for {{client_name}}'s seafarers and their families.</p>
                    <p>Looking forward to your feedback.</p>
                    <br>
                    <p>Best regards,</p>
                    <p><strong>✦ POLARIS Financial Services</strong><br>
                    Healthcare Solutions for the Maritime Industry</p>
                </div>`
            },
            'followup_decision': {
                subject: 'Following Up - {{client_name}} Healthcare Program',
                body: `<div style="font-family: Arial, sans-serif; color: #333; line-height: 1.6;">
                    <p>Dear {{contact_name}},</p>
                    <p>I hope you're doing well.</p>
                    <p>I'm following up on our healthcare proposal for {{client_name}}.</p>
                    <p>Is there any additional information you need to help with your decision? We are here to assist with:</p>
                    <ul>
                        <li>Clarifications on coverage or benefits</li>
                        <li>Pricing adjustments or alternative options</li>
                        <li>References from our existing clients</li>
                        <li>Site visits or presentations</li>
                    </ul>
                    <p>We understand that choosing a healthcare partner is an important decision, and we're committed to providing the best solution for your team.</p>
                    <p>Please let me know how we can assist.</p>
                    <br>
                    <p>Best regards,</p>
                    <p><strong>✦ POLARIS Financial Services</strong><br>
                    Healthcare Solutions for the Maritime Industry</p>
                </div>`
            }
        };
        
        async function updateEmailDocsPreview() {
            const templateId = document.getElementById('emailDocsTemplate').value;
            const preview = document.getElementById('emailDocsPreview');
            const clientName = selectedSendDocsClient?.name?.replace('🏢 ', '') || '{{client_name}}';
            const contactName = selectedSendDocsClient?.data?.contact_name || '{{contact_name}}';
            const contactFirstName = contactName.split(' ')[0];
            
            if (!templateId) {
                preview.innerHTML = '<p style="color: #999; text-align: center;">Select a template to see preview</p>';
                sendDocsOriginalTemplate = '';
                return;
            }
            
            // Show loading
            preview.innerHTML = '<p style="color: #999; text-align: center;">Loading template...</p>';
            
            // First try to get from API (Google Drive stored templates)
            try {
                const response = await fetch(`${API_URL}?action=getEmailTemplateBody&template_id=${templateId}`);
                const result = await response.json();
                
                if (result.success && result.body_html) {
                    // Use template from Google Drive
                    let body = result.body_html;
                    body = replacePlaceholders(body, clientName, contactName, contactFirstName);
                    preview.innerHTML = body;
                    sendDocsOriginalTemplate = body;
                    updateSendDocsEmailCount();
                    return;
                }
            } catch (err) {
                console.log('Could not fetch template from API, using local:', err);
            }
            
            // Fall back to local templates
            const template = sendDocsTemplates[templateId];
            if (template) {
                let body = template.body;
                body = replacePlaceholders(body, clientName, contactName, contactFirstName);
                preview.innerHTML = body;
                sendDocsOriginalTemplate = body;
            } else {
                // Try existing email templates
                const existingTemplate = emailTemplates?.find(t => t.template_id === templateId);
                if (existingTemplate) {
                    let body = existingTemplate.body_html || getDefaultTemplateBody(templateId);
                    body = replacePlaceholders(body, clientName, contactName, contactFirstName);
                    preview.innerHTML = body;
                    sendDocsOriginalTemplate = body;
                } else {
                    preview.innerHTML = '<p style="color: #e74c3c; text-align: center;">Template not found</p>';
                    sendDocsOriginalTemplate = '';
                }
            }
            
            updateSendDocsEmailCount();
        }
        
        function replacePlaceholders(text, clientName, contactName, contactFirstName) {
            return text
                .replace(/\{\{client_name\}\}/gi, clientName)
                .replace(/\{\{contact_name\}\}/gi, contactFirstName || contactName)
                .replace(/\{\{contact_full_name\}\}/gi, contactName)
                .replace(/\{\{date\}\}/gi, new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }))
                .replace(/\{\{year\}\}/gi, new Date().getFullYear().toString())
                .replace(/\{\{company_name\}\}/gi, clientName);
        }
        
        function formatEmailDocsText(command) {
            const preview = document.getElementById('emailDocsPreview');
            preview.focus();
            document.execCommand(command, false, null);
        }
        
        function resetEmailDocsTemplate() {
            if (sendDocsOriginalTemplate) {
                if (confirm('Reset to original template? Your changes will be lost.')) {
                    document.getElementById('emailDocsPreview').innerHTML = sendDocsOriginalTemplate;
                }
            }
        }
        
        function showEmailDocsStatus(message, type) {
            const status = document.getElementById('emailDocsStatus');
            status.innerHTML = `<div class="email-status ${type}">${message}</div>`;
            if (type === 'success') {
                setTimeout(() => status.innerHTML = '', 5000);
            }
        }
        
        async function saveEmailDocsDraft() {
            showEmailDocsStatus('💾 Saving draft to Gmail...', 'loading');
            
            const data = collectEmailDocsData();
            
            if (!data.client) {
                showEmailDocsStatus('❌ Please select a client first.', 'error');
                return;
            }
            
            if (data.recipients.length === 0) {
                showEmailDocsStatus('❌ Please select at least one recipient.', 'error');
                return;
            }
            
            console.log('Saving draft:', data);
            
            try {
                const response = await fetch(`${API_URL}?action=createEmailDraft`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'createEmailDraft',
                        clientId: data.client.id,
                        clientName: data.client.name,
                        recipients: data.recipients,
                        documents: data.documents,
                        programs: data.programs,
                        emailBody: data.emailBody,
                        template: data.template,
                        signDocs: data.signDocs,
                        signatory: data.signatory
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showEmailDocsStatus('✅ Draft saved to Gmail! Check your drafts folder.', 'success');
                } else {
                    showEmailDocsStatus('❌ ' + (result.error || 'Failed to save draft'), 'error');
                }
            } catch (err) {
                console.error('Draft save error:', err);
                showEmailDocsStatus('❌ Error saving draft: ' + err.message, 'error');
            }
        }
        
        async function sendEmailDocs() {
            showEmailDocsStatus('📨 Preparing documents and sending...', 'loading');
            
            const data = collectEmailDocsData();
            
            if (!data.client) {
                showEmailDocsStatus('❌ Please select a client first.', 'error');
                return;
            }
            
            if (data.recipients.length === 0) {
                showEmailDocsStatus('❌ Please select at least one recipient.', 'error');
                return;
            }
            
            if (data.attachments.length === 0) {
                showEmailDocsStatus('❌ Please select at least one document to send.', 'error');
                return;
            }
            
            console.log('Sending documents:', data);
            
            try {
                const response = await fetch(`${API_URL}?action=sendDocumentsEmail`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({
                        action: 'sendDocumentsEmail',
                        clientId: data.client.id,
                        clientName: data.client.name,
                        recipients: data.recipients,
                        documents: data.documents,
                        programs: data.programs,
                        emailBody: data.emailBody,
                        template: data.template,
                        signDocs: data.signDocs,
                        signatory: data.signatory
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showEmailDocsStatus('✅ Documents sent successfully to ' + data.recipients.map(r => r.email).join(', '), 'success');
                    // Clear form after successful send
                    setTimeout(() => {
                        initSendDocsTab();
                    }, 3000);
                } else {
                    showEmailDocsStatus('❌ ' + (result.error || 'Failed to send email'), 'error');
                }
            } catch (err) {
                console.error('Send error:', err);
                showEmailDocsStatus('❌ Error sending: ' + err.message, 'error');
            }
        }
        
        function collectEmailDocsData() {
            const documents = [];
            document.querySelectorAll('input[name="emailDoc"]:checked').forEach(cb => documents.push(cb.value));
            
            const programs = [];
            document.querySelectorAll('input[name="emailProg"]:checked').forEach(cb => programs.push(cb.value));
            
            const recipients = [];
            document.querySelectorAll('#emailDocsRecipients .email-recipient-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    const email = item.querySelector('.email-recipient-email')?.textContent;
                    const name = item.querySelector('.email-recipient-name')?.textContent;
                    if (email && email !== 'No email') {
                        recipients.push({ name, email });
                    }
                }
            });
            
            return {
                client: selectedSendDocsClient,
                documents,
                programs,
                attachments: [...documents, ...programs],
                recipients,
                template: document.getElementById('emailDocsTemplate').value,
                emailBody: document.getElementById('emailDocsPreview').innerHTML,
                signDocs: document.getElementById('emailDocsSignCheck').checked,
                signatory: document.getElementById('emailDocsSignatory').value
            };
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // END EMAIL CENTER FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════════════
        
        function openReportBuilder() {
            document.getElementById('reportBuilderModal').classList.remove('hidden');
            document.getElementById('dashboardBtn').style.display = 'flex';
            document.getElementById('mainDashboardBtn').style.display = 'flex';
            updateSectionStyles();
        }
        
        function closeReportBuilder() {
            document.getElementById('reportBuilderModal').classList.add('hidden');
        }
        
        function selectTemplate(template) {
            // Remove active from all
            document.querySelectorAll('.rb-template-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Set sections based on template
            const templates = {
                board: { executive: true, inout: true, claims: true, cost: true, members: false, movement: false, plans: false, history: false, trends: false },
                monthly: { executive: true, inout: true, claims: true, cost: true, members: true, movement: true, plans: false, history: false, trends: false },
                executive: { executive: true, inout: false, claims: false, cost: true, members: false, movement: false, plans: false, history: false, trends: false },
                full: { executive: true, inout: true, claims: true, cost: true, members: true, movement: true, plans: true, history: true, trends: true }
            };
            
            reportConfig.sections = { ...templates[template] };
            
            // Update checkboxes
            Object.keys(reportConfig.sections).forEach(key => {
                const checkbox = document.getElementById('sec_' + key);
                if (checkbox) checkbox.checked = reportConfig.sections[key];
            });
            
            updateSectionStyles();
        }
        
        function selectFormat(format) {
            reportConfig.format = format;
            document.querySelectorAll('.rb-format-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('format' + format.charAt(0).toUpperCase() + format.slice(1)).classList.add('selected');
        }
        
        function updateSectionStyles() {
            document.querySelectorAll('.rb-section-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }
        
        // Add event listeners to checkboxes
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.rb-section-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const key = checkbox.id.replace('sec_', '');
                    reportConfig.sections[key] = checkbox.checked;
                    updateSectionStyles();
                });
            });
        });
        
        function previewReport() {
            const selectedSections = Object.entries(reportConfig.sections).filter(([k, v]) => v).map(([k]) => k);
            const pages = selectedSections.length + 1; // +1 for cover
            alert(`📄 Προεπισκόπηση Αναφοράς\n\n` +
                  `Περίοδος: ${reportConfig.fromPeriod} - ${reportConfig.toPeriod}\n` +
                  `Ενότητες: ${selectedSections.length}\n` +
                  `Εκτιμώμενες σελίδες: ${pages}\n` +
                  `Μορφή: ${reportConfig.format.toUpperCase()}`);
        }
        
        async function generateReport() {
            closeReportBuilder();
            
            // Get selected sections
            const sections = reportConfig.sections;
            
            // Call appropriate generator based on format
            if (reportConfig.format === 'pdf' || reportConfig.format === 'both') {
                await generateCustomPDF(sections);
            }
            
            if (reportConfig.format === 'excel' || reportConfig.format === 'both') {
                generateExcelReport();
            }
        }
        
        function generateExcelReport() {
            alert('📊 Excel export θα υλοποιηθεί σύντομα!\n\nΠρος το παρόν διαθέσιμη μόνο η PDF μορφή.');
        }
        
        async function generateCustomPDF(sections) {
            const modal = document.getElementById('reportModal');
            const progressBar = document.getElementById('reportProgressBar');
            const stepText = document.getElementById('reportStep');
            const statusText = document.getElementById('reportStatus');
            const titleText = document.getElementById('reportTitle');
            
            modal.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressBar.style.background = 'linear-gradient(90deg, #B8860B, #D4AF37)';
            titleText.textContent = 'Generating Report...';
            statusText.textContent = 'Preparing your custom report';
            
            const updateProgress = (percent, step) => {
                progressBar.style.width = percent + '%';
                stepText.textContent = step;
            };
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 12;
                const contentWidth = pageWidth - (margin * 2);
                
                const clientName = currentUser.username || currentUser.client_id || 'Client';
                const periodLabel = document.getElementById('periodBadge')?.textContent || 'Q3 2025';
                const reportDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                
                // Colors
                const purple = [0, 150, 136]; // Now teal instead of purple
                const purpleLight = [77, 182, 172]; // Teal light
                const green = [27, 94, 32];
                const greenLight = [76, 175, 80];
                const gold = [212, 175, 55];
                const blue = [25, 118, 210];
                const blueLight = [66, 165, 245];
                const red = [211, 47, 47];
                const redLight = [239, 83, 80];
                const orange = [255, 152, 0];
                const teal = [0, 150, 136];
                const textDark = [33, 33, 33];
                const textMuted = [117, 117, 117];
                const bgLight = [250, 250, 252];
                
                // Helper: Draw progress bar
                const drawProgressBar = (x, y, width, height, percent, color1, color2) => {
                    doc.setFillColor(230, 230, 235);
                    doc.roundedRect(x, y, width, height, height/2, height/2, 'F');
                    const fillWidth = (percent / 100) * width;
                    if (fillWidth > 0) {
                        doc.setFillColor(...color1);
                        doc.roundedRect(x, y, Math.max(fillWidth, height), height, height/2, height/2, 'F');
                    }
                };
                
                // Helper: Draw donut chart
                const drawDonut = (cx, cy, outerR, innerR, segments) => {
                    let startAngle = -Math.PI / 2;
                    segments.forEach(seg => {
                        const endAngle = startAngle + (seg.percent / 100) * Math.PI * 2;
                        doc.setFillColor(...seg.color);
                        
                        // Draw arc segment (approximation with polygon)
                        const points = [];
                        for (let a = startAngle; a <= endAngle; a += 0.1) {
                            points.push([cx + Math.cos(a) * outerR, cy + Math.sin(a) * outerR]);
                        }
                        for (let a = endAngle; a >= startAngle; a -= 0.1) {
                            points.push([cx + Math.cos(a) * innerR, cy + Math.sin(a) * innerR]);
                        }
                        
                        if (points.length > 2) {
                            doc.setFillColor(...seg.color);
                            // Simple filled arc
                            const midAngle = (startAngle + endAngle) / 2;
                            const midR = (outerR + innerR) / 2;
                            // Draw as thick arc
                            for (let r = innerR; r <= outerR; r += 0.5) {
                                for (let a = startAngle; a <= endAngle; a += 0.02) {
                                    const px = cx + Math.cos(a) * r;
                                    const py = cy + Math.sin(a) * r;
                                    doc.circle(px, py, 0.3, 'F');
                                }
                            }
                        }
                        startAngle = endAngle;
                    });
                    // Center circle
                    doc.setFillColor(255, 255, 255);
                    doc.circle(cx, cy, innerR, 'F');
                };
                
                // Helper: Mini KPI card
                const drawMiniKPI = (x, y, w, h, icon, label, value, color) => {
                    doc.setFillColor(...bgLight);
                    doc.roundedRect(x, y, w, h, 3, 3, 'F');
                    doc.setFillColor(...color);
                    doc.roundedRect(x, y, 4, h, 2, 2, 'F');
                    
                    doc.setFontSize(7);
                    doc.setTextColor(...textMuted);
                    doc.text(label.toUpperCase(), x + 8, y + 8);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...color);
                    doc.text(value, x + 8, y + 18);
                    doc.setFont('helvetica', 'normal');
                };
                
                // Get all values
                const totalMembers = document.getElementById('kpiMembers')?.textContent || '8,547';
                const totalClaims = document.getElementById('kpiClaims')?.textContent || '1,234';
                const approvedAmount = document.getElementById('kpiApproved')?.textContent || '$156,789';
                const costPerMember = document.getElementById('kpiCost')?.textContent || '$67.83';
                const utilization = document.getElementById('kpiUtilization')?.textContent || '14.4%';
                const inpatientCases = document.getElementById('inpatientCases')?.textContent || '308';
                const outpatientCases = document.getElementById('outpatientCases')?.textContent || '926';
                const inpatientCost = document.getElementById('inpatientCost')?.textContent || '$101,913';
                const outpatientCost = document.getElementById('outpatientCost')?.textContent || '$54,876';
                const principalCount = document.getElementById('principalCount')?.textContent || '3,419';
                const dependentCount = document.getElementById('dependentCount')?.textContent || '5,128';
                const newEnroll = document.getElementById('newEnrollments')?.textContent || '+684';
                const cancelled = document.getElementById('cancellations')?.textContent || '-256';
                const netChange = document.getElementById('netChange')?.textContent || '+428';
                
                let totalSections = Object.values(sections).filter(v => v).length;
                let sectionsDone = 0;
                
                // ==================== PAGE 1: COVER ====================
                updateProgress(5, 'Creating cover page...');
                await new Promise(r => setTimeout(r, 80));
                
                // Full page gradient header
                doc.setFillColor(...purple);
                doc.rect(0, 0, pageWidth, 100, 'F');
                
                // Decorative circles
                doc.setFillColor(140, 50, 180);
                doc.circle(180, 20, 40, 'F');
                doc.setFillColor(100, 20, 140);
                doc.circle(200, 80, 25, 'F');
                doc.setFillColor(160, 70, 200);
                doc.circle(20, 90, 15, 'F');
                
                // Gold accent bar
                doc.setFillColor(...gold);
                doc.rect(0, 98, pageWidth, 4, 'F');
                
                // Logo area
                doc.setFillColor(255, 255, 255);
                doc.roundedRect(margin, 15, 50, 20, 3, 3, 'F');
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...purple);
                doc.text('POLARIS', margin + 8, 27);
                
                // Main title
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(36);
                doc.setFont('helvetica', 'bold');
                doc.text('Analytics Report', margin, 60);
                
                doc.setFontSize(16);
                doc.setFont('helvetica', 'normal');
                doc.text(clientName, margin, 75);
                doc.setFontSize(12);
                doc.text(periodLabel + '  •  ' + reportDate, margin, 88);
                
                // Quick stats row
                let yPos = 115;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('QUICK OVERVIEW', margin, yPos);
                
                yPos += 8;
                const quickStats = [
                    { label: 'Members', value: totalMembers, color: green },
                    { label: 'Claims', value: totalClaims, color: blue },
                    { label: 'Approved', value: approvedAmount, color: gold },
                    { label: 'Cost/Member', value: costPerMember, color: purple }
                ];
                
                const statWidth = (contentWidth - 15) / 4;
                quickStats.forEach((stat, i) => {
                    const x = margin + (i * (statWidth + 5));
                    doc.setFillColor(...stat.color);
                    doc.roundedRect(x, yPos, statWidth, 28, 3, 3, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'normal');
                    doc.text(stat.label.toUpperCase(), x + 5, yPos + 9);
                    doc.setFontSize(13);
                    doc.setFont('helvetica', 'bold');
                    doc.text(stat.value, x + 5, yPos + 21);
                });
                
                // Report contents
                yPos += 45;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('REPORT CONTENTS', margin, yPos);
                
                yPos += 8;
                const sectionNames = {
                    executive: { name: 'Executive Summary', icon: '📊' },
                    inout: { name: 'Inpatient vs Outpatient', icon: '🏥' },
                    claims: { name: 'Claims Analysis', icon: '📋' },
                    cost: { name: 'Cost Breakdown', icon: '💰' },
                    members: { name: 'Member Analysis', icon: '👥' },
                    movement: { name: 'Member Movement', icon: '📈' },
                    plans: { name: 'Plan Performance', icon: '🏆' },
                    history: { name: 'Historical Data', icon: '📅' },
                    trends: { name: 'Trends', icon: '📊' }
                };
                
                let col = 0;
                Object.entries(sections).forEach(([key, enabled]) => {
                    if (enabled && sectionNames[key]) {
                        const x = margin + (col % 2) * (contentWidth / 2);
                        doc.setFillColor(...bgLight);
                        doc.roundedRect(x, yPos, contentWidth / 2 - 5, 12, 2, 2, 'F');
                        doc.setFillColor(...purple);
                        doc.circle(x + 6, yPos + 6, 3, 'F');
                        doc.setFontSize(9);
                        doc.setTextColor(...textDark);
                        doc.text(sectionNames[key].name, x + 14, yPos + 8);
                        col++;
                        if (col % 2 === 0) yPos += 15;
                    }
                });
                
                // Bottom decorative bar
                doc.setFillColor(...purple);
                doc.rect(0, pageHeight - 15, pageWidth, 15, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.text('Confidential  •  Polaris Financial Services  •  ' + reportDate, pageWidth / 2, pageHeight - 6, { align: 'center' });
                
                // ==================== PAGE 2: EXECUTIVE SUMMARY ====================
                if (sections.executive) {
                    sectionsDone++;
                    updateProgress(10 + (sectionsDone / totalSections * 70), 'Building Executive Summary...');
                    await new Promise(r => setTimeout(r, 80));
                    doc.addPage();
                    
                    // Header bar
                    doc.setFillColor(...purple);
                    doc.rect(0, 0, pageWidth, 22, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Executive Summary', margin, 14);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text(periodLabel, pageWidth - margin, 14, { align: 'right' });
                    
                    yPos = 32;
                    
                    // KPI Cards Row 1
                    const kpiW = (contentWidth - 10) / 3;
                    const kpis = [
                        { label: 'Total Members', value: totalMembers, sub: '+5.2% vs last period', color: green, subColor: greenLight },
                        { label: 'Total Claims', value: totalClaims, sub: '+12.3% vs last period', color: blue, subColor: red },
                        { label: 'Approved Amount', value: approvedAmount, sub: 'USD Equivalent', color: gold, subColor: textMuted }
                    ];
                    
                    kpis.forEach((kpi, i) => {
                        const x = margin + (i * (kpiW + 5));
                        
                        // Card background
                        doc.setFillColor(...bgLight);
                        doc.roundedRect(x, yPos, kpiW, 38, 4, 4, 'F');
                        
                        // Top color bar
                        doc.setFillColor(...kpi.color);
                        doc.roundedRect(x, yPos, kpiW, 5, 4, 4, 'F');
                        doc.rect(x, yPos + 3, kpiW, 2, 'F');
                        
                        // Label
                        doc.setFontSize(7);
                        doc.setTextColor(...textMuted);
                        doc.text(kpi.label.toUpperCase(), x + 6, yPos + 14);
                        
                        // Value
                        doc.setFontSize(16);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...kpi.color);
                        doc.text(kpi.value, x + 6, yPos + 26);
                        
                        // Sub text
                        doc.setFontSize(6);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(...kpi.subColor);
                        doc.text(kpi.sub, x + 6, yPos + 34);
                    });
                    
                    yPos += 48;
                    
                    // KPI Cards Row 2
                    const kpis2 = [
                        { label: 'Cost per Member', value: costPerMember, color: purple },
                        { label: 'Utilization Rate', value: utilization, color: teal },
                        { label: 'Avg Claim Value', value: '$127.05', color: orange }
                    ];
                    
                    kpis2.forEach((kpi, i) => {
                        const x = margin + (i * (kpiW + 5));
                        doc.setFillColor(...bgLight);
                        doc.roundedRect(x, yPos, kpiW, 32, 4, 4, 'F');
                        doc.setFillColor(...kpi.color);
                        doc.roundedRect(x, yPos, 4, 32, 2, 2, 'F');
                        
                        doc.setFontSize(7);
                        doc.setTextColor(...textMuted);
                        doc.text(kpi.label.toUpperCase(), x + 10, yPos + 12);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...kpi.color);
                        doc.text(kpi.value, x + 10, yPos + 25);
                    });
                    
                    yPos += 42;
                    
                    // Performance Metrics Section
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('PERFORMANCE METRICS', margin, yPos);
                    
                    yPos += 8;
                    
                    const metrics = [
                        { label: 'Claims Processing Rate', value: 94, target: 95, color: green },
                        { label: 'Cost Efficiency', value: 78, target: 80, color: blue },
                        { label: 'Member Satisfaction', value: 88, target: 85, color: purple },
                        { label: 'Network Utilization', value: 72, target: 75, color: orange }
                    ];
                    
                    metrics.forEach((m, i) => {
                        const y = yPos + (i * 18);
                        
                        // Background
                        doc.setFillColor(...bgLight);
                        doc.roundedRect(margin, y, contentWidth, 15, 2, 2, 'F');
                        
                        // Label
                        doc.setFontSize(8);
                        doc.setTextColor(...textDark);
                        doc.setFont('helvetica', 'normal');
                        doc.text(m.label, margin + 5, y + 10);
                        
                        // Progress bar
                        const barX = margin + 70;
                        const barW = 80;
                        drawProgressBar(barX, y + 5, barW, 5, m.value, m.color, m.color);
                        
                        // Value
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...m.color);
                        doc.text(m.value + '%', barX + barW + 5, y + 10);
                        
                        // Target
                        doc.setFontSize(6);
                        doc.setTextColor(...textMuted);
                        doc.text('Target: ' + m.target + '%', barX + barW + 20, y + 10);
                    });
                    
                    yPos += 80;
                    
                    // Period Comparison
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('PERIOD COMPARISON', margin, yPos);
                    
                    yPos += 6;
                    
                    // Table
                    const headers = ['Metric', 'Current', 'Previous', 'Change'];
                    const colWidths = [50, 35, 35, 40];
                    
                    // Header row
                    doc.setFillColor(...purple);
                    doc.roundedRect(margin, yPos, contentWidth, 10, 2, 2, 'F');
                    doc.rect(margin, yPos + 5, contentWidth, 5, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    
                    let xPos = margin + 5;
                    headers.forEach((h, i) => {
                        doc.text(h, xPos, yPos + 7);
                        xPos += colWidths[i];
                    });
                    
                    yPos += 10;
                    
                    const rows = [
                        ['Total Claims', '1,234', '1,099', '+12.3%', greenLight],
                        ['Members', '8,547', '8,119', '+5.2%', greenLight],
                        ['Approved (USD)', '$156,789', '$142,350', '+10.1%', greenLight],
                        ['Cost/Member', '$67.83', '$62.45', '+8.6%', redLight]
                    ];
                    
                    rows.forEach((row, ri) => {
                        const y = yPos + (ri * 12);
                        doc.setFillColor(ri % 2 === 0 ? 250 : 245, ri % 2 === 0 ? 250 : 248, 252);
                        doc.rect(margin, y, contentWidth, 12, 'F');
                        
                        xPos = margin + 5;
                        row.slice(0, 4).forEach((cell, ci) => {
                            if (ci === 3) {
                                doc.setTextColor(...row[4]);
                                doc.setFont('helvetica', 'bold');
                            } else if (ci === 0) {
                                doc.setTextColor(...textDark);
                                doc.setFont('helvetica', 'bold');
                            } else {
                                doc.setTextColor(...textDark);
                                doc.setFont('helvetica', 'normal');
                            }
                            doc.setFontSize(8);
                            doc.text(cell, xPos, y + 8);
                            xPos += colWidths[ci];
                        });
                    });
                    
                    // Footer
                    doc.setFillColor(...purple);
                    doc.rect(0, pageHeight - 8, pageWidth, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6);
                    doc.text('Page 2  •  Polaris Financial Services  •  Confidential', pageWidth / 2, pageHeight - 3, { align: 'center' });
                }
                
                // ==================== PAGE 3: INPATIENT VS OUTPATIENT ====================
                if (sections.inout) {
                    sectionsDone++;
                    updateProgress(10 + (sectionsDone / totalSections * 70), 'Adding Inpatient/Outpatient...');
                    await new Promise(r => setTimeout(r, 80));
                    doc.addPage();
                    
                    // Header
                    doc.setFillColor(...purple);
                    doc.rect(0, 0, pageWidth, 22, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Inpatient vs Outpatient Analysis', margin, 14);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text(periodLabel, pageWidth - margin, 14, { align: 'right' });
                    
                    yPos = 32;
                    
                    // Main stats boxes
                    const boxW = (contentWidth - 10) / 2;
                    
                    // Inpatient Box
                    doc.setFillColor(...red);
                    doc.roundedRect(margin, yPos, boxW, 55, 5, 5, 'F');
                    
                    // Inner lighter box
                    doc.setFillColor(239, 154, 154);
                    doc.roundedRect(margin + boxW - 45, yPos + 5, 40, 45, 3, 3, 'F');
                    doc.setFontSize(8);
                    doc.setTextColor(...red);
                    doc.text('25%', margin + boxW - 30, yPos + 30);
                    doc.setFontSize(6);
                    doc.text('of cases', margin + boxW - 33, yPos + 38);
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text('INPATIENT', margin + 8, yPos + 14);
                    doc.setFontSize(26);
                    doc.setFont('helvetica', 'bold');
                    doc.text(inpatientCases, margin + 8, yPos + 35);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Cases', margin + 8, yPos + 45);
                    
                    // Outpatient Box
                    doc.setFillColor(...blue);
                    doc.roundedRect(margin + boxW + 10, yPos, boxW, 55, 5, 5, 'F');
                    
                    doc.setFillColor(144, 202, 249);
                    doc.roundedRect(margin + boxW + 10 + boxW - 45, yPos + 5, 40, 45, 3, 3, 'F');
                    doc.setFontSize(8);
                    doc.setTextColor(...blue);
                    doc.text('75%', margin + boxW + 10 + boxW - 30, yPos + 30);
                    doc.setFontSize(6);
                    doc.text('of cases', margin + boxW + 10 + boxW - 33, yPos + 38);
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text('OUTPATIENT', margin + boxW + 18, yPos + 14);
                    doc.setFontSize(26);
                    doc.setFont('helvetica', 'bold');
                    doc.text(outpatientCases, margin + boxW + 18, yPos + 35);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Cases', margin + boxW + 18, yPos + 45);
                    
                    yPos += 65;
                    
                    // Cost Comparison
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('COST ANALYSIS', margin, yPos);
                    
                    yPos += 8;
                    
                    // Visual bar comparison
                    const totalCostVal = 156789;
                    const inCostVal = 101913;
                    const outCostVal = 54876;
                    const inPct = (inCostVal / totalCostVal * 100).toFixed(0);
                    const outPct = (outCostVal / totalCostVal * 100).toFixed(0);
                    
                    // Stacked bar
                    doc.setFillColor(...red);
                    const inBarW = (inCostVal / totalCostVal) * contentWidth;
                    doc.roundedRect(margin, yPos, inBarW, 25, 3, 3, 'F');
                    doc.rect(margin + inBarW - 5, yPos, 5, 25, 'F');
                    
                    doc.setFillColor(...blue);
                    doc.roundedRect(margin + inBarW, yPos, contentWidth - inBarW, 25, 3, 3, 'F');
                    doc.rect(margin + inBarW, yPos, 5, 25, 'F');
                    
                    // Labels on bar
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Inpatient ' + inPct + '%', margin + 8, yPos + 10);
                    doc.text(inpatientCost, margin + 8, yPos + 19);
                    
                    doc.text('Outpatient ' + outPct + '%', margin + inBarW + 8, yPos + 10);
                    doc.text(outpatientCost, margin + inBarW + 8, yPos + 19);
                    
                    yPos += 35;
                    
                    // Detailed breakdown table
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('DETAILED BREAKDOWN', margin, yPos);
                    
                    yPos += 8;
                    
                    const detailHeaders = ['Category', 'Cases', 'Cost', 'Avg/Case', '% Total'];
                    const detailWidths = [40, 30, 40, 35, 30];
                    
                    doc.setFillColor(...purple);
                    doc.roundedRect(margin, yPos, contentWidth, 10, 2, 2, 'F');
                    doc.rect(margin, yPos + 5, contentWidth, 5, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    
                    xPos = margin + 3;
                    detailHeaders.forEach((h, i) => {
                        doc.text(h, xPos, yPos + 7);
                        xPos += detailWidths[i];
                    });
                    
                    yPos += 10;
                    
                    const detailRows = [
                        { data: ['Inpatient', '308', '$101,913', '$330.89', '65%'], color: red },
                        { data: ['Outpatient', '926', '$54,876', '$59.26', '35%'], color: blue },
                        { data: ['TOTAL', '1,234', '$156,789', '$127.05', '100%'], color: purple, bold: true }
                    ];
                    
                    detailRows.forEach((row, ri) => {
                        const y = yPos + (ri * 14);
                        
                        if (row.bold) {
                            doc.setFillColor(240, 235, 245);
                        } else {
                            doc.setFillColor(ri % 2 === 0 ? 255 : 250, ri % 2 === 0 ? 248 : 245, ri % 2 === 0 ? 248 : 250);
                        }
                        doc.roundedRect(margin, y, contentWidth, 14, ri === detailRows.length - 1 ? 2 : 0, ri === detailRows.length - 1 ? 2 : 0, 'F');
                        
                        // Color indicator
                        doc.setFillColor(...row.color);
                        doc.roundedRect(margin, y, 3, 14, 1, 1, 'F');
                        
                        xPos = margin + 6;
                        row.data.forEach((cell, ci) => {
                            doc.setFontSize(8);
                            if (ci === 0 || row.bold) {
                                doc.setFont('helvetica', 'bold');
                                doc.setTextColor(...row.color);
                            } else {
                                doc.setFont('helvetica', 'normal');
                                doc.setTextColor(...textDark);
                            }
                            doc.text(cell, xPos, y + 9);
                            xPos += detailWidths[ci];
                        });
                    });
                    
                    yPos += 55;
                    
                    // Trends mini section
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('MONTHLY TREND', margin, yPos);
                    
                    yPos += 8;
                    
                    // Simple bar chart
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                    const barWidth = (contentWidth - 30) / 6;
                    
                    doc.setFillColor(...bgLight);
                    doc.roundedRect(margin, yPos, contentWidth, 50, 3, 3, 'F');
                    
                    const inData = [45, 52, 38, 61, 55, 51];
                    const outData = [120, 135, 142, 128, 155, 154];
                    const maxVal = 160;
                    
                    months.forEach((m, i) => {
                        const x = margin + 15 + (i * barWidth);
                        const inH = (inData[i] / maxVal) * 35;
                        const outH = (outData[i] / maxVal) * 35;
                        
                        // Outpatient bar
                        doc.setFillColor(...blue);
                        doc.roundedRect(x, yPos + 45 - outH, barWidth * 0.35, outH, 1, 1, 'F');
                        
                        // Inpatient bar
                        doc.setFillColor(...red);
                        doc.roundedRect(x + barWidth * 0.4, yPos + 45 - inH, barWidth * 0.35, inH, 1, 1, 'F');
                        
                        // Month label
                        doc.setFontSize(6);
                        doc.setTextColor(...textMuted);
                        doc.text(m, x + barWidth * 0.2, yPos + 48);
                    });
                    
                    // Legend
                    doc.setFillColor(...red);
                    doc.rect(margin + contentWidth - 60, yPos + 5, 8, 4, 'F');
                    doc.setFillColor(...blue);
                    doc.rect(margin + contentWidth - 60, yPos + 12, 8, 4, 'F');
                    doc.setFontSize(6);
                    doc.setTextColor(...textDark);
                    doc.text('Inpatient', margin + contentWidth - 50, yPos + 8);
                    doc.text('Outpatient', margin + contentWidth - 50, yPos + 15);
                    
                    // Footer
                    doc.setFillColor(...purple);
                    doc.rect(0, pageHeight - 8, pageWidth, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6);
                    doc.text('Page 3  •  Polaris Financial Services  •  Confidential', pageWidth / 2, pageHeight - 3, { align: 'center' });
                }
                
                // ==================== PAGE 4: CLAIMS ANALYSIS ====================
                if (sections.claims) {
                    sectionsDone++;
                    updateProgress(10 + (sectionsDone / totalSections * 70), 'Building Claims Analysis...');
                    await new Promise(r => setTimeout(r, 80));
                    doc.addPage();
                    
                    // Header
                    doc.setFillColor(...purple);
                    doc.rect(0, 0, pageWidth, 22, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Claims Analysis', margin, 14);
                    
                    yPos = 32;
                    
                    // Claims overview cards
                    const claimCards = [
                        { label: 'Total Claims', value: totalClaims, icon: '📋', color: blue },
                        { label: 'Approved', value: approvedAmount, icon: '✓', color: green },
                        { label: 'Avg Claim', value: '$127.05', icon: '📊', color: gold },
                        { label: 'Pending', value: '23', icon: '⏳', color: orange }
                    ];
                    
                    const cardW = (contentWidth - 15) / 4;
                    claimCards.forEach((card, i) => {
                        const x = margin + (i * (cardW + 5));
                        doc.setFillColor(...card.color);
                        doc.roundedRect(x, yPos, cardW, 40, 4, 4, 'F');
                        
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'normal');
                        doc.text(card.label.toUpperCase(), x + 5, yPos + 12);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text(card.value, x + 5, yPos + 28);
                    });
                    
                    yPos += 52;
                    
                    // Claims by category
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('CLAIMS BY CATEGORY', margin, yPos);
                    
                    yPos += 8;
                    
                    const categories = [
                        { name: 'Consultation', count: 412, amount: '$28,450', pct: 33, color: blue },
                        { name: 'Laboratory', count: 289, amount: '$22,340', pct: 23, color: green },
                        { name: 'Pharmacy', count: 234, amount: '$18,920', pct: 19, color: purple },
                        { name: 'Hospitalization', count: 156, amount: '$52,430', pct: 13, color: red },
                        { name: 'Emergency', count: 89, amount: '$24,120', pct: 7, color: orange },
                        { name: 'Others', count: 54, amount: '$10,529', pct: 5, color: teal }
                    ];
                    
                    categories.forEach((cat, i) => {
                        const y = yPos + (i * 16);
                        
                        doc.setFillColor(...bgLight);
                        doc.roundedRect(margin, y, contentWidth, 14, 2, 2, 'F');
                        
                        // Color bar
                        doc.setFillColor(...cat.color);
                        doc.roundedRect(margin, y, 3, 14, 1, 1, 'F');
                        
                        // Name
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...cat.color);
                        doc.text(cat.name, margin + 8, y + 9);
                        
                        // Count
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(...textDark);
                        doc.text(cat.count + ' claims', margin + 50, y + 9);
                        
                        // Progress bar
                        drawProgressBar(margin + 90, y + 4, 50, 5, cat.pct, cat.color, cat.color);
                        
                        // Amount
                        doc.setFont('helvetica', 'bold');
                        doc.text(cat.amount, margin + 145, y + 9);
                        
                        // Percentage
                        doc.setTextColor(...cat.color);
                        doc.text(cat.pct + '%', margin + contentWidth - 15, y + 9);
                    });
                    
                    yPos += 105;
                    
                    // Claims trend
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('CLAIMS PROCESSING STATUS', margin, yPos);
                    
                    yPos += 8;
                    
                    doc.setFillColor(...bgLight);
                    doc.roundedRect(margin, yPos, contentWidth, 45, 3, 3, 'F');
                    
                    // Status breakdown
                    const statuses = [
                        { name: 'Approved', value: 1156, pct: 94, color: green },
                        { name: 'Pending', value: 23, pct: 2, color: orange },
                        { name: 'Under Review', value: 32, pct: 3, color: blue },
                        { name: 'Denied', value: 23, pct: 1, color: red }
                    ];
                    
                    const statusW = (contentWidth - 20) / 4;
                    statuses.forEach((s, i) => {
                        const x = margin + 5 + (i * statusW);
                        
                        doc.setFillColor(...s.color);
                        doc.circle(x + 8, yPos + 15, 5, 'F');
                        
                        doc.setFontSize(7);
                        doc.setTextColor(...textMuted);
                        doc.text(s.name, x + 18, yPos + 13);
                        
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...s.color);
                        doc.text(s.value.toString(), x + 18, yPos + 26);
                        
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'normal');
                        doc.text(s.pct + '%', x + 18, yPos + 35);
                    });
                    
                    // Footer
                    doc.setFillColor(...purple);
                    doc.rect(0, pageHeight - 8, pageWidth, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6);
                    doc.text('Page 4  •  Polaris Financial Services  •  Confidential', pageWidth / 2, pageHeight - 3, { align: 'center' });
                }
                
                // ==================== PAGE 5: COST BREAKDOWN ====================
                if (sections.cost) {
                    sectionsDone++;
                    updateProgress(10 + (sectionsDone / totalSections * 70), 'Adding Cost Breakdown...');
                    await new Promise(r => setTimeout(r, 80));
                    doc.addPage();
                    
                    // Header
                    doc.setFillColor(...purple);
                    doc.rect(0, 0, pageWidth, 22, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Cost Breakdown', margin, 14);
                    
                    yPos = 32;
                    
                    // Main cost display
                    doc.setFillColor(...green);
                    doc.roundedRect(margin, yPos, contentWidth, 50, 5, 5, 'F');
                    
                    // Decorative element
                    doc.setFillColor(56, 142, 60);
                    doc.circle(margin + contentWidth - 30, yPos + 25, 35, 'F');
                    doc.setFillColor(76, 175, 80);
                    doc.circle(margin + contentWidth - 25, yPos + 20, 20, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text('TOTAL COST PER MEMBER', margin + 12, yPos + 18);
                    doc.setFontSize(32);
                    doc.setFont('helvetica', 'bold');
                    doc.text(costPerMember, margin + 12, yPos + 42);
                    
                    yPos += 60;
                    
                    // Cost components
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('COST COMPONENTS', margin, yPos);
                    
                    yPos += 8;
                    
                    const costNum = 67.83;
                    const components = [
                        { name: 'Base Claims Cost', value: (costNum * 0.70).toFixed(2), pct: 70, color: green },
                        { name: 'Audit Fee (15%)', value: (costNum * 0.105).toFixed(2), pct: 10.5, color: gold },
                        { name: 'Administrative', value: '8.50', pct: 12.5, color: blue },
                        { name: 'Registration Fee', value: '2.00', pct: 3, color: purple },
                        { name: 'Service Fee', value: '0.75', pct: 1, color: orange },
                        { name: 'Other Fees', value: '2.10', pct: 3, color: teal }
                    ];
                    
                    components.forEach((comp, i) => {
                        const y = yPos + (i * 20);
                        
                        doc.setFillColor(...bgLight);
                        doc.roundedRect(margin, y, contentWidth, 18, 2, 2, 'F');
                        
                        // Color indicator
                        doc.setFillColor(...comp.color);
                        doc.roundedRect(margin + 3, y + 3, 12, 12, 2, 2, 'F');
                        
                        // Name
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...textDark);
                        doc.text(comp.name, margin + 20, y + 12);
                        
                        // Progress bar
                        drawProgressBar(margin + 80, y + 6, 60, 5, comp.pct, comp.color, comp.color);
                        
                        // Value
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...comp.color);
                        doc.text('$' + comp.value, margin + 150, y + 12);
                    });
                    
                    yPos += 130;
                    
                    // Cost trend mini chart
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('COST TREND (6 MONTHS)', margin, yPos);
                    
                    yPos += 8;
                    
                    doc.setFillColor(...bgLight);
                    doc.roundedRect(margin, yPos, contentWidth, 55, 3, 3, 'F');
                    
                    // Draw line chart
                    const costData = [58.2, 61.4, 63.8, 65.2, 66.5, 67.83];
                    const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                    const chartMargin = 25;
                    const chartW = contentWidth - chartMargin * 2;
                    const chartH = 35;
                    const minCost = 55;
                    const maxCost = 75;
                    
                    // Grid lines
                    doc.setDrawColor(220, 220, 220);
                    doc.setLineWidth(0.2);
                    for (let i = 0; i <= 4; i++) {
                        const gy = yPos + 8 + (i * chartH / 4);
                        doc.line(margin + chartMargin, gy, margin + chartMargin + chartW, gy);
                    }
                    
                    // Y-axis labels
                    doc.setFontSize(6);
                    doc.setTextColor(...textMuted);
                    doc.text('$75', margin + 5, yPos + 10);
                    doc.text('$65', margin + 5, yPos + 27);
                    doc.text('$55', margin + 5, yPos + 44);
                    
                    // Draw line
                    doc.setDrawColor(...green);
                    doc.setLineWidth(1);
                    
                    costData.forEach((val, i) => {
                        const x = margin + chartMargin + (i * chartW / 5);
                        const y = yPos + 8 + ((maxCost - val) / (maxCost - minCost)) * chartH;
                        
                        if (i > 0) {
                            const prevX = margin + chartMargin + ((i - 1) * chartW / 5);
                            const prevY = yPos + 8 + ((maxCost - costData[i-1]) / (maxCost - minCost)) * chartH;
                            doc.line(prevX, prevY, x, y);
                        }
                        
                        // Point
                        doc.setFillColor(...green);
                        doc.circle(x, y, 2, 'F');
                        
                        // Month label
                        doc.setFontSize(6);
                        doc.setTextColor(...textMuted);
                        doc.text(monthLabels[i], x - 4, yPos + 52);
                    });
                    
                    // Footer
                    doc.setFillColor(...purple);
                    doc.rect(0, pageHeight - 8, pageWidth, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6);
                    doc.text('Page 5  •  Polaris Financial Services  •  Confidential', pageWidth / 2, pageHeight - 3, { align: 'center' });
                }
                
                // ==================== FINALIZE ====================
                updateProgress(95, 'Finalizing...');
                await new Promise(r => setTimeout(r, 100));
                
                // ==================== SAVE ====================
                updateProgress(100, 'Complete!');
                titleText.textContent = 'Report Ready!';
                statusText.textContent = 'Your custom report has been generated';
                stepText.textContent = 'Downloading...';
                
                await new Promise(r => setTimeout(r, 500));
                
                const fileName = `Polaris_Report_${clientName.replace(/\s+/g, '_')}_${periodLabel.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 1500);
                
            } catch (error) {
                console.error('Report error:', error);
                titleText.textContent = 'Error';
                statusText.textContent = 'Failed to generate report';
                stepText.textContent = error.message;
                progressBar.style.background = '#e74c3c';
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 3000);
            }
        }
        
        // Store dashboard data globally for report
        let dashboardData = null;
        
        async function generateClientReport() {
            const modal = document.getElementById('reportModal');
            const progressBar = document.getElementById('reportProgressBar');
            const stepText = document.getElementById('reportStep');
            const statusText = document.getElementById('reportStatus');
            const titleText = document.getElementById('reportTitle');
            
            modal.classList.remove('hidden');
            
            const updateProgress = (percent, step) => {
                progressBar.style.width = percent + '%';
                stepText.textContent = step;
            };
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);
                
                // Get current data
                const clientName = currentUser.username || currentUser.client_id || 'Client';
                const periodLabel = document.getElementById('periodBadge')?.textContent || 'Current Period';
                const reportDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                
                // Colors
                const greenDark = [27, 94, 32];
                const greenLight = [46, 125, 50];
                const gold = [212, 175, 55];
                const textDark = [30, 30, 30];
                const textMuted = [120, 120, 120];
                
                // ==================== PAGE 1: COVER ====================
                updateProgress(10, 'Creating cover page...');
                await new Promise(r => setTimeout(r, 200));
                
                // Green header bar
                doc.setFillColor(...greenDark);
                doc.rect(0, 0, pageWidth, 60, 'F');
                
                // Gold accent line
                doc.setFillColor(...gold);
                doc.rect(0, 58, pageWidth, 4, 'F');
                
                // Company name
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(28);
                doc.setFont('helvetica', 'bold');
                doc.text('POLARIS', margin, 30);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'normal');
                doc.text('FINANCIAL SERVICES', margin, 40);
                
                // Report title
                doc.setTextColor(...textDark);
                doc.setFontSize(32);
                doc.setFont('helvetica', 'bold');
                doc.text('Client Analytics Report', margin, 100);
                
                // Client name
                doc.setFontSize(20);
                doc.setTextColor(...greenDark);
                doc.text(clientName, margin, 120);
                
                // Period
                doc.setFontSize(14);
                doc.setTextColor(...textMuted);
                doc.text('Period: ' + periodLabel, margin, 135);
                doc.text('Generated: ' + reportDate, margin, 145);
                
                // Decorative box
                doc.setDrawColor(...greenDark);
                doc.setLineWidth(0.5);
                doc.rect(margin, 160, contentWidth, 80);
                
                doc.setFontSize(12);
                doc.setTextColor(...textDark);
                doc.text('This report contains:', margin + 5, 175);
                
                const contents = [
                    '• Executive Summary & KPIs',
                    '• Period Comparison Analysis',
                    '• Inpatient vs Outpatient Breakdown',
                    '• Principal vs Dependent Analysis',
                    '• Cost Analysis & Trends',
                    '• Member Movement Statistics',
                    '• Historical Data'
                ];
                
                contents.forEach((item, i) => {
                    doc.text(item, margin + 5, 188 + (i * 7));
                });
                
                // Footer
                doc.setFontSize(10);
                doc.setTextColor(...textMuted);
                doc.text('Confidential - For authorized use only', pageWidth / 2, 280, { align: 'center' });
                doc.text('© 2025 Polaris Financial Services', pageWidth / 2, 287, { align: 'center' });
                
                // ==================== PAGE 2: EXECUTIVE SUMMARY ====================
                updateProgress(25, 'Building executive summary...');
                await new Promise(r => setTimeout(r, 200));
                doc.addPage();
                
                // Header
                doc.setFillColor(...greenDark);
                doc.rect(0, 0, pageWidth, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Executive Summary', margin, 17);
                
                // KPI boxes
                const kpis = [
                    { label: 'Total Members', value: document.getElementById('kpiMembers')?.textContent || '-', icon: '👥' },
                    { label: 'Total Claims', value: document.getElementById('kpiClaims')?.textContent || '-', icon: '📋' },
                    { label: 'Approved Amount', value: document.getElementById('kpiApproved')?.textContent || '-', icon: '💵' },
                    { label: 'Cost per Member', value: document.getElementById('kpiCost')?.textContent || '-', icon: '📈' },
                    { label: 'Utilization Rate', value: document.getElementById('kpiUtilization')?.textContent || '-', icon: '🎯' }
                ];
                
                let yPos = 40;
                const boxWidth = (contentWidth - 10) / 2;
                const boxHeight = 30;
                
                kpis.forEach((kpi, i) => {
                    const col = i % 2;
                    const row = Math.floor(i / 2);
                    const x = margin + (col * (boxWidth + 10));
                    const y = yPos + (row * (boxHeight + 8));
                    
                    // Box
                    doc.setFillColor(245, 250, 245);
                    doc.setDrawColor(...greenLight);
                    doc.roundedRect(x, y, boxWidth, boxHeight, 3, 3, 'FD');
                    
                    // Label
                    doc.setFontSize(9);
                    doc.setTextColor(...textMuted);
                    doc.text(kpi.label, x + 5, y + 10);
                    
                    // Value
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...greenDark);
                    doc.text(kpi.value, x + 5, y + 23);
                });
                
                // Period Comparison Section
                yPos = 165;
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Period Comparison', margin, yPos);
                
                doc.setDrawColor(...gold);
                doc.setLineWidth(1);
                doc.line(margin, yPos + 3, margin + 50, yPos + 3);
                
                yPos += 15;
                
                const comparisons = [
                    { label: 'Claims', current: document.getElementById('cmpClaims')?.textContent, prev: document.getElementById('cmpClaimsPrev')?.textContent },
                    { label: 'Members', current: document.getElementById('cmpMembers')?.textContent, prev: document.getElementById('cmpMembersPrev')?.textContent },
                    { label: 'Approved (USD)', current: document.getElementById('cmpApproved')?.textContent, prev: document.getElementById('cmpApprovedPrev')?.textContent },
                    { label: 'Cost/Member', current: document.getElementById('cmpCost')?.textContent, prev: document.getElementById('cmpCostPrev')?.textContent }
                ];
                
                // Table header
                doc.setFillColor(...greenDark);
                doc.rect(margin, yPos, contentWidth, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Metric', margin + 5, yPos + 7);
                doc.text('Current', margin + 70, yPos + 7);
                doc.text('Previous', margin + 120, yPos + 7);
                
                yPos += 10;
                
                comparisons.forEach((cmp, i) => {
                    const rowY = yPos + (i * 12);
                    doc.setFillColor(i % 2 === 0 ? 250 : 245, i % 2 === 0 ? 250 : 248, i % 2 === 0 ? 250 : 245);
                    doc.rect(margin, rowY, contentWidth, 12, 'F');
                    
                    doc.setTextColor(...textDark);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.text(cmp.label, margin + 5, rowY + 8);
                    doc.setFont('helvetica', 'bold');
                    doc.text(cmp.current || '-', margin + 70, rowY + 8);
                    doc.setTextColor(...textMuted);
                    doc.text(cmp.prev || '-', margin + 120, rowY + 8);
                });
                
                // ==================== PAGE 3: INPATIENT/OUTPATIENT ====================
                updateProgress(45, 'Adding inpatient/outpatient analysis...');
                await new Promise(r => setTimeout(r, 200));
                doc.addPage();
                
                // Header
                doc.setFillColor(...greenDark);
                doc.rect(0, 0, pageWidth, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Inpatient vs Outpatient Analysis', margin, 17);
                
                yPos = 40;
                
                // Stats boxes
                const inpatientCases = document.getElementById('inpatientCases')?.textContent || '-';
                const outpatientCases = document.getElementById('outpatientCases')?.textContent || '-';
                const inpatientCost = document.getElementById('inpatientCost')?.textContent || '-';
                const outpatientCost = document.getElementById('outpatientCost')?.textContent || '-';
                
                // Inpatient Box
                doc.setFillColor(231, 76, 60);
                doc.roundedRect(margin, yPos, 85, 50, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.text('INPATIENT', margin + 10, yPos + 15);
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.text(inpatientCases, margin + 10, yPos + 32);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cases', margin + 10, yPos + 42);
                
                // Outpatient Box
                doc.setFillColor(52, 152, 219);
                doc.roundedRect(margin + 95, yPos, 85, 50, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.text('OUTPATIENT', margin + 105, yPos + 15);
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.text(outpatientCases, margin + 105, yPos + 32);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cases', margin + 105, yPos + 42);
                
                yPos += 65;
                
                // Cost comparison
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Cost Analysis', margin, yPos);
                
                yPos += 15;
                
                doc.setFillColor(250, 245, 245);
                doc.setDrawColor(231, 76, 60);
                doc.roundedRect(margin, yPos, 85, 35, 3, 3, 'FD');
                doc.setTextColor(231, 76, 60);
                doc.setFontSize(10);
                doc.text('Inpatient Cost', margin + 10, yPos + 12);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(inpatientCost, margin + 10, yPos + 27);
                
                doc.setFillColor(245, 250, 255);
                doc.setDrawColor(52, 152, 219);
                doc.roundedRect(margin + 95, yPos, 85, 35, 3, 3, 'FD');
                doc.setTextColor(52, 152, 219);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Outpatient Cost', margin + 105, yPos + 12);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(outpatientCost, margin + 105, yPos + 27);
                
                // ==================== PAGE 4: PRINCIPAL/DEPENDENT ====================
                updateProgress(60, 'Adding member type analysis...');
                await new Promise(r => setTimeout(r, 200));
                
                yPos += 55;
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Principal vs Dependent Analysis', margin, yPos);
                
                doc.setDrawColor(...gold);
                doc.setLineWidth(1);
                doc.line(margin, yPos + 3, margin + 70, yPos + 3);
                
                yPos += 20;
                
                const principalCount = document.getElementById('principalCount')?.textContent || '-';
                const dependentCount = document.getElementById('dependentCount')?.textContent || '-';
                const principalCost = document.getElementById('principalCost')?.textContent || '-';
                const dependentCost = document.getElementById('dependentCost')?.textContent || '-';
                
                // Principal Box
                doc.setFillColor(...greenDark);
                doc.roundedRect(margin, yPos, 85, 50, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.text('SEAFARERS (Principal)', margin + 8, yPos + 15);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(principalCount, margin + 10, yPos + 32);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cost: ' + principalCost, margin + 10, yPos + 44);
                
                // Dependent Box
                doc.setFillColor(...gold);
                doc.roundedRect(margin + 95, yPos, 85, 50, 3, 3, 'F');
                doc.setTextColor(30, 30, 30);
                doc.setFontSize(11);
                doc.text('DEPENDENTS', margin + 105, yPos + 15);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(dependentCount, margin + 105, yPos + 32);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cost: ' + dependentCost, margin + 105, yPos + 44);
                
                // ==================== PAGE 4: MEMBER MOVEMENT ====================
                updateProgress(75, 'Adding member movement...');
                await new Promise(r => setTimeout(r, 200));
                doc.addPage();
                
                // Header
                doc.setFillColor(...greenDark);
                doc.rect(0, 0, pageWidth, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Member Movement & Fees', margin, 17);
                
                yPos = 40;
                
                const newEnroll = document.getElementById('newEnrollments')?.textContent || '-';
                const cancelled = document.getElementById('cancellations')?.textContent || '-';
                const netChange = document.getElementById('netChange')?.textContent || '-';
                
                // Movement boxes
                doc.setFillColor(76, 175, 80);
                doc.roundedRect(margin, yPos, 55, 45, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.text('NEW ENROLLMENTS', margin + 5, yPos + 12);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(newEnroll, margin + 5, yPos + 32);
                
                doc.setFillColor(231, 76, 60);
                doc.roundedRect(margin + 62, yPos, 55, 45, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('CANCELLATIONS', margin + 67, yPos + 12);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(cancelled, margin + 67, yPos + 32);
                
                doc.setFillColor(...gold);
                doc.roundedRect(margin + 124, yPos, 55, 45, 3, 3, 'F');
                doc.setTextColor(30, 30, 30);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('NET CHANGE', margin + 129, yPos + 12);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(netChange, margin + 129, yPos + 32);
                
                // Fees Section
                yPos += 65;
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Fees & Charges', margin, yPos);
                
                doc.setDrawColor(...gold);
                doc.setLineWidth(1);
                doc.line(margin, yPos + 3, margin + 40, yPos + 3);
                
                yPos += 15;
                
                const fees = [
                    { label: 'Audit Fee', value: '15%' },
                    { label: 'Registration Fee (Annual)', value: '$24' },
                    { label: 'Monthly Fee (Annual)', value: '$9' }
                ];
                
                fees.forEach((fee, i) => {
                    const rowY = yPos + (i * 18);
                    doc.setFillColor(i % 2 === 0 ? 250 : 245, 250, i % 2 === 0 ? 250 : 245);
                    doc.roundedRect(margin, rowY, contentWidth, 15, 2, 2, 'F');
                    
                    doc.setFontSize(11);
                    doc.setTextColor(...textDark);
                    doc.setFont('helvetica', 'normal');
                    doc.text(fee.label, margin + 5, rowY + 10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...greenDark);
                    doc.text(fee.value, margin + contentWidth - 30, rowY + 10);
                });
                
                // ==================== FINAL PAGE: FOOTER ====================
                updateProgress(90, 'Finalizing report...');
                await new Promise(r => setTimeout(r, 200));
                
                // Add footer to all pages
                const totalPages = doc.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(9);
                    doc.setTextColor(...textMuted);
                    doc.text(`Page ${i} of ${totalPages}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                    if (i > 1) {
                        doc.text('Polaris Financial Services - Confidential', margin, pageHeight - 10);
                    }
                }
                
                // ==================== SAVE ====================
                updateProgress(100, 'Complete!');
                titleText.textContent = 'Report Ready!';
                statusText.textContent = 'Your report has been generated successfully';
                stepText.textContent = 'Downloading...';
                
                await new Promise(r => setTimeout(r, 500));
                
                // Save PDF
                const fileName = `Polaris_Report_${clientName.replace(/\s+/g, '_')}_${periodLabel.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
                
                // Close modal after delay
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 1500);
                
            } catch (error) {
                console.error('Report generation error:', error);
                titleText.textContent = 'Error';
                statusText.textContent = 'Failed to generate report';
                stepText.textContent = error.message;
                progressBar.style.background = '#e74c3c';
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 3000);
            }
        }
        
        async function generateMonthlyReport() {
            const modal = document.getElementById('reportModal');
            const progressBar = document.getElementById('reportProgressBar');
            const stepText = document.getElementById('reportStep');
            const statusText = document.getElementById('reportStatus');
            const titleText = document.getElementById('reportTitle');
            
            modal.classList.remove('hidden');
            progressBar.style.background = 'linear-gradient(90deg, var(--polaris-green), var(--polaris-gold))';
            
            const updateProgress = (percent, step) => {
                progressBar.style.width = percent + '%';
                stepText.textContent = step;
            };
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);
                
                // Get data
                const clientName = currentUser.username || currentUser.client_id || 'All Clients';
                const periodLabel = document.getElementById('periodBadge')?.textContent || 'Current Period';
                const reportDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                const monthName = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                // Colors
                const greenDark = [27, 94, 32];
                const greenLight = [46, 125, 50];
                const gold = [212, 175, 55];
                const blue = [21, 101, 192];
                const blueDark = [13, 71, 161];
                const red = [211, 47, 47];
                const textDark = [30, 30, 30];
                const textMuted = [120, 120, 120];
                
                // ==================== PAGE 1: COVER ====================
                updateProgress(5, 'Creating cover page...');
                await new Promise(r => setTimeout(r, 150));
                
                // Blue header for monthly report
                doc.setFillColor(...blue);
                doc.rect(0, 0, pageWidth, 70, 'F');
                
                // Gold accent
                doc.setFillColor(...gold);
                doc.rect(0, 68, pageWidth, 4, 'F');
                
                // Title
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'normal');
                doc.text('POLARIS FINANCIAL SERVICES', margin, 25);
                
                doc.setFontSize(32);
                doc.setFont('helvetica', 'bold');
                doc.text('Monthly Report', margin, 45);
                
                doc.setFontSize(18);
                doc.setFont('helvetica', 'normal');
                doc.text(periodLabel, margin, 58);
                
                // Report info box
                doc.setFillColor(250, 250, 250);
                doc.roundedRect(margin, 85, contentWidth, 50, 3, 3, 'F');
                
                doc.setFontSize(11);
                doc.setTextColor(...textMuted);
                doc.text('Report Details', margin + 10, 98);
                
                doc.setFontSize(12);
                doc.setTextColor(...textDark);
                doc.setFont('helvetica', 'bold');
                doc.text('Client:', margin + 10, 112);
                doc.text('Period:', margin + 10, 124);
                doc.setFont('helvetica', 'normal');
                doc.text(clientName, margin + 50, 112);
                doc.text(periodLabel, margin + 50, 124);
                
                doc.setTextColor(...textMuted);
                doc.setFontSize(10);
                doc.text('Generated: ' + reportDate, margin + 10, 130);
                
                // Contents
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Report Contents', margin, 160);
                
                doc.setDrawColor(...blue);
                doc.setLineWidth(1);
                doc.line(margin, 164, margin + 45, 164);
                
                const contents = [
                    { num: '01', title: 'Executive Summary', desc: 'Key performance indicators overview' },
                    { num: '02', title: 'Inpatient vs Outpatient', desc: 'Case distribution and cost analysis' },
                    { num: '03', title: 'Claims Analysis', desc: 'Detailed claims breakdown by category' },
                    { num: '04', title: 'Cost Breakdown', desc: 'Comprehensive cost analysis and fees' }
                ];
                
                let yPos = 175;
                contents.forEach((item, i) => {
                    doc.setFillColor(...blue);
                    doc.roundedRect(margin, yPos, 20, 20, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(item.num, margin + 6, yPos + 13);
                    
                    doc.setTextColor(...textDark);
                    doc.setFontSize(12);
                    doc.text(item.title, margin + 28, yPos + 8);
                    doc.setTextColor(...textMuted);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text(item.desc, margin + 28, yPos + 16);
                    
                    yPos += 28;
                });
                
                // Footer
                doc.setFontSize(9);
                doc.setTextColor(...textMuted);
                doc.text('Confidential - For internal use only', pageWidth / 2, 285, { align: 'center' });
                
                // ==================== PAGE 2: EXECUTIVE SUMMARY ====================
                updateProgress(20, 'Building executive summary...');
                await new Promise(r => setTimeout(r, 150));
                doc.addPage();
                
                // Header
                doc.setFillColor(...blue);
                doc.rect(0, 0, pageWidth, 30, 'F');
                doc.setFillColor(...gold);
                doc.rect(0, 28, pageWidth, 3, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text('MONTHLY REPORT | ' + periodLabel, margin, 12);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('01. Executive Summary', margin, 23);
                
                yPos = 45;
                
                // Key Metrics Title
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Key Performance Indicators', margin, yPos);
                
                yPos += 10;
                
                // KPI Grid (2x3)
                const kpis = [
                    { label: 'Total Members', value: document.getElementById('kpiMembers')?.textContent || '-', color: greenDark, icon: 'MEMBERS' },
                    { label: 'Total Claims', value: document.getElementById('kpiClaims')?.textContent || '-', color: blue, icon: 'CLAIMS' },
                    { label: 'Approved Amount', value: document.getElementById('kpiApproved')?.textContent || '-', color: greenLight, icon: 'APPROVED' },
                    { label: 'Cost per Member', value: document.getElementById('kpiCost')?.textContent || '-', color: gold, icon: 'COST' },
                    { label: 'Utilization Rate', value: document.getElementById('kpiUtilization')?.textContent || '-', color: blue, icon: 'UTIL' },
                    { label: 'Inpatient Cases', value: document.getElementById('inpatientCases')?.textContent || '-', color: red, icon: 'INPAT' }
                ];
                
                const kpiBoxWidth = (contentWidth - 10) / 2;
                const kpiBoxHeight = 35;
                
                kpis.forEach((kpi, i) => {
                    const col = i % 2;
                    const row = Math.floor(i / 2);
                    const x = margin + (col * (kpiBoxWidth + 10));
                    const y = yPos + (row * (kpiBoxHeight + 8));
                    
                    // Box with left accent
                    doc.setFillColor(248, 250, 252);
                    doc.roundedRect(x, y, kpiBoxWidth, kpiBoxHeight, 2, 2, 'F');
                    doc.setFillColor(...kpi.color);
                    doc.rect(x, y, 4, kpiBoxHeight, 'F');
                    
                    // Label
                    doc.setFontSize(9);
                    doc.setTextColor(...textMuted);
                    doc.setFont('helvetica', 'normal');
                    doc.text(kpi.label.toUpperCase(), x + 10, y + 12);
                    
                    // Value
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...kpi.color);
                    doc.text(kpi.value, x + 10, y + 28);
                });
                
                // Period Comparison
                yPos += (kpiBoxHeight + 8) * 3 + 15;
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Period Comparison', margin, yPos);
                
                yPos += 8;
                
                // Comparison table
                const compHeaders = ['Metric', 'Current Period', 'Previous Period', 'Change'];
                const compData = [
                    ['Claims', document.getElementById('cmpClaims')?.textContent || '-', document.getElementById('cmpClaimsPrev')?.textContent || '-', document.getElementById('cmpClaimsChange')?.textContent || '-'],
                    ['Members', document.getElementById('cmpMembers')?.textContent || '-', document.getElementById('cmpMembersPrev')?.textContent || '-', document.getElementById('cmpMembersChange')?.textContent || '-'],
                    ['Approved (USD)', document.getElementById('cmpApproved')?.textContent || '-', document.getElementById('cmpApprovedPrev')?.textContent || '-', document.getElementById('cmpApprovedChange')?.textContent || '-'],
                    ['Cost/Member', document.getElementById('cmpCost')?.textContent || '-', document.getElementById('cmpCostPrev')?.textContent || '-', document.getElementById('cmpCostChange')?.textContent || '-']
                ];
                
                const colWidths = [45, 45, 45, 40];
                
                // Header row
                doc.setFillColor(...blue);
                doc.rect(margin, yPos, contentWidth, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                
                let xPos = margin + 5;
                compHeaders.forEach((h, i) => {
                    doc.text(h, xPos, yPos + 7);
                    xPos += colWidths[i];
                });
                
                yPos += 10;
                
                // Data rows
                compData.forEach((row, rowIdx) => {
                    doc.setFillColor(rowIdx % 2 === 0 ? 250 : 245, 250, rowIdx % 2 === 0 ? 252 : 248);
                    doc.rect(margin, yPos, contentWidth, 10, 'F');
                    
                    xPos = margin + 5;
                    row.forEach((cell, colIdx) => {
                        if (colIdx === 0) {
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(...textDark);
                        } else if (colIdx === 3) {
                            // Change column - color based on value
                            const isPositive = cell.includes('+') || cell.includes('↑');
                            const isNegative = cell.includes('-') || cell.includes('↓');
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(isPositive ? 76 : isNegative ? 211 : 120, isPositive ? 175 : isNegative ? 47 : 120, isPositive ? 80 : isNegative ? 47 : 120);
                        } else {
                            doc.setFont('helvetica', 'normal');
                            doc.setTextColor(...textDark);
                        }
                        doc.setFontSize(9);
                        doc.text(cell, xPos, yPos + 7);
                        xPos += colWidths[colIdx];
                    });
                    
                    yPos += 10;
                });
                
                // ==================== PAGE 3: INPATIENT VS OUTPATIENT ====================
                updateProgress(40, 'Adding inpatient/outpatient analysis...');
                await new Promise(r => setTimeout(r, 150));
                doc.addPage();
                
                // Header
                doc.setFillColor(...blue);
                doc.rect(0, 0, pageWidth, 30, 'F');
                doc.setFillColor(...gold);
                doc.rect(0, 28, pageWidth, 3, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text('MONTHLY REPORT | ' + periodLabel, margin, 12);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('02. Inpatient vs Outpatient', margin, 23);
                
                yPos = 45;
                
                // Get values
                const inpatientCases = document.getElementById('inpatientCases')?.textContent || '0';
                const outpatientCases = document.getElementById('outpatientCases')?.textContent || '0';
                const inpatientCost = document.getElementById('inpatientCost')?.textContent || '$0';
                const outpatientCost = document.getElementById('outpatientCost')?.textContent || '$0';
                
                // Overview boxes
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Case Distribution', margin, yPos);
                
                yPos += 8;
                
                // Inpatient big box
                doc.setFillColor(211, 47, 47);
                doc.roundedRect(margin, yPos, 85, 60, 4, 4, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('INPATIENT', margin + 10, yPos + 15);
                doc.setFontSize(28);
                doc.setFont('helvetica', 'bold');
                doc.text(inpatientCases, margin + 10, yPos + 38);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cases', margin + 10, yPos + 50);
                
                // Outpatient big box
                doc.setFillColor(25, 118, 210);
                doc.roundedRect(margin + 95, yPos, 85, 60, 4, 4, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('OUTPATIENT', margin + 105, yPos + 15);
                doc.setFontSize(28);
                doc.setFont('helvetica', 'bold');
                doc.text(outpatientCases, margin + 105, yPos + 38);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cases', margin + 105, yPos + 50);
                
                yPos += 75;
                
                // Cost Analysis
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Cost Analysis', margin, yPos);
                
                yPos += 10;
                
                // Cost comparison table
                doc.setFillColor(...blue);
                doc.rect(margin, yPos, contentWidth, 12, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Category', margin + 5, yPos + 8);
                doc.text('Total Cost', margin + 70, yPos + 8);
                doc.text('% of Total', margin + 130, yPos + 8);
                
                yPos += 12;
                
                // Parse costs for percentage calculation
                const inCostNum = parseFloat(inpatientCost.replace(/[^0-9.]/g, '')) || 0;
                const outCostNum = parseFloat(outpatientCost.replace(/[^0-9.]/g, '')) || 0;
                const totalCost = inCostNum + outCostNum;
                const inPct = totalCost > 0 ? ((inCostNum / totalCost) * 100).toFixed(1) : '0';
                const outPct = totalCost > 0 ? ((outCostNum / totalCost) * 100).toFixed(1) : '0';
                
                // Inpatient row
                doc.setFillColor(255, 235, 238);
                doc.rect(margin, yPos, contentWidth, 15, 'F');
                doc.setFillColor(211, 47, 47);
                doc.rect(margin, yPos, 4, 15, 'F');
                doc.setTextColor(...textDark);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Inpatient', margin + 10, yPos + 10);
                doc.text(inpatientCost, margin + 70, yPos + 10);
                doc.setTextColor(211, 47, 47);
                doc.text(inPct + '%', margin + 130, yPos + 10);
                
                yPos += 15;
                
                // Outpatient row
                doc.setFillColor(227, 242, 253);
                doc.rect(margin, yPos, contentWidth, 15, 'F');
                doc.setFillColor(25, 118, 210);
                doc.rect(margin, yPos, 4, 15, 'F');
                doc.setTextColor(...textDark);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Outpatient', margin + 10, yPos + 10);
                doc.text(outpatientCost, margin + 70, yPos + 10);
                doc.setTextColor(25, 118, 210);
                doc.text(outPct + '%', margin + 130, yPos + 10);
                
                yPos += 15;
                
                // Total row
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPos, contentWidth, 15, 'F');
                doc.setTextColor(...textDark);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL', margin + 10, yPos + 10);
                doc.text('$' + totalCost.toLocaleString(), margin + 70, yPos + 10);
                doc.text('100%', margin + 130, yPos + 10);
                
                yPos += 30;
                
                // Visual bar
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Cost Distribution', margin, yPos);
                
                yPos += 8;
                
                const barWidth = contentWidth;
                const barHeight = 20;
                const inBarWidth = totalCost > 0 ? (inCostNum / totalCost) * barWidth : barWidth / 2;
                
                doc.setFillColor(211, 47, 47);
                doc.roundedRect(margin, yPos, inBarWidth, barHeight, 2, 2, 'F');
                doc.setFillColor(25, 118, 210);
                doc.roundedRect(margin + inBarWidth, yPos, barWidth - inBarWidth, barHeight, 2, 2, 'F');
                
                // Labels on bar
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                if (inBarWidth > 30) doc.text('Inpatient ' + inPct + '%', margin + 5, yPos + 13);
                if (barWidth - inBarWidth > 30) doc.text('Outpatient ' + outPct + '%', margin + inBarWidth + 5, yPos + 13);
                
                // ==================== PAGE 4: CLAIMS ANALYSIS ====================
                updateProgress(60, 'Building claims analysis...');
                await new Promise(r => setTimeout(r, 150));
                doc.addPage();
                
                // Header
                doc.setFillColor(...blue);
                doc.rect(0, 0, pageWidth, 30, 'F');
                doc.setFillColor(...gold);
                doc.rect(0, 28, pageWidth, 3, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text('MONTHLY REPORT | ' + periodLabel, margin, 12);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('03. Claims Analysis', margin, 23);
                
                yPos = 45;
                
                // Claims Overview
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Claims Overview', margin, yPos);
                
                yPos += 10;
                
                const totalClaims = document.getElementById('kpiClaims')?.textContent || '0';
                const approvedAmount = document.getElementById('kpiApproved')?.textContent || '$0';
                const claimsNum = parseInt(totalClaims.replace(/,/g, '')) || 1;
                const approvedNum = parseFloat(approvedAmount.replace(/[^0-9.]/g, '')) || 0;
                const avgClaim = claimsNum > 0 ? (approvedNum / claimsNum).toFixed(2) : '0';
                
                // Claims metrics boxes
                const claimMetrics = [
                    { label: 'Total Claims', value: totalClaims, color: blue },
                    { label: 'Approved Amount', value: approvedAmount, color: greenDark },
                    { label: 'Average Claim', value: '$' + avgClaim, color: gold }
                ];
                
                const metricWidth = (contentWidth - 20) / 3;
                
                claimMetrics.forEach((m, i) => {
                    const x = margin + (i * (metricWidth + 10));
                    
                    doc.setFillColor(248, 250, 252);
                    doc.setDrawColor(...m.color);
                    doc.setLineWidth(0.5);
                    doc.roundedRect(x, yPos, metricWidth, 40, 3, 3, 'FD');
                    
                    doc.setFontSize(8);
                    doc.setTextColor(...textMuted);
                    doc.setFont('helvetica', 'normal');
                    doc.text(m.label.toUpperCase(), x + 5, yPos + 12);
                    
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...m.color);
                    doc.text(m.value, x + 5, yPos + 30);
                });
                
                yPos += 55;
                
                // Claims by Type
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Claims by Type', margin, yPos);
                
                yPos += 10;
                
                const claimTypes = [
                    { type: 'Inpatient Claims', count: inpatientCases, pct: '25%', color: [211, 47, 47] },
                    { type: 'Outpatient Claims', count: outpatientCases, pct: '75%', color: [25, 118, 210] }
                ];
                
                claimTypes.forEach((ct, i) => {
                    doc.setFillColor(250, 250, 252);
                    doc.roundedRect(margin, yPos, contentWidth, 25, 2, 2, 'F');
                    doc.setFillColor(...ct.color);
                    doc.rect(margin, yPos, 5, 25, 'F');
                    
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text(ct.type, margin + 12, yPos + 10);
                    
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...textMuted);
                    doc.text(ct.count + ' claims (' + ct.pct + ')', margin + 12, yPos + 19);
                    
                    // Progress bar
                    const pctNum = parseFloat(ct.pct) || 0;
                    const barStartX = margin + 120;
                    const barMaxWidth = 50;
                    
                    doc.setFillColor(230, 230, 230);
                    doc.roundedRect(barStartX, yPos + 8, barMaxWidth, 8, 2, 2, 'F');
                    doc.setFillColor(...ct.color);
                    doc.roundedRect(barStartX, yPos + 8, (pctNum / 100) * barMaxWidth, 8, 2, 2, 'F');
                    
                    yPos += 30;
                });
                
                // ==================== PAGE 5: COST BREAKDOWN ====================
                updateProgress(80, 'Creating cost breakdown...');
                await new Promise(r => setTimeout(r, 150));
                doc.addPage();
                
                // Header
                doc.setFillColor(...blue);
                doc.rect(0, 0, pageWidth, 30, 'F');
                doc.setFillColor(...gold);
                doc.rect(0, 28, pageWidth, 3, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text('MONTHLY REPORT | ' + periodLabel, margin, 12);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('04. Cost Breakdown', margin, 23);
                
                yPos = 45;
                
                // Cost Summary
                const costPerMember = document.getElementById('kpiCost')?.textContent || '$0';
                const costNum = parseFloat(costPerMember.replace(/[^0-9.]/g, '')) || 0;
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Cost per Member Analysis', margin, yPos);
                
                yPos += 10;
                
                // Big cost display
                doc.setFillColor(245, 250, 245);
                doc.setDrawColor(...greenDark);
                doc.setLineWidth(1);
                doc.roundedRect(margin, yPos, contentWidth, 50, 4, 4, 'FD');
                
                doc.setFontSize(12);
                doc.setTextColor(...textMuted);
                doc.text('TOTAL COST PER MEMBER', margin + 10, yPos + 18);
                
                doc.setFontSize(32);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...greenDark);
                doc.text(costPerMember, margin + 10, yPos + 40);
                
                // Target indicator
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...textMuted);
                doc.text('Target: $50.00', margin + 120, yPos + 40);
                
                yPos += 65;
                
                // Cost Components
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Cost Components', margin, yPos);
                
                yPos += 10;
                
                const baseCost = costNum * 0.70;
                const auditFee = baseCost * 0.15;
                const regFee = 24;
                const monthlyFee = 9;
                
                const costComponents = [
                    { label: 'Base Claims Cost', value: '$' + baseCost.toFixed(2), pct: '70%', color: greenDark },
                    { label: 'Audit Fee (15%)', value: '$' + auditFee.toFixed(2), pct: '10.5%', color: gold },
                    { label: 'Registration Fee', value: '$' + regFee.toFixed(2), pct: 'Annual', color: blue },
                    { label: 'Monthly Service Fee', value: '$' + monthlyFee.toFixed(2), pct: 'Annual', color: [156, 39, 176] }
                ];
                
                costComponents.forEach((cc, i) => {
                    doc.setFillColor(250, 250, 252);
                    doc.roundedRect(margin, yPos, contentWidth, 20, 2, 2, 'F');
                    doc.setFillColor(...cc.color);
                    doc.rect(margin, yPos, 4, 20, 'F');
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...textDark);
                    doc.text(cc.label, margin + 10, yPos + 13);
                    
                    doc.setFont('helvetica', 'bold');
                    doc.text(cc.value, margin + 100, yPos + 13);
                    
                    doc.setTextColor(...textMuted);
                    doc.setFontSize(9);
                    doc.text(cc.pct, margin + 150, yPos + 13);
                    
                    yPos += 24;
                });
                
                yPos += 10;
                
                // Total bar
                doc.setFillColor(...greenDark);
                doc.roundedRect(margin, yPos, contentWidth, 25, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL ANNUALIZED COST', margin + 10, yPos + 16);
                doc.text(costPerMember + ' per member', margin + 120, yPos + 16);
                
                // ==================== ADD PAGE NUMBERS ====================
                updateProgress(95, 'Finalizing...');
                await new Promise(r => setTimeout(r, 150));
                
                const totalPages = doc.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(...textMuted);
                    doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
                    if (i > 1) {
                        doc.text('Polaris Financial Services | Confidential', margin, pageHeight - 10);
                    }
                }
                
                // ==================== SAVE ====================
                updateProgress(100, 'Complete!');
                titleText.textContent = 'Monthly Report Ready!';
                statusText.textContent = 'Your report has been generated';
                stepText.textContent = 'Downloading...';
                
                await new Promise(r => setTimeout(r, 500));
                
                const fileName = `Polaris_Monthly_Report_${periodLabel.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 1500);
                
            } catch (error) {
                console.error('Report error:', error);
                titleText.textContent = 'Error';
                statusText.textContent = 'Failed to generate report';
                stepText.textContent = error.message;
                progressBar.style.background = '#e74c3c';
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 3000);
            }
        }
        
        async function showDashboard() {
            const loginModal = document.getElementById('loginModal');
            const mainContent = document.getElementById('mainContent');
            const mainFooter = document.getElementById('mainFooter');
            const loadingScreen = document.getElementById('loadingScreen');
            const loadingText = document.getElementById('loadingText');
            const loadingProgress = document.getElementById('loadingProgress');
            
            if (loginModal) loginModal.classList.add('hidden');
            if (mainContent) mainContent.style.display = 'block';
            if (mainFooter) mainFooter.style.display = 'block';
            
            // Show loading screen with progress bar
            if (loadingScreen) loadingScreen.classList.remove('hidden');
            if (loadingText) loadingText.textContent = 'LOADING DATA...';
            if (loadingProgress) loadingProgress.style.display = 'block';
            
            // Start preloading all data
            await preloadAllDataWithProgress();
            
            // Hide loading screen after data is loaded
            if (loadingScreen) loadingScreen.classList.add('hidden');
            
            // Load clients from API first
            await loadClientsFromAPI();
            
            // Populate client selector
            populateClientSelector();
            
            // Always load mock data first to ensure charts render
            loadDataForSelectedQuarters();
            
            const lastUpdated = document.getElementById('lastUpdated');
            if (lastUpdated) lastUpdated.textContent = new Date().toLocaleString();
            
            // Then try API (if available, it will update with real data)
            try {
                await loadData();
            } catch(e) {
                console.error('Load data error:', e);
            }
        }
        
        async function loadData() {
            try {
                const r = await fetch(`${API_URL}?action=getMasterComparison`);
                const d = await r.json();
                if (d.success) updateDashboard(d.data);
                // Handle responsive charts after data loads
                onChartsRendered();
            } catch(e) { 
                console.error('API not available, using mock data:', e); 
                onChartsRendered();
            }
        }
        
        function updateDashboard(data) {
            if (!data.current_period) return;
            const c = data.current_period, p = data.previous_period, ch = data.changes, periods = data.all_periods || [];
            
            // Update quarter data from API
            if (c.period_label) {
                const q = c.period_label.replace(' 2025', '').replace('2025-', '');
                if (quarterData[q]) {
                    quarterData[q] = {
                        members: c.members,
                        claims: c.claims,
                        approved_usd: c.approved_usd,
                        cost_per_member: c.cost_per_member
                    };
                }
            }
            
            if (p && document.getElementById('cmpPeriodLabel')) {
                document.getElementById('cmpPeriodLabel').textContent = `${c.period_label} vs ${p.period_label}`;
            }
            
            document.getElementById('kpiMembers').textContent = fmt(c.members);
            document.getElementById('kpiClaims').textContent = fmt(c.claims);
            document.getElementById('kpiApproved').textContent = '$' + fmt(c.approved_usd);
            document.getElementById('kpiCost').textContent = '$' + c.cost_per_member.toFixed(2);
            const util = c.members > 0 ? (c.claims / c.members * 100) : 0;
            document.getElementById('kpiUtilization').textContent = util.toFixed(1) + '%';
            document.getElementById('totalActive').textContent = fmt(c.members);
            
            if (ch) {
                setTrend('kpiMembersTrend', ch.members);
                setTrend('kpiClaimsTrend', ch.claims);
                setTrend('kpiApprovedTrend', ch.approved_usd);
                setTrend('kpiCostTrend', ch.cost_per_member);
            }
            
            if (p && ch) {
                document.getElementById('cmpClaims').textContent = fmt(c.claims);
                document.getElementById('cmpClaimsPrev').textContent = fmt(p.claims);
                setChange('cmpClaimsChange', ch.claims);
                document.getElementById('cmpMembers').textContent = fmt(c.members);
                document.getElementById('cmpMembersPrev').textContent = fmt(p.members);
                setChange('cmpMembersChange', ch.members);
                document.getElementById('cmpApproved').textContent = '$' + fmt(c.approved_usd);
                document.getElementById('cmpApprovedPrev').textContent = '$' + fmt(p.approved_usd);
                setChange('cmpApprovedChange', ch.approved_usd);
                document.getElementById('cmpCost').textContent = '$' + c.cost_per_member.toFixed(2);
                document.getElementById('cmpCostPrev').textContent = '$' + p.cost_per_member.toFixed(2);
                setChange('cmpCostChange', ch.cost_per_member);
            }
            
            // ═══════════════════════════════════════════════════════════
            // LOAD REAL DATA FROM API (FinancialData, Claims_Categories sheets)
            // ═══════════════════════════════════════════════════════════
            
            // These will be populated by loadFinancialBreakdowns() below
            let inpatientCases = 0, outpatientCases = 0, exGratiaCases = 0;
            let inpatientCostVal = 0, outpatientCostVal = 0, exGratiaCostVal = 0;
            let principalMembers = 0, dependentMembers = 0;
            let newEnroll = 0, cancelled = 0;
            
            // Call async function to load real data
            loadFinancialBreakdowns().then(data => {
                if (data) {
                    // Update Inpatient/Outpatient/Ex Gratia from API
                    if (data.claimTypes) {
                        document.getElementById('inpatientCases').textContent = fmt(data.claimTypes.cases.inpatient);
                        document.getElementById('outpatientCases').textContent = fmt(data.claimTypes.cases.outpatient);
                        document.getElementById('exGratiaCases').textContent = fmt(data.claimTypes.cases.exgratia);
                        document.getElementById('inpatientCost').textContent = '$' + fmt(data.claimTypes.costs.inpatient);
                        document.getElementById('outpatientCost').textContent = '$' + fmt(data.claimTypes.costs.outpatient);
                        document.getElementById('exGratiaCost').textContent = '$' + fmt(data.claimTypes.costs.exgratia);
                        
                        // Recreate charts with real data
                        try { 
                            createInOutCharts(periods, 
                                data.claimTypes.cases.inpatient, 
                                data.claimTypes.cases.outpatient, 
                                data.claimTypes.cases.exgratia,
                                data.claimTypes.costs.inpatient,
                                data.claimTypes.costs.outpatient,
                                data.claimTypes.costs.exgratia
                            ); 
                        } catch(e) { console.error('createInOutCharts error:', e); }
                    }
                    
                    // Update Principal/Dependent from API
                    if (data.memberTypes) {
                        document.getElementById('principalCount').textContent = fmt(data.memberTypes.members.principal);
                        document.getElementById('dependentCount').textContent = fmt(data.memberTypes.members.dependent);
                        
                        try { 
                            createMemberTypeCharts(
                                data.memberTypes.members.principal, 
                                data.memberTypes.members.dependent, 
                                c.claims
                            ); 
                        } catch(e) { console.error('createMemberTypeCharts error:', e); }
                    }
                    
                    // Update Member Movement from API
                    if (data.memberMovement) {
                        document.getElementById('newEnrollments').textContent = '+' + data.memberMovement.totals.enrollments;
                        document.getElementById('cancellations').textContent = '-' + data.memberMovement.totals.cancellations;
                        const nc = data.memberMovement.totals.netChange;
                        document.getElementById('netChange').textContent = (nc >= 0 ? '+' : '') + nc;
                    }
                    
                    // Update Categories from API
                    if (data.categories && data.categories.categories) {
                        updateCategoriesDisplay(data.categories.categories);
                    }
                    
                    // Update Geographic from API
                    if (data.geographic) {
                        updateGeographicDisplay(data.geographic);
                    }
                }
            }).catch(err => console.error('loadFinancialBreakdowns error:', err));
            
            // NEW: Additional charts - temporarily disabled for debugging
            try {
                createCategoryCharts(c);
                createYoYCharts(periods);
                createHospitalCharts();
                createGeoCharts();
            } catch(e) {
                console.error('New charts error:', e);
            }
            
            updateMetrics(util);
            updateInsights(ch);
            updateTable(periods);
            
            // Update CEO Financial Dashboard
            try { updateCEOFinancialDashboard(c, periods); } catch(e) { console.error('CEO Dashboard error:', e); }
        }
        
        // ═══════════════════════════════════════════════════════════
        // CEO/CFO FINANCIAL DASHBOARD - CYPRUS TAX COMPLIANCE
        // ═══════════════════════════════════════════════════════════
        
        function updateCEOFinancialDashboard(current, periods) {
            const fmt = n => n.toLocaleString();
            const fmtCurrency = n => '$' + n.toLocaleString();
            
            // Calculate financial metrics based on current data
            // Using approved_usd as base for claims-related revenue/expenses
            
            // Revenue Calculations (based on TPA business model)
            const totalMembers = current.members || 0;
            const totalClaimsAmount = current.approved_usd || 0;
            
            // Revenue streams (estimates based on TPA typical fee structures)
            const adminFeePerMember = 12; // $12/member/month avg
            const adminFeeRevenue = totalMembers * adminFeePerMember * 12; // Annual
            const premiumRevenue = totalClaimsAmount * 1.35; // Claims + 35% margin
            const stopLossFee = totalClaimsAmount * 0.08; // 8% stop-loss fee
            const networkFee = totalClaimsAmount * 0.05; // 5% network access
            const processingFee = current.claims * 15; // $15 per claim processing
            
            const totalRevenue = premiumRevenue + adminFeeRevenue + stopLossFee + networkFee + processingFee;
            
            // Expense Calculations
            const claimsPaid = totalClaimsAmount; // Direct claims payment
            const exGratiaPayments = totalClaimsAmount * 0.08; // ~8% ex gratia
            const providerNetworkCosts = totalClaimsAmount * 0.12; // 12% provider costs
            const operatingExpenses = totalRevenue * 0.15; // 15% operating costs
            const bankFees = totalRevenue * 0.02; // 2% bank fees
            
            const totalExpenses = claimsPaid + exGratiaPayments + providerNetworkCosts + operatingExpenses + bankFees;
            
            // Profit Calculations
            const grossProfit = totalRevenue - totalExpenses;
            const netProfit = grossProfit; // EBIT
            
            // Cyprus Tax Calculations (2024 rates)
            const corporateTax = Math.max(0, netProfit * 0.125); // 12.5% CIT
            const sdcContribution = netProfit > 0 ? netProfit * 0.0265 : 0; // 2.65% SDC (on dividends, simplified)
            const ghsContribution = netProfit > 0 ? netProfit * 0.029 : 0; // 2.9% GHS
            const totalTax = corporateTax + sdcContribution + ghsContribution;
            
            // Key Ratios
            const grossMargin = totalRevenue > 0 ? (grossProfit / totalRevenue * 100) : 0;
            const lossRatio = premiumRevenue > 0 ? (claimsPaid / premiumRevenue * 100) : 0;
            const expenseRatio = premiumRevenue > 0 ? ((operatingExpenses + bankFees) / premiumRevenue * 100) : 0;
            const combinedRatio = lossRatio + expenseRatio;
            const arpm = totalMembers > 0 ? (totalRevenue / totalMembers / 12) : 0; // Monthly ARPM
            
            // Cash Flow
            const cashInflow = premiumRevenue + adminFeeRevenue;
            const cashOutflow = claimsPaid + operatingExpenses + bankFees;
            const netCash = cashInflow - cashOutflow;
            
            // Update Main KPIs
            document.getElementById('ceoGrossRevenue').textContent = fmtCurrency(Math.round(totalRevenue));
            document.getElementById('ceoTotalExpenses').textContent = fmtCurrency(Math.round(totalExpenses));
            document.getElementById('ceoNetProfit').textContent = fmtCurrency(Math.round(netProfit));
            document.getElementById('ceoTaxLiability').textContent = fmtCurrency(Math.round(totalTax));
            
            // Update Revenue Breakdown
            document.getElementById('ceoPremiumRevenue').textContent = fmtCurrency(Math.round(premiumRevenue));
            document.getElementById('ceoAdminFeeRevenue').textContent = fmtCurrency(Math.round(adminFeeRevenue));
            document.getElementById('ceoStopLossRevenue').textContent = fmtCurrency(Math.round(stopLossFee));
            document.getElementById('ceoNetworkRevenue').textContent = fmtCurrency(Math.round(networkFee));
            document.getElementById('ceoProcessingRevenue').textContent = fmtCurrency(Math.round(processingFee));
            document.getElementById('ceoTotalRevenue').textContent = fmtCurrency(Math.round(totalRevenue));
            
            // Update Expense Breakdown
            document.getElementById('ceoClaimsPaid').textContent = '-' + fmtCurrency(Math.round(claimsPaid));
            document.getElementById('ceoExGratia').textContent = '-' + fmtCurrency(Math.round(exGratiaPayments));
            document.getElementById('ceoProviderCosts').textContent = '-' + fmtCurrency(Math.round(providerNetworkCosts));
            document.getElementById('ceoOperatingExp').textContent = '-' + fmtCurrency(Math.round(operatingExpenses));
            document.getElementById('ceoBankFees').textContent = '-' + fmtCurrency(Math.round(bankFees));
            document.getElementById('ceoTotalExpensesSum').textContent = '-' + fmtCurrency(Math.round(totalExpenses));
            
            // Update Tax Breakdown
            document.getElementById('ceoTaxableIncome').textContent = fmtCurrency(Math.round(netProfit));
            document.getElementById('ceoCorporateTax').textContent = '-' + fmtCurrency(Math.round(corporateTax));
            document.getElementById('ceoSDC').textContent = '-' + fmtCurrency(Math.round(sdcContribution));
            document.getElementById('ceoGHS').textContent = '-' + fmtCurrency(Math.round(ghsContribution));
            document.getElementById('ceoTotalTax').textContent = '-' + fmtCurrency(Math.round(totalTax));
            
            // Update Cash Flow
            document.getElementById('ceoCashInflow').textContent = fmtCurrency(Math.round(cashInflow));
            document.getElementById('ceoCashOutflow').textContent = '-' + fmtCurrency(Math.round(cashOutflow));
            document.getElementById('ceoNetCash').textContent = (netCash >= 0 ? '+' : '') + fmtCurrency(Math.round(netCash));
            
            // Update Cash Flow Bars
            const maxCash = Math.max(cashInflow, cashOutflow, Math.abs(netCash));
            document.getElementById('ceoCashInflowBar').style.width = (cashInflow / maxCash * 80) + '%';
            document.getElementById('ceoCashOutflowBar').style.width = (cashOutflow / maxCash * 80) + '%';
            document.getElementById('ceoNetCashBar').style.width = (Math.abs(netCash) / maxCash * 80) + '%';
            document.getElementById('ceoNetCashBar').textContent = (netCash >= 0 ? '+' : '') + Math.round(netCash / maxCash * 100) + '%';
            
            // Update Ratios
            document.getElementById('ceoGrossMargin').textContent = grossMargin.toFixed(0) + '%';
            document.getElementById('ceoLossRatio').textContent = lossRatio.toFixed(0) + '%';
            document.getElementById('ceoCombinedRatio').textContent = combinedRatio.toFixed(0) + '%';
            document.getElementById('ceoARPM').textContent = '$' + arpm.toFixed(0);
            
            // Update ratio card colors based on performance
            const grossMarginCard = document.getElementById('ceoGrossMarginCard');
            grossMarginCard.className = 'ceo-ratio-card ' + (grossMargin >= 30 ? 'success' : grossMargin >= 20 ? 'warning' : 'danger');
            
            const lossRatioCard = document.getElementById('ceoLossRatioCard');
            lossRatioCard.className = 'ceo-ratio-card ' + (lossRatio <= 70 ? 'success' : lossRatio <= 85 ? 'warning' : 'danger');
            
            const combinedRatioCard = document.getElementById('ceoCombinedRatioCard');
            combinedRatioCard.className = 'ceo-ratio-card ' + (combinedRatio < 95 ? 'success' : combinedRatio < 100 ? 'warning' : 'danger');
            
            // Update Period
            const now = new Date();
            document.getElementById('ceoFinancePeriod').textContent = 'YTD ' + now.getFullYear();
            
            // Update dynamic notes based on performance
            updateCEONotes(grossMargin, lossRatio, combinedRatio, netProfit, corporateTax);
        }
        
        function updateCEONotes(grossMargin, lossRatio, combinedRatio, netProfit, corporateTax) {
            const note1 = document.getElementById('ceoNote1');
            const note2 = document.getElementById('ceoNote2');
            const note3 = document.getElementById('ceoNote3');
            const note4 = document.getElementById('ceoNote4');
            const note5 = document.getElementById('ceoNote5');
            
            // Dynamic notes based on actual performance
            if (lossRatio <= 65) {
                note1.textContent = '✅ Loss Ratio at ' + lossRatio.toFixed(0) + '% is excellent. Industry benchmark for TPA is 60-70%.';
            } else if (lossRatio <= 75) {
                note1.textContent = '⚠️ Loss Ratio at ' + lossRatio.toFixed(0) + '% is within acceptable range but trending high. Monitor closely.';
            } else {
                note1.textContent = '🚨 Loss Ratio at ' + lossRatio.toFixed(0) + '% exceeds target. Immediate review of claims required.';
            }
            
            if (grossMargin >= 30) {
                note2.textContent = '✅ Gross Margin of ' + grossMargin.toFixed(0) + '% exceeds target. Revenue per member growing steadily.';
            } else {
                note2.textContent = '⚠️ Gross Margin of ' + grossMargin.toFixed(0) + '% below target (30%). Review pricing strategy.';
            }
            
            const now = new Date();
            const year = now.getFullYear();
            const provisionalTax = Math.round(corporateTax * 0.75);
            if (now.getMonth() < 6) {
                note3.textContent = '📅 Provisional tax payment due by 31 July ' + year + '. Estimated: $' + provisionalTax.toLocaleString() + ' (75% of prior year tax).';
            } else if (now.getMonth() < 11) {
                note3.textContent = '📅 Final provisional tax payment due by 31 December ' + year + '. Balance: $' + (corporateTax - provisionalTax).toLocaleString();
            } else {
                note3.textContent = '📅 Annual return due by 31 March ' + (year + 1) + '. Total tax liability: $' + Math.round(corporateTax).toLocaleString();
            }
            
            note4.textContent = '💡 Consider VAT optimization: Healthcare services may qualify for reduced VAT (5%) or exemption under Cyprus law.';
            note5.textContent = '📋 Transfer pricing documentation required for intercompany transactions with Philippines subsidiary (Polaris Administration Services, Inc).';
        }
        
        function createInOutCharts(periods, inCases, outCases, exGratiaCases, inCost, outCost, exGratiaCost) {
            // Inpatient/Outpatient/Ex Gratia Pie
            const ctx1 = document.getElementById('inOutPieChart').getContext('2d');
            if (charts.inOutPie) charts.inOutPie.destroy();
            
            const redGrad = ctx1.createLinearGradient(0, 0, 0, 300);
            redGrad.addColorStop(0, '#EF5350');
            redGrad.addColorStop(1, '#B71C1C');
            const blueGrad = ctx1.createLinearGradient(0, 0, 0, 300);
            blueGrad.addColorStop(0, '#42A5F5');
            blueGrad.addColorStop(1, '#1565C0');
            const purpleGrad = ctx1.createLinearGradient(0, 0, 0, 300);
            purpleGrad.addColorStop(0, '#FFD700');
            purpleGrad.addColorStop(1, '#B8860B');
            
            charts.inOutPie = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Inpatient', 'Outpatient', 'Ex Gratia'],
                    datasets: [{ 
                        data: [inCases, outCases, exGratiaCases], 
                        backgroundColor: [redGrad, blueGrad, purpleGrad], 
                        borderWidth: 3,
                        borderColor: ['#B71C1C', '#0D47A1', '#8B7500'],
                        hoverOffset: 15,
                        hoverBorderWidth: 4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '55%', 
                    plugins: { 
                        legend: { display: true, position: 'bottom', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20, boxWidth: 16, boxHeight: 16 } }
                    }
                }
            });
            
            // Cost Comparison Bar
            const ctx2 = document.getElementById('inOutCostChart').getContext('2d');
            if (charts.inOutCost) charts.inOutCost.destroy();
            
            const barRedGrad = ctx2.createLinearGradient(0, 0, 0, 250);
            barRedGrad.addColorStop(0, '#EF9A9A');
            barRedGrad.addColorStop(0.3, '#EF5350');
            barRedGrad.addColorStop(1, '#C62828');
            const barBlueGrad = ctx2.createLinearGradient(0, 0, 0, 250);
            barBlueGrad.addColorStop(0, '#90CAF9');
            barBlueGrad.addColorStop(0.3, '#42A5F5');
            barBlueGrad.addColorStop(1, '#1565C0');
            const barPurpleGrad = ctx2.createLinearGradient(0, 0, 0, 250);
            barPurpleGrad.addColorStop(0, '#FFE082');
            barPurpleGrad.addColorStop(0.3, '#DAA520');
            barPurpleGrad.addColorStop(1, '#B8860B');
            
            charts.inOutCost = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Inpatient', 'Outpatient', 'Ex Gratia'],
                    datasets: [{ 
                        data: [inCost, outCost, exGratiaCost], 
                        backgroundColor: [barRedGrad, barBlueGrad, barPurpleGrad], 
                        borderRadius: { topLeft: 8, topRight: 8, bottomLeft: 0, bottomRight: 0 },
                        borderWidth: 2,
                        borderColor: ['#B71C1C', '#0D47A1', '#8B7500'],
                        barPercentage: 0.7
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { weight: 'bold', size: 10 } } }, 
                        y: { grid: { color: 'rgba(30,58,30,0.5)' }, ticks: { color: '#7a8f7a', callback: v => '$' + fmt(v) } } 
                    }
                }
            });
            
            // Trend Chart with Ex Gratia
            const ctx3 = document.getElementById('inOutTrendChart').getContext('2d');
            if (charts.inOutTrend) charts.inOutTrend.destroy();
            
            const fillRed = ctx3.createLinearGradient(0, 0, 0, 200);
            fillRed.addColorStop(0, 'rgba(231,76,60,0.4)');
            fillRed.addColorStop(1, 'rgba(231,76,60,0.05)');
            const fillBlue = ctx3.createLinearGradient(0, 0, 0, 200);
            fillBlue.addColorStop(0, 'rgba(52,152,219,0.4)');
            fillBlue.addColorStop(1, 'rgba(52,152,219,0.05)');
            const fillGold = ctx3.createLinearGradient(0, 0, 0, 200);
            fillGold.addColorStop(0, 'rgba(212,175,55,0.4)');
            fillGold.addColorStop(1, 'rgba(212,175,55,0.05)');
            
            charts.inOutTrend = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: periods.map(p => p.period_label),
                    datasets: [
                        { 
                            label: 'Inpatient', 
                            data: periods.map(p => Math.round(p.claims * 0.22)), 
                            borderColor: '#e74c3c', 
                            backgroundColor: fillRed, 
                            fill: true, 
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: '#e74c3c',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 7
                        },
                        { 
                            label: 'Outpatient', 
                            data: periods.map(p => Math.round(p.claims * 0.70)), 
                            borderColor: '#3498db', 
                            backgroundColor: fillBlue, 
                            fill: true, 
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: '#3498db',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 7
                        },
                        { 
                            label: 'Ex Gratia', 
                            data: periods.map(p => Math.round(p.claims * 0.08)), 
                            borderColor: '#D4AF37', 
                            backgroundColor: fillGold, 
                            fill: true, 
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: '#D4AF37',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 7
                        }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: true, position: 'top', labels: { color: '#b8c9b8', font: { weight: 'bold', size: 11 } } }
                    }, 
                    scales: { 
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8' } }, 
                        y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } } 
                    }
                }
            });
        }
        
        function createMemberTypeCharts(principal, dependent, claims) {
            // Member Type Pie - Doughnut
            const ctx1 = document.getElementById('memberTypePieChart').getContext('2d');
            if (charts.memberPie) charts.memberPie.destroy();
            
            // Create gradient for 3D effect
            const greenGrad = ctx1.createLinearGradient(0, 0, 0, 300);
            greenGrad.addColorStop(0, '#4CAF50');
            greenGrad.addColorStop(1, '#1B5E20');
            const goldGrad = ctx1.createLinearGradient(0, 0, 0, 300);
            goldGrad.addColorStop(0, '#FFD700');
            goldGrad.addColorStop(1, '#B8860B');
            
            charts.memberPie = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Seafarers', 'Dependents'],
                    datasets: [{ 
                        data: [principal, dependent], 
                        backgroundColor: [greenGrad, goldGrad], 
                        borderWidth: 3,
                        borderColor: ['#1B5E20', '#8B7500'],
                        hoverOffset: 15,
                        hoverBorderWidth: 4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '55%', 
                    plugins: { 
                        legend: { display: true, position: 'bottom', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20, boxWidth: 16, boxHeight: 16 } }
                    },
                    animation: { animateRotate: true, animateScale: true }
                }
            });
            
            // Claims by Member Type - Bar Chart
            const ctx2 = document.getElementById('memberTypeClaimsChart').getContext('2d');
            if (charts.memberClaims) charts.memberClaims.destroy();
            
            const principalClaims = Math.round(claims * 0.55);
            const dependentClaims = claims - principalClaims;
            
            // Update stat values
            document.getElementById('principalClaims').textContent = fmt(principalClaims);
            document.getElementById('dependentClaims').textContent = fmt(dependentClaims);
            
            charts.memberClaims = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Seafarer Claims', 'Dependent Claims'],
                    datasets: [{ 
                        data: [principalClaims, dependentClaims], 
                        backgroundColor: [greenGrad, goldGrad], 
                        borderWidth: 3,
                        borderColor: ['#1B5E20', '#8B7500'],
                        hoverOffset: 15
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '55%', 
                    plugins: { 
                        legend: { display: true, position: 'bottom', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20 } }
                    }
                }
            });
        }
        
        function createMovementCharts(periods) {
            // Movement Compare Chart - Side by side bars (Enrollments vs Cancellations)
            const ctx1 = document.getElementById('movementCompareChart').getContext('2d');
            if (charts.movementCompare) charts.movementCompare.destroy();
            
            const enrollGrad = ctx1.createLinearGradient(0, 0, 0, 250);
            enrollGrad.addColorStop(0, '#A5D6A7');
            enrollGrad.addColorStop(0.5, '#66BB6A');
            enrollGrad.addColorStop(1, '#2E7D32');
            
            const cancelGrad = ctx1.createLinearGradient(0, 0, 0, 250);
            cancelGrad.addColorStop(0, '#EF9A9A');
            cancelGrad.addColorStop(0.5, '#EF5350');
            cancelGrad.addColorStop(1, '#C62828');
            
            charts.movementCompare = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: periods.map(p => p.period_label),
                    datasets: [
                        { 
                            label: 'New Enrollments',
                            data: periods.map(p => Math.round(p.members * 0.08)), 
                            backgroundColor: enrollGrad, 
                            borderRadius: 6,
                            borderWidth: 2,
                            borderColor: '#1B5E20',
                            barPercentage: 0.8,
                            categoryPercentage: 0.7
                        },
                        { 
                            label: 'Cancellations',
                            data: periods.map(p => Math.round(p.members * 0.03)), 
                            backgroundColor: cancelGrad,
                            borderRadius: 6,
                            borderWidth: 2,
                            borderColor: '#B71C1C',
                            barPercentage: 0.8,
                            categoryPercentage: 0.7
                        }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { 
                            display: true, 
                            position: 'top', 
                            labels: { 
                                color: '#b8c9b8', 
                                font: { size: 13, weight: 'bold' },
                                usePointStyle: true,
                                pointStyle: 'rectRounded'
                            } 
                        } 
                    }, 
                    scales: { 
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 12, weight: 'bold' } } }, 
                        y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', font: { size: 12 } } } 
                    }
                }
            });
            
            // Movement Trend Chart - Combined line chart with net change
            const ctx2 = document.getElementById('movementTrendChart').getContext('2d');
            if (charts.movementTrend) charts.movementTrend.destroy();
            
            const netGrad = ctx2.createLinearGradient(0, 0, 0, 250);
            netGrad.addColorStop(0, 'rgba(212,175,55,0.4)');
            netGrad.addColorStop(1, 'rgba(212,175,55,0.05)');
            
            charts.movementTrend = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: periods.map(p => p.period_label),
                    datasets: [
                        { 
                            label: 'Enrollments',
                            data: periods.map(p => Math.round(p.members * 0.08)), 
                            borderColor: '#4CAF50', 
                            backgroundColor: 'rgba(76,175,80,0.1)',
                            fill: false,
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: '#4CAF50',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 8
                        },
                        { 
                            label: 'Cancellations',
                            data: periods.map(p => Math.round(p.members * 0.03)), 
                            borderColor: '#e74c3c', 
                            backgroundColor: 'rgba(231,76,60,0.1)',
                            fill: false,
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: '#e74c3c',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 8
                        },
                        { 
                            label: 'Net Change',
                            data: periods.map(p => Math.round(p.members * 0.05)), 
                            borderColor: '#FFD700', 
                            backgroundColor: netGrad, 
                            fill: true, 
                            tension: 0.4,
                            borderWidth: 4,
                            pointBackgroundColor: '#FFD700',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 3,
                            pointRadius: 6,
                            pointHoverRadius: 10
                        }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { 
                            display: true, 
                            position: 'top', 
                            labels: { 
                                color: '#b8c9b8', 
                                font: { size: 13, weight: 'bold' },
                                usePointStyle: true 
                            } 
                        } 
                    }, 
                    scales: { 
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 12, weight: 'bold' } } }, 
                        y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', font: { size: 12 } } } 
                    }
                }
            });
            
            // Full Width Trend Chart
            const ctx3 = document.getElementById('movementFullTrendChart').getContext('2d');
            if (charts.movementFullTrend) charts.movementFullTrend.destroy();
            
            const fillGreen = ctx3.createLinearGradient(0, 0, 0, 200);
            fillGreen.addColorStop(0, 'rgba(76,175,80,0.3)');
            fillGreen.addColorStop(1, 'rgba(76,175,80,0.05)');
            const fillRed = ctx3.createLinearGradient(0, 0, 0, 200);
            fillRed.addColorStop(0, 'rgba(231,76,60,0.3)');
            fillRed.addColorStop(1, 'rgba(231,76,60,0.05)');
            
            charts.movementFullTrend = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: periods.map(p => p.period_label),
                    datasets: [
                        { 
                            label: 'New Enrollments',
                            data: periods.map(p => Math.round(p.members * 0.08)), 
                            borderColor: '#4CAF50', 
                            backgroundColor: fillGreen,
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: '#4CAF50',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 10
                        },
                        { 
                            label: 'Cancellations',
                            data: periods.map(p => Math.round(p.members * 0.03)), 
                            borderColor: '#e74c3c', 
                            backgroundColor: fillRed,
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3,
                            pointBackgroundColor: '#e74c3c',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 10
                        }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { 
                            display: true, 
                            position: 'top', 
                            labels: { 
                                color: '#b8c9b8', 
                                font: { size: 14, weight: 'bold' },
                                usePointStyle: true,
                                padding: 25
                            } 
                        } 
                    }, 
                    scales: { 
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 13, weight: 'bold' } } }, 
                        y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', font: { size: 12 } } } 
                    }
                }
            });
        }
        
        function createCostBreakdownChart(current) {
            const ctx = document.getElementById('costBreakdownChart').getContext('2d');
            if (charts.costBreakdown) charts.costBreakdown.destroy();
            
            // 3D Shadow plugin
            const shadow3D = {
                id: 'shadow3D',
                beforeDraw: (chart) => {
                    const ctx = chart.ctx;
                    ctx.save();
                    ctx.shadowColor = 'rgba(0,0,0,0.4)';
                    ctx.shadowBlur = 12;
                    ctx.shadowOffsetX = 6;
                    ctx.shadowOffsetY = 6;
                }
            };
            
            const baseCost = current.cost_per_member * 0.7;
            const auditFee = baseCost * 0.15;
            const regFee = 24;
            const monthlyFee = 9;
            
            // Create gradients for 3D effect
            const greenGrad = ctx.createLinearGradient(0, 0, 0, 300);
            greenGrad.addColorStop(0, '#66BB6A');
            greenGrad.addColorStop(0.5, '#43A047');
            greenGrad.addColorStop(1, '#2E7D32');
            
            const goldGrad = ctx.createLinearGradient(0, 0, 0, 300);
            goldGrad.addColorStop(0, '#FFE082');
            goldGrad.addColorStop(0.5, '#FFD54F');
            goldGrad.addColorStop(1, '#FFC107');
            
            const blueGrad = ctx.createLinearGradient(0, 0, 0, 300);
            blueGrad.addColorStop(0, '#64B5F6');
            blueGrad.addColorStop(0.5, '#42A5F5');
            blueGrad.addColorStop(1, '#1E88E5');
            
            const purpleGrad = ctx.createLinearGradient(0, 0, 0, 300);
            purpleGrad.addColorStop(0, '#4DD0E1');
            purpleGrad.addColorStop(0.5, '#00BCD4');
            purpleGrad.addColorStop(1, '#00838F');
            
            const redGrad = ctx.createLinearGradient(0, 0, 0, 300);
            redGrad.addColorStop(0, '#EF5350');
            redGrad.addColorStop(0.5, '#E53935');
            redGrad.addColorStop(1, '#C62828');
            
            charts.costBreakdown = new Chart(ctx, {
                type: 'bar',
                plugins: [shadow3D],
                data: {
                    labels: ['Base Claims', 'Audit Fee', 'Registration', 'Monthly', 'Total'],
                    datasets: [{
                        data: [baseCost, auditFee, regFee, monthlyFee, current.cost_per_member],
                        backgroundColor: [greenGrad, goldGrad, blueGrad, purpleGrad, redGrad],
                        borderRadius: { topLeft: 8, topRight: 8, bottomLeft: 0, bottomRight: 0 },
                        borderWidth: 2,
                        borderColor: ['#1B5E20', '#F57F17', '#1565C0', '#006064', '#B71C1C'],
                        barPercentage: 0.7
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { weight: 'bold', size: 10 } } }, 
                        y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', callback: v => '$' + v.toFixed(0) } } 
                    } 
                }
            });
        }
        
        // ============ NEW SECTIONS CHARTS ============
        
        function createCategoryCharts(current) {
            // Mock data - will come from Excel/CBMS
            const categories = [
                { name: 'Medical', cases: 450, cost: 125000, color: '#4CAF50' },
                { name: 'Dental', cases: 180, cost: 28000, color: '#2196F3' },
                { name: 'Maternity', cases: 45, cost: 85000, color: '#E91E63' },
                { name: 'Optical', cases: 120, cost: 15000, color: '#FF9800' },
                { name: 'Laboratory', cases: 280, cost: 42000, color: '#D4AF37' },
                { name: 'Other', cases: 95, cost: 18000, color: '#607D8B' }
            ];
            
            // Update stat values
            document.getElementById('catMedical').textContent = categories[0].cases;
            document.getElementById('catDental').textContent = categories[1].cases;
            document.getElementById('catMaternity').textContent = categories[2].cases;
            document.getElementById('catOptical').textContent = categories[3].cases;
            document.getElementById('catLab').textContent = categories[4].cases;
            document.getElementById('catOther').textContent = categories[5].cases;
            
            // Category Pie Chart
            const ctx1 = document.getElementById('categoryPieChart').getContext('2d');
            if (charts.categoryPie) charts.categoryPie.destroy();
            charts.categoryPie = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: categories.map(c => c.name),
                    datasets: [{
                        data: categories.map(c => c.cases),
                        backgroundColor: categories.map(c => c.color),
                        borderWidth: 2,
                        borderColor: '#0a1a0a',
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '55%',
                    plugins: { legend: { display: true, position: 'right', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20, boxWidth: 16, boxHeight: 16 } } }
                }
            });
            
            // Category Cost Bar Chart
            const ctx2 = document.getElementById('categoryCostChart').getContext('2d');
            if (charts.categoryCost) charts.categoryCost.destroy();
            charts.categoryCost = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: categories.map(c => c.name),
                    datasets: [{
                        data: categories.map(c => c.cost),
                        backgroundColor: categories.map(c => c.color + 'CC'),
                        borderColor: categories.map(c => c.color),
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', callback: v => '$' + fmt(v) } },
                        y: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 10 } } }
                    }
                }
            });
            
            // Category Trend Chart
            const ctx3 = document.getElementById('categoryTrendChart').getContext('2d');
            if (charts.categoryTrend) charts.categoryTrend.destroy();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            charts.categoryTrend = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: categories.slice(0, 4).map(cat => ({
                        label: cat.name,
                        data: months.map(() => Math.round(cat.cases / 6 * (0.8 + Math.random() * 0.4))),
                        borderColor: cat.color,
                        backgroundColor: cat.color + '20',
                        fill: false,
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 4
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'top', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20 } } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8' } },
                        y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } }
                    }
                }
            });
        }
        
        function createYoYCharts(periods) {
            // Mock YoY data
            const data2024 = { claims: 3850, cost: 285000, members: 980 };
            const data2025 = { claims: 4320, cost: 312000, members: 1127 };
            
            // Update YoY stats
            document.getElementById('yoyClaims2025').textContent = fmt(data2025.claims);
            document.getElementById('yoyClaims2024').textContent = fmt(data2024.claims);
            document.getElementById('yoyCost2025').textContent = '$' + fmt(data2025.cost);
            document.getElementById('yoyCost2024').textContent = '$' + fmt(data2024.cost);
            
            const claimsChange = ((data2025.claims - data2024.claims) / data2024.claims * 100).toFixed(0);
            const costChange = ((data2025.cost - data2024.cost) / data2024.cost * 100).toFixed(0);
            const memberChange = ((data2025.members - data2024.members) / data2024.members * 100).toFixed(0);
            const costPerMember2024 = data2024.cost / data2024.members;
            const costPerMember2025 = data2025.cost / data2025.members;
            const cpmChange = ((costPerMember2025 - costPerMember2024) / costPerMember2024 * 100).toFixed(0);
            
            document.getElementById('yoyClaimsChange').textContent = (claimsChange > 0 ? '+' : '') + claimsChange + '%';
            document.getElementById('yoyCostChange').textContent = (costChange > 0 ? '+' : '') + costChange + '%';
            document.getElementById('yoyMemberChange').textContent = (memberChange > 0 ? '+' : '') + memberChange + '%';
            document.getElementById('yoyCostPerMember').textContent = (cpmChange > 0 ? '+' : '') + cpmChange + '%';
            
            // YoY Claims Chart
            const ctx1 = document.getElementById('yoyClaimsChart').getContext('2d');
            if (charts.yoyClaims) charts.yoyClaims.destroy();
            charts.yoyClaims = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Q1', 'Q2', 'Q3', 'Q4'],
                    datasets: [
                        { label: '2024', data: [920, 980, 1050, 900], backgroundColor: 'rgba(122,143,122,0.7)', borderRadius: 4 },
                        { label: '2025', data: [1080, 1150, 1090, null], backgroundColor: 'rgba(212,175,55,0.8)', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'top', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20 } } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8' } },
                        y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } }
                    }
                }
            });
            
            // YoY Cost Chart
            const ctx2 = document.getElementById('yoyCostChart').getContext('2d');
            if (charts.yoyCost) charts.yoyCost.destroy();
            charts.yoyCost = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Q1', 'Q2', 'Q3', 'Q4'],
                    datasets: [
                        { label: '2024', data: [68000, 72000, 78000, 67000], backgroundColor: 'rgba(122,143,122,0.7)', borderRadius: 4 },
                        { label: '2025', data: [82000, 95000, 88000, null], backgroundColor: 'rgba(76,175,80,0.8)', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'top', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20 } } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8' } },
                        y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', callback: v => '$' + fmt(v) } }
                    }
                }
            });
            
            // YoY Trend Chart
            const ctx3 = document.getElementById('yoyTrendChart').getContext('2d');
            if (charts.yoyTrend) charts.yoyTrend.destroy();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'];
            charts.yoyTrend = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        { 
                            label: '2025', 
                            data: [320, 380, 410, 350, 420, 380, 390, 410, 360],
                            borderColor: '#D4AF37',
                            backgroundColor: 'rgba(212,175,55,0.2)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: 5
                        },
                        { 
                            label: '2024', 
                            data: [280, 320, 350, 310, 380, 340, 360, 390, 320],
                            borderColor: '#7a8f7a',
                            backgroundColor: 'rgba(122,143,122,0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'top', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20 } } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8' } },
                        y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } }
                    }
                }
            });
        }
        
        function createHospitalCharts() {
            // Mock hospital data - will come from CBMS
            const hospitals = [
                { name: 'St. Luke\'s BGC', claims: 185, cost: 452000 },
                { name: 'Makati Medical', claims: 156, cost: 380000 },
                { name: 'The Medical City', claims: 142, cost: 325000 },
                { name: 'Asian Hospital', claims: 128, cost: 298000 },
                { name: 'Manila Doctors', claims: 115, cost: 245000 },
                { name: 'Cardinal Santos', claims: 98, cost: 215000 },
                { name: 'Chong Hua Cebu', claims: 87, cost: 178000 },
                { name: 'UERM', claims: 76, cost: 145000 },
                { name: 'PGH', claims: 68, cost: 98000 },
                { name: 'Others', claims: 315, cost: 480000 }
            ];
            
            const totalCost = hospitals.reduce((a, h) => a + h.cost, 0);
            
            // Top Hospitals by Claims
            const ctx1 = document.getElementById('topHospitalsChart').getContext('2d');
            if (charts.topHospitals) charts.topHospitals.destroy();
            charts.topHospitals = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: hospitals.map(h => h.name),
                    datasets: [{
                        data: hospitals.map(h => h.claims),
                        backgroundColor: 'rgba(76,175,80,0.7)',
                        borderColor: '#4CAF50',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } },
                        y: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 9 } } }
                    }
                }
            });
            
            // Top Hospitals by Cost
            const ctx2 = document.getElementById('topHospitalsCostChart').getContext('2d');
            if (charts.topHospitalsCost) charts.topHospitalsCost.destroy();
            charts.topHospitalsCost = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: hospitals.map(h => h.name),
                    datasets: [{
                        data: hospitals.map(h => h.cost),
                        backgroundColor: 'rgba(212,175,55,0.7)',
                        borderColor: '#D4AF37',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', callback: v => '$' + fmt(v) } },
                        y: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 9 } } }
                    }
                }
            });
            
            // Hospital Table
            const tbody = document.getElementById('hospitalsTableBody');
            tbody.innerHTML = hospitals.map((h, i) => `
                <tr>
                    <td><span style="background:${i < 3 ? '#D4AF37' : '#2E7D32'};color:#000;padding:2px 8px;border-radius:10px;font-weight:bold">${i + 1}</span></td>
                    <td><strong>${h.name}</strong></td>
                    <td>${h.claims}</td>
                    <td>$${fmt(h.cost)}</td>
                    <td>$${fmt(Math.round(h.cost / h.claims))}</td>
                    <td>${(h.cost / totalCost * 100).toFixed(1)}%</td>
                </tr>
            `).join('');
        }
        
        function createGeoCharts() {
            // Mock geographic data - will come from CBMS
            const regions = [
                { name: 'NCR', claims: 580, cost: 1250000, color: '#4CAF50' },
                { name: 'Central Visayas', claims: 245, cost: 485000, color: '#2196F3' },
                { name: 'Davao Region', claims: 165, cost: 320000, color: '#FF9800' },
                { name: 'Western Visayas', claims: 125, cost: 215000, color: '#D4AF37' },
                { name: 'Central Luzon', claims: 95, cost: 165000, color: '#E91E63' },
                { name: 'Other Regions', claims: 160, cost: 280000, color: '#607D8B' }
            ];
            
            // Update city stats
            document.getElementById('geoManila').textContent = '580';
            document.getElementById('geoCebu').textContent = '185';
            document.getElementById('geoDavao').textContent = '165';
            document.getElementById('geoIloilo').textContent = '95';
            document.getElementById('geoOther').textContent = '345';
            
            // Region Pie Chart
            const ctx1 = document.getElementById('geoRegionChart').getContext('2d');
            if (charts.geoRegion) charts.geoRegion.destroy();
            charts.geoRegion = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: regions.map(r => r.name),
                    datasets: [{
                        data: regions.map(r => r.claims),
                        backgroundColor: regions.map(r => r.color),
                        borderWidth: 2,
                        borderColor: '#0a1a0a',
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '55%',
                    plugins: { legend: { display: true, position: 'right', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20, boxWidth: 16, boxHeight: 16 } } }
                }
            });
            
            // Region Cost Chart
            const ctx2 = document.getElementById('geoCostChart').getContext('2d');
            if (charts.geoCost) charts.geoCost.destroy();
            charts.geoCost = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: regions.map(r => r.name),
                    datasets: [{
                        data: regions.map(r => r.cost),
                        backgroundColor: regions.map(r => r.color + 'CC'),
                        borderColor: regions.map(r => r.color),
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', callback: v => '$' + fmt(v) } },
                        y: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 9 } } }
                    }
                }
            });
            
            // Cities Bar Chart
            const ctx3 = document.getElementById('geoCitiesChart').getContext('2d');
            if (charts.geoCities) charts.geoCities.destroy();
            const cities = [
                { name: 'Manila', claims: 285 },
                { name: 'Quezon City', claims: 165 },
                { name: 'Cebu City', claims: 145 },
                { name: 'Davao City', claims: 125 },
                { name: 'Makati', claims: 95 },
                { name: 'Pasig', claims: 85 },
                { name: 'Iloilo City', claims: 75 },
                { name: 'Taguig', claims: 65 }
            ];
            charts.geoCities = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: cities.map(c => c.name),
                    datasets: [{
                        data: cities.map(c => c.claims),
                        backgroundColor: [
                            '#4CAF50', '#66BB6A', '#2196F3', '#FF9800', 
                            '#D4AF37', '#E91E63', '#00BCD4', '#607D8B'
                        ],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 13, weight: 'bold' } } },
                        y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', font: { size: 12 } } }
                    }
                }
            });
        }
        
        function setTrend(id, ch) {
            const el = document.getElementById(id);
            if (!ch || ch.percentage === null) { el.textContent = 'N/A'; return; }
            el.innerHTML = `${ch.percentage > 0 ? '↑' : '↓'} ${Math.abs(ch.percentage).toFixed(1)}%`;
            // For costs: down is good (green), up is bad (red)
            // For members/claims: up can be either based on context
            el.className = `kpi-trend ${ch.percentage <= 0 ? 'down' : 'up'}`;
        }
        
        function setChange(id, ch) {
            const el = document.getElementById(id);
            if (!ch || ch.percentage === null) { el.textContent = 'N/A'; return; }
            el.innerHTML = `${ch.percentage > 0 ? '↑' : '↓'} ${Math.abs(ch.percentage).toFixed(1)}%`;
            el.className = `cmp-change ${ch.percentage >= 0 ? 'positive' : 'negative'}`;
        }
        
        function createCharts(periods, current) {
            const labels = periods.map(p => p.period_label);
            
            // 3D Shadow plugin
            const shadow3D = {
                id: 'shadow3D',
                beforeDraw: (chart) => {
                    const ctx = chart.ctx;
                    ctx.save();
                    ctx.shadowColor = 'rgba(0,0,0,0.4)';
                    ctx.shadowBlur = 12;
                    ctx.shadowOffsetX = 5;
                    ctx.shadowOffsetY = 5;
                }
            };
            
            const opts = {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(13,31,13,0.95)', borderColor: '#D4AF37', borderWidth: 2, titleFont: { weight: 'bold' } } }
            };
            
            // Cost Trend - 3D Line
            const ctx1 = document.getElementById('costTrendChart').getContext('2d');
            if (charts.cost) charts.cost.destroy();
            const grad = ctx1.createLinearGradient(0, 0, 0, 350);
            grad.addColorStop(0, 'rgba(255,215,0,0.5)'); grad.addColorStop(1, 'rgba(255,215,0,0.02)');
            charts.cost = new Chart(ctx1, {
                type: 'line',
                data: { 
                    labels, 
                    datasets: [{ 
                        data: periods.map(p => p.cost_per_member), 
                        borderColor: '#FFD700', 
                        backgroundColor: grad, 
                        fill: true, 
                        tension: 0.4, 
                        pointRadius: 6, 
                        pointHoverRadius: 10,
                        pointBackgroundColor: '#FFD700',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3,
                        borderWidth: 4 
                    }] 
                },
                options: { ...opts, scales: { x: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#b8c9b8' } }, y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#D4AF37', font: { weight: 'bold' }, callback: v => '$' + v } } } }
            });
            
            // Approved - 3D Bars
            const ctx2 = document.getElementById('approvedChart').getContext('2d');
            if (charts.approved) charts.approved.destroy();
            const approvedGrad = ctx2.createLinearGradient(0, 0, 0, 300);
            approvedGrad.addColorStop(0, '#81C784');
            approvedGrad.addColorStop(0.5, '#4CAF50');
            approvedGrad.addColorStop(1, '#2E7D32');
            charts.approved = new Chart(ctx2, {
                type: 'bar',
                plugins: [shadow3D],
                data: { 
                    labels, 
                    datasets: [{ 
                        data: periods.map(p => p.approved_usd), 
                        backgroundColor: approvedGrad, 
                        borderColor: '#1B5E20', 
                        borderWidth: 2, 
                        borderRadius: { topLeft: 8, topRight: 8, bottomLeft: 0, bottomRight: 0 },
                        barPercentage: 0.7
                    }] 
                },
                options: { ...opts, scales: { x: { grid: { display: false }, ticks: { color: '#b8c9b8' } }, y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', callback: v => '$' + fmt(v) } } } }
            });
            
            // Gauge - Enhanced 3D
            const canvas = document.getElementById('gaugeChart');
            const gctx = canvas.getContext('2d');
            const pct = Math.min(current.cost_per_member / 100, 1);
            gctx.clearRect(0, 0, 200, 200);
            
            // Outer shadow ring
            gctx.shadowColor = 'rgba(0,0,0,0.5)';
            gctx.shadowBlur = 15;
            gctx.shadowOffsetX = 5;
            gctx.shadowOffsetY = 5;
            
            // Background ring
            gctx.beginPath(); gctx.arc(100, 100, 75, Math.PI * 0.75, Math.PI * 2.25); 
            gctx.lineWidth = 22; gctx.strokeStyle = '#1e3a1e'; gctx.lineCap = 'round'; gctx.stroke();
            
            // Gradient ring
            const gg = gctx.createLinearGradient(0, 0, 200, 0); 
            gg.addColorStop(0, '#4CAF50'); gg.addColorStop(0.5, '#FFD700'); gg.addColorStop(1, '#f44336');
            gctx.beginPath(); gctx.arc(100, 100, 75, Math.PI * 0.75, Math.PI * 0.75 + Math.PI * 1.5 * pct); 
            gctx.lineWidth = 18; gctx.strokeStyle = gg; gctx.lineCap = 'round'; gctx.stroke();
            
            // Reset shadow
            gctx.shadowColor = 'transparent';
            document.getElementById('gaugeValue').textContent = '$' + current.cost_per_member.toFixed(2);
            
            // Claims by Period - 3D Bars
            const ctx3 = document.getElementById('claimsPeriodChart').getContext('2d');
            if (charts.claimsPeriod) charts.claimsPeriod.destroy();
            const claimsGrad = ctx3.createLinearGradient(0, 0, 0, 250);
            claimsGrad.addColorStop(0, '#FFE082');
            claimsGrad.addColorStop(0.5, '#FFD54F');
            claimsGrad.addColorStop(1, '#FFC107');
            charts.claimsPeriod = new Chart(ctx3, {
                type: 'bar',
                plugins: [shadow3D],
                data: { 
                    labels, 
                    datasets: [{ 
                        data: periods.map(p => p.claims), 
                        backgroundColor: claimsGrad, 
                        borderColor: '#F57F17',
                        borderWidth: 2,
                        borderRadius: { topLeft: 6, topRight: 6, bottomLeft: 0, bottomRight: 0 },
                        barPercentage: 0.6
                    }] 
                },
                options: { ...opts, scales: { x: { grid: { display: false }, ticks: { color: '#b8c9b8' } }, y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } } } }
            });
            
            // Claims per 1000 - 3D Line
            const ctx4 = document.getElementById('claims1000Chart').getContext('2d');
            if (charts.claims1000) charts.claims1000.destroy();
            const blueGrad = ctx4.createLinearGradient(0, 0, 0, 200);
            blueGrad.addColorStop(0, 'rgba(66,165,245,0.5)');
            blueGrad.addColorStop(1, 'rgba(66,165,245,0.02)');
            charts.claims1000 = new Chart(ctx4, {
                type: 'line',
                data: { 
                    labels, 
                    datasets: [{ 
                        data: periods.map(p => p.members > 0 ? p.claims / p.members * 1000 : 0), 
                        borderColor: '#42A5F5', 
                        backgroundColor: blueGrad, 
                        fill: true, 
                        tension: 0.4,
                        borderWidth: 4,
                        pointRadius: 5,
                        pointBackgroundColor: '#42A5F5',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 8
                    }] 
                },
                options: { ...opts, scales: { x: { grid: { display: false }, ticks: { color: '#b8c9b8' } }, y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } } } }
            });
            
            // Avg Claim - 3D Line
            const ctx5 = document.getElementById('avgClaimChart').getContext('2d');
            if (charts.avgClaim) charts.avgClaim.destroy();
            const orangeGrad = ctx5.createLinearGradient(0, 0, 0, 200);
            orangeGrad.addColorStop(0, 'rgba(255,152,0,0.5)');
            orangeGrad.addColorStop(1, 'rgba(255,152,0,0.02)');
            charts.avgClaim = new Chart(ctx5, {
                type: 'line',
                data: { 
                    labels, 
                    datasets: [{ 
                        data: periods.map(p => p.claims > 0 ? p.approved_usd / p.claims : 0), 
                        borderColor: '#FF9800', 
                        backgroundColor: orangeGrad, 
                        fill: true, 
                        tension: 0.4,
                        borderWidth: 4,
                        pointRadius: 5,
                        pointBackgroundColor: '#FF9800',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 8
                    }] 
                },
                options: { ...opts, scales: { x: { grid: { display: false }, ticks: { color: '#b8c9b8' } }, y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', callback: v => '$' + v.toFixed(0) } } } }
            });
            
            // Plan Pie - 3D Doughnut
            const ctx6 = document.getElementById('planPieChart').getContext('2d');
            if (charts.planPie) charts.planPie.destroy();
            const goldPlanGrad = ctx6.createLinearGradient(0, 0, 0, 300);
            goldPlanGrad.addColorStop(0, '#FFE57F');
            goldPlanGrad.addColorStop(1, '#FFB300');
            const platGrad = ctx6.createLinearGradient(0, 0, 0, 300);
            platGrad.addColorStop(0, '#F5F5F5');
            platGrad.addColorStop(1, '#BDBDBD');
            const silverGrad = ctx6.createLinearGradient(0, 0, 0, 300);
            silverGrad.addColorStop(0, '#E0E0E0');
            silverGrad.addColorStop(1, '#9E9E9E');
            charts.planPie = new Chart(ctx6, {
                type: 'doughnut',
                plugins: [shadow3D],
                data: { 
                    labels: ['Gold', 'Platinum', 'Silver'], 
                    datasets: [{ 
                        data: [60, 25, 15], 
                        backgroundColor: [goldPlanGrad, platGrad, silverGrad], 
                        borderColor: ['#FF8F00', '#757575', '#616161'], 
                        borderWidth: 3, 
                        hoverOffset: 15 
                    }] 
                },
                options: { ...opts, cutout: '55%', plugins: { legend: { display: true, position: 'bottom', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20 } } } }
            });
            
            // Plan Cost - 3D Horizontal Bars
            const ctx7 = document.getElementById('planCostChart').getContext('2d');
            if (charts.planCost) charts.planCost.destroy();
            charts.planCost = new Chart(ctx7, {
                type: 'bar',
                plugins: [shadow3D],
                data: { 
                    labels: ['Gold', 'Platinum', 'Silver'], 
                    datasets: [{ 
                        data: [65, 85, 35], 
                        backgroundColor: [goldPlanGrad, platGrad, silverGrad],
                        borderColor: ['#FF8F00', '#757575', '#616161'],
                        borderWidth: 2,
                        borderRadius: 6 
                    }] 
                },
                options: { ...opts, indexAxis: 'y', scales: { x: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', callback: v => '$' + v } }, y: { grid: { display: false }, ticks: { color: '#fff', font: { weight: 'bold' } } } } }
            });
            
            // Utilization - 3D Line
            const ctx8 = document.getElementById('utilizationChart').getContext('2d');
            if (charts.util) charts.util.destroy();
            const greenGrad = ctx8.createLinearGradient(0, 0, 0, 200);
            greenGrad.addColorStop(0, 'rgba(76,175,80,0.5)');
            greenGrad.addColorStop(1, 'rgba(76,175,80,0.02)');
            charts.util = new Chart(ctx8, {
                type: 'line',
                data: { 
                    labels, 
                    datasets: [{ 
                        data: periods.map(p => p.members > 0 ? p.claims / p.members * 100 : 0), 
                        borderColor: '#4CAF50', 
                        backgroundColor: greenGrad, 
                        fill: true, 
                        tension: 0.4,
                        borderWidth: 4,
                        pointRadius: 5,
                        pointBackgroundColor: '#4CAF50',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 8
                    }] 
                },
                options: { ...opts, scales: { x: { grid: { display: false }, ticks: { color: '#b8c9b8' } }, y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', callback: v => v + '%' } } } }
            });
        }
        
        function updateMetrics(util) {
            document.getElementById('utilValue').textContent = util.toFixed(1) + '%';
            document.getElementById('utilBar').style.width = Math.min(util * 2, 100) + '%';
        }
        
        function updateInsights(ch) {
            const list = document.getElementById('insightsList');
            const insights = [];
            if (ch) {
                // Check cost - good if decreased (negative percentage)
                if (ch.cost && ch.cost.percentage !== null) {
                    if (ch.cost.percentage < 0) insights.push({ type: 'success', icon: '✓', title: 'Cost Improvement', desc: `Cost decreased by ${Math.abs(ch.cost.percentage).toFixed(1)}%` });
                    else if (ch.cost.percentage > 10) insights.push({ type: 'danger', icon: '⚠', title: 'Cost Alert', desc: `Cost increased by ${ch.cost.percentage.toFixed(1)}%` });
                }
                // Check members - good if increased
                if (ch.members && ch.members.percentage !== null && ch.members.percentage > 0) {
                    insights.push({ type: 'success', icon: '📈', title: 'Growth', desc: `Members grew by ${ch.members.percentage.toFixed(1)}%` });
                }
                // Check claims - warning if increased significantly
                if (ch.claims && ch.claims.percentage !== null && ch.claims.percentage > 5) {
                    insights.push({ type: 'warning', icon: '!', title: 'Claims Up', desc: `Claims increased by ${ch.claims.percentage.toFixed(1)}%` });
                }
            }
            while (insights.length < 3) insights.push({ type: 'info', icon: 'ℹ', title: 'Analysis', desc: 'Continue monitoring trends' });
            list.innerHTML = insights.slice(0, 3).map(i => `
                <div class="insight-item ${i.type}">
                    <div class="insight-icon">${i.icon}</div>
                    <div><div class="insight-title">${i.title}</div><div class="insight-desc">${i.desc}</div></div>
                </div>
            `).join('');
        }
        
        function updateTable(periods) {
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = periods.map((p, i) => {
                const rank = periods.length - i;
                const cls = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
                const util = p.members > 0 ? (p.claims / p.members * 100).toFixed(1) : 0;
                return `<tr>
                    <td><div class="rank-badge ${cls}">${rank}</div></td>
                    <td><strong>${p.period_label}</strong></td>
                    <td>${fmt(p.members)}</td>
                    <td>${fmt(p.claims)}</td>
                    <td>₱${fmt(p.approved_php)}</td>
                    <td class="currency">$${fmt(p.approved_usd)}</td>
                    <td class="currency">$${p.cost_per_member.toFixed(2)}</td>
                    <td>${util}%</td>
                </tr>`;
            }).reverse().join('');
        }
        
        function fmt(n) { return n === undefined ? '-' : n.toLocaleString('en-US', { maximumFractionDigits: 0 }); }
        
        // Initialize on page load
        // ═══════════════════════════════════════════════════════════════════════════
        // WELCOME SCREEN & MAIN DASHBOARD FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════════════
        
        let isInAppView = false; // Track if user is in full app view
        
        // Initialize Welcome Screen with stars and particles
        function initWelcomeScreen() {
            const starsContainer = document.getElementById('starsContainer');
            const particlesContainer = document.getElementById('particlesContainer');
            
            // Create random stars
            if (starsContainer) {
                for (let i = 0; i < 100; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 100 + '%';
                    star.style.width = (Math.random() * 3 + 1) + 'px';
                    star.style.height = star.style.width;
                    star.style.animationDelay = Math.random() * 3 + 's';
                    star.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    starsContainer.appendChild(star);
                }
            }
            
            // Create floating particles
            if (particlesContainer) {
                for (let i = 0; i < 30; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 8 + 's';
                    particle.style.animationDuration = (Math.random() * 4 + 6) + 's';
                    particlesContainer.appendChild(particle);
                }
            }
        }
        
        // Show Welcome Loading Screen
        function showWelcomeScreen() {
            const welcomeScreen = document.getElementById('welcomeLoadingScreen');
            const loginModal = document.getElementById('loginModal');
            
            if (loginModal) loginModal.classList.add('hidden');
            if (welcomeScreen) welcomeScreen.classList.remove('hidden');
            
            initWelcomeScreen();
            
            // Update loading text
            const loadingTexts = [
                'Initializing system...',
                'Loading client data...',
                'Preparing healthcare plans...',
                'Connecting to services...',
                'Almost ready...'
            ];
            
            let textIndex = 0;
            const loadingTextEl = document.getElementById('welcomeLoadingText');
            const textInterval = setInterval(() => {
                textIndex++;
                if (textIndex < loadingTexts.length && loadingTextEl) {
                    loadingTextEl.textContent = loadingTexts[textIndex];
                }
            }, 500);
            
            // Transition to Main Dashboard after loading
            setTimeout(() => {
                clearInterval(textInterval);
                transitionToMainDashboard();
            }, 3000);
        }
        
        // Initialize Dashboard Stars Background
        function initDashboardStars() {
            const starsContainer = document.getElementById('dashboardStarsContainer');
            const particlesContainer = document.getElementById('dashboardParticlesContainer');
            
            // Only init once
            if (starsContainer && starsContainer.children.length === 0) {
                // Create stars
                for (let i = 0; i < 80; i++) {
                    const star = document.createElement('div');
                    star.className = 'dashboard-star';
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 100 + '%';
                    star.style.width = (Math.random() * 3 + 1) + 'px';
                    star.style.height = star.style.width;
                    star.style.animationDelay = Math.random() * 4 + 's';
                    star.style.animationDuration = (Math.random() * 3 + 3) + 's';
                    starsContainer.appendChild(star);
                }
            }
            
            // Only init particles once
            if (particlesContainer && particlesContainer.children.length === 0) {
                for (let i = 0; i < 20; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'dashboard-particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 10 + 's';
                    particle.style.animationDuration = (Math.random() * 5 + 8) + 's';
                    particlesContainer.appendChild(particle);
                }
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // HORIZONTAL SCROLL WITH ARROWS
        // ═══════════════════════════════════════════════════════════════════════════
        
        function initScrollContainers() {
            document.querySelectorAll('.scroll-container').forEach(container => {
                const content = container.querySelector('.scroll-content');
                const leftArrow = container.querySelector('.scroll-arrow.left');
                const rightArrow = container.querySelector('.scroll-arrow.right');
                
                if (!content) return;
                
                const updateArrows = () => {
                    const canScrollLeft = content.scrollLeft > 10;
                    const canScrollRight = content.scrollLeft < (content.scrollWidth - content.clientWidth - 10);
                    
                    if (leftArrow) {
                        leftArrow.classList.toggle('visible', canScrollLeft);
                    }
                    if (rightArrow) {
                        rightArrow.classList.toggle('visible', canScrollRight);
                    }
                };
                
                content.addEventListener('scroll', updateArrows);
                window.addEventListener('resize', updateArrows);
                
                // Initial check
                setTimeout(updateArrows, 100);
                
                if (leftArrow) {
                    leftArrow.addEventListener('click', () => {
                        content.scrollBy({ left: -300, behavior: 'smooth' });
                    });
                }
                
                if (rightArrow) {
                    rightArrow.addEventListener('click', () => {
                        content.scrollBy({ left: 300, behavior: 'smooth' });
                    });
                }
            });
        }
        
        // Make any element horizontally scrollable with arrows
        function wrapWithScrollContainer(element) {
            if (!element || element.parentElement?.classList.contains('scroll-container')) return;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'scroll-container';
            
            const content = document.createElement('div');
            content.className = 'scroll-content';
            
            const leftArrow = document.createElement('button');
            leftArrow.className = 'scroll-arrow left';
            leftArrow.innerHTML = '◀';
            leftArrow.setAttribute('aria-label', 'Scroll left');
            
            const rightArrow = document.createElement('button');
            rightArrow.className = 'scroll-arrow right';
            rightArrow.innerHTML = '▶';
            rightArrow.setAttribute('aria-label', 'Scroll right');
            
            element.parentNode.insertBefore(wrapper, element);
            content.appendChild(element);
            wrapper.appendChild(leftArrow);
            wrapper.appendChild(content);
            wrapper.appendChild(rightArrow);
            
            // Initialize scroll functionality
            const updateArrows = () => {
                const canScrollLeft = content.scrollLeft > 10;
                const canScrollRight = content.scrollLeft < (content.scrollWidth - content.clientWidth - 10);
                leftArrow.classList.toggle('visible', canScrollLeft);
                rightArrow.classList.toggle('visible', canScrollRight);
            };
            
            content.addEventListener('scroll', updateArrows);
            window.addEventListener('resize', updateArrows);
            setTimeout(updateArrows, 100);
            
            leftArrow.addEventListener('click', () => {
                content.scrollBy({ left: -300, behavior: 'smooth' });
            });
            
            rightArrow.addEventListener('click', () => {
                content.scrollBy({ left: 300, behavior: 'smooth' });
            });
            
            return wrapper;
        }
        
        // Auto-wrap wide tables on mobile
        function initResponsiveTables() {
            const tables = document.querySelectorAll('table:not(.no-scroll)');
            const isMobile = window.innerWidth <= 992;
            
            if (isMobile) {
                tables.forEach(table => {
                    if (table.scrollWidth > table.parentElement?.clientWidth) {
                        wrapWithScrollContainer(table);
                    }
                });
            }
        }
        
        // Initialize scroll arrows for specific table containers
        function initTableScrollArrows() {
            document.querySelectorAll('.scroll-container').forEach(container => {
                const content = container.querySelector('.scroll-content');
                const leftArrow = container.querySelector('.scroll-arrow.left');
                const rightArrow = container.querySelector('.scroll-arrow.right');
                
                if (!content || !leftArrow || !rightArrow) return;
                
                const updateArrows = () => {
                    const canScrollLeft = content.scrollLeft > 10;
                    const canScrollRight = content.scrollLeft < (content.scrollWidth - content.clientWidth - 10);
                    
                    leftArrow.classList.toggle('visible', canScrollLeft);
                    rightArrow.classList.toggle('visible', canScrollRight);
                };
                
                // Remove old listeners first
                content.removeEventListener('scroll', updateArrows);
                
                // Add listener
                content.addEventListener('scroll', updateArrows);
                
                // Initial check with delay
                setTimeout(updateArrows, 100);
                setTimeout(updateArrows, 500);
            });
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initScrollContainers();
            initResponsiveTables();
            window.addEventListener('resize', debounce(initResponsiveTables, 250));
        });
        
        // ═══════════════════════════════════════════════════════════════════════════
        // FULLSCREEN MODE
        // ═══════════════════════════════════════════════════════════════════════════
        
        let isFullscreen = false;
        
        function enterFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) { /* Safari */
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { /* IE11 */
                elem.msRequestFullscreen();
            }
            isFullscreen = true;
            updateFullscreenButton();
        }
        
        function exitFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) { /* Safari */
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { /* IE11 */
                document.msExitFullscreen();
            }
            isFullscreen = false;
            updateFullscreenButton();
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                enterFullscreen();
            } else {
                exitFullscreen();
            }
        }
        
        function updateFullscreenButton() {
            const btn = document.getElementById('fullscreenToggleBtn');
            if (btn) {
                if (document.fullscreenElement || document.webkitFullscreenElement) {
                    btn.innerHTML = '⛶';
                    btn.title = 'Exit Fullscreen (Esc)';
                } else {
                    btn.innerHTML = '⛶';
                    btn.title = 'Enter Fullscreen (F11)';
                }
            }
        }
        
        // Listen for fullscreen change events
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
        
        // Auto-enter fullscreen after welcome (requires user click)
        let fullscreenRequested = false;
        
        function enterFullscreenAndContinue() {
            // Enter fullscreen
            enterFullscreen();
            
            // Hide the button
            const btn = document.getElementById('welcomeFullscreenBtn');
            if (btn) {
                btn.style.display = 'none';
            }
            
            // Update loading text
            const loadingText = document.getElementById('welcomeLoadingText');
            if (loadingText) {
                loadingText.textContent = 'Entering full screen mode...';
            }
            
            fullscreenRequested = true;
        }
        
        function requestFullscreenOnFirstClick() {
            if (!fullscreenRequested) {
                fullscreenRequested = true;
                enterFullscreen();
            }
        }
        
        // Transition from Welcome Screen to Main Dashboard
        function transitionToMainDashboard() {
            const welcomeScreen = document.getElementById('welcomeLoadingScreen');
            const mainDashboard = document.getElementById('mainDashboard');
            
            // Fade out welcome screen
            if (welcomeScreen) {
                welcomeScreen.classList.add('hidden');
            }
            
            // Show main dashboard after brief delay
            setTimeout(() => {
                if (mainDashboard) {
                    mainDashboard.classList.remove('hidden');
                    initDashboardStars();
                    updateDashboardStats();
                }
            }, 800);
        }
        
        // Go to Dashboard (POLARIS Portal with cards)
        function goToDashboard() {
            const mainDashboard = document.getElementById('mainDashboard');
            const mainContent = document.getElementById('mainContent');
            const mainHeader = document.getElementById('mainHeader');
            const mainFooter = document.getElementById('mainFooter');
            const dashboardBtn = document.getElementById('dashboardBtn');
            const mainDashboardBtn = document.getElementById('mainDashboardBtn');
            
            // Close any open modals
            try { closeEmailCenter(); } catch(e) {}
            try { closeContractCenter(); } catch(e) {}
            try { closeOffersCenter(); } catch(e) {}
            try { closeReportBuilder(); } catch(e) {}
            try { closeRenewals(); } catch(e) {}
            
            // Hide app view
            if (mainContent) mainContent.style.display = 'none';
            if (mainHeader) mainHeader.style.display = 'none';
            if (mainFooter) mainFooter.style.display = 'none';
            if (dashboardBtn) dashboardBtn.style.display = 'none';
            if (mainDashboardBtn) mainDashboardBtn.style.display = 'none';
            
            // Show POLARIS Portal (cards)
            if (mainDashboard) mainDashboard.classList.remove('hidden');
            
            isInAppView = false;
            initDashboardStars();
            updateDashboardStats();
        }
        
        // Go to Main Dashboard (Admin Dashboard with KPIs)
        function goToMainDashboard() {
            const mainDashboard = document.getElementById('mainDashboard');
            const mainContent = document.getElementById('mainContent');
            const mainHeader = document.getElementById('mainHeader');
            const mainFooter = document.getElementById('mainFooter');
            const dashboardBtn = document.getElementById('dashboardBtn');
            const mainDashboardBtn = document.getElementById('mainDashboardBtn');
            
            // Close any open modals
            try { closeEmailCenter(); } catch(e) {}
            try { closeContractCenter(); } catch(e) {}
            try { closeOffersCenter(); } catch(e) {}
            try { closeReportBuilder(); } catch(e) {}
            try { closeRenewals(); } catch(e) {}
            
            // Hide POLARIS Portal
            if (mainDashboard) mainDashboard.classList.add('hidden');
            
            // Show Admin Dashboard (KPIs)
            if (mainContent) mainContent.style.display = 'block';
            if (mainHeader) mainHeader.style.display = 'flex';
            if (mainFooter) mainFooter.style.display = 'block';
            
            // Show Dashboard button, hide Main Dashboard button
            if (dashboardBtn) dashboardBtn.style.display = 'flex';
            if (mainDashboardBtn) mainDashboardBtn.style.display = 'none';
            
            isInAppView = true;
        }
        
        // Keep showMainDashboard for backwards compatibility (calls goToDashboard)
        function showMainDashboard() {
            goToDashboard();
        }
        
        // Enter specific module from dashboard
        function enterModule(module) {
            const mainDashboard = document.getElementById('mainDashboard');
            const mainContent = document.getElementById('mainContent');
            const mainHeader = document.getElementById('mainHeader');
            const mainFooter = document.getElementById('mainFooter');
            const dashboardBtn = document.getElementById('dashboardBtn');
            const mainDashboardBtn = document.getElementById('mainDashboardBtn');
            
            // Special cases that don't need to show app view
            if (module === 'members') {
                // Open Active Members in new tab
                window.open('https://polaris.cfserver3.net/', '_blank');
                return;
            }
            
            // Hide POLARIS Portal (cards)
            if (mainDashboard) mainDashboard.classList.add('hidden');
            
            // Show Admin Dashboard (KPIs)
            if (mainContent) mainContent.style.display = 'block';
            if (mainHeader) mainHeader.style.display = 'flex';
            if (mainFooter) mainFooter.style.display = 'block';
            
            // Show Dashboard button (to go back to POLARIS Portal)
            if (dashboardBtn) dashboardBtn.style.display = 'flex';
            // Hide Main Dashboard button (we're already in Main Dashboard)
            if (mainDashboardBtn) mainDashboardBtn.style.display = 'none';
            
            isInAppView = true;
            
            // Navigate to specific module
            switch(module) {
                case 'clients':
                    switchTab('clients');
                    break;
                case 'newproposal':
                    // Open Offers Center and switch to New Proposal tab
                    openOffersCenter();
                    setTimeout(() => {
                        if (typeof switchOffersTab === 'function') {
                            switchOffersTab('create');
                        }
                    }, 300);
                    break;
                case 'offers':
                    // Open Offers Center and show All Offers tab
                    openOffersCenter();
                    setTimeout(() => {
                        if (typeof switchOffersTab === 'function') {
                            switchOffersTab('list');
                        }
                    }, 300);
                    break;
                case 'contracts':
                    openContractCenter();
                    break;
                case 'email':
                    openEmailCenter();
                    break;
                case 'comparison':
                    // Open Offers Center and switch to Comparison Quote tab
                    openOffersCenter();
                    setTimeout(() => {
                        if (typeof switchOffersTab === 'function') {
                            switchOffersTab('compare');
                        }
                    }, 300);
                    break;
                case 'reports':
                    openReportBuilder();
                    break;
                case 'calculator':
                    switchTab('calculator');
                    break;
                case 'followups':
                    // Open Follow Ups / Renewals dashboard
                    openRenewals();
                    break;
                case 'settings':
                    alert('⚙️ Settings panel coming soon!');
                    break;
                default:
                    switchTab('dashboard');
            }
        }
        
        // Update dashboard statistics
        async function updateDashboardStats() {
            try {
                // Get counts from cached data or API
                const statsClients = document.getElementById('dashStatClients');
                const statsOffers = document.getElementById('dashStatOffers');
                const statsContracts = document.getElementById('dashStatContracts');
                const statsMembers = document.getElementById('dashStatMembers');
                const statsPending = document.getElementById('dashStatPending');
                const offersNotif = document.getElementById('dashOffersNotif');
                
                // Use cached data if available
                const clientCount = window.clientsData?.length || '--';
                const offerCount = window.offersData?.length || '--';
                const contractCount = window.contractsData?.length || '--';
                
                // Calculate totals
                let totalMembers = 0;
                let pendingCount = 0;
                
                if (window.offersData) {
                    window.offersData.forEach(offer => {
                        if (offer.total_members) totalMembers += parseInt(offer.total_members) || 0;
                        if (offer.status === 'pending_signature') pendingCount++;
                    });
                }
                
                // Animate number updates
                if (statsClients) animateNumber(statsClients, clientCount);
                if (statsOffers) animateNumber(statsOffers, offerCount);
                if (statsContracts) animateNumber(statsContracts, contractCount);
                if (statsMembers) animateNumber(statsMembers, totalMembers > 0 ? totalMembers.toLocaleString() : '--');
                if (statsPending) animateNumber(statsPending, pendingCount);
                
                // Show notification badge if pending offers
                if (offersNotif && pendingCount > 0) {
                    offersNotif.textContent = pendingCount;
                    offersNotif.style.display = 'block';
                } else if (offersNotif) {
                    offersNotif.style.display = 'none';
                }
                
                // Update user info
                const userName = document.getElementById('dashboardUserName');
                const userAvatar = document.getElementById('dashboardUserAvatar');
                if (currentUser && userName) {
                    userName.textContent = 'Welcome, ' + (currentUser.name || currentUser.username || 'Admin');
                }
                if (currentUser && userAvatar) {
                    userAvatar.textContent = (currentUser.name || currentUser.username || 'A').charAt(0).toUpperCase();
                }
                
            } catch (err) {
                console.error('Error updating dashboard stats:', err);
            }
        }
        
        // Animate number display
        function animateNumber(element, targetValue) {
            if (!element) return;
            
            if (typeof targetValue === 'string' && targetValue.includes('--')) {
                element.textContent = targetValue;
                return;
            }
            
            const numericValue = typeof targetValue === 'string' ? 
                parseInt(targetValue.replace(/,/g, '')) : targetValue;
            
            if (isNaN(numericValue)) {
                element.textContent = targetValue;
                return;
            }
            
            let current = 0;
            const increment = Math.ceil(numericValue / 30);
            const timer = setInterval(() => {
                current += increment;
                if (current >= numericValue) {
                    current = numericValue;
                    clearInterval(timer);
                }
                element.textContent = current.toLocaleString();
            }, 30);
        }
        
        // Modified showDashboard to use new flow
        async function showDashboardNew() {
            // Start with welcome screen
            showWelcomeScreen();
            
            // Preload data in background
            try {
                await preloadAllDataWithProgress();
                await loadClientsFromAPI();
                populateClientSelector();
                loadDataForSelectedQuarters();
            } catch (e) {
                console.error('Error preloading data:', e);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Check for existing session
            const savedUser = localStorage.getItem('polaris_admin_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    if (currentUser && currentUser.role === 'admin') {
                        // Use new welcome flow
                        document.getElementById('welcomeLoadingScreen').classList.remove('hidden');
                        document.getElementById('loginModal').classList.add('hidden');
                        initWelcomeScreen();
                        
                        // Preload data then show dashboard
                        (async () => {
                            try {
                                await preloadAllDataWithProgress();
                                await loadClientsFromAPI();
                                populateClientSelector();
                                loadDataForSelectedQuarters();
                            } catch (e) {
                                console.error('Preload error:', e);
                            }
                            
                            // Transition to main dashboard
                            setTimeout(() => {
                                transitionToMainDashboard();
                            }, 3000);
                        })();
                        return;
                    }
                } catch (e) {
                    localStorage.removeItem('polaris_admin_user');
                }
            }
            // Show login modal
            document.getElementById('welcomeLoadingScreen').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('hidden');
            
            // Allow Enter key to submit
            document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            document.getElementById('loginUsername').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') document.getElementById('loginPassword').focus();
            });
            
            // Handle responsive charts on mobile
            handleResponsiveCharts();
            window.addEventListener('resize', debounce(handleResponsiveCharts, 250));
        });
        
        // Make charts scrollable on mobile
        function handleResponsiveCharts() {
            const isMobile = window.innerWidth <= 767;
            const chartCards = document.querySelectorAll('.chart-card');
            
            chartCards.forEach(card => {
                const canvas = card.querySelector('canvas');
                if (!canvas) return;
                
                // Get Chart.js instance if exists
                const chartInstance = Chart.getChart(canvas);
                const chartType = chartInstance ? chartInstance.config.type : '';
                
                if (isMobile) {
                    // Bar charts and horizontal bar charts need scroll
                    const needsScroll = chartType === 'bar' || 
                                       card.classList.contains('wide') || 
                                       card.classList.contains('full');
                    
                    if (needsScroll) {
                        card.classList.add('scrollable');
                        card.style.overflowX = 'auto';
                        card.style.webkitOverflowScrolling = 'touch';
                        // Set minimum width based on number of data points
                        const dataLength = chartInstance?.data?.labels?.length || 0;
                        const minWidth = Math.max(450, dataLength * 50);
                        canvas.style.minWidth = minWidth + 'px';
                        canvas.style.height = '250px';
                    } else {
                        // Pie, doughnut, line charts stay at 100%
                        card.classList.remove('scrollable');
                        card.style.overflowX = '';
                        canvas.style.minWidth = '100%';
                        canvas.style.height = '';
                    }
                } else {
                    card.classList.remove('scrollable');
                    card.style.overflowX = '';
                    canvas.style.minWidth = '';
                    canvas.style.height = '';
                }
            });
        }
        
        // Call after charts are rendered
        function onChartsRendered() {
            setTimeout(handleResponsiveCharts, 100);
        }
        
        // Debounce helper
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ═══════════════════════════════════════════════════════════════════════
        // CONTRACT CENTER FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════════
        let allContractsData = [];
        let currentContractDetails = null;
        
        // Check if running in Google Apps Script environment
        const isGoogleAppsScript = typeof google !== 'undefined' && google.script && google.script.run;
        
        // Web App API URL for Vercel deployment
        const CONTRACT_API_URL = API_URL;
        
        // API Helper function
        async function callContractAPI(action, params = {}) {
            const url = new URL(CONTRACT_API_URL);
            url.searchParams.append('action', action);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            
            try {
                const response = await fetch(url.toString());
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return null;
            }
        }
        
        // API helper using GET request (to avoid CORS issues with POST)
        async function postContractAPIWithCallback(action, data, callback) {
            try {
                // Convert nested data to flat structure for GET request
                let params = new URLSearchParams();
                params.append('action', action);
                
                // For createClient, flatten the clientData
                if ((action === 'createClient' || action === 'addClient') && data.clientData) {
                    params.append('client', JSON.stringify(data.clientData));
                }
                // For createContractWithDocuments, flatten the params
                else if (action === 'createContractWithDocuments' && data.params) {
                    params.append('data', JSON.stringify(data.params));
                }
                // For updateStatus
                else if (action === 'updateStatus') {
                    params.append('contractId', data.contractId || '');
                    params.append('newStatus', data.newStatus || '');
                    params.append('notes', data.notes || '');
                    params.append('updatedBy', data.updatedBy || 'System');
                }
                else {
                    params.append('data', JSON.stringify(data));
                }
                
                const url = CONTRACT_API_URL + '?' + params.toString();
                console.log('API Request:', action, url.substring(0, 200) + '...');
                
                const response = await fetch(url);
                const result = await response.json();
                
                console.log('API Response:', result);
                
                if (callback) callback(result);
                return result;
            } catch (error) {
                console.error('API Error:', error);
                if (callback) callback({ success: false, error: error.toString() });
                return { success: false, error: error.toString() };
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // CLIENT MANAGEMENT FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════════
        
        // ═══════════════════════════════════════════════════════════════════════════════
        // v26: CLIENT HIERARCHY FUNCTIONS FOR ADD CLIENT MODAL
        // ═══════════════════════════════════════════════════════════════════════════════
        
        function toggleParentClientDropdown() {
            const clientType = document.getElementById("clientType").value;
            const parentContainer = document.getElementById("parentClientContainer");
            
            if (clientType === "subsidiary") {
                parentContainer.style.display = "block";
                populateParentClientDropdown();
            } else {
                parentContainer.style.display = "none";
                document.getElementById("parentClientId").value = "";
            }
        }
        
        function populateParentClientDropdown() {
            const select = document.getElementById("parentClientId");
            const allClients = window.cachedClientsData || [];
            
            // Filter only parent clients (no parent_client_id)
            const parentClients = allClients.filter(function(c) {
                return !c.parent_client_id || c.parent_client_id === "" || c.client_type === "parent";
            });
            
            let html = "<option value=\"\">-- Select Parent Company --</option>";
            parentClients.forEach(function(c) {
                const name = c.client_name || c.name || c.client_id;
                html += "<option value=\"" + c.client_id + "\">🏛️ " + name + "</option>";
            });
            
            select.innerHTML = html;
            console.log("✅ Parent dropdown populated with", parentClients.length, "parent clients");
        }
        
        function resetClientHierarchyFields() {
            document.getElementById("clientType").value = "parent";
            document.getElementById("parentClientId").value = "";
            document.getElementById("parentClientContainer").style.display = "none";
        }
        

        function openAddClientModal() {
            document.getElementById('addClientModal').classList.remove('hidden');
            document.getElementById('addClientModal').style.display = 'flex';
            clearClientForm();
            resetClientHierarchyFields(); // Reset hierarchy fields
        }
        
        function closeAddClientModal() {
            const modal = document.getElementById('addClientModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }
        }
        
        function clearClientForm() {
            ['clientName', 'clientCountry', 'clientTIN', 'clientRegAddress', 'clientOpAddress', 'clientVAT',
             'clientContactPerson', 'clientCapacity', 'clientEmail', 'clientPhone', 'clientMobile', 'clientFax',
             'clientSignatoryName', 'clientSignatoryTitle'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('addClientStatus').innerHTML = '';
        }
        
        async function saveNewClient() {
            const clientName = document.getElementById('clientName').value.trim();
            const contactPerson = document.getElementById('clientContactPerson').value.trim();
            const email = document.getElementById('clientEmail').value.trim();
            const signatoryName = document.getElementById('clientSignatoryName').value.trim();
            const signatoryTitle = document.getElementById('clientSignatoryTitle').value.trim();
            
            // Validation
            if (!clientName) { showClientStatus('Company Name is required', 'error'); return; }
            if (!contactPerson) { showClientStatus('Contact Person is required', 'error'); return; }
            if (!email) { showClientStatus('Email is required', 'error'); return; }
            if (!signatoryName || !signatoryTitle) { showClientStatus('Signatory Name and Title are required', 'error'); return; }
            
            // Hierarchy validation
            const clientType = document.getElementById('clientType').value;
            const parentClientId = document.getElementById('parentClientId').value;
            if (clientType === 'subsidiary' && !parentClientId) {
                showClientStatus('Please select a Parent Company for this subsidiary', 'error');
                return;
            }
            
            const clientData = {
                client_name: clientName,
                country: document.getElementById('clientCountry').value.trim(),
                tin_number: document.getElementById('clientTIN').value.trim(),
                registered_address: document.getElementById('clientRegAddress').value.trim(),
                operating_address: document.getElementById('clientOpAddress').value.trim(),
                vat_number: document.getElementById('clientVAT').value.trim(),
                contact_person: contactPerson,
                contact_capacity: document.getElementById('clientCapacity').value.trim(),
                email: email,
                phone: document.getElementById('clientPhone').value.trim(),
                mobile: document.getElementById('clientMobile').value.trim(),
                fax: document.getElementById('clientFax').value.trim(),
                authorized_signatory_name: signatoryName,
                authorized_signatory_title: signatoryTitle,
                client_type: document.getElementById("clientType").value || "parent",
                parent_client_id: document.getElementById("parentClientId").value || ""
            };
            
            showClientStatus('Saving client...', 'info');
            
            if (isGoogleAppsScript) {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            showClientStatus('✅ ' + result.message, 'success');
                            loadClientsForContractDropdowns();
                            setTimeout(() => {
                                closeAddClientModal();
                                // Select the newly created client
                                document.getElementById('newContractClient').value = result.client_id;
                            }, 1500);
                        } else {
                            showClientStatus('Error: ' + result.error, 'error');
                        }
                    })
                    .withFailureHandler(function(e) { showClientStatus('Error: ' + e.message, 'error'); })
                    .createClient(clientData);
            } else {
                // Use API call
                postContractAPIWithCallback('addClient', { clientData: clientData }, function(result) {
                    if (result && result.success) {
                        showClientStatus('✅ ' + result.message, 'success');
                        loadClientsForContractDropdowns();
                        setTimeout(() => {
                            closeAddClientModal();
                            if (result.client_id) {
                                document.getElementById('newContractClient').value = result.client_id;
                            }
                        }, 1500);
                    } else {
                        // Optimistic update - assume success if no error
                        showClientStatus('✅ Client saved. Refreshing...', 'success');
                        setTimeout(() => {
                            loadClientsForContractDropdowns();
                            closeAddClientModal();
                        }, 2000);
                    }
                });
            }
        }
        
        function showClientStatus(message, type) {
            const colors = {
                success: { bg: 'rgba(76,175,80,0.2)', text: '#4CAF50' },
                error: { bg: 'rgba(231,76,60,0.2)', text: '#e74c3c' },
                info: { bg: 'rgba(33,150,243,0.2)', text: '#2196F3' }
            };
            const style = colors[type] || colors.info;
            document.getElementById('addClientStatus').innerHTML = 
                `<div style="background:${style.bg};color:${style.text};padding:0.75rem;border-radius:8px;text-align:center;">${message}</div>`;
        }
        
        // Update First Warning Amount when Fund changes
        function updateFirstWarning() {
            const fund = parseFloat(document.getElementById('finFund').value) || 0;
            document.getElementById('finFirstWarning').value = (fund * 0.6).toFixed(2);
        }

        function openContractCenter() {
            document.getElementById('contractCenterModal').classList.remove('hidden');
            document.getElementById('dashboardBtn').style.display = 'flex';
            document.getElementById('mainDashboardBtn').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            loadContractStats(); 
            loadContracts(); 
            loadClientsForContractDropdowns(); 
            loadContractTemplatesLinks(); 
            switchContractTab('list');
            // Hide client folder view, show main view
            document.getElementById('clientFolderView').classList.remove('active');
            document.getElementById('contractMainView').style.display = 'block';
        }
        function closeContractCenter() { 
            document.getElementById('contractCenterModal').classList.add('hidden');
            document.body.style.overflow = '';
        }
        
        // Refresh contracts data
        async function refreshContractsData() {
            const btn = event.target;
            btn.innerHTML = '⏳ Loading...';
            btn.disabled = true;
            await loadContracts();
            await loadContractStats();
            btn.innerHTML = '🔄 Refresh';
            btn.disabled = false;
        }

        function switchContractTab(tabName) {
            document.querySelectorAll('.contract-tab-content').forEach(t => t.style.display = 'none');
            
            const map = {
                'list': 'contractTabList',
                'active': 'contractTabList',
                'expiring': 'contractTabList',
                'templates': 'contractTabTemplates'
            };
            
            if (map[tabName]) {
                document.getElementById(map[tabName]).style.display = 'block';
            }
            
            // Update tab buttons
            document.querySelectorAll('.contract-tab-btn').forEach(b => b.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Apply filter based on tab
            if (tabName === 'active') {
                document.getElementById('contractFilterStatus').value = 'active';
                filterContracts();
            } else if (tabName === 'expiring') {
                // Filter to show expiring contracts
                filterExpiringContracts();
            } else if (tabName === 'list') {
                clearContractFilters();
            }
            
            if(tabName==='templates') loadContractTemplatesLinks();
        }
        
        function filterExpiringContracts() {
            // Show contracts expiring in next 90 days
            const filtered = allContractsData.filter(c => {
                const expiry = new Date(c.expiry_date || c.end_date);
                const now = new Date();
                const daysUntilExpiry = Math.floor((expiry - now) / (1000 * 60 * 60 * 24));
                return daysUntilExpiry > 0 && daysUntilExpiry <= 90;
            });
            renderContractsTable(filtered);
        }
        
        function clearContractFilters() {
            document.getElementById('contractFilterStatus').value = '';
            document.getElementById('contractFilterType').value = '';
            document.getElementById('contractFilterClient').value = '';
            document.getElementById('contractFilterSearch').value = '';
            if (document.getElementById('contractFilterDate')) {
                document.getElementById('contractFilterDate').value = '';
            }
            filterContracts();
        }
        
        // ═══════════════════════════════════════════════════════════════════════════
        // CLIENT FOLDER VIEW FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════════════
        
        let currentClientFolder = null;
        
        window.openClientFolder = function(clientName, clientId) {
            currentClientFolder = { name: clientName, id: clientId };
            
            // Hide main view, show folder view
            document.getElementById('contractMainView').style.display = 'none';
            document.getElementById('clientFolderView').classList.add('active');
            
            // Set client info
            const initials = clientName.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('clientFolderAvatar').textContent = initials;
            document.getElementById('clientFolderName').innerHTML = clientName + ' <span>Portfolio</span>';
            
            // Load client data
            loadClientFolderData(clientName, clientId);
        }
        
        window.closeClientFolder = function() {
            document.getElementById('clientFolderView').classList.remove('active');
            document.getElementById('contractMainView').style.display = 'block';
            currentClientFolder = null;
        }
        
        async function loadClientFolderData(clientName, clientId) {
            // Try to load from cached data or API
            const client = (window.cachedClientsData || []).find(c => c.client_name === clientName || c.client_id === clientId || c.id === clientId);
            
            if (client) {
                // Populate quick stats from cached client data
                document.getElementById('cfStatMembers').textContent = (client.total_members || client.member_count || 0).toLocaleString();
                document.getElementById('cfStatClaims').textContent = (client.total_claims || 0).toLocaleString();
                document.getElementById('cfStatApproved').textContent = '$' + (client.approved_amount || 0).toLocaleString();
                document.getElementById('cfStatUtilization').textContent = (client.utilization || 0) + '%';
                document.getElementById('cfStatCostPerMember').textContent = '$' + (client.cost_per_member || 0).toLocaleString();
                
                // Update header meta
                document.getElementById('clientFolderSince').textContent = client.start_year || '2020';
                document.getElementById('clientFolderMembers').textContent = (client.total_members || client.member_count || 0).toLocaleString();
                
                // Financial data
                document.getElementById('cfTotalPremium').textContent = '$' + (client.total_premium || 0).toLocaleString();
                document.getElementById('cfTotalClaims').textContent = '$' + (client.total_claims_amount || 0).toLocaleString();
                document.getElementById('cfAdminFees').textContent = '$' + (client.admin_fees || 0).toLocaleString();
                document.getElementById('cfLossRatio').textContent = (client.loss_ratio || 0) + '%';
                
                // Calculate and update Client Financial KPIs (Cyprus Tax View)
                updateClientFinancialKPIs(client);
            }
            
            // ══════════════════════════════════════════════════════════════
            // NEW: Load detailed analytics from FinancialData sheet via API
            // ══════════════════════════════════════════════════════════════
            try {
                await populateClientFolderWithRealData(clientId || clientName);
            } catch (err) {
                console.warn('Could not load client analytics:', err);
            }
            
            // Load contracts for this client
            loadClientContracts(clientName);
        }
        
        // Calculate Client-specific Financial KPIs for Cyprus Tax View
        function updateClientFinancialKPIs(client) {
            const members = client.total_members || client.member_count || 0;
            const claimsAmount = client.approved_amount || client.total_claims_amount || 0;
            
            // Revenue from this client (TPA model)
            const adminFeePerMember = 12; // $12/member/month
            const adminFeeRevenue = members * adminFeePerMember * 12; // Annual
            const premiumRevenue = claimsAmount * 1.35; // Claims + 35% margin
            const otherFees = claimsAmount * 0.13; // Stop-loss + network + processing
            const clientRevenue = premiumRevenue + adminFeeRevenue + otherFees;
            
            // Expenses for this client
            const clientExpenses = claimsAmount + (claimsAmount * 0.12); // Claims + provider costs
            
            // Profit from this client
            const clientProfit = clientRevenue - clientExpenses;
            
            // Tax contribution (Cyprus 12.5%)
            const clientTax = Math.max(0, clientProfit * 0.125);
            
            // Key Ratios
            const lossRatio = premiumRevenue > 0 ? (claimsAmount / premiumRevenue * 100) : 0;
            const grossMargin = clientRevenue > 0 ? (clientProfit / clientRevenue * 100) : 0;
            const arpm = members > 0 ? (clientRevenue / members / 12) : 0; // Monthly
            const cpm = members > 0 ? (claimsAmount / members) : 0; // Cost per member
            
            // Calculate revenue share (% of total company revenue)
            // Use current dashboard data for comparison
            const totalCompanyRevenue = parseFloat(document.getElementById('ceoGrossRevenue')?.textContent?.replace(/[$,]/g, '') || 0);
            const revenueShare = totalCompanyRevenue > 0 ? (clientRevenue / totalCompanyRevenue * 100) : 0;
            
            // Update UI
            document.getElementById('cfClientRevenue').textContent = '$' + Math.round(clientRevenue).toLocaleString();
            document.getElementById('cfClientExpenses').textContent = '$' + Math.round(clientExpenses).toLocaleString();
            document.getElementById('cfClientProfit').textContent = '$' + Math.round(clientProfit).toLocaleString();
            document.getElementById('cfClientTax').textContent = '$' + Math.round(clientTax).toLocaleString();
            
            // Update ratios
            document.getElementById('cfClientLossRatio').textContent = lossRatio.toFixed(0) + '%';
            document.getElementById('cfClientMargin').textContent = grossMargin.toFixed(0) + '%';
            document.getElementById('cfClientARPM').textContent = '$' + arpm.toFixed(0);
            document.getElementById('cfClientCPM').textContent = '$' + cpm.toFixed(0);
            document.getElementById('cfClientShare').textContent = revenueShare.toFixed(1) + '%';
            
            // Color-code ratios based on performance
            const lossRatioEl = document.getElementById('cfClientLossRatio');
            lossRatioEl.style.color = lossRatio <= 65 ? '#27ae60' : lossRatio <= 75 ? '#f39c12' : '#e74c3c';
            
            const marginEl = document.getElementById('cfClientMargin');
            marginEl.style.color = grossMargin >= 30 ? '#27ae60' : grossMargin >= 20 ? '#f39c12' : '#e74c3c';
            
            // Update CFO Note based on performance
            const cfoNote = document.getElementById('cfClientCFONote');
            let noteText = '';
            
            if (lossRatio <= 65 && grossMargin >= 30) {
                noteText = '✅ This client is highly profitable with excellent loss ratio (' + lossRatio.toFixed(0) + '%) and strong margin (' + grossMargin.toFixed(0) + '%). Consider for premium retention program.';
            } else if (lossRatio <= 75 && grossMargin >= 20) {
                noteText = '👍 This client performs within acceptable parameters. Loss ratio at ' + lossRatio.toFixed(0) + '%. Review claims trends for optimization opportunities.';
            } else if (lossRatio > 75) {
                noteText = '⚠️ High loss ratio (' + lossRatio.toFixed(0) + '%) requires attention. Consider premium adjustment or claims review meeting with client.';
            } else {
                noteText = '📊 Client contributes ' + revenueShare.toFixed(1) + '% of total revenue. ARPM of $' + arpm.toFixed(0) + ' is ' + (arpm >= 45 ? 'above' : 'below') + ' company average.';
            }
            
            if (revenueShare >= 10) {
                noteText += ' ⭐ Key account - represents significant revenue share.';
            }
            
            cfoNote.textContent = noteText;
        }
        
        function loadClientContracts(clientName) {
            const container = document.getElementById('cfContractsList');
            const clientContracts = allContractsData.filter(c => 
                (c.client_name || '').toLowerCase() === clientName.toLowerCase()
            );
            
            document.getElementById('clientFolderContracts').textContent = clientContracts.length;
            
            if (clientContracts.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:2rem; color:rgba(255,255,255,0.5);">No contracts found for this client</div>';
                return;
            }
            
            container.innerHTML = clientContracts.map(c => {
                const typeClass = (c.doc_type || 'ASA').toUpperCase();
                const statusClass = (c.status || 'draft').toLowerCase();
                return `
                    <div class="client-contract-item">
                        <div class="client-contract-info">
                            <span class="contract-type ${typeClass}">${typeClass}</span>
                            <div class="client-contract-details">
                                <h4>${c.doc_type || 'Contract'} - v${c.version || '1.0'}</h4>
                                <span>Created: ${c.created_date || 'N/A'} • Status: ${c.status || 'Draft'}</span>
                            </div>
                        </div>
                        <div class="contract-actions">
                            ${c.document_url ? `<a href="${c.document_url}" target="_blank" class="contract-action-btn view">📄 View</a>` : ''}
                            ${c.folder_url ? `<a href="${c.folder_url}" target="_blank" class="contract-action-btn folder">📁 Folder</a>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function openClientGoogleFolder() {
            if (currentClientFolder) {
                // Try to find folder URL from client data
                const client = (window.cachedClientsData || []).find(c => c.client_name === currentClientFolder.name);
                if (client && client.folder_url) {
                    window.open(client.folder_url, '_blank');
                } else {
                    alert('Folder URL not found for this client');
                }
            }
        }
        
        function emailClient() {
            if (currentClientFolder) {
                closeContractCenter();
                setTimeout(() => {
                    openEmailCenter();
                    // Pre-select client
                    const clientSelect = document.getElementById('emailClient');
                    if (clientSelect) {
                        for (let option of clientSelect.options) {
                            if (option.text.includes(currentClientFolder.name)) {
                                clientSelect.value = option.value;
                                break;
                            }
                        }
                    }
                }, 300);
            }
        }
        
        function createNewContractForClient() {
            if (currentClientFolder) {
                alert('Create new contract for: ' + currentClientFolder.name);
                // TODO: Open contract creation form pre-filled with client
            }
        }
        function toggleFinancialTerms() { 
            const box = document.getElementById('financialTermsBox');
            const checkbox = document.getElementById('newContractASA');
            if (box && checkbox) box.style.display = checkbox.checked ? 'block' : 'none'; 
        }

        // Load documents from DocumentVersions sheet
        async function loadDocumentVersions() {
            const tbody = document.getElementById('contractTableBody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--text-muted);">Loading documents...</td></tr>';
            
            try {
                const response = await fetch(API_URL + '?action=getDocumentVersions');
                const result = await response.json();
                
                if (result.success && result.data) {
                    allContractsData = result.data;
                    updateContractStats(result.data);
                    renderDocumentsTable(result.data);
                } else {
                    // Fallback to old contracts method
                    loadContracts();
                }
            } catch (error) {
                console.error('Error loading documents:', error);
                loadContracts();
            }
        }
        
        function updateContractStats(docs) {
            const total = docs.length;
            const byType = { ASA: 0, NDA: 0, DPA: 0 };
            docs.forEach(d => {
                const type = (d.doc_type || '').toUpperCase();
                if (byType[type] !== undefined) byType[type]++;
            });
            
            document.getElementById('contractStatTotal').textContent = total;
            document.getElementById('contractStatActive').textContent = byType.ASA || 0;
            document.getElementById('contractStatPending').textContent = byType.NDA || 0;
            document.getElementById('contractStatExpiring').textContent = byType.DPA || 0;
            
            // Update labels
            document.querySelector('#contractStatActive').closest('.contract-stat-card').querySelector('.contract-stat-label').textContent = 'ASA';
            document.querySelector('#contractStatPending').closest('.contract-stat-card').querySelector('.contract-stat-label').textContent = 'NDA';
            document.querySelector('#contractStatExpiring').closest('.contract-stat-card').querySelector('.contract-stat-label').textContent = 'DPA';
        }
        
        function renderDocumentsTable(docs) {
            const tbody = document.getElementById('contractTableBody');
            if (!docs || docs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:rgba(255,255,255,0.5);">No documents found. Create documents from Offers Center.</td></tr>';
                return;
            }
            
            // Update result count
            const countEl = document.getElementById('contractResultCount');
            if (countEl) countEl.textContent = `Showing ${docs.length} contracts`;
            
            tbody.innerHTML = docs.map(d => {
                // Format date
                const dateStr = d.created_at ? formatContractDate(d.created_at) : '-';
                // Client name
                const clientName = d.client_name || d.client_id || '-';
                const clientInitials = clientName.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
                // Doc type
                const docType = (d.doc_type || '').toUpperCase();
                // Status
                const status = (d.status || 'active').toLowerCase();
                // Folder URL
                const folderUrl = d.folder_url || '#';
                // Expiry
                const expiryDate = d.expiry_date || d.end_date || '-';
                
                return `<tr onclick="openClientFolder('${clientName.replace(/'/g, "\\'")}', '${d.client_id || ''}')" style="cursor:pointer;">
                    <td>
                        <div class="contract-client-info">
                            <div class="contract-client-avatar">${clientInitials}</div>
                            <div>
                                <div class="contract-client-name">${clientName}</div>
                                <div class="contract-client-company">${d.doc_id || 'ID: N/A'}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="contract-type ${docType}">${docType}</span></td>
                    <td><span class="contract-status ${status}">${status}</span></td>
                    <td style="text-align:center;font-weight:600;">v${d.version || 1}</td>
                    <td>${dateStr}</td>
                    <td>${expiryDate !== '-' ? formatContractDate(expiryDate) : '-'}</td>
                    <td onclick="event.stopPropagation();">
                        <div class="contract-actions">
                            ${d.drive_url ? `<a href="${d.drive_url}" target="_blank" class="contract-action-btn view">📄 Doc</a>` : ''}
                            <button onclick="event.stopPropagation(); openClientFolder('${clientName.replace(/'/g, "\\'")}', '${d.client_id || ''}')" class="contract-action-btn folder">📁 Folder</button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }
        
        // Load templates with direct links
        function loadContractTemplatesLinks() {
            const container = document.getElementById('templatesListContainer');
            container.innerHTML = `
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;">
                    <div style="background:var(--bg-dark);border:1px solid var(--border-color);border-radius:12px;padding:1.5rem;text-align:center;">
                        <div style="font-size:2.5rem;margin-bottom:0.5rem;">📜</div>
                        <h4 style="color:var(--polaris-gold);margin-bottom:0.5rem;">NDA Template</h4>
                        <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1rem;">Non-Disclosure Agreement</p>
                        <a href="https://docs.google.com/document/d/1LFFNuLnqzn8Tr9Cvdlh6bcVIlqSOhVZTMbXNWXr7Dbs/edit" target="_blank" 
                           style="display:inline-block;padding:0.5rem 1rem;background:#e67e22;color:white;border-radius:6px;text-decoration:none;font-size:0.85rem;">
                            📝 Edit Template
                        </a>
                    </div>
                    <div style="background:var(--bg-dark);border:1px solid var(--border-color);border-radius:12px;padding:1.5rem;text-align:center;">
                        <div style="font-size:2.5rem;margin-bottom:0.5rem;">🔒</div>
                        <h4 style="color:var(--polaris-gold);margin-bottom:0.5rem;">DPA Template</h4>
                        <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1rem;">Data Processing Agreement</p>
                        <a href="https://docs.google.com/document/d/1zDcYgk-ffAMY0A7dQrqy0ip6Oz8KKEtMqCXfhbCh1Q8/edit" target="_blank" 
                           style="display:inline-block;padding:0.5rem 1rem;background:#9b59b6;color:white;border-radius:6px;text-decoration:none;font-size:0.85rem;">
                            📝 Edit Template
                        </a>
                    </div>
                    <div style="background:var(--bg-dark);border:1px solid var(--border-color);border-radius:12px;padding:1.5rem;text-align:center;">
                        <div style="font-size:2.5rem;margin-bottom:0.5rem;">📋</div>
                        <h4 style="color:var(--polaris-gold);margin-bottom:0.5rem;">ASA Template</h4>
                        <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1rem;">Administrative Services Agreement</p>
                        <a href="https://docs.google.com/document/d/1sAi4lPlEzjUmXoclDgtLXMifQAfkA8Mhvg8njqE8A_A/edit" target="_blank" 
                           style="display:inline-block;padding:0.5rem 1rem;background:#27ae60;color:white;border-radius:6px;text-decoration:none;font-size:0.85rem;">
                            📝 Edit Template
                        </a>
                    </div>
                </div>
                <div style="margin-top:1.5rem;padding:1rem;background:rgba(212,175,55,0.1);border:1px solid var(--polaris-gold);border-radius:8px;">
                    <p style="color:var(--text-secondary);margin:0;font-size:0.9rem;">
                        💡 <strong>Tip:</strong> Use placeholders like <code style="background:var(--bg-dark);padding:0.2rem 0.5rem;border-radius:4px;">{{CLIENT_NAME}}</code>, 
                        <code style="background:var(--bg-dark);padding:0.2rem 0.5rem;border-radius:4px;">{{EFFECTIVE_DATE}}</code> in templates. 
                        They will be automatically replaced when generating documents.
                    </p>
                </div>
            `;
        }

        async function loadContractStats() {
            if (isGoogleAppsScript) {
                google.script.run.withSuccessHandler(function(s) {
                    // Update new KPI elements
                    const total = s.total || 0;
                    const active = s.byStatus?.active || 0;
                    const signed = s.byStatus?.signed || 0;
                    const sent = s.byStatus?.sent || 0;
                    const draft = s.byStatus?.draft || 0;
                    const expiring = s.expiringSoon || 0;
                    
                    // New KPI grid
                    if (document.getElementById('contractKpiTotal')) document.getElementById('contractKpiTotal').textContent = total;
                    if (document.getElementById('contractKpiActive')) document.getElementById('contractKpiActive').textContent = active;
                    if (document.getElementById('contractKpiSigned')) document.getElementById('contractKpiSigned').textContent = signed;
                    if (document.getElementById('contractKpiSent')) document.getElementById('contractKpiSent').textContent = sent;
                    if (document.getElementById('contractKpiDraft')) document.getElementById('contractKpiDraft').textContent = draft;
                    if (document.getElementById('contractKpiExpiring')) document.getElementById('contractKpiExpiring').textContent = expiring;
                    
                    // Badges
                    if (document.getElementById('activeContractsBadge')) document.getElementById('activeContractsBadge').textContent = active;
                    if (document.getElementById('expiringContractsBadge')) document.getElementById('expiringContractsBadge').textContent = expiring;
                }).withFailureHandler(function(e){console.error(e);}).getContractDashboardStats();
            } else {
                // Use Web App API
                try {
                    const response = await fetch(`${API_URL}?action=getContractStats`);
                    const result = await response.json();
                    if (result.success && result.data) {
                        const stats = result.data;
                        
                        // New KPI grid
                        if (document.getElementById('contractKpiTotal')) document.getElementById('contractKpiTotal').textContent = stats.total || 0;
                        if (document.getElementById('contractKpiActive')) document.getElementById('contractKpiActive').textContent = stats.active || 0;
                        if (document.getElementById('contractKpiSigned')) document.getElementById('contractKpiSigned').textContent = stats.signed || 0;
                        if (document.getElementById('contractKpiSent')) document.getElementById('contractKpiSent').textContent = stats.sent || 0;
                        if (document.getElementById('contractKpiDraft')) document.getElementById('contractKpiDraft').textContent = stats.draft || 0;
                        if (document.getElementById('contractKpiExpiring')) document.getElementById('contractKpiExpiring').textContent = stats.expiring_soon || 0;
                        
                        // Badges
                        if (document.getElementById('activeContractsBadge')) document.getElementById('activeContractsBadge').textContent = stats.active || 0;
                        if (document.getElementById('expiringContractsBadge')) document.getElementById('expiringContractsBadge').textContent = stats.expiring_soon || 0;
                    }
                } catch (e) {
                    console.error('Error loading stats:', e);
                }
            }
        }
        async function loadContracts() {
            const tbody = document.getElementById('contractTableBody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted);">Loading...</td></tr>';
            
            try {
                // Load BOTH contracts AND all clients
                const [contractsResponse, clientsResponse] = await Promise.all([
                    fetch(`${API_URL}?action=getContracts`),
                    fetch(`${API_URL}?action=getClients`)
                ]);
                
                const contractsResult = await contractsResponse.json();
                const clientsResult = await clientsResponse.json();
                
                const contracts = contractsResult.data || contractsResult || [];
                const clients = clientsResult.data || clientsResult || [];
                
                console.log('📋 Contracts loaded:', contracts.length, contracts);
                console.log('👥 Clients loaded:', clients.length, clients);
                
                // Create a map of client_id to their contracts
                const clientContractsMap = {};
                contracts.forEach(c => {
                    const clientId = c.client_id;
                    if (clientId) {
                        if (!clientContractsMap[clientId]) {
                            clientContractsMap[clientId] = [];
                        }
                        clientContractsMap[clientId].push(c);
                    }
                });
                
                console.log('📋 Client-Contract mapping:', clientContractsMap);
                
                // Build combined list: all clients with their contract status
                const combinedList = [];
                
                clients.forEach(client => {
                    const clientId = client.client_id || client.id;
                    const clientName = client.client_name || client.contact_name || client.name || 'Unknown';
                    const clientContracts = clientContractsMap[clientId] || [];
                    
                    console.log(`  Client ${clientId} (${clientName}): ${clientContracts.length} contracts`);
                    
                    if (clientContracts.length > 0) {
                        // Client has contracts - add each contract
                        clientContracts.forEach(contract => {
                            combinedList.push({
                                ...contract,
                                client_id: clientId,
                                client_name: clientName,
                                has_contract: true,
                                sort_priority: getContractPriority(contract.status)
                            });
                        });
                    } else {
                        // Client has NO contract - add as "No Contract"
                        // But check if they have contract dates in the client record
                        const hasContractDates = client.contract_start || client.contract_end;
                        if (hasContractDates) {
                            // Client has contract info in their record
                            combinedList.push({
                                contract_id: `CON-${clientId}`,
                                client_id: clientId,
                                client_name: clientName,
                                doc_type: 'Service Agreement',
                                status: client.status || 'Active',
                                version: '1',
                                effective_date: client.contract_start,
                                expiry_date: client.contract_end,
                                has_contract: true,
                                sort_priority: getContractPriority(client.status || 'Active')
                            });
                        } else {
                            // Client truly has no contract
                            combinedList.push({
                                contract_id: '-',
                                client_id: clientId,
                                client_name: clientName,
                                doc_type: '-',
                                status: 'No Contract',
                                version: '-',
                                effective_date: null,
                                expiry_date: null,
                                has_contract: false,
                                sort_priority: 99
                            });
                        }
                    }
                });
                
                // Sort by priority: Active first, then Signed, then Pending, then No Contract
                combinedList.sort((a, b) => a.sort_priority - b.sort_priority);
                
                console.log('📋 Combined list:', combinedList);
                
                allContractsData = combinedList;
                renderContractsTable(combinedList);
                
            } catch (e) {
                console.error('Error loading contracts:', e);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#e74c3c;">Error loading contracts</td></tr>';
            }
        }
        
        // Get priority for sorting (lower = higher priority)
        function getContractPriority(status) {
            const s = (status || '').toLowerCase();
            if (s === 'active' || s === 'running') return 1;
            if (s === 'signed' || s === 'completed') return 2;
            if (s === 'sent' || s === 'pending signature') return 3;
            if (s === 'draft') return 4;
            if (s === 'expired') return 5;
            return 10;
        }
        
        function renderContractsTable(contracts) {
            const tbody = document.getElementById('contractTableBody');
            if(!contracts||contracts.length===0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted);">No contracts found</td></tr>'; return; }
            
            tbody.innerHTML = contracts.map(c => {
                const statusClass = getStatusClass(c.status);
                const needsContract = c.status === 'No Contract';
                const hasContract = c.has_contract && c.contract_id && c.contract_id !== '-';
                
                return `<tr style="${needsContract ? 'background: rgba(231,76,60,0.1);' : ''}">
                <td>
                    <a href="javascript:void(0)" onclick="window.selectClientFromContract('${c.client_id}', '${(c.client_name || '').replace(/'/g, "\\'")}');" 
                       style="color:var(--polaris-gold);text-decoration:none;font-weight:600;cursor:pointer;" 
                       title="Click to view ${c.client_name} KPIs">
                        ${c.client_name || '-'}
                    </a>
                </td>
                <td><span class="contract-type ${(c.doc_type||'').toLowerCase()}">${c.doc_type || '-'}</span></td>
                <td><span class="contract-status ${statusClass}">${c.status || '-'}</span></td>
                <td style="text-align:center;">${needsContract || !c.version || c.version === '-' ? '-' : 'v' + c.version}</td>
                <td>${formatContractDate(c.effective_date || c.start_date) || '-'}</td>
                <td>${formatContractDate(c.expiry_date || c.end_date || c.contract_end) || '-'}</td>
                <td>
                    ${needsContract ? 
                        `<button class="contract-action-btn" onclick="window.createContractForClient('${c.client_id}', '${(c.client_name || '').replace(/'/g, "\\'")}');" style="background:#27ae60;color:white;padding:0.4rem 0.8rem;border-radius:6px;border:none;cursor:pointer;font-size:0.8rem;">+ Create</button>` :
                        `<button class="contract-action-btn view" onclick="window.viewContractDetails('${c.contract_id}')" title="View Details" style="background:#3498db;color:white;padding:0.4rem 0.6rem;border-radius:6px;border:none;cursor:pointer;margin-right:4px;">👁️</button>
                        ${c.current_doc_url || c.gdrive_url ? `<a href="${c.current_doc_url || c.gdrive_url}" target="_blank" class="contract-action-btn" style="background:#27ae60;color:white;padding:0.4rem 0.6rem;border-radius:6px;text-decoration:none;display:inline-block;" title="Open Document">📄</a>` : ''}
                        ${c.gdrive_folder_url ? `<a href="${c.gdrive_folder_url}" target="_blank" class="contract-action-btn" style="background:#f39c12;color:white;padding:0.4rem 0.6rem;border-radius:6px;text-decoration:none;display:inline-block;margin-left:4px;" title="Open Folder">📁</a>` : ''}`
                    }
                </td>
            </tr>`;
            }).join('');
            
            // Update count display
            const countEl = document.getElementById('contractResultCount');
            if (countEl) {
                const withContracts = contracts.filter(c => c.has_contract).length;
                const withoutContracts = contracts.filter(c => !c.has_contract).length;
                countEl.textContent = `Showing ${contracts.length} clients (${withContracts} with contracts, ${withoutContracts} need contracts)`;
            }
        }
        
        // Select client from contract table and show their KPIs in the Client Folder View
        window.selectClientFromContract = function(clientId, clientName) {
            console.log('🔄 selectClientFromContract called:', clientId, clientName);
            
            // Call the existing openClientFolder function
            openClientFolder(clientName, clientId);
        }
        
        // Go to main dashboard with client selected
        window.goToClientDashboard = function(clientId, clientName) {
            // Close the contract modal
            const contractModal = document.getElementById('contractCenterModal');
            if (contractModal) {
                contractModal.classList.add('hidden');
            }
            
            // Update the client selector dropdown
            const selector = document.getElementById('clientSelector');
            if (selector) {
                for (let i = 0; i < selector.options.length; i++) {
                    if (selector.options[i].value === clientId) {
                        selector.selectedIndex = i;
                        break;
                    }
                }
                // Trigger the change event to update dashboard
                if (typeof handleClientChange === 'function') {
                    handleClientChange();
                }
            }
            
            console.log(`✅ Viewing full KPIs for: ${clientName}`);
        }
        
        function getStatusClass(status) {
            const s = (status || '').toLowerCase();
            if (s === 'active' || s === 'running') return 'active';
            if (s === 'signed' || s === 'completed') return 'completed';
            if (s === 'sent') return 'sent';
            if (s === 'draft') return 'draft';
            if (s === 'expired') return 'expired';
            if (s === 'no contract') return 'no-contract';
            return s;
        }
        
        // Quick create contract for client - opens Offers Center
        window.createContractForClient = function(clientId, clientName) {
            // Close Contract Center
            const contractModal = document.getElementById('contractCenterModal');
            if (contractModal) {
                contractModal.classList.add('hidden');
            }
            
            setTimeout(() => {
                openOffersCenter();
                
                // Pre-select the client in the offer form
                setTimeout(() => {
                    const clientSelect = document.getElementById('offerClientSelect');
                    if (clientSelect) {
                        for (let option of clientSelect.options) {
                            if (option.value === clientId) {
                                option.selected = true;
                                break;
                            }
                        }
                    }
                    
                    // Show alert with instructions
                    alert(`Creating offer for: ${clientName}\n\n1. Select a program/plan\n2. Enter member counts\n3. Generate the offer\n4. Create documents (NDA, DPA, ASA, Proposal)`);
                }, 500);
            }, 300);
        }

        function filterContracts() {
            let filtered = allContractsData || [];
            const status = document.getElementById('contractFilterStatus')?.value;
            const type = document.getElementById('contractFilterType')?.value;
            const client = document.getElementById('contractFilterClient')?.value;
            const search = (document.getElementById('contractFilterSearch')?.value || '').toLowerCase();
            
            if(status) {
                if (status === 'No Contract') {
                    filtered = filtered.filter(c => !c.has_contract);
                } else {
                    filtered = filtered.filter(c => c.status && c.status.toLowerCase() === status.toLowerCase());
                }
            }
            if(type) filtered = filtered.filter(c => c.doc_type === type);
            if(client) filtered = filtered.filter(c => c.client_id === client);
            if(search) filtered = filtered.filter(c => 
                (c.contract_id || c.doc_id || '').toLowerCase().includes(search) || 
                (c.client_name && c.client_name.toLowerCase().includes(search))
            );
            
            renderContractsTable(filtered);
        }

        async function loadClientsForContractDropdowns() {
            const populateDropdowns = (clients) => {
                const filterSel = document.getElementById('contractFilterClient');
                const createSel = document.getElementById('newContractClient');
                
                // Filter dropdown exists
                if (filterSel) {
                    filterSel.innerHTML = '<option value="">All Clients</option>';
                }
                
                // Create dropdown may not exist (removed New Contract tab)
                if (createSel) {
                    createSel.innerHTML = '<option value="">-- Select Client --</option>';
                }
                
                if (clients && clients.length > 0) {
                    clients.forEach(c => {
                        const displayName = c.client_name || c.contact_name || 'Unknown';
                        if (filterSel) filterSel.innerHTML += `<option value="${c.client_id}">${displayName}</option>`;
                        if (createSel) createSel.innerHTML += `<option value="${c.client_id}" data-name="${displayName}">${displayName}</option>`;
                    });
                } else {
                    // If no clients from API, get unique clients from loaded contracts
                    const uniqueClients = {};
                    allContractsData.forEach(c => {
                        if (c.client_id && c.client_name && !uniqueClients[c.client_id]) {
                            uniqueClients[c.client_id] = c.client_name;
                        }
                    });
                    Object.keys(uniqueClients).forEach(id => {
                        if (filterSel) filterSel.innerHTML += `<option value="${id}">${uniqueClients[id]}</option>`;
                        if (createSel) createSel.innerHTML += `<option value="${id}" data-name="${uniqueClients[id]}">${uniqueClients[id]}</option>`;
                    });
                }
            };
            
            if (isGoogleAppsScript) {
                google.script.run.withSuccessHandler(populateDropdowns).withFailureHandler(function(e){console.error(e);}).getClientsForContracts();
            } else {
                // Use Web App API
                const clients = await callContractAPI('getAllClients');
                populateDropdowns(clients || []);
            }
        }

        async function createNewContract() {
            const sel = document.getElementById('newContractClient');
            const clientId = sel.value;
            const clientName = sel.options[sel.selectedIndex]?.dataset?.name || sel.options[sel.selectedIndex]?.textContent;
            if(!clientId) { showContractStatus('Please select a client','error'); return; }
            const docTypes = [];
            if(document.getElementById('newContractASA').checked) docTypes.push('ASA');
            if(document.getElementById('newContractNDA').checked) docTypes.push('NDA');
            if(document.getElementById('newContractDPA').checked) docTypes.push('DPA');
            if(docTypes.length===0) { showContractStatus('Please select at least one document type','error'); return; }
            
            // Build params with all fields
            const params = {
                client_id: clientId, 
                client_name: clientName, 
                doc_types: docTypes, 
                created_by: 'Admin Dashboard',
                // Contract dates
                contract_dates: {
                    effective_date: document.getElementById('contractEffectiveDate').value || '',
                    expiry_date: document.getElementById('contractExpiryDate').value || '',
                    auto_renewal: document.getElementById('contractAutoRenewal').checked
                }
            };
            
            // Add financials if ASA is selected
            if(docTypes.includes('ASA')) {
                params.plans = {
                    gold: parseInt(document.getElementById('finGold').value) || 0,
                    platinum: parseInt(document.getElementById('finPlatinum').value) || 0,
                    diamond: parseInt(document.getElementById('finDiamond').value) || 0,
                    dental: parseInt(document.getElementById('finDentalMembers').value) || 0
                };
                params.financials = {
                    enrollment_fee: parseFloat(document.getElementById('finEnrollmentFee').value) || 0,
                    plan_management_fee: parseFloat(document.getElementById('finManagementFee').value) || 0,
                    plan_management_minimum: parseFloat(document.getElementById('finManagementMin').value) || 0,
                    claim_processing_fee: parseFloat(document.getElementById('finClaimFee').value) || 0,
                    dental_benefit_fee: parseFloat(document.getElementById('finDentalFee').value) || 0,
                    fund_amount: parseFloat(document.getElementById('finFund').value) || 0,
                    running_cost: parseFloat(document.getElementById('finRunning').value) || 0
                };
            }
            
            showContractStatus('Creating contract(s) and generating documents...','info');
            
            if (isGoogleAppsScript) {
                google.script.run.withSuccessHandler(function(result) {
                    if(result.success) {
                        showContractStatus('✅ ' + result.message,'success');
                        loadContractStats(); loadContracts();
                        resetContractForm();
                        setTimeout(()=>document.querySelector('.contract-tab').click(), 2000);
                    } else { showContractStatus('Error: '+(result.error||'Unknown error'),'error'); }
                }).withFailureHandler(function(e){showContractStatus('Error: '+e.message,'error');}).createContractWithDocuments(params);
            } else {
                // Use JSONP callback approach
                postContractAPIWithCallback('createContractWithDocuments', { params: params }, function(result) {
                    if (result && result.success) {
                        showContractStatus('✅ ' + result.message, 'success');
                        loadContractStats(); loadContracts();
                        resetContractForm();
                        setTimeout(()=>document.querySelector('.contract-tab').click(), 2000);
                    } else {
                        // Optimistic - assume it worked
                        showContractStatus(`✅ Contract creation sent for ${clientName}. Refreshing...`, 'success');
                        setTimeout(() => {
                            loadContractStats();
                            loadContracts();
                            resetContractForm();
                            document.querySelector('.contract-tab').click();
                        }, 3000);
                    }
                });
            }
        }
        
        function resetContractForm() {
            document.getElementById('newContractClient').value = '';
            document.getElementById('contractEffectiveDate').value = '';
            document.getElementById('contractExpiryDate').value = '';
            document.getElementById('contractAutoRenewal').checked = true;
            ['finGold','finPlatinum','finDiamond','finDentalMembers','finEnrollmentFee','finManagementFee',
             'finManagementMin','finClaimFee','finDentalFee','finFund','finRunning','finFirstWarning'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '0';
            });
        }

        function showContractStatus(message, type) {
            const colors = {success:{bg:'rgba(76,175,80,0.2)',text:'#4CAF50'},error:{bg:'rgba(231,76,60,0.2)',text:'#e74c3c'},info:{bg:'rgba(33,150,243,0.2)',text:'#2196F3'}};
            const style = colors[type]||colors.info;
            document.getElementById('createContractStatus').innerHTML = `<div style="background:${style.bg};color:${style.text};padding:1rem;border-radius:10px;margin-top:1rem;text-align:center;">${message}</div>`;
        }

        window.viewContractDetails = function(contractId) {
            console.log('👁️ viewContractDetails called:', contractId);
            
            // Find the contract in our data
            const contract = allContractsData.find(c => c.contract_id === contractId);
            
            if (contract) {
                const details = `
Contract Details
================
Client: ${contract.client_name || '-'}
Type: ${contract.doc_type || 'Service Agreement'}
Status: ${contract.status || '-'}
Version: v${contract.version || 1}

Dates:
- Start: ${formatContractDate(contract.effective_date || contract.contract_start) || '-'}
- Expiry: ${formatContractDate(contract.expiry_date || contract.contract_end) || '-'}

Contact: ${contract.contact_name || '-'}
Email: ${contract.contact_email || '-'}
                `.trim();
                
                alert(details);
            } else {
                alert('Contract not found: ' + contractId);
            }
        }

        function renderContractDetails(c) {
            console.log('renderContractDetails called with:', c);
            if(!c) { document.getElementById('contractInfoDetails').innerHTML = '<p style="color:#e74c3c;">Contract not found</p>'; return; }
            
            // Store for later use
            window.currentContractData = c;
            
            document.getElementById('contractDetailsTitle').textContent = `${c.doc_type || 'Contract'} - ${c.client_name || 'Unknown Client'}`;
            document.getElementById('contractInfoDetails').innerHTML = `
                <div class="contract-detail-row"><span class="contract-detail-label">Contract ID</span><span class="contract-detail-value">${c.contract_id || '-'}</span></div>
                <div class="contract-detail-row"><span class="contract-detail-label">Type</span><span class="contract-detail-value"><span class="contract-type ${c.doc_type || ''}">${c.doc_type || '-'}</span></span></div>
                <div class="contract-detail-row"><span class="contract-detail-label">Status</span><span class="contract-detail-value"><span class="contract-status ${(c.status||'').toLowerCase()}">${c.status || '-'}</span></span></div>
                <div class="contract-detail-row"><span class="contract-detail-label">Version</span><span class="contract-detail-value">v${c.version||1}</span></div>
                <div class="contract-detail-row"><span class="contract-detail-label">Created</span><span class="contract-detail-value">${formatContractDate(c.created_date) || '-'}</span></div>`;
            document.getElementById('contractDatesDetails').innerHTML = `
                <div class="contract-detail-row"><span class="contract-detail-label">Effective Date</span><span class="contract-detail-value">${formatContractDate(c.effective_date) || '-'}</span></div>
                <div class="contract-detail-row"><span class="contract-detail-label">Expiry Date</span><span class="contract-detail-value">${formatContractDate(c.expiry_date) || '-'}</span></div>
                <div class="contract-detail-row"><span class="contract-detail-label">Signed Date</span><span class="contract-detail-value">${formatContractDate(c.signed_date) || '-'}</span></div>
                <div class="contract-detail-row"><span class="contract-detail-label">Auto Renewal</span><span class="contract-detail-value">${c.auto_renewal === true || c.auto_renewal === 'TRUE' || c.auto_renewal === 'true' ? '✅ Yes' : '❌ No'}</span></div>`;
            
            if(c.financials) {
                document.getElementById('contractFinancialsSection').style.display='block';
                document.getElementById('contractFinancialsDetails').innerHTML = `<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;">
                    <div><span class="contract-detail-label">🥇 Gold</span><br><strong>${c.financials.plan_gold_members||0}</strong></div>
                    <div><span class="contract-detail-label">🥈 Platinum</span><br><strong>${c.financials.plan_platinum_members||0}</strong></div>
                    <div><span class="contract-detail-label">💎 Diamond</span><br><strong>${c.financials.plan_diamond_members||0}</strong></div>
                    <div><span class="contract-detail-label">Fund Amount</span><br><strong>$${(c.financials.fund_amount||0).toLocaleString()}</strong></div>
                    <div><span class="contract-detail-label">Running Cost</span><br><strong>$${(c.financials.running_cost_annual||0).toLocaleString()}</strong></div>
                    <div><span class="contract-detail-label">Dental</span><br><strong>${c.financials.has_dental==='TRUE'?'✅ Yes':'❌ No'}</strong></div></div>`;
            } else { document.getElementById('contractFinancialsSection').style.display='none'; }
            
            // Render Signed Documents Links
            renderContractDocumentLinks(c);
            
            if(c.history&&c.history.length>0) {
                document.getElementById('contractHistoryDetails').innerHTML = c.history.map(h=>{
                    // Make offer IDs clickable
                    let notes = h.notes || '';
                    notes = notes.replace(/(OFF-\d{4}-\d{4})/g, '<a href="#" onclick="viewOfferFromHistory(\'$1\'); return false;" style="color:#d4a843; text-decoration:underline;">$1</a>');
                    
                    return `
                    <div style="display:flex;align-items:center;gap:1rem;padding:0.75rem;background:var(--bg-dark);border-radius:8px;margin-bottom:0.5rem;">
                        <div style="width:8px;height:8px;background:var(--polaris-gold);border-radius:50%;"></div>
                        <div style="flex:1;"><div style="font-weight:500;text-transform:capitalize;">${h.action}</div><div style="font-size:0.8rem;color:var(--text-muted);">${notes}</div></div>
                        <div style="font-size:0.8rem;color:var(--text-muted);">${formatContractDate(h.action_date)}</div>
                    </div>`;
                }).join('');
            } else { document.getElementById('contractHistoryDetails').innerHTML = '<p style="color:var(--text-muted);">No history yet</p>'; }
            
            document.getElementById('contractFolderLink').href = c.gdrive_folder_url||'#';
            document.getElementById('contractFolderLink').style.display = c.gdrive_folder_url?'inline-block':'none';
            document.getElementById('contractDocLink').href = c.current_doc_url||'#';
            document.getElementById('contractDocLink').style.display = c.current_doc_url?'inline-block':'none';
            
            const actionBtn = document.getElementById('contractActionBtn');
            actionBtn.style.display = 'inline-block';
            const statusLower = (c.status || '').toLowerCase();
            switch(statusLower) {
                case 'draft': actionBtn.textContent='📤 Mark as Sent'; actionBtn.onclick=()=>updateContractStatusFromUI(c.contract_id,'Sent'); break;
                case 'sent': case 'negotiating': case 'pending': actionBtn.textContent='✍️ Mark as Signed'; actionBtn.onclick=()=>updateContractStatusFromUI(c.contract_id,'Signed'); break;
                case 'signed': actionBtn.textContent='✅ Activate'; actionBtn.onclick=()=>updateContractStatusFromUI(c.contract_id,'Active'); break;
                default: actionBtn.style.display='none';
            }
        }
        
        // Render document links for contract
        async function renderContractDocumentLinks(contract) {
            const container = document.getElementById('contractDocumentsLinks');
            const section = document.getElementById('contractDocumentsSection');
            
            // Get offer_id to fetch documents
            let offerId = contract.offer_id || contract.source_offer_id;
            
            // Fallback: try to extract from history notes
            if (!offerId && contract.history && contract.history.length > 0) {
                for (let h of contract.history) {
                    const match = (h.notes || '').match(/OFF-\d{4}-\d{4}/);
                    if (match) {
                        offerId = match[0];
                        break;
                    }
                }
            }
            
            if (!offerId) {
                // Try to get from client folder
                if (contract.gdrive_folder_url) {
                    container.innerHTML = `
                        <a href="${contract.gdrive_folder_url}" target="_blank" style="display:flex; align-items:center; gap:0.5rem; padding:0.75rem 1.25rem; background:linear-gradient(135deg, #2d5a87, #1E3A5F); border:1px solid #3498db; border-radius:10px; color:white; text-decoration:none; transition:all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='none'">
                            <span style="font-size:1.2rem;">📁</span>
                            <span>All Documents in Folder</span>
                        </a>`;
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
                return;
            }
            
            container.innerHTML = '<span style="color:#7aa0c0;">Loading documents...</span>';
            section.style.display = 'block';
            
            try {
                // Fetch documents for this offer
                const docs = await getOfferDocuments(offerId);
                
                let linksHtml = '';
                const docTypes = [
                    { key: 'nda', name: 'NDA', icon: '🔒', color: '#9b59b6' },
                    { key: 'dpa', name: 'DPA', icon: '🛡️', color: '#3498db' },
                    { key: 'asa', name: 'ASA', icon: '📋', color: '#27ae60' },
                    { key: 'proposal', name: 'Proposal', icon: '📄', color: '#d4a843' }
                ];
                
                docTypes.forEach(docType => {
                    if (docs[docType.key] && docs[docType.key].fileUrl) {
                        linksHtml += `
                            <a href="${docs[docType.key].fileUrl}" target="_blank" style="display:flex; align-items:center; gap:0.5rem; padding:0.75rem 1.25rem; background:linear-gradient(135deg, ${docType.color}33, ${docType.color}22); border:1px solid ${docType.color}; border-radius:10px; color:white; text-decoration:none; transition:all 0.3s;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 15px ${docType.color}44'" onmouseout="this.style.transform='none';this.style.boxShadow='none'">
                                <span style="font-size:1.2rem;">${docType.icon}</span>
                                <div>
                                    <div style="font-weight:600;">${docType.name}</div>
                                    <div style="font-size:0.7rem; opacity:0.7;">v${docs[docType.key].version || 1}</div>
                                </div>
                            </a>`;
                    }
                });
                
                // Add View Original Offer button at the end
                linksHtml += `
                    <button onclick="viewOfferFromContractDirect('${offerId}')" style="display:flex; align-items:center; gap:0.5rem; padding:0.75rem 1.25rem; background:linear-gradient(135deg, #1E3A5F, #2d5a87); border:2px solid #7aa0c0; border-radius:10px; color:white; cursor:pointer; transition:all 0.3s;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 15px rgba(122,160,192,0.4)';this.style.borderColor='#d4a843'" onmouseout="this.style.transform='none';this.style.boxShadow='none';this.style.borderColor='#7aa0c0'">
                        <span style="font-size:1.2rem;">👁️</span>
                        <div>
                            <div style="font-weight:600;">View Offer</div>
                            <div style="font-size:0.7rem; opacity:0.7;">${offerId}</div>
                        </div>
                    </button>`;
                
                if (linksHtml) {
                    container.innerHTML = linksHtml;
                } else {
                    container.innerHTML = '<span style="color:#7aa0c0;">No signed documents found</span>';
                }
                
            } catch (error) {
                console.error('Error loading contract documents:', error);
                container.innerHTML = '<span style="color:#e74c3c;">Error loading documents</span>';
            }
        }
        
        // View the original offer from contract
        function viewOfferFromContract() {
            const btn = document.getElementById('viewOfferFromContract');
            const offerId = btn.getAttribute('data-offer-id');
            
            if (!offerId) {
                alert('Offer ID not found');
                return;
            }
            
            // Close contract center and open offer
            closeContractCenter();
            setTimeout(() => {
                openOffersCenter();
                setTimeout(() => {
                    viewOffer(offerId);
                }, 300);
            }, 200);
        }
        
        // View offer directly with offerId parameter
        function viewOfferFromContractDirect(offerId) {
            if (!offerId) {
                alert('Offer ID not found');
                return;
            }
            
            closeContractCenter();
            setTimeout(() => {
                openOffersCenter();
                setTimeout(() => {
                    viewOffer(offerId);
                }, 300);
            }, 200);
        }
        
        // View offer from history link
        function viewOfferFromHistory(offerId) {
            if (!offerId) return;
            
            closeContractCenter();
            setTimeout(() => {
                openOffersCenter();
                setTimeout(() => {
                    viewOffer(offerId);
                }, 300);
            }, 200);
        }

        function closeContractDetails() {
            document.getElementById('contractDetailsView').style.display='none';
            document.getElementById('contractTabList').style.display='block';
            document.querySelectorAll('.contract-tab').forEach(b=>b.classList.remove('active'));
            document.querySelector('.contract-tab').classList.add('active');
        }

        async function updateContractStatusFromUI(contractId, newStatus) {
            if (isGoogleAppsScript) {
                google.script.run.withSuccessHandler(function(result) {
                    if(result.success) { loadContractStats(); loadContracts(); viewContractDetails(contractId); }
                }).withFailureHandler(function(e){console.error(e);}).updateContractStatus(contractId, newStatus, 'Updated from dashboard', 'Admin');
            } else {
                // Use Web App API - POST via form
                try {
                    const iframe = document.createElement('iframe');
                    iframe.name = 'statusApiFrame';
                    iframe.style.display = 'none';
                    document.body.appendChild(iframe);
                    
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = CONTRACT_API_URL;
                    form.target = 'statusApiFrame';
                    
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'payload';
                    input.value = JSON.stringify({ 
                        action: 'updateStatus', 
                        contractId: contractId, 
                        newStatus: newStatus,
                        notes: 'Updated from dashboard',
                        updatedBy: 'Admin'
                    });
                    form.appendChild(input);
                    
                    document.body.appendChild(form);
                    form.submit();
                    
                    setTimeout(() => {
                        document.body.removeChild(form);
                        document.body.removeChild(iframe);
                        loadContractStats();
                        loadContracts();
                        viewContractDetails(contractId);
                    }, 1500);
                } catch (error) {
                    console.error('Error updating status:', error);
                }
            }
        }

        async function loadContractTemplates() {
            const container = document.getElementById('templatesListContainer');
            container.innerHTML = '<p style="color:var(--text-muted);">Loading templates...</p>';
            
            const renderTemplates = (templates) => {
                if(!templates||templates.length===0) { container.innerHTML='<p style="color:var(--text-muted);">No templates found</p>'; return; }
                const colors = {'ASA':'#1a365d','NDA':'#7c3aed','DPA':'#0891b2'};
                container.innerHTML = templates.map(t=>`
                    <div style="background:var(--bg-dark);border:1px solid var(--border-color);border-radius:12px;padding:1rem;margin-bottom:0.75rem;display:flex;align-items:center;justify-content:space-between;">
                        <div style="display:flex;align-items:center;gap:1rem;">
                            <div style="width:50px;height:50px;background:${colors[t.template_type]||'#64748b'};border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;">${t.template_type}</div>
                            <div><div style="font-weight:600;">${t.template_name}</div><div style="font-size:0.85rem;color:var(--text-muted);">${t.description||'No description'}</div><div style="font-size:0.75rem;color:var(--text-muted);margin-top:0.25rem;">Version ${t.version}</div></div>
                        </div>
                        ${t.gdrive_file_url?`<a href="${t.gdrive_file_url}" target="_blank" class="contract-btn contract-btn-secondary" style="padding:0.5rem 1rem;text-decoration:none;">📥 Download</a>`:'<span style="color:var(--text-muted);font-size:0.85rem;">No file uploaded</span>'}
                    </div>`).join('');
            };
            
            if (isGoogleAppsScript) {
                google.script.run.withSuccessHandler(renderTemplates).withFailureHandler(function(e){container.innerHTML='<p style="color:#e74c3c;">Error loading templates</p>';}).getActiveContractTemplates();
            } else {
                // Use Web App API
                const templates = await callContractAPI('getTemplates');
                renderTemplates(templates || []);
            }
        }

        function formatContractDate(dateValue) {
            if(!dateValue) return '-';
            const date = new Date(dateValue);
            if(isNaN(date.getTime())) return '-';
            return date.toLocaleDateString('en-GB', {day:'2-digit',month:'2-digit',year:'numeric'});
        }

        // ═══════════════════════════════════════════════════════════════════════════
        // OFFERS MODULE - POLARIS V4 INTERFACE
        // ═══════════════════════════════════════════════════════════════════════════
        
        // Use window.offersData for global access (needed for navigation arrows)
        window.offersData = window.offersData || [];
        let offersData = window.offersData; // Local reference for convenience
        let currentOfferTier = 1;
        let customPlans = JSON.parse(localStorage.getItem('polarisCustomPlans') || '[]');
        const DENTAL_FEE = 9.50;
        
        // Standard Plans Data (will be replaced by API data if available)
        // PROGRAMS - Loaded from database (Programs sheet)
        let OFFER_PROGRAMS = {};
        let programsLoaded = false;
        
        // Load programs from database
        async function loadProgramsFromDB() {
            try {
                console.log('Loading programs from database...');
                const response = await fetch(API_URL + '?action=getPrograms');
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    OFFER_PROGRAMS = {};
                    result.data.forEach(prog => {
                        // Skip inactive programs
                        if (prog.is_active === false || prog.is_active === 0 || prog.is_active === 'false') {
                            return;
                        }
                        // Map API fields to expected format
                        const programId = prog.program_id || prog.id;
                        OFFER_PROGRAMS[programId] = {
                            id: programId,
                            name: prog.program_name || prog.name || programId,
                            displayName: prog.program_display_name || prog.displayName || ('POLARIS ' + (prog.program_name || prog.name || '').toUpperCase()),
                            limits: prog.limits_display || prog.limits || '',
                            mbl: parseInt(prog.mbl_php) || parseInt(prog.mbl) || 0,
                            opbl: parseInt(prog.opbl_php) || parseInt(prog.opbl) || 0,
                            reg: parseFloat(prog.reg_fee_usd) || parseFloat(prog.reg) || 0,
                            fund: [
                                parseFloat(prog.fund_deposit_tier1) || 0,
                                parseFloat(prog.fund_deposit_tier2) || 0,
                                parseFloat(prog.fund_deposit_tier3) || 0,
                                parseFloat(prog.fund_deposit_tier4) || 0
                            ],
                            color: prog.color_code || prog.color || '#1e3a5f',
                            roomType: prog.room_type || prog.roomType || 'Ward',
                            dentalFee: parseFloat(prog.dental_fee_usd) || parseFloat(prog.dentalFee) || 9.5,
                            mgmtFee: parseFloat(prog.management_fee_monthly) || parseFloat(prog.mgmtFee) || 0.75,
                            claimPct: parseFloat(prog.claim_processing_pct) || parseFloat(prog.claimPct) || 15,
                            description: prog.description || ''
                        };
                    });
                    programsLoaded = true;
                    window.OFFER_PROGRAMS = OFFER_PROGRAMS; // Make available globally
                    console.log('✅ Loaded ' + result.data.length + ' programs from database');
                    return true;
                } else {
                    console.warn('⚠️ Could not load programs from DB, using defaults');
                    loadDefaultPrograms();
                    return false;
                }
            } catch (error) {
                console.error('Error loading programs:', error);
                loadDefaultPrograms();
                return false;
            }
        }
        
        // Fallback default programs (in case DB fails)
        function loadDefaultPrograms() {
            OFFER_PROGRAMS = {
                bronze: { id: 'bronze', name: 'Bronze', displayName: 'POLARIS BRONZE', limits: '30/15', mbl: 30000, opbl: 15000, reg: 20, fund: [15, 14, 13, 12], color: '#8B4513' },
                silver: { id: 'silver', name: 'Silver', displayName: 'POLARIS SILVER', limits: '40/20', mbl: 40000, opbl: 20000, reg: 24, fund: [20, 18, 16, 14], color: '#6c757d' },
                gold: { id: 'gold', name: 'Gold', displayName: 'POLARIS GOLD', limits: '80/40', mbl: 80000, opbl: 40000, reg: 24, fund: [45, 42, 39, 36], color: '#d4a843' },
                gold_plus: { id: 'gold_plus', name: 'Gold+', displayName: 'POLARIS GOLD+', limits: '100/40', mbl: 100000, opbl: 40000, reg: 24, fund: [50, 47, 44, 41], color: '#b8860b' },
                gold_plus_plus: { id: 'gold_plus_plus', name: 'Gold++', displayName: 'POLARIS GOLD++', limits: '150/50', mbl: 150000, opbl: 50000, reg: 28, fund: [55, 52, 49, 46], color: '#8b6914' },
                platinum: { id: 'platinum', name: 'Platinum', displayName: 'POLARIS PLATINUM', limits: '180/40', mbl: 180000, opbl: 40000, reg: 24, fund: [50, 47, 44, 41], color: '#5a6268' },
                diamond: { id: 'diamond', name: 'Diamond', displayName: 'POLARIS DIAMOND', limits: '360/60', mbl: 360000, opbl: 60000, reg: 40, fund: [100, 95, 90, 85], color: '#17a2b8' }
            };
            programsLoaded = true;
            window.OFFER_PROGRAMS = OFFER_PROGRAMS; // Make available globally
            console.log('📋 Using default programs (7 programs)');
        }
        
        // Alias for backward compatibility
        let OFFER_PLANS = {};
        function syncPlansFromPrograms() {
            OFFER_PLANS = OFFER_PROGRAMS;
        }
        
        // Flag to track if offers data is loaded
        let offersDataLoaded = false;
        let offersInitialLoadDone = false;
        
        async function openOffersCenter() {
            document.getElementById('offersCenterModal').classList.remove('hidden');
            document.getElementById('dashboardBtn').style.display = 'flex';
            document.getElementById('mainDashboardBtn').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Load programs from DB if not already loaded
            if (!programsLoaded) {
                await loadProgramsFromDB();
            }
            syncPlansFromPrograms();
            
            // Only fetch data if not already loaded, otherwise just render from cache
            if (!offersDataLoaded || !offersInitialLoadDone) {
                await loadOffers(); // Full load
                offersInitialLoadDone = true;
            } else {
                // Use cached data - just render
                renderOffersTable();
                updateOfferStats();
            }
            
            // Apply cached document links immediately
            if (window.dataCache && window.dataCache.documentLinks && window.cachedDocumentLinks) {
                setTimeout(() => applyDocumentLinksToTable(), 100);
            }
            
            loadOfferClients();
            renderOfferPlanCards();
            renderCustomPlans();
            updateOfferValidityDate();
            generateOfferDisplayId();
            updateOfferCreatedDate();
            
            // Initialize scroll arrows for tables
            setTimeout(() => initTableScrollArrows(), 200);
        }
        
        // Quick open - just show the modal with cached data
        function openOffersCenterQuick() {
            document.getElementById('offersCenterModal').classList.remove('hidden');
            document.getElementById('dashboardBtn').style.display = 'flex';
            document.getElementById('mainDashboardBtn').style.display = 'flex';
            if (offersData && offersData.length > 0) {
                renderOffersTable();
                updateOfferStats();
            }
        }
        
        // Refresh offers data manually
        async function refreshOffersData() {
            const refreshBtn = document.querySelector('.offers-refresh-btn');
            if (refreshBtn) {
                refreshBtn.innerHTML = '⏳ Loading...';
                refreshBtn.disabled = true;
            }
            
            try {
                await loadOffers();
                await loadOfferDocumentLinksFromDB();
            } finally {
                if (refreshBtn) {
                    refreshBtn.innerHTML = '🔄 Refresh';
                    refreshBtn.disabled = false;
                }
            }
        }
        
        function closeOffersCenter() {
            document.getElementById('offersCenterModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        function generateOfferDisplayId() {
            const year = new Date().getFullYear();
            const num = String(Math.floor(Math.random() * 9999) + 1).padStart(4, '0');
            const el = document.getElementById('offerDisplayId');
            if (el) el.textContent = `OFF-${year}-${num}`;
        }
        
        function updateOfferCreatedDate() {
            const el = document.getElementById('offerCreatedDate');
            if (el) el.textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        
        async function switchOffersTab(tab) {
            // Hide all tabs and remove active class
            document.querySelectorAll('.offers-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.offers-tab-content').forEach(c => c.style.display = 'none');
            
            // Find the correct tab button and activate it
            const tabButtons = document.querySelectorAll('.offers-tab');
            tabButtons.forEach(btn => {
                if ((tab === 'list' && btn.textContent.includes('All Offers')) || 
                    (tab === 'create' && btn.textContent.includes('New Proposal')) ||
                    (tab === 'compare' && btn.textContent.includes('Comparison'))) {
                    btn.classList.add('active');
                }
            });
            
            // Show the correct tab content
            const tabId = 'offersTab' + tab.charAt(0).toUpperCase() + tab.slice(1);
            const tabContent = document.getElementById(tabId);
            if (tabContent) {
                tabContent.style.display = 'block';
            }
            
            if (tab === 'create') {
                renderOfferPlanCards();
                renderCustomPlans();
                updateOfferValidityDate();
                generateOfferDisplayId();
                updateOfferCreatedDate();
            }
            
            if (tab === 'compare') {
                await initComparisonQuote();
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════
        // COMPARISON QUOTE SYSTEM
        // ═══════════════════════════════════════════════════════════════════
        
        let comparisonSelectedPlans = [];
        
        async function initComparisonQuote() {
            // Load programs from DB if not already loaded
            if (!programsLoaded || !OFFER_PROGRAMS || Object.keys(OFFER_PROGRAMS).length === 0) {
                await loadProgramsFromDB();
            }
            loadCompareClients();
            populateComparePlanOptions();
            updateComparisonTotals();
        }
        
        function loadCompareClients() {
            const select = document.getElementById('compareClientSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Select Client --</option>';
            
            // Try multiple sources for client data
            let clients = [];
            if (window.allClientsData && window.allClientsData.length > 0) {
                clients = window.allClientsData;
            } else if (window.cachedClientsData && window.cachedClientsData.length > 0) {
                clients = window.cachedClientsData;
            }
            
            console.log('Comparison Quote - Loading clients:', clients.length);
            
            if (clients.length > 0) {
                clients.forEach(c => {
                    const displayName = c.client_name || c.contact_name || 'Unknown';
                    select.innerHTML += `<option value="${c.client_id}" data-name="${displayName}">${displayName}</option>`;
                });
            } else {
                // Try to load from API
                fetch(API_URL + '?action=getClients')
                    .then(r => r.json())
                    .then(result => {
                        if (result.success && result.data) {
                            window.allClientsData = result.data;
                            result.data.forEach(c => {
                                const displayName = c.client_name || c.contact_name || 'Unknown';
                                select.innerHTML += `<option value="${c.client_id}" data-name="${displayName}">${displayName}</option>`;
                            });
                        }
                    })
                    .catch(e => console.error('Error loading clients:', e));
            }
        }
        
        function populateComparePlanOptions() {
            const container = document.getElementById('comparePlanOptions');
            if (!container) return;
            
            // Get programs from OFFER_PROGRAMS (loaded from DB)
            const programs = window.OFFER_PROGRAMS || {};
            const programKeys = Object.keys(programs);
            
            console.log('Comparison Quote - Programs loaded:', programKeys.length, programKeys);
            
            // Default plans if no programs loaded (match loadDefaultPrograms)
            const defaultPlans = [
                { id: 'bronze', name: 'Bronze', color: '#8B4513', icon: '🥉', reg: 20, fund: [15, 14, 13, 12], dentalFee: 9.5, mbl: 30000 },
                { id: 'silver', name: 'Silver', color: '#6c757d', icon: '🥈', reg: 24, fund: [20, 18, 16, 14], dentalFee: 9.5, mbl: 40000 },
                { id: 'gold', name: 'Gold', color: '#d4a843', icon: '🥇', reg: 24, fund: [45, 42, 39, 36], dentalFee: 9.5, mbl: 80000 },
                { id: 'gold_plus', name: 'Gold+', color: '#b8860b', icon: '🏅', reg: 24, fund: [50, 47, 44, 41], dentalFee: 9.5, mbl: 100000 },
                { id: 'gold_plus_plus', name: 'Gold++', color: '#8b6914', icon: '🌟', reg: 28, fund: [55, 52, 49, 46], dentalFee: 9.5, mbl: 150000 },
                { id: 'platinum', name: 'Platinum', color: '#5a6268', icon: '💎', reg: 24, fund: [50, 47, 44, 41], dentalFee: 9.5, mbl: 180000 },
                { id: 'diamond', name: 'Diamond', color: '#17a2b8', icon: '💠', reg: 40, fund: [100, 95, 90, 85], dentalFee: 9.5, mbl: 360000 }
            ];
            
            const plansToShow = programKeys.length > 0 ? programKeys.map(key => {
                const p = programs[key];
                const nameLC = (p.name || key).toLowerCase();
                // Better icon mapping
                let icon = '📋';
                if (nameLC.includes('bronze')) icon = '🥉';
                else if (nameLC.includes('silver')) icon = '🥈';
                else if (nameLC.includes('gold++') || nameLC.includes('gold_plus_plus')) icon = '🌟';
                else if (nameLC.includes('gold+') || nameLC.includes('gold_plus')) icon = '🏅';
                else if (nameLC.includes('gold')) icon = '🥇';
                else if (nameLC.includes('platinum')) icon = '💎';
                else if (nameLC.includes('diamond')) icon = '💠';
                else if (nameLC.includes('emerald')) icon = '💚';
                
                return {
                    id: p.id || key,
                    name: p.name || key,
                    color: p.color || '#8e44ad',
                    icon: icon,
                    reg: p.reg || 24,
                    fund: p.fund || [50, 50, 50, 50],
                    dentalFee: p.dentalFee || 9.5,
                    mbl: p.mbl || 0,
                    opbl: p.opbl || 0,
                    limits: p.limits || ''
                };
            }) : defaultPlans;
            
            // Sort plans by logical order (Bronze < Silver < Gold < Gold+ < Gold++ < Platinum < Diamond)
            const planOrderMap = {'bronze': 1, 'silver': 2, 'gold': 3, 'gold_plus': 4, 'gold_plus_plus': 5, 'platinum': 6, 'diamond': 7};
            plansToShow.sort((a, b) => {
                const aOrder = planOrderMap[a.id.toLowerCase()] || 99;
                const bOrder = planOrderMap[b.id.toLowerCase()] || 99;
                return aOrder - bOrder;
            });
            
            // Store plan order for preview sorting
            window.planOrderMap = {};
            plansToShow.forEach((plan, idx) => {
                window.planOrderMap[plan.id] = idx;
            });
            
            container.innerHTML = plansToShow.map((plan, index) => {
                return `
                <div class="compare-plan-card" id="comparePlan_${plan.id}" 
                     style="background: white; border: 3px solid #dee2e6; border-radius: 12px; padding: 15px 12px; cursor: pointer; transition: all 0.3s; min-width: 140px;"
                     data-plan='${JSON.stringify(plan).replace(/'/g, "&#39;")}'
                     data-order="${index}"
                     onclick="selectPlan('${plan.id}')">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <input type="checkbox" id="compareCheck_${plan.id}" style="width: 28px; height: 28px; min-width: 28px; pointer-events: none; accent-color: #8e44ad; cursor: pointer;">
                        <span style="font-size: 24px;">${plan.icon}</span>
                        <span style="font-weight: 700; color: ${plan.color}; font-size: 15px; white-space: nowrap;">${plan.name}</span>
                    </div>
                    <div style="padding-left: 8px;" onclick="event.stopPropagation();">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; color: #555;">
                            <input type="checkbox" id="compareDental_${plan.id}" style="width: 22px; height: 22px; min-width: 22px; accent-color: #28a745; cursor: pointer;" onchange="updateComparisonPreview()">
                            <span style="line-height: 1.3;">🦷 Include<br>Dental<br>(+$${(plan.dentalFee || 9.50).toFixed(1)}/member)</span>
                        </label>
                    </div>
                </div>
            `}).join('');
        }
        
        function selectPlan(planId) {
            const card = document.getElementById('comparePlan_' + planId);
            const checkbox = document.getElementById('compareCheck_' + planId);
            if (!card || !checkbox) return;
            
            if (comparisonSelectedPlans.includes(planId)) {
                // Deselect
                checkbox.checked = false;
                card.style.borderColor = '#dee2e6';
                card.style.background = 'white';
                card.style.boxShadow = 'none';
                comparisonSelectedPlans = comparisonSelectedPlans.filter(p => p !== planId);
            } else {
                // Select
                checkbox.checked = true;
                card.style.borderColor = '#8e44ad';
                card.style.background = 'linear-gradient(135deg, #f8f4fc, #f0e6f6)';
                card.style.boxShadow = '0 4px 15px rgba(142, 68, 173, 0.3)';
                comparisonSelectedPlans.push(planId);
            }
            
            updateComparisonPreview();
        }
        
        function updateComparisonTotals() {
            const principals = parseInt(document.getElementById('comparePrincipals')?.value) || 0;
            const dependents = parseInt(document.getElementById('compareDependents')?.value) || 0;
            const total = principals + dependents;
            
            const totalEl = document.getElementById('compareTotalMembers');
            const tierEl = document.getElementById('compareTierBadge');
            
            if (totalEl) totalEl.textContent = total.toLocaleString();
            
            // Determine tier
            let tier = 'Tier 1';
            if (total > 750) tier = 'Tier 3';
            else if (total > 500) tier = 'Tier 2';
            
            if (tierEl) tierEl.textContent = tier;
            
            return { principals, dependents, total, tier };
        }
        
        function updateComparisonPreview() {
            updateComparisonTotals();
            
            const container = document.getElementById('comparisonPreview');
            if (!container) return;
            
            if (comparisonSelectedPlans.length < 2) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.7; font-size: 16px;">Select at least 2 plans to see comparison</p>';
                return;
            }
            
            const { principals, dependents, total, tier } = updateComparisonTotals();
            
            // Determine tier index for fund deposit
            let tierIndex = 0;
            if (total > 1000) tierIndex = 3;
            else if (total > 750) tierIndex = 2;
            else if (total > 500) tierIndex = 1;
            
            // Sort selected plans by their display order (Silver -> Gold -> Gold+ -> Gold++ -> Platinum -> Diamond)
            const fixedPlanOrder = {
                'bronze': 1, 
                'silver': 2, 
                'gold': 3, 
                'gold_plus': 4, 
                'gold_plus_plus': 5, 
                'platinum': 6, 
                'diamond': 7
            };
            const sortedSelectedPlans = [...comparisonSelectedPlans].sort((a, b) => {
                return (fixedPlanOrder[a] || 99) - (fixedPlanOrder[b] || 99);
            });
            
            // Build comparison table with larger rows
            let html = `
                <table style="width: 100%; border-collapse: collapse; color: white;">
                    <thead>
                        <tr style="border-bottom: 2px solid #d4a843; height: 110px;">
                            <th style="text-align: left; padding: 25px; font-size: 18px; color: #d4a843; vertical-align: middle;">Cost Breakdown</th>
            `;
            
            // Get plan data for each selected plan (in sorted order)
            const planDataList = [];
            sortedSelectedPlans.forEach(planId => {
                const card = document.getElementById('comparePlan_' + planId);
                if (card) {
                    const planData = JSON.parse(card.dataset.plan.replace(/&#39;/g, "'"));
                    const hasDental = document.getElementById('compareDental_' + planId)?.checked || false;
                    // Get fund deposit based on tier
                    const fundArray = planData.fund || [50, 50, 50, 50];
                    const fundDeposit = fundArray[tierIndex] || fundArray[0] || 50;
                    planDataList.push({ ...planData, hasDental, fundDeposit });
                    html += `<th style="text-align: center; padding: 25px 15px; font-size: 22px; color: ${planData.color}; min-width: 160px; height: 100px; vertical-align: middle;">
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                            <span style="font-size: 24px;">${planData.icon} ${planData.name}</span>
                            ${hasDental ? '<span style="font-weight:normal; opacity:0.8; font-size: 15px; margin-top: 6px;">+ Dental</span>' : '<span style="height: 21px;"></span>'}
                        </div>
                    </th>`;
                }
            });
            
            html += '</tr></thead><tbody>';
            
            // Calculate costs for each plan
            const rows = [
                { label: 'Registration Fee (Principals)', calc: (p) => principals * (p.reg || 24) },
                { label: 'Fund Deposit (All Members)', calc: (p) => total * (p.fundDeposit || 50) },
                { label: 'Dental Fee', calc: (p) => p.hasDental ? total * (p.dentalFee || 9.50) : 0 }
            ];
            
            rows.forEach(row => {
                html += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.1); height: 65px;">
                    <td style="padding: 20px; font-size: 17px;">${row.label}</td>`;
                planDataList.forEach(plan => {
                    const value = row.calc(plan);
                    html += `<td style="text-align: center; padding: 20px; font-size: 20px; font-weight: 500;">$${value.toLocaleString()}</td>`;
                });
                html += '</tr>';
            });
            
            // Total row
            html += `<tr style="border-top: 2px solid #d4a843; background: rgba(212,168,67,0.1); height: 80px;">
                <td style="padding: 25px; font-weight: 700; font-size: 22px; color: #d4a843;">TOTAL COST</td>`;
            planDataList.forEach(plan => {
                const regFee = principals * (plan.reg || 24);
                const fundDep = total * (plan.fundDeposit || 50);
                const dental = plan.hasDental ? total * (plan.dentalFee || 9.50) : 0;
                const totalCost = regFee + fundDep + dental;
                html += `<td style="text-align: center; padding: 25px; font-weight: 700; font-size: 28px; color: #d4a843;">$${totalCost.toLocaleString()}</td>`;
            });
            html += '</tr>';
            
            // Cost per member row
            html += `<tr style="background: rgba(255,255,255,0.05); height: 60px;">
                <td style="padding: 20px; font-size: 16px; opacity: 0.8;">Cost per Member</td>`;
            planDataList.forEach(plan => {
                const regFee = principals * (plan.reg || 24);
                const fundDep = total * (plan.fundDeposit || 50);
                const dental = plan.hasDental ? total * (plan.dentalFee || 9.50) : 0;
                const totalCost = regFee + fundDep + dental;
                const perMember = total > 0 ? (totalCost / total).toFixed(2) : 0;
                html += `<td style="text-align: center; padding: 20px; font-size: 20px; opacity: 0.9;">$${perMember}</td>`;
            });
            html += '</tr>';
            
            html += '</tbody></table>';
            
            // Summary info
            html += `
                <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center;">
                    <span style="font-size: 16px; opacity: 0.9;">Population: ${principals.toLocaleString()} Principals + ${dependents.toLocaleString()} Dependents = <strong style="font-size: 18px;">${total.toLocaleString()} Members</strong></span>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function resetComparison() {
            comparisonSelectedPlans = [];
            
            // Reset checkboxes and cards
            document.querySelectorAll('[id^="compareCheck_"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('[id^="compareDental_"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('[id^="comparePlan_"]').forEach(card => {
                card.style.borderColor = '#dee2e6';
                card.style.background = 'white';
                card.style.boxShadow = 'none';
            });
            
            // Reset inputs
            document.getElementById('comparePrincipals').value = 100;
            document.getElementById('compareDependents').value = 500;
            document.getElementById('compareClientSelect').value = '';
            
            updateComparisonTotals();
            updateComparisonPreview();
        }
        
        async function generateComparisonOfferEmail() {
            if (comparisonSelectedPlans.length < 2) {
                alert('Please select at least 2 plans to compare');
                return;
            }
            
            const clientSelect = document.getElementById('compareClientSelect');
            const clientId = clientSelect?.value || '';
            const clientName = clientSelect?.options[clientSelect.selectedIndex]?.text || 'Client';
            
            if (!clientId) {
                alert('Please select a client first');
                return;
            }
            
            // Get contact person
            let contactPerson = 'Sir/Madam';
            let contactEmail = '';
            if (window.allClientsData) {
                const client = window.allClientsData.find(c => c.client_id === clientId);
                if (client) {
                    contactPerson = client.contact_person || client.signatory_name || 'Sir/Madam';
                    contactEmail = client.email || '';
                }
            }
            
            const { principals, dependents, total, tier } = updateComparisonTotals();
            
            // Build plan summary for email
            const planOrderMapEmail = {'bronze': 1, 'silver': 2, 'gold': 3, 'gold_plus': 4, 'gold_plus_plus': 5, 'platinum': 6, 'diamond': 7};
            const sortedPlans = [...comparisonSelectedPlans].sort((a, b) => (planOrderMapEmail[a] || 99) - (planOrderMapEmail[b] || 99));
            
            let tierIndex = 0;
            if (total > 1000) tierIndex = 3;
            else if (total > 750) tierIndex = 2;
            else if (total > 500) tierIndex = 1;
            
            let planRows = '';
            sortedPlans.forEach(planId => {
                const card = document.getElementById('comparePlan_' + planId);
                if (card) {
                    const planData = JSON.parse(card.dataset.plan.replace(/&#39;/g, "'"));
                    const hasDental = document.getElementById('compareDental_' + planId)?.checked || false;
                    const fundArray = planData.fund || [50, 50, 50, 50];
                    const fundRate = fundArray[tierIndex] || fundArray[0] || 50;
                    const regFee = principals * (planData.reg || 24);
                    const fundDep = total * fundRate;
                    const dental = hasDental ? total * (planData.dentalFee || 9.50) : 0;
                    const totalCost = regFee + fundDep + dental;
                    
                    planRows += `<tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">${planData.icon} ${planData.name}${hasDental ? ' + Dental' : ''}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">$${totalCost.toLocaleString()}</td>
                    </tr>`;
                }
            });
            
            // Create email HTML
            const emailHtml = `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                    <div style="background: #1E3A5F; padding: 20px; text-align: center;">
                        <h1 style="color: #D4A843; margin: 0;">Healthcare Plans Comparison</h1>
                    </div>
                    <div style="padding: 20px;">
                        <p>Dear <strong>${contactPerson}</strong>,</p>
                        <p>Following our recent discussions, we are pleased to present a Healthcare Plans Comparison for <strong>${clientName}</strong>.</p>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                            <p style="margin: 0;"><strong>Population:</strong> ${principals.toLocaleString()} Principals + ${dependents.toLocaleString()} Dependents = <strong>${total.toLocaleString()} Members</strong></p>
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                            <thead>
                                <tr style="background: #1E3A5F; color: white;">
                                    <th style="padding: 12px; text-align: left;">Plan</th>
                                    <th style="padding: 12px; text-align: right;">Total Cost</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${planRows}
                            </tbody>
                        </table>
                        
                        <p>Please find attached the detailed comparison document for your review.</p>
                        <p>We look forward to your favorable response.</p>
                        
                        <p style="margin-top: 30px;">Best regards,<br><strong>Polaris Team</strong></p>
                    </div>
                    <div style="background: #1E3A5F; padding: 15px; text-align: center;">
                        <p style="color: #D4A843; margin: 0; font-style: italic;">Fast - Fair & Flexible</p>
                    </div>
                </div>
            `;
            
            // Open email center and populate
            openEmailCenter();
            
            setTimeout(() => {
                const subjectInput = document.getElementById('emailSubject');
                const previewBox = document.getElementById('emailPreviewBox');
                
                if (subjectInput) subjectInput.value = `Healthcare Plans Comparison Quote - ${clientName}`;
                if (previewBox) previewBox.innerHTML = emailHtml;
                
                // Enable send button
                const sendBtn = document.getElementById('emailSendBtn');
                if (sendBtn) sendBtn.disabled = false;
            }, 300);
        }
        
        async function saveComparisonOffer() {
            if (comparisonSelectedPlans.length < 2) {
                alert('Please select at least 2 plans to compare');
                return;
            }
            
            const clientSelect = document.getElementById('compareClientSelect');
            const clientId = clientSelect?.value || '';
            const clientName = clientSelect?.options[clientSelect.selectedIndex]?.text || '';
            
            if (!clientId) {
                alert('Please select a client first');
                return;
            }
            
            const { principals, dependents, total, tier } = updateComparisonTotals();
            
            // Collect all plan data
            const planOrderMapSave = {'bronze': 1, 'silver': 2, 'gold': 3, 'gold_plus': 4, 'gold_plus_plus': 5, 'platinum': 6, 'diamond': 7};
            const sortedPlans = [...comparisonSelectedPlans].sort((a, b) => (planOrderMapSave[a] || 99) - (planOrderMapSave[b] || 99));
            
            let tierIndex = 0;
            if (total > 1000) tierIndex = 3;
            else if (total > 750) tierIndex = 2;
            else if (total > 500) tierIndex = 1;
            
            const options = [];
            sortedPlans.forEach(planId => {
                const card = document.getElementById('comparePlan_' + planId);
                if (card) {
                    const planData = JSON.parse(card.dataset.plan.replace(/&#39;/g, "'"));
                    const hasDental = document.getElementById('compareDental_' + planId)?.checked || false;
                    const fundArray = planData.fund || [50, 50, 50, 50];
                    const fundRate = fundArray[tierIndex] || fundArray[0] || 50;
                    const regFee = principals * (planData.reg || 24);
                    const fundDep = total * fundRate;
                    const dental = hasDental ? total * (planData.dentalFee || 9.50) : 0;
                    const totalCost = regFee + fundDep + dental;
                    
                    options.push({
                        planId: planId,
                        planName: planData.name,
                        hasDental,
                        regFee,
                        fundDep,
                        dental,
                        totalCost,
                        perMember: total > 0 ? (totalCost / total).toFixed(2) : '0.00'
                    });
                }
            });
            
            // Save to database
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '⏳ Saving...';
            btn.disabled = true;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'saveComparisonOffer',
                        clientId,
                        clientName,
                        principals,
                        dependents,
                        totalMembers: total,
                        tier,
                        options: options,
                        offerDate: new Date().toISOString().split('T')[0],
                        createdBy: currentUser?.name || 'Admin',
                        createdAt: new Date().toISOString()
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ Comparison offer saved successfully!');
                    
                    // ═══════════════════════════════════════════════════════════════
                    // FIX: Clear document cache to force reload
                    // ═══════════════════════════════════════════════════════════════
                    window.cachedDocumentLinks = null;
                    if (window.dataCache) window.dataCache.documentLinks = false;
                    
                    // Reset comparison form
                    comparisonSelectedPlans = [];
                    document.querySelectorAll('.compare-plan-card').forEach(card => {
                        card.classList.remove('selected');
                        const checkbox = card.querySelector('input[type="checkbox"]');
                        if (checkbox) checkbox.checked = false;
                    });
                    
                    // Refresh offers list
                    if (typeof loadOffers === 'function') {
                        await loadOffers();
                    }
                    
                    // ═══════════════════════════════════════════════════════════════
                    // FIX: Reload document links after offers are loaded
                    // ═══════════════════════════════════════════════════════════════
                    if (typeof loadOfferDocumentLinksFromDB === 'function') {
                        await loadOfferDocumentLinksFromDB();
                    }
                    
                    // Navigate to All Offers tab
                    switchOffersTab('list');
                } else {
                    alert('❌ Error: ' + (result.error || 'Failed to save offer'));
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('❌ Error saving offer: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function generateComparisonPDF() {
            if (comparisonSelectedPlans.length < 2) {
                alert('Please select at least 2 plans to compare');
                return;
            }
            
            const clientSelect = document.getElementById('compareClientSelect');
            const clientName = clientSelect?.options[clientSelect.selectedIndex]?.text || 'Client';
            const { principals, dependents, total, tier } = updateComparisonTotals();
            
            // Determine tier index for fund deposit
            let tierIndex = 0;
            if (total > 1000) tierIndex = 3;
            else if (total > 750) tierIndex = 2;
            else if (total > 500) tierIndex = 1;
            
            // Sort selected plans by display order
            const planOrderMapDoc = {'bronze': 1, 'silver': 2, 'gold': 3, 'gold_plus': 4, 'gold_plus_plus': 5, 'platinum': 6, 'diamond': 7};
            const sortedSelectedPlans = [...comparisonSelectedPlans].sort((a, b) => {
                return (planOrderMapDoc[a] || 99) - (planOrderMapDoc[b] || 99);
            });
            
            // Collect plan data (in sorted order)
            const planDataList = [];
            sortedSelectedPlans.forEach(planId => {
                const card = document.getElementById('comparePlan_' + planId);
                if (card) {
                    const planData = JSON.parse(card.dataset.plan.replace(/&#39;/g, "'"));
                    const hasDental = document.getElementById('compareDental_' + planId)?.checked || false;
                    
                    // Get fund deposit based on tier
                    const fundArray = planData.fund || [50, 50, 50, 50];
                    const fundDepositRate = fundArray[tierIndex] || fundArray[0] || 50;
                    
                    const regFee = principals * (planData.reg || 24);
                    const fundDep = total * fundDepositRate;
                    const dental = hasDental ? total * (planData.dentalFee || 9.50) : 0;
                    const totalCost = regFee + fundDep + dental;
                    
                    planDataList.push({
                        name: planData.name,
                        color: planData.color,
                        icon: planData.icon,
                        hasDental,
                        regFee,
                        fundDep,
                        dental,
                        totalCost,
                        perMember: total > 0 ? (totalCost / total).toFixed(2) : 0
                    });
                }
            });
            
            // Generate PDF using jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape', 'mm', 'a4');
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            
            // Header background
            doc.setFillColor(30, 58, 95);
            doc.rect(0, 0, pageWidth, 35, 'F');
            
            // Header text
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text('POLARIS Healthcare Plans Comparison', 15, 18);
            
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text(`Prepared for: ${clientName}`, 15, 28);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, pageWidth - 60, 28);
            
            // Gold accent line
            doc.setFillColor(212, 168, 67);
            doc.rect(0, 35, pageWidth, 3, 'F');
            
            // Population info box
            doc.setFillColor(248, 249, 250);
            doc.rect(15, 45, pageWidth - 30, 18, 'F');
            doc.setDrawColor(142, 68, 173);
            doc.setLineWidth(0.5);
            doc.rect(15, 45, pageWidth - 30, 18, 'S');
            
            doc.setTextColor(30, 58, 95);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(`Population: ${principals.toLocaleString()} Principals + ${dependents.toLocaleString()} Dependents = ${total.toLocaleString()} Total Members`, pageWidth / 2, 56, { align: 'center' });
            
            // Comparison table
            const tableStartY = 75;
            const colWidth = (pageWidth - 30) / (planDataList.length + 1);
            
            // Table header
            doc.setFillColor(142, 68, 173);
            doc.rect(15, tableStartY, pageWidth - 30, 12, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('Cost Breakdown', 20, tableStartY + 8);
            
            planDataList.forEach((plan, i) => {
                const x = 15 + colWidth + (i * colWidth) + colWidth/2;
                doc.text(`${plan.name}${plan.hasDental ? ' + Dental' : ''}`, x, tableStartY + 8, { align: 'center' });
            });
            
            // Table rows
            const rows = [
                { label: 'Registration Fee (Principals)', values: planDataList.map(p => p.regFee) },
                { label: 'Fund Deposit (All Members)', values: planDataList.map(p => p.fundDep) },
                { label: 'Dental Fee', values: planDataList.map(p => p.dental) }
            ];
            
            let currentY = tableStartY + 12;
            doc.setTextColor(30, 58, 95);
            
            rows.forEach((row, idx) => {
                if (idx % 2 === 0) {
                    doc.setFillColor(248, 249, 250);
                    doc.rect(15, currentY, pageWidth - 30, 10, 'F');
                }
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                doc.text(row.label, 20, currentY + 7);
                
                row.values.forEach((val, i) => {
                    const x = 15 + colWidth + (i * colWidth) + colWidth/2;
                    doc.text(`$${val.toLocaleString()}`, x, currentY + 7, { align: 'center' });
                });
                
                currentY += 10;
            });
            
            // Total row
            doc.setFillColor(212, 168, 67);
            doc.rect(15, currentY, pageWidth - 30, 14, 'F');
            
            doc.setTextColor(30, 58, 95);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('TOTAL COST', 20, currentY + 9);
            
            planDataList.forEach((plan, i) => {
                const x = 15 + colWidth + (i * colWidth) + colWidth/2;
                doc.text(`$${plan.totalCost.toLocaleString()}`, x, currentY + 9, { align: 'center' });
            });
            
            currentY += 14;
            
            // Cost per member row
            doc.setFillColor(240, 240, 240);
            doc.rect(15, currentY, pageWidth - 30, 10, 'F');
            
            doc.setFontSize(9);
            doc.setFont('helvetica', 'italic');
            doc.text('Cost per Member', 20, currentY + 7);
            
            planDataList.forEach((plan, i) => {
                const x = 15 + colWidth + (i * colWidth) + colWidth/2;
                doc.text(`$${plan.perMember}`, x, currentY + 7, { align: 'center' });
            });
            
            // Footer
            doc.setFillColor(30, 58, 95);
            doc.rect(0, pageHeight - 15, pageWidth, 15, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text('POLARIS Financial Services | TPA Healthcare Solutions for the Maritime Industry', pageWidth / 2, pageHeight - 6, { align: 'center' });
            
            // Open PDF in new tab
            const pdfBlob = doc.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);
            window.open(pdfUrl, '_blank');
        }
        
        // Generate Comparison Quote as Google Doc
        async function generateComparisonGoogleDoc() {
            if (comparisonSelectedPlans.length < 2) {
                alert('Please select at least 2 plans to compare');
                return;
            }
            
            const clientSelect = document.getElementById('compareClientSelect');
            const clientId = clientSelect?.value || '';
            const clientName = clientSelect?.options[clientSelect.selectedIndex]?.text || 'Client';
            
            if (!clientId) {
                alert('Please select a client first');
                return;
            }
            
            // Get contact person from client data
            let contactPerson = 'Sir/Madam';
            if (window.allClientsData) {
                const client = window.allClientsData.find(c => c.client_id === clientId);
                if (client) {
                    contactPerson = client.contact_person || client.signatory_name || 'Sir/Madam';
                }
            }
            
            const { principals, dependents, total, tier } = updateComparisonTotals();
            
            // Determine tier index for fund deposit
            let tierIndex = 0;
            if (total > 1000) tierIndex = 3;
            else if (total > 750) tierIndex = 2;
            else if (total > 500) tierIndex = 1;
            
            // Sort selected plans by display order
            const planOrderMapPrint = {'bronze': 1, 'silver': 2, 'gold': 3, 'gold_plus': 4, 'gold_plus_plus': 5, 'platinum': 6, 'diamond': 7};
            const sortedSelectedPlans = [...comparisonSelectedPlans].sort((a, b) => {
                return (planOrderMapPrint[a] || 99) - (planOrderMapPrint[b] || 99);
            });
            
            // Collect plan data (in sorted order)
            const options = [];
            sortedSelectedPlans.forEach(planId => {
                const card = document.getElementById('comparePlan_' + planId);
                if (card) {
                    const planData = JSON.parse(card.dataset.plan.replace(/&#39;/g, "'"));
                    const hasDental = document.getElementById('compareDental_' + planId)?.checked || false;
                    
                    // Get fund deposit based on tier
                    const fundArray = planData.fund || [50, 50, 50, 50];
                    const fundDepositRate = fundArray[tierIndex] || fundArray[0] || 50;
                    
                    const regFee = principals * (planData.reg || 24);
                    const fundDep = total * fundDepositRate;
                    const dental = hasDental ? total * (planData.dentalFee || 9.50) : 0;
                    const totalCost = regFee + fundDep + dental;
                    
                    options.push({
                        name: planData.name,
                        hasDental,
                        regFee,
                        fundDep,
                        dental,
                        totalCost,
                        perMember: total > 0 ? (totalCost / total).toFixed(2) : '0.00'
                    });
                }
            });
            
            // Show loading
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '⏳ Generating...';
            btn.disabled = true;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generateComparisonQuote',
                        clientId: clientId,
                        clientName: clientName,
                        contactPerson: contactPerson,
                        principals: principals,
                        dependents: dependents,
                        totalMembers: total,
                        tier: tier,
                        options: options
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.documentUrl) {
                    // Open the document in a new tab
                    window.open(result.documentUrl, '_blank');
                    
                    // Show success message
                    alert('✅ Comparison Quote created successfully!\n\nDocument: ' + result.documentName);
                } else {
                    throw new Error(result.error || 'Failed to generate document');
                }
                
            } catch (error) {
                console.error('Error generating comparison quote:', error);
                alert('Error generating document: ' + error.message + '\n\nTry the PDF option instead.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        function updateOfferStats() {
            // Calculate stats from loaded offers data
            const offers = offersData || [];
            const stats = {
                total: offers.length,
                draft: offers.filter(o => o.status === 'draft').length,
                sent: offers.filter(o => o.status === 'sent').length,
                accepted: offers.filter(o => o.status === 'accepted').length,
                rejected: offers.filter(o => o.status === 'rejected').length
            };
            
            document.getElementById('offerStatTotal').textContent = stats.total;
            document.getElementById('offerStatDraft').textContent = stats.draft;
            document.getElementById('offerStatSent').textContent = stats.sent;
            document.getElementById('offerStatAccepted').textContent = stats.accepted;
            document.getElementById('offerStatRejected').textContent = stats.rejected;
        }
        
        async function loadOfferStats() {
            // Now just calls updateOfferStats after offers are loaded
            updateOfferStats();
        }
        
        async function loadOffers() {
            const tbody = document.getElementById('offersTableBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted);">Loading...</td></tr>';
            }
            
            try {
                const response = await fetch(API_URL + '?action=getOffers');
                const result = await response.json();
                
                if (result.success && result.data) {
                    // Sort by date/ID - newest first
                    result.data.sort((a, b) => {
                        const dateA = new Date(a.created_date || a.offer_date || 0);
                        const dateB = new Date(b.created_date || b.offer_date || 0);
                        if (dateB - dateA !== 0) return dateB - dateA;
                        // Fallback to offer_id comparison (newer IDs have larger timestamps)
                        return (b.offer_id || '').localeCompare(a.offer_id || '');
                    });
                    offersData = result.data;
                    window.offersData = result.data; // Sync to global for navigation
                    allOffersData = result.data; // Also store for filtering
                    offersDataLoaded = true;
                    renderOffersTable();
                    updateOfferStats(); // Update statistics after loading
                    // Load document links after table is rendered
                    setTimeout(() => loadOfferDocumentLinksFromDB(), 500);
                    console.log('✅ Offers loaded:', offersData.length, 'items');
                } else {
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted);">No offers found</td></tr>';
                    }
                }
            } catch (e) {
                console.error('Error loading offers:', e);
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:#e74c3c;">Error loading offers</td></tr>';
                }
            }
        }
        
        // Preload offers data in background
        async function preloadOffersData() {
            if (offersDataLoaded) return; // Already loaded
            
            try {
                console.log('🔄 Preloading offers data...');
                const response = await fetch(API_URL + '?action=getOffers');
                const result = await response.json();
                
                if (result.success && result.data) {
                    // Sort by date/ID - newest first
                    result.data.sort((a, b) => {
                        const dateA = new Date(a.created_date || a.offer_date || 0);
                        const dateB = new Date(b.created_date || b.offer_date || 0);
                        if (dateB - dateA !== 0) return dateB - dateA;
                        return (b.offer_id || '').localeCompare(a.offer_id || '');
                    });
                    offersData = result.data;
                    window.offersData = result.data; // Sync to global for navigation
                    allOffersData = result.data;
                    offersDataLoaded = true;
                    console.log('✅ Offers preloaded:', offersData.length, 'items');
                }
            } catch (e) {
                console.log('⚠️ Could not preload offers:', e.message);
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════
        // OFFERS FILTER FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        let allOffersData = []; // Store all offers for filtering
        
        function filterOffers() {
            const searchClient = document.getElementById('offerSearchClient').value.toLowerCase().trim();
            const dateFrom = document.getElementById('offerSearchDateFrom').value;
            const dateTo = document.getElementById('offerSearchDateTo').value;
            const statusFilter = document.getElementById('offerSearchStatus').value.toLowerCase();
            
            let filtered = allOffersData.filter(offer => {
                // Filter by client name
                if (searchClient && !(offer.client_name || '').toLowerCase().includes(searchClient)) {
                    return false;
                }
                
                // Filter by date range
                if (dateFrom || dateTo) {
                    const offerDate = offer.offer_date ? new Date(offer.offer_date).toISOString().split('T')[0] : '';
                    if (dateFrom && offerDate < dateFrom) return false;
                    if (dateTo && offerDate > dateTo) return false;
                }
                
                // Filter by status
                if (statusFilter && (offer.status || '').toLowerCase() !== statusFilter) {
                    return false;
                }
                
                return true;
            });
            
            // Update counter
            const countEl = document.getElementById('offerFilterCount');
            if (countEl) {
                countEl.textContent = `Showing ${filtered.length} of ${allOffersData.length} offers`;
            }
            
            // Render filtered results
            renderOffersTableFiltered(filtered);
        }
        
        function clearOfferFilters() {
            document.getElementById('offerSearchClient').value = '';
            document.getElementById('offerSearchDateFrom').value = '';
            document.getElementById('offerSearchDateTo').value = '';
            document.getElementById('offerSearchStatus').value = '';
            
            const countEl = document.getElementById('offerFilterCount');
            if (countEl) countEl.textContent = '';
            
            renderOffersTableFiltered(allOffersData);
        }
        
        // Helper function to render offer row with comparison/standard logic
        function renderOfferRow(offer) {
            const isComparison = offer.offer_type === 'comparison' || (offer.offer_id && offer.offer_id.startsWith('CQ-'));
            
            // Badge HTML
            const typeBadge = isComparison 
                ? '<span style="background:#8b5cf6;color:white;padding:2px 6px;border-radius:4px;font-size:0.65rem;margin-left:6px;">📊 COMPARISON</span>'
                : '';
            
            // Actions based on offer type
            let actionsHtml = '';
            
            if (isComparison) {
                // COMPARISON OFFER: View, CQ Doc, NDA, Convert to Standard
                actionsHtml = `
                    <div style="text-align:center;width:42px;">
                        <button onclick="viewOffer('${offer.offer_id}')" style="padding:0.5rem 0.75rem;font-size:0.8rem;background:#4a5568;color:white;border:none;border-radius:6px;cursor:pointer;" title="View Offer">👁️</button>
                    </div>
                    <div style="text-align:center;width:70px;">
                        <button onclick="generateCQFromTable('${offer.offer_id}')" style="padding:0.5rem 0.75rem;font-size:0.8rem;background:#8b5cf6;color:white;border:none;border-radius:6px;cursor:pointer;width:70px;" title="Generate Comparison Quote Document">📊 CQ</button>
                        <div id="cqLink-${offer.offer_id}" style="margin-top:4px;font-size:0.7rem;min-height:18px;"></div>
                    </div>
                    <div style="text-align:center;width:70px;">
                        <button onclick="generateNDAFromOffer('${offer.offer_id}', '${offer.client_id}')" style="padding:0.5rem 0.75rem;font-size:0.8rem;background:#e67e22;color:white;border:none;border-radius:6px;cursor:pointer;width:70px;" title="Generate NDA">📜 NDA</button>
                        <div id="ndaLink-${offer.offer_id}" style="margin-top:4px;font-size:0.7rem;min-height:18px;"></div>
                    </div>
                    <div style="text-align:center;width:80px;">
                        <button onclick="openConvertToStandardModal('${offer.offer_id}')" style="padding:0.5rem 0.75rem;font-size:0.75rem;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:6px;cursor:pointer;width:80px;" title="Convert to Standard Offer">🔄 Convert</button>
                    </div>
                    <div style="text-align:center;width:60px;">
                        <button onclick="openSendDocumentsFromOffer('${offer.offer_id}')" style="padding:0.5rem 0.75rem;font-size:0.8rem;background:linear-gradient(135deg,#d4a843,#c49932);color:#1e3a5f;border:none;border-radius:6px;cursor:pointer;width:60px;font-weight:600;" title="Send Documents via Email">📨 Send</button>
                    </div>
                `;
            } else {
                // STANDARD OFFER: Full buttons
                actionsHtml = `
                    <div style="text-align:center;width:42px;">
                        <button onclick="viewOffer('${offer.offer_id}')" style="padding:0.5rem 0.75rem;font-size:0.8rem;background:#4a5568;color:white;border:none;border-radius:6px;cursor:pointer;" title="View Offer">👁️</button>
                    </div>
                    <div style="text-align:center;width:42px;">
                        <button onclick="sendOffer('${offer.offer_id}')" style="padding:0.5rem 0.75rem;font-size:0.8rem;background:#3498db;color:white;border:none;border-radius:6px;cursor:pointer;${offer.status !== 'draft' ? 'opacity:0.3;pointer-events:none;' : ''}" title="Send Email" ${offer.status !== 'draft' ? 'disabled' : ''}>📧</button>
                    </div>
                    <div style="text-align:center;width:70px;">
                        <button onclick="generateNDAFromOffer('${offer.offer_id}', '${offer.client_id}')" style="padding:0.5rem 0.75rem;font-size:0.8rem;background:#e67e22;color:white;border:none;border-radius:6px;cursor:pointer;width:70px;" title="Generate NDA">📜 NDA</button>
                        <div id="ndaLink-${offer.offer_id}" style="margin-top:4px;font-size:0.7rem;min-height:18px;"></div>
                    </div>
                    <div style="text-align:center;width:70px;">
                        <button onclick="generateDPAFromOffer('${offer.offer_id}', '${offer.client_id}')" style="padding:0.5rem 0.75rem;font-size:0.8rem;background:#9b59b6;color:white;border:none;border-radius:6px;cursor:pointer;width:70px;" title="Generate DPA">🔒 DPA</button>
                        <div id="dpaLink-${offer.offer_id}" style="margin-top:4px;font-size:0.7rem;min-height:18px;"></div>
                    </div>
                    <div style="text-align:center;width:70px;">
                        <button onclick="generateASAFromOffer('${offer.offer_id}', '${offer.client_id}')" style="padding:0.5rem 0.75rem;font-size:0.8rem;background:#27ae60;color:white;border:none;border-radius:6px;cursor:pointer;width:70px;" title="Generate ASA">📋 ASA</button>
                        <div id="asaLink-${offer.offer_id}" style="margin-top:4px;font-size:0.7rem;min-height:18px;"></div>
                    </div>
                    <div style="text-align:center;width:70px;">
                        <button onclick="generateProposalFromOffer('${offer.offer_id}', '${offer.client_id}')" style="padding:0.5rem 0.75rem;font-size:0.8rem;background:#1e3a5f;color:white;border:none;border-radius:6px;cursor:pointer;width:70px;" title="Generate Proposal">📄 Prop</button>
                        <div id="proposalLink-${offer.offer_id}" style="margin-top:4px;font-size:0.7rem;min-height:18px;"></div>
                    </div>
                    <div style="text-align:center;width:60px;">
                        <button onclick="generateAllDocsFromOffer('${offer.offer_id}', '${offer.client_id}')" style="padding:0.5rem 0.75rem;font-size:0.8rem;background:#8e44ad;color:white;border:none;border-radius:6px;cursor:pointer;width:60px;" title="Generate All Documents">📁 All</button>
                        <div id="allStatus-${offer.offer_id}" style="margin-top:4px;font-size:0.7rem;min-height:18px;"></div>
                    </div>
                    <div style="text-align:center;width:60px;">
                        <button onclick="openSendDocumentsFromOffer('${offer.offer_id}')" style="padding:0.5rem 0.75rem;font-size:0.8rem;background:linear-gradient(135deg,#d4a843,#c49932);color:#1e3a5f;border:none;border-radius:6px;cursor:pointer;width:60px;font-weight:600;" title="Send Documents via Email">📨 Send</button>
                    </div>
                    <!-- OFFER → CONTRACT WORKFLOW BUTTONS -->
                    <div style="text-align:center;width:70px;${offer.status !== 'accepted' ? 'display:none;' : ''}">
                        <button onclick="sendOfferForSignature('${offer.offer_id}')" style="padding:0.5rem 0.75rem;font-size:0.8rem;background:#9b59b6;color:white;border:none;border-radius:6px;cursor:pointer;width:70px;" title="Convert to PDF & Send for Signature">📝 Sign</button>
                    </div>
                    <div style="text-align:center;width:70px;${offer.status !== 'pending_signature' ? 'display:none;' : ''}">
                        <button onclick="markOfferAsSigned('${offer.offer_id}')" style="padding:0.5rem 0.75rem;font-size:0.8rem;background:#1abc9c;color:white;border:none;border-radius:6px;cursor:pointer;width:70px;" title="Mark as Signed">✅ Signed</button>
                    </div>
                    <div style="text-align:center;width:70px;${offer.status !== 'signed' ? 'display:none;' : ''}">
                        <button onclick="createContractFromOfferUI('${offer.offer_id}')" style="padding:0.5rem 0.75rem;font-size:0.8rem;background:linear-gradient(135deg,#d4a843,#c49932);color:#1e3a5f;border:none;border-radius:6px;cursor:pointer;width:70px;font-weight:600;" title="Create Contract">📄 Contract</button>
                    </div>
                `;
            }
            
            return `
                <tr style="height:90px;">
                    <td style="padding:1rem;"><strong>${offer.offer_id}</strong>${typeBadge}</td>
                    <td style="padding:1rem;">${offer.client_name || 'N/A'}</td>
                    <td style="padding:1rem;">${formatContractDate(offer.offer_date)}</td>
                    <td style="padding:1rem;">${offer.total_members || 0}</td>
                    <td style="padding:1rem;"><strong>$${(offer.grand_total_usd || 0).toLocaleString()}</strong></td>
                    <td style="padding:1rem;"><span class="offer-status ${offer.status}">${offer.status}</span></td>
                    <td style="padding:1rem;">
                        <div style="display:flex;gap:6px;align-items:flex-start;">
                            ${actionsHtml}
                        </div>
                    </td>
                </tr>
            `;
        }
        
        function renderOffersTableFiltered(offers) {
            const tbody = document.getElementById('offersTableBody');
            
            if (!offers || offers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted);">No offers found matching your criteria</td></tr>';
                return;
            }
            
            tbody.innerHTML = offers.map(offer => renderOfferRow(offer)).join('');
        }
        
        function renderOffersTable() {
            const tbody = document.getElementById('offersTableBody');
            
            if (!offersData || offersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--text-muted);">No offers yet. Create your first offer!</td></tr>';
                return;
            }
            
            // Store all offers for filtering
            allOffersData = [...offersData];
            
            tbody.innerHTML = offersData.map(offer => renderOfferRow(offer)).join('');
        }
        
        // ═══════════════════════════════════════════════════════════════════
        // DOCUMENT GENERATION FUNCTIONS (Using GET to avoid CORS)
        // ═══════════════════════════════════════════════════════════════════
        
        // Store generated document IDs per offer/client
        let generatedDocuments = {};
        
        async function generateNDAFromOffer(offerId, clientId) {
            const linkEl = document.getElementById('ndaLink-' + offerId);
            if (linkEl) linkEl.innerHTML = '<span style="color:#f39c12;">⏳...</span>';
            
            try {
                const url = API_URL + '?action=createNDA&clientId=' + encodeURIComponent(clientId) + '&offerId=' + encodeURIComponent(offerId);
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    if (linkEl) linkEl.innerHTML = `<a href="${result.fileUrl}" target="_blank" style="color:#e67e22;">📜 Open</a>`;
                    // Store the document ID
                    if (!generatedDocuments[offerId]) generatedDocuments[offerId] = {};
                    generatedDocuments[offerId].nda = {
                        fileId: result.fileId,
                        fileUrl: result.fileUrl,
                        fileName: result.fileName || 'NDA - ' + clientId
                    };
                } else {
                    if (linkEl) linkEl.innerHTML = '<span style="color:#e74c3c;">❌</span>';
                }
            } catch (error) {
                console.error('NDA generation error:', error);
                if (linkEl) linkEl.innerHTML = '<span style="color:#e74c3c;">❌</span>';
            }
        }
        
        async function generateDPAFromOffer(offerId, clientId) {
            const linkEl = document.getElementById('dpaLink-' + offerId);
            if (linkEl) linkEl.innerHTML = '<span style="color:#f39c12;">⏳...</span>';
            
            try {
                const url = API_URL + '?action=createDPA&clientId=' + encodeURIComponent(clientId) + '&offerId=' + encodeURIComponent(offerId);
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    if (linkEl) linkEl.innerHTML = `<a href="${result.fileUrl}" target="_blank" style="color:#9b59b6;">🔒 Open</a>`;
                    // Store the document ID
                    if (!generatedDocuments[offerId]) generatedDocuments[offerId] = {};
                    generatedDocuments[offerId].dpa = {
                        fileId: result.fileId,
                        fileUrl: result.fileUrl,
                        fileName: result.fileName || 'DPA - ' + clientId
                    };
                } else {
                    if (linkEl) linkEl.innerHTML = '<span style="color:#e74c3c;">❌</span>';
                }
            } catch (error) {
                console.error('DPA generation error:', error);
                if (linkEl) linkEl.innerHTML = '<span style="color:#e74c3c;">❌</span>';
            }
        }
        
        async function generateASAFromOffer(offerId, clientId) {
            const linkEl = document.getElementById('asaLink-' + offerId);
            if (linkEl) linkEl.innerHTML = '<span style="color:#f39c12;">⏳...</span>';
            
            try {
                const url = API_URL + '?action=createASAFromOffer&offerId=' + encodeURIComponent(offerId);
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    if (linkEl) linkEl.innerHTML = `<a href="${result.fileUrl}" target="_blank" style="color:#27ae60;">📋 Open</a>`;
                    // Store the document ID
                    if (!generatedDocuments[offerId]) generatedDocuments[offerId] = {};
                    generatedDocuments[offerId].asa = {
                        fileId: result.fileId,
                        fileUrl: result.fileUrl,
                        fileName: result.fileName || 'ASA - ' + offerId
                    };
                } else {
                    if (linkEl) linkEl.innerHTML = '<span style="color:#e74c3c;">❌</span>';
                }
            } catch (error) {
                console.error('ASA generation error:', error);
                if (linkEl) linkEl.innerHTML = '<span style="color:#e74c3c;">❌</span>';
            }
        }
        async function generateProposalFromOffer(offerId, clientId) {
            const linkEl = document.getElementById('proposalLink-' + offerId);
            if (linkEl) linkEl.innerHTML = '<span style="color:#f39c12;">⏳ ...</span>';
            
            try {
                const url = API_URL + '?action=createProposalFromOffer&offerId=' + encodeURIComponent(offerId);
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    if (linkEl) linkEl.innerHTML = `<a href="${result.fileUrl}" target="_blank" style="color:#9b59b6;">📄 Open</a>`;
                    // Store the document ID
                    if (!generatedDocuments[offerId]) generatedDocuments[offerId] = {};
                    generatedDocuments[offerId].proposal = {
                        fileId: result.fileId,
                        fileUrl: result.fileUrl,
                        fileName: result.fileName || 'Proposal - ' + offerId
                    };
                } else {
                    if (linkEl) linkEl.innerHTML = '<span style="color:#e74c3c;">❌</span>';
                }
            } catch (error) {
                console.error('Proposal generation error:', error);
                if (linkEl) linkEl.innerHTML = '<span style="color:#e74c3c;">❌</span>';
            }
        }
        
        // Get generated documents for an offer (for Send Documents modal)
        async function getOfferDocuments(offerId) {
            // First check local cache
            if (generatedDocuments[offerId]) {
                return generatedDocuments[offerId];
            }
            
            // Otherwise fetch from database
            try {
                const response = await fetch(`${API_URL}?action=getOfferDocuments&offerId=${offerId}`);
                const result = await response.json();
                if (result.success && result.documents) {
                    generatedDocuments[offerId] = result.documents;
                    return result.documents;
                }
            } catch (err) {
                console.error('Error fetching offer documents:', err);
            }
            
            return {};
        }
// ============================================
        // AUTO-LOAD DOCUMENT LINKS FROM DATABASE
        // ============================================
        async function loadOfferDocumentLinksFromDB() {
            // Use cached data if available
            if (window.dataCache && window.dataCache.documentLinks && window.cachedDocumentLinks) {
                console.log('Using cached document links');
                applyDocumentLinksToTable();
                return;
            }
            
            try {
                const url = API_URL + '?action=getAllOffersDocuments';
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const docsMap = result.data;
                    
                    // Cache for later use
                    window.cachedDocumentLinks = docsMap;
                    if (window.dataCache) window.dataCache.documentLinks = true;
                    
                    // Helper to extract URL from string or object
                    const getUrl = (doc) => {
                        if (!doc) return null;
                        if (typeof doc === 'string') return doc;
                        return doc.url || doc.drive_url || doc.fileUrl || null;
                    };
                    
                    Object.keys(docsMap).forEach(offerId => {
                        const docs = docsMap[offerId];
                        
                        const ndaUrl = getUrl(docs.nda);
                        const ndaLink = document.getElementById('ndaLink-' + offerId);
                        if (ndaLink && ndaUrl) {
                            ndaLink.innerHTML = `<a href="${ndaUrl}" target="_blank" style="color:#e67e22;">📜 Open</a>`;
                        }
                        
                        const dpaUrl = getUrl(docs.dpa);
                        const dpaLink = document.getElementById('dpaLink-' + offerId);
                        if (dpaLink && dpaUrl) {
                            dpaLink.innerHTML = `<a href="${dpaUrl}" target="_blank" style="color:#9b59b6;">🔒 Open</a>`;
                        }
                        
                        const asaUrl = getUrl(docs.asa);
                        const asaLink = document.getElementById('asaLink-' + offerId);
                        if (asaLink && asaUrl) {
                            asaLink.innerHTML = `<a href="${asaUrl}" target="_blank" style="color:#27ae60;">📋 Open</a>`;
                        }
                        
                        const proposalUrl = getUrl(docs.proposal);
                        const proposalLink = document.getElementById('proposalLink-' + offerId);
                        if (proposalLink && proposalUrl) {
                            proposalLink.innerHTML = `<a href="${proposalUrl}" target="_blank" style="color:#1e3a5f;">📄 Open</a>`;
                        }
                        
                        // CQ (Comparison Quote) document link
                        const cqUrl = getUrl(docs.comparison_quote);
                        const cqLink = document.getElementById('cqLink-' + offerId);
                        if (cqLink && cqUrl) {
                            cqLink.innerHTML = `<a href="${cqUrl}" target="_blank" style="color:#8b5cf6;">📊 Open</a>`;
                        }
                    });
                    console.log('Document links loaded for', Object.keys(docsMap).length, 'offers');
                }
            } catch (error) {
                console.error('Error loading document links:', error);
            }
        }
        async function generateAllDocsFromOffer(offerId, clientId) {
            const ndaLink = document.getElementById('ndaLink-' + offerId);
            const dpaLink = document.getElementById('dpaLink-' + offerId);
            const asaLink = document.getElementById('asaLink-' + offerId);
            const proposalLink = document.getElementById('proposalLink-' + offerId);
            const allStatus = document.getElementById('allStatus-' + offerId);
            
            // Show loading on all
            if (ndaLink) ndaLink.innerHTML = '<span style="color:#f39c12;">⏳...</span>';
            if (dpaLink) dpaLink.innerHTML = '<span style="color:#f39c12;">⏳...</span>';
            if (asaLink) asaLink.innerHTML = '<span style="color:#f39c12;">⏳...</span>';
            if (proposalLink) proposalLink.innerHTML = '<span style="color:#f39c12;">⏳...</span>';
            if (allStatus) allStatus.innerHTML = '<span style="color:#f39c12;">⏳</span>';
            
            try {
                // 1. Generate NDA
                const ndaUrl = API_URL + '?action=createNDA&clientId=' + encodeURIComponent(clientId) + '&offerId=' + encodeURIComponent(offerId);
                const ndaResponse = await fetch(ndaUrl);
                const ndaResult = await ndaResponse.json();
                if (ndaResult.success && ndaLink) {
                    ndaLink.innerHTML = `<a href="${ndaResult.fileUrl}" target="_blank" style="color:#e67e22;">📜 Open</a>`;
                }
                
                // 2. Generate DPA
                const dpaUrl = API_URL + '?action=createDPA&clientId=' + encodeURIComponent(clientId) + '&offerId=' + encodeURIComponent(offerId);
                const dpaResponse = await fetch(dpaUrl);
                const dpaResult = await dpaResponse.json();
                if (dpaResult.success && dpaLink) {
                    dpaLink.innerHTML = `<a href="${dpaResult.fileUrl}" target="_blank" style="color:#9b59b6;">🔒 Open</a>`;
                }
                
                // 3. Generate ASA
                const asaUrl = API_URL + '?action=createASAFromOffer&offerId=' + encodeURIComponent(offerId);
                const asaResponse = await fetch(asaUrl);
                const asaResult = await asaResponse.json();
                if (asaResult.success && asaLink) {
                    asaLink.innerHTML = `<a href="${asaResult.fileUrl}" target="_blank" style="color:#27ae60;">📋 Open</a>`;
                }
                
                // 4. Generate Proposal
                const proposalUrl = API_URL + '?action=createProposalFromOffer&offerId=' + encodeURIComponent(offerId);
                const proposalResponse = await fetch(proposalUrl);
                const proposalResult = await proposalResponse.json();
                if (proposalResult.success && proposalLink) {
                    proposalLink.innerHTML = `<a href="${proposalResult.fileUrl}" target="_blank" style="color:#1e3a5f;">📄 Open</a>`;
                }
                
                // Update All status
                const successCount = [ndaResult, dpaResult, asaResult, proposalResult].filter(r => r && r.success).length;
                if (allStatus) {
                    allStatus.innerHTML = successCount === 4 ? 
                        '<span style="color:#27ae60;">✅</span>' : 
                        `<span style="color:#f39c12;">${successCount}/4</span>`;
                }
                
            } catch (error) {
                console.error('Document generation error:', error);
                if (allStatus) allStatus.innerHTML = '<span style="color:#e74c3c;">❌</span>';
            }
        }
        
        // ═══════════════════════════════════════════════════════════════════
        // OFFER → CONTRACT WORKFLOW FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════
        
        async function sendOfferForSignature(offerId) {
            // Find the offer in loaded data
            const offer = offersData.find(o => o.offer_id === offerId);
            if (!offer) {
                alert('Offer not found: ' + offerId);
                return;
            }
            
            console.log('Opening Send for Signature for offer:', offer);
            
            // Get CLIENT NAME from offer
            let clientName = offer.client_name || 'Unknown Client';
            
            // Get contact info DIRECTLY from offer
            let contactName = offer.contact_person || '';
            let contactEmail = offer.contact_email || '';
            
            // If not in offer, try to get from client_info
            if (offer.client_info) {
                if (!contactName) contactName = offer.client_info.contact_name || '';
                if (!contactEmail) contactEmail = offer.client_info.contact_email || '';
            }
            
            // Extract program names from offer items
            const programs = [];
            if (offer.items && Array.isArray(offer.items)) {
                offer.items.forEach(item => {
                    if (item.plan_name && !programs.includes(item.plan_name)) {
                        programs.push(item.plan_name);
                    }
                });
            }
            
            // Prepare offer data for the modal - WITH SIGNATURE FLAG
            const isComparison = offer.offer_id && offer.offer_id.startsWith('CQ-');
            const offerData = {
                offerId: offer.offer_id,
                clientId: offer.client_id,
                clientName: clientName,
                contactName: contactName || 'Unknown Contact',
                contactEmail: contactEmail,
                programs: programs,
                items: offer.items, // Include items for program highlighting
                status: offer.status,
                totalMembers: offer.total_members,
                grandTotal: offer.grand_total_usd,
                forSignature: true,  // FLAG: This is for signature - will update status after send
                isComparison: isComparison  // FLAG: Is this a Comparison Quote?
            };
            
            console.log('Opening Email Center for signature with:', offerData);
            console.log('isComparison:', isComparison);
            
            // Open the Send Documents modal (status will update after email is sent)
            openSendDocumentsModal(offerData);
        }
        
        async function markOfferAsSigned(offerId) {
            if (!confirm('Mark this offer as SIGNED?\n\nThis will update the status to "signed" and allow contract creation.')) {
                return;
            }
            
            try {
                console.log('Marking offer as signed:', offerId);
                
                const url = API_URL + '?action=markOfferAsSigned&offerId=' + encodeURIComponent(offerId);
                const response = await fetch(url);
                const result = await response.json();
                
                console.log('Result:', result);
                
                if (result.success) {
                    alert('✅ Offer marked as signed!');
                    loadOffers(); // Refresh table
                } else {
                    alert('❌ Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('markOfferAsSigned error:', error);
                alert('❌ Error updating status: ' + error.message);
            }
        }
        
        async function createContractFromOfferUI(offerId) {
            if (!confirm('Create a new CONTRACT from this offer?\n\nThis will:\n1. Create a new contract record\n2. Update offer status to "converted"')) {
                return;
            }
            
            try {
                console.log('Creating contract from offer:', offerId);
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'createContractFromOffer',
                        offerId: offerId
                    })
                });
                
                const result = await response.json();
                console.log('Result:', result);
                
                if (result.success) {
                    alert('✅ Contract created!\n\nContract ID: ' + result.data.contract_id);
                    loadOffers(); // Refresh offers table
                    
                    // Ask if user wants to go to Contract Center
                    if (confirm('Go to Contract Center now?')) {
                        showPage('contractCenter');
                        setTimeout(() => loadContracts(), 500);
                    }
                } else {
                    alert('❌ Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('createContractFromOfferUI error:', error);
                alert('❌ Error creating contract: ' + error.message);
            }
        }
        
        // Cache for clients data (use window scope for cross-module access)
        window.cachedClientsData = window.cachedClientsData || null;
        let clientsDataLoaded = false;
        
        async function loadOfferClients() {
            const select = document.getElementById('offerClientSelect');
            if (!select) return;
            
            // Keep first two options
            const firstOptions = '<option value="">-- Select a client or enter new --</option><option value="new">+ Add New Client</option>';
            select.innerHTML = firstOptions;
            
            // Use cached data if available
            if (clientsDataLoaded && window.cachedClientsData) {
                window.cachedClientsData.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.client_id;
                    // API returns contacts - use contact_name as display name
                    option.textContent = c.client_name || c.contact_name || c.name || 'Unknown';
                    option.dataset.email = c.contact_email || c.email || '';
                    option.dataset.contact = c.contact_person || c.contact_name || '';
                    select.appendChild(option);
                });
                return;
            }
            
            try {
                const response = await fetch(API_URL + '?action=getClients');
                const clients = await response.json();
                
                const clientList = clients.data || clients;
                if (Array.isArray(clientList)) {
                    window.cachedClientsData = clientList;
                    clientsDataLoaded = true;
                    
                    clientList.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.client_id;
                        // API returns contacts - use contact_name as display name
                        option.textContent = c.client_name || c.contact_name || c.name || 'Unknown';
                        option.dataset.email = c.contact_email || c.email || '';
                        option.dataset.contact = c.contact_person || c.contact_name || '';
                        select.appendChild(option);
                    });
                    console.log('✅ Clients loaded:', clientList.length, 'items');
                }
            } catch (e) {
                console.error('Error loading clients:', e);
            }
        }
        
        // Force refresh clients data
        function refreshClientsData() {
            window.cachedClientsData = null;
            clientsDataLoaded = false;
            loadOfferClients();
        }
        
        function handleOfferClientChange() {
            const select = document.getElementById('offerClientSelect');
            console.log('handleOfferClientChange called, value:', select.value);
            if (select.value === 'new') {
                console.log('Opening Add Client Modal...');
                // Open the Add New Client modal
                const modal = document.getElementById('addClientModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.style.display = 'flex';
                    console.log('Modal opened');
                } else {
                    console.error('addClientModal not found!');
                }
                // Reset selection so user can select again after closing
                select.value = '';
            }
        }
        
        // Override saveNewClient to also update Offers dropdown
        const originalSaveNewClient = saveNewClient;
        async function saveNewClientWithOffersUpdate() {
            const clientName = document.getElementById('clientName').value.trim();
            const contactPerson = document.getElementById('clientContactPerson').value.trim();
            const email = document.getElementById('clientEmail').value.trim();
            const signatoryName = document.getElementById('clientSignatoryName').value.trim();
            const signatoryTitle = document.getElementById('clientSignatoryTitle').value.trim();
            
            // Validation
            if (!clientName) { showClientStatus('Company Name is required', 'error'); return; }
            if (!contactPerson) { showClientStatus('Contact Person is required', 'error'); return; }
            if (!email) { showClientStatus('Email is required', 'error'); return; }
            if (!signatoryName || !signatoryTitle) { showClientStatus('Signatory Name and Title are required', 'error'); return; }
            
            // Hierarchy validation
            const clientType = document.getElementById('clientType').value;
            const parentClientId = document.getElementById('parentClientId').value;
            if (clientType === 'subsidiary' && !parentClientId) {
                showClientStatus('Please select a Parent Company for this subsidiary', 'error');
                return;
            }

const clientData = {
    client_name: clientName,
    client_short: document.getElementById('clientShort').value.trim() || clientName.substring(0, 20),
    plan_id: document.getElementById('clientPlanId').value || '',
    contract_start: document.getElementById('clientContractStart').value || '',
    contract_end: document.getElementById('clientContractEnd').value || '',
    status: document.getElementById('clientStatus').value || 'active',
    tin_number: document.getElementById('clientTIN').value.trim(),
    registered_address: document.getElementById('clientRegAddress').value.trim(),
    operating_address: document.getElementById('clientOpAddress').value.trim(),
    vat_number: document.getElementById('clientVAT').value.trim(),
    contact_name: contactPerson,
    contact_capacity: document.getElementById('clientCapacity').value.trim(),
    contact_email: email,
    contact_phone: document.getElementById('clientPhone').value.trim(),
    mobile: document.getElementById('clientMobile').value.trim(),
    fax: document.getElementById('clientFax').value.trim(),
    authorized_signatory_name: signatoryName,
    authorized_signatory_title: signatoryTitle,
    portal_url: document.getElementById('clientPortalUrl').value.trim(),
    portal_username: document.getElementById('clientPortalUsername').value.trim(),
    portal_password: document.getElementById('clientPortalPassword').value.trim(),
    is_primary: 'TRUE'
};

            
            showClientStatus('Saving client...', 'info');
            
           try {
    // Use GET request to avoid CORS issues
    const url = API_URL + '?action=addClient&client=' + encodeURIComponent(JSON.stringify(clientData));
    console.log('Creating client via GET:', url.substring(0, 150) + '...');
    const response = await fetch(url);
    const result = await response.json();
                if (result.success) {
                    showClientStatus('✅ ' + result.message, 'success');
                    // Reload both dropdowns
                    loadClientsForContractDropdowns();
                    loadOfferClients(); // Also reload Offers dropdown
                    setTimeout(() => {
                        closeAddClientModal();
                        // Select the newly created client in Offers if that was the source
                        if (result.client_id) {
                            const offerSelect = document.getElementById('offerClientSelect');
                            if (offerSelect) {
                                setTimeout(() => {
                                    offerSelect.value = result.client_id;
                                }, 500);
                            }
                        }
                    }, 1500);
                } else {
                    showClientStatus('Error: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (e) {
                showClientStatus('Error: ' + e.message, 'error');
            }
        }
        
        function selectOfferTier(btn) {
            document.querySelectorAll('.offer-tier-btn').forEach(b => {
                b.style.background = 'white';
                b.style.color = '#333';
            });
            btn.style.background = '#1e3a5f';
            btn.style.color = 'white';
            
            currentOfferTier = parseInt(btn.dataset.tier);
            const min = btn.dataset.min;
            const max = btn.dataset.max === '9999' ? '+' : btn.dataset.max;
            document.getElementById('currentTierBadge').textContent = `Tier ${currentOfferTier}: ${min}-${max} members`;
            
            renderOfferPlanCards();
            calculateOfferTotals();
        }
        
        function renderOfferPlanCards() {
            const container = document.getElementById('offerPlansGrid');
            const tierIndex = currentOfferTier - 1;
            
            container.innerHTML = Object.values(OFFER_PLANS).map(plan => `
                <div class="offer-plan-card" id="offerPlan_${plan.id}" data-plan="${plan.id}" style="border: 2px solid #dee2e6; border-radius: 12px; overflow: hidden; transition: all 0.3s ease;">
                    <div style="background: ${plan.color}; color: white; padding: 18px 22px; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;">
                        <div style="text-align: left;">
                            <div style="font-size: 18px; font-weight: 700;">${plan.limits}</div>
                            <div style="font-size: 12px; opacity: 0.85;">PHP ${plan.mbl.toLocaleString()} MBL</div>
                        </div>
                        <div style="font-size: 20px; font-weight: 700; text-align: center;">${plan.displayName || 'POLARIS ' + plan.name.toUpperCase()}</div>
                        <div style="text-align: right;">
                            <input type="checkbox" class="offer-plan-checkbox" data-plan="${plan.id}" onchange="toggleOfferPlan('${plan.id}')" style="width: 28px; height: 28px; cursor: pointer;">
                        </div>
                    </div>
                    <div style="padding: 22px; background: white;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 18px;">
                            <div style="background: #f8f9fa; padding: 14px; border-radius: 8px; text-align: center;">
                                <div style="color: #666; font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Registration</div>
                                <div style="font-weight: 700; color: #1e3a5f; font-size: 20px;">$${plan.reg}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 14px; border-radius: 8px; text-align: center;">
                                <div style="color: #666; font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Fund Deposit</div>
                                <div style="font-weight: 700; color: #1e3a5f; font-size: 20px;">$${plan.fund[tierIndex]}</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                            <div style="text-align: center;">
                                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 6px; text-transform: uppercase; font-weight: 500;">Principals</label>
                                <input type="number" class="offer-principals" data-plan="${plan.id}" value="0" min="0" oninput="debouncedUpdatePlan('${plan.id}')" style="width: 100%; padding: 14px; border: 2px solid #dee2e6; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700;">
                            </div>
                            <div style="text-align: center;">
                                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 6px; text-transform: uppercase; font-weight: 500;">Dependents</label>
                                <input type="number" class="offer-dependents" data-plan="${plan.id}" value="0" min="0" oninput="debouncedUpdatePlan('${plan.id}')" style="width: 100%; padding: 14px; border: 2px solid #dee2e6; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700;">
                            </div>
                            <div style="text-align: center;">
                                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 6px; text-transform: uppercase; font-weight: 500;">Total</label>
                                <input type="text" class="offer-total" data-plan="${plan.id}" value="0" readonly style="width: 100%; padding: 14px; border: 2px solid #1e3a5f; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; background: #1e3a5f; color: white;">
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Debounce function to prevent rapid re-calculations
        let updatePlanTimeout = null;
        function debouncedUpdatePlan(planId) {
            if (updatePlanTimeout) clearTimeout(updatePlanTimeout);
            updatePlanTimeout = setTimeout(() => {
                updateOfferPlanTotal(planId);
            }, 200);
        }
        
        function toggleOfferPlan(planId) {
            const card = document.getElementById('offerPlan_' + planId);
            const checkbox = card.querySelector('.offer-plan-checkbox');
            
            if (checkbox.checked) {
                card.style.borderColor = '#d4a843';
                card.style.boxShadow = '0 5px 20px rgba(212, 168, 67, 0.3)';
            } else {
                card.style.borderColor = '#dee2e6';
                card.style.boxShadow = 'none';
            }
            
            calculateOfferTotals();
        }
        
        // Custom Plans Functions
        function openCustomPlanModal() {
            document.getElementById('customPlanModal').style.display = 'flex';
        }
        
        function closeCustomPlanModal() {
            document.getElementById('customPlanModal').style.display = 'none';
            // Clear all fields
            const fields = ['customPlanName', 'customMBL', 'customOPBL', 'customRegFee', 'customFundDeposit', 
                           'customMgmtFee', 'customMgmtMin', 'customClaimFee', 'customDentalFee', 'customRoomRate'];
            fields.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        }
        
        async function saveCustomPlan() {
            const name = document.getElementById('customPlanName').value.trim();
            const mbl = parseInt(document.getElementById('customMBL').value) || 0;
            const opbl = parseInt(document.getElementById('customOPBL').value) || 0;
            const reg = parseFloat(document.getElementById('customRegFee').value) || 0;
            const fund = parseFloat(document.getElementById('customFundDeposit').value) || 0;
            const mgmtFee = parseFloat(document.getElementById('customMgmtFee').value) || 0.75;
            const claimFee = parseFloat(document.getElementById('customClaimFee').value) || 15;
            const dentalFee = parseFloat(document.getElementById('customDentalFee').value) || 9.50;
            const roomType = document.getElementById('customRoomType').value;
            
            if (!name || !mbl || !reg || !fund) {
                alert('Please fill in required fields: Plan Name, MBL, Registration Fee, Fund Deposit');
                return;
            }
            
            // Calculate tier discounts (5% reduction per tier)
            const fundT1 = fund;
            const fundT2 = Math.round(fund * 0.95 * 100) / 100;
            const fundT3 = Math.round(fund * 0.90 * 100) / 100;
            const fundT4 = Math.round(fund * 0.85 * 100) / 100;
            
            // Prepare data for database
            const programData = {
                name: name,
                displayName: 'POLARIS ' + name.toUpperCase(),
                limits: `${Math.round(mbl/1000)}/${Math.round(opbl/1000)}`,
                mbl: mbl,
                opbl: opbl,
                roomType: roomType,
                regFee: reg,
                fundT1: fundT1,
                fundT2: fundT2,
                fundT3: fundT3,
                fundT4: fundT4,
                dentalFee: dentalFee,
                mgmtFee: mgmtFee,
                claimPct: claimFee,
                color: '#6f42c1',
                description: 'Custom program created via dashboard'
            };
            
            try {
                // Show saving indicator
                const saveBtn = document.querySelector('#customPlanModal button[onclick="saveCustomPlan()"]');
                const originalText = saveBtn ? saveBtn.innerHTML : '';
                if (saveBtn) saveBtn.innerHTML = '⏳ Saving...';
                
                // Save to database
                const response = await fetch(API_URL + '?action=createProgram&data=' + encodeURIComponent(JSON.stringify(programData)));
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ Program "' + result.display_name + '" created successfully!\n\nThe program is now available in the database.');
                    
                    // Reload programs from DB to include the new one
                    programsLoaded = false;
                    await loadProgramsFromDB();
                    syncPlansFromPrograms();
                    
                    // Re-render plan cards
                    renderOfferPlanCards();
                    
                    closeCustomPlanModal();
                } else {
                    alert('❌ Error creating program: ' + (result.error || 'Unknown error'));
                    if (saveBtn) saveBtn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Error saving custom plan:', error);
                alert('❌ Error saving program: ' + error.message);
            }
        }
        
        function renderCustomPlans() {
            const container = document.getElementById('customPlansContainer');
            if (!container) return;
            
            const tierIndex = currentOfferTier - 1;
            
            if (customPlans.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = customPlans.map(plan => `
                <div class="offer-plan-card" id="offerPlan_${plan.id}" data-plan="${plan.id}" style="border: 2px solid #dee2e6; border-radius: 12px; overflow: hidden; background: white;">
                    <div style="background: #6f42c1; color: white; padding: 18px 22px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 20px; font-weight: 700;">POLARIS ${plan.name}</div>
                            <div style="font-size: 13px; opacity: 0.9;">${plan.limits} • PHP ${plan.mbl.toLocaleString()} MBL</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" class="offer-plan-checkbox" data-plan="${plan.id}" onchange="toggleOfferPlan('${plan.id}')" style="width: 28px; height: 28px; cursor: pointer;">
                            <button onclick="deleteCustomPlan('${plan.id}')" style="background: #dc3545; color: white; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 18px;">&times;</button>
                        </div>
                    </div>
                    <div style="padding: 22px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 18px;">
                            <div style="background: #f8f9fa; padding: 14px; border-radius: 8px; text-align: center;">
                                <div style="color: #666; font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Registration</div>
                                <div style="font-weight: 700; color: #1e3a5f; font-size: 20px;">$${plan.reg}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 14px; border-radius: 8px; text-align: center;">
                                <div style="color: #666; font-size: 12px; text-transform: uppercase; margin-bottom: 4px;">Fund Deposit</div>
                                <div style="font-weight: 700; color: #1e3a5f; font-size: 20px;">$${plan.fund[tierIndex].toFixed(0)}</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                            <div style="text-align: center;">
                                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 6px; text-transform: uppercase; font-weight: 500;">Principals</label>
                                <input type="number" class="offer-principals" data-plan="${plan.id}" value="0" min="0" oninput="debouncedUpdatePlan('${plan.id}')" style="width: 100%; padding: 14px; border: 2px solid #dee2e6; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700;">
                            </div>
                            <div style="text-align: center;">
                                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 6px; text-transform: uppercase; font-weight: 500;">Dependents</label>
                                <input type="number" class="offer-dependents" data-plan="${plan.id}" value="0" min="0" oninput="debouncedUpdatePlan('${plan.id}')" style="width: 100%; padding: 14px; border: 2px solid #dee2e6; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700;">
                            </div>
                            <div style="text-align: center;">
                                <label style="display: block; font-size: 12px; color: #666; margin-bottom: 6px; text-transform: uppercase; font-weight: 500;">Total</label>
                                <input type="text" class="offer-total" data-plan="${plan.id}" value="0" readonly style="width: 100%; padding: 14px; border: 2px solid #1e3a5f; border-radius: 8px; text-align: center; font-size: 20px; font-weight: 700; background: #1e3a5f; color: white;">
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function deleteCustomPlan(planId) {
            if (confirm('Delete this custom plan?')) {
                customPlans = customPlans.filter(p => p.id !== planId);
                localStorage.setItem('polarisCustomPlans', JSON.stringify(customPlans));
                renderCustomPlans();
                calculateOfferTotals();
            }
        }
        
        function getAllPlans() {
            const all = { ...OFFER_PLANS };
            customPlans.forEach(cp => { all[cp.id] = cp; });
            return all;
        }
        
        function updateOfferPlanTotal(planId) {
            const card = document.getElementById('offerPlan_' + planId);
            if (!card) return;
            const principals = parseInt(card.querySelector('.offer-principals').value) || 0;
            const dependents = parseInt(card.querySelector('.offer-dependents').value) || 0;
            const total = principals + dependents;
            
            card.querySelector('.offer-total').value = total;
            
            // Auto-check if members entered
            const checkbox = card.querySelector('.offer-plan-checkbox');
            if (total > 0 && !checkbox.checked) {
                checkbox.checked = true;
                toggleOfferPlan(planId);
            }
            
            calculateOfferTotals();
        }
        
        function calculateOfferTotals() {
            const tierIndex = currentOfferTier - 1;
            const allPlans = getAllPlans();
            let totalPrincipals = 0;
            let totalDependents = 0;
            let regTotal = 0;
            let fundTotal = 0;
            let breakdownHTML = '';
            
            Object.values(allPlans).forEach(plan => {
                const card = document.getElementById('offerPlan_' + plan.id);
                if (!card) return;
                
                const checkbox = card.querySelector('.offer-plan-checkbox');
                if (checkbox && checkbox.checked) {
                    const principals = parseInt(card.querySelector('.offer-principals').value) || 0;
                    const dependents = parseInt(card.querySelector('.offer-dependents').value) || 0;
                    const total = principals + dependents;
                    
                    if (total > 0) {
                        totalPrincipals += principals;
                        totalDependents += dependents;
                        
                        const fundValue = Array.isArray(plan.fund) ? plan.fund[tierIndex] : plan.fund;
                        const pRegTotal = total * plan.reg;
                        const pFundTotal = total * fundValue;
                        regTotal += pRegTotal;
                        fundTotal += pFundTotal;
                        
                        breakdownHTML += `<div style="display:grid;grid-template-columns:2fr 0.8fr 0.8fr 0.8fr 1fr 1fr 1fr;gap:8px;padding:15px 18px;background:rgba(255,255,255,0.08);border-bottom:1px solid rgba(255,255,255,0.1);font-size:18px;">
                            <div><strong style="font-size:18px;">POLARIS ${plan.name}</strong><br><span style="opacity:0.7;font-size:14px;">${plan.limits}</span></div>
                            <div style="text-align:right;font-size:20px;">${principals.toLocaleString()}</div>
                            <div style="text-align:right;font-size:20px;">${dependents.toLocaleString()}</div>
                            <div style="text-align:right;font-weight:700;font-size:20px;">${total.toLocaleString()}</div>
                            <div style="text-align:right;font-size:20px;">$${pRegTotal.toLocaleString()}</div>
                            <div style="text-align:right;font-size:20px;">$${pFundTotal.toLocaleString()}</div>
                            <div style="text-align:right;color:#d4a843;font-weight:bold;font-size:22px;">$${(pRegTotal + pFundTotal).toLocaleString()}</div>
                        </div>`;
                    }
                }
            });
            
            const grandTotalMembers = totalPrincipals + totalDependents;
            const dentalIncluded = document.getElementById('offerDentalCheckbox')?.checked || false;
            const dentalTotal = dentalIncluded ? grandTotalMembers * DENTAL_FEE : 0;
            const annualTotal = regTotal + fundTotal + dentalTotal;
            
            // Update display
            document.getElementById('offerTotalPrincipals').textContent = totalPrincipals.toLocaleString();
            document.getElementById('offerTotalDependents').textContent = totalDependents.toLocaleString();
            document.getElementById('offerGrandTotalMembers').textContent = grandTotalMembers.toLocaleString();
            document.getElementById('offerRegTotal').textContent = regTotal.toLocaleString();
            document.getElementById('offerFundTotal').textContent = fundTotal.toLocaleString();
            document.getElementById('offerDentalTotal').textContent = dentalTotal.toLocaleString();
            document.getElementById('offerAnnualTotal').textContent = annualTotal.toLocaleString();
            
            // Update plan breakdown
            const breakdownContainer = document.getElementById('offerPlanBreakdown');
            if (breakdownHTML) {
                breakdownContainer.innerHTML = `<div style="background:rgba(0,0,0,0.2);padding:14px 18px;font-size:14px;text-transform:uppercase;display:grid;grid-template-columns:2fr 0.8fr 0.8fr 0.8fr 1fr 1fr 1fr;gap:8px;opacity:0.9;font-weight:600;">
                    <div>Plan</div><div style="text-align:right;">Principals</div><div style="text-align:right;">Dependents</div><div style="text-align:right;">Members</div><div style="text-align:right;">Reg Fee</div><div style="text-align:right;">Fund Dep</div><div style="text-align:right;">Subtotal</div>
                </div>${breakdownHTML}`;
            } else {
                breakdownContainer.innerHTML = '';
            }
            
            // Auto-select tier based on total
            autoSelectOfferTier(grandTotalMembers);
        }
        
        function autoSelectOfferTier(total) {
            // Don't auto-select if total is 0 or very small
            if (total < 10) return;
            
            let newTier;
            if (total <= 500) newTier = 1;
            else if (total <= 750) newTier = 2;
            else if (total <= 1100) newTier = 3;
            else newTier = 4;
            
            // Only update if tier actually changed AND we're not already in a calculation
            if (newTier !== currentOfferTier) {
                // Just update the badge text, don't re-render cards
                const badge = document.getElementById('currentTierBadge');
                if (badge) {
                    const tierRanges = {1: '1-500', 2: '501-750', 3: '751-1100', 4: '1100+'};
                    badge.textContent = `Tier ${newTier}: ${tierRanges[newTier]} members`;
                }
                // Update button styles without triggering selectOfferTier
                document.querySelectorAll('.offer-tier-btn').forEach(btn => {
                    const btnTier = parseInt(btn.dataset.tier);
                    if (btnTier === newTier) {
                        btn.style.background = '#1e3a5f';
                        btn.style.color = 'white';
                        btn.style.borderColor = '#1e3a5f';
                    } else {
                        btn.style.background = 'white';
                        btn.style.color = '#333';
                        btn.style.borderColor = '#dee2e6';
                    }
                });
                currentOfferTier = newTier;
            }
        }
        
        function updateOfferValidityDate() {
            const daysInput = document.getElementById('offerValidityDays');
            if (!daysInput) return;
            
            const days = parseInt(daysInput.value) || 30;
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + days);
            
            const expirySpan = document.getElementById('offerExpiryDate');
            if (expirySpan) {
                expirySpan.textContent = expiryDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
        }
        
        function getOfferClientName() {
            const select = document.getElementById('offerClientSelect');
            if (select.value === '' || select.value === 'new') return 'Prospective Client';
            return select.options[select.selectedIndex].text;
        }
        
        function getSelectedOfferPlans() {
            const selected = [];
            const tierIndex = currentOfferTier - 1;
            
            Object.values(OFFER_PLANS).forEach(plan => {
                const card = document.getElementById('offerPlan_' + plan.id);
                if (!card) return;
                
                const checkbox = card.querySelector('.offer-plan-checkbox');
                if (checkbox && checkbox.checked) {
                    const principals = parseInt(card.querySelector('.offer-principals').value) || 0;
                    const dependents = parseInt(card.querySelector('.offer-dependents').value) || 0;
                    const total = principals + dependents;
                    
                    if (total > 0) {
                        selected.push({
                            program_id: plan.id,
                            plan: plan.name,
                            limits: plan.limits,
                            mbl: plan.mbl,
                            principals,
                            dependents,
                            total,
                            regFee: plan.reg,
                            fundDeposit: plan.fund[tierIndex]
                        });
                    }
                }
            });
            
            return selected;
        }
        
        function resetOfferForm() {
            // Reset client selection
            document.getElementById('offerClientSelect').value = '';
            
            // Reset tier
            currentOfferTier = 1;
            document.querySelectorAll('.offer-tier-btn').forEach((btn, i) => {
                if (i === 0) {
                    btn.style.background = '#1e3a5f';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#333';
                }
            });
            document.getElementById('currentTierBadge').textContent = 'Tier 1: 1-500 members';
            
            // Reset dental
            const dentalCheckbox = document.getElementById('offerDentalCheckbox');
            if (dentalCheckbox) dentalCheckbox.checked = false;
            
            // Reset validity
            const validityInput = document.getElementById('offerValidityDays');
            if (validityInput) validityInput.value = 30;
            updateOfferValidityDate();
            
            // Reset notes
            const notesField = document.getElementById('offerNotes');
            if (notesField) notesField.value = '';
            
            // Re-render plan cards (this resets all values)
            renderOfferPlanCards();
            calculateOfferTotals();
        }
        
        async function saveOfferDraft() {
            const plans = getSelectedOfferPlans();
            if (plans.length === 0) {
                alert('Please select at least one plan with members.');
                return;
            }
            
            const clientSelect = document.getElementById('offerClientSelect');
            let clientId = clientSelect.value;
            let clientName = getOfferClientName();
            let contactPerson = '';
            let contactEmail = '';
            
            if (clientId === 'new' || clientId === '') {
                // No client selected - offer can still be saved as draft
                clientName = 'Prospective Client';
                contactPerson = '';
                contactEmail = '';
                clientId = '';
            } else if (clientId) {
                const selectedOption = clientSelect.options[clientSelect.selectedIndex];
                contactEmail = selectedOption.dataset.email || '';
                contactPerson = selectedOption.dataset.contact || '';
            }
            
            // Map plans to items format expected by API
            const items = plans.map(plan => ({
                program_id: plan.program_id,
                principals: plan.principals,
                dependents: plan.dependents
            }));
            
            const offerData = {
                client_id: clientId,
                client_name: clientName,
                contact_person: contactPerson,
                contact_email: contactEmail,
                tier: currentOfferTier,
                includes_dental: document.getElementById('offerDentalCheckbox')?.checked || false,
                validity_days: parseInt(document.getElementById('offerValidityDays')?.value) || 30,
                notes: document.getElementById('offerNotes')?.value || '',
                items: items,
                created_by: currentUser?.full_name || 'Admin'
            };
            
            // Show loading state
            const saveBtn = document.querySelector('button[onclick="saveOfferDraft()"]');
            const originalText = saveBtn ? saveBtn.innerHTML : '';
            if (saveBtn) {
                saveBtn.innerHTML = '⏳ Saving...';
                saveBtn.disabled = true;
            }
            
            try {
                console.log('Saving offer:', offerData);
                
                // Use POST for larger data
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify({
                        action: 'createOffer',
                        offerData: offerData
                    })
                });
                
                const result = await response.json();
                console.log('Save result:', result);
                
                if (result.success) {
                    alert('✅ Offer saved successfully!\n\n' +
                          '📋 Offer ID: ' + result.offer_id + '\n' +
                          '👥 Total Members: ' + result.total_members + '\n' +
                          '💰 Grand Total: $' + (result.grand_total || 0).toLocaleString());
                    
                    resetOfferForm();
                    
                    // Switch to list view and refresh
                    if (typeof switchOffersTab === 'function') {
                        switchOffersTab('list');
                    }
                    if (typeof loadOffers === 'function') {
                        loadOffers(); // This now also updates stats
                    }
                } else {
                    alert('❌ Error saving offer:\n' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Error saving offer:', e);
                alert('❌ Error saving offer:\n' + e.message);
            } finally {
                // Restore button state
                if (saveBtn) {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }
            }
        }
        
        function generateOfferEmailPreview() {
            const plans = getSelectedOfferPlans();
            if (plans.length === 0) {
                alert('Please select at least one plan with members.');
                return;
            }
            
            const clientName = getOfferClientName();
            const clientSelect = document.getElementById('offerClientSelect');
            const clientId = clientSelect.value;
            
            const dentalIncluded = document.getElementById('offerDentalCheckbox')?.checked || false;
            const validityDays = document.getElementById('offerValidityDays')?.value || 30;
            
            // Calculate totals
            let totalPrincipals = 0;
            let totalDependents = 0;
            
            plans.forEach(p => {
                totalPrincipals += p.principals;
                totalDependents += p.dependents;
            });
            
            const grandTotal = totalPrincipals + totalDependents;
            
            // Generate Offer ID
            const year = new Date().getFullYear();
            const offerId = 'OFF-' + year + '-DRAFT';
            
            // Expiry date
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + parseInt(validityDays));
            const expiryDateStr = expiryDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            
            // Build SIMPLE plan table (NO COSTS - just programs and members)
            let planTableHtml = '';
            plans.forEach(p => {
                const roomType = p.plan.toLowerCase().includes('gold+') ? 'Private Room' : 'Semi-Private Room';
                planTableHtml += `
                    <tr>
                        <td style="padding: 12px 15px; border-bottom: 1px solid #e0e0e0;">
                            <strong style="color: #1e3a5f;">POLARIS ${p.plan.toUpperCase()}</strong><br>
                            <span style="color: #666; font-size: 12px;">${p.limits} • PHP ${(p.mbl || 0).toLocaleString()} MBL • ${roomType}</span>
                        </td>
                        <td align="center" style="padding: 12px; border-bottom: 1px solid #e0e0e0; color: #333;">${p.principals.toLocaleString()}</td>
                        <td align="center" style="padding: 12px; border-bottom: 1px solid #e0e0e0; color: #333;">${p.dependents.toLocaleString()}</td>
                        <td align="center" style="padding: 12px; border-bottom: 1px solid #e0e0e0; color: #1e3a5f; font-weight: bold;">${p.total.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            // Build SIMPLIFIED email HTML (no costs, more welcoming text)
            const emailHtml = `
                <table cellpadding="0" cellspacing="0" border="0" width="100%" style="font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto; color: #333333; line-height: 1.7;">
                    <!-- Header -->
                    <tr>
                        <td bgcolor="#1e3a5f" style="padding: 25px 30px;">
                            <table cellpadding="0" cellspacing="0" border="0" width="100%">
                                <tr>
                                    <td valign="middle">
                                        <span style="color: #ffffff; font-size: 22px; font-weight: bold;">✦ POLARIS </span><span style="color: #d4a843; font-size: 22px; font-weight: bold;">Financial Services</span><br>
                                        <span style="color: #b0b0b0; font-size: 13px;">Healthcare TPA Solutions for the Maritime Industry</span>
                                    </td>
                                    <td align="right" valign="middle">
                                        <span style="color: #b0b0b0; font-size: 11px;">Reference</span><br>
                                        <span style="color: #d4a843; font-size: 15px; font-weight: bold;">${offerId}</span>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                    <!-- Body -->
                    <tr>
                        <td bgcolor="#ffffff" style="padding: 30px; border: 1px solid #e0e0e0; border-top: none;">
                            
                            <p id="offerEmailGreeting" style="margin: 0 0 20px 0; font-size: 15px;">Dear Sir/Madam,</p>
                            
                            <p style="margin: 0 0 20px 0; font-size: 15px;">Warm greetings from <strong style="color: #1e3a5f;">Polaris Financial Services</strong>!</p>
                            
                            <p style="margin: 0 0 20px 0; font-size: 15px;">Following our recent discussions, we are pleased to present our healthcare TPA services proposal for <strong style="color: #1e3a5f;">${clientName}</strong>.</p>
                            
                            <p style="margin: 0 0 20px 0; font-size: 15px;">With over <strong>8 years of experience</strong> serving the maritime industry and having successfully managed more than <strong>90,000 medical cases</strong> in the Philippines, we are confident that Polaris can provide exceptional healthcare management services for your seafarers and their families.</p>
                            
                            <p style="margin: 0 0 20px 0; font-size: 15px;">Based on our discussions, we have prepared a coverage scheme for <strong style="color: #d4a843;">${grandTotal.toLocaleString()} members</strong> (${totalPrincipals.toLocaleString()} seafarers + ${totalDependents.toLocaleString()} dependents):</p>
                            
                            <!-- Programs Table (NO COSTS) -->
                            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="margin: 25px 0; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                                <tr bgcolor="#1e3a5f">
                                    <td style="padding: 12px 15px; color: #ffffff; font-weight: bold;">Healthcare Program</td>
                                    <td align="center" style="padding: 12px; color: #ffffff; font-weight: bold;">Seafarers</td>
                                    <td align="center" style="padding: 12px; color: #ffffff; font-weight: bold;">Dependents</td>
                                    <td align="center" style="padding: 12px; color: #d4a843; font-weight: bold;">Total</td>
                                </tr>
                                ${planTableHtml}
                                <tr bgcolor="#f8f9fa">
                                    <td style="padding: 12px 15px; font-weight: bold; color: #1e3a5f;">TOTAL MEMBERS</td>
                                    <td align="center" style="padding: 12px; font-weight: bold;">${totalPrincipals.toLocaleString()}</td>
                                    <td align="center" style="padding: 12px; font-weight: bold;">${totalDependents.toLocaleString()}</td>
                                    <td align="center" style="padding: 12px; font-weight: bold; color: #d4a843; font-size: 16px;">${grandTotal.toLocaleString()}</td>
                                </tr>
                            </table>
                            
                            ${dentalIncluded ? `
                            <p style="margin: 0 0 20px 0; font-size: 15px;">🦷 <strong>Dental Benefits</strong> are included in this proposal for all members.</p>
                            ` : ''}
                            
                            <p style="margin: 0 0 20px 0; font-size: 15px;">Our services include:</p>
                            <ul style="margin: 0 0 20px 20px; font-size: 15px;">
                                <li>24/7 Medical Assistance Hotline</li>
                                <li>Access to our nationwide network of accredited hospitals and clinics</li>
                                <li>Dedicated Claims Management Team</li>
                                <li>Quarterly Performance Reports</li>
                                <li>Online Member Portal for real-time tracking</li>
                            </ul>
                            
                            <p style="margin: 0 0 20px 0; font-size: 15px;">Please find attached the <strong>detailed cost proposal</strong> and our <strong>Non-Disclosure Agreement (NDA)</strong> for your review.</p>
                            
                            <!-- Validity Box -->
                            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="margin: 25px 0;">
                                <tr>
                                    <td width="4" bgcolor="#d4a843"></td>
                                    <td bgcolor="#fff8e1" style="padding: 15px; font-size: 14px;">
                                        <strong>📅 Proposal Validity:</strong> This proposal is valid until <strong>${expiryDateStr}</strong> (${validityDays} days).
                                    </td>
                                </tr>
                            </table>
                            
                            <p style="margin: 0 0 20px 0; font-size: 15px;">We would be delighted to schedule a meeting to discuss this proposal in detail and answer any questions you may have.</p>
                            
                            <p style="margin: 0 0 20px 0; font-size: 15px;">Thank you for considering Polaris Financial Services. We look forward to the opportunity of working together.</p>
                            
                            <p style="margin: 0 0 10px 0; font-size: 15px;">Warm regards,</p>
                            
                            <!-- Signature -->
                            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="margin-top: 20px; border-top: 1px solid #e0e0e0;">
                                <tr>
                                    <td id="offerEmailSignature" style="padding-top: 20px;">
                                        <strong style="color: #1e3a5f;">Konstantinos Koutsiouris</strong><br>
                                        <span style="color: #666666; font-size: 13px;">Business Development</span><br>
                                        <span style="color: #666666; font-size: 13px;">Polaris Financial Services Ltd.</span><br>
                                        <span style="color: #666666; font-size: 13px;">📧 kkoutsiouris@polaris-finance.com</span>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    
                    <!-- Footer -->
                    <tr>
                        <td bgcolor="#1e3a5f" style="padding: 15px 30px; text-align: center;">
                            <span style="color: #b0b0b0; font-size: 12px;">Polaris Financial Services Ltd. | Healthcare TPA Solutions for the Maritime Industry</span><br>
                            <span style="color: #666; font-size: 11px;">www.polaris-finance.com</span>
                        </td>
                    </tr>
                </table>
            `;
            
            // Load senders and recipients
            loadOfferEmailSenders();
            if (clientId && clientId !== 'new') {
                loadOfferEmailRecipients(clientId);
            }
            
            // Set email values
            document.getElementById('offerEmailSubject').value = `Polaris Healthcare Proposal - ${clientName} [${offerId}]`;
            document.getElementById('offerEmailBody').innerHTML = emailHtml;
            document.getElementById('offerEmailTo').value = '';
            document.getElementById('offerEmailCC').value = '';
            
            // Reset recipient count
            document.getElementById('offerRecipientCount').textContent = '0 selected';
            
            // Show modal
            document.getElementById('offerEmailModal').style.display = 'flex';
        }
        
        function closeOfferEmailModal() {
            document.getElementById('offerEmailModal').style.display = 'none';
        }
        
        // ============================================
        // GMAIL API INTEGRATION
        // ============================================
        
        const GMAIL_CLIENT_ID = '672009743511-f88odvlcdfc7uu0rife6bhjlrsnm6fhi.apps.googleusercontent.com';
        const GMAIL_SCOPES = 'https://www.googleapis.com/auth/gmail.send https://www.googleapis.com/auth/gmail.compose';
        
        let gmailTokenClient;
        let gmailAccessToken = null;
        
        // Initialize Google Identity Services
        function initGmailAuth() {
            if (typeof google === 'undefined') {
                console.log('Google Identity Services not loaded yet');
                return;
            }
            
            gmailTokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GMAIL_CLIENT_ID,
                scope: GMAIL_SCOPES,
                callback: (response) => {
                    if (response.access_token) {
                        gmailAccessToken = response.access_token;
                        updateGmailConnectionStatus(true, response.email || 'Connected');
                        localStorage.setItem('gmail_access_token', gmailAccessToken);
                    }
                },
            });
            
            // Check for existing token
            const savedToken = localStorage.getItem('gmail_access_token');
            if (savedToken) {
                gmailAccessToken = savedToken;
                validateGmailToken(savedToken);
            }
        }
        
        // Validate existing token
        async function validateGmailToken(token) {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=' + token);
                if (response.ok) {
                    const data = await response.json();
                    updateGmailConnectionStatus(true, data.email);
                } else {
                    gmailAccessToken = null;
                    localStorage.removeItem('gmail_access_token');
                    updateGmailConnectionStatus(false);
                }
            } catch (error) {
                gmailAccessToken = null;
                localStorage.removeItem('gmail_access_token');
                updateGmailConnectionStatus(false);
            }
        }
        
        // Update Gmail status UI
        function updateGmailConnectionStatus(connected, email = '') {
            const statusEl = document.getElementById('gmailConnectionStatus');
            const btnEl = document.getElementById('gmailConnectBtn');
            
            if (statusEl && btnEl) {
                if (connected) {
                    statusEl.innerHTML = `<span style="color: #4CAF50;">✓ ${email}</span>`;
                    btnEl.textContent = 'Disconnect';
                    btnEl.onclick = disconnectGmail;
                } else {
                    statusEl.innerHTML = '<span style="color: #ff6b6b;">Not connected</span>';
                    btnEl.textContent = 'Connect Gmail';
                    btnEl.onclick = connectGmail;
                }
            }
        }
        
        // Connect to Gmail
        function connectGmail() {
            if (gmailTokenClient) {
                gmailTokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                alert('Google Identity Services not loaded. Please refresh the page.');
            }
        }
        
        // Disconnect from Gmail
        function disconnectGmail() {
            if (gmailAccessToken) {
                google.accounts.oauth2.revoke(gmailAccessToken);
            }
            gmailAccessToken = null;
            localStorage.removeItem('gmail_access_token');
            updateGmailConnectionStatus(false);
        }
        
        // Create RFC 2822 formatted email
        function createEmailMessage(to, subject, htmlBody) {
            const boundary = 'boundary_' + Date.now();
            const plainText = document.getElementById('offerEmailBody').innerText;
            
            const emailLines = [
                'MIME-Version: 1.0',
                'To: ' + to,
                'Subject: =?UTF-8?B?' + btoa(unescape(encodeURIComponent(subject))) + '?=',
                'Content-Type: multipart/alternative; boundary="' + boundary + '"',
                '',
                '--' + boundary,
                'Content-Type: text/plain; charset="UTF-8"',
                'Content-Transfer-Encoding: base64',
                '',
                btoa(unescape(encodeURIComponent(plainText))),
                '',
                '--' + boundary,
                'Content-Type: text/html; charset="UTF-8"',
                'Content-Transfer-Encoding: base64',
                '',
                btoa(unescape(encodeURIComponent(htmlBody))),
                '',
                '--' + boundary + '--'
            ];
            
            return btoa(unescape(encodeURIComponent(emailLines.join('\r\n'))))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }
        
        // Send email via Gmail API
        async function sendOfferViaGmail() {
            if (!gmailAccessToken) {
                alert('Please connect to Gmail first.');
                connectGmail();
                return;
            }
            
            const to = document.getElementById('offerEmailTo').value;
            if (!to || !to.includes('@')) {
                alert('Please enter a valid email address.');
                return;
            }
            
            const subject = document.getElementById('offerEmailSubject').value;
            const htmlBody = document.getElementById('offerEmailBody').innerHTML;
            
            // Show loading
            const sendBtn = document.querySelector('#offerEmailModal button[onclick="sendOfferViaGmail()"]');
            const originalText = sendBtn.innerHTML;
            sendBtn.innerHTML = '⏳ Sending...';
            sendBtn.disabled = true;
            
            try {
                const raw = createEmailMessage(to, subject, htmlBody);
                
                const response = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/send', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + gmailAccessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ raw: raw })
                });
                
                if (response.ok) {
                    alert('✅ Email sent successfully to ' + to + '!');
                    closeOfferEmailModal();
                } else {
                    const error = await response.json();
                    if (error.error?.code === 401) {
                        gmailAccessToken = null;
                        localStorage.removeItem('gmail_access_token');
                        updateGmailConnectionStatus(false);
                        alert('Session expired. Please reconnect to Gmail.');
                    } else {
                        alert('Failed to send email: ' + (error.error?.message || 'Unknown error'));
                    }
                }
            } catch (error) {
                alert('Error sending email: ' + error.message);
            } finally {
                sendBtn.innerHTML = originalText;
                sendBtn.disabled = false;
            }
        }
        
        // Create draft in Gmail
        async function createOfferGmailDraft() {
            if (!gmailAccessToken) {
                alert('Please connect to Gmail first.');
                connectGmail();
                return;
            }
            
            const to = document.getElementById('offerEmailTo').value;
            const subject = document.getElementById('offerEmailSubject').value;
            const htmlBody = document.getElementById('offerEmailBody').innerHTML;
            
            try {
                const raw = createEmailMessage(to, subject, htmlBody);
                
                const response = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/drafts', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + gmailAccessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: { raw: raw } })
                });
                
                if (response.ok) {
                    alert('✅ Draft created! Check your Gmail drafts folder.');
                    window.open('https://mail.google.com/mail/u/0/#drafts', '_blank');
                } else {
                    const error = await response.json();
                    alert('Failed to create draft: ' + (error.error?.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Error creating draft: ' + error.message);
            }
        }
        
        // Export email to PDF
        async function exportOfferEmailToPDF() {
            const emailBody = document.getElementById('offerEmailBody');
            
            try {
                // Create a temporary container with white background
                const tempContainer = document.createElement('div');
                tempContainer.style.cssText = 'position: absolute; left: -9999px; background: white; padding: 20px; width: 800px;';
                tempContainer.innerHTML = emailBody.innerHTML;
                document.body.appendChild(tempContainer);
                
                const canvas = await html2canvas(tempContainer, { scale: 2, backgroundColor: '#ffffff' });
                document.body.removeChild(tempContainer);
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 190;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, 10, imgWidth, imgHeight);
                
                const subject = document.getElementById('offerEmailSubject').value;
                const fileName = subject.replace(/[^a-zA-Z0-9]/g, '_') + '.pdf';
                pdf.save(fileName);
                
                alert('✅ PDF downloaded!');
            } catch (error) {
                alert('Error generating PDF: ' + error.message);
            }
        }
        
        // Copy email HTML to clipboard
        function copyOfferEmailHtml() {
            const emailBody = document.getElementById('offerEmailBody').innerHTML;
            
            const blob = new Blob([emailBody], { type: 'text/html' });
            const item = new ClipboardItem({ 
                'text/html': blob, 
                'text/plain': new Blob([document.getElementById('offerEmailBody').innerText], { type: 'text/plain' }) 
            });
            
            navigator.clipboard.write([item]).then(() => {
                alert('✅ HTML copied! Paste in Outlook with Ctrl+V');
            }).catch(err => {
                navigator.clipboard.writeText(emailBody).then(() => {
                    alert('✅ Content copied to clipboard!');
                });
            });
        }
        
        // Initialize Gmail auth when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initGmailAuth, 1000);
        });
        
        // ============================================
        // OFFER EMAIL - RECIPIENTS & SENDER
        // ============================================
        
        let offerEmailContacts = [];
        let offerEmailSelectedContacts = [];
        let offerEmailSenders = [];
        let currentOfferSender = null;
        
        // Load senders (Users with admin role)
        async function loadOfferEmailSenders() {
            const select = document.getElementById('offerEmailSender');
            if (!select) return;
            
            try {
                const response = await fetch(API_URL + '?action=getUsers');
                const users = await response.json();
                
                select.innerHTML = '<option value="">-- Select Sender --</option>';
                
                if (Array.isArray(users)) {
                    offerEmailSenders = users.filter(u => u.role === 'admin' && u.status === 'Active');
                    offerEmailSenders.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.username;
                        option.textContent = user.full_name;
                        option.dataset.email = user.email || '';
                        option.dataset.name = user.full_name || '';
                        select.appendChild(option);
                    });
                }
            } catch (e) {
                console.error('Error loading senders:', e);
            }
        }
        
        // Load recipients for selected client
        async function loadOfferEmailRecipients(clientId) {
            const container = document.getElementById('offerEmailRecipientsBox');
            if (!container) return;
            
            if (!clientId) {
                container.innerHTML = '<p style="color:#999; font-size:12px; text-align:center; margin:0;">Select a client first</p>';
                return;
            }
            
            container.innerHTML = '<p style="color:#999; font-size:12px; text-align:center; margin:0;">Loading contacts...</p>';
            
            try {
                const response = await fetch(API_URL + '?action=getClientContacts&clientId=' + clientId);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    offerEmailContacts = data.data;
                    renderOfferEmailRecipients();
                } else {
                    offerEmailContacts = [];
                    container.innerHTML = '<p style="color:#999; font-size:12px; text-align:center; margin:0;">No contacts found. Add CC manually.</p>';
                }
            } catch (e) {
                console.error('Error loading contacts:', e);
                container.innerHTML = '<p style="color:#999; font-size:12px; text-align:center; margin:0;">Error loading contacts</p>';
            }
        }
        
        function renderOfferEmailRecipients() {
            const container = document.getElementById('offerEmailRecipientsBox');
            
            if (offerEmailContacts.length === 0) {
                container.innerHTML = '<p style="color:#718096; font-size:14px; text-align:center; margin:0;">No contacts available</p>';
                return;
            }
            
            container.innerHTML = offerEmailContacts.map((contact, idx) => `
                <div style="display:flex; align-items:center; gap:12px; padding:10px 8px; border-bottom:1px solid #4a5568; transition:background 0.2s;" onmouseover="this.style.background='#2d3748'" onmouseout="this.style.background='transparent'">
                    <input type="checkbox" id="offerRecipient_${idx}" onchange="updateOfferRecipients()" style="cursor:pointer; width:20px; height:20px;">
                    <div style="flex:1; min-width:0;">
                        <div style="font-size:15px; font-weight:500; color:white; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${contact.contact_name}</div>
                        <div style="font-size:13px; color:#a0aec0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${contact.email}</div>
                    </div>
                    <span style="font-size:12px; background:#4a5568; padding:4px 10px; border-radius:4px; color:#d4a843; font-weight:500;">${contact.role || 'Contact'}</span>
                </div>
            `).join('');
        }
        
        function updateOfferRecipients() {
            offerEmailSelectedContacts = [];
            offerEmailContacts.forEach((contact, idx) => {
                const checkbox = document.getElementById('offerRecipient_' + idx);
                if (checkbox && checkbox.checked) {
                    offerEmailSelectedContacts.push(contact);
                }
            });
            
            // Update count
            document.getElementById('offerRecipientCount').textContent = offerEmailSelectedContacts.length + ' selected';
            
            // Update hidden To field with selected emails
            const emails = offerEmailSelectedContacts.map(c => c.email).join(', ');
            document.getElementById('offerEmailTo').value = emails;
            
            // Update greeting in email body
            updateOfferEmailGreeting();
        }
        
        // Dynamic greeting based on selected recipients
        function updateOfferEmailGreeting() {
            const greetingEl = document.getElementById('offerEmailGreeting');
            if (!greetingEl) return;
            
            let greeting = 'Dear Sir/Madam';
            
            if (offerEmailSelectedContacts.length === 0) {
                greeting = 'Dear Sir/Madam';
            } else if (offerEmailSelectedContacts.length === 1) {
                const name = offerEmailSelectedContacts[0].contact_name;
                const firstName = name.split(' ')[0];
                greeting = `Dear Mr./Ms. ${firstName}`;
            } else if (offerEmailSelectedContacts.length === offerEmailContacts.length) {
                greeting = 'Dear All';
            } else {
                // Multiple but not all
                const names = offerEmailSelectedContacts.map(c => {
                    const parts = c.contact_name.split(' ');
                    return 'Mr./Ms. ' + (parts[parts.length - 1] || parts[0]); // Last name
                });
                if (names.length <= 3) {
                    greeting = 'Dear ' + names.join(', ');
                } else {
                    greeting = 'Dear ' + names.slice(0, 2).join(', ') + ' and colleagues';
                }
            }
            
            greetingEl.textContent = greeting + ',';
        }
        
        function selectAllOfferRecipients() {
            offerEmailContacts.forEach((_, idx) => {
                const checkbox = document.getElementById('offerRecipient_' + idx);
                if (checkbox) checkbox.checked = true;
            });
            updateOfferRecipients();
        }
        
        function clearAllOfferRecipients() {
            offerEmailContacts.forEach((_, idx) => {
                const checkbox = document.getElementById('offerRecipient_' + idx);
                if (checkbox) checkbox.checked = false;
            });
            updateOfferRecipients();
        }
        
        // Update signature based on sender
        function updateOfferEmailSignature() {
            const select = document.getElementById('offerEmailSender');
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                currentOfferSender = null;
                return;
            }
            
            currentOfferSender = {
                name: selectedOption.dataset.name || selectedOption.textContent,
                email: selectedOption.dataset.email || ''
            };
            
            // Update signature in email body
            const signatureEl = document.getElementById('offerEmailSignature');
            if (signatureEl) {
                signatureEl.innerHTML = `
                    <strong style="color: #1e3a5f;">${currentOfferSender.name}</strong><br>
                    <span style="color: #666666; font-size: 13px;">Business Development</span><br>
                    <span style="color: #666666; font-size: 13px;">Polaris Financial Services Ltd.</span><br>
                    <span style="color: #666666; font-size: 13px;">📧 ${currentOfferSender.email}</span>
                `;
            }
        }
        
        function saveAndSendOffer() {
            alert('📧 Save & Send functionality coming soon!\n\nFor now, please save as draft.');
            saveOfferDraft();
        }
        
        // ═══════════════════════════════════════════════════════════════════
        // OPEN SEND DOCUMENTS MODAL FROM OFFER (FIXED v3)
        // ═══════════════════════════════════════════════════════════════════
        async function openSendDocumentsFromOffer(offerId) {
            // Find the offer in loaded data
            const offer = offersData.find(o => o.offer_id === offerId);
            if (!offer) {
                alert('Offer not found: ' + offerId);
                return;
            }
            
            console.log('Opening Send Docs for offer:', offer);
            
            // Check if this is a Comparison Quote
            const isComparison = offer.offer_type === 'comparison' || (offerId && offerId.startsWith('CQ-'));
            
            // Get CLIENT NAME from offer
            let clientName = offer.client_name || 'Unknown Client';
            
            // Get contact info DIRECTLY from offer
            let contactName = offer.contact_person || '';
            let contactEmail = offer.contact_email || '';
            
            // If not in offer, try to get from client_info
            if (offer.client_info) {
                if (!contactName) contactName = offer.client_info.contact_name || '';
                if (!contactEmail) contactEmail = offer.client_info.contact_email || '';
            }
            
            // If still no contact info, try to fetch from Clients database
            if ((!contactName || !contactEmail) && offer.client_id) {
                try {
                    console.log('Fetching contact info from API for client:', offer.client_id);
                    const clientResponse = await fetch(`${API_URL}?action=getClientById&clientId=${encodeURIComponent(offer.client_id)}`);
                    const clientResult = await clientResponse.json();
                    
                    if (clientResult.success && clientResult.data) {
                        const clientData = clientResult.data;
                        if (!contactName) contactName = clientData.contact_person || clientData.contact_name || '';
                        if (!contactEmail) contactEmail = clientData.contact_email || clientData.email || '';
                        console.log('Retrieved contact from API:', contactName, contactEmail);
                    }
                } catch (e) {
                    console.error('Error fetching client contact:', e);
                }
            }
            
            // Extract program names from offer items OR comparison_data
            const programs = [];
            
            if (isComparison && offer.comparison_data) {
                // Parse comparison_data for Comparison Quotes
                try {
                    let compData = offer.comparison_data;
                    if (typeof compData === 'string') {
                        compData = JSON.parse(compData);
                    }
                    
                    // comparison_data can be a single object or array of plans
                    if (Array.isArray(compData)) {
                        compData.forEach(plan => {
                            if (plan.planName && !programs.includes(plan.planName)) {
                                programs.push(plan.planName);
                            }
                        });
                    } else if (compData.planName) {
                        programs.push(compData.planName);
                    }
                    console.log('Extracted programs from comparison_data:', programs);
                } catch (e) {
                    console.error('Error parsing comparison_data:', e);
                }
            } else if (offer.items && Array.isArray(offer.items)) {
                // Standard offer - extract from items
                offer.items.forEach(item => {
                    if (item.plan_name && !programs.includes(item.plan_name)) {
                        programs.push(item.plan_name);
                    }
                });
            }
            
            // Prepare offer data for the modal
            const offerData = {
                offerId: offer.offer_id,
                clientId: offer.client_id,
                clientName: clientName,
                contactName: contactName || 'Unknown Contact',
                contactEmail: contactEmail,
                programs: programs,
                items: offer.items, // Include items for program highlighting
                status: offer.status,
                totalMembers: offer.total_members,
                grandTotal: offer.grand_total_usd,
                isComparison: isComparison
            };
            
            console.log('Opening Send Documents modal with:', offerData);
            
            // Open the Send Documents modal
            openSendDocumentsModal(offerData);
        }
        
        async function viewOffer(offerId) {
            // Find the offer in loaded data
            const offer = offersData.find(o => o.offer_id === offerId);
            if (!offer) {
                alert('Offer not found: ' + offerId);
                return;
            }
            
            // Store for later use
            window.currentViewOffer = offer;
            
            // Check if this is a comparison offer
            const isComparison = offer.offer_type === 'comparison' || offerId.startsWith('CQ-');
            
            // Build document buttons based on offer type
            let documentButtonsHtml = '';
            let actionButtonsHtml = '';
            
            if (isComparison) {
                // Comparison Offer - only Comparison Quote + NDA
                documentButtonsHtml = `
                    <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:1rem; margin-bottom:1.5rem;">
                        <button onclick="window.generateComparisonQuoteDoc()" style="padding:1rem; background:linear-gradient(135deg, #8e44ad, #9b59b6); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600;">
                            📊 Generate Comparison Quote
                        </button>
                        <button onclick="window.generateNDAFromViewModal()" style="padding:1rem; background:linear-gradient(135deg, #7c3aed, #6d28d9); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600;">
                            🔒 Generate NDA
                        </button>
                    </div>
                    <div style="background:rgba(212,168,67,0.1); border:2px solid #d4a843; border-radius:12px; padding:1rem; margin-bottom:1rem;">
                        <p style="color:#d4a843; margin:0; text-align:center;">
                            ⚠️ This is a <strong>Comparison Quote</strong>. DPA, ASA, and Proposal will be available after the client selects a plan.
                        </p>
                    </div>
                `;
                actionButtonsHtml = `
                    <button onclick="window.showConvertToStandardModal()" style="flex:1; min-width:280px; padding:1.2rem 2rem; background:linear-gradient(135deg, #27ae60, #1e8449); color:white; border:none; border-radius:12px; cursor:pointer; font-size:1.2rem; font-weight:600; box-shadow:0 4px 15px rgba(39,174,96,0.3);">
                        ✅ Convert to Standard Offer (Client Selected Plan)
                    </button>
                    <button onclick="window.openOfferEmailFromView()" style="flex:1; min-width:280px; padding:1.2rem 2rem; background:linear-gradient(135deg, #d4a843, #c49932); color:#1E3A5F; border:none; border-radius:12px; cursor:pointer; font-size:1.2rem; font-weight:600; box-shadow:0 4px 15px rgba(212,168,67,0.3);">
                        📧 Send Comparison Email
                    </button>
                `;
            } else {
                // Standard Offer - all documents available
                documentButtonsHtml = `
                    <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:1rem; margin-bottom:1.5rem;">
                        <button onclick="window.generateNDAFromViewModal()" style="padding:1rem; background:linear-gradient(135deg, #7c3aed, #6d28d9); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600;">
                            🔒 NDA
                        </button>
                        <button onclick="window.generateDPAFromViewModal()" style="padding:1rem; background:linear-gradient(135deg, #0891b2, #0e7490); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600;">
                            🛡️ DPA
                        </button>
                        <button onclick="window.generateASAFromOffer()" style="padding:1rem; background:linear-gradient(135deg, #1a365d, #2d4a7c); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600;">
                            📋 ASA
                        </button>
                        <button onclick="window.generateProposalFromOffer()" style="padding:1rem; background:linear-gradient(135deg, #d4a843, #c49932); color:#1E3A5F; border:none; border-radius:10px; cursor:pointer; font-weight:600;">
                            💼 Proposal
                        </button>
                    </div>
                `;
                actionButtonsHtml = `
                    <button id="viewOfferGeneratePDF" onclick="window.generateOfferPDFAction()" style="flex:1; min-width:280px; padding:1.2rem 2rem; background:linear-gradient(135deg, #e67e22, #d35400); color:white; border:none; border-radius:12px; cursor:pointer; font-size:1.2rem; font-weight:600; box-shadow:0 4px 15px rgba(230,126,34,0.3);">
                        📄 Generate PDF
                    </button>
                    <button id="viewOfferSendEmail" onclick="window.openOfferEmailFromView()" style="flex:1; min-width:280px; padding:1.2rem 2rem; background:linear-gradient(135deg, #27ae60, #1e8449); color:white; border:none; border-radius:12px; cursor:pointer; font-size:1.2rem; font-weight:600; box-shadow:0 4px 15px rgba(39,174,96,0.3);">
                        📧 Send Proposal Email
                    </button>
                `;
            }
            
            // Offer type badge
            const offerTypeBadge = isComparison 
                ? '<span style="background:#8e44ad; color:white; padding:4px 12px; border-radius:12px; font-size:0.75rem; margin-left:10px;">📊 COMPARISON</span>'
                : '<span style="background:#27ae60; color:white; padding:4px 12px; border-radius:12px; font-size:0.75rem; margin-left:10px;">📋 STANDARD</span>';
            
            // Create modal if doesn't exist
            // Remove existing modal to ensure fresh state
            const existingModal = document.getElementById('viewOfferModal');
            if (existingModal) existingModal.remove();
            
            const modalHtml = `
            <div id="viewOfferModal" style="position:fixed; top:0; left:0; right:0; bottom:0; width:100vw; height:100vh; background:#0a0f1a; z-index:99999; overflow-y:auto; display:block;">
                <!-- Left Navigation Arrow -->
                <button id="viewOfferPrev" onclick="window.navigateOffer(-1)" title="Previous Offer (←)" style="position:fixed; left:15px; top:50%; transform:translateY(-50%); background:rgba(30,58,95,0.95); border:2px solid #d4a843; color:#d4a843; width:60px; height:60px; border-radius:50%; cursor:pointer; font-size:2rem; z-index:100000; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 20px rgba(0,0,0,0.5); transition:all 0.3s;" onmouseover="this.style.background='rgba(212,168,67,0.3)';this.style.transform='translateY(-50%) scale(1.1)'" onmouseout="this.style.background='rgba(30,58,95,0.95)';this.style.transform='translateY(-50%)'">‹</button>
                
                <!-- Right Navigation Arrow -->
                <button id="viewOfferNext" onclick="window.navigateOffer(1)" title="Next Offer (→)" style="position:fixed; right:15px; top:50%; transform:translateY(-50%); background:rgba(30,58,95,0.95); border:2px solid #d4a843; color:#d4a843; width:60px; height:60px; border-radius:50%; cursor:pointer; font-size:2rem; z-index:100000; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 20px rgba(0,0,0,0.5); transition:all 0.3s;" onmouseover="this.style.background='rgba(212,168,67,0.3)';this.style.transform='translateY(-50%) scale(1.1)'" onmouseout="this.style.background='rgba(30,58,95,0.95)';this.style.transform='translateY(-50%)'">›</button>
                
                <!-- Header -->
                <div style="background:linear-gradient(135deg, #1E3A5F, #2d5a87); padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:50;">
                    <div style="display:flex; align-items:center; gap:1rem;">
                        
                        <div>
                            <h2 style="color:white; margin:0; font-size:1.4rem;">📋 Offer Details ${offerTypeBadge}</h2>
                            <div style="display:flex; align-items:center; gap:12px; margin-top:4px;">
                                <span id="viewOfferRef" style="color:#d4a843; font-size:0.9rem;"></span>
                                <span id="viewOfferNavCounter" style="color:#7aa0c0; font-size:0.75rem; background:rgba(0,0,0,0.3); padding:3px 10px; border-radius:10px;"></span>
                            </div>
                        </div>
                    </div>
                    <button onclick="window.closeViewOfferModal()" style="background:rgba(255,255,255,0.2); border:none; color:white; width:45px; height:45px; border-radius:50%; cursor:pointer; font-size:1.4rem;">✕</button>
                </div>
                
                <div style="padding:1rem 80px; margin:0 auto;">
                    <!-- Client Info -->
                    <div style="background:#1a2332; border:1px solid #2d3748; border-radius:12px; padding:1.5rem 2rem; margin-bottom:1rem;">
                        <h4 style="color:#d4a843; margin:0 0 1rem 0; font-size:1.1rem;">🏢 Client Information</h4>
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:2rem;">
                            <div><span style="color:#718096; font-size:0.85rem;">Company:</span><br><span id="viewOfferClient" style="color:white; font-weight:600; font-size:1.3rem;"></span></div>
                            <div><span style="color:#718096; font-size:0.85rem;">Status:</span><br><span id="viewOfferStatusBadge"></span></div>
                            <div><span style="color:#718096; font-size:0.85rem;">Created:</span><br><span id="viewOfferCreated" style="color:white; font-size:1.1rem;"></span></div>
                            <div><span style="color:#718096; font-size:0.85rem;">Valid Until:</span><br><span id="viewOfferExpires" style="color:white; font-size:1.1rem;"></span></div>
                        </div>
                    </div>
                    
                    <!-- Documents Section -->
                    <div style="background:#1a2332; border:1px solid #2d3748; border-radius:12px; padding:1.5rem 2rem; margin-bottom:1rem;">
                        <h4 style="color:#d4a843; margin:0 0 1rem 0; font-size:1.1rem;">📄 Generate Documents</h4>
                        ${documentButtonsHtml}
                    </div>
                    
                    <!-- Members Summary Badge -->
                    <div style="display:flex; justify-content:flex-end; margin-bottom:1rem;">
                        <div style="background:linear-gradient(135deg, #d4a843, #b8860b); padding:0.8rem 1.5rem; border-radius:25px; display:inline-flex; align-items:center; gap:0.5rem; box-shadow:0 4px 15px rgba(212,168,67,0.3);">
                            <span id="viewOfferMembersBadge" style="color:#1E3A5F; font-weight:bold; font-size:1.1rem;"></span>
                        </div>
                    </div>
                    
                    <!-- PLANS TABLE -->
                    <div style="background:#1a2332; border:1px solid #2d3748; border-radius:12px; padding:1.5rem 2rem; margin-bottom:1rem;">
                        <h4 style="color:#d4a843; margin:0 0 1rem 0; font-size:1.1rem;">💰 Cost Summary</h4>
                        <div style="overflow-x:auto;">
                            <table id="viewOfferPlansTable" style="width:100%; border-collapse:collapse;">
                                <thead>
                                    <tr style="background:#1E3A5F;">
                                        <th style="padding:1.2rem 1.5rem; text-align:left; color:#94A3B8; font-size:0.9rem; font-weight:600; text-transform:uppercase;">PLAN</th>
                                        <th style="padding:1.2rem 1.5rem; text-align:right; color:#94A3B8; font-size:0.9rem; font-weight:600; text-transform:uppercase;">PRINCIPALS</th>
                                        <th style="padding:1.2rem 1.5rem; text-align:right; color:#94A3B8; font-size:0.9rem; font-weight:600; text-transform:uppercase;">DEPENDENTS</th>
                                        <th style="padding:1.2rem 1.5rem; text-align:right; color:#94A3B8; font-size:0.9rem; font-weight:600; text-transform:uppercase;">MEMBERS</th>
                                        <th style="padding:1.2rem 1.5rem; text-align:right; color:#94A3B8; font-size:0.9rem; font-weight:600; text-transform:uppercase;">REG FEE</th>
                                        <th style="padding:1.2rem 1.5rem; text-align:right; color:#94A3B8; font-size:0.9rem; font-weight:600; text-transform:uppercase;">FUND DEP</th>
                                        <th style="padding:1.2rem 1.5rem; text-align:right; color:#94A3B8; font-size:0.9rem; font-weight:600; text-transform:uppercase;">SUBTOTAL</th>
                                    </tr>
                                </thead>
                                <tbody id="viewOfferPlansBody">
                                    <!-- Plans will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Subtotals Row -->
                        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:1rem; margin-top:2rem; border-top:2px solid #2d3748; padding-top:1.5rem;">
                            <div style="background:#1E3A5F; border-radius:12px; padding:1.5rem; text-align:right;">
                                <div style="color:#94A3B8; font-size:0.85rem; text-transform:uppercase; margin-bottom:0.5rem;">REGISTRATION FEES</div>
                                <div id="viewOfferRegFees" style="color:white; font-size:1.8rem; font-weight:bold;"></div>
                            </div>
                            <div style="background:#1E3A5F; border-radius:12px; padding:1.5rem; text-align:right;">
                                <div style="color:#94A3B8; font-size:0.85rem; text-transform:uppercase; margin-bottom:0.5rem;">FUND DEPOSITS</div>
                                <div id="viewOfferFundDep" style="color:white; font-size:1.8rem; font-weight:bold;"></div>
                            </div>
                            <div style="background:#1E3A5F; border-radius:12px; padding:1.5rem; text-align:right;">
                                <div style="color:#94A3B8; font-size:0.85rem; text-transform:uppercase; margin-bottom:0.5rem;">DENTAL BENEFITS</div>
                                <div id="viewOfferDental" style="color:white; font-size:1.8rem; font-weight:bold;"></div>
                            </div>
                        </div>
                        
                        <!-- TOTAL -->
                        <div style="background:linear-gradient(135deg, #d4a843, #b8860b); border-radius:12px; padding:1.5rem 2rem; display:flex; justify-content:space-between; align-items:center; margin-top:1rem; box-shadow:0 4px 15px rgba(212,168,67,0.3);">
                            <span style="color:#1E3A5F; font-weight:bold; font-size:1.3rem;">TOTAL ANNUAL COST</span>
                            <span id="viewOfferTotal" style="color:#1E3A5F; font-size:2.5rem; font-weight:bold;"></span>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div style="display:flex; gap:1.5rem; flex-wrap:wrap; margin-top:2rem; margin-bottom:2rem;">
                        ${actionButtonsHtml}
                    </div>
                </div>
            </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Populate modal
            document.getElementById('viewOfferRef').textContent = offer.offer_id;
            document.getElementById('viewOfferClient').textContent = offer.client_name || 'Unknown Client';
            
            const statusColors = { 'draft': '#718096', 'sent': '#3498db', 'accepted': '#27ae60', 'rejected': '#e74c3c', 'expired': '#95a5a6', 'pending_signature': '#9b59b6', 'signed': '#1abc9c' };
            const statusColor = statusColors[offer.status] || '#718096';
            document.getElementById('viewOfferStatusBadge').innerHTML = '<span style="background:' + statusColor + '; color:white; padding:2px 10px; border-radius:12px; font-size:0.8rem; text-transform:uppercase;">' + (offer.status || 'draft') + '</span>';
            
            document.getElementById('viewOfferCreated').textContent = offer.created_at ? new Date(offer.created_at).toLocaleDateString() : (offer.offer_date ? new Date(offer.offer_date).toLocaleDateString() : '-');
            document.getElementById('viewOfferExpires').textContent = offer.expires_at ? new Date(offer.expires_at).toLocaleDateString() : '-';
            
            // Members badge
            const prin = offer.total_principals || 0;
            const dep = offer.total_dependents || 0;
            const mem = offer.total_members || 0;
            document.getElementById('viewOfferMembersBadge').textContent = prin.toLocaleString() + ' Principals + ' + dep.toLocaleString() + ' Dependents = ' + mem.toLocaleString() + ' Members';
            
            // Build plans table
            // Subtotals - set defaults first (buildViewOfferPlansTable will override for comparison offers)
            document.getElementById('viewOfferRegFees').textContent = '$' + (parseFloat(offer.subtotal_reg_fees) || 0).toLocaleString();
            document.getElementById('viewOfferFundDep').textContent = '$' + (parseFloat(offer.subtotal_fund_deposit) || 0).toLocaleString();
            document.getElementById('viewOfferDental').textContent = '$' + (parseFloat(offer.subtotal_dental) || 0).toLocaleString();
            document.getElementById('viewOfferTotal').textContent = '$' + (parseFloat(offer.grand_total_usd) || 0).toLocaleString();
            
            // Build plans table (this will update subtotals for comparison offers)
            buildViewOfferPlansTable(offer);
            
            // Update navigation counter
            const offers = window.offersData || offersData || [];
            const currentIndex = offers.findIndex(o => o.offer_id === offer.offer_id);
            const navCounter = document.getElementById('viewOfferNavCounter');
            if (navCounter && offers.length > 0) {
                navCounter.textContent = `${currentIndex + 1} of ${offers.length} offers`;
            }
            
            // Modal is already visible (display:block in HTML)
            // Prevent body scroll while modal is open
            document.body.style.overflow = 'hidden';
        }
        
        // Build plans table for View Offer modal
        function buildViewOfferPlansTable(offer) {
            const tbody = document.getElementById('viewOfferPlansBody');
            if (!tbody) return;
            
            console.log('🔍 Building plans table for:', offer.offer_id);
            console.log('🔍 Items:', offer.items?.length || 0);
            console.log('🔍 comparison_data exists:', !!offer.comparison_data);
            console.log('🔍 offer_type:', offer.offer_type);
            
            let items = offer.items || [];
            
            // If no items but has comparison_data, parse it
            if (items.length === 0 && offer.comparison_data) {
                console.log('🔍 Parsing comparison_data...');
                try {
                    const compData = typeof offer.comparison_data === 'string' 
                        ? JSON.parse(offer.comparison_data) 
                        : offer.comparison_data;
                    
                    console.log('🔍 Parsed compData:', compData);
                    
                    if (Array.isArray(compData) && compData.length > 0) {
                        // For converted offers, show the first/selected plan
                        // Or all plans if it's still a comparison
                        const isComparison = offer.offer_type === 'comparison' || (offer.offer_id && offer.offer_id.startsWith('CQ-'));
                        console.log('🔍 isComparison:', isComparison);
                        
                        if (isComparison) {
                            // Show all comparison plans
                            items = compData.map(plan => {
                                console.log('🔍 Creating item from plan:', plan.planName, 'regFee:', plan.regFee, 'fundDep:', plan.fundDep);
                                return {
                                    plan_id: plan.planId || plan.planName,
                                    plan_name: plan.planName + (plan.hasDental ? ' + Dental' : ''),
                                    principals: offer.total_principals || 0,
                                    dependents: offer.total_dependents || 0,
                                    total_members: offer.total_members || 0,
                                    subtotal_reg: plan.regFee || 0,
                                    subtotal_fund: plan.fundDep || 0,
                                    subtotal_dental: plan.dental || 0,
                                    subtotal_total: plan.totalCost || 0
                                };
                            });
                            
                            // For comparison, show first plan's summary (as example)
                            const firstPlan = compData[0];
                            if (firstPlan) {
                                const regEl = document.getElementById('viewOfferRegFees');
                                const fundEl = document.getElementById('viewOfferFundDep');
                                const dentalEl = document.getElementById('viewOfferDental');
                                if (regEl) regEl.textContent = '$' + (firstPlan.regFee || 0).toLocaleString();
                                if (fundEl) fundEl.textContent = '$' + (firstPlan.fundDep || 0).toLocaleString();
                                if (dentalEl) dentalEl.textContent = '$' + (firstPlan.dental || 0).toLocaleString();
                            }
                        } else {
                            // Converted offer - show only the selected plan (first one that matches grand_total)
                            const selectedPlan = compData.find(p => p.totalCost === offer.grand_total_usd) || compData[0];
                            if (selectedPlan) {
                                items = [{
                                    plan_id: selectedPlan.planId || selectedPlan.planName,
                                    plan_name: selectedPlan.planName + (selectedPlan.hasDental ? ' + Dental' : ''),
                                    principals: offer.total_principals || 0,
                                    dependents: offer.total_dependents || 0,
                                    total_members: offer.total_members || 0,
                                    subtotal_reg: selectedPlan.regFee || 0,
                                    subtotal_fund: selectedPlan.fundDep || 0,
                                    subtotal_dental: selectedPlan.dental || 0,
                                    subtotal_total: selectedPlan.totalCost || 0
                                }];
                                
                                // Also update the summary boxes
                                const regEl = document.getElementById('viewOfferRegFees');
                                const fundEl = document.getElementById('viewOfferFundDep');
                                const dentalEl = document.getElementById('viewOfferDental');
                                if (regEl) regEl.textContent = '$' + (selectedPlan.regFee || 0).toLocaleString();
                                if (fundEl) fundEl.textContent = '$' + (selectedPlan.fundDep || 0).toLocaleString();
                                if (dentalEl) dentalEl.textContent = '$' + (selectedPlan.dental || 0).toLocaleString();
                            }
                        }
                    }
                } catch (e) {
                    console.log('Could not parse comparison_data:', e);
                }
            }
            
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:1rem; color:#718096;">No plan details available</td></tr>';
                return;
            }
            
            // Plan limits mapping
            const planLimits = {
                'bronze': '30/15',
                'silver': '40/20',
                'gold': '80/40',
                'gold_plus': '100/40',
                'gold+': '100/40',
                'gold_plus_plus': '150/50',
                'gold++': '150/50',
                'platinum': '180/40',
                'diamond': '360/60'
            };
            
            let html = '';
            items.forEach((item, index) => {
                const planId = (item.plan_id || item.program_id || item.planId || '').toLowerCase();
                const planName = item.plan_name || item.program_name || item.planName || item.plan_id || 'Unknown';
                
                // Get fee values - handle multiple field names from different sources
                const regFee = parseFloat(item.subtotal_reg || item.regFee || item.registration_fee || item.reg_fee || 0);
                const fundDep = parseFloat(item.subtotal_fund || item.fundDep || item.fund_deposit || item.fund_dep || 0);
                const dentalFee = parseFloat(item.subtotal_dental || item.dental || item.dental_fee || 0);
                
                console.log('🔍 Row ' + index + ':', planName, 'regFee:', regFee, 'fundDep:', fundDep, 'dental:', dentalFee);
                console.log('🔍 Item object:', JSON.stringify(item));
                
                // isDental should only be true for DENTAL-ONLY plans (no reg/fund fees)
                // Not for plans that INCLUDE dental like "Gold + Dental"
                const isDentalOnly = (planId === 'dental') || (regFee === 0 && fundDep === 0 && dentalFee > 0);
                console.log('🔍 isDentalOnly:', isDentalOnly);
                
                // Get limits from planId
                let limits = '';
                Object.keys(planLimits).forEach(key => {
                    if (planId.includes(key) || planName.toLowerCase().includes(key)) {
                        limits = planLimits[key];
                    }
                });
                
                const displayName = 'POLARIS ' + planName;
                
                // Handle multiple field name possibilities
                const prin = parseInt(item.principals || item.num_principals || item.principal_count || 0);
                const dep = parseInt(item.dependents || item.num_dependents || item.dependent_count || 0);
                const mem = parseInt(item.total_members || item.members || (prin + dep) || 0);
                
                const subtotal = parseFloat(item.subtotal_total || item.totalCost || item.subtotal || (isDentalOnly ? dentalFee : (regFee + fundDep + dentalFee)) || 0);
                
                // Alternate row colors
                const rowBg = index % 2 === 0 ? '#1a2332' : '#1E3A5F';
                
                html += '<tr style="background:' + rowBg + ';">';
                html += '<td style="padding:1.2rem 1.5rem; border-bottom:1px solid #2d3748;">';
                html += '<strong style="color:' + (isDentalOnly ? '#d4a843' : 'white') + '; font-size:1.1rem;">' + displayName + '</strong>';
                if (limits && !isDentalOnly) html += '<br><span style="color:#718096; font-size:0.85rem;">' + limits + '</span>';
                html += '</td>';
                html += '<td style="padding:1.2rem 1.5rem; text-align:right; color:white; border-bottom:1px solid #2d3748; font-size:1.1rem;">' + prin.toLocaleString() + '</td>';
                html += '<td style="padding:1.2rem 1.5rem; text-align:right; color:white; border-bottom:1px solid #2d3748; font-size:1.1rem;">' + dep.toLocaleString() + '</td>';
                html += '<td style="padding:1.2rem 1.5rem; text-align:right; color:white; font-weight:bold; border-bottom:1px solid #2d3748; font-size:1.1rem;">' + mem.toLocaleString() + '</td>';
                html += '<td style="padding:1.2rem 1.5rem; text-align:right; color:white; border-bottom:1px solid #2d3748; font-size:1.1rem;">' + (isDentalOnly ? '' : '$' + regFee.toLocaleString()) + '</td>';
                html += '<td style="padding:1.2rem 1.5rem; text-align:right; color:white; border-bottom:1px solid #2d3748; font-size:1.1rem;">' + (isDentalOnly ? '' : '$' + fundDep.toLocaleString()) + '</td>';
                html += '<td style="padding:1.2rem 1.5rem; text-align:right; color:#d4a843; font-weight:bold; border-bottom:1px solid #2d3748; font-size:1.2rem;">$' + subtotal.toLocaleString() + '</td>';
                html += '</tr>';
            });
            
            tbody.innerHTML = html;
        }
        
        // Make functions globally accessible for onclick handlers
        window.closeViewOfferModal = function() {
            const modal = document.getElementById('viewOfferModal');
            if (modal) modal.remove();
            document.body.style.overflow = 'auto';
        };
        
        // Navigate between offers in View modal
        window.navigateOffer = function(direction) {
            const currentOffer = window.currentViewOffer;
            const offers = window.offersData || offersData || [];
            
            if (!currentOffer || !offers || offers.length === 0) {
                console.log('Cannot navigate: no current offer or offers data');
                return;
            }
            
            // Find current index
            const currentIndex = offers.findIndex(o => o.offer_id === currentOffer.offer_id);
            if (currentIndex === -1) {
                console.log('Current offer not found in offers list');
                return;
            }
            
            // Calculate new index
            let newIndex = currentIndex + direction;
            if (newIndex < 0) newIndex = offers.length - 1;
            if (newIndex >= offers.length) newIndex = 0;
            
            console.log(`Navigating from offer ${currentIndex} to ${newIndex} (total: ${offers.length})`);
            
            // Load new offer
            const newOffer = offers[newIndex];
            if (newOffer) {
                window.closeViewOfferModal();
                setTimeout(() => {
                    viewOffer(newOffer.offer_id);
                }, 100);
            }
        };
        
        // Keyboard navigation for View Offer modal
        document.addEventListener('keydown', function(e) {
            const modal = document.getElementById('viewOfferModal');
            if (!modal) return; // Only when modal is open
            
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                window.navigateOffer(-1);
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                window.navigateOffer(1);
            } else if (e.key === 'Escape') {
                e.preventDefault();
                window.closeViewOfferModal();
            }
        });
        
        // ═══════════════════════════════════════════════════════════════════════════
        // COMPARISON QUOTE FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════════════
        
        // Generate Comparison Quote Document from Offers Table (with offerId parameter)
        async function generateCQFromTable(offerId) {
            const linkEl = document.getElementById('cqLink-' + offerId);
            if (linkEl) linkEl.innerHTML = '<span style="color:#f39c12;">⏳...</span>';
            
            try {
                // Use GET to avoid CORS - Apps Script will fetch offer data internally
                const url = API_URL + '?action=generateComparisonQuoteFromOffer&offerId=' + encodeURIComponent(offerId);
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    if (linkEl) linkEl.innerHTML = `<a href="${result.documentUrl || result.fileUrl}" target="_blank" style="color:#8b5cf6;">📊 Open</a>`;
                } else {
                    console.error('CQ generation failed:', result.error);
                    if (linkEl) linkEl.innerHTML = '<span style="color:#e74c3c;" title="' + (result.error || 'Error') + '">❌</span>';
                }
            } catch (error) {
                console.error('CQ generation error:', error);
                if (linkEl) linkEl.innerHTML = '<span style="color:#e74c3c;">❌</span>';
            }
        }
        
        // Open Convert to Standard Modal from Offers Table (with offerId parameter)
        async function openConvertToStandardModal(offerId) {
            try {
                // First fetch the offer data
                const offerResponse = await fetch(API_URL + '?action=getOfferById&offerId=' + encodeURIComponent(offerId));
                const offerResult = await offerResponse.json();
                
                if (!offerResult.success || !offerResult.data) {
                    alert('Could not load offer data');
                    return;
                }
                
                // Set the currentViewOffer so the existing modal functions work
                window.currentViewOffer = offerResult.data;
                
                // Now call the existing modal function
                window.showConvertToStandardModal();
            } catch (error) {
                console.error('Error loading offer:', error);
                alert('Error: ' + error.message);
            }
        }
        
        // Generate Comparison Quote Document from View Offer
        window.generateComparisonQuoteDoc = async function() {
            const offer = window.currentViewOffer;
            if (!offer) { alert('No offer selected'); return; }
            
            // Parse comparison data
            let options = [];
            try {
                if (offer.comparison_data) {
                    options = JSON.parse(offer.comparison_data);
                }
            } catch (e) {
                console.error('Error parsing comparison data:', e);
            }
            
            if (options.length === 0) {
                alert('No comparison data found for this offer');
                return;
            }
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '⏳ Generating...';
            btn.disabled = true;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generateComparisonQuote',
                        clientName: offer.client_name,
                        contactPerson: offer.contact_person || 'Sir/Madam',
                        principals: offer.principals || offer.total_principals || 0,
                        dependents: offer.dependents || offer.total_dependents || 0,
                        totalMembers: offer.total_members || 0,
                        tier: offer.tier || 'Tier 1',
                        options: options
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    window.open(result.documentUrl, '_blank');
                } else {
                    alert('Error: ' + (result.error || 'Failed to generate document'));
                }
            } catch (error) {
                console.error('Generate error:', error);
                alert('Error: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };
        
        // Generate NDA from Offer
        window.generateNDAFromViewModal = async function() {
            const offer = window.currentViewOffer;
            if (!offer) { alert('No offer selected'); return; }
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '⏳ Generating...';
            btn.disabled = true;
            showGlobalStatus('Generating NDA...', '📜');
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generateNDA',
                        clientName: offer.client_name,
                        clientId: offer.client_id
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    window.open(result.documentUrl, '_blank');
                } else {
                    alert('Error: ' + (result.error || 'Failed to generate NDA'));
                }
            } catch (error) {
                console.error('Generate error:', error);
                alert('Error: ' + error.message);
            } finally {
                hideGlobalStatus();
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };
        
        // Generate DPA from Offer
        window.generateDPAFromViewModal = async function() {
            const offer = window.currentViewOffer;
            if (!offer) { alert('No offer selected'); return; }
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '⏳ Generating...';
            btn.disabled = true;
            showGlobalStatus('Generating DPA...', '🔒');
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generateDPA',
                        clientName: offer.client_name,
                        clientId: offer.client_id
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    window.open(result.documentUrl, '_blank');
                } else {
                    alert('Error: ' + (result.error || 'Failed to generate DPA'));
                }
            } catch (error) {
                console.error('Generate error:', error);
                alert('Error: ' + error.message);
            } finally {
                hideGlobalStatus();
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };
        
        // Generate ASA from Offer
        window.generateASAFromOffer = async function(offerId, clientId) {
            // Use passed offerId or fall back to currentViewOffer
            const useOfferId = offerId || (window.currentViewOffer ? window.currentViewOffer.offer_id : null);
            if (!useOfferId) { alert('No offer selected'); return; }
            
            const btn = event?.target;
            const originalText = btn ? btn.innerHTML : '';
            if (btn) {
                btn.innerHTML = '⏳ Generating...';
                btn.disabled = true;
            }
            showGlobalStatus('Generating ASA Contract...', '📋');
            
            try {
                // Use GET to avoid CORS issues
                const url = API_URL + '?action=createASAFromOffer&offerId=' + encodeURIComponent(useOfferId);
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    window.open(result.fileUrl || result.documentUrl, '_blank');
                    // Update link in current view if exists
                    const linkEl = document.getElementById('asaLink-' + useOfferId);
                    if (linkEl) linkEl.innerHTML = `<a href="${result.fileUrl || result.documentUrl}" target="_blank" style="color:#27ae60;">📋 Open</a>`;
                } else {
                    alert('Error: ' + (result.error || 'Failed to generate ASA'));
                }
            } catch (error) {
                console.error('Generate error:', error);
                alert('Error: ' + error.message);
            } finally {
                hideGlobalStatus();
                if (btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        };
        
        // Generate Proposal from Offer
        window.generateProposalFromOffer = async function(offerId, clientId) {
            // Use passed offerId or fall back to currentViewOffer
            const useOfferId = offerId || (window.currentViewOffer ? window.currentViewOffer.offer_id : null);
            if (!useOfferId) { alert('No offer selected'); return; }
            
            const btn = event?.target;
            const originalText = btn ? btn.innerHTML : '';
            if (btn) {
                btn.innerHTML = '⏳ Generating...';
                btn.disabled = true;
            }
            showGlobalStatus('Generating Proposal...', '📄');
            
            try {
                // Use GET to avoid CORS issues
                const url = API_URL + '?action=createProposalFromOffer&offerId=' + encodeURIComponent(useOfferId);
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    window.open(result.fileUrl || result.documentUrl, '_blank');
                    // Update link in current view if exists
                    const linkEl = document.getElementById('proposalLink-' + useOfferId);
                    if (linkEl) linkEl.innerHTML = `<a href="${result.fileUrl || result.documentUrl}" target="_blank" style="color:#9b59b6;">📄 Open</a>`;
                } else {
                    alert('Error: ' + (result.error || 'Failed to generate Proposal'));
                }
            } catch (error) {
                console.error('Generate error:', error);
                alert('Error: ' + error.message);
            } finally {
                hideGlobalStatus();
                if (btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        };
        
        // Show Convert to Standard Offer Modal
        window.showConvertToStandardModal = function() {
            const offer = window.currentViewOffer;
            if (!offer) { alert('No offer selected'); return; }
            
            // Parse comparison data to get available plans
            let options = [];
            try {
                if (offer.comparison_data) {
                    options = JSON.parse(offer.comparison_data);
                }
            } catch (e) {
                console.error('Error parsing comparison data:', e);
            }
            
            if (options.length === 0) {
                alert('No plan options found');
                return;
            }
            
            // Build plan selection HTML
            const planOptionsHtml = options.map((opt, idx) => `
                <div style="display:flex; align-items:center; gap:15px; padding:15px; background:#1E3A5F; border-radius:10px; cursor:pointer; border:2px solid transparent; transition:all 0.3s;" 
                     onclick="selectPlanForConversion(${idx})" id="convertPlanOption_${idx}">
                    <input type="radio" name="convertPlan" value="${idx}" style="width:20px; height:20px;">
                    <span style="font-size:1.5rem;">${getPlanIconForDisplay(opt.planName)}</span>
                    <div style="flex:1;">
                        <div style="font-weight:600; color:white;">${opt.planName}${opt.hasDental ? ' + Dental' : ''}</div>
                        <div style="color:#94A3B8; font-size:0.9rem;">Total: $${(opt.totalCost || 0).toLocaleString()}</div>
                    </div>
                </div>
            `).join('');
            
            const modalHtml = `
            <div id="convertToStandardModal" style="position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:100001; display:flex; align-items:center; justify-content:center;">
                <div style="background:#0a0f1a; border:2px solid #d4a843; border-radius:15px; padding:2rem; max-width:500px; width:90%;">
                    <h3 style="color:#d4a843; margin:0 0 1rem 0;">✅ Convert to Standard Offer</h3>
                    <p style="color:#94A3B8; margin-bottom:1.5rem;">Select the plan the client has chosen:</p>
                    
                    <div style="display:flex; flex-direction:column; gap:10px; max-height:400px; overflow-y:auto; margin-bottom:1.5rem;">
                        ${planOptionsHtml}
                    </div>
                    
                    <div style="display:flex; gap:1rem;">
                        <button onclick="closeConvertModal()" style="flex:1; padding:12px; background:#4a5568; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600;">
                            Cancel
                        </button>
                        <button onclick="confirmConvertToStandard()" id="confirmConvertBtn" style="flex:1; padding:12px; background:linear-gradient(135deg, #27ae60, #1e8449); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600;" disabled>
                            ✅ Convert
                        </button>
                    </div>
                </div>
            </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            window.convertOptions = options;
            window.selectedConvertPlanIndex = null;
        };
        
        // Helper to get plan icon
        function getPlanIconForDisplay(planName) {
            const name = (planName || '').toLowerCase();
            if (name.includes('gold++')) return '🌟';
            if (name.includes('gold+')) return '🏅';
            if (name.includes('bronze')) return '🥉';
            if (name.includes('silver')) return '🥈';
            if (name.includes('gold')) return '🥇';
            if (name.includes('platinum')) return '💎';
            if (name.includes('diamond')) return '💠';
            return '📋';
        }
        
        // Select plan for conversion
        window.selectPlanForConversion = function(idx) {
            // Reset all options
            document.querySelectorAll('[id^="convertPlanOption_"]').forEach(el => {
                el.style.borderColor = 'transparent';
                el.querySelector('input').checked = false;
            });
            
            // Highlight selected
            const selected = document.getElementById('convertPlanOption_' + idx);
            if (selected) {
                selected.style.borderColor = '#27ae60';
                selected.querySelector('input').checked = true;
            }
            
            window.selectedConvertPlanIndex = idx;
            document.getElementById('confirmConvertBtn').disabled = false;
        };
        
        // Close convert modal
        window.closeConvertModal = function() {
            const modal = document.getElementById('convertToStandardModal');
            if (modal) modal.remove();
        };
        
        // Confirm conversion to standard offer
        window.confirmConvertToStandard = async function() {
            const offer = window.currentViewOffer;
            const idx = window.selectedConvertPlanIndex;
            const options = window.convertOptions;
            
            if (idx === null || !options || !options[idx]) {
                alert('Please select a plan');
                return;
            }
            
            const selectedPlan = options[idx];
            
            const btn = document.getElementById('confirmConvertBtn');
            btn.innerHTML = '⏳ Converting...';
            btn.disabled = true;
            
            try {
                // Use GET to avoid CORS
                const params = new URLSearchParams({
                    action: 'convertToStandardOffer',
                    offerId: offer.offer_id,
                    selectedPlan: selectedPlan.planName + (selectedPlan.hasDental ? ' + Dental' : ''),
                    totalCost: selectedPlan.totalCost,
                    includeDental: selectedPlan.hasDental
                });
                
                const response = await fetch(API_URL + '?' + params.toString());
                const result = await response.json();
                
                if (result.success) {
                    closeConvertModal();
                    if (window.closeViewOfferModal) window.closeViewOfferModal();
                    // Clear document links cache to force reload
                    window.cachedDocumentLinks = null;
                    if (window.dataCache) window.dataCache.documentLinks = false;
                    // Reload offers and wait for completion
                    if (typeof loadOffers === 'function') {
                        await loadOffers();
                    }
                    
                    // Automatically open the new converted offer
                    const newOfferId = result.newOfferId;
                    alert('✅ Successfully converted to standard offer!\n\nNew Offer ID: ' + newOfferId);
                    
                    // Open the new offer so user can generate documents
                    if (newOfferId && typeof viewOffer === 'function') {
                        setTimeout(() => viewOffer(newOfferId), 300);
                    }
                } else {
                    alert('Error: ' + (result.error || 'Failed to convert'));
                }
            } catch (error) {
                console.error('Convert error:', error);
                alert('Error: ' + error.message);
            } finally {
                btn.innerHTML = '✅ Convert';
                btn.disabled = false;
            }
        };
        
        // ═══════════════════════════════════════════════════════════════════════════
        
        // Global PDF generation function
        window.generateOfferPDFAction = async function() {
            const offer = window.currentViewOffer;
            if (!offer) { alert('No offer selected'); return; }
            
            const btn = document.getElementById('viewOfferGeneratePDF');
            const originalText = btn.innerHTML;
            btn.innerHTML = '⏳ Generating PDF...';
            btn.disabled = true;
            btn.style.opacity = '0.7';
            
            try {
                // Use jsPDF for client-side PDF generation
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4'); // Landscape A4: 297x210mm
                
                const pageWidth = doc.internal.pageSize.getWidth();  // 297mm
                const pageHeight = doc.internal.pageSize.getHeight(); // 210mm
                const margin = 12;
                const contentWidth = pageWidth - (margin * 2);
                
                // ═══════════════════════════════════════════════════════════════
                // HEADER SECTION (35mm height)
                // ═══════════════════════════════════════════════════════════════
                doc.setFillColor(30, 58, 95);
                doc.rect(0, 0, pageWidth, 35, 'F');
                
                // Gold accent line
                doc.setFillColor(212, 168, 67);
                doc.rect(0, 35, pageWidth, 2, 'F');
                
                // POLARIS Logo
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(24);
                doc.setTextColor(212, 168, 67);
                doc.text('POLARIS', margin + 5, 18);
                doc.setFontSize(10);
                doc.setTextColor(255, 255, 255);
                doc.text('FINANCIAL SERVICES', margin + 5, 26);
                
                // Document Title (right side)
                doc.setFontSize(18);
                doc.setTextColor(255, 255, 255);
                doc.text('HEALTHCARE PROPOSAL', pageWidth - margin, 18, { align: 'right' });
                doc.setFontSize(10);
                doc.setTextColor(180, 180, 180);
                doc.text(offer.offer_id || 'Proposal', pageWidth - margin, 26, { align: 'right' });
                
                // ═══════════════════════════════════════════════════════════════
                // CLIENT INFORMATION BOX (starting at y=42)
                // ═══════════════════════════════════════════════════════════════
                const clientBoxY = 42;
                doc.setFillColor(26, 35, 50);
                doc.roundedRect(margin, clientBoxY, contentWidth, 22, 2, 2, 'F');
                
                // Client info label
                doc.setFontSize(8);
                doc.setTextColor(212, 168, 67);
                doc.text('CLIENT INFORMATION', margin + 5, clientBoxY + 6);
                
                // Members badge (top right of client box - same line as label)
                const totalPrin = parseInt(offer.total_principals) || 0;
                const totalDep = parseInt(offer.total_dependents) || 0;
                const totalMem = parseInt(offer.total_members) || (totalPrin + totalDep);
                
                doc.setFillColor(212, 168, 67);
                doc.roundedRect(pageWidth - margin - 85, clientBoxY + 2, 83, 8, 2, 2, 'F');
                doc.setFontSize(6);
                doc.setTextColor(30, 58, 95);
                doc.setFont('helvetica', 'bold');
                doc.text(totalPrin.toLocaleString() + ' Prin + ' + totalDep.toLocaleString() + ' Dep = ' + totalMem.toLocaleString() + ' Members', pageWidth - margin - 83, clientBoxY + 7);
                doc.setFont('helvetica', 'normal');
                
                // Client details row
                doc.setFontSize(9);
                doc.setTextColor(255, 255, 255);
                const col1 = margin + 5;
                const col2 = margin + 70;
                const col3 = margin + 130;
                const col4 = margin + 195;
                const infoY = clientBoxY + 16;
                
                doc.text('Company: ' + (offer.client_name || 'N/A'), col1, infoY);
                doc.text('Status: ' + (offer.status || 'Draft').toUpperCase(), col2, infoY);
                doc.text('Date: ' + new Date(offer.created_at || Date.now()).toLocaleDateString(), col3, infoY);
                doc.text('Valid Until: 30 days', col4, infoY);
                
                // ═══════════════════════════════════════════════════════════════
                // PLANS TABLE (starting at y=68)
                // ═══════════════════════════════════════════════════════════════
                const tableTop = 68;
                const rowHeight = 10;
                const headerHeight = 8;
                
                // Table Header
                doc.setFillColor(30, 58, 95);
                doc.rect(margin, tableTop, contentWidth, headerHeight, 'F');
                
                // Column positions
                const colPlan = margin + 3;
                const colPrin = margin + 85;
                const colDep = margin + 115;
                const colMem = margin + 145;
                const colReg = margin + 180;
                const colFund = margin + 215;
                const colSub = pageWidth - margin - 3;
                
                doc.setFontSize(7);
                doc.setTextColor(148, 163, 184);
                doc.text('PLAN', colPlan, tableTop + 5.5);
                doc.text('PRINCIPALS', colPrin, tableTop + 5.5, { align: 'right' });
                doc.text('DEPENDENTS', colDep, tableTop + 5.5, { align: 'right' });
                doc.text('MEMBERS', colMem, tableTop + 5.5, { align: 'right' });
                doc.text('REG FEE', colReg, tableTop + 5.5, { align: 'right' });
                doc.text('FUND DEP', colFund, tableTop + 5.5, { align: 'right' });
                doc.text('SUBTOTAL', colSub, tableTop + 5.5, { align: 'right' });
                
                // Plan limits mapping
                const planLimits = {
                    'bronze': '30/15', 'silver': '40/20', 'gold': '80/40',
                    'gold+': '100/40', 'gold++': '150/50', 'platinum': '180/40', 'diamond': '360/60'
                };
                
                // Table Rows
                let yPos = tableTop + headerHeight;
                const items = offer.items || [];
                
                items.forEach((item, index) => {
                    const rowBg = index % 2 === 0 ? [26, 35, 50] : [35, 50, 70];
                    doc.setFillColor(rowBg[0], rowBg[1], rowBg[2]);
                    doc.rect(margin, yPos, contentWidth, rowHeight, 'F');
                    
                    const planId = (item.plan_id || '').toLowerCase();
                    const planName = item.plan_name || item.plan_id || 'Unknown';
                    const isDental = planId.includes('dental') || planName.toLowerCase().includes('dental');
                    
                    // Get limits
                    let limits = '';
                    Object.keys(planLimits).forEach(key => {
                        if (planId.includes(key) || planName.toLowerCase().includes(key)) {
                            limits = planLimits[key];
                        }
                    });
                    
                    // Plan name
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(isDental ? 212 : 255, isDental ? 168 : 255, isDental ? 67 : 255);
                    doc.text('POLARIS ' + planName, colPlan, yPos + 5);
                    
                    // Limits below plan name
                    if (limits && !isDental) {
                        doc.setFontSize(6);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(113, 128, 150);
                        doc.text(limits, colPlan, yPos + 8.5);
                    }
                    
                    // Data columns
                    const prin = parseInt(item.principals || item.num_principals || 0);
                    const dep = parseInt(item.dependents || item.num_dependents || 0);
                    const mem = parseInt(item.total_members || item.members || (prin + dep) || 0);
                    const regFee = parseFloat(item.subtotal_reg || item.registration_fee || 0);
                    const fundDep = parseFloat(item.subtotal_fund || item.fund_deposit || 0);
                    const subtotal = parseFloat(item.subtotal_total || item.subtotal || (isDental ? (item.subtotal_dental || 0) : (regFee + fundDep)) || 0);
                    
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(255, 255, 255);
                    doc.text(prin.toLocaleString(), colPrin, yPos + 6, { align: 'right' });
                    doc.text(dep.toLocaleString(), colDep, yPos + 6, { align: 'right' });
                    doc.setFont('helvetica', 'bold');
                    doc.text(mem.toLocaleString(), colMem, yPos + 6, { align: 'right' });
                    doc.setFont('helvetica', 'normal');
                    doc.text(isDental ? '-' : '$' + regFee.toLocaleString(), colReg, yPos + 6, { align: 'right' });
                    doc.text(isDental ? '-' : '$' + fundDep.toLocaleString(), colFund, yPos + 6, { align: 'right' });
                    doc.setTextColor(212, 168, 67);
                    doc.setFont('helvetica', 'bold');
                    doc.text('$' + subtotal.toLocaleString(), colSub, yPos + 6, { align: 'right' });
                    doc.setFont('helvetica', 'normal');
                    
                    yPos += rowHeight;
                });
                
                // ═══════════════════════════════════════════════════════════════
                // SUBTOTALS SECTION
                // ═══════════════════════════════════════════════════════════════
                yPos += 4;
                const boxHeight = 14;
                const boxGap = 4;
                const boxW = (contentWidth - (boxGap * 2)) / 3;
                
                // Registration Fees Box
                doc.setFillColor(30, 58, 95);
                doc.roundedRect(margin, yPos, boxW, boxHeight, 2, 2, 'F');
                doc.setFontSize(7);
                doc.setTextColor(148, 163, 184);
                doc.text('REGISTRATION FEES', margin + 4, yPos + 5);
                doc.setFontSize(11);
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.text('$' + (parseFloat(offer.subtotal_reg_fees) || 0).toLocaleString(), margin + boxW - 4, yPos + 11, { align: 'right' });
                
                // Fund Deposits Box
                doc.setFillColor(30, 58, 95);
                doc.roundedRect(margin + boxW + boxGap, yPos, boxW, boxHeight, 2, 2, 'F');
                doc.setFontSize(7);
                doc.setTextColor(148, 163, 184);
                doc.text('FUND DEPOSITS', margin + boxW + boxGap + 4, yPos + 5);
                doc.setFontSize(11);
                doc.setTextColor(255, 255, 255);
                doc.text('$' + (parseFloat(offer.subtotal_fund_deposit) || 0).toLocaleString(), margin + (boxW * 2) + boxGap - 4, yPos + 11, { align: 'right' });
                
                // Dental Benefits Box
                doc.setFillColor(30, 58, 95);
                doc.roundedRect(margin + (boxW * 2) + (boxGap * 2), yPos, boxW, boxHeight, 2, 2, 'F');
                doc.setFontSize(7);
                doc.setTextColor(148, 163, 184);
                doc.text('DENTAL BENEFITS', margin + (boxW * 2) + (boxGap * 2) + 4, yPos + 5);
                doc.setFontSize(11);
                doc.setTextColor(255, 255, 255);
                doc.text('$' + (parseFloat(offer.subtotal_dental) || 0).toLocaleString(), pageWidth - margin - 4, yPos + 11, { align: 'right' });
                
                // ═══════════════════════════════════════════════════════════════
                // TOTAL BOX
                // ═══════════════════════════════════════════════════════════════
                yPos += boxHeight + 3;
                doc.setFillColor(212, 168, 67);
                doc.roundedRect(margin, yPos, contentWidth, 14, 2, 2, 'F');
                doc.setFontSize(10);
                doc.setTextColor(30, 58, 95);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL ANNUAL COST', margin + 8, yPos + 9);
                doc.setFontSize(14);
                doc.text('$' + (parseFloat(offer.grand_total_usd) || 0).toLocaleString(), pageWidth - margin - 8, yPos + 10, { align: 'right' });
                
                // ═══════════════════════════════════════════════════════════════
                // FOOTER (small, at bottom)
                // ═══════════════════════════════════════════════════════════════
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(6);
                doc.setTextColor(100, 100, 100);
                doc.text('Generated by POLARIS Financial Services | ' + new Date().toLocaleDateString() + ' | Valid for 30 days', pageWidth / 2, pageHeight - 5, { align: 'center' });
                
                // Save PDF
                const fileName = 'POLARIS_Proposal_' + (offer.client_name || 'Client').replace(/[^a-zA-Z0-9]/g, '_') + '_' + (offer.offer_id || 'Draft') + '.pdf';
                doc.save(fileName);
                
                alert('✅ PDF Generated!\\n\\n' + fileName);
                
            } catch (e) {
                console.error('PDF generation error:', e);
                alert('❌ Error: ' + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        };
        
        // generateOfferPDF is now window.generateOfferPDFAction (defined above)
        
        window.openOfferEmailFromView = function() {
            const offer = window.currentViewOffer;
            if (!offer) { alert('No offer selected'); return; }
            window.closeViewOfferModal();
            // Call the correct function with offerId
            openSendDocumentsFromOffer(offer.offer_id);
        };
        
        // Load document links for offers from DocumentVersions
        async function loadOfferDocumentLinks() {
            try {
                console.log('Loading document links for offers...');
                const response = await fetch(API_URL + '?action=getDocumentVersions');
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    console.log('Found', result.data.length, 'documents');
                    
                    // Group documents by client_id
                    const docsByClient = {};
                    result.data.forEach(doc => {
                        const clientId = doc.client_id;
                        if (!docsByClient[clientId]) {
                            docsByClient[clientId] = { NDA: null, DPA: null, ASA: null };
                        }
                        const docType = (doc.doc_type || '').toUpperCase();
                        // Keep the latest version (highest version number)
                        if (docType && (!docsByClient[clientId][docType] || (doc.version || 1) > (docsByClient[clientId][docType].version || 0))) {
                            docsByClient[clientId][docType] = doc;
                        }
                    });
                    
                    console.log('Documents by client:', docsByClient);
                    
                    // Update offers table with document links
                    offersData.forEach(offer => {
                        const clientDocs = docsByClient[offer.client_id];
                        console.log('Offer', offer.offer_id, 'client_id:', offer.client_id, 'docs:', clientDocs);
                        if (clientDocs) {
                            updateOfferDocLinks(offer.offer_id, clientDocs);
                        }
                    });
                } else {
                    console.log('No documents found in DocumentVersions');
                }
            } catch (error) {
                console.error('Error loading document links:', error);
            }
        }
        
        function updateOfferDocLinks(offerId, docs) {
            const ndaLink = document.getElementById('ndaLink-' + offerId);
            const dpaLink = document.getElementById('dpaLink-' + offerId);
            const asaLink = document.getElementById('asaLink-' + offerId);
            
            console.log('Updating links for offer', offerId, '- NDA:', ndaLink, 'DPA:', dpaLink, 'ASA:', asaLink);
            
            // Helper to extract URL from various formats
            const getUrl = (doc) => {
                if (!doc) return null;
                if (typeof doc === 'string') return doc;
                return doc.drive_url || doc.url || doc.fileUrl || null;
            };
            const getVersion = (doc) => (doc && typeof doc === 'object') ? (doc.version || 1) : 1;
            
            // Check both uppercase (NDA) and lowercase (nda) keys
            const ndaDoc = docs.NDA || docs.nda;
            const dpaDoc = docs.DPA || docs.dpa;
            const asaDoc = docs.ASA || docs.asa;
            
            const ndaUrl = getUrl(ndaDoc);
            if (ndaLink && ndaUrl) {
                ndaLink.innerHTML = `<a href="${ndaUrl}" target="_blank" style="color:#e67e22;">📜 v${getVersion(ndaDoc)}</a>`;
            }
            const dpaUrl = getUrl(dpaDoc);
            if (dpaLink && dpaUrl) {
                dpaLink.innerHTML = `<a href="${dpaUrl}" target="_blank" style="color:#9b59b6;">🔒 v${getVersion(dpaDoc)}</a>`;
            }
            const asaUrl = getUrl(asaDoc);
            if (asaLink && asaUrl) {
                asaLink.innerHTML = `<a href="${asaUrl}" target="_blank" style="color:#27ae60;">📋 v${getVersion(asaDoc)}</a>`;
            }
        }
        
        async function sendOffer(offerId) {
            if (!confirm('Mark offer ' + offerId + ' as sent?')) return;
            
            try {
                const response = await fetch(API_URL + '?action=updateOfferStatus&offerId=' + offerId + '&status=sent&notes=Sent from dashboard');
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ Offer marked as sent!');
                    loadOffers(); // This now also updates stats
                } else {
                    alert('❌ Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Error:', e);
                alert('❌ Error: ' + e.message);
            }
        }
    </script>
<!-- ADD NEW CLIENT MODAL - IMPROVED VERSION -->
<div id="addClientModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:99999; align-items:center; justify-content:center; padding:10px;">
    <div style="background:linear-gradient(135deg, #1a2332 0%, #0f1724 100%); border:1px solid #2d3748; border-radius:20px; width:100%; max-width:1000px; max-height:95vh; overflow-y:auto; box-shadow: 0 25px 50px rgba(0,0,0,0.5);">
        
        <!-- Header -->
        <div style="background:linear-gradient(135deg, #1E3A5F, #2d5a87); padding:1.5rem 2rem; display:flex; justify-content:space-between; align-items:center; border-radius:20px 20px 0 0; position:sticky; top:0; z-index:10;">
            <div style="display:flex; align-items:center; gap:1rem;">
                
                <h2 style="color:white; margin:0; font-size:1.75rem; display:flex; align-items:center; gap:12px;">
                    <span style="font-size:2rem;">🏢</span> Add New Client
                </h2>
            </div>
            <button onclick="closeAddClientModal()" style="background:rgba(255,255,255,0.2); border:none; color:white; width:44px; height:44px; border-radius:50%; cursor:pointer; font-size:1.5rem; transition:all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">✕</button>
        </div>
        
        <!-- Form Content -->
        <div style="padding:2rem;">
            
            <!-- SECTION 1: Company Information -->
            <div style="margin-bottom:2rem;">
                <h3 style="color:#d4a843; margin-bottom:1.25rem; font-size:1.25rem; display:flex; align-items:center; gap:10px; border-bottom:1px solid #3d4a5c; padding-bottom:0.75rem;">
                    <span>📋</span> Company Information
                </h3>
                <div style="display:grid; grid-template-columns:1fr; gap:1.25rem;">
                    <!-- Row 1: Company Name (full width) -->
                    <div>
                        <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Company Name <span style="color:#e74c3c;">*</span></label>
                        <input type="text" id="clientName" placeholder="e.g., Alpha Marine Ltd" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                    </div>
                    
                    <!-- Row 2: Short Name, Country -->
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:1.25rem;">
                        <div>
                            <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Short Name</label>
                            <input type="text" id="clientShort" placeholder="e.g., ALPHA" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                        </div>
                        <div>
                            <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Country <span style="color:#e74c3c;">*</span></label>
                            <input type="text" id="clientCountry" placeholder="e.g., Greece" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                        </div>
                    </div>
                    
                    <!-- Row 3: TIN, VAT -->
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:1.25rem;">
                        <div>
                            <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">TIN Number</label>
                            <input type="text" id="clientTIN" placeholder="Tax Identification Number" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                        </div>
                        <div>
                            <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">VAT Number</label>
                            <input type="text" id="clientVAT" placeholder="Value Added Tax Number" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                        </div>
                    </div>
                    
                    <!-- Row 4: Registered Address (full width) -->
                    <div>
                        <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Registered Address</label>
                        <input type="text" id="clientRegAddress" placeholder="Full registered address" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                    </div>
                    
                    <!-- Row 5: Operating Address (full width) -->
                    <div>
                        <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Operating Address</label>
                        <input type="text" id="clientOpAddress" placeholder="Operating address (if different)" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                    </div>
                </div>
            </div>
            
            <!-- SECTION 1.5: Company Structure (Hierarchy) -->
            <div style="margin-bottom:2rem;">
                <h3 style="color:#d4a843; margin-bottom:1.25rem; font-size:1.25rem; display:flex; align-items:center; gap:10px; border-bottom:1px solid #3d4a5c; padding-bottom:0.75rem;">
                    <span>🏢</span> Company Structure
                </h3>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:1.25rem;">
                    <div>
                        <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Client Type <span style="color:#e74c3c;">*</span></label>
                        <select id="clientType" onchange="toggleParentClientDropdown()" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; cursor:pointer; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                            <option value="parent">🏛️ Parent Company (Main Entity)</option>
                            <option value="subsidiary">└─ Subsidiary (Under a Parent)</option>
                        </select>
                    </div>
                    <div id="parentClientContainer" style="display:none;">
                        <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Parent Company <span style="color:#e74c3c;">*</span></label>
                        <select id="parentClientId" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; cursor:pointer; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                            <option value="">-- Select Parent Company --</option>
                        </select>
                        <p style="color:#6b7280; font-size:0.85rem; margin-top:0.5rem;">📌 This company will be linked as a subsidiary under the selected parent.</p>
                    </div>
                </div>
            </div>

            <!-- SECTION 2: Contract Information -->
            <div style="margin-bottom:2rem;">
                <h3 style="color:#d4a843; margin-bottom:1.25rem; font-size:1.25rem; display:flex; align-items:center; gap:10px; border-bottom:1px solid #3d4a5c; padding-bottom:0.75rem;">
                    <span>📄</span> Contract Information
                </h3>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1.25rem;">
                    <div>
                        <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Healthcare Plan</label>
                        <select id="clientPlanId" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; cursor:pointer; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                            <option value="">-- Select Plan --</option>
                            <option value="bronze">Bronze</option>
                            <option value="silver">Silver</option>
                            <option value="gold">Gold</option>
                            <option value="gold_plus">Gold+</option>
                            <option value="platinum">Platinum</option>
                            <option value="diamond">Diamond</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Contract Start</label>
                        <input type="date" id="clientContractStart" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                    </div>
                    <div>
                        <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Contract End</label>
                        <input type="date" id="clientContractEnd" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                    </div>
                    <div>
                        <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Status</label>
                        <select id="clientStatus" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; cursor:pointer; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                            <option value="active">Active</option>
                            <option value="pending">Pending</option>
                            <option value="inactive">Inactive</option>
                            <option value="expired">Expired</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- SECTION 3: Contact Information -->
            <div style="margin-bottom:2rem;">
                <h3 style="color:#d4a843; margin-bottom:1.25rem; font-size:1.25rem; display:flex; align-items:center; gap:10px; border-bottom:1px solid #3d4a5c; padding-bottom:0.75rem;">
                    <span>👤</span> Contact Information
                </h3>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:1.25rem;">
                    <div>
                        <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Contact Person <span style="color:#e74c3c;">*</span></label>
                        <input type="text" id="clientContactPerson" placeholder="Full name" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                    </div>
                    <div>
                        <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Capacity / Title</label>
                        <input type="text" id="clientCapacity" placeholder="e.g., Fleet Manager" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                    </div>
                    <div>
                        <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Email <span style="color:#e74c3c;">*</span></label>
                        <input type="email" id="clientEmail" placeholder="email@company.com" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                    </div>
                    <div>
                        <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Phone</label>
                        <input type="tel" id="clientPhone" placeholder="+30 xxx xxx xxxx" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                    </div>
                    <div>
                        <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Mobile</label>
                        <input type="tel" id="clientMobile" placeholder="+30 xxx xxx xxxx" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                    </div>
                    <div>
                        <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Fax</label>
                        <input type="tel" id="clientFax" placeholder="+30 xxx xxx xxxx" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                    </div>
                </div>
            </div>
            
            <!-- SECTION 4: Authorized Signatory -->
            <div style="margin-bottom:2rem;">
                <h3 style="color:#d4a843; margin-bottom:1.25rem; font-size:1.25rem; display:flex; align-items:center; gap:10px; border-bottom:1px solid #3d4a5c; padding-bottom:0.75rem;">
                    <span>✍️</span> Authorized Signatory
                </h3>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:1.25rem;">
                    <div>
                        <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Signatory Name <span style="color:#e74c3c;">*</span></label>
                        <input type="text" id="clientSignatoryName" placeholder="Full legal name" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                    </div>
                    <div>
                        <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Signatory Title <span style="color:#e74c3c;">*</span></label>
                        <input type="text" id="clientSignatoryTitle" placeholder="e.g., CEO, Director" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                    </div>
                </div>
            </div>
            
            <!-- SECTION 5: Portal Access (Collapsible) -->
            <div style="margin-bottom:2rem;">
                <h3 onclick="togglePortalSection()" style="color:#d4a843; margin-bottom:1.25rem; font-size:1.25rem; display:flex; align-items:center; gap:10px; border-bottom:1px solid #3d4a5c; padding-bottom:0.75rem; cursor:pointer; user-select:none;">
                    <span>🔐</span> Portal Access <span style="font-size:0.9rem; color:#718096; margin-left:auto;">(Optional - Click to expand)</span>
                    <span id="portalToggleIcon" style="transition:transform 0.3s;">▼</span>
                </h3>
                <div id="portalSection" style="display:none; animation: fadeIn 0.3s;">
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:1.25rem;">
                        <div style="grid-column: 1 / -1;">
                            <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Portal URL</label>
                            <input type="url" id="clientPortalUrl" placeholder="https://portal.example.com" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                        </div>
                        <div>
                            <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Portal Username</label>
                            <input type="text" id="clientPortalUsername" placeholder="Username" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                        </div>
                        <div>
                            <label style="display:block; color:#a0aec0; font-size:1rem; margin-bottom:0.5rem; font-weight:500;">Portal Password</label>
                            <input type="password" id="clientPortalPassword" placeholder="Password" style="width:100%; padding:1rem 1.25rem; background:#2d3748; border:2px solid #4a5568; border-radius:10px; color:white; font-size:1.1rem; transition:border-color 0.3s;" onfocus="this.style.borderColor='#d4a843'" onblur="this.style.borderColor='#4a5568'">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Status Message -->
            <div id="addClientStatus" style="margin-bottom:1.5rem;"></div>
            
            <!-- Action Buttons -->
            <div style="display:flex; gap:1rem; justify-content:flex-end; flex-wrap:wrap; padding-top:1rem; border-top:1px solid #3d4a5c;">
                <button onclick="closeAddClientModal()" style="padding:1rem 2rem; background:#4a5568; color:white; border:none; border-radius:10px; cursor:pointer; font-size:1.1rem; font-weight:500; transition:all 0.3s; min-width:140px;" onmouseover="this.style.background='#5a6578'" onmouseout="this.style.background='#4a5568'">
                    Cancel
                </button>
                <button onclick="saveNewClientWithOffersUpdate()" style="padding:1rem 2rem; background:linear-gradient(135deg, #27ae60, #1e8449); color:white; border:none; border-radius:10px; cursor:pointer; font-size:1.1rem; font-weight:600; transition:all 0.3s; min-width:180px; display:flex; align-items:center; justify-content:center; gap:8px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(39,174,96,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <span>💾</span> Save Client
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Toggle Portal Section
function togglePortalSection() {
    const section = document.getElementById('portalSection');
    const icon = document.getElementById('portalToggleIcon');
    if (section.style.display === 'none') {
        section.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
    } else {
        section.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
    }
}

// Auto-generate short name from company name
document.getElementById('clientName').addEventListener('input', function() {
    const shortField = document.getElementById('clientShort');
    if (!shortField.value) { // Only auto-fill if empty
        const words = this.value.trim().split(' ');
        if (words.length >= 2) {
            // Take first letter of each word (up to 4 words)
            shortField.value = words.slice(0, 4).map(w => w[0]).join('').toUpperCase();
        } else {
            shortField.value = this.value.substring(0, 10).toUpperCase();
        }
    }
});

// Auto-set contract end date (1 year from start)
document.getElementById('clientContractStart').addEventListener('change', function() {
    const endField = document.getElementById('clientContractEnd');
    if (!endField.value && this.value) {
        const startDate = new Date(this.value);
        startDate.setFullYear(startDate.getFullYear() + 1);
        endField.value = startDate.toISOString().split('T')[0];
    }
});
</script>

<style>
/* Responsive adjustments */
@media (max-width: 768px) {
    #addClientModal > div {
        margin: 5px;
        max-height: 98vh;
        border-radius: 15px;
    }
    
    #addClientModal > div > div:first-child {
        padding: 1rem 1.25rem;
        border-radius: 15px 15px 0 0;
    }
    
    #addClientModal > div > div:first-child h2 {
        font-size: 1.4rem;
    }
    
    #addClientModal > div > div:last-child {
        padding: 1.25rem;
    }
    
    #addClientModal input,
    #addClientModal select {
        padding: 0.875rem 1rem !important;
        font-size: 1rem !important;
    }
    
    #addClientModal label {
        font-size: 0.95rem !important;
    }
    
    #addClientModal h3 {
        font-size: 1.1rem !important;
    }
    
    #addClientModal button {
        width: 100%;
        padding: 1rem !important;
    }
}

/* Animation */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Custom scrollbar */
#addClientModal > div::-webkit-scrollbar {
    width: 8px;
}

#addClientModal > div::-webkit-scrollbar-track {
    background: #1a2332;
    border-radius: 10px;
}

#addClientModal > div::-webkit-scrollbar-thumb {
    background: #4a5568;
    border-radius: 10px;
}

#addClientModal > div::-webkit-scrollbar-thumb:hover {
    background: #5a6578;
}
</style>

<!-- OFFER EMAIL PREVIEW MODAL -->
<div id="offerEmailModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.98); z-index:99999; align-items:stretch; justify-content:stretch; padding: 0;">
    <div style="background:#1a2332; width:100%; height:100%; overflow:hidden; display:flex; flex-direction:column;">
        <!-- Modal Header -->
        <div style="background:linear-gradient(135deg, #1e3a5f, #2d5a87); padding:20px 30px; display:flex; justify-content:space-between; align-items:center; flex-shrink:0;">
            <div>
                <h2 style="color:white; margin:0; font-size:1.6rem;">📧 Offer Email</h2>
                <div style="display:flex; align-items:center; gap:20px; margin-top:10px;">
                    <span style="color:#b0b0b0; font-size:14px;">Gmail:</span>
                    <span id="gmailConnectionStatus" style="font-size:14px;"><span style="color: #ff6b6b;">Not connected</span></span>
                    <button id="gmailConnectBtn" onclick="connectGmail()" style="background:#4CAF50; color:white; border:none; padding:6px 16px; border-radius:20px; font-size:13px; cursor:pointer; font-weight:500;">Connect Gmail</button>
                </div>
            </div>
            <button onclick="closeOfferEmailModal()" style="background:rgba(255,255,255,0.2); border:none; color:white; width:44px; height:44px; border-radius:50%; cursor:pointer; font-size:1.5rem; transition:background 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">✕</button>
        </div>
        
        <!-- Email Fields - Two columns -->
        <div style="padding:20px 30px; background:#2d3748; border-bottom:1px solid #4a5568; flex-shrink:0;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:30px;">
                <!-- Left Column: From & To -->
                <div>
                    <!-- From (Sender) -->
                    <div style="margin-bottom:16px;">
                        <label style="color:#d4a843; font-size:14px; font-weight:600; display:block; margin-bottom:6px;">📤 From (Sender):</label>
                        <select id="offerEmailSender" onchange="updateOfferEmailSignature()" style="width:100%; padding:12px 15px; border:1px solid #4a5568; border-radius:8px; font-size:15px; background:#1a2332; color:white;">
                            <option value="">-- Select Sender --</option>
                        </select>
                    </div>
                    
                    <!-- To (Recipients) -->
                    <div>
                        <label style="color:#d4a843; font-size:14px; font-weight:600; display:block; margin-bottom:6px;">📥 To (Recipients):</label>
                        <div id="offerEmailRecipientsBox" style="max-height:180px; overflow-y:auto; border:1px solid #4a5568; border-radius:8px; background:#1a2332; padding:10px;">
                            <p style="color:#718096; font-size:14px; text-align:center; margin:0;">Select a client first</p>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:8px; align-items:center;">
                            <button onclick="selectAllOfferRecipients()" style="padding:6px 14px; background:#4a5568; border:none; border-radius:6px; font-size:13px; cursor:pointer; color:white;">☑️ All</button>
                            <button onclick="clearAllOfferRecipients()" style="padding:6px 14px; background:#4a5568; border:none; border-radius:6px; font-size:13px; cursor:pointer; color:white;">✖️ Clear</button>
                            <span id="offerRecipientCount" style="color:#d4a843; font-size:13px; margin-left:auto; font-weight:500;">0 selected</span>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column: CC & Subject -->
                <div>
                    <!-- CC -->
                    <div style="margin-bottom:16px;">
                        <label style="color:#d4a843; font-size:14px; font-weight:600; display:block; margin-bottom:6px;">📋 CC (optional):</label>
                        <input type="text" id="offerEmailCC" style="width:100%; padding:12px 15px; border:1px solid #4a5568; border-radius:8px; font-size:15px; background:#1a2332; color:white;" placeholder="email1@example.com, email2@example.com">
                    </div>
                    
                    <!-- Subject -->
                    <div style="margin-bottom:16px;">
                        <label style="color:#d4a843; font-size:14px; font-weight:600; display:block; margin-bottom:6px;">📌 Subject:</label>
                        <input type="text" id="offerEmailSubject" style="width:100%; padding:12px 15px; border:1px solid #4a5568; border-radius:8px; font-size:15px; background:#1a2332; color:white;">
                    </div>
                    
                    <!-- Attachments -->
                    <div>
                        <label style="color:#d4a843; font-size:14px; font-weight:600; display:block; margin-bottom:6px;">📎 Attachments:</label>
                        <div style="display:flex; gap:20px; flex-wrap:wrap;">
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; color:white; font-size:14px;">
                                <input type="checkbox" id="attachOfferPDF" checked style="width:18px; height:18px;"> 
                                <span>📄 Offer PDF</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; color:white; font-size:14px;">
                                <input type="checkbox" id="attachNDA" style="width:18px; height:18px;"> 
                                <span>📜 NDA</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; color:white; font-size:14px;">
                                <input type="checkbox" id="attachBenefits" style="width:18px; height:18px;"> 
                                <span>📋 Benefits Table</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Hidden To field for actual sending -->
                    <input type="hidden" id="offerEmailTo">
                </div>
            </div>
        </div>
        
        <!-- Email Body (Editable) - Scrollable -->
        <div style="flex:1; overflow-y:auto; padding:25px 30px; background:#ffffff;">
            <div id="offerEmailBody" contenteditable="true" style="min-height:100%; outline:none; font-family: Arial, sans-serif; line-height:1.7; font-size:15px;">
                <!-- Email content will be inserted here -->
            </div>
        </div>
        
        <!-- Modal Footer / Actions -->
        <div style="padding:20px 30px; background:#2d3748; border-top:1px solid #4a5568; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px; flex-shrink:0;">
            <div style="display:flex; gap:12px;">
                <button onclick="copyOfferEmailHtml()" style="padding:12px 24px; background:#6c757d; color:white; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:500; display:flex; align-items:center; gap:8px;">
                    📋 Copy HTML
                </button>
                <button onclick="exportOfferEmailToPDF()" style="padding:12px 24px; background:#17a2b8; color:white; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:500; display:flex; align-items:center; gap:8px;">
                    📄 Export PDF
                </button>
            </div>
            <div style="display:flex; gap:12px;">
                <button onclick="createOfferGmailDraft()" style="padding:12px 24px; background:#ffc107; color:#1e3a5f; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; display:flex; align-items:center; gap:8px;">
                    💾 Save Draft
                </button>
                <button onclick="sendOfferViaGmail()" style="padding:12px 24px; background:#28a745; color:white; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; display:flex; align-items:center; gap:8px;">
                    📧 Send Email
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════════ -->
<!-- SEND DOCUMENTS MODAL - Full Screen Document Delivery System                      -->
<!-- ═══════════════════════════════════════════════════════════════════════════════ -->
<style>
/* Send Documents Modal Styles */
.send-docs-modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.95); display: flex;
    align-items: stretch; justify-content: stretch; z-index: 99999;
    backdrop-filter: blur(8px);
}
.send-docs-modal.hidden { display: none; }

.send-docs-container {
    background: #1a2332; width: 100%; height: 100%;
    overflow: hidden; display: flex; flex-direction: column;
}

.send-docs-header {
    background: linear-gradient(135deg, #1e3a5f, #2d5a87);
    padding: 20px 30px; display: flex; justify-content: space-between;
    align-items: center; flex-shrink: 0;
    border-bottom: 3px solid #d4af37;
}

.send-docs-header h2 {
    color: white; margin: 0; font-size: 1.6rem;
    font-family: 'Montserrat', sans-serif;
}

.send-docs-header-info {
    display: flex; flex-direction: column; gap: 10px; margin-top: 8px;
}

/* Client Offers Section in Send Docs */
#sendDocsClientOffersList {
    scrollbar-width: thin;
    scrollbar-color: #d4af37 #1a2332;
}
#sendDocsClientOffersList::-webkit-scrollbar {
    height: 6px;
}
#sendDocsClientOffersList::-webkit-scrollbar-track {
    background: #1a2332;
    border-radius: 3px;
}
#sendDocsClientOffersList::-webkit-scrollbar-thumb {
    background: #d4af37;
    border-radius: 3px;
}
.send-docs-offer-card.selected {
    border-color: #d4af37 !important;
    background: linear-gradient(135deg, #2a3a4a, #344a5a) !important;
}

.send-docs-header-badge {
    background: rgba(212, 175, 55, 0.2);
    color: #d4af37; padding: 6px 16px;
    border-radius: 20px; font-size: 14px; font-weight: 600;
}

.send-docs-close {
    background: rgba(255,255,255,0.2); border: none; color: white;
    width: 50px; height: 50px; border-radius: 50%; cursor: pointer;
    font-size: 1.8rem; transition: all 0.3s;
}
.send-docs-close:hover {
    background: rgba(231, 76, 60, 0.8); transform: scale(1.1);
}

.send-docs-body {
    flex: 1; overflow-y: auto; padding: 25px 30px;
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 30px;
}

/* Left Column - Document Selection */
.send-docs-left {
    display: flex; flex-direction: column; gap: 20px;
}

/* Right Column - Email Settings */
.send-docs-right {
    display: flex; flex-direction: column; gap: 20px;
}

/* Section Cards */
.send-docs-section {
    background: #2d3748; border-radius: 16px;
    border: 1px solid #4a5568; overflow: hidden;
}

.send-docs-section-header {
    background: linear-gradient(135deg, #1e3a5f, #2a4a6f);
    padding: 16px 20px; display: flex; align-items: center; gap: 12px;
}

.send-docs-section-header h3 {
    color: white; margin: 0; font-size: 1.1rem;
    font-family: 'Montserrat', sans-serif;
}

.send-docs-section-icon {
    font-size: 1.4rem;
}

.send-docs-section-body {
    padding: 20px;
}

/* Checkbox Items - Large & Touch Friendly */
.send-docs-checkbox-grid {
    display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
}

.send-docs-checkbox-item {
    display: flex; align-items: center; gap: 14px;
    padding: 16px 18px; background: #1a2332;
    border: 2px solid #4a5568; border-radius: 12px;
    cursor: pointer; transition: all 0.3s;
    min-height: 60px;
}

.send-docs-checkbox-item:hover {
    border-color: #d4af37; background: rgba(212, 175, 55, 0.05);
}

.send-docs-checkbox-item.selected {
    border-color: #4CAF50; background: rgba(76, 175, 80, 0.15);
}

.send-docs-checkbox-item input[type="checkbox"] {
    width: 26px; height: 26px; cursor: pointer;
    accent-color: #4CAF50;
}

.send-docs-checkbox-label {
    flex: 1; display: flex; flex-direction: column;
}

.send-docs-checkbox-name {
    color: #ffffff; font-weight: 600; font-size: 1rem;
}

.send-docs-checkbox-desc {
    color: #7aa0c0; font-size: 0.8rem; margin-top: 2px;
}

/* Program Grid - 4 columns for programs */
.send-docs-program-grid {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
}

.send-docs-program-item {
    display: flex; flex-direction: column; align-items: center;
    padding: 14px 10px; background: #1a2332;
    border: 2px solid #4a5568; border-radius: 12px;
    cursor: pointer; transition: all 0.3s; text-align: center;
}

.send-docs-program-item:hover {
    border-color: #d4af37; transform: translateY(-2px);
}

.send-docs-program-item.selected {
    border-color: #4CAF50; background: rgba(76, 175, 80, 0.15);
}

.send-docs-program-item.highlighted {
    border-color: #d4af37; background: rgba(212, 175, 55, 0.2);
    box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
}

/* Custom/Other File Picker */
.send-docs-custom-item {
    border: 2px dashed #d4af37 !important;
    background: linear-gradient(135deg, rgba(212,175,55,0.1), rgba(212,175,55,0.05)) !important;
    position: relative;
    overflow: hidden;
}

/* Split Item - Drive & Local */
.send-docs-split-item {
    border: 2px dashed #d4af37 !important;
    background: linear-gradient(135deg, rgba(212,175,55,0.1), rgba(212,175,55,0.05)) !important;
}

.split-btn {
    position: relative;
    overflow: hidden;
}

.split-btn::before {
    content: '';
    position: absolute;
    top: 0; left: -100%;
    width: 200%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s;
}

.split-btn:hover::before {
    left: 100%;
}

.split-drive:hover {
    background: rgba(66, 133, 244, 0.2) !important;
}

.split-local:hover {
    background: rgba(76, 175, 80, 0.2) !important;
}

.split-btn-small:hover {
    background: rgba(212, 175, 55, 0.25);
}

.send-docs-custom-item::before {
    content: '';
    position: absolute;
    top: 0; left: -100%;
    width: 200%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(212,175,55,0.2), transparent);
    animation: shimmer 3s infinite;
}

@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

.send-docs-custom-item:hover {
    border-color: #ffd700 !important;
    background: linear-gradient(135deg, rgba(212,175,55,0.25), rgba(212,175,55,0.15)) !important;
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 8px 25px rgba(212, 175, 55, 0.3);
}

.send-docs-program-item input[type="checkbox"] {
    width: 22px; height: 22px; margin-bottom: 8px;
    accent-color: #4CAF50;
}

.send-docs-program-icon {
    font-size: 1.8rem; margin-bottom: 6px;
}

.send-docs-program-name {
    color: #ffffff; font-weight: 600; font-size: 0.9rem;
}

.send-docs-program-limit {
    color: #7aa0c0; font-size: 0.7rem; margin-top: 4px;
}

/* Signature Section */
.send-docs-signature-row {
    display: flex; align-items: center; gap: 20px;
    flex-wrap: wrap;
}

.send-docs-signature-toggle {
    display: flex; align-items: center; gap: 12px;
    padding: 14px 20px; background: #1a2332;
    border: 2px solid #4a5568; border-radius: 12px;
    cursor: pointer; transition: all 0.3s;
}

.send-docs-signature-toggle.active {
    border-color: #9c27b0; background: rgba(156, 39, 176, 0.15);
}

.send-docs-signature-toggle input[type="checkbox"] {
    width: 24px; height: 24px;
    accent-color: #9c27b0;
}

.send-docs-signatory-select {
    flex: 1; padding: 14px 18px;
    background: #1a2332; border: 2px solid #4a5568;
    border-radius: 12px; color: white;
    font-size: 1rem; cursor: pointer;
    min-width: 250px;
}

.send-docs-signatory-select:focus {
    outline: none; border-color: #9c27b0;
}

/* Email Template Section */
.send-docs-template-select {
    width: 100%; padding: 16px 20px;
    background: #1a2332; border: 2px solid #4a5568;
    border-radius: 12px; color: white;
    font-size: 1rem; cursor: pointer;
}

.send-docs-template-select:focus {
    outline: none; border-color: #1976D2;
}

/* Recipients Section */
.send-docs-recipients {
    background: #1a2332; border: 2px solid #4a5568;
    border-radius: 12px; padding: 16px; max-height: 200px;
    overflow-y: auto;
}

.send-docs-recipient-row {
    display: flex; align-items: center; gap: 12px;
    padding: 10px; border-radius: 8px;
    transition: background 0.2s;
}

.send-docs-recipient-row:hover {
    background: rgba(255,255,255,0.05);
}

.send-docs-recipient-row input[type="checkbox"] {
    width: 20px; height: 20px;
    accent-color: #1976D2;
}

.send-docs-recipient-info {
    flex: 1;
}

.send-docs-recipient-name {
    color: white; font-weight: 500;
}

.send-docs-recipient-email {
    color: #7aa0c0; font-size: 0.85rem;
}

.send-docs-recipient-role {
    font-size: 0.7rem; padding: 4px 10px;
    border-radius: 20px; background: #4a5568;
    color: #b8d4e8;
}

/* Preview Section */
.send-docs-preview {
    background: #ffffff; border-radius: 12px;
    padding: 20px; color: #333; max-height: 250px;
    overflow-y: auto;
}

.send-docs-preview-placeholder {
    text-align: center; color: #999; padding: 30px;
}

/* Footer Actions - COMPACT */
.send-docs-footer {
    background: #2d3748; padding: 10px 20px;
    display: flex; justify-content: space-between;
    align-items: center; border-top: 1px solid #4a5568;
    flex-shrink: 0; gap: 15px;
}

.send-docs-footer-info {
    display: flex; flex-direction: row; gap: 10px; flex: 1; align-items: center;
}

.send-docs-attachment-count {
    background: rgba(76, 175, 80, 0.2);
    color: #4CAF50; padding: 6px 14px;
    border-radius: 20px; font-weight: 600; font-size: 0.85rem;
}

.send-docs-footer-actions {
    display: flex; gap: 10px;
}

.send-docs-btn {
    padding: 10px 20px; border: none; border-radius: 25px;
    font-family: 'Montserrat', sans-serif; font-weight: 600;
    cursor: pointer; transition: all 0.3s; font-size: 0.85rem;
    display: flex; align-items: center; gap: 8px;
}

.send-docs-btn-preview {
    background: #4a5568; color: white;
}

.send-docs-btn-preview:hover {
    background: #5a6578; transform: translateY(-2px);
}

.send-docs-btn-draft {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    color: white;
}

.send-docs-btn-draft:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(243, 156, 18, 0.4);
}

.send-docs-btn-send {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
}

.send-docs-btn-send:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(39, 174, 96, 0.4);
}

.send-docs-btn:disabled {
    opacity: 0.5; cursor: not-allowed; transform: none !important;
}

/* Status Messages */
.send-docs-status {
    padding: 12px 20px; border-radius: 10px;
    text-align: center; margin-top: 15px;
}

.send-docs-status.success {
    background: rgba(76, 175, 80, 0.2); color: #4CAF50;
}

.send-docs-status.error {
    background: rgba(231, 76, 60, 0.2); color: #e74c3c;
}

.send-docs-status.loading {
    background: rgba(25, 118, 210, 0.2); color: #1976D2;
}

/* Responsive - Mobile */
@media (max-width: 1024px) {
    .send-docs-body {
        grid-template-columns: 1fr;
        padding: 15px;
    }
    
    .send-docs-program-grid {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .send-docs-header {
        padding: 15px 20px;
    }
    
    .send-docs-header h2 {
        font-size: 1.3rem;
    }
    
    .send-docs-footer {
        flex-direction: column; gap: 15px;
    }
    
    .send-docs-footer-actions {
        width: 100%; flex-direction: column;
    }
    
    .send-docs-btn {
        width: 100%; justify-content: center;
    }
}

@media (max-width: 600px) {
    .send-docs-checkbox-grid {
        grid-template-columns: 1fr;
    }
    
    .send-docs-program-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .send-docs-signature-row {
        flex-direction: column;
    }
    
    .send-docs-signatory-select {
        width: 100%;
    }
}
</style>

<div class="send-docs-modal hidden" id="sendDocumentsModal">
    <div class="send-docs-container">
        <!-- Header -->
        <div class="send-docs-header">
            <div style="flex: 1; display: flex; align-items: center; gap: 1rem;">
                
                <div style="flex: 1;">
                    <h2 style="margin:0;">📨 Send Documents</h2>
                    <div class="send-docs-header-info">
                        <!-- Client Search (shown when no client selected) -->
                        <div id="sendDocsClientSearchContainer" style="display: flex; align-items: center; gap: 15px;">
                            <span style="color: #d4af37; font-weight: 600;">🔍 Search Client:</span>
                            <div style="position: relative;">
                                <input type="text" id="sendDocsModalClientSearch" 
                                       placeholder="Type client name..." 
                                       onkeyup="searchModalClients(this.value)"
                                   autocomplete="off"
                                   style="padding: 10px 40px 10px 15px; background: rgba(255,255,255,0.1); border: 2px solid #d4af37; border-radius: 25px; color: white; font-size: 14px; width: 300px; outline: none;">
                            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #d4af37;">🔍</span>
                            <div id="sendDocsModalClientDropdown" style="display: none; position: absolute; z-index: 100; width: 100%; max-height: 250px; overflow-y: auto; background: #1a2332; border: 2px solid #d4af37; border-radius: 12px; margin-top: 5px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
                                <!-- Search results -->
                            </div>
                        </div>
                    </div>
                    <!-- Selected Client (shown when client selected) -->
                    <div id="sendDocsSelectedClientBadge" style="display: none; align-items: center; gap: 15px;">
                        <span class="send-docs-header-badge" id="sendDocsClientName">Select Client</span>
                        <span style="color: #b0b0b0;">|</span>
                        <span style="color: #b8d4e8;" id="sendDocsContactName">Contact Name</span>
                        <button onclick="clearModalClient()" style="background: rgba(231,76,60,0.3); border: none; color: #ff6b6b; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 12px; margin-left: 10px;">✕ Change Client</button>
                    </div>
                    
                    <!-- Client Offers Section (shown after client selected) -->
                    <div id="sendDocsClientOffersContainer" style="display: none; margin-top: 10px; padding: 12px; background: rgba(30,58,95,0.5); border-radius: 12px; border: 1px solid rgba(212,168,67,0.3);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #d4af37; font-weight: 600; font-size: 0.9rem;">📋 Recent Offers</span>
                            <span id="sendDocsOffersCount" style="color: #7aa0c0; font-size: 0.8rem;">Loading...</span>
                        </div>
                        <div id="sendDocsClientOffersList" style="display: flex; flex-wrap: wrap; gap: 8px; max-height: 120px; overflow-y: auto;">
                            <!-- Offers will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            </div>
            <button class="send-docs-close" onclick="closeSendDocumentsModal()">✕</button>
        </div>
        
        <!-- Body - Two Columns -->
        <div class="send-docs-body">
            <!-- LEFT COLUMN: Document Selection -->
            <div class="send-docs-left">
                
                <!-- Contract Documents Section -->
                <div class="send-docs-section">
                    <div class="send-docs-section-header">
                        <span class="send-docs-section-icon">📄</span>
                        <h3>Contract Documents</h3>
                    </div>
                    <div class="send-docs-section-body">
                        <div class="send-docs-checkbox-grid">
                            <label class="send-docs-checkbox-item" onclick="toggleDocCheckbox(this)">
                                <input type="checkbox" name="doc_nda" value="NDA">
                                <div class="send-docs-checkbox-label">
                                    <span class="send-docs-checkbox-name">🔒 NDA</span>
                                    <span class="send-docs-checkbox-desc">Non-Disclosure Agreement</span>
                                </div>
                            </label>
                            <label class="send-docs-checkbox-item" onclick="toggleDocCheckbox(this)">
                                <input type="checkbox" name="doc_dpa" value="DPA">
                                <div class="send-docs-checkbox-label">
                                    <span class="send-docs-checkbox-name">🛡️ DPA</span>
                                    <span class="send-docs-checkbox-desc">Data Processing Agreement</span>
                                </div>
                            </label>
                            <label class="send-docs-checkbox-item" onclick="toggleDocCheckbox(this)">
                                <input type="checkbox" name="doc_asa" value="ASA">
                                <div class="send-docs-checkbox-label">
                                    <span class="send-docs-checkbox-name">📋 ASA</span>
                                    <span class="send-docs-checkbox-desc">Administrative Services Agreement</span>
                                </div>
                            </label>
                            <label class="send-docs-checkbox-item" onclick="toggleDocCheckbox(this)">
                                <input type="checkbox" name="doc_proposal" value="PROPOSAL">
                                <div class="send-docs-checkbox-label">
                                    <span class="send-docs-checkbox-name">💼 Proposal</span>
                                    <span class="send-docs-checkbox-desc">Healthcare TPA Services Proposal</span>
                                </div>
                            </label>
                            <label class="send-docs-checkbox-item" id="sendDocsCQItem" onclick="toggleDocCheckbox(this)" style="display:none; border-color: #8b5cf6;">
                                <input type="checkbox" name="doc_comparison_quote" value="COMPARISON_QUOTE">
                                <div class="send-docs-checkbox-label">
                                    <span class="send-docs-checkbox-name">📊 Comparison Quote</span>
                                    <span class="send-docs-checkbox-desc">Multi-plan comparison document</span>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Program Brochures Section -->
                <div class="send-docs-section">
                    <div class="send-docs-section-header">
                        <span class="send-docs-section-icon">📋</span>
                        <h3>Program Brochures</h3>
                        <span style="margin-left: auto; font-size: 0.8rem; color: #d4af37;">★ Highlighted = Offer programs</span>
                    </div>
                    <div class="send-docs-section-body">
                        <div class="send-docs-program-grid" id="sendDocsProgramGrid">
                            <label class="send-docs-program-item" data-program="Silver" onclick="toggleProgramCheckbox(this)">
                                <input type="checkbox" name="prog_silver" value="Silver">
                                <span class="send-docs-program-icon">🥈</span>
                                <span class="send-docs-program-name">Silver</span>
                                <span class="send-docs-program-limit">40K / 20K</span>
                            </label>
                            <label class="send-docs-program-item" data-program="Gold" onclick="toggleProgramCheckbox(this)">
                                <input type="checkbox" name="prog_gold" value="Gold">
                                <span class="send-docs-program-icon">🥇</span>
                                <span class="send-docs-program-name">Gold</span>
                                <span class="send-docs-program-limit">80K / 40K</span>
                            </label>
                            <label class="send-docs-program-item" data-program="Gold Plus" onclick="toggleProgramCheckbox(this)">
                                <input type="checkbox" name="prog_goldplus" value="Gold Plus">
                                <span class="send-docs-program-icon">🥇+</span>
                                <span class="send-docs-program-name">Gold+</span>
                                <span class="send-docs-program-limit">100K / 40K</span>
                            </label>
                            <label class="send-docs-program-item" data-program="Gold Plus Plus" onclick="toggleProgramCheckbox(this)">
                                <input type="checkbox" name="prog_goldplusplus" value="Gold Plus Plus">
                                <span class="send-docs-program-icon">🥇++</span>
                                <span class="send-docs-program-name">Gold++</span>
                                <span class="send-docs-program-limit">150K / 50K</span>
                            </label>
                            <label class="send-docs-program-item" data-program="Platinum" onclick="toggleProgramCheckbox(this)">
                                <input type="checkbox" name="prog_platinum" value="Platinum">
                                <span class="send-docs-program-icon">💎</span>
                                <span class="send-docs-program-name">Platinum</span>
                                <span class="send-docs-program-limit">180K / 40K</span>
                            </label>
                            <label class="send-docs-program-item" data-program="Diamond" onclick="toggleProgramCheckbox(this)">
                                <input type="checkbox" name="prog_diamond" value="Diamond">
                                <span class="send-docs-program-icon">💠</span>
                                <span class="send-docs-program-name">Diamond</span>
                                <span class="send-docs-program-limit">360K / 60K</span>
                            </label>
                            <label class="send-docs-program-item" data-program="Dental" onclick="toggleProgramCheckbox(this)">
                                <input type="checkbox" name="prog_dental" value="Dental">
                                <span class="send-docs-program-icon">🦷</span>
                                <span class="send-docs-program-name">Dental</span>
                                <span class="send-docs-program-limit">Add-on</span>
                            </label>
                            <!-- Custom/Other - Split into Drive and Local -->
                            <div class="send-docs-program-item send-docs-split-item" style="padding: 0; overflow: hidden; display: flex; flex-direction: row;">
                                <!-- Left: Google Drive -->
                                <div onclick="openDriveFolder(event)" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px 5px; cursor: pointer; border-right: 1px solid rgba(212,175,55,0.3); transition: all 0.2s;" class="split-btn split-drive">
                                    <span style="font-size: 1.6rem;">☁️</span>
                                    <span style="color: #d4af37; font-size: 0.7rem; font-weight: 600;">Drive</span>
                                </div>
                                <!-- Right: Local Files -->
                                <div onclick="openLocalFiles(event)" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px 5px; cursor: pointer; transition: all 0.2s;" class="split-btn split-local">
                                    <span style="font-size: 1.6rem;">💻</span>
                                    <span style="color: #d4af37; font-size: 0.7rem; font-weight: 600;">Local</span>
                                </div>
                            </div>
                            <!-- Hidden file input for local files -->
                            <input type="file" id="localFileInput" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.png,.jpg,.jpeg" style="display: none;" onchange="handleLocalFiles(event)">
                        </div>
                    </div>
                </div>
                
                <!-- Document Format & Status Section -->
                <div class="send-docs-section">
                    <div class="send-docs-section-header">
                        <span class="send-docs-section-icon">📋</span>
                        <h3>Document Format & Status</h3>
                    </div>
                    <div class="send-docs-section-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <!-- Document Format -->
                            <div>
                                <label style="display: block; color: #7aa0c0; font-size: 0.85rem; margin-bottom: 6px;">📄 Contract Documents Format</label>
                                <select id="sendDocsFormat" onchange="onDocumentFormatChange()" style="width: 100%; padding: 10px 12px; background: #1a2942; border: 1px solid #3182ce; border-radius: 8px; color: white; font-size: 0.9rem;">
                                    <option value="word">📝 Word (.docx) - For Review</option>
                                    <option value="pdf">📑 PDF - For Signature</option>
                                </select>
                                <div style="margin-top: 6px; font-size: 0.75rem; color: #d4a843;">
                                    ⚠️ Proposals & Quotes → Always PDF (locked)
                                </div>
                            </div>
                            <!-- Update Status -->
                            <div>
                                <label style="display: block; color: #7aa0c0; font-size: 0.85rem; margin-bottom: 6px;">📊 Update Status After Send</label>
                                <select id="sendDocsNewStatus" style="width: 100%; padding: 10px 12px; background: #1a2942; border: 1px solid #3182ce; border-radius: 8px; color: white; font-size: 0.9rem;">
                                    <option value="">-- No Change --</option>
                                    <option value="sent">📤 Sent</option>
                                    <option value="pending_signature">✍️ Pending Signature</option>
                                    <option value="accepted">✅ Accepted</option>
                                    <option value="rejected">❌ Rejected</option>
                                </select>
                            </div>
                        </div>
                        <div id="formatStatusHint" style="margin-top: 10px; padding: 8px 12px; background: rgba(49,130,206,0.1); border-radius: 6px; font-size: 0.8rem; color: #90cdf4; display: none;">
                            💡 Tip: PDF format is recommended when sending for signature
                        </div>
                    </div>
                </div>
                
                <!-- Signature Options Section -->
                <div class="send-docs-section">
                    <div class="send-docs-section-header">
                        <span class="send-docs-section-icon">✍️</span>
                        <h3>Signature Options</h3>
                    </div>
                    <div class="send-docs-section-body">
                        <div class="send-docs-signature-row">
                            <label class="send-docs-signature-toggle" id="signatureToggle" onclick="toggleSignatureOption()">
                                <input type="checkbox" id="sendDocsSignCheckbox">
                                <span style="color: white; font-weight: 600;">Sign Documents</span>
                            </label>
                            <select class="send-docs-signatory-select" id="sendDocsSignatory" disabled>
                                <option value="">-- Select Signatory --</option>
                                <option value="apostolos_kagelaris">Apostolos Kagelaris (CEO)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- RIGHT COLUMN: Email Settings -->
            <div class="send-docs-right">
                
                <!-- Email Template Section -->
                <div class="send-docs-section">
                    <div class="send-docs-section-header">
                        <span class="send-docs-section-icon">📝</span>
                        <h3>Email Template</h3>
                        <button onclick="openDriveTemplatesFolder()" style="margin-left: auto; padding: 6px 12px; background: linear-gradient(135deg, rgba(212,175,55,0.2), rgba(212,175,55,0.1)); border: 1px solid #d4af37; border-radius: 6px; color: #d4af37; font-size: 0.75rem; cursor: pointer;" title="Open Drive folder">
                            📂 Manage Templates
                        </button>
                    </div>
                    <div class="send-docs-section-body">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select class="send-docs-template-select" id="sendDocsTemplate" onchange="loadDriveTemplateContent(); updateSendDocsCount(); checkTemplateForSignature();" style="flex: 1;">
                                <option value="">-- Select Email Template --</option>
                                <option value="_loading" disabled>⏳ Loading from Drive...</option>
                            </select>
                            <button onclick="refreshDriveTemplates()" style="padding: 10px 14px; background: #4a5568; border: none; border-radius: 8px; color: white; cursor: pointer;" title="Refresh templates">
                                🔄
                            </button>
                        </div>
                        <div id="driveTemplateStatus" style="margin-top: 8px; font-size: 0.8rem; color: #7aa0c0;"></div>
                    </div>
                </div>
                
                <!-- Recipients Section -->
                <div class="send-docs-section">
                    <div class="send-docs-section-header">
                        <span class="send-docs-section-icon">👥</span>
                        <h3>Recipients</h3>
                    </div>
                    <div class="send-docs-section-body">
                        <div class="send-docs-recipients" id="sendDocsRecipients">
                            <p style="color: #7aa0c0; text-align: center; padding: 20px;">
                                Recipients will load from offer data...
                            </p>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap;">
    <button onclick="selectAllSendDocsRecipients()" style="padding: 8px 16px; background: #4a5568; border: none; border-radius: 20px; color: white; cursor: pointer; font-size: 0.85rem;">☑️ All</button>
    <button onclick="selectSendDocsRecipientsByRole('Primary')" style="padding: 8px 16px; background: #4a5568; border: none; border-radius: 20px; color: white; cursor: pointer; font-size: 0.85rem;">👤 Primary</button>
    <button onclick="selectSendDocsRecipientsByRole('Finance')" style="padding: 8px 16px; background: #4a5568; border: none; border-radius: 20px; color: white; cursor: pointer; font-size: 0.85rem;">💰 Finance</button>
    <button onclick="selectSendDocsRecipientsByRole('Operations')" style="padding: 8px 16px; background: #4a5568; border: none; border-radius: 20px; color: white; cursor: pointer; font-size: 0.85rem;">🔧 Operations</button>
    <button onclick="selectSendDocsRecipientsByRole('Marketing')" style="padding: 8px 16px; background: #4a5568; border: none; border-radius: 20px; color: white; cursor: pointer; font-size: 0.85rem;">📣 Marketing</button>
    <button onclick="selectSendDocsRecipientsByRole('Develop')" style="padding: 8px 16px; background: #4a5568; border: none; border-radius: 20px; color: white; cursor: pointer; font-size: 0.85rem;">💻 Develop</button>
    <button onclick="selectSendDocsRecipientsByRole('Legal')" style="padding: 8px 16px; background: #4a5568; border: none; border-radius: 20px; color: white; cursor: pointer; font-size: 0.85rem;">⚖️ Legal</button>
    <button onclick="clearAllSendDocsRecipients()" style="padding: 8px 16px; background: #4a5568; border: none; border-radius: 20px; color: white; cursor: pointer; font-size: 0.85rem;">✖️ Clear</button>
</div>
                    </div>
                </div>
                
                <!-- Email Body Section (Editable) -->
                <div class="send-docs-section" style="flex: 1;">
                    <div class="send-docs-section-header">
                        <span class="send-docs-section-icon">✏️</span>
                        <h3>Email Body</h3>
                        <span style="margin-left: auto; font-size: 0.75rem; color: #4CAF50; background: rgba(76,175,80,0.2); padding: 4px 12px; border-radius: 12px;">✎ Editable</span>
                    </div>
                    <div class="send-docs-section-body">
                        <!-- Formatting Toolbar -->
                        <div style="display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; padding: 10px; background: #1a2332; border-radius: 10px;">
                            <button onclick="formatSendDocsText('bold')" title="Bold" style="padding: 8px 12px; background: #4a5568; border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: bold;">B</button>
                            <button onclick="formatSendDocsText('italic')" title="Italic" style="padding: 8px 12px; background: #4a5568; border: none; border-radius: 6px; color: white; cursor: pointer; font-style: italic;">I</button>
                            <button onclick="formatSendDocsText('underline')" title="Underline" style="padding: 8px 12px; background: #4a5568; border: none; border-radius: 6px; color: white; cursor: pointer; text-decoration: underline;">U</button>
                            <span style="width: 1px; background: #4a5568; margin: 0 5px;"></span>
                            <button onclick="formatSendDocsText('insertUnorderedList')" title="Bullet List" style="padding: 8px 12px; background: #4a5568; border: none; border-radius: 6px; color: white; cursor: pointer;">• List</button>
                            <button onclick="formatSendDocsText('insertOrderedList')" title="Numbered List" style="padding: 8px 12px; background: #4a5568; border: none; border-radius: 6px; color: white; cursor: pointer;">1. List</button>
                            <span style="width: 1px; background: #4a5568; margin: 0 5px;"></span>
                            <button onclick="insertSendDocsLink()" title="Insert Link" style="padding: 8px 12px; background: #4a5568; border: none; border-radius: 6px; color: white; cursor: pointer;">🔗 Link</button>
                            <span style="width: 1px; background: #4a5568; margin: 0 5px;"></span>
                            <button onclick="resetSendDocsTemplate()" title="Reset to Template" style="padding: 8px 12px; background: #e74c3c; border: none; border-radius: 6px; color: white; cursor: pointer;">↺ Reset</button>
                        </div>
                        <!-- Editable Preview -->
                        <div class="send-docs-preview" id="sendDocsPreview" contenteditable="true" style="min-height: 200px; cursor: text; outline: none; border: 2px solid transparent; transition: border-color 0.3s;" onfocus="this.style.borderColor='#1976D2'" onblur="this.style.borderColor='transparent'">
                            <div class="send-docs-preview-placeholder">
                                Select a template to see preview, then edit as needed...
                            </div>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.75rem; color: #7aa0c0;">
                            💡 Tip: Click inside to edit. Use toolbar for formatting. Changes are saved automatically.
                        </div>
                    </div>
                </div>
                
                <!-- Status -->
                <div id="sendDocsStatus"></div>
            </div>
        </div>
        
        <!-- Footer - Compact Single Row -->
        <div class="send-docs-footer" style="padding: 12px 20px; gap: 15px;">
            <span class="send-docs-attachment-count" id="sendDocsAttachmentCount" style="white-space: nowrap;">📎 0 attachments</span>
            <div id="sendDocsSelectedDocs" style="display: flex; flex-wrap: wrap; gap: 4px; flex: 1; max-height: 30px; overflow: hidden;">
                <span style="color: #7aa0c0; font-size: 0.8rem;">No documents selected</span>
            </div>
            <div class="send-docs-footer-actions" style="gap: 8px;">
                <button class="send-docs-btn send-docs-btn-preview" onclick="previewSendDocs()" style="padding: 8px 16px; font-size: 0.85rem;">
                    👁️ Preview Email
                </button>
                <button class="send-docs-btn send-docs-btn-draft" onclick="saveSendDocsDraft()" style="padding: 8px 16px; font-size: 0.85rem;">
                    💾 Save Draft
                </button>
                <button class="send-docs-btn send-docs-btn-send" id="sendDocsSubmitBtn" onclick="submitSendDocs()" disabled style="padding: 8px 20px; font-size: 0.9rem;">
                    📧 Send Documents
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ═══════════════════════════════════════════════════════════════════════════════
// SEND DOCUMENTS MODAL - JavaScript Functions
// ═══════════════════════════════════════════════════════════════════════════════

// File IDs for Program Brochures
const PROGRAM_FILE_IDS = {
    'Silver': '19wzlaTn_qhx72JY5w94xmN93wKCCGy19',
    'Gold': '1qsYOCSbYJw3UyioUqBdhbAxqgxCIpk1c',
    'Gold+': '19uDXnW5Z-abm-En10UVSibyXDBuLJgtC',
    'Gold++': '1azzhFBt4xpSRljWFMjV5Y-6El4pGlf8r',
    'Platinum': '1apl63zK-UVdG-JU87VbeffVupPlTXUFp',
    'Diamond': '1pZVOjPAN-Fni4yMUlum2NVBSyy-eay-4',
    'Dental': '1xjaHu2vn2f3uOTha1O97w7EyNkSoPsXu'
};

// Signature File IDs
const SIGNATORY_FILE_IDS = {
    'apostolos_kagelaris': '1apoOaPtvftYKN1yG_t_ysTfr0mfwx7ky'
};

// Current offer data for the modal
let currentSendDocsOffer = null;
let modalSelectedClient = null;

// Open Send Documents from Email Center (without offer data - shows client search)
function openSendDocsFromEmailCenter() {
    try {
        console.log('openSendDocsFromEmailCenter called');
        
        // Close Email Center modal first
        document.getElementById('emailCenterModal').classList.add('hidden');
        console.log('Email Center closed');
        
        // Open Send Documents modal without offer data
        openSendDocumentsModal(null);
        console.log('Send Documents modal opened');
        
        // Show client search, hide selected client
        document.getElementById('sendDocsClientSearchContainer').style.display = 'flex';
        document.getElementById('sendDocsSelectedClientBadge').style.display = 'none';
        document.getElementById('sendDocsModalClientSearch').value = '';
        document.getElementById('sendDocsModalClientDropdown').style.display = 'none';
        
        // Hide offers container
        const offersContainer = document.getElementById('sendDocsClientOffersContainer');
        if (offersContainer) offersContainer.style.display = 'none';
        
        // Clear document checkboxes
        document.querySelectorAll('.send-docs-checkbox-item').forEach(item => {
            const checkbox = item.querySelector('input[type="checkbox"]');
            if (checkbox) checkbox.checked = false;
            item.classList.remove('checked');
            item.style.borderColor = '';
            item.style.background = '';
            const badge = item.querySelector('.doc-exists-badge');
            if (badge) badge.remove();
        });
        
        // Clear program selections
        document.querySelectorAll('.send-docs-program-item').forEach(item => {
            const checkbox = item.querySelector('input[type="checkbox"]');
            if (checkbox) checkbox.checked = false;
            item.classList.remove('checked');
            item.style.borderColor = '';
            item.style.background = '';
        });
        
        // Clear recipients
        document.getElementById('sendDocsRecipients').innerHTML = '<p style="color: #7aa0c0; text-align: center; padding: 20px;">🔍 Search and select a client first</p>';
        
        console.log('openSendDocsFromEmailCenter completed');
    } catch (error) {
        console.error('Error in openSendDocsFromEmailCenter:', error);
        alert('Error opening Send Docs: ' + error.message);
    }
}

// Search clients in modal
function searchModalClients(query) {
    const dropdown = document.getElementById('sendDocsModalClientDropdown');
    
    if (query.length < 2) {
        dropdown.style.display = 'none';
        return;
    }
    
    // Filter clients - search in company name and contact name
    const filtered = clientsList.filter(c => {
        if (c.id === 'all') return false;
        // c.name should be the client_name (company name)
        const companyName = c.data?.client_name || c.name || '';
        const contactName = c.data?.contact_name || '';
        return companyName.toLowerCase().includes(query.toLowerCase()) ||
               contactName.toLowerCase().includes(query.toLowerCase());
    });
    
    if (filtered.length === 0) {
        dropdown.innerHTML = '<div style="padding: 15px; color: #7aa0c0; text-align: center;">No clients found</div>';
    } else {
        dropdown.innerHTML = filtered.slice(0, 8).map(c => {
            // ALWAYS get company name from client_name field
            const companyName = (c.data?.client_name || c.name || 'Unknown').replace('🏢 ', '');
            const contactName = c.data?.contact_name || c.data?.contact_person || '';
            
            // Pass COMPANY NAME (not contact name) to selectModalClient
            return `
            <div onclick="selectModalClient('${c.id}', '${companyName.replace(/'/g, "\\'")}')" 
                 style="padding: 12px 18px; cursor: pointer; border-bottom: 1px solid #2d3748; transition: background 0.2s;"
                 onmouseover="this.style.background='rgba(212,175,67,0.2)'"
                 onmouseout="this.style.background='transparent'">
                <div style="color: #d4af37; font-weight: 600; font-size: 0.95rem;">🏢 ${companyName}</div>
                ${contactName ? `<div style="color: #7aa0c0; font-size: 0.8rem; margin-top: 2px;">👤 ${contactName}</div>` : ''}
            </div>
        `}).join('');
    }
    
    dropdown.style.display = 'block';
}

// Select client in modal
async function selectModalClient(clientId, clientName) {
    try {
        console.log('selectModalClient called:', clientId, clientName);
        
        // Hide dropdown and search
        document.getElementById('sendDocsModalClientDropdown').style.display = 'none';
        document.getElementById('sendDocsClientSearchContainer').style.display = 'none';
        
        // Get elements
        const badgeEl = document.getElementById('sendDocsSelectedClientBadge');
        const nameEl = document.getElementById('sendDocsClientName');
        const contactNameEl = document.getElementById('sendDocsContactName');
        
        // Show badge immediately with loading
        if (badgeEl) badgeEl.style.display = 'flex';
        if (nameEl) nameEl.textContent = 'Loading...';
        
        // Store selection
        modalSelectedClient = { id: clientId, name: clientName };
        
        // ALWAYS fetch fresh client data from API to ensure correct names
        let clientData = null;
        
        try {
            console.log('Fetching fresh client data from API for:', clientId);
            const response = await fetch(`${API_URL}?action=getClients`);
            const result = await response.json();
            if (result.success && result.data) {
                // Update cache with fresh data
                window.cachedClientsData = result.data;
                clientData = result.data.find(c => c.client_id === clientId);
                console.log('Fresh client data found:', clientData);
            }
        } catch (e) {
            console.log('Could not fetch client data:', e);
        }
        
        // Now set the correct names
        if (clientData) {
            // ALWAYS use client_name from database - this is the COMPANY name
            const companyName = clientData.client_name || clientName.replace('🏢 ', '');
            const contactName = clientData.contact_name || clientData.contact_person || 'Primary Contact';
            
            console.log('✅ Setting names - Company:', companyName, 'Contact:', contactName);
            
            if (nameEl) nameEl.textContent = companyName;
            if (contactNameEl) contactNameEl.textContent = contactName;
            
            modalSelectedClient.data = clientData;
            modalSelectedClient.companyName = companyName;
            modalSelectedClient.email = clientData.contact_email || clientData.email;
            
            // Store for sending
            currentSendDocsOffer = {
                clientId: clientId,
                clientName: companyName,
                contactName: contactName,
                contactEmail: clientData.contact_email || clientData.email || ''
            };
        } else {
            // Fallback - use passed name
            const cleanName = (clientName || 'Unknown').replace('🏢 ', '');
            if (nameEl) nameEl.textContent = cleanName;
            if (contactNameEl) contactNameEl.textContent = 'Primary Contact';
            
            console.log('⚠️ No client data found, using passed name:', cleanName);
            
            currentSendDocsOffer = {
                clientId: clientId,
                clientName: cleanName,
                contactName: 'Contact',
                contactEmail: ''
            };
        }
        
        // Load recipients
        try {
            await loadModalClientContacts(clientId);
        } catch (e) {
            console.log('Error loading contacts:', e);
        }
        
        // Load client offers
        try {
            await loadClientOffersForSendDocs(clientId, currentSendDocsOffer.clientName);
        } catch (e) {
            console.log('Error loading offers:', e);
        }
        
        // Update count
        updateSendDocsCount();
        
    } catch (error) {
        console.error('Error in selectModalClient:', error);
        const nameEl = document.getElementById('sendDocsClientName');
        if (nameEl && clientName) {
            nameEl.textContent = clientName.replace('🏢 ', '');
        }
        document.getElementById('sendDocsContactName').textContent = 'Contact';
    }
}

// Load offers for selected client in Send Documents modal
async function loadClientOffersForSendDocs(clientId, clientName) {
    const container = document.getElementById('sendDocsClientOffersList');
    const countEl = document.getElementById('sendDocsOffersCount');
    const offersContainer = document.getElementById('sendDocsClientOffersContainer');
    
    if (!container || !offersContainer) return;
    
    // Show container and loading state
    offersContainer.style.display = 'block';
    container.innerHTML = '<span style="color: #7aa0c0;">Loading offers...</span>';
    
    try {
        // Try to use cached offers first
        let offers = [];
        if (typeof offersData !== 'undefined' && offersData && offersData.length > 0) {
            offers = offersData.filter(o => 
                o.client_id === clientId || 
                o.client_name === clientName ||
                o.client_name?.toLowerCase() === clientName?.toLowerCase()
            );
            console.log('Using cached offers for client:', offers.length);
        }
        
        // If no cached data, fetch from API and update cache
        if (offers.length === 0) {
            const response = await fetch(`${API_URL}?action=getOffers`);
            const result = await response.json();
            if (result.success && result.data) {
                // Update the global offersData cache
                if (typeof offersData === 'undefined' || !offersData) {
                    window.offersData = result.data;
                } else {
                    // Merge new data
                    result.data.forEach(newOffer => {
                        if (!offersData.find(o => o.offer_id === newOffer.offer_id)) {
                            offersData.push(newOffer);
                        }
                    });
                }
                
                offers = result.data.filter(o => 
                    o.client_id === clientId || 
                    o.client_name === clientName ||
                    o.client_name?.toLowerCase() === clientName?.toLowerCase()
                );
                console.log('Fetched and cached offers for client:', offers.length);
            }
        }
        
        // Sort by date (newest first) and take last 10
        offers.sort((a, b) => new Date(b.created_at || b.date_created || 0) - new Date(a.created_at || a.date_created || 0));
        const recentOffers = offers.slice(0, 10);
        
        countEl.textContent = `${recentOffers.length} offer${recentOffers.length !== 1 ? 's' : ''} found`;
        
        if (recentOffers.length === 0) {
            container.innerHTML = '<span style="color: #7aa0c0; font-style: italic;">No offers found for this client</span>';
            return;
        }
        
        // Render offer cards
        container.innerHTML = recentOffers.map(offer => {
            const dateRaw = offer.created_at || offer.date_created || offer.created;
            let dateStr = 'No date';
            if (dateRaw) {
                const date = new Date(dateRaw);
                if (!isNaN(date.getTime())) {
                    dateStr = date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: '2-digit' });
                }
            }
            const status = (offer.status || 'draft').toLowerCase();
            const total = parseFloat(offer.grand_total_usd || offer.total_amount || 0);
            const members = parseInt(offer.total_members || 0);
            
            // Status colors
            const statusColors = {
                'draft': '#95a5a6',
                'sent': '#3498db',
                'followup1': '#f39c12',
                'followup2': '#e67e22',
                'followup3': '#e74c3c',
                'follow-up 1': '#f39c12',
                'follow-up 2': '#e67e22',
                'follow-up 3': '#e74c3c',
                'accepted': '#27ae60',
                'signed': '#27ae60',
                'pending_signature': '#9b59b6'
            };
            const statusColor = statusColors[status] || '#95a5a6';
            
            return `
                <div class="send-docs-offer-card" onclick="selectOfferForSendDocs('${offer.offer_id}')" 
                     style="background: linear-gradient(135deg, #1a2332, #243447); border: 2px solid transparent; 
                            border-radius: 10px; padding: 10px 14px; cursor: pointer; min-width: 180px;
                            transition: all 0.2s; position: relative;"
                     onmouseover="this.style.borderColor='#d4af37'; this.style.transform='translateY(-2px)';"
                     onmouseout="this.style.borderColor='transparent'; this.style.transform='translateY(0)';"
                     data-offer-id="${offer.offer_id}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                        <span style="color: #d4af37; font-weight: 600; font-size: 0.85rem;">${offer.offer_id}</span>
                        <button onclick="event.stopPropagation(); viewOfferFromSendDocs('${offer.offer_id}')" 
                                style="background: rgba(52,152,219,0.3); border: none; color: #3498db; 
                                       padding: 3px 8px; border-radius: 8px; cursor: pointer; font-size: 0.75rem;"
                                title="Preview Offer">👁️</button>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #7aa0c0; font-size: 0.75rem;">${dateStr}</span>
                        <span style="background: ${statusColor}33; color: ${statusColor}; padding: 2px 8px; 
                                     border-radius: 8px; font-size: 0.7rem; text-transform: uppercase;">${status}</span>
                    </div>
                    <div style="margin-top: 6px; display: flex; justify-content: space-between;">
                        <span style="color: #fff; font-size: 0.8rem;">$${total.toLocaleString()}</span>
                        <span style="color: #95a5a6; font-size: 0.75rem;">${members} members</span>
                    </div>
                </div>
            `;
        }).join('');
        
        console.log('Rendered', recentOffers.length, 'offers for client');
        
    } catch (error) {
        console.error('Error loading client offers:', error);
        container.innerHTML = '<span style="color: #e74c3c;">Error loading offers</span>';
    }
}

// Select an offer and load its documents
async function selectOfferForSendDocs(offerId) {
    console.log('Selecting offer for Send Docs:', offerId);
    
    // FIRST: Clear ALL previous selections before loading new offer
    clearAllDocumentSelections();
    
    // Highlight selected offer card
    document.querySelectorAll('.send-docs-offer-card').forEach(card => {
        card.style.borderColor = card.dataset.offerId === offerId ? '#d4af37' : 'transparent';
        card.style.background = card.dataset.offerId === offerId 
            ? 'linear-gradient(135deg, #2a3a4a, #344a5a)' 
            : 'linear-gradient(135deg, #1a2332, #243447)';
    });
    
    // Find the offer data
    let offer = null;
    if (typeof offersData !== 'undefined' && offersData) {
        offer = offersData.find(o => o.offer_id === offerId);
    }
    
    if (!offer) {
        try {
            const response = await fetch(`${API_URL}?action=getOffers`);
            const result = await response.json();
            if (result.success && result.data) {
                offer = result.data.find(o => o.offer_id === offerId);
            }
        } catch (e) {
            console.log('Could not fetch offer:', e);
        }
    }
    
    if (!offer) {
        console.error('Offer not found:', offerId);
        return;
    }
    
    // Store offer data for sending
    currentSendDocsOffer = {
        ...currentSendDocsOffer,
        offerId: offerId,
        offer: offer
    };
    
    // Load offer documents from cache or API
    await loadOfferDocumentsForSendDocs(offerId);
    
    // Highlight programs from the offer
    highlightOfferPrograms(offer);
}

// Clear all document and program selections
function clearAllDocumentSelections() {
    // Clear document checkboxes
    document.querySelectorAll('.send-docs-checkbox-item').forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        if (checkbox) checkbox.checked = false;
        item.classList.remove('checked');
        item.style.borderColor = '';
        item.style.background = '';
        const badge = item.querySelector('.doc-exists-badge');
        if (badge) badge.remove();
    });
    
    // Clear program selections
    document.querySelectorAll('.send-docs-program-item').forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        if (checkbox) checkbox.checked = false;
        item.classList.remove('checked');
        item.style.borderColor = '';
        item.style.background = '';
    });
    
    console.log('Cleared all previous document/program selections');
}

// Load documents for selected offer
async function loadOfferDocumentsForSendDocs(offerId) {
    console.log('Loading documents for offer:', offerId);
    
    // Check cached document links first
    let docs = null;
    if (window.cachedDocumentLinks && window.cachedDocumentLinks[offerId]) {
        docs = window.cachedDocumentLinks[offerId];
        console.log('Using cached documents for offer');
    } else {
        // Fetch from API
        try {
            const response = await fetch(`${API_URL}?action=getAllOffersDocuments`);
            const result = await response.json();
            if (result.success && result.data && result.data[offerId]) {
                docs = result.data[offerId];
            }
        } catch (e) {
            console.log('Could not fetch offer documents:', e);
        }
    }
    
    // Helper to extract URL
    const getUrl = (doc) => {
        if (!doc) return null;
        if (typeof doc === 'string') return doc;
        return doc.url || doc.drive_url || doc.fileUrl || null;
    };
    
    // Auto-check document checkboxes based on what exists
    const ndaUrl = docs ? getUrl(docs.nda) : null;
    const dpaUrl = docs ? getUrl(docs.dpa) : null;
    const asaUrl = docs ? getUrl(docs.asa) : null;
    const proposalUrl = docs ? getUrl(docs.proposal) : null;
    
    // Check/uncheck and highlight checkboxes
    const checkboxes = {
        'doc_nda': ndaUrl,
        'doc_dpa': dpaUrl,
        'doc_asa': asaUrl,
        'doc_proposal': proposalUrl
    };
    
    Object.keys(checkboxes).forEach(name => {
        const checkbox = document.querySelector(`input[name="${name}"]`);
        const label = checkbox?.closest('.send-docs-checkbox-item');
        
        if (checkbox && label) {
            const hasDoc = !!checkboxes[name];
            checkbox.checked = hasDoc;
            label.classList.toggle('checked', hasDoc);
            
            // Add visual indicator if document exists
            if (hasDoc) {
                label.style.borderColor = '#27ae60';
                label.style.background = 'rgba(39, 174, 96, 0.1)';
                // Add "exists" badge if not already there
                if (!label.querySelector('.doc-exists-badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'doc-exists-badge';
                    badge.style.cssText = 'position: absolute; top: 5px; right: 5px; background: #27ae60; color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 8px;';
                    badge.textContent = '✓ Ready';
                    label.style.position = 'relative';
                    label.appendChild(badge);
                }
            } else {
                label.style.borderColor = '';
                label.style.background = '';
                const badge = label.querySelector('.doc-exists-badge');
                if (badge) badge.remove();
            }
        }
    });
    
    // Store document URLs for sending
    currentSendDocsOffer.documents = {
        nda: ndaUrl,
        dpa: dpaUrl,
        asa: asaUrl,
        proposal: proposalUrl
    };
    
    // Update attachment count
    updateSendDocsCount();
    
    // Show notification
    const docCount = [ndaUrl, dpaUrl, asaUrl, proposalUrl].filter(Boolean).length;
    if (docCount > 0) {
        console.log(`✅ Loaded ${docCount} documents from offer ${offerId}`);
    } else {
        console.log(`⚠️ No documents found for offer ${offerId}`);
    }
}

// Highlight programs from the selected offer
function highlightOfferPrograms(offer) {
    // Use currentViewOffer if no offer passed
    offer = offer || window.currentViewOffer;
    
    if (!offer) {
        console.log('No offer to highlight programs');
        return;
    }
    
    // Parse offer items to get programs
    let programs = [];
    try {
        if (offer.items) {
            const items = typeof offer.items === 'string' ? JSON.parse(offer.items) : offer.items;
            programs = items.map(item => (item.plan_name || item.program || '').toLowerCase().trim()).filter(Boolean);
        }
    } catch (e) {
        console.log('Could not parse offer items:', e);
    }
    
    console.log('Offer programs to highlight:', programs);
    
    // Extract individual plan components from plan names
    // "Gold+ + Dental" -> ["gold+", "dental"]
    // "Gold++" -> ["gold++"]
    // "Silver" -> ["silver"]
    const planComponents = [];
    programs.forEach(planName => {
        // Split by " + " (space-plus-space) to get components
        // This ensures "Gold+" stays as "Gold+" and doesn't split on the +
        const parts = planName.split(' + ');
        parts.forEach(part => {
            const cleaned = part.trim().toLowerCase();
            if (cleaned && !planComponents.includes(cleaned)) {
                planComponents.push(cleaned);
            }
        });
    });
    
    console.log('Plan components to match:', planComponents);
    
    // First, deselect all program brochures
    document.querySelectorAll('.send-docs-program-item').forEach(item => {
        item.classList.remove('selected', 'checked');
        item.style.borderColor = '';
        item.style.background = '';
        const checkbox = item.querySelector('input[type="checkbox"]');
        if (checkbox) checkbox.checked = false;
    });
    
    // Then select only matching programs
    document.querySelectorAll('.send-docs-program-item').forEach(item => {
        const nameEl = item.querySelector('.send-docs-program-name');
        if (!nameEl) return;
        
        const brochureName = nameEl.textContent.toLowerCase().trim();
        
        // Check if this brochure matches any plan component
        const shouldSelect = planComponents.some(comp => {
            // Exact match or close match
            return comp === brochureName || 
                   comp.replace(/\s+/g, '') === brochureName.replace(/\s+/g, '') ||
                   (comp.includes('dental') && brochureName === 'dental');
        });
        
        if (shouldSelect) {
            item.classList.add('selected', 'checked');
            item.style.borderColor = '#d4af37';
            item.style.background = 'rgba(212, 175, 55, 0.15)';
            const checkbox = item.querySelector('input[type="checkbox"]');
            if (checkbox) checkbox.checked = true;
            console.log('✅ Auto-selected program:', brochureName);
        }
    });
    
    // Update attachment count after programs are set
    updateSendDocsCount();
}

// View offer preview from Send Docs
function viewOfferFromSendDocs(offerId) {
    console.log('Viewing offer from Send Docs:', offerId);
    
    // Check if offersData is loaded
    if (typeof offersData === 'undefined' || !offersData || offersData.length === 0) {
        alert('Please wait for offers to load, then try again');
        return;
    }
    
    // Find the offer first to verify it exists
    const offer = offersData.find(o => o.offer_id === offerId);
    if (!offer) {
        alert('Offer not found: ' + offerId);
        return;
    }
    
    // Call viewOffer with the offerId string
    if (typeof viewOffer === 'function') {
        viewOffer(offerId);
    } else {
        alert('Offer preview not available');
    }
}

// Clear selected client in modal
function clearModalClient() {
    modalSelectedClient = null;
    currentSendDocsOffer = null;
    
    // Show search, hide badge
    document.getElementById('sendDocsClientSearchContainer').style.display = 'flex';
    document.getElementById('sendDocsSelectedClientBadge').style.display = 'none';
    document.getElementById('sendDocsModalClientSearch').value = '';
    
    // Hide offers container
    const offersContainer = document.getElementById('sendDocsClientOffersContainer');
    if (offersContainer) offersContainer.style.display = 'none';
    
    // Clear document checkboxes
    document.querySelectorAll('.send-docs-checkbox-item').forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        if (checkbox) checkbox.checked = false;
        item.classList.remove('checked');
        item.style.borderColor = '';
        item.style.background = '';
        const badge = item.querySelector('.doc-exists-badge');
        if (badge) badge.remove();
    });
    
    // Clear program selections
    document.querySelectorAll('.send-docs-program-item').forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        if (checkbox) checkbox.checked = false;
        item.classList.remove('checked');
        item.style.borderColor = '';
        item.style.background = '';
    });
    
    // Clear recipients
    document.getElementById('sendDocsRecipients').innerHTML = '<p style="color: #7aa0c0; text-align: center; padding: 20px;">🔍 Search and select a client first</p>';
    
    updateSendDocsCount();
}

// Load contacts for modal
async function loadModalClientContacts(clientId) {
    const container = document.getElementById('sendDocsRecipients');
    container.innerHTML = '<p style="color: #7aa0c0; text-align: center; padding: 20px;">Loading contacts...</p>';
    
    try {
        // Try to get contacts from API (use clientId parameter)
        const response = await fetch(`${API_URL}?action=getClientContacts&clientId=${clientId}`);
        const result = await response.json();
        
        if (result.success && result.data && result.data.length > 0) {
            container.innerHTML = result.data.map((contact, idx) => `
                <div class="send-docs-recipient-row">
                    <input type="checkbox" id="sendDocsRecip_${idx}" checked onchange="updateSendDocsCount()">
                    <div class="send-docs-recipient-info">
                        <div class="send-docs-recipient-name">${contact.contact_name || 'Unknown'}</div>
                        <div class="send-docs-recipient-email">${contact.email || 'No email'}</div>
                    </div>
                    <span class="send-docs-recipient-role">${contact.role || 'Contact'}</span>
                </div>
            `).join('');
            // Update count after loading recipients
            setTimeout(() => updateSendDocsCount(), 100);
            return;
        }
    } catch (err) {
        console.log('ClientContacts API not available, using fallback:', err);
    }
    
    // Fallback: Use client data from selection
    const client = modalSelectedClient?.data || currentSendDocsOffer;
    const contactEmail = client?.contact_email || client?.contactEmail || client?.email;
    const contactName = client?.contact_name || client?.contactName || client?.contact_person || 'Primary Contact';
    
    if (contactEmail) {
        container.innerHTML = `
            <div class="send-docs-recipient-row">
                <input type="checkbox" id="sendDocsRecip_0" checked onchange="updateSendDocsCount()">
                <div class="send-docs-recipient-info">
                    <div class="send-docs-recipient-name">${contactName}</div>
                    <div class="send-docs-recipient-email">${contactEmail}</div>
                </div>
                <span class="send-docs-recipient-role">Primary</span>
            </div>
        `;
    } else {
        container.innerHTML = '<p style="color: #7aa0c0; text-align: center; padding: 20px;">No contacts found. Add contacts to this client first.</p>';
    }
}

// Open Send Documents Modal
function openSendDocumentsModal(offerData = null) {
    try {
        console.log('openSendDocumentsModal called with:', offerData);
        
        const modal = document.getElementById('sendDocumentsModal');
        if (!modal) {
            throw new Error('sendDocumentsModal not found');
        }
        modal.classList.remove('hidden');
        console.log('Modal visible');
        
        // Store offer data
        currentSendDocsOffer = offerData;
        
        // Reset selections
        resetSendDocsSelections();
        console.log('Selections reset');
        
        // Load email templates from Drive
        if (driveEmailTemplates.length === 0) {
            loadDriveTemplates();
        }
        
        // Handle Comparison Quote vs Standard Offer documents
        const cqItem = document.getElementById('sendDocsCQItem');
        const proposalItem = document.querySelector('input[value="PROPOSAL"]')?.closest('.send-docs-checkbox-item');
        const dpaItem = document.querySelector('input[value="DPA"]')?.closest('.send-docs-checkbox-item');
        const asaItem = document.querySelector('input[value="ASA"]')?.closest('.send-docs-checkbox-item');
        
        console.log('CQ Item element:', cqItem);
        console.log('offerData.isComparison:', offerData?.isComparison);
        
        if (offerData && offerData.isComparison) {
            console.log('This is a COMPARISON offer - showing CQ item');
            // Show CQ document, hide Proposal (DPA/ASA still available but not typical for CQ)
            if (cqItem) {
                cqItem.style.display = 'block';
                // Auto-select CQ document
                const cqCheckbox = cqItem.querySelector('input[type="checkbox"]');
                if (cqCheckbox) {
                    cqCheckbox.checked = true;
                    cqItem.classList.add('selected');
                    console.log('CQ checkbox auto-selected');
                }
            }
            if (proposalItem) proposalItem.style.display = 'none';
            // DPA and ASA remain visible but not highlighted for CQ
        } else {
            console.log('This is a STANDARD offer - hiding CQ item');
            // Standard offer - hide CQ, show Proposal
            if (cqItem) cqItem.style.display = 'none';
            if (proposalItem) proposalItem.style.display = 'block';
        }
        
        // If offer data provided, populate the modal and hide search
        if (offerData) {
            document.getElementById('sendDocsClientSearchContainer').style.display = 'none';
            document.getElementById('sendDocsSelectedClientBadge').style.display = 'flex';
            // Set currentViewOffer for program highlighting
            window.currentViewOffer = offerData;
            populateSendDocsFromOffer(offerData);
        } else {
            // Show search for client selection
            document.getElementById('sendDocsClientSearchContainer').style.display = 'flex';
            document.getElementById('sendDocsSelectedClientBadge').style.display = 'none';
            // Hide CQ option when no offer context
            if (cqItem) cqItem.style.display = 'none';
            if (proposalItem) proposalItem.style.display = 'block';
        }
        
        updateSendDocsCount();
        console.log('openSendDocumentsModal completed');
    } catch (error) {
        console.error('Error in openSendDocumentsModal:', error);
        alert('Error opening modal: ' + error.message);
    }
}

// Close Send Documents Modal
function closeSendDocumentsModal() {
    const modal = document.getElementById('sendDocumentsModal');
    modal.classList.add('hidden');
    currentSendDocsOffer = null;
    
    // Clear cache and reload document links when closing modal
    window.cachedDocumentLinks = null;
    if (window.dataCache) window.dataCache.documentLinks = false;
    
    // Reload document links after a short delay
    setTimeout(() => {
        if (typeof loadOfferDocumentLinksFromDB === 'function') {
            loadOfferDocumentLinksFromDB();
        }
    }, 300);
}

// Reset all selections
function resetSendDocsSelections() {
    try {
        console.log('resetSendDocsSelections started');
        
        // Uncheck all document checkboxes
        document.querySelectorAll('#sendDocumentsModal input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });
        
        // Remove selected/highlighted classes
        document.querySelectorAll('.send-docs-checkbox-item').forEach(item => {
            item.classList.remove('selected');
        });
        document.querySelectorAll('.send-docs-program-item').forEach(item => {
            item.classList.remove('selected', 'highlighted');
        });
        
        // Reset signature - check if elements exist
        const signatureToggle = document.getElementById('signatureToggle');
        if (signatureToggle) signatureToggle.classList.remove('active');
        
        const sendDocsSignatory = document.getElementById('sendDocsSignatory');
        if (sendDocsSignatory) {
            sendDocsSignatory.disabled = true;
            sendDocsSignatory.value = '';
        }
        
        // Reset template
        const sendDocsTemplate = document.getElementById('sendDocsTemplate');
        if (sendDocsTemplate) sendDocsTemplate.value = '';
        
        // Reset document format and status
        const sendDocsFormat = document.getElementById('sendDocsFormat');
        if (sendDocsFormat) sendDocsFormat.value = 'word';
        
        const sendDocsNewStatus = document.getElementById('sendDocsNewStatus');
        if (sendDocsNewStatus) sendDocsNewStatus.value = '';
        
        const formatStatusHint = document.getElementById('formatStatusHint');
        if (formatStatusHint) formatStatusHint.style.display = 'none';
        
        // Reset preview
        const sendDocsPreview = document.getElementById('sendDocsPreview');
        if (sendDocsPreview) sendDocsPreview.innerHTML = '<div class="send-docs-preview-placeholder">Select a template to see preview</div>';
        
        // Reset status
        const sendDocsStatus = document.getElementById('sendDocsStatus');
        if (sendDocsStatus) sendDocsStatus.innerHTML = '';
        
        // Reset client search
        const sendDocsModalClientSearch = document.getElementById('sendDocsModalClientSearch');
        if (sendDocsModalClientSearch) sendDocsModalClientSearch.value = '';
        
        const sendDocsModalClientDropdown = document.getElementById('sendDocsModalClientDropdown');
        if (sendDocsModalClientDropdown) sendDocsModalClientDropdown.style.display = 'none';
        
        modalSelectedClient = null;
        
        // Update header
        const sendDocsClientName = document.querySelectorAll('#sendDocsClientName');
        sendDocsClientName.forEach(el => el.textContent = 'Select Client');
        
        const sendDocsContactName = document.querySelectorAll('#sendDocsContactName');
        sendDocsContactName.forEach(el => el.textContent = 'Contact Name');
        
        console.log('resetSendDocsSelections completed');
    } catch (error) {
        console.error('Error in resetSendDocsSelections:', error);
    }
}

// Populate modal from offer data
async function populateSendDocsFromOffer(offer) {
    // Update header - use querySelectorAll to update ALL elements with these IDs
    document.querySelectorAll('#sendDocsClientName').forEach(el => {
        el.textContent = offer.clientName || 'Unknown Client';
    });
    document.querySelectorAll('#sendDocsContactName').forEach(el => {
        el.textContent = offer.contactName || 'Unknown Contact';
    });
    
    console.log('Header updated - Client:', offer.clientName, 'Contact:', offer.contactName);
    
    // Highlight programs from offer
    if (offer.programs && Array.isArray(offer.programs)) {
        offer.programs.forEach(program => {
            const programItem = document.querySelector(`.send-docs-program-item[data-program="${program}"]`);
            if (programItem) {
                programItem.classList.add('highlighted');
                // Auto-select highlighted programs
                const checkbox = programItem.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    checkbox.checked = true;
                    programItem.classList.add('selected');
                }
            }
        });
    }
    
    // Load generated documents and mark which ones are available
    await loadOfferGeneratedDocuments(offer.offerId || offer.clientId);
    
    // Load recipients (now async)
    await loadSendDocsRecipients(offer);
    
    // Highlight programs from the offer items
    highlightOfferPrograms(window.currentViewOffer);
    
    // Update count - use setTimeout to ensure DOM is updated
    setTimeout(() => {
        updateSendDocsCount();
        console.log('Final updateSendDocsCount called');
    }, 200);
}

// Load generated documents for offer and update UI
async function loadOfferGeneratedDocuments(offerId) {
    if (!offerId) {
        console.log('loadOfferGeneratedDocuments: No offerId provided');
        return;
    }
    
    try {
        console.log('═══════════════════════════════════════════');
        console.log('loadOfferGeneratedDocuments: Loading docs for', offerId);
        const docs = await getOfferDocuments(offerId);
        console.log('Documents found:', JSON.stringify(docs, null, 2));
        
        // Update document checkboxes with availability status
        // Include comparison_quote for CQ offers
        const docTypes = ['nda', 'dpa', 'asa', 'proposal', 'comparison_quote'];
        
        docTypes.forEach(docType => {
            const checkbox = document.querySelector(`#sendDocumentsModal input[value="${docType.toUpperCase()}"]`);
            console.log(`Looking for ${docType.toUpperCase()}: checkbox found = ${!!checkbox}, doc exists = ${!!docs[docType]}, fileId = ${docs[docType]?.fileId || 'none'}`);
            if (!checkbox) return;
            
            const item = checkbox.closest('.send-docs-checkbox-item');
            if (!item) return;
            
            if (docs[docType] && docs[docType].fileId) {
                // Document exists - mark as available
                item.style.borderColor = '#4CAF50';
                item.setAttribute('data-file-id', docs[docType].fileId);
                item.setAttribute('data-file-url', docs[docType].fileUrl || '');
                
                // Add "Available" badge
                let badge = item.querySelector('.doc-available-badge');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'doc-available-badge';
                    badge.style.cssText = 'position: absolute; top: 5px; right: 5px; background: #4CAF50; color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 8px;';
                    badge.textContent = '✓ v' + (docs[docType].version || 1);
                    item.style.position = 'relative';
                    item.appendChild(badge);
                } else {
                    badge.textContent = '✓ v' + (docs[docType].version || 1);
                }
            } else {
                // Document not generated yet
                item.style.borderColor = '#4a5568';
                item.removeAttribute('data-file-id');
                item.removeAttribute('data-file-url');
                
                // Remove badge if exists
                const badge = item.querySelector('.doc-available-badge');
                if (badge) badge.remove();
            }
        });
        
    } catch (err) {
        console.error('Error loading offer documents:', err);
    }
}

// Load recipients from offer/client data AND from API
async function loadSendDocsRecipients(offer) {
    const container = document.getElementById('sendDocsRecipients');
    
    // Show loading
    container.innerHTML = '<p style="color: #7aa0c0; text-align: center; padding: 20px;">⏳ Loading contacts...</p>';
    
    const recipients = [];
    
    // 1. Add primary contact from offer
    if (offer.contactEmail) {
        recipients.push({
            name: offer.contactName || 'Primary Contact',
            email: offer.contactEmail,
            role: 'Primary'
        });
    }
    
    // 2. Try to load additional contacts from API
    if (offer.clientId) {
        try {
            const response = await fetch(`${API_URL}?action=getClientContacts&clientId=${offer.clientId}`);
            const result = await response.json();
            
            if (result.success && result.data && result.data.length > 0) {
                result.data.forEach(contact => {
                    // Don't add duplicate emails
                    const emailExists = recipients.some(r => r.email === contact.email || r.email === contact.contact_email);
                    if (!emailExists && (contact.email || contact.contact_email)) {
                        recipients.push({
                            name: contact.name || contact.contact_name || 'Contact',
                            email: contact.email || contact.contact_email,
                            role: contact.role || contact.contact_role || 'Contact'
                        });
                    }
                });
            }
        } catch (err) {
            console.error('Error loading client contacts:', err);
        }
    }
    
    // 3. If still no recipients, show message
    if (recipients.length === 0) {
        container.innerHTML = '<p style="color: #7aa0c0; text-align: center; padding: 20px;">No recipients found. Add contacts to the client first.</p>';
        return;
    }
    
    // 4. Build recipients HTML
    let html = '';
    recipients.forEach((r, index) => {
        html += `
            <div class="send-docs-recipient-row">
                <input type="checkbox" id="sendDocsRecip_${index}" checked onchange="updateSendDocsCount()">
                <div class="send-docs-recipient-info">
                    <div class="send-docs-recipient-name">${r.name}</div>
                    <div class="send-docs-recipient-email">${r.email}</div>
                </div>
                <span class="send-docs-recipient-role">${r.role}</span>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Update count after recipients loaded
    setTimeout(() => updateSendDocsCount(), 100);
}

// Toggle document checkbox
function toggleDocCheckbox(element) {
    const checkbox = element.querySelector('input[type="checkbox"]');
    // checkbox.checked = !checkbox.checked; // Toggle is handled by label click
    
    if (checkbox.checked) {
        element.classList.add('selected');
    } else {
        element.classList.remove('selected');
    }
    
    updateSendDocsCount();
}

// Toggle program checkbox
function toggleProgramCheckbox(element) {
    const checkbox = element.querySelector('input[type="checkbox"]');
    
    if (checkbox.checked) {
        element.classList.add('selected');
    } else {
        element.classList.remove('selected');
    }
    
    updateSendDocsCount();
}

// ═══════════════════════════════════════════════════════════════
// CUSTOM FILE PICKER - Split into Drive and Local
// ═══════════════════════════════════════════════════════════════
const CUSTOM_FILES_FOLDER_URL = 'https://drive.google.com/drive/folders/15mkQBf1Cpf1myga-0TZetbrsRZ65OiED';

// Track selected local files
let selectedLocalFiles = [];

// Open Google Drive folder
function openDriveFolder(event) {
    event.preventDefault();
    event.stopPropagation();
    
    window.open(CUSTOM_FILES_FOLDER_URL, '_blank');
    
    showFilePickerNotification('drive');
}

// Open local file picker
function openLocalFiles(event) {
    event.preventDefault();
    event.stopPropagation();
    
    document.getElementById('localFileInput').click();
}

// Handle selected local files
function handleLocalFiles(event) {
    const files = event.target.files;
    if (files.length === 0) return;
    
    selectedLocalFiles = Array.from(files);
    
    // Show notification with file names
    showFilePickerNotification('local', selectedLocalFiles);
    
    // Update count
    updateSendDocsCount();
}

// Show notification for file picker
function showFilePickerNotification(type, files = []) {
    const existing = document.getElementById('customFileNotification');
    if (existing) existing.remove();
    
    let content = '';
    
    if (type === 'drive') {
        content = `
            <div style="display: flex; align-items: flex-start; gap: 15px;">
                <span style="font-size: 2.5rem;">☁️</span>
                <div>
                    <h4 style="margin: 0 0 8px 0; color: #d4af37; font-size: 1.1rem;">Google Drive Opened</h4>
                    <p style="margin: 0 0 12px 0; font-size: 0.9rem; opacity: 0.9;">
                        Your Drive folder is now open in a new tab.
                    </p>
                    <p style="margin: 0 0 15px 0; font-size: 0.85rem; opacity: 0.8;">
                        📌 Copy the file's share link and paste it in the email body.
                    </p>
                    <button onclick="this.closest('#customFileNotification').remove()" style="
                        background: #d4af37; color: #1e3a5f; border: none;
                        padding: 8px 20px; border-radius: 6px; font-weight: 700;
                        cursor: pointer; font-size: 0.85rem;
                    ">Got it!</button>
                </div>
            </div>
        `;
    } else if (type === 'local') {
        const fileList = files.map(f => `<li style="margin: 2px 0;">📄 ${f.name}</li>`).join('');
        content = `
            <div style="display: flex; align-items: flex-start; gap: 15px;">
                <span style="font-size: 2.5rem;">💻</span>
                <div>
                    <h4 style="margin: 0 0 8px 0; color: #4CAF50; font-size: 1.1rem;">
                        ✅ ${files.length} File${files.length > 1 ? 's' : ''} Selected
                    </h4>
                    <ul style="margin: 0 0 12px 0; padding-left: 20px; font-size: 0.85rem; opacity: 0.9; max-height: 100px; overflow-y: auto;">
                        ${fileList}
                    </ul>
                    <p style="margin: 0 0 15px 0; font-size: 0.8rem; opacity: 0.7;">
                        These files will be attached when you send the email.
                    </p>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="clearLocalFiles()" style="
                            background: #e74c3c; color: white; border: none;
                            padding: 8px 15px; border-radius: 6px; font-weight: 600;
                            cursor: pointer; font-size: 0.8rem;
                        ">Clear</button>
                        <button onclick="this.closest('#customFileNotification').remove()" style="
                            background: #4CAF50; color: white; border: none;
                            padding: 8px 20px; border-radius: 6px; font-weight: 700;
                            cursor: pointer; font-size: 0.85rem;
                        ">OK</button>
                    </div>
                </div>
            </div>
        `;
    }
    
    const notification = document.createElement('div');
    notification.id = 'customFileNotification';
    notification.innerHTML = `
        <div style="
            position: fixed; top: 20px; right: 20px;
            background: linear-gradient(135deg, #1e3a5f, #2d5a87);
            border: 2px solid ${type === 'drive' ? '#d4af37' : '#4CAF50'};
            border-radius: 12px; padding: 20px 25px; color: white;
            z-index: 100000; box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            max-width: 400px; animation: slideIn 0.3s ease;
        ">
            ${content}
        </div>
        <style>
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        </style>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 10 seconds for drive, keep for local until dismissed
    if (type === 'drive') {
        setTimeout(() => {
            if (document.getElementById('customFileNotification')) {
                document.getElementById('customFileNotification').remove();
            }
        }, 8000);
    }
}

// Clear selected local files
function clearLocalFiles() {
    selectedLocalFiles = [];
    document.getElementById('localFileInput').value = '';
    document.getElementById('customFileNotification').remove();
    updateSendDocsCount();
    
    // Show cleared notification briefly
    const toast = document.createElement('div');
    toast.innerHTML = `
        <div style="
            position: fixed; top: 20px; right: 20px;
            background: #e74c3c; color: white;
            padding: 12px 20px; border-radius: 8px;
            z-index: 100000; font-weight: 600;
            animation: slideIn 0.3s ease;
        ">
            🗑️ Local files cleared
        </div>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}

// Get selected local files (for use in send function)
function getSelectedLocalFiles() {
    return selectedLocalFiles;
}

// ═══════════════════════════════════════════════════════════════
// EMAIL TEMPLATES FROM GOOGLE DRIVE
// ═══════════════════════════════════════════════════════════════
const EMAIL_TEMPLATES_FOLDER_URL = 'https://drive.google.com/drive/folders/15mkQBf1Cpf1myga-0TZetbrsRZ65OiED';
let driveEmailTemplates = [];
let currentDriveTemplateContent = null;

// Load email templates from Drive on page load
async function loadDriveTemplates() {
    const select = document.getElementById('sendDocsTemplate');
    const statusDiv = document.getElementById('driveTemplateStatus');
    
    if (!select) return;
    
    try {
        const EMAIL_TEMPLATES_FOLDER_ID = '1cj4aLgolPRwJvjRrkiNAUhQ7ZD_HRfE2';
        // Show loading
        select.innerHTML = '<option value="">-- Select Email Template --</option><option value="_loading" disabled>⏳ Loading from Drive...</option>';
        if (statusDiv) statusDiv.innerHTML = '⏳ Fetching templates from Drive...';
        
        const response = await fetch(`${API_URL}?action=getEmailTemplatesFromDrive`);
        const result = await response.json();
        
        if (result.success && result.data) {
            driveEmailTemplates = result.data;
            
            // Build dropdown
            select.innerHTML = '<option value="">-- Select Email Template --</option>';
            
            if (result.data.length === 0) {
                select.innerHTML += '<option value="" disabled>📭 No templates found in folder</option>';
                if (statusDiv) statusDiv.innerHTML = '📭 No templates found. <a href="' + EMAIL_TEMPLATES_FOLDER_URL + '" target="_blank" style="color: #d4af37;">Add templates to Drive</a>';
            } else {
                result.data.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.icon + ' ' + template.name;
                    option.title = template.fullName + ' (Last updated: ' + new Date(template.lastUpdated).toLocaleDateString() + ')';
                    select.appendChild(option);
                });
                
                if (statusDiv) statusDiv.innerHTML = '✅ ' + result.count + ' templates loaded from Drive';
                
                // Clear status after 3 seconds
                setTimeout(() => {
                    if (statusDiv) statusDiv.innerHTML = '';
                }, 3000);
            }
        } else {
            throw new Error(result.error || 'Failed to load templates');
        }
        
    } catch (error) {
        console.error('Error loading Drive templates:', error);
        select.innerHTML = '<option value="">-- Select Email Template --</option><option value="" disabled>❌ Error loading templates</option>';
        if (statusDiv) statusDiv.innerHTML = '❌ Error: ' + error.message + ' <button onclick="refreshDriveTemplates()" style="background: #4a5568; border: none; color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Retry</button>';
    }
}

// Refresh templates from Drive
function refreshDriveTemplates() {
    loadDriveTemplates();
}

// Open Drive templates folder
function openDriveTemplatesFolder() {
    window.open(EMAIL_TEMPLATES_FOLDER_URL, '_blank');
}

// Load template content when selected
async function loadDriveTemplateContent() {
    const select = document.getElementById('sendDocsTemplate');
    const templateId = select.value;
    const previewDiv = document.getElementById('sendDocsPreview');
    
    if (!templateId || templateId === '_loading') {
        currentDriveTemplateContent = null;
        if (previewDiv) previewDiv.innerHTML = '<p style="color: #7aa0c0; text-align: center;">Select a template to preview...</p>';
        updateSendDocsCount();
        return;
    }
    
    try {
        // Show loading in preview
        if (previewDiv) previewDiv.innerHTML = '<p style="color: #7aa0c0; text-align: center;">⏳ Loading template content...</p>';
        
        const response = await fetch(`${API_URL}?action=getEmailTemplateContent&templateId=${encodeURIComponent(templateId)}`);
        const result = await response.json();
        
        if (result.success && result.content) {
            currentDriveTemplateContent = result.content;
            
            // Replace placeholders with offer data if available
            let processedContent = replaceTemplatePlaceholders(result.content);
            
            if (previewDiv) {
                previewDiv.innerHTML = processedContent;
            }
            
            // Find the template info
            const templateInfo = driveEmailTemplates.find(t => t.id === templateId);
            if (templateInfo) {
                const statusDiv = document.getElementById('driveTemplateStatus');
                if (statusDiv) statusDiv.innerHTML = '✏️ Editing: ' + templateInfo.name + ' <a href="' + templateInfo.url + '" target="_blank" style="color: #d4af37; font-size: 0.7rem;">(Open in Drive)</a>';
            }
            
        } else {
            throw new Error(result.error || 'Failed to load content');
        }
        
    } catch (error) {
        console.error('Error loading template content:', error);
        if (previewDiv) previewDiv.innerHTML = '<p style="color: #e74c3c; text-align: center;">❌ Error loading template: ' + error.message + '</p>';
    }
    
    updateSendDocsCount();
}

// Replace placeholders in template content
function replaceTemplatePlaceholders(content) {
    if (!content) return content;
    
    // Get current offer data from the modal
    const clientName = document.getElementById('sendDocsClientName')?.textContent || '{{CLIENT_NAME}}';
    const offerId = document.getElementById('sendDocsOfferId')?.textContent || '{{OFFER_ID}}';
    
    // Get contact info from recipients if available
    let contactName = '{{CONTACT_NAME}}';
    const primaryRecipient = document.querySelector('#sendDocsRecipients .send-docs-recipient-row');
    if (primaryRecipient) {
        const nameSpan = primaryRecipient.querySelector('.send-docs-recipient-name');
        if (nameSpan) contactName = nameSpan.textContent.split(' ')[0]; // First name
    }
    
    // Common placeholders
    const replacements = {
        '{{CLIENT_NAME}}': clientName,
        '{{COMPANY_NAME}}': clientName,
        '{{CONTACT_NAME}}': contactName,
        '{{CONTACT_PERSON}}': contactName,
        '{{FIRST_NAME}}': contactName.split(' ')[0],
        '{{OFFER_ID}}': offerId,
        '{{DATE}}': new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
        '{{YEAR}}': new Date().getFullYear().toString(),
        '{{SENDER_NAME}}': 'Apostolos Kagelaris',
        '{{SENDER_TITLE}}': 'CEO',
        '{{SENDER_COMPANY}}': 'Polaris Financial Services Ltd'
    };
    
    // Apply replacements
    let processed = content;
    for (const [placeholder, value] of Object.entries(replacements)) {
        processed = processed.replace(new RegExp(placeholder.replace(/[{}]/g, '\\$&'), 'gi'), value);
    }
    
    return processed;
}

// Reset to original template content
function resetSendDocsTemplate() {
    if (currentDriveTemplateContent) {
        const previewDiv = document.getElementById('sendDocsPreview');
        if (previewDiv) {
            previewDiv.innerHTML = replaceTemplatePlaceholders(currentDriveTemplateContent);
        }
    }
}

// Initialize templates when Send Documents modal opens
function initSendDocsTemplates() {
    // Load Drive templates if not already loaded
    if (driveEmailTemplates.length === 0) {
        loadDriveTemplates();
    }
}

// Toggle signature option
// Document Format Change Handler
function onDocumentFormatChange() {
    const formatSelect = document.getElementById('sendDocsFormat');
    const statusSelect = document.getElementById('sendDocsNewStatus');
    const hintDiv = document.getElementById('formatStatusHint');
    const signCheckbox = document.getElementById('sendDocsSignCheckbox');
    
    if (formatSelect.value === 'pdf') {
        // PDF selected - suggest Pending Signature status
        if (statusSelect.value === '' || statusSelect.value === 'sent') {
            statusSelect.value = 'pending_signature';
        }
        if (hintDiv) {
            hintDiv.style.display = 'block';
            hintDiv.innerHTML = '✍️ PDF format selected - Status set to "Pending Signature"';
        }
        // Also check the sign documents checkbox
        if (signCheckbox && !signCheckbox.checked) {
            signCheckbox.checked = true;
            toggleSignatureOption();
        }
    } else {
        // Word selected
        if (statusSelect.value === 'pending_signature') {
            statusSelect.value = 'sent';
        }
        if (hintDiv) {
            hintDiv.style.display = 'block';
            hintDiv.innerHTML = '📝 Word format - Documents can be reviewed and edited by recipient';
        }
        // Uncheck sign documents
        if (signCheckbox && signCheckbox.checked) {
            signCheckbox.checked = false;
            toggleSignatureOption();
        }
    }
}

// Auto-detect format based on template selection
function checkTemplateForSignature() {
    const templateSelect = document.getElementById('sendDocsTemplate');
    const formatSelect = document.getElementById('sendDocsFormat');
    
    if (templateSelect && formatSelect) {
        const templateText = templateSelect.options[templateSelect.selectedIndex]?.text?.toLowerCase() || '';
        
        // If template name contains "signature" or "sign", auto-select PDF
        if (templateText.includes('signature') || templateText.includes('sign') || templateText.includes('υπογραφ')) {
            formatSelect.value = 'pdf';
            onDocumentFormatChange();
        }
    }
}

function toggleSignatureOption() {
    const toggle = document.getElementById('signatureToggle');
    const checkbox = document.getElementById('sendDocsSignCheckbox');
    const signatory = document.getElementById('sendDocsSignatory');
    
    if (checkbox.checked) {
        toggle.classList.add('active');
        signatory.disabled = false;
    } else {
        toggle.classList.remove('active');
        signatory.disabled = true;
        signatory.value = '';
    }
}

// Update attachment count
function updateSendDocsCount() {
    let count = 0;
    let selectedNames = [];
    
    // Count documents
    document.querySelectorAll('.send-docs-checkbox-item input:checked').forEach(cb => {
        count++;
        selectedNames.push({ name: cb.value, type: 'doc' });
    });
    
    // Count programs
    document.querySelectorAll('.send-docs-program-item input:checked').forEach(cb => {
        count++;
        selectedNames.push({ name: cb.value + ' Brochure', type: 'prog' });
    });
    
    // Count local files
    if (typeof selectedLocalFiles !== 'undefined' && selectedLocalFiles.length > 0) {
        count += selectedLocalFiles.length;
        selectedLocalFiles.forEach(f => selectedNames.push({ name: f.name, type: 'file' }));
    }
    
    // Update attachment count
    const attachmentEl = document.getElementById('sendDocsAttachmentCount');
    if (attachmentEl) {
        attachmentEl.textContent = `📎 ${count} attachment${count !== 1 ? 's' : ''}`;
    }
    
    // Update selected docs display - show ALL as badges
    const docsContainer = document.getElementById('sendDocsSelectedDocs');
    if (docsContainer) {
        if (count > 0) {
            docsContainer.innerHTML = selectedNames.map(item => {
                const colors = {
                    'doc': { bg: 'rgba(212,168,67,0.2)', border: '#d4a843', text: '#d4a843' },
                    'prog': { bg: 'rgba(52,152,219,0.2)', border: '#3498db', text: '#3498db' },
                    'file': { bg: 'rgba(46,204,113,0.2)', border: '#2ecc71', text: '#2ecc71' }
                };
                const c = colors[item.type] || colors.doc;
                return `<span style="background: ${c.bg}; border: 1px solid ${c.border}; color: ${c.text}; 
                                     padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; white-space: nowrap;">
                            ${item.name}
                        </span>`;
            }).join('');
        } else {
            docsContainer.innerHTML = '<span style="color: #7aa0c0;">No documents selected</span>';
        }
    }
    
    // Check recipients
    const recipientCheckboxes = document.querySelectorAll('#sendDocsRecipients input[type="checkbox"]:checked');
    const hasRecipients = recipientCheckboxes.length > 0;
    
    // Check template - be more flexible with the check
    const templateSelect = document.getElementById('sendDocsTemplate');
    const templateValue = templateSelect ? templateSelect.value : '';
    const hasTemplate = templateValue && templateValue !== '' && templateValue !== '_loading';
    
    // Debug logging
    console.log('📧 Send Docs Check:', {
        attachments: count,
        hasRecipients: hasRecipients,
        recipientCount: recipientCheckboxes.length,
        templateValue: templateValue,
        hasTemplate: hasTemplate
    });
    
    // Enable/disable send button - just require attachments and recipients
    const submitBtn = document.getElementById('sendDocsSubmitBtn');
    if (submitBtn) {
        // Simple check: has attachments AND has recipients
        const canSend = count > 0 && hasRecipients;
        submitBtn.disabled = !canSend;
        
        // Visual feedback
        if (canSend) {
            submitBtn.style.opacity = '1';
            submitBtn.style.cursor = 'pointer';
            submitBtn.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
            submitBtn.style.pointerEvents = 'auto';
        } else {
            submitBtn.style.opacity = '0.5';
            submitBtn.style.cursor = 'not-allowed';
            submitBtn.style.background = '#4a5568';
            submitBtn.style.pointerEvents = 'none';
        }
        
        console.log('📧 Send Check: attachments=' + count + ', recipients=' + hasRecipients + ', canSend=' + canSend);
    }
}

// Recipients selection functions
function selectAllSendDocsRecipients() {
    document.querySelectorAll('#sendDocsRecipients input[type="checkbox"]').forEach(cb => cb.checked = true);
    updateSendDocsCount();
}

function selectSendDocsRecipientsByRole(role) {
    document.querySelectorAll('#sendDocsRecipients .send-docs-recipient-row').forEach(row => {
        const roleSpan = row.querySelector('.send-docs-recipient-role');
        const checkbox = row.querySelector('input[type="checkbox"]');
        if (roleSpan && roleSpan.textContent === role) {
            checkbox.checked = true;
        }
    });
    updateSendDocsCount();
}

function clearAllSendDocsRecipients() {
    document.querySelectorAll('#sendDocsRecipients input[type="checkbox"]').forEach(cb => cb.checked = false);
    updateSendDocsCount();
}

// Preview full email - Opens in new window
function previewSendDocs() {
    const template = document.getElementById('sendDocsTemplate').value;
    if (!template) {
        showSendDocsStatus('Please select an email template first.', 'error');
        return;
    }
    
    // Get email body content
    const emailBody = document.getElementById('sendDocsPreview').innerHTML;
    const clientName = document.getElementById('sendDocsClientName').textContent;
    const contactName = document.getElementById('sendDocsContactName').textContent;
    
    // Get selected attachments
    const attachments = [];
    document.querySelectorAll('.send-docs-checkbox-item input:checked').forEach(cb => {
        attachments.push(cb.value);
    });
    document.querySelectorAll('.send-docs-program-item input:checked').forEach(cb => {
        attachments.push(cb.value + ' Brochure');
    });
    
    // Create preview window
    const previewWindow = window.open('', 'EmailPreview', 'width=700,height=600,scrollbars=yes');
    previewWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Email Preview - ${clientName}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
                .email-container { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto; }
                .email-header { background: #1e3a5f; color: white; padding: 20px; border-radius: 8px 8px 0 0; }
                .email-to { padding: 15px 20px; border-bottom: 1px solid #eee; color: #666; }
                .email-body { padding: 20px; }
                .attachments { background: #f9f9f9; padding: 15px 20px; border-top: 1px solid #eee; }
                .attachment-item { display: inline-block; background: #e3f2fd; color: #1976d2; padding: 5px 12px; border-radius: 15px; margin: 3px; font-size: 12px; }
            </style>
        </head>
        <body>
            <div class="email-container">
                <div class="email-header">
                    <strong>📧 Email Preview</strong><br>
                    <small>From: Polaris Financial Services</small>
                </div>
                <div class="email-to">
                    <strong>To:</strong> ${contactName} (${clientName})
                </div>
                <div class="email-body">
                    ${emailBody}
                </div>
                ${attachments.length > 0 ? `
                <div class="attachments">
                    <strong>📎 Attachments (${attachments.length}):</strong><br>
                    ${attachments.map(a => `<span class="attachment-item">${a}</span>`).join('')}
                </div>
                ` : ''}
            </div>
            <p style="text-align: center; margin-top: 20px; color: #666;">
                <button onclick="window.print()" style="padding: 10px 20px; background: #1976d2; color: white; border: none; border-radius: 5px; cursor: pointer;">🖨️ Print</button>
                <button onclick="window.close()" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">✕ Close</button>
            </p>
        </body>
        </html>
    `);
    previewWindow.document.close();
    
    showSendDocsStatus('Preview opened in new window!', 'success');
}

// Save as draft to Gmail
async function saveSendDocsDraft() {
    showSendDocsStatus('💾 Saving draft to Gmail...', 'loading');
    
    // Collect all data
    const draftData = collectSendDocsData();
    
    if (draftData.recipients.length === 0) {
        showSendDocsStatus('Please select at least one recipient.', 'error');
        return;
    }
    
    console.log('Saving draft:', draftData);
    
    try {
        const response = await fetch(`${API_URL}?action=createEmailDraft`, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({
                action: 'createEmailDraft',
                clientId: draftData.offerId ? null : draftData.clientName,
                clientName: draftData.clientName,
                contactName: draftData.contactName,
                recipients: draftData.recipients,
                documents: draftData.documents,
                programs: draftData.programs,
                emailBody: draftData.emailBody,
                template: draftData.template,
                signDocs: draftData.signDocs,
                signatory: draftData.signatoryId,
                signatureFileId: draftData.signatureFileId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSendDocsStatus('✅ Draft saved to Gmail! Check your drafts folder.', 'success');
        } else {
            showSendDocsStatus('❌ ' + (result.error || 'Failed to save draft'), 'error');
        }
    } catch (err) {
        console.error('Draft save error:', err);
        showSendDocsStatus('❌ Error saving draft: ' + err.message, 'error');
    }
}

// ═══════════════════════════════════════════════════════════════════════════
// GLOBAL STATUS INDICATOR - Shows processing status in header
// ═══════════════════════════════════════════════════════════════════════════

function showGlobalStatus(message, icon = '📧') {
    const indicator = document.getElementById('globalStatusIndicator');
    const iconEl = document.getElementById('globalStatusIcon');
    const textEl = document.getElementById('globalStatusText');
    
    if (indicator && iconEl && textEl) {
        iconEl.textContent = icon;
        textEl.textContent = message;
        indicator.style.display = 'flex';
        indicator.style.animation = 'statusSlideIn 0.3s ease forwards, pulse 1.5s 0.3s infinite';
        console.log('🔵 Global Status:', message);
    }
}

function hideGlobalStatus() {
    const indicator = document.getElementById('globalStatusIndicator');
    if (indicator) {
        indicator.style.animation = 'none';
        indicator.style.display = 'none';
        console.log('🔵 Global Status: Hidden');
    }
}

function updateGlobalStatus(message, icon) {
    const iconEl = document.getElementById('globalStatusIcon');
    const textEl = document.getElementById('globalStatusText');
    
    if (iconEl && icon) iconEl.textContent = icon;
    if (textEl && message) textEl.textContent = message;
}

// ═══════════════════════════════════════════════════════════════════════════

// Submit and send documents
async function submitSendDocs() {
    showSendDocsStatus('📨 Preparing documents and sending email...', 'loading');
    showGlobalStatus('Preparing documents and sending email...', '📧');
    
    // Collect all data
    const sendData = collectSendDocsData();
    
    // DETAILED LOGGING
    console.log('═══════════════════════════════════════════');
    console.log('📧 SEND DOCUMENTS DATA:');
    console.log('  offerId:', sendData.offerId);
    console.log('  clientName:', sendData.clientName);
    console.log('  documents:', JSON.stringify(sendData.documents));
    console.log('  programs:', JSON.stringify(sendData.programs));
    console.log('  recipients:', JSON.stringify(sendData.recipients));
    console.log('  attachments total:', sendData.attachments.length);
    console.log('  documentFormat:', sendData.documentFormat);
    console.log('═══════════════════════════════════════════');
    
    // Validate
    if (sendData.attachments.length === 0) {
        showSendDocsStatus('Please select at least one document to send.', 'error');
        hideGlobalStatus();
        return;
    }
    
    if (sendData.recipients.length === 0) {
        showSendDocsStatus('Please select at least one recipient.', 'error');
        hideGlobalStatus();
        return;
    }
    
    // Template is optional now - just warn if missing
    if (!sendData.template && !sendData.emailBody) {
        console.warn('No template selected and no email body');
    }
    
    console.log('Sending documents:', sendData);
    
    try {
        const response = await fetch(`${API_URL}?action=sendDocumentsEmail`, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({
                action: 'sendDocumentsEmail',
                offerId: sendData.offerId,
                clientName: sendData.clientName,
                contactName: sendData.contactName,
                recipients: sendData.recipients,
                documents: sendData.documents,
                programs: sendData.programs,
                emailBody: sendData.emailBody,
                template: sendData.template,
                signDocs: sendData.signDocs,
                signatory: sendData.signatoryId,
                signatureFileId: sendData.signatureFileId,
                documentFormat: sendData.documentFormat,
                newStatus: sendData.newStatus
            })
        });
        
        const result = await response.json();
        console.log('📧 Server response:', result);
        
        if (result.success) {
            const attachCount = result.attachments || result.attachmentCount || 'unknown';
            showSendDocsStatus(`✅ Documents sent successfully to ${sendData.recipients.map(r => r.email).join(', ')} (${attachCount} attachments)`, 'success');
            hideGlobalStatus();
            
            // Update offer status if selected
            if (sendData.newStatus && sendData.offerId) {
                try {
                    console.log('Updating offer status to:', sendData.newStatus);
                    const statusUrl = API_URL + '?action=updateOfferStatus&offerId=' + encodeURIComponent(sendData.offerId) + '&status=' + encodeURIComponent(sendData.newStatus) + '&notes=Status%20updated%20after%20sending%20documents';
                    await fetch(statusUrl);
                    console.log('Status updated to:', sendData.newStatus);
                    
                    const statusNames = {
                        'sent': 'Sent',
                        'pending_signature': 'Pending Signature',
                        'accepted': 'Accepted',
                        'rejected': 'Rejected'
                    };
                    showSendDocsStatus('✅ Documents sent! Status updated to ' + (statusNames[sendData.newStatus] || sendData.newStatus), 'success');
                    
                    // Clear document links cache so it reloads fresh
                    window.cachedDocumentLinks = null;
                    if (window.dataCache) window.dataCache.documentLinks = false;
                    
                    // Refresh offers table
                    if (typeof loadOffers === 'function') {
                        loadOffers();
                    }
                } catch (statusErr) {
                    console.error('Could not update status:', statusErr);
                }
            }
            
            // Clear document links cache so it reloads fresh (even if no status update)
            window.cachedDocumentLinks = null;
            if (window.dataCache) window.dataCache.documentLinks = false;
            
            // Close modal after 3 seconds
            setTimeout(() => {
                closeSendDocumentsModal();
            }, 3000);
        } else {
            showSendDocsStatus('❌ ' + (result.error || 'Failed to send email'), 'error');
            hideGlobalStatus();
        }
    } catch (err) {
        console.error('Send error:', err);
        showSendDocsStatus('❌ Error sending: ' + err.message, 'error');
        hideGlobalStatus();
    }
}

// Collect all form data
function collectSendDocsData() {
    // Get selected documents with their file IDs
    const documents = [];
    document.querySelectorAll('.send-docs-checkbox-item input:checked').forEach(cb => {
        const item = cb.closest('.send-docs-checkbox-item');
        documents.push({
            type: cb.value,
            fileId: item?.getAttribute('data-file-id') || null,
            fileUrl: item?.getAttribute('data-file-url') || null
        });
    });
    
    // Get selected programs with their file IDs
    const programs = [];
    document.querySelectorAll('.send-docs-program-item input:checked').forEach(cb => {
        programs.push({
            name: cb.value,
            fileId: PROGRAM_FILE_IDS[cb.value]
        });
    });
    
    // Get signature info
    const signDocsCheckbox = document.getElementById('sendDocsSignCheckbox');
    const signDocs = signDocsCheckbox ? signDocsCheckbox.checked : false;
    const signatorySelect = document.getElementById('sendDocsSignatory');
    const signatoryId = signatorySelect ? signatorySelect.value : '';
    const signatureFileId = signatoryId ? SIGNATORY_FILE_IDS[signatoryId] : null;
    
    // Get recipients
    const recipients = [];
    document.querySelectorAll('#sendDocsRecipients .send-docs-recipient-row').forEach(row => {
        const checkbox = row.querySelector('input[type="checkbox"]');
        if (checkbox && checkbox.checked) {
            const emailEl = row.querySelector('.send-docs-recipient-email');
            const nameEl = row.querySelector('.send-docs-recipient-name');
            if (emailEl && nameEl) {
                recipients.push({ 
                    name: nameEl.textContent, 
                    email: emailEl.textContent 
                });
            }
        }
    });
    
    // Get template
    const template = document.getElementById('sendDocsTemplate').value;
    const emailBody = document.getElementById('sendDocsPreview').innerHTML;
    
    // Get document format and new status
    const documentFormat = document.getElementById('sendDocsFormat')?.value || 'word';
    const newStatus = document.getElementById('sendDocsNewStatus')?.value || '';
    
    // Build attachments list with file info
    const attachments = [
        ...documents.map(d => ({
            type: 'document',
            name: d.type,
            fileId: d.fileId,
            fileUrl: d.fileUrl
        })),
        ...programs.map(p => ({
            type: 'brochure',
            name: p.name,
            fileId: p.fileId
        }))
    ];
    
    return {
        offerId: currentSendDocsOffer?.offerId,
        clientId: currentSendDocsOffer?.clientId || modalSelectedClient?.id,
        clientName: document.getElementById('sendDocsClientName').textContent,
        contactName: document.getElementById('sendDocsContactName').textContent,
        documents,
        programs,
        attachments,
        signDocs,
        signatoryId,
        signatureFileId,
        recipients,
        template,
        emailBody,
        documentFormat,
        newStatus
    };
}

// Show status message
function showSendDocsStatus(message, type) {
    const status = document.getElementById('sendDocsStatus');
    status.innerHTML = `<div class="send-docs-status ${type}">${message}</div>`;
    
    // Auto-clear success messages
    if (type === 'success') {
        setTimeout(() => {
            status.innerHTML = '';
        }, 5000);
    }
}

// ═══════════════════════════════════════════════════════════════════════════════
// EMAIL BODY FORMATTING FUNCTIONS
// ═══════════════════════════════════════════════════════════════════════════════

// Store original template for reset
let originalTemplateContent = '';

// Format text in the editable preview
function formatSendDocsText(command) {
    const preview = document.getElementById('sendDocsPreview');
    preview.focus();
    document.execCommand(command, false, null);
}

// Insert link
function insertSendDocsLink() {
    const url = prompt('Enter URL:', 'https://');
    if (url) {
        const preview = document.getElementById('sendDocsPreview');
        preview.focus();
        document.execCommand('createLink', false, url);
    }
}

// Reset to original template
function resetSendDocsTemplate() {
    if (originalTemplateContent) {
        const preview = document.getElementById('sendDocsPreview');
        if (confirm('Reset to original template? Your changes will be lost.')) {
            preview.innerHTML = originalTemplateContent;
        }
    } else {
        showSendDocsStatus('No template selected to reset to.', 'error');
    }
}

// Modified updateSendDocsPreview to store original
async function updateSendDocsPreview() {
    const templateId = document.getElementById('sendDocsTemplate').value;
    const preview = document.getElementById('sendDocsPreview');
    const clientName = document.getElementById('sendDocsClientName').textContent || '{{client_name}}';
    const contactFullName = document.getElementById('sendDocsContactName').textContent || '{{contact_name}}';
    const contactName = contactFullName.split(' ')[0];
    
    if (!templateId) {
        preview.innerHTML = '<div class="send-docs-preview-placeholder">Select a template to see preview, then edit as needed...</div>';
        originalTemplateContent = '';
        return;
    }
    
    // Show loading
    preview.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Loading template...</div>';
    
    // First try to get from API (Google Drive stored templates)
    try {
        const response = await fetch(`${API_URL}?action=getEmailTemplateBody&template_id=${templateId}`);
        const result = await response.json();
        
        if (result.success && result.body_html) {
            // Use template from Google Drive
            let body = result.body_html;
            body = body.replace(/\{\{client_name\}\}/gi, clientName)
                       .replace(/\{\{contact_name\}\}/gi, contactName)
                       .replace(/\{\{contact_full_name\}\}/gi, contactFullName)
                       .replace(/\{\{date\}\}/gi, new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }))
                       .replace(/\{\{year\}\}/gi, new Date().getFullYear().toString());
            preview.innerHTML = body;
            originalTemplateContent = body;
            updateSendDocsCount();
            return;
        }
    } catch (err) {
        console.log('Could not fetch template from API, using local:', err);
    }
    
    // Use sendDocsTemplates (defined in Email Center section) if available
    if (typeof sendDocsTemplates !== 'undefined' && sendDocsTemplates[templateId]) {
        let body = sendDocsTemplates[templateId].body;
        body = body.replace(/\{\{client_name\}\}/gi, clientName)
                   .replace(/\{\{contact_name\}\}/gi, contactName)
                   .replace(/\{\{contact_full_name\}\}/gi, contactFullName)
                   .replace(/\{\{date\}\}/gi, new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }))
                   .replace(/\{\{year\}\}/gi, new Date().getFullYear().toString());
        preview.innerHTML = body;
        originalTemplateContent = body;
        updateSendDocsCount();
        return;
    }
    
    // Fallback to basic templates
    const basicTemplates = {
        'initial_contact': `<div style="font-family: Arial, sans-serif; color: #333; line-height: 1.6;">
            <p>Dear ${contactName},</p>
            <p>Thank you for your interest in <strong>Polaris Financial Services</strong> healthcare solutions for your seafarers.</p>
            <p>As a first step, please find attached our <strong>Non-Disclosure Agreement (NDA)</strong>. Once signed, we will be able to share detailed program information and pricing tailored to ${clientName}'s needs.</p>
            <p>Please review and return at your earliest convenience.</p>
            <br>
            <p>Best regards,</p>
            <p><strong>✦ POLARIS Financial Services</strong></p>
        </div>`,
        'proposal_submission': `<div style="font-family: Arial, sans-serif; color: #333; line-height: 1.6;">
            <p>Dear ${contactName},</p>
            <p>Following our recent discussions, please find attached our comprehensive <strong>Healthcare TPA Proposal</strong> for ${clientName}.</p>
            <p>The proposal includes detailed coverage options, pricing, and program benefits selected based on your requirements.</p>
            <p>We look forward to your feedback and are available to discuss any questions.</p>
            <br>
            <p>Best regards,</p>
            <p><strong>✦ POLARIS Financial Services</strong></p>
        </div>`,
        'contract_documents': `<div style="font-family: Arial, sans-serif; color: #333; line-height: 1.6;">
            <p>Dear ${contactName},</p>
            <p>We are pleased to move forward with ${clientName}'s enrollment in our healthcare program.</p>
            <p>Please find attached:</p>
            <ul>
                <li><strong>Data Processing Agreement (DPA)</strong></li>
                <li><strong>Administrative Services Agreement (ASA)</strong></li>
            </ul>
            <p>Please review, sign, and return both documents to initiate the onboarding process.</p>
            <br>
            <p>Best regards,</p>
            <p><strong>✦ POLARIS Financial Services</strong></p>
        </div>`,
        'program_info': `<div style="font-family: Arial, sans-serif; color: #333; line-height: 1.6;">
            <p>Dear ${contactName},</p>
            <p>As requested, please find attached detailed brochures for the healthcare programs we discussed.</p>
            <p>Each brochure contains comprehensive information about coverage limits, benefits, and features.</p>
            <p>Please don't hesitate to reach out with any questions.</p>
            <br>
            <p>Best regards,</p>
            <p><strong>✦ POLARIS Financial Services</strong></p>
        </div>`,
        'full_package': `<div style="font-family: Arial, sans-serif; color: #333; line-height: 1.6;">
            <p>Dear ${contactName},</p>
            <p>Please find attached a complete package of documents for ${clientName}:</p>
            <ul>
                <li>Non-Disclosure Agreement (NDA)</li>
                <li>Data Processing Agreement (DPA)</li>
                <li>Administrative Services Agreement (ASA)</li>
                <li>Healthcare Proposal</li>
                <li>Program Brochures</li>
            </ul>
            <p>We recommend reviewing each document carefully. Please contact us for any clarifications.</p>
            <br>
            <p>Best regards,</p>
            <p><strong>✦ POLARIS Financial Services</strong></p>
        </div>`,
        'followup_nda': `<div style="font-family: Arial, sans-serif; color: #333; line-height: 1.6;">
            <p>Dear ${contactName},</p>
            <p>I hope this message finds you well. I wanted to follow up on the NDA we sent previously.</p>
            <p>Once we receive the signed NDA, we can share our detailed proposal with program options and pricing for ${clientName}.</p>
            <p>Please let me know if you have any questions or need any modifications to the agreement.</p>
            <br>
            <p>Best regards,</p>
            <p><strong>✦ POLARIS Financial Services</strong></p>
        </div>`,
        'followup_proposal': `<div style="font-family: Arial, sans-serif; color: #333; line-height: 1.6;">
            <p>Dear ${contactName},</p>
            <p>I wanted to check in regarding the proposal we submitted for ${clientName}.</p>
            <p>Have you had a chance to review the coverage options and pricing? I'm happy to schedule a call to discuss any questions or adjustments.</p>
            <p>Looking forward to your feedback.</p>
            <br>
            <p>Best regards,</p>
            <p><strong>✦ POLARIS Financial Services</strong></p>
        </div>`,
        'followup_decision': `<div style="font-family: Arial, sans-serif; color: #333; line-height: 1.6;">
            <p>Dear ${contactName},</p>
            <p>I hope you're doing well. I'm following up on our proposal for ${clientName}.</p>
            <p>Is there any additional information you need to help with your decision? We're committed to providing the best healthcare solution for your team.</p>
            <p>Please let me know how we can assist.</p>
            <br>
            <p>Best regards,</p>
            <p><strong>✦ POLARIS Financial Services</strong></p>
        </div>`
    };
    
    if (basicTemplates[templateId]) {
        preview.innerHTML = basicTemplates[templateId];
        originalTemplateContent = basicTemplates[templateId];
    } else {
        preview.innerHTML = '<div class="send-docs-preview-placeholder">Template not found. Select another template.</div>';
        originalTemplateContent = '';
    }
    
    updateSendDocsCount();
}

// Listen for checkbox changes to update count
document.addEventListener('DOMContentLoaded', function() {
    // Add change listeners for checkboxes
    document.querySelectorAll('#sendDocumentsModal input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', updateSendDocsCount);
    });
});
</script>

    <!-- ═══════════════════════════════════════════════════════════════════════
         RENEWALS DASHBOARD MODAL
         ═══════════════════════════════════════════════════════════════════════ -->
    <div class="renewals-modal hidden" id="renewalsModal">
        <div class="renewals-box">
            <div class="renewals-header">
                <div style="display:flex; align-items:center; gap:1rem;">
                    
                    <h2>📋 Follow Up Dashboard</h2>
                </div>
                <div class="renewals-header-actions">
                    <button class="renewals-export-btn pdf" onclick="exportRenewalsPDF()">
                        📄 Export PDF
                    </button>
                    <button class="renewals-export-btn excel" onclick="exportRenewalsExcel()">
                        📊 Export Excel
                    </button>
                    <button class="renewals-close" onclick="closeRenewals()">✕</button>
                </div>
            </div>
            
            <div class="renewals-content">
                <!-- KPI Cards -->
                <div class="renewals-kpis">
                    <div class="renewals-kpi members">
                        <div class="renewals-kpi-icon">👥</div>
                        <div class="renewals-kpi-value" id="renewalsKpiMembers">-</div>
                        <div class="renewals-kpi-label">Total Members</div>
                        <span class="renewals-kpi-trend up" id="renewalsKpiMembersTrend">+12%</span>
                    </div>
                    <div class="renewals-kpi revenue">
                        <div class="renewals-kpi-icon">💰</div>
                        <div class="renewals-kpi-value" id="renewalsKpiRevenue">-</div>
                        <div class="renewals-kpi-label">Annual Revenue</div>
                        <span class="renewals-kpi-trend up" id="renewalsKpiRevenueTrend">+8%</span>
                    </div>
                    <div class="renewals-kpi pending">
                        <div class="renewals-kpi-icon">📝</div>
                        <div class="renewals-kpi-value" id="renewalsKpiPending">-</div>
                        <div class="renewals-kpi-label">Pending Offers</div>
                        <span class="renewals-kpi-trend neutral" id="renewalsKpiPendingTrend">Active</span>
                    </div>
                    <div class="renewals-kpi expiring">
                        <div class="renewals-kpi-icon">⚠️</div>
                        <div class="renewals-kpi-value" id="renewalsKpiExpiring">-</div>
                        <div class="renewals-kpi-label">Expiring (90 days)</div>
                        <span class="renewals-kpi-trend down" id="renewalsKpiExpiringTrend">Action Required</span>
                    </div>
                </div>
                
                <!-- Pipeline Section -->
                <div class="renewals-section">
                    <div class="renewals-section-header">
                        <div class="renewals-section-title">
                            📊 Offers Pipeline
                        </div>
                        <button onclick="refreshPipeline()" style="background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 0.4rem 0.8rem; border-radius: 8px; cursor: pointer; font-size: 0.8rem;">
                            🔄 Refresh
                        </button>
                    </div>
                    
                    <div class="scroll-container pipeline-scroll-container">
                        <button class="scroll-arrow left" onclick="this.nextElementSibling.scrollBy({left:-300,behavior:'smooth'})">◀</button>
                        <div class="scroll-content pipeline-scroll-content">
                            <div class="pipeline-kanban" id="pipelineKanban">
                        <div class="pipeline-column draft">
                            <div class="pipeline-column-header">📝 Draft <span class="pipeline-column-count" id="pipelineCountDraft">0</span></div>
                            <div class="pipeline-column-body" id="pipelineBodyDraft"></div>
                        </div>
                        <div class="pipeline-column sent">
                            <div class="pipeline-column-header">📤 Sent <span class="pipeline-column-count" id="pipelineCountSent">0</span></div>
                            <div class="pipeline-column-body" id="pipelineBodySent"></div>
                        </div>
                        <div class="pipeline-column followup1">
                            <div class="pipeline-column-header">📞 Follow-up 1 <span class="pipeline-column-count" id="pipelineCountFollowup1">0</span></div>
                            <div class="pipeline-column-body" id="pipelineBodyFollowup1"></div>
                        </div>
                        <div class="pipeline-column followup2">
                            <div class="pipeline-column-header">📞 Follow-up 2 <span class="pipeline-column-count" id="pipelineCountFollowup2">0</span></div>
                            <div class="pipeline-column-body" id="pipelineBodyFollowup2"></div>
                        </div>
                        <div class="pipeline-column followup3">
                            <div class="pipeline-column-header">🔥 Follow-up 3 <span class="pipeline-column-count" id="pipelineCountFollowup3">0</span></div>
                            <div class="pipeline-column-body" id="pipelineBodyFollowup3"></div>
                        </div>
                        <div class="pipeline-column accepted">
                            <div class="pipeline-column-header">✅ Accepted <span class="pipeline-column-count" id="pipelineCountAccepted">0</span></div>
                            <div class="pipeline-column-body" id="pipelineBodyAccepted"></div>
                        </div>
                    </div>
                        </div>
                        <button class="scroll-arrow right" onclick="this.previousElementSibling.scrollBy({left:300,behavior:'smooth'})">▶</button>
                    </div>
                </div>
                
                <!-- NEW: Pipeline Summary + Action Required (side by side) -->
                <div class="pipeline-summary-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    
                    <!-- OFFERS PIPELINE BAR CHART -->
                    <div class="renewals-section">
                        <div class="renewals-section-header">
                            <div class="renewals-section-title">📊 Offers Pipeline</div>
                        </div>
                        <div class="pipeline-bars" id="pipelineBars">
                            <div class="pipeline-bar-row">
                                <span class="bar-label">Draft</span>
                                <div class="bar-container"><div class="bar-fill draft" id="barDraft" style="width: 0%"></div></div>
                                <span class="bar-count" id="barCountDraft">0</span>
                            </div>
                            <div class="pipeline-bar-row">
                                <span class="bar-label">Sent</span>
                                <div class="bar-container"><div class="bar-fill sent" id="barSent" style="width: 0%"></div></div>
                                <span class="bar-count" id="barCountSent">0</span>
                            </div>
                            <div class="pipeline-bar-row">
                                <span class="bar-label">Follow-up 1</span>
                                <div class="bar-container"><div class="bar-fill followup1" id="barFollowup1" style="width: 0%"></div></div>
                                <span class="bar-count" id="barCountFollowup1">0</span>
                            </div>
                            <div class="pipeline-bar-row">
                                <span class="bar-label">Follow-up 2</span>
                                <div class="bar-container"><div class="bar-fill followup2" id="barFollowup2" style="width: 0%"></div></div>
                                <span class="bar-count" id="barCountFollowup2">0</span>
                            </div>
                            <div class="pipeline-bar-row">
                                <span class="bar-label">Follow-up 3</span>
                                <div class="bar-container"><div class="bar-fill followup3" id="barFollowup3" style="width: 0%"></div></div>
                                <span class="bar-count" id="barCountFollowup3">0</span>
                            </div>
                            <div class="pipeline-bar-row">
                                <span class="bar-label">Accepted</span>
                                <div class="bar-container"><div class="bar-fill accepted" id="barAccepted" style="width: 0%"></div></div>
                                <span class="bar-count" id="barCountAccepted">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ACTION REQUIRED -->
                    <div class="renewals-section">
                        <div class="renewals-section-header">
                            <div class="renewals-section-title">🔔 Action Required</div>
                        </div>
                        <div class="action-required-list" id="actionRequiredList">
                            <div class="action-item warning">
                                <span class="action-icon">⚠️</span>
                                <span class="action-text">Follow-up overdue</span>
                                <span class="action-count" id="actionOverdue">0</span>
                            </div>
                            <div class="action-item call">
                                <span class="action-icon">📞</span>
                                <span class="action-text">Call today</span>
                                <span class="action-count" id="actionCallToday">0</span>
                            </div>
                            <div class="action-item expiring">
                                <span class="action-icon">📋</span>
                                <span class="action-text">Contracts expiring</span>
                                <span class="action-count" id="actionExpiring">0</span>
                            </div>
                            <div class="action-item renewal">
                                <span class="action-icon">📧</span>
                                <span class="action-text">Send renewal</span>
                                <span class="action-count" id="actionSendRenewal">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- DETAILED VIEW TABLE -->
                <div class="renewals-section">
                    <div class="renewals-section-header">
                        <div class="renewals-section-title">📋 Detailed View</div>
                        <button onclick="printDetailedView()" style="background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 0.4rem 0.8rem; border-radius: 8px; cursor: pointer; font-size: 0.8rem;">
                            🖨️ Print
                        </button>
                    </div>
                    <div class="scroll-horizontal" style="max-height: 300px; overflow-y: auto;">
                        <table class="detailed-view-table" id="detailedViewTable">
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Stage</th>
                                    <th style="text-align: right;">Members</th>
                                    <th style="text-align: right;">Value</th>
                                    <th>Last Note</th>
                                    <th>Next Action</th>
                                </tr>
                            </thead>
                            <tbody id="detailedViewBody">
                                <tr><td colspan="6" style="text-align: center; color: var(--text-muted); padding: 2rem;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- TOTALS ROW -->
                    <div class="detailed-view-totals" id="detailedViewTotals">
                        <div class="total-item">
                            <span class="total-icon">👥</span>
                            <span class="total-value" id="totalPipelineMembers">0</span>
                            <span class="total-label">Members</span>
                        </div>
                        <div class="total-divider">|</div>
                        <div class="total-item">
                            <span class="total-icon">💰</span>
                            <span class="total-value" id="totalPipelineValue">$0</span>
                            <span class="total-label">Pipeline Value</span>
                        </div>
                    </div>
                </div>
                
                <!-- Two Column Layout: Expiring + Notes -->
                <div class="notes-grid">
                    <!-- Expiring Contracts Section -->
                    <div class="renewals-section">
                        <div class="renewals-section-header">
                            <div class="renewals-section-title">⏰ Expiring Contracts</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">
                                Total at risk: <span id="expiringTotalMembers" style="color: var(--polaris-gold); font-weight: 700;">0</span> members
                            </div>
                        </div>
                        <div class="expiring-tabs">
                            <button class="expiring-tab active" onclick="filterExpiring(30)" data-days="30">
                                🔴 30 Days <span class="count" id="expiring30Count">0</span>
                                <span style="margin-left: 5px; font-size: 0.75rem; opacity: 0.8;">• <span id="expiring30Members">0</span> 👥</span>
                            </button>
                            <button class="expiring-tab" onclick="filterExpiring(60)" data-days="60">
                                🟠 60 Days <span class="count" id="expiring60Count">0</span>
                                <span style="margin-left: 5px; font-size: 0.75rem; opacity: 0.8;">• <span id="expiring60Members">0</span> 👥</span>
                            </button>
                            <button class="expiring-tab" onclick="filterExpiring(90)" data-days="90">
                                🟡 90 Days <span class="count" id="expiring90Count">0</span>
                                <span style="margin-left: 5px; font-size: 0.75rem; opacity: 0.8;">• <span id="expiring90Members">0</span> 👥</span>
                            </button>
                        </div>
                        <div class="scroll-horizontal" style="max-height: 280px; overflow-y: auto;">
                            <table class="expiring-table">
                                <thead>
                                    <tr><th>Client</th><th>Contract</th><th style="text-align: center;">Members</th><th>Expires</th><th>Days</th><th>Action</th></tr>
                                </thead>
                                <tbody id="expiringTableBody">
                                    <tr><td colspan="6" style="text-align: center; color: var(--text-muted); padding: 2rem;">Loading expiring contracts...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Notes & Action Items with Email Templates -->
                    <div class="renewals-section">
                        <div class="renewals-section-header">
                            <div class="renewals-section-title">📧 Quick Email & Notes</div>
                        </div>
                        <div class="add-note-form">
                            <h4>➕ Send Quick Email</h4>
                            
                            <!-- Client Selection -->
                            <div style="margin-bottom: 0.75rem;">
                                <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.25rem;">Select Client</label>
                                <select id="noteClientSelect" onchange="loadClientDataForEmail()" style="width: 100%; padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary);">
                                    <option value="">Select Client...</option>
                                </select>
                            </div>
                            
                            <!-- Email Template Dropdown -->
                            <div style="margin-bottom: 0.75rem;">
                                <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.25rem;">Email Template</label>
                                <select id="renewalTemplateSelect" onchange="loadRenewalEmailTemplate()" style="width: 100%; padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary);">
                                    <option value="">Select Template...</option>
                                    <option value="followup_nda">📄 Follow-up: NDA Reminder</option>
                                    <option value="followup_proposal">📋 Follow-up: Proposal Review</option>
                                    <option value="followup_decision">⏳ Follow-up: Decision Pending</option>
                                    <option value="renewal_reminder">🔄 Renewal Reminder (30 days)</option>
                                    <option value="renewal_urgent">🔥 Renewal Urgent (expiring soon)</option>
                                    <option value="thank_you">🙏 Thank You - Contract Signed</option>
                                    <option value="meeting_request">📅 Meeting Request</option>
                                    <option value="custom">✏️ Custom Message</option>
                                </select>
                            </div>
                            
                            <!-- Recipients Selection -->
                            <div style="margin-bottom: 0.75rem;">
                                <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.25rem;">👥 Recipients</label>
                                <div id="quickEmailRecipients" style="max-height: 120px; overflow-y: auto; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem;">
                                    <div style="color: var(--text-muted); font-size: 0.85rem; text-align: center; padding: 0.5rem;">Select a client first...</div>
                                </div>
                                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                    <button type="button" onclick="selectAllQuickEmailRecipients()" style="padding: 0.25rem 0.5rem; font-size: 0.7rem; background: rgba(52,152,219,0.2); border: 1px solid #3498db; color: #3498db; border-radius: 5px; cursor: pointer;">✓ All</button>
                                    <button type="button" onclick="selectQuickEmailRecipientsByRole('Primary')" style="padding: 0.25rem 0.5rem; font-size: 0.7rem; background: rgba(231,76,60,0.2); border: 1px solid #e74c3c; color: #e74c3c; border-radius: 5px; cursor: pointer;">👤 Primary</button>
                                    <button type="button" onclick="selectQuickEmailRecipientsByRole('Finance')" style="padding: 0.25rem 0.5rem; font-size: 0.7rem; background: rgba(241,196,15,0.2); border: 1px solid #f1c40f; color: #f1c40f; border-radius: 5px; cursor: pointer;">💰 Finance</button>
                                    <button type="button" onclick="selectQuickEmailRecipientsByRole('Operations')" style="padding: 0.25rem 0.5rem; font-size: 0.7rem; background: rgba(155,89,182,0.2); border: 1px solid #9b59b6; color: #9b59b6; border-radius: 5px; cursor: pointer;">⚙️ Operations</button>
                                    <button type="button" onclick="clearAllQuickEmailRecipients()" style="padding: 0.25rem 0.5rem; font-size: 0.7rem; background: rgba(149,165,166,0.2); border: 1px solid #95a5a6; color: #95a5a6; border-radius: 5px; cursor: pointer;">✕ Clear</button>
                                </div>
                            </div>
                            
                            <!-- Subject -->
                            <div style="margin-bottom: 0.75rem;">
                                <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.25rem;">Subject</label>
                                <input type="text" id="renewalEmailSubject" placeholder="Email subject..." style="width: 100%; padding: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary);">
                            </div>
                            
                            <!-- Email Body Preview -->
                            <div style="margin-bottom: 0.75rem;">
                                <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 0.25rem;">Message Preview</label>
                                <div id="renewalEmailPreview" contenteditable="true" style="width: 100%; min-height: 120px; max-height: 200px; overflow-y: auto; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem; color: var(--text-primary); font-size: 0.9rem; line-height: 1.5;">
                                    <span style="color: var(--text-muted);">Select a client and template to preview...</span>
                                </div>
                            </div>
                            
                            <div class="note-actions">
                                <button class="note-btn note-btn-cancel" onclick="clearRenewalEmailForm()">Cancel</button>
                                <button class="note-btn" onclick="saveAsNote()" style="background: var(--bg-dark); border: 1px solid var(--polaris-gold); color: var(--polaris-gold);">📝 Save as Note</button>
                                <button class="note-btn note-btn-save" onclick="sendRenewalEmail()">📧 Send Email</button>
                            </div>
                        </div>
                        
                        <!-- Recent Notes -->
                        <div style="margin-top: 1rem;">
                            <h4 style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">Recent Activity</h4>
                            <div class="notes-list" id="notesList">
                                <div style="text-align: center; color: var(--text-muted); padding: 1rem;">No notes yet</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// ═══════════════════════════════════════════════════════════════════════════════
// RENEWALS DASHBOARD FUNCTIONS
// ═══════════════════════════════════════════════════════════════════════════════

let renewalsData = { offers: [], contracts: [], notes: [] };

function openRenewals() {
    document.getElementById('renewalsModal').classList.remove('hidden');
    document.getElementById('dashboardBtn').style.display = 'flex';
    document.getElementById('mainDashboardBtn').style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Show loading state immediately
    populateNoteClientDropdown(); // This can run immediately with cached data
    
    // Load other data in parallel
    loadRenewalsData();
}

function closeRenewals() {
    document.getElementById('renewalsModal').classList.add('hidden');
    document.body.style.overflow = '';
}

let renewalsDataLoaded = false;

async function loadRenewalsData() {
    try {
        // Run all loads in parallel for speed
        await Promise.all([
            loadRenewalsKPIs(),
            loadPipeline(),
            loadExpiringContracts(),
            loadNotes()
        ]);
        
        // Populate dropdowns after data is loaded
        populateNoteClientDropdown();
        renewalsDataLoaded = true;
        
        // Initialize scroll arrows for pipeline
        setTimeout(() => {
            if (typeof initTableScrollArrows === 'function') {
                initTableScrollArrows();
            }
        }, 200);
    } catch (e) {
        console.error('Error loading renewals data:', e);
    }
}

async function loadRenewalsKPIs() {
    try {
        const response = await fetch(`${API_URL}?action=getDashboardKPIs`);
        const result = await response.json();
        
        if (result.success && result.data) {
            const data = result.data;
            document.getElementById('renewalsKpiMembers').textContent = (data.total_members || 0).toLocaleString();
            document.getElementById('renewalsKpiRevenue').textContent = '$' + (data.annual_revenue || 0).toLocaleString();
            document.getElementById('renewalsKpiPending').textContent = data.pending_offers || 0;
            document.getElementById('renewalsKpiExpiring').textContent = data.expiring_contracts || 0;
        }
    } catch (e) {
        console.error('Error loading KPIs:', e);
        // Fallback to local calculation
        const members = document.getElementById('kpiMembers')?.textContent || '0';
        document.getElementById('renewalsKpiMembers').textContent = members;
        const memberCount = parseInt(members.replace(/,/g, '')) || 0;
        document.getElementById('renewalsKpiRevenue').textContent = '$' + (memberCount * 85).toLocaleString();
    }
}

async function loadPipeline() {
    // Try multiple sources for offers data
    let offers = [];
    
    // 1. Try offersData from preload
    if (typeof offersData !== 'undefined' && offersData && offersData.length > 0) {
        offers = offersData;
        console.log('Using cached offersData for pipeline');
    }
    // 2. Try allOffers
    else if (typeof allOffers !== 'undefined' && allOffers && allOffers.length > 0) {
        offers = allOffers;
    }
    // 3. Fetch from API
    else {
        try {
            const response = await fetch(`${API_URL}?action=getOffers`);
            const result = await response.json();
            if (result.success) offers = result.data || result.offers || [];
        } catch (e) { console.log('Could not fetch offers:', e); }
    }
    
    renewalsData.offers = offers;
    
    const stages = {
        'draft': { body: 'pipelineBodyDraft', count: 'pipelineCountDraft' },
        'sent': { body: 'pipelineBodySent', count: 'pipelineCountSent' },
        'followup1': { body: 'pipelineBodyFollowup1', count: 'pipelineCountFollowup1' },
        'followup2': { body: 'pipelineBodyFollowup2', count: 'pipelineCountFollowup2' },
        'followup3': { body: 'pipelineBodyFollowup3', count: 'pipelineCountFollowup3' },
        'accepted': { body: 'pipelineBodyAccepted', count: 'pipelineCountAccepted' }
    };
    
    Object.values(stages).forEach(stage => {
        document.getElementById(stage.body).innerHTML = '';
        document.getElementById(stage.count).textContent = '0';
    });
    
    const stageCounts = {};
    const stageData = {}; // Store offer data per stage for detailed view
    Object.keys(stages).forEach(s => {
        stageCounts[s] = 0;
        stageData[s] = [];
    });
    
    let totalPipelineMembers = 0;
    let totalPipelineValue = 0;
    
    offers.forEach(offer => {
        let status = (offer.status || 'draft').toLowerCase();
        if (status === 'follow-up 1' || status === 'followup_1') status = 'followup1';
        if (status === 'follow-up 2' || status === 'followup_2') status = 'followup2';
        if (status === 'follow-up 3' || status === 'followup_3') status = 'followup3';
        if (status === 'pending_signature' || status === 'signed') status = 'accepted';
        
        const offerValue = parseFloat(offer.total_amount || offer.grand_total_usd || offer.grand_total || 0);
        const offerMembers = parseInt(offer.total_members || 0);
        
        totalPipelineMembers += offerMembers;
        totalPipelineValue += offerValue;
        
        if (stages[status]) {
            stageCounts[status]++;
            stageData[status].push(offer);
            
            const created = new Date(offer.created_at || offer.date_created);
            const daysSince = Math.floor((new Date() - created) / (1000 * 60 * 60 * 24));
            let urgencyClass = daysSince > 30 ? 'urgent' : daysSince > 14 ? 'warning' : 'normal';
            
            const card = `<div class="pipeline-card" onclick="openOfferFromPipeline('${offer.offer_id}')">
                <div class="pipeline-card-client">${offer.client_name || 'Unknown Client'}</div>
                <div class="pipeline-card-amount">$${offerValue.toLocaleString()}</div>
                <div class="pipeline-card-date">${formatDateRenewals(offer.created_at || offer.date_created)}</div>
                <span class="pipeline-card-days ${urgencyClass}">${daysSince} days</span>
            </div>`;
            document.getElementById(stages[status].body).innerHTML += card;
        }
    });
    
    Object.entries(stages).forEach(([status, stage]) => {
        document.getElementById(stage.count).textContent = stageCounts[status];
    });
    
    // Update Pipeline Bar Chart
    updatePipelineBars(stageCounts, offers.length);
    
    // Update Detailed View Table
    updateDetailedView(offers, stageData);
    
    // Update Totals
    document.getElementById('totalPipelineMembers').textContent = totalPipelineMembers.toLocaleString();
    document.getElementById('totalPipelineValue').textContent = '$' + totalPipelineValue.toLocaleString();
    
    // Update Action Required (after expiring contracts are loaded)
    updateActionRequired(stageCounts);
}

// Update Pipeline Bar Chart
function updatePipelineBars(stageCounts, totalOffers) {
    const maxCount = Math.max(...Object.values(stageCounts), 1);
    
    const stageMapping = {
        'draft': 'Draft',
        'sent': 'Sent',
        'followup1': 'Followup1',
        'followup2': 'Followup2',
        'followup3': 'Followup3',
        'accepted': 'Accepted'
    };
    
    Object.entries(stageMapping).forEach(([key, name]) => {
        const count = stageCounts[key] || 0;
        const percentage = (count / maxCount) * 100;
        
        const bar = document.getElementById('bar' + name);
        const countEl = document.getElementById('barCount' + name);
        
        if (bar) bar.style.width = percentage + '%';
        if (countEl) countEl.textContent = count;
    });
}

// Update Detailed View Table
function updateDetailedView(offers, stageData) {
    const tbody = document.getElementById('detailedViewBody');
    if (!tbody) return;
    
    // Filter to only show active offers (not signed/completed)
    const activeOffers = offers.filter(o => {
        const status = (o.status || '').toLowerCase();
        return status !== 'signed' && status !== 'completed' && status !== 'rejected';
    });
    
    if (activeOffers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted); padding: 2rem;">No active offers in pipeline</td></tr>';
        return;
    }
    
    // Sort by date (newest first)
    activeOffers.sort((a, b) => new Date(b.created_at || b.date_created) - new Date(a.created_at || a.date_created));
    
    let html = '';
    activeOffers.slice(0, 15).forEach(offer => { // Limit to 15 rows
        let status = (offer.status || 'draft').toLowerCase();
        if (status === 'follow-up 1' || status === 'followup_1') status = 'followup1';
        if (status === 'follow-up 2' || status === 'followup_2') status = 'followup2';
        if (status === 'follow-up 3' || status === 'followup_3') status = 'followup3';
        if (status === 'pending_signature') status = 'accepted';
        
        const stageName = {
            'draft': 'Draft',
            'sent': 'Sent',
            'followup1': 'Follow-1',
            'followup2': 'Follow-2',
            'followup3': 'Follow-3',
            'accepted': 'Accepted'
        }[status] || status;
        
        const value = parseFloat(offer.total_amount || offer.grand_total_usd || offer.grand_total || 0);
        const members = parseInt(offer.total_members || 0);
        
        // Calculate next action date (created + 7 days for draft, + 3 days for others)
        const created = new Date(offer.created_at || offer.date_created);
        const nextDays = status === 'draft' ? 7 : 3;
        const nextDate = new Date(created);
        nextDate.setDate(nextDate.getDate() + nextDays);
        
        // Determine last note icon based on status
        const noteIcon = status.includes('followup') ? '📞' : status === 'sent' ? '📧' : '📝';
        const noteDate = formatDateRenewals(offer.created_at || offer.date_created);
        
        html += `<tr onclick="openOfferFromPipeline('${offer.offer_id}')" style="cursor: pointer;">
            <td><strong>${offer.client_name || 'Unknown'}</strong></td>
            <td><span class="stage-badge ${status}">${stageName}</span></td>
            <td style="text-align: right;">${members.toLocaleString()}</td>
            <td style="text-align: right; color: var(--polaris-gold); font-weight: 600;">$${value.toLocaleString()}</td>
            <td class="last-note-cell"><span class="last-note-icon">${noteIcon}</span><span class="last-note-date">${noteDate}</span></td>
            <td><span class="next-action-date">${formatDateRenewals(nextDate)}</span></td>
        </tr>`;
    });
    
    tbody.innerHTML = html;
}

// Update Action Required counts
function updateActionRequired(stageCounts) {
    // Follow-up overdue: offers in followup stages older than 7 days
    const overdueCount = (stageCounts.followup2 || 0) + (stageCounts.followup3 || 0);
    document.getElementById('actionOverdue').textContent = overdueCount;
    
    // Call today: offers in followup stages
    const callTodayCount = (stageCounts.followup1 || 0) + (stageCounts.followup2 || 0);
    document.getElementById('actionCallToday').textContent = callTodayCount;
    
    // Contracts expiring: from expiring contracts data
    const expiringCount = renewalsData.contracts ? renewalsData.contracts.length : 0;
    document.getElementById('actionExpiring').textContent = expiringCount;
    
    // Send renewal: draft offers
    const sendRenewalCount = stageCounts.draft || 0;
    document.getElementById('actionSendRenewal').textContent = sendRenewalCount;
}

// Print Detailed View
function printDetailedView() {
    const table = document.getElementById('detailedViewTable');
    const totals = document.getElementById('detailedViewTotals');
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>POLARIS - Pipeline Detailed View</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { color: #1e3a5f; border-bottom: 2px solid #d4a843; padding-bottom: 10px; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th { background: #1e3a5f; color: white; padding: 12px; text-align: left; }
                td { padding: 10px; border-bottom: 1px solid #ddd; }
                tr:nth-child(even) { background: #f9f9f9; }
                .totals { margin-top: 20px; padding: 15px; background: #f5f5f5; border-top: 3px solid #d4a843; }
                .totals span { font-weight: bold; color: #d4a843; }
                @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
            </style>
        </head>
        <body>
            <h1>✦ POLARIS - Pipeline Detailed View</h1>
            <p>Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</p>
            ${table.outerHTML}
            <div class="totals">
                <strong>TOTALS:</strong> 
                👥 <span>${document.getElementById('totalPipelineMembers').textContent}</span> Members | 
                💰 <span>${document.getElementById('totalPipelineValue').textContent}</span> Pipeline Value
            </div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

async function loadExpiringContracts() {
    try {
        const response = await fetch(`${API_URL}?action=getExpiringContracts&days=90`);
        const result = await response.json();
        
        let contracts = result.success ? (result.data || result.contracts || []) : (Array.isArray(result) ? result : []);
        renewalsData.contracts = contracts;
        
        const now = new Date();
        let count30 = 0, count60 = 0, count90 = 0;
        let members30 = 0, members60 = 0, members90 = 0;
        let totalMembers = 0;
        
        contracts.forEach(c => {
            const expiry = new Date(c.expiry_date || c.end_date);
            const daysUntil = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
            const memberCount = parseInt(c.member_count || c.members || c.total_members || 0);
            
            if (daysUntil <= 30) { count30++; members30 += memberCount; }
            else if (daysUntil <= 60) { count60++; members60 += memberCount; }
            else if (daysUntil <= 90) { count90++; members90 += memberCount; }
            totalMembers += memberCount;
        });
        
        document.getElementById('expiring30Count').textContent = count30;
        document.getElementById('expiring60Count').textContent = count60;
        document.getElementById('expiring90Count').textContent = count90;
        document.getElementById('expiring30Members').textContent = members30.toLocaleString();
        document.getElementById('expiring60Members').textContent = members60.toLocaleString();
        document.getElementById('expiring90Members').textContent = members90.toLocaleString();
        document.getElementById('expiringTotalMembers').textContent = totalMembers.toLocaleString();
        document.getElementById('renewalsKpiExpiring').textContent = contracts.length;
        
        filterExpiring(30);
    } catch (e) {
        console.error('Error loading expiring contracts:', e);
        document.getElementById('expiringTableBody').innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted); padding: 2rem;">Error loading contracts</td></tr>';
    }
}

function filterExpiring(days) {
    document.querySelectorAll('.expiring-tab').forEach(tab => {
        tab.classList.toggle('active', parseInt(tab.dataset.days) === days);
    });
    
    const now = new Date();
    const filtered = renewalsData.contracts.filter(c => {
        const expiry = new Date(c.expiry_date || c.end_date);
        const daysUntil = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
        return daysUntil <= days && daysUntil > 0;
    });
    
    const tbody = document.getElementById('expiringTableBody');
    
    if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: var(--text-muted); padding: 2rem;">No contracts expiring in ${days} days</td></tr>`;
        return;
    }
    
    filtered.sort((a, b) => new Date(a.expiry_date || a.end_date) - new Date(b.expiry_date || b.end_date));
    
    tbody.innerHTML = filtered.map(c => {
        const expiry = new Date(c.expiry_date || c.end_date);
        const daysUntil = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
        const memberCount = parseInt(c.member_count || c.members || c.total_members || 0);
        let badgeClass = daysUntil <= 30 ? 'critical' : daysUntil <= 60 ? 'warning' : 'ok';
        
        return `<tr>
            <td style="font-weight: 600;">${c.client_name || 'Unknown'}</td>
            <td>${c.contract_id || c.contract_type || 'ASA'}</td>
            <td style="text-align: center;"><span style="background: rgba(212,175,55,0.2); color: var(--polaris-gold); padding: 0.25rem 0.6rem; border-radius: 15px; font-weight: 600; font-size: 0.85rem;">${memberCount.toLocaleString()} 👥</span></td>
            <td>${formatDateRenewals(c.expiry_date || c.end_date)}</td>
            <td><span class="days-badge ${badgeClass}">${daysUntil} days</span></td>
            <td><button onclick="createRenewalOffer('${c.client_id}')" style="background: linear-gradient(135deg, #1B5E20, #2E7D32); color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 6px; cursor: pointer; font-size: 0.75rem;">🔄 Renew</button></td>
        </tr>`;
    }).join('');
}

function refreshPipeline() { allOffers = null; loadPipeline(); }

function openOfferFromPipeline(offerId) {
    closeRenewals();
    openOffersCenter();
    setTimeout(() => {
        const offer = allOffers?.find(o => o.offer_id === offerId);
        if (offer) viewOfferDetails(offer);
    }, 500);
}

function createRenewalOffer(clientId) {
    closeRenewals();
    openOffersCenter();
    setTimeout(() => {
        switchOffersTab('create');
        const clientSelect = document.getElementById('offerClientSelect');
        if (clientSelect) {
            clientSelect.value = clientId;
            clientSelect.dispatchEvent(new Event('change'));
        }
    }, 500);
}

function populateNoteClientDropdown() {
    const select = document.getElementById('noteClientSelect');
    if (!select) return;
    
    let options = '<option value="">Select Client...</option>';
    
    // Try multiple sources for client data
    let clients = [];
    
    // 1. Try cachedClientsData (from preload)
    if (window.cachedClientsData && cachedClientsData.length > 0) {
        clients = cachedClientsData;
    }
    // 2. Try allClientsData
    else if (typeof allClientsData !== 'undefined' && allClientsData.length > 0) {
        clients = allClientsData;
    }
    // 3. Try clientsList
    else if (typeof clientsList !== 'undefined' && clientsList.length > 0) {
        clients = clientsList.filter(c => c.id !== 'all').map(c => ({
            client_id: c.id,
            client_name: c.name.replace('🏢 ', ''),
            contact_email: c.email || '',
            contact_name: c.contact || ''
        }));
    }
    
    if (clients.length > 0) {
        clients.forEach(client => {
            const name = client.client_name || client.name || '';
            const id = client.client_id || client.id || name;
            const email = client.contact_email || client.email || '';
            const contact = client.contact_name || client.contact_person || '';
            options += `<option value="${id}" data-email="${email}" data-contact="${contact}">${name}</option>`;
        });
    } else {
        // Last resort - extract from offers
        const clientsFromOffers = [...new Set(renewalsData.offers.map(o => o.client_name).filter(Boolean))];
        clientsFromOffers.forEach(name => { 
            options += `<option value="${name}">${name}</option>`; 
        });
    }
    
    select.innerHTML = options;
    console.log('Note client dropdown populated with', clients.length || 0, 'clients');
    
    // Also try to load templates from API
    loadEmailTemplatesForRenewals();
}

async function loadEmailTemplatesForRenewals() {
    try {
        // Try new renewal-specific templates first
        let response = await fetch(`${API_URL}?action=getRenewalEmailTemplates`);
        let result = await response.json();
        
        // Fallback to general templates if needed
        if (!result.success || !result.templates || result.templates.length === 0) {
            response = await fetch(`${API_URL}?action=getEmailTemplates`);
            result = await response.json();
        }
        
        if (result.success && result.templates && result.templates.length > 0) {
            const select = document.getElementById('renewalTemplateSelect');
            let options = '<option value="">Select Template...</option>';
            
            result.templates.forEach(t => {
                const icon = t.category === 'followup' ? '📞' : t.category === 'renewal' ? '🔄' : '📧';
                options += `<option value="${t.template_id}" data-source="drive">${icon} ${t.template_name || t.name}</option>`;
            });
            
            options += '<option value="custom">✏️ Custom Message</option>';
            select.innerHTML = options;
        }
    } catch (e) {
        console.log('Using built-in templates:', e);
    }
}

async function loadClientDataForEmail() {
    const select = document.getElementById('noteClientSelect');
    const option = select.options[select.selectedIndex];
    const recipientsContainer = document.getElementById('quickEmailRecipients');
    
    if (!option || !option.value) {
        recipientsContainer.innerHTML = '<div style="color: var(--text-muted); font-size: 0.85rem; text-align: center; padding: 0.5rem;">Select a client first...</div>';
        return;
    }
    
    const clientId = option.value;
    const clientName = option.text;
    
    // Show loading
    recipientsContainer.innerHTML = '<div style="color: var(--text-muted); font-size: 0.85rem; text-align: center; padding: 0.5rem;">Loading contacts...</div>';
    
    try {
        // Try to fetch contacts from API
        const response = await fetch(`${API_URL}?action=getClientContacts&clientId=${clientId}`);
        const result = await response.json();
        
        if (result.success && result.data && result.data.length > 0) {
            recipientsContainer.innerHTML = result.data.map((contact, idx) => `
                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem; border-bottom: 1px solid var(--border-color);">
                    <input type="checkbox" id="quickEmailRecip_${idx}" value="${contact.email || ''}" data-role="${contact.role || 'Contact'}" checked style="cursor: pointer;">
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-size: 0.85rem; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${contact.contact_name || 'Unknown'}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${contact.email || 'No email'}</div>
                    </div>
                    <span style="font-size: 0.65rem; padding: 2px 6px; background: rgba(52,152,219,0.2); color: #3498db; border-radius: 4px;">${contact.role || 'Contact'}</span>
                </div>
            `).join('');
            
            // If template is selected, reload it with new client data
            loadRenewalEmailTemplate();
            return;
        }
    } catch (e) {
        console.log('Error fetching contacts:', e);
    }
    
    // Fallback: Use contact from the option dataset
    const email = option.dataset.email || '';
    const contact = option.dataset.contact || 'Contact';
    
    if (email) {
        recipientsContainer.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem;">
                <input type="checkbox" id="quickEmailRecip_0" value="${email}" data-role="Primary" checked style="cursor: pointer;">
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 0.85rem; color: var(--text-primary);">${contact}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">${email}</div>
                </div>
                <span style="font-size: 0.65rem; padding: 2px 6px; background: rgba(231,76,60,0.2); color: #e74c3c; border-radius: 4px;">Primary</span>
            </div>
        `;
    } else {
        recipientsContainer.innerHTML = '<div style="color: var(--text-muted); font-size: 0.85rem; text-align: center; padding: 0.5rem;">No contacts found for this client</div>';
    }
    
    // If template is selected, reload it with new client data
    loadRenewalEmailTemplate();
}

// Quick Email Recipients helper functions
function selectAllQuickEmailRecipients() {
    document.querySelectorAll('#quickEmailRecipients input[type="checkbox"]').forEach(cb => cb.checked = true);
}

function selectQuickEmailRecipientsByRole(role) {
    document.querySelectorAll('#quickEmailRecipients input[type="checkbox"]').forEach(cb => {
        if (cb.dataset.role === role) cb.checked = true;
    });
}

function clearAllQuickEmailRecipients() {
    document.querySelectorAll('#quickEmailRecipients input[type="checkbox"]').forEach(cb => cb.checked = false);
}

async function loadRenewalEmailTemplate() {
    const templateSelect = document.getElementById('renewalTemplateSelect');
    const clientSelect = document.getElementById('noteClientSelect');
    const preview = document.getElementById('renewalEmailPreview');
    const subjectInput = document.getElementById('renewalEmailSubject');
    
    const templateId = templateSelect.value;
    const clientOption = clientSelect.options[clientSelect.selectedIndex];
    
    if (!templateId) {
        preview.innerHTML = '<span style="color: var(--text-muted);">Select a client and template to preview...</span>';
        subjectInput.value = '';
        return;
    }
    
    // Get client data
    const clientName = clientOption?.text || '{{client_name}}';
    const contactName = clientOption?.dataset?.contact || '{{contact_name}}';
    const contactFirstName = contactName.split(' ')[0] || '{{contact_name}}';
    
    // Check if it's a Drive template
    if (templateSelect.options[templateSelect.selectedIndex]?.dataset?.source === 'drive') {
        try {
            // Try renewal-specific endpoint first
            let response = await fetch(`${API_URL}?action=getRenewalEmailTemplateBody&template_id=${templateId}`);
            let result = await response.json();
            
            // Fallback to general endpoint
            if (!result.success) {
                response = await fetch(`${API_URL}?action=getEmailTemplateBody&template_id=${templateId}`);
                result = await response.json();
            }
            
            if (result.success && result.body_html) {
                const body = replacePlaceholders(result.body_html, clientName, contactFirstName, contactName);
                preview.innerHTML = body;
                subjectInput.value = replacePlaceholders(result.subject || '', clientName, contactFirstName, contactName);
                return;
            }
        } catch (e) {
            console.log('Error loading Drive template:', e);
        }
    }
    
    // Built-in templates
    const templates = {
        'followup_nda': {
            subject: `Follow-up: NDA for ${clientName}`,
            body: `<p>Dear ${contactFirstName},</p>
<p>I hope this message finds you well. I wanted to follow up on the <strong>Non-Disclosure Agreement</strong> we sent previously for ${clientName}.</p>
<p>Once we receive the signed NDA, we can share our detailed proposal with program options and pricing tailored to your needs.</p>
<p>Please let me know if you have any questions or need any modifications to the agreement.</p>
<br><p>Best regards,</p>
<p><strong>✦ POLARIS Financial Services</strong></p>`
        },
        'followup_proposal': {
            subject: `Follow-up: Healthcare Proposal for ${clientName}`,
            body: `<p>Dear ${contactFirstName},</p>
<p>I wanted to check in regarding the <strong>healthcare proposal</strong> we submitted for ${clientName}.</p>
<p>Have you had a chance to review the coverage options and pricing? I'm happy to schedule a call to discuss any questions or adjustments you may need.</p>
<p>Looking forward to your feedback.</p>
<br><p>Best regards,</p>
<p><strong>✦ POLARIS Financial Services</strong></p>`
        },
        'followup_decision': {
            subject: `Checking In: ${clientName} Healthcare Decision`,
            body: `<p>Dear ${contactFirstName},</p>
<p>I hope you're doing well. I'm following up on our proposal for ${clientName}.</p>
<p>Is there any additional information you need to help with your decision? We're committed to providing the best healthcare solution for your seafarers.</p>
<p>Please let me know how we can assist.</p>
<br><p>Best regards,</p>
<p><strong>✦ POLARIS Financial Services</strong></p>`
        },
        'renewal_reminder': {
            subject: `Contract Renewal Reminder - ${clientName}`,
            body: `<p>Dear ${contactFirstName},</p>
<p>This is a friendly reminder that the <strong>healthcare services contract</strong> for ${clientName} will be expiring within the next 30 days.</p>
<p>We would like to discuss the renewal terms and any adjustments you may need for the upcoming period. Our team has prepared updated options that may better serve your seafarers' needs.</p>
<p>Please let me know a convenient time to schedule a call.</p>
<br><p>Best regards,</p>
<p><strong>✦ POLARIS Financial Services</strong></p>`
        },
        'renewal_urgent': {
            subject: `🔥 URGENT: Contract Expiring Soon - ${clientName}`,
            body: `<p>Dear ${contactFirstName},</p>
<p><strong>Important Notice:</strong> The healthcare services contract for ${clientName} is expiring very soon.</p>
<p>To ensure uninterrupted coverage for your seafarers, we need to process the renewal immediately.</p>
<p>Please contact us at your earliest convenience to finalize the renewal terms.</p>
<br><p>Best regards,</p>
<p><strong>✦ POLARIS Financial Services</strong></p>`
        },
        'thank_you': {
            subject: `Welcome to POLARIS - ${clientName}`,
            body: `<p>Dear ${contactFirstName},</p>
<p>Thank you for choosing <strong>POLARIS Financial Services</strong> as your healthcare TPA partner!</p>
<p>We have received the signed contracts and your account is now active. Our team will begin the onboarding process immediately.</p>
<p>You will receive enrollment instructions and access credentials within the next 48 hours.</p>
<p>Welcome aboard!</p>
<br><p>Best regards,</p>
<p><strong>✦ POLARIS Financial Services</strong></p>`
        },
        'meeting_request': {
            subject: `Meeting Request - ${clientName} Healthcare Review`,
            body: `<p>Dear ${contactFirstName},</p>
<p>I would like to schedule a meeting to discuss the healthcare program for ${clientName}.</p>
<p>Please let me know your availability for a 30-minute call this week. We can discuss:</p>
<ul>
<li>Coverage options and benefits</li>
<li>Pricing and payment terms</li>
<li>Implementation timeline</li>
</ul>
<p>Looking forward to speaking with you.</p>
<br><p>Best regards,</p>
<p><strong>✦ POLARIS Financial Services</strong></p>`
        },
        'custom': {
            subject: '',
            body: `<p>Dear ${contactFirstName},</p>
<p></p>
<br><p>Best regards,</p>
<p><strong>✦ POLARIS Financial Services</strong></p>`
        }
    };
    
    const template = templates[templateId];
    if (template) {
        preview.innerHTML = template.body;
        subjectInput.value = template.subject;
    }
}

function replacePlaceholders(text, clientName, contactFirstName, contactFullName) {
    return text
        .replace(/\{\{client_name\}\}/gi, clientName)
        .replace(/\{\{contact_name\}\}/gi, contactFirstName)
        .replace(/\{\{contact_full_name\}\}/gi, contactFullName)
        .replace(/\{\{date\}\}/gi, new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }))
        .replace(/\{\{year\}\}/gi, new Date().getFullYear().toString());
}

function clearRenewalEmailForm() {
    document.getElementById('noteClientSelect').value = '';
    document.getElementById('renewalTemplateSelect').value = '';
    document.getElementById('renewalEmailSubject').value = '';
    document.getElementById('renewalEmailPreview').innerHTML = '<span style="color: var(--text-muted);">Select a client and template to preview...</span>';
    document.getElementById('quickEmailRecipients').innerHTML = '<div style="color: var(--text-muted); font-size: 0.85rem; text-align: center; padding: 0.5rem;">Select a client first...</div>';
}

async function sendRenewalEmail() {
    const clientSelect = document.getElementById('noteClientSelect');
    const templateSelect = document.getElementById('renewalTemplateSelect');
    const subject = document.getElementById('renewalEmailSubject').value.trim();
    const bodyHtml = document.getElementById('renewalEmailPreview').innerHTML;
    
    // Get selected recipients
    const selectedRecipients = [];
    document.querySelectorAll('#quickEmailRecipients input[type="checkbox"]:checked').forEach(cb => {
        if (cb.value && cb.value.includes('@')) {
            selectedRecipients.push(cb.value);
        }
    });
    
    if (!clientSelect.value) { alert('Please select a client'); return; }
    if (selectedRecipients.length === 0) { alert('Please select at least one recipient'); return; }
    if (!subject) { alert('Please enter email subject'); return; }
    
    showRenewalsNotification(`📧 Sending email to ${selectedRecipients.length} recipient(s)...`, 'info');
    
    try {
        // Send to all selected recipients
        const toEmail = selectedRecipients.join(', ');
        
        // Use sendRenewalEmail backend action for proper logging
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'sendRenewalEmail',
                to_email: toEmail,
                subject: subject,
                body_html: bodyHtml,
                client_id: clientSelect.value,
                client_name: clientSelect.options[clientSelect.selectedIndex].text,
                template_id: templateSelect ? templateSelect.value : ''
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showRenewalsNotification(`✅ Email sent to ${selectedRecipients.length} recipient(s)!`, 'success');
            // Note is automatically saved by backend
            clearRenewalEmailForm();
            // Refresh notes list to show the new note
            setTimeout(() => loadNotes(), 500);
        } else {
            showRenewalsNotification('❌ Error: ' + (result.error || 'Failed to send'), 'error');
        }
    } catch (e) {
        console.error('Send email error:', e);
        showRenewalsNotification('❌ Error sending email', 'error');
    }
}

async function saveAsNote() {
    const clientSelect = document.getElementById('noteClientSelect');
    const subject = document.getElementById('renewalEmailSubject').value.trim();
    const template = document.getElementById('renewalTemplateSelect').value;
    const bodyHtml = document.getElementById('renewalEmailPreview').innerHTML;
    
    if (!clientSelect.value) { alert('Please select a client'); return; }
    
    showRenewalsNotification('📝 Saving note...', 'info');
    
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'addFollowUpNote',
                client_id: clientSelect.value,
                client_name: clientSelect.options[clientSelect.selectedIndex].text,
                note_type: 'reminder',
                content: subject || 'Note: ' + (template || 'General'),
                template_used: template,
                email_sent: 'no',
                created_by: 'Admin'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showRenewalsNotification('✅ Note saved!', 'success');
            clearRenewalEmailForm();
            setTimeout(() => loadNotes(), 500);
        } else {
            showRenewalsNotification('❌ Error: ' + (result.error || 'Failed to save'), 'error');
        }
    } catch (e) {
        console.error('Save note error:', e);
        showRenewalsNotification('❌ Error saving note', 'error');
    }
}

function saveEmailAsNote(clientName, subject) {
    const note = {
        id: Date.now(),
        client: clientName,
        content: '📧 Email sent: ' + subject,
        date: new Date().toISOString(),
        type: 'followup'
    };
    
    renewalsData.notes.unshift(note);
    localStorage.setItem('polaris_notes', JSON.stringify(renewalsData.notes));
    loadNotes();
}

async function loadNotes() {
    const container = document.getElementById('notesList');
    container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 1rem;">Loading notes...</div>';
    
    try {
        // Fetch notes from backend (FollowUpNotes sheet)
        const response = await fetch(`${API_URL}?action=getFollowUpNotes&limit=20`);
        const result = await response.json();
        
        if (result.success && result.data && result.data.length > 0) {
            renewalsData.notes = result.data;
        } else {
            // Fallback to localStorage
            const stored = localStorage.getItem('polaris_notes');
            if (stored) { 
                try { renewalsData.notes = JSON.parse(stored); } 
                catch (e) { renewalsData.notes = []; } 
            } else {
                renewalsData.notes = [];
            }
        }
    } catch (e) {
        console.log('Could not fetch notes from backend:', e);
        // Fallback to localStorage
        const stored = localStorage.getItem('polaris_notes');
        if (stored) { try { renewalsData.notes = JSON.parse(stored); } catch (e) { renewalsData.notes = []; } }
    }
    
    if (renewalsData.notes.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 1rem;">No notes yet. Send an email or add a note above!</div>';
        return;
    }
    
    container.innerHTML = renewalsData.notes.slice(0, 10).map(note => {
        // Handle different field names from backend vs localStorage
        const clientName = note.client_name || note.client || 'Unknown';
        const noteDate = note.created_at || note.date || new Date().toISOString();
        const noteType = note.note_type || note.type || 'note';
        const noteContent = note.content || note.note_text || '';
        const noteIcon = noteType.includes('email') ? '📧' : noteType.includes('call') ? '📞' : '📝';
        
        return `
            <div class="note-item">
                <div class="note-item-header">
                    <span class="note-item-client">${noteIcon} ${clientName}</span>
                    <span class="note-item-date">${formatDateRenewals(noteDate)}</span>
                </div>
                <span class="note-item-type ${noteType}">${noteType.replace('_', ' ')}</span>
                <div class="note-item-content">${noteContent}</div>
            </div>
        `;
    }).join('');
}

function exportRenewalsPDF() {
    showRenewalsNotification('Generating PDF report...', 'info');
    if (typeof jspdf !== 'undefined' || typeof jsPDF !== 'undefined') {
        const { jsPDF } = window.jspdf || window;
        const doc = new jsPDF();
        doc.setFontSize(20);
        doc.text('Polaris Follow Up Dashboard', 20, 20);
        doc.setFontSize(12);
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 30);
        doc.setFontSize(14);
        doc.text('KPIs Summary:', 20, 45);
        doc.setFontSize(11);
        doc.text(`• Total Members: ${document.getElementById('renewalsKpiMembers').textContent}`, 25, 55);
        doc.text(`• Annual Revenue: ${document.getElementById('renewalsKpiRevenue').textContent}`, 25, 62);
        doc.text(`• Pending Offers: ${document.getElementById('renewalsKpiPending').textContent}`, 25, 69);
        doc.text(`• Expiring Contracts: ${document.getElementById('renewalsKpiExpiring').textContent}`, 25, 76);
        doc.save('polaris-renewals-dashboard.pdf');
        showRenewalsNotification('PDF exported successfully!', 'success');
    } else {
        showRenewalsNotification('PDF library not loaded', 'error');
    }
}

function exportRenewalsExcel() {
    showRenewalsNotification('Generating Excel export...', 'info');
    let csv = 'Polaris Follow Up Dashboard Export\n\nKPIs\n';
    csv += `Total Members,${document.getElementById('renewalsKpiMembers').textContent}\n`;
    csv += `Annual Revenue,${document.getElementById('renewalsKpiRevenue').textContent}\n`;
    csv += `Pending Offers,${document.getElementById('renewalsKpiPending').textContent}\n`;
    csv += `Expiring Contracts,${document.getElementById('renewalsKpiExpiring').textContent}\n`;
    csv += `Members at Risk,${document.getElementById('expiringTotalMembers').textContent}\n\n`;
    csv += 'Expiring Contracts\nClient,Contract,Members,Expiry Date,Days Until\n';
    renewalsData.contracts.forEach(c => {
        const expiry = new Date(c.expiry_date || c.end_date);
        const daysUntil = Math.ceil((expiry - new Date()) / (1000 * 60 * 60 * 24));
        const memberCount = parseInt(c.member_count || c.members || c.total_members || 0);
        csv += `"${c.client_name || 'Unknown'}","${c.contract_id || 'ASA'}",${memberCount},"${formatDateRenewals(expiry)}",${daysUntil}\n`;
    });
    csv += '\nPipeline Offers\nClient,Status,Amount,Created\n';
    renewalsData.offers.forEach(o => {
        csv += `"${o.client_name || 'Unknown'}","${o.status || 'draft'}","$${o.total_amount || 0}","${formatDateRenewals(o.created_at)}"\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'polaris-renewals-export.csv';
    link.click();
    showRenewalsNotification('Excel/CSV exported successfully!', 'success');
}

function formatDateRenewals(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return dateStr;
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}

function showRenewalsNotification(message, type = 'info') {
    if (typeof showToast === 'function') { showToast(message, type); return; }
    const notification = document.createElement('div');
    notification.style.cssText = `position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem;
        background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#F44336' : '#2196F3'};
        color: white; border-radius: 8px; z-index: 99999; box-shadow: 0 4px 15px rgba(0,0,0,0.3);`;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

// ═══════════════════════════════════════════════════════════════════════════
// COMPREHENSIVE PRELOAD SYSTEM - All data loads on page start
// ═══════════════════════════════════════════════════════════════════════════

// Global cache flags
window.dataCache = {
    offers: false,
    programs: false,
    clients: false,
    documentLinks: false,
    emailTemplates: false,
    emailHistory: false,
    contracts: false,
    renewals: false
};

// Cache storage
window.cachedDocumentLinks = {};
window.cachedEmailHistory = [];

// Preload document links for offers
async function preloadDocumentLinks() {
    if (window.dataCache.documentLinks) return;
    
    try {
        console.log('🔄 Preloading document links...');
        const response = await fetch(API_URL + '?action=getAllOffersDocuments');
        const result = await response.json();
        
        if (result.success && result.data) {
            // Store the entire docsMap
            window.cachedDocumentLinks = result.data;
            window.dataCache.documentLinks = true;
            console.log('✅ Document links preloaded:', Object.keys(result.data).length, 'offers');
            
            // Update any visible offers table
            if (typeof offersData !== 'undefined' && offersData && offersData.length > 0) {
                applyDocumentLinksToTable();
            }
        }
    } catch (e) {
        console.log('⚠️ Could not preload document links:', e.message);
    }
}

// Apply cached document links to offers table
function applyDocumentLinksToTable() {
    if (!window.cachedDocumentLinks) return;
    
    const docsMap = window.cachedDocumentLinks;
    
    // Helper to extract URL from string or object
    const getUrl = (doc) => {
        if (!doc) return null;
        if (typeof doc === 'string') return doc;
        return doc.url || doc.drive_url || doc.fileUrl || null;
    };
    
    Object.keys(docsMap).forEach(offerId => {
        const docs = docsMap[offerId];
        
        const ndaUrl = getUrl(docs.nda);
        const ndaLink = document.getElementById('ndaLink-' + offerId);
        if (ndaLink && ndaUrl) {
            ndaLink.innerHTML = `<a href="${ndaUrl}" target="_blank" style="color:#e67e22;">📜 Open</a>`;
        }
        
        const dpaUrl = getUrl(docs.dpa);
        const dpaLink = document.getElementById('dpaLink-' + offerId);
        if (dpaLink && dpaUrl) {
            dpaLink.innerHTML = `<a href="${dpaUrl}" target="_blank" style="color:#9b59b6;">🔒 Open</a>`;
        }
        
        const asaUrl = getUrl(docs.asa);
        const asaLink = document.getElementById('asaLink-' + offerId);
        if (asaLink && asaUrl) {
            asaLink.innerHTML = `<a href="${asaUrl}" target="_blank" style="color:#27ae60;">📋 Open</a>`;
        }
        
        const proposalUrl = getUrl(docs.proposal);
        const proposalLink = document.getElementById('proposalLink-' + offerId);
        if (proposalLink && proposalUrl) {
            proposalLink.innerHTML = `<a href="${proposalUrl}" target="_blank" style="color:#1e3a5f;">📄 Open</a>`;
        }
    });
    
    console.log('✅ Document links applied to table');
}

// Preload email history
async function preloadEmailHistory() {
    if (window.dataCache.emailHistory) return;
    
    try {
        console.log('🔄 Preloading email history...');
        const response = await fetch(API_URL + '?action=getEmailHistory');
        const result = await response.json();
        
        if (result.success && result.data) {
            window.cachedEmailHistory = result.data;
            window.dataCache.emailHistory = true;
            console.log('✅ Email history preloaded:', result.data.length, 'emails');
        }
    } catch (e) {
        console.log('⚠️ Could not preload email history:', e.message);
    }
}

// Preload email templates
async function preloadEmailTemplates() {
    if (window.dataCache.emailTemplates) return;
    
    try {
        console.log('🔄 Preloading email templates...');
        const response = await fetch(API_URL + '?action=getEmailTemplates');
        const result = await response.json();
        
        if (result.success && result.data) {
            emailTemplates = result.data;
            window.dataCache.emailTemplates = true;
            console.log('✅ Email templates preloaded:', result.data.length, 'templates');
        }
    } catch (e) {
        console.log('⚠️ Could not preload email templates');
    }
}

// Preload contracts
async function preloadContracts() {
    if (window.dataCache.contracts) return;
    
    try {
        console.log('🔄 Preloading contracts...');
        const response = await fetch(API_URL + '?action=getContracts');
        const result = await response.json();
        
        if (result.success && result.data) {
            window.cachedContracts = result.data;
            window.dataCache.contracts = true;
            console.log('✅ Contracts preloaded:', result.data.length, 'contracts');
        }
    } catch (e) {
        console.log('⚠️ Could not preload contracts');
    }
}

// Master preload function
async function preloadAllData() {
    console.log('🚀 Starting comprehensive data preload...');
    
    const startTime = Date.now();
    
    try {
        // Phase 1: Critical data (parallel)
        await Promise.all([
            preloadOffersData(),
            loadProgramsFromDB().catch(() => {}),
            loadOfferClients().catch(() => {}),
            preloadClientsForAll() // NEW: Ensure clients are available everywhere
        ]);
        console.log('✅ Phase 1 complete: Offers, Programs, Clients');
        
        // Phase 2: Document links and email data (parallel)
        await Promise.all([
            preloadDocumentLinks(),
            preloadEmailTemplates(),
            preloadEmailHistory()
        ]);
        console.log('✅ Phase 2 complete: Documents, Email Templates, History');
        
        // Phase 3: Additional data
        await Promise.all([
            preloadContracts()
        ]);
        console.log('✅ Phase 3 complete: Contracts');
        
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        console.log(`🎉 All data preloaded in ${elapsed}s - Modals will open instantly!`);
        
    } catch (e) {
        console.log('⚠️ Some preload errors (non-critical):', e.message);
    }
}

// Preload clients for all modules
async function preloadClientsForAll() {
    if (window.cachedClientsData && window.cachedClientsData.length > 0) {
        console.log('📦 Clients already cached:', window.cachedClientsData.length);
        return;
    }
    
    try {
        console.log('🔄 Preloading clients for all modules...');
        const response = await fetch(API_URL + '?action=getClients');
        const result = await response.json();
        console.log('📦 Raw API result:', result);
        
        const clientList = result.data || result;
        console.log('📦 Parsed clientList:', clientList);
        
        if (Array.isArray(clientList) && clientList.length > 0) {
            // Log first item structure
            console.log('📋 First client object:', JSON.stringify(clientList[0], null, 2));
            console.log('📋 Fields available:', Object.keys(clientList[0]));
            
            window.cachedClientsData = clientList;
            console.log('✅ Clients preloaded for all modules:', clientList.length, 'clients');
        } else {
            console.warn('⚠️ No clients in response');
        }
    } catch (e) {
        console.error('❌ Could not preload clients:', e.message);
    }
}

// Update loading progress UI
function updateLoadingProgress(percent, details) {
    const bar = document.getElementById('loadingBar');
    const detailsEl = document.getElementById('loadingDetails');
    if (bar) bar.style.width = percent + '%';
    if (detailsEl) detailsEl.textContent = details;
}

// Master preload function WITH PROGRESS
async function preloadAllDataWithProgress() {
    console.log('🚀 Starting comprehensive data preload with progress...');
    
    const startTime = Date.now();
    
    try {
        // Phase 1: Critical data (25%)
        updateLoadingProgress(5, 'Loading offers...');
        await preloadOffersData().catch(() => {});
        
        updateLoadingProgress(15, 'Loading programs...');
        await loadProgramsFromDB().catch(() => {});
        
        updateLoadingProgress(25, 'Loading clients...');
        await Promise.all([
            loadOfferClients().catch(() => {}),
            preloadClientsForAll().catch(() => {})
        ]);
        console.log('✅ Phase 1 complete: Offers, Programs, Clients');
        
        // Phase 2: Document links and email data (50%)
        updateLoadingProgress(35, 'Loading document links...');
        await preloadDocumentLinks().catch(() => {});
        
        updateLoadingProgress(45, 'Loading email templates...');
        await preloadEmailTemplates().catch(() => {});
        
        updateLoadingProgress(55, 'Loading email history...');
        await preloadEmailHistory().catch(() => {});
        console.log('✅ Phase 2 complete: Documents, Email Templates, History');
        
        // Phase 3: Contracts (75%)
        updateLoadingProgress(70, 'Loading contracts...');
        await preloadContracts().catch(() => {});
        console.log('✅ Phase 3 complete: Contracts');
        
        // Phase 4: Final setup (100%)
        updateLoadingProgress(90, 'Finalizing...');
        
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        updateLoadingProgress(100, `Ready! Loaded in ${elapsed}s`);
        console.log(`🎉 All data preloaded in ${elapsed}s - Modals will open instantly!`);
        
        // Auto-load CEO Dashboard
        loadCEODashboardFromAPI();
        
        // Small delay to show 100%
        await new Promise(resolve => setTimeout(resolve, 300));
        
    } catch (e) {
        console.log('⚠️ Some preload errors (non-critical):', e.message);
        updateLoadingProgress(100, 'Ready (some data may load on demand)');
    }
}

console.log('📋 POLARIS Portal v4 - Comprehensive preloading enabled');
console.log('🔥 VERSION: 2026-02-01-REAL-DATA-INTEGRATION');

// ═══════════════════════════════════════════════════════════════════════════════
// RESPONSIVE HELPERS
// ═══════════════════════════════════════════════════════════════════════════════

// Add scroll indicators to tables and charts
function initScrollIndicators() {
    const scrollContainers = document.querySelectorAll('.chart-container, .data-table-wrapper, .offers-table-wrapper, .contracts-table-wrapper');
    
    scrollContainers.forEach(container => {
        // Check if content overflows
        if (container.scrollWidth > container.clientWidth) {
            container.classList.add('has-scroll');
            
            // Add scroll hint
            if (!container.querySelector('.scroll-hint')) {
                const hint = document.createElement('div');
                hint.className = 'scroll-hint';
                hint.innerHTML = '<span>← Scroll →</span>';
                hint.style.cssText = 'text-align:center;font-size:0.7rem;color:var(--text-muted);padding:5px;opacity:0.7;';
                container.parentNode.insertBefore(hint, container.nextSibling);
            }
        }
    });
}

// Handle orientation change
function handleOrientationChange() {
    const isLandscape = window.innerWidth > window.innerHeight;
    document.body.classList.toggle('landscape', isLandscape);
    document.body.classList.toggle('portrait', !isLandscape);
    
    // Reinitialize scroll indicators
    setTimeout(initScrollIndicators, 100);
}

// Initialize on load
window.addEventListener('load', () => {
    handleOrientationChange();
    initScrollIndicators();
});

// Listen for orientation changes
window.addEventListener('orientationchange', () => {
    setTimeout(handleOrientationChange, 100);
});

// Listen for resize
let resizeTimeout;
window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
        handleOrientationChange();
        initScrollIndicators();
    }, 250);
});

// ═══════════════════════════════════════════════════════════════════════════════
// CEO DASHBOARD - API INTEGRATION (v1.0)
// ═══════════════════════════════════════════════════════════════════════════════

async function loadCEODashboardFromAPI() {
    console.log('🔄 Loading CEO Dashboard from API...');
    
    try {
        const response = await fetch(API_URL + '?action=getCEODashboard');
        const result = await response.json();
        
        if (!result.success) {
            console.error('❌ CEO Dashboard API error:', result.error);
            return;
        }
        
        console.log('✅ CEO Dashboard data loaded:', result);
        updateCEODashboardUI(result);
        
    } catch (error) {
        console.error('❌ Error loading CEO Dashboard:', error);
    }
}

async function loadCEOFinancialsForClient(clientId) {
    console.log('🔄 Loading CEO Financials for client:', clientId);
    
    try {
        const response = await fetch(API_URL + '?action=getCEOFinancials&clientId=' + clientId);
        const result = await response.json();
        
        if (!result.success) {
            console.error('❌ CEO Financials API error:', result.error);
            return null;
        }
        
        console.log('✅ CEO Financials loaded for', clientId);
        updateCEOFinancialsUI(result);
        return result;
        
    } catch (error) {
        console.error('❌ Error loading CEO Financials:', error);
        return null;
    }
}

function updateCEODashboardUI(data) {
    const fmt = n => Math.round(n || 0).toLocaleString();
    const fmtCurrency = n => '$' + fmt(n);
    
    const summary = data.summary || {};
    const tax = data.tax || {};
    const annualized = data.annualized || {};
    const movement = data.member_movement || {};
    const topClients = data.top_clients || [];
    
    // MAIN KPI CARDS
    safeSetText('ceoGrossRevenue', fmtCurrency(summary.gross_revenue));
    safeSetText('ceoTotalExpenses', fmtCurrency(summary.total_expenses));
    safeSetText('ceoNetProfit', fmtCurrency(summary.net_profit));
    safeSetText('ceoTaxLiability', fmtCurrency(tax.total));
    
    // REVENUE BREAKDOWN
    const grossRevenue = summary.gross_revenue || 0;
    safeSetText('ceoPremiumRevenue', fmtCurrency(grossRevenue * 0.65));
    safeSetText('ceoAdminFeeRevenue', fmtCurrency(grossRevenue * 0.20));
    safeSetText('ceoStopLossRevenue', fmtCurrency(grossRevenue * 0.08));
    safeSetText('ceoNetworkRevenue', fmtCurrency(grossRevenue * 0.05));
    safeSetText('ceoProcessingRevenue', fmtCurrency(grossRevenue * 0.02));
    safeSetText('ceoTotalRevenue', fmtCurrency(grossRevenue));
    
    // EXPENSE BREAKDOWN
    const totalExpenses = summary.total_expenses || 0;
    safeSetText('ceoClaimsPaid', '-' + fmtCurrency(totalExpenses * 0.70));
    safeSetText('ceoExGratia', '-' + fmtCurrency(totalExpenses * 0.08));
    safeSetText('ceoProviderCosts', '-' + fmtCurrency(totalExpenses * 0.07));
    safeSetText('ceoOperatingExp', '-' + fmtCurrency(totalExpenses * 0.12));
    safeSetText('ceoBankFees', '-' + fmtCurrency(totalExpenses * 0.03));
    safeSetText('ceoTotalExpensesSum', '-' + fmtCurrency(totalExpenses));
    
    // CYPRUS TAX BREAKDOWN
    safeSetText('ceoTaxableIncome', fmtCurrency(summary.ebit));
    safeSetText('ceoCorporateTax', '-' + fmtCurrency(tax.cit));
    safeSetText('ceoSDC', '-' + fmtCurrency(tax.sdc));
    safeSetText('ceoGHS', '-' + fmtCurrency(tax.ghs));
    safeSetText('ceoTotalTax', '-' + fmtCurrency(tax.total));
    
    // CASH FLOW
    const netCash = grossRevenue - totalExpenses;
    safeSetText('ceoCashInflow', fmtCurrency(grossRevenue));
    safeSetText('ceoCashOutflow', '-' + fmtCurrency(totalExpenses));
    safeSetText('ceoNetCash', (netCash >= 0 ? '+' : '') + fmtCurrency(netCash));
    
    // KEY RATIOS
    const grossMargin = summary.gross_margin || 0;
    const lossRatio = summary.loss_ratio || 0;
    safeSetText('ceoGrossMargin', grossMargin.toFixed(0) + '%');
    safeSetText('ceoLossRatio', lossRatio.toFixed(0) + '%');
    safeSetText('ceoCombinedRatio', (lossRatio + 20).toFixed(0) + '%');
    safeSetText('ceoARPM', '$' + (summary.total_members > 0 ? (grossRevenue / summary.total_members / 3).toFixed(0) : 0));
    
    // MEMBER MOVEMENT
    safeSetText('newEnrollments', '+' + (movement.new_enrollments || 0));
    safeSetText('cancellations', '-' + (movement.cancellations || 0));
    const netChange = movement.net_change || 0;
    safeSetText('netChange', (netChange >= 0 ? '+' : '') + netChange);
    
    // PERIOD
    const now = new Date();
    safeSetText('ceoFinancePeriod', 'Q' + Math.ceil((now.getMonth() + 1) / 3) + ' ' + now.getFullYear());
    
    // TOP CLIENTS TABLE
    if (topClients.length > 0) {
        updateTopClientsTable(topClients);
    }
    
    console.log('✅ CEO Dashboard UI updated successfully!');
}

function updateCEOFinancialsUI(data) {
    const fmtCurrency = n => '$' + Math.round(n || 0).toLocaleString();
    
    const revenue = data.revenue || {};
    const expenses = data.expenses || {};
    const profit = data.profit || {};
    const ratios = data.ratios || {};
    const cyprusTax = profit.cyprus_tax || {};
    
    // MAIN KPIs
    safeSetText('ceoGrossRevenue', fmtCurrency(revenue.gross_revenue));
    safeSetText('ceoTotalExpenses', fmtCurrency(expenses.total_expenses));
    safeSetText('ceoNetProfit', fmtCurrency(profit.net_profit));
    safeSetText('ceoTaxLiability', fmtCurrency(cyprusTax.total));
    
    // REVENUE BREAKDOWN
    safeSetText('ceoPremiumRevenue', fmtCurrency(revenue.premium_revenue));
    safeSetText('ceoAdminFeeRevenue', fmtCurrency(revenue.fee_revenue));
    safeSetText('ceoStopLossRevenue', fmtCurrency(revenue.stop_loss_premium));
    safeSetText('ceoNetworkRevenue', fmtCurrency(revenue.network_access_fees));
    safeSetText('ceoProcessingRevenue', fmtCurrency(revenue.claim_processing_fees));
    safeSetText('ceoTotalRevenue', fmtCurrency(revenue.gross_revenue));
    
    // EXPENSE BREAKDOWN
    safeSetText('ceoClaimsPaid', '-' + fmtCurrency(expenses.claims_paid));
    safeSetText('ceoOperatingExp', '-' + fmtCurrency(expenses.operating_expenses));
    safeSetText('ceoBankFees', '-' + fmtCurrency(expenses.bank_fees));
    safeSetText('ceoTotalExpensesSum', '-' + fmtCurrency(expenses.total_expenses));
    
    // CYPRUS TAX
    safeSetText('ceoTaxableIncome', fmtCurrency(profit.ebit));
    safeSetText('ceoCorporateTax', '-' + fmtCurrency(cyprusTax.cit));
    safeSetText('ceoSDC', '-' + fmtCurrency(cyprusTax.sdc));
    safeSetText('ceoGHS', '-' + fmtCurrency(cyprusTax.ghs));
    safeSetText('ceoTotalTax', '-' + fmtCurrency(cyprusTax.total));
    
    // RATIOS
    safeSetText('ceoGrossMargin', ratios.gross_margin.toFixed(0) + '%');
    safeSetText('ceoLossRatio', ratios.loss_ratio.toFixed(0) + '%');
    safeSetText('ceoCombinedRatio', ratios.combined_ratio.toFixed(0) + '%');
    safeSetText('ceoARPM', '$' + ratios.arpm_monthly.toFixed(0));
    
    safeSetText('ceoFinancePeriod', data.period || 'Current Quarter');
    console.log('✅ CEO Financials UI updated for client:', data.client_id);
}

function safeSetText(elementId, value) {
    const el = document.getElementById(elementId);
    if (el) el.textContent = value;
}

function updateTopClientsTable(clients) {
    const tbody = document.getElementById('ceoTopClientsBody');
    if (!tbody || !clients || clients.length === 0) {
        console.log('ℹ️ No top clients table or data to display');
        return;
    }
    
    tbody.innerHTML = '';
    clients.forEach((client, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${client.client_id || 'Unknown'}</td>
            <td>${(client.members || 0).toLocaleString()}</td>
            <td>$${Math.round(client.claims_cost || 0).toLocaleString()}</td>
            <td>${client.contribution_pct || 0}%</td>
            <td style="color: ${parseFloat(client.loss_ratio) <= 70 ? '#4CAF50' : '#f39c12'}">${client.loss_ratio || 0}%</td>
        `;
        tbody.appendChild(row);
    });
    console.log('✅ Top clients table updated with', clients.length, 'clients');
}

function refreshCEODashboard(clientId) {
    if (clientId) {
        loadCEOFinancialsForClient(clientId);
    } else {
        loadCEODashboardFromAPI();
    }
}

console.log('✅ CEO Dashboard API Integration loaded!');
</script>

</body>
</html>

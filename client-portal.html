<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polaris Financial Services - Client Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --polaris-green: #1B5E20;
            --polaris-green-light: #2E7D32;
            --polaris-gold: #D4AF37;
            --gold-plan: #FFD700;
            --platinum-plan: #E5E4E2;
            --silver-plan: #C0C0C0;
            --bg-dark: #0a1a0a;
            --bg-card: #0d1f0d;
            --text-primary: #ffffff;
            --text-secondary: #b8c9b8;
            --text-muted: #7a8f7a;
            --border-color: #1e3a1e;
            --success: #4CAF50;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Open Sans', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }
        h1, h2, h3 { font-family: 'Montserrat', sans-serif; }
        
        .bg-pattern {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(ellipse at 20% 20%, rgba(27, 94, 32, 0.15) 0%, transparent 50%),
                        radial-gradient(ellipse at 80% 80%, rgba(212, 175, 55, 0.08) 0%, transparent 50%);
        }
        
        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 10000;
            transition: opacity 0.5s;
        }
        .loading-screen.hidden { opacity: 0; visibility: hidden; }
        .loader-ring {
            width: 80px; height: 80px; border: 3px solid var(--border-color);
            border-top-color: var(--polaris-gold); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 1.5rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .login-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: flex;
            align-items: center; justify-content: center; z-index: 9999;
        }
        .login-modal.hidden { display: none; }
        .login-box {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 20px; padding: 3rem; width: 100%; max-width: 420px;
        }
        .login-box::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--polaris-green), var(--polaris-gold));
        }
        .login-title {
            font-size: 1.75rem; font-weight: 700; text-align: center;
            margin-bottom: 0.5rem;
        }
        .login-subtitle {
            text-align: center; color: var(--text-secondary);
            margin-bottom: 2rem;
        }
        .login-input {
            width: 100%; background: var(--bg-dark);
            border: 1px solid var(--border-color); border-radius: 10px;
            padding: 1rem; color: var(--text-primary);
            font-family: inherit; margin-bottom: 1rem;
        }
        .login-input:focus { outline: none; border-color: var(--polaris-green); }
        .login-btn {
            width: 100%; background: linear-gradient(135deg, var(--polaris-green), var(--polaris-green-light));
            border: none; border-radius: 10px; padding: 1rem;
            color: white; font-family: 'Montserrat', sans-serif;
            font-weight: 700; cursor: pointer; transition: transform 0.3s;
        }
        .login-btn:hover { transform: translateY(-2px); }
        .login-error { color: var(--danger); text-align: center; margin-top: 1rem; }
        
        .header {
            background: rgba(10, 26, 10, 0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem; position: sticky; top: 0; z-index: 100;
        }
        .header-content {
            max-width: 1600px; margin: 0 auto;
            display: flex; align-items: center; justify-content: space-between;
        }
        .logo-section { display: flex; align-items: center; gap: 1rem; }
        .logo-section img { height: 40px; }
        .portal-badge {
            background: var(--polaris-gold); color: var(--bg-dark);
            padding: 0.3rem 0.8rem; border-radius: 15px;
            font-size: 0.7rem; font-weight: 700;
        }
        .user-section { display: flex; align-items: center; gap: 1rem; }
        .client-badge {
            display: flex; align-items: center; gap: 0.5rem;
            background: var(--bg-card); border: 1px solid var(--border-color);
            padding: 0.4rem 1rem 0.4rem 0.4rem; border-radius: 25px;
        }
        .client-avatar {
            width: 32px; height: 32px; border-radius: 50%;
            background: var(--polaris-green); display: flex;
            align-items: center; justify-content: center; font-weight: 700;
        }
        .logout-btn {
            background: transparent; border: 1px solid var(--border-color);
            color: var(--text-secondary); padding: 0.5rem 1rem;
            border-radius: 8px; cursor: pointer;
        }
        .logout-btn:hover { background: var(--danger); border-color: var(--danger); color: white; }
        .active-members-btn {
            display: flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, var(--polaris-gold), #FFA000);
            color: var(--bg-dark); padding: 0.6rem 1.25rem;
            border-radius: 25px; text-decoration: none;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem; font-weight: 700;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(212,175,55,0.3);
        }
        .active-members-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212,175,55,0.5);
        }
        .report-btn {
            display: flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, #2E7D32, #4CAF50);
            color: white; padding: 0.6rem 1.25rem;
            border: none; border-radius: 25px; cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem; font-weight: 700;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(46,125,50,0.3);
        }
        .report-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(46,125,50,0.5);
        }
        
        /* Report Modal */
        .report-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex;
            align-items: center; justify-content: center; z-index: 9999;
        }
        .report-modal.hidden { display: none; }
        .report-box {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 20px; padding: 2rem; width: 100%; max-width: 500px;
            text-align: center;
        }
        .report-progress {
            width: 100%; height: 8px; background: var(--bg-dark);
            border-radius: 4px; margin: 1.5rem 0; overflow: hidden;
        }
        .report-progress-bar {
            height: 100%; background: linear-gradient(90deg, var(--polaris-green), var(--polaris-gold));
            border-radius: 4px; transition: width 0.3s;
        }
        
        .main-content { max-width: 1600px; margin: 0 auto; padding: 2rem; }
        
        .page-header { margin-bottom: 2rem; }
        .page-title {
            font-size: 1.75rem; font-weight: 700;
            display: flex; align-items: center; gap: 0.75rem;
        }
        .page-subtitle { color: var(--text-secondary); margin-top: 0.5rem; }
        .period-badge {
            display: inline-block; background: var(--bg-card);
            border: 1px solid var(--polaris-gold); color: var(--polaris-gold);
            padding: 0.4rem 1rem; border-radius: 20px;
            font-family: 'Montserrat', sans-serif; font-weight: 600;
        }
        
        .section { margin-bottom: 2.5rem; }
        .section-title {
            font-size: 1.2rem; font-weight: 700;
            margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.5rem;
        }
        
        .kpi-grid {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 1.25rem; margin-bottom: 2rem;
        }
        .kpi-card {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 16px; padding: 1.5rem;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        .kpi-card::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 100%; height: 4px; border-radius: 16px 16px 0 0;
            background: linear-gradient(90deg, var(--polaris-green), var(--polaris-gold));
        }
        .kpi-icon { font-size: 2rem; margin-bottom: 0.75rem; }
        .kpi-label {
            font-size: 0.75rem; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem;
        }
        .kpi-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.75rem; font-weight: 800;
            color: var(--polaris-gold);
        }
        .kpi-trend {
            display: inline-flex; align-items: center; gap: 0.3rem;
            margin-top: 0.5rem; padding: 0.25rem 0.6rem;
            border-radius: 15px; font-size: 0.8rem; font-weight: 600;
        }
        .kpi-trend.up { background: rgba(231, 76, 60, 0.15); color: var(--danger); }
        .kpi-trend.down { background: rgba(76, 175, 80, 0.15); color: var(--success); }
        
        .comparison-banner {
            background: linear-gradient(135deg, var(--bg-card), rgba(27, 94, 32, 0.2));
            border: 1px solid var(--border-color); border-radius: 20px;
            padding: 2rem; margin-bottom: 2rem;
        }
        .comparison-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 1.5rem;
        }
        .comparison-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.25rem;
        }
        .cmp-card {
            background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.25rem;
        }
        .cmp-label {
            font-size: 0.7rem; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.75rem;
        }
        .cmp-values { display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.5rem; }
        .cmp-current { font-family: 'Montserrat', sans-serif; font-size: 1.5rem; font-weight: 700; }
        .cmp-previous { font-size: 0.85rem; color: var(--text-muted); text-decoration: line-through; }
        .cmp-change {
            display: inline-flex; align-items: center; gap: 0.25rem;
            padding: 0.25rem 0.6rem; border-radius: 15px;
            font-size: 0.8rem; font-weight: 600;
        }
        .cmp-change.positive { background: rgba(76, 175, 80, 0.2); color: var(--success); }
        .cmp-change.negative { background: rgba(231, 76, 60, 0.2); color: var(--danger); }
        
        .chart-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.25rem;
        }
        .chart-grid.three { grid-template-columns: repeat(3, 1fr); }
        .chart-card {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 16px; padding: 1.5rem;
        }
        .chart-card.wide { grid-column: span 2; }
        .chart-card.full { grid-column: span 3; }
        .chart-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 1.25rem;
        }
        .chart-title { font-size: 1rem; font-weight: 600; }
        .chart-badge {
            background: rgba(212, 175, 55, 0.2); color: var(--polaris-gold);
            padding: 0.25rem 0.6rem; border-radius: 12px;
            font-size: 0.7rem; font-weight: 600;
        }
        .chart-container { height: 280px; position: relative; }
        .chart-container.tall { height: 350px; }
        
        .gauge-container {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; height: 260px;
        }
        .gauge-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem; font-weight: 800;
            color: var(--polaris-gold); margin-top: 1rem;
        }
        .gauge-label { color: var(--text-muted); margin-top: 0.25rem; }
        .gauge-target { color: var(--text-secondary); margin-top: 0.5rem; }
        .gauge-target span { color: var(--polaris-gold); font-weight: 600; }
        
        .stats-mini-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;
        }
        .stat-mini {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 1.25rem; text-align: center;
        }
        .stat-mini-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .stat-mini-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4rem; font-weight: 700; color: var(--polaris-gold);
        }
        .stat-mini-label { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; }
        
        .progress-item { margin-bottom: 1.25rem; }
        .progress-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .progress-label { font-size: 0.9rem; }
        .progress-value { font-family: 'Montserrat', sans-serif; color: var(--polaris-gold); font-weight: 600; }
        .progress-bar {
            height: 8px; background: var(--bg-dark);
            border-radius: 4px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; border-radius: 4px;
            background: linear-gradient(90deg, var(--polaris-green), var(--polaris-gold));
            transition: width 1s ease-out;
        }
        
        .insights-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .insight-item {
            display: flex; align-items: flex-start; gap: 0.75rem;
            padding: 0.75rem; background: rgba(0,0,0,0.2);
            border-radius: 10px; border-left: 3px solid var(--polaris-green);
        }
        .insight-item.success { border-left-color: var(--success); }
        .insight-item.warning { border-left-color: var(--warning); }
        .insight-item.danger { border-left-color: var(--danger); }
        .insight-icon { font-size: 1.2rem; }
        .insight-title { font-weight: 600; font-size: 0.9rem; }
        .insight-desc { font-size: 0.8rem; color: var(--text-secondary); }
        
        .data-table-container {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 16px; overflow: hidden;
        }
        .table-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 1.25rem; border-bottom: 1px solid var(--border-color);
        }
        .table-search {
            background: var(--bg-dark); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 0.5rem 1rem;
            color: var(--text-primary); width: 220px;
        }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th {
            text-align: left; padding: 1rem;
            font-size: 0.75rem; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px;
            background: var(--bg-dark); border-bottom: 1px solid var(--border-color);
        }
        .data-table td { padding: 1rem; border-bottom: 1px solid var(--border-color); }
        .data-table tr:hover td { background: rgba(46, 125, 50, 0.1); }
        .rank-badge {
            width: 32px; height: 32px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 0.8rem;
        }
        .rank-badge.gold { background: var(--gold-plan); color: var(--bg-dark); }
        .rank-badge.silver { background: var(--silver-plan); color: var(--bg-dark); }
        .rank-badge.bronze { background: #CD7F32; color: white; }
        .currency { font-family: 'Montserrat', sans-serif; color: var(--polaris-gold); font-weight: 600; }
        
        .footer {
            text-align: center; padding: 2rem;
            border-top: 1px solid var(--border-color); margin-top: 2rem;
            color: var(--text-muted); font-size: 0.85rem;
        }
        
        @media (max-width: 1200px) {
            .kpi-grid { grid-template-columns: repeat(3, 1fr); }
            .chart-grid, .chart-grid.three { grid-template-columns: 1fr; }
            .chart-card.wide, .chart-card.full { grid-column: span 1; }
        }
        @media (max-width: 768px) {
            .kpi-grid, .comparison-grid, .stats-mini-grid { grid-template-columns: 1fr; }
            .header-content { flex-direction: column; gap: 1rem; }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <div class="loading-screen" id="loadingScreen">
        <div class="loader-ring"></div>
        <div style="color: var(--text-secondary); letter-spacing: 2px;">LOADING DASHBOARD</div>
    </div>
    
    <div class="login-modal" id="loginModal">
        <div class="login-box">
            <h2 class="login-title">Client Portal</h2>
            <p class="login-subtitle">Sign in to access your analytics</p>
            <input type="text" class="login-input" id="loginUsername" placeholder="Username">
            <input type="password" class="login-input" id="loginPassword" placeholder="Password">
            <button class="login-btn" onclick="handleLogin()">Sign In</button>
            <p class="login-error" id="loginError"></p>
        </div>
    </div>
    
    <header class="header" id="mainHeader" style="display:none">
        <div class="header-content">
            <div class="logo-section">
                <img src="https://www.polaris-finance.com/sites/default/files/logo.png" alt="Polaris" onerror="this.outerHTML='<span style=font-family:Montserrat;font-weight:800;color:var(--polaris-gold)>POLARIS</span>'">
                <span class="portal-badge">CLIENT PORTAL</span>
            </div>
            <div class="user-section">
                <button onclick="generateClientReport()" class="report-btn">
                    <span>üìÑ</span> Download Report
                </button>
                <a href="#" id="activeMembersBtn" class="active-members-btn" onclick="openActiveMembers()">
                    <span>üë•</span> Active Members
                </a>
                <div class="client-badge">
                    <div class="client-avatar" id="clientAvatar">U</div>
                    <span id="clientName">User</span>
                </div>
                <button class="logout-btn" onclick="handleLogout()">Sign Out</button>
            </div>
        </div>
    </header>
    
    <main class="main-content" id="mainContent" style="display:none">
        <div class="page-header">
            <h1 class="page-title">üìä Financial Analytics Dashboard</h1>
            <p class="page-subtitle">
                Real-time insights into your health plan performance
                <span class="period-badge" id="periodBadge">Q3 2025</span>
            </p>
        </div>
        
        <section class="section">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon">üë•</div>
                    <div class="kpi-label">Total Members</div>
                    <div class="kpi-value" id="kpiMembers">-</div>
                    <div class="kpi-trend" id="kpiMembersTrend">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üìã</div>
                    <div class="kpi-label">Total Claims</div>
                    <div class="kpi-value" id="kpiClaims">-</div>
                    <div class="kpi-trend" id="kpiClaimsTrend">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üíµ</div>
                    <div class="kpi-label">Approved Amount</div>
                    <div class="kpi-value" id="kpiApproved">-</div>
                    <div class="kpi-trend" id="kpiApprovedTrend">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üìà</div>
                    <div class="kpi-label">Cost per Member</div>
                    <div class="kpi-value" id="kpiCost">-</div>
                    <div class="kpi-trend" id="kpiCostTrend">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üéØ</div>
                    <div class="kpi-label">Utilization Rate</div>
                    <div class="kpi-value" id="kpiUtilization">-</div>
                    <div class="kpi-trend" style="background:rgba(255,255,255,0.1);color:var(--text-secondary)">Target: 15%</div>
                </div>
            </div>
        </section>
        
        <!-- INPATIENT vs OUTPATIENT Section - TOP PRIORITY -->
        <section class="section">
            <h2 class="section-title">üè• Inpatient vs Outpatient Analysis</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üìä Cases Distribution</h3>
                        <span class="chart-badge">Current Period</span>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem">
                        <div class="stat-mini" style="border-left:4px solid #e74c3c">
                            <div class="stat-mini-icon">üè®</div>
                            <div class="stat-mini-value" id="inpatientCases">-</div>
                            <div class="stat-mini-label">Inpatient Cases</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #3498db">
                            <div class="stat-mini-icon">üèÉ</div>
                            <div class="stat-mini-value" id="outpatientCases">-</div>
                            <div class="stat-mini-label">Outpatient Cases</div>
                        </div>
                    </div>
                    <div class="chart-container short"><canvas id="inOutPieChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üí∞ Cost Comparison</h3>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem">
                        <div class="stat-mini" style="border-left:4px solid #e74c3c">
                            <div class="stat-mini-icon">üíµ</div>
                            <div class="stat-mini-value" id="inpatientCost">-</div>
                            <div class="stat-mini-label">Inpatient Cost</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #3498db">
                            <div class="stat-mini-icon">üíµ</div>
                            <div class="stat-mini-value" id="outpatientCost">-</div>
                            <div class="stat-mini-label">Outpatient Cost</div>
                        </div>
                    </div>
                    <div class="chart-container short"><canvas id="inOutCostChart"></canvas></div>
                </div>
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title">üìà Inpatient vs Outpatient Trend</h3>
                    </div>
                    <div class="chart-container"><canvas id="inOutTrendChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- PRINCIPAL vs DEPENDENT Section -->
        <section class="section">
            <h2 class="section-title">üë• Principal vs Dependent Analysis</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üë§ Member Type Distribution</h3>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem">
                        <div class="stat-mini" style="border-left:4px solid #2E7D32">
                            <div class="stat-mini-icon">‚öì</div>
                            <div class="stat-mini-value" id="principalCount">-</div>
                            <div class="stat-mini-label">Seafarers (Principal)</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37">
                            <div class="stat-mini-icon">üë®‚Äçüë©‚Äçüëß</div>
                            <div class="stat-mini-value" id="dependentCount">-</div>
                            <div class="stat-mini-label">Dependents</div>
                        </div>
                    </div>
                    <div class="chart-container short"><canvas id="memberTypePieChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üí∞ Cost by Member Type</h3>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem">
                        <div class="stat-mini" style="border-left:4px solid #2E7D32">
                            <div class="stat-mini-icon">üíµ</div>
                            <div class="stat-mini-value" id="principalCost">-</div>
                            <div class="stat-mini-label">Principal Cost/Member</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37">
                            <div class="stat-mini-icon">üíµ</div>
                            <div class="stat-mini-value" id="dependentCost">-</div>
                            <div class="stat-mini-label">Dependent Cost/Member</div>
                        </div>
                    </div>
                    <div class="chart-container short"><canvas id="memberTypeCostChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- MEMBER MOVEMENT Section -->
        <section class="section">
            <h2 class="section-title">üìà Member Movement</h2>
            <div class="chart-grid three">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">‚ûï New Enrollments</h3>
                        <span class="chart-badge" style="background:rgba(76,175,80,0.2);color:#4CAF50">This Period</span>
                    </div>
                    <div style="text-align:center;padding:2rem 0">
                        <div style="font-size:3rem;color:#4CAF50;font-family:Montserrat;font-weight:800" id="newEnrollments">+0</div>
                        <div style="color:var(--text-muted);margin-top:0.5rem">New Members</div>
                    </div>
                    <div class="chart-container short"><canvas id="enrollmentChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">‚ûñ Cancellations</h3>
                        <span class="chart-badge" style="background:rgba(231,76,60,0.2);color:#e74c3c">This Period</span>
                    </div>
                    <div style="text-align:center;padding:2rem 0">
                        <div style="font-size:3rem;color:#e74c3c;font-family:Montserrat;font-weight:800" id="cancellations">-0</div>
                        <div style="color:var(--text-muted);margin-top:0.5rem">Cancelled</div>
                    </div>
                    <div class="chart-container short"><canvas id="cancellationChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üìä Net Change</h3>
                    </div>
                    <div style="text-align:center;padding:2rem 0">
                        <div style="font-size:3rem;color:#D4AF37;font-family:Montserrat;font-weight:800" id="netChange">0</div>
                        <div style="color:var(--text-muted);margin-top:0.5rem">Net Growth</div>
                    </div>
                    <div class="chart-container short"><canvas id="netChangeChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- FEES BREAKDOWN Section -->
        <section class="section">
            <h2 class="section-title">üí≥ Fees & Charges Breakdown</h2>
            <div class="stats-mini-grid">
                <div class="stat-mini">
                    <div class="stat-mini-icon">üìã</div>
                    <div class="stat-mini-value" id="auditFee">15%</div>
                    <div class="stat-mini-label">Audit Fee</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon">üìù</div>
                    <div class="stat-mini-value" id="registrationFee">$24</div>
                    <div class="stat-mini-label">Registration Fee (Annual)</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon">üìÖ</div>
                    <div class="stat-mini-value" id="monthlyFee">$9</div>
                    <div class="stat-mini-label">Monthly Fee (Annual)</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon">ü¶∑</div>
                    <div class="stat-mini-value" id="dentalFee">-</div>
                    <div class="stat-mini-label">Dental Fee</div>
                </div>
            </div>
            <div class="chart-grid" style="margin-top:1.5rem">
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title">üìä Annualized Cost Breakdown</h3>
                        <span class="chart-badge">Per Member</span>
                    </div>
                    <div class="chart-container"><canvas id="costBreakdownChart"></canvas></div>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="comparison-banner">
                <div class="comparison-header">
                    <h2 class="section-title" style="margin:0">üìä Period Comparison</h2>
                    <span class="period-badge" id="cmpPeriodLabel">Q3 vs Q2 2025</span>
                </div>
                <div class="comparison-grid">
                    <div class="cmp-card">
                        <div class="cmp-label">Total Claims</div>
                        <div class="cmp-values">
                            <span class="cmp-current" id="cmpClaims">-</span>
                            <span class="cmp-previous" id="cmpClaimsPrev">-</span>
                        </div>
                        <span class="cmp-change" id="cmpClaimsChange">-</span>
                    </div>
                    <div class="cmp-card">
                        <div class="cmp-label">Total Members</div>
                        <div class="cmp-values">
                            <span class="cmp-current" id="cmpMembers">-</span>
                            <span class="cmp-previous" id="cmpMembersPrev">-</span>
                        </div>
                        <span class="cmp-change" id="cmpMembersChange">-</span>
                    </div>
                    <div class="cmp-card">
                        <div class="cmp-label">Approved (USD)</div>
                        <div class="cmp-values">
                            <span class="cmp-current" id="cmpApproved">-</span>
                            <span class="cmp-previous" id="cmpApprovedPrev">-</span>
                        </div>
                        <span class="cmp-change" id="cmpApprovedChange">-</span>
                    </div>
                    <div class="cmp-card">
                        <div class="cmp-label">Cost per Member</div>
                        <div class="cmp-values">
                            <span class="cmp-current" id="cmpCost">-</span>
                            <span class="cmp-previous" id="cmpCostPrev">-</span>
                        </div>
                        <span class="cmp-change" id="cmpCostChange">-</span>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="section">
            <h2 class="section-title">üí∞ Financial Analytics</h2>
            <div class="chart-grid">
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title">üìà Cost per Member Trend</h3>
                        <span class="chart-badge">Historical</span>
                    </div>
                    <div class="chart-container tall"><canvas id="costTrendChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üíµ Approved Amounts</h3>
                    </div>
                    <div class="chart-container"><canvas id="approvedChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üéØ Cost vs Target</h3>
                        <span class="chart-badge">Gauge</span>
                    </div>
                    <div class="gauge-container">
                        <canvas id="gaugeChart" width="200" height="200"></canvas>
                        <div class="gauge-value" id="gaugeValue">$0</div>
                        <div class="gauge-label">Cost per Member</div>
                        <div class="gauge-target">Target: <span>$50.00</span></div>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="section">
            <h2 class="section-title">üìã Claims Analysis</h2>
            <div class="chart-grid three">
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">üìä Claims by Period</h3></div>
                    <div class="chart-container"><canvas id="claimsPeriodChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">üè• Claims per 1000</h3></div>
                    <div class="chart-container"><canvas id="claims1000Chart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">üíä Avg Claim Value</h3></div>
                    <div class="chart-container"><canvas id="avgClaimChart"></canvas></div>
                </div>
            </div>
        </section>
        
        <section class="section">
            <h2 class="section-title">üèÜ Plan Performance</h2>
            <div class="stats-mini-grid" style="margin-bottom:1.5rem">
                <div class="stat-mini">
                    <div class="stat-mini-icon">ü•á</div>
                    <div class="stat-mini-value" id="goldMembers">60%</div>
                    <div class="stat-mini-label">Gold Members</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon">üíé</div>
                    <div class="stat-mini-value" id="platMembers">25%</div>
                    <div class="stat-mini-label">Platinum</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon">ü•à</div>
                    <div class="stat-mini-value" id="silverMembers">15%</div>
                    <div class="stat-mini-label">Silver</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon">üìä</div>
                    <div class="stat-mini-value" id="totalActive">-</div>
                    <div class="stat-mini-label">Total Active</div>
                </div>
            </div>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üìä Member Distribution</h3>
                        <span class="chart-badge">3D Pie</span>
                    </div>
                    <div class="chart-container"><canvas id="planPieChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">üí∞ Cost by Plan</h3></div>
                    <div class="chart-container"><canvas id="planCostChart"></canvas></div>
                </div>
            </div>
        </section>
        
        <section class="section">
            <h2 class="section-title">üìà Utilization Metrics</h2>
            <div class="chart-grid three">
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">üìä Utilization Trend</h3></div>
                    <div class="chart-container"><canvas id="utilizationChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">üè• Key Metrics</h3></div>
                    <div style="padding:1rem 0">
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-label">Utilization Rate</span>
                                <span class="progress-value" id="utilValue">0%</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" id="utilBar" style="width:0%"></div></div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-label">Claims Ratio</span>
                                <span class="progress-value" id="claimsRatioValue">30%</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" id="claimsRatioBar" style="width:30%"></div></div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-label">Cost Efficiency</span>
                                <span class="progress-value" id="effValue">75%</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" id="effBar" style="width:75%"></div></div>
                        </div>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">üí° AI Insights</h3></div>
                    <div class="insights-list" id="insightsList"></div>
                </div>
            </div>
        </section>
        
        <section class="section">
            <div class="data-table-container">
                <div class="table-header">
                    <h3 class="section-title" style="margin:0">üìÖ Historical Data</h3>
                    <input type="text" class="table-search" placeholder="Search..." id="tableSearch">
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th><th>Period</th><th>Members</th><th>Claims</th>
                            <th>PHP</th><th>USD</th><th>Cost/Member</th><th>Util %</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable"></tbody>
                </table>
            </div>
        </section>
    </main>
    
    <!-- Report Generation Modal -->
    <div class="report-modal hidden" id="reportModal">
        <div class="report-box">
            <div style="font-size:3rem;margin-bottom:1rem">üìÑ</div>
            <h3 style="font-size:1.25rem;font-weight:700;margin-bottom:0.5rem" id="reportTitle">Generating Report...</h3>
            <p style="color:var(--text-secondary);margin-bottom:1rem" id="reportStatus">Preparing your personalized report</p>
            <div class="report-progress">
                <div class="report-progress-bar" id="reportProgressBar" style="width:0%"></div>
            </div>
            <p style="color:var(--text-muted);font-size:0.85rem" id="reportStep">Initializing...</p>
        </div>
    </div>
    
    <footer class="footer" id="mainFooter" style="display:none">
        <p>¬© 2025 Polaris Financial Services. All rights reserved.</p>
        <p style="margin-top:0.5rem">Last updated: <span id="lastUpdated">-</span></p>
    </footer>
    
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxg83W_1DARho7eqGOcLC1sbu1t1NPFW9StzTaQTEMjasi2_E7rVvGOUSEXBdIc_DYk/exec';
        let currentUser = null, charts = {};
        
        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('polaris_user');
            if (saved) { currentUser = JSON.parse(saved); showDashboard(); }
            else document.getElementById('loadingScreen').classList.add('hidden');
        });
        
        async function handleLogin() {
            const u = document.getElementById('loginUsername').value;
            if (!u) { document.getElementById('loginError').textContent = 'Enter username'; return; }
            currentUser = { username: u };
            localStorage.setItem('polaris_user', JSON.stringify(currentUser));
            showDashboard();
        }
        
        function handleLogout() { localStorage.removeItem('polaris_user'); location.reload(); }
        
        function openActiveMembers() {
            // Get client_id from logged in user
            const clientId = currentUser.client_id || currentUser.username || '';
            const url = 'https://apostolos-bizou.github.io/polaris-member-tracker/?client=' + encodeURIComponent(clientId);
            window.open(url, '_blank');
        }
        
        // Store dashboard data globally for report
        let dashboardData = null;
        
        async function generateClientReport() {
            const modal = document.getElementById('reportModal');
            const progressBar = document.getElementById('reportProgressBar');
            const stepText = document.getElementById('reportStep');
            const statusText = document.getElementById('reportStatus');
            const titleText = document.getElementById('reportTitle');
            
            modal.classList.remove('hidden');
            
            const updateProgress = (percent, step) => {
                progressBar.style.width = percent + '%';
                stepText.textContent = step;
            };
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);
                
                // Get current data
                const clientName = currentUser.username || currentUser.client_id || 'Client';
                const periodLabel = document.getElementById('periodBadge')?.textContent || 'Current Period';
                const reportDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                
                // Colors
                const greenDark = [27, 94, 32];
                const greenLight = [46, 125, 50];
                const gold = [212, 175, 55];
                const textDark = [30, 30, 30];
                const textMuted = [120, 120, 120];
                
                // ==================== PAGE 1: COVER ====================
                updateProgress(10, 'Creating cover page...');
                await new Promise(r => setTimeout(r, 200));
                
                // Green header bar
                doc.setFillColor(...greenDark);
                doc.rect(0, 0, pageWidth, 60, 'F');
                
                // Gold accent line
                doc.setFillColor(...gold);
                doc.rect(0, 58, pageWidth, 4, 'F');
                
                // Company name
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(28);
                doc.setFont('helvetica', 'bold');
                doc.text('POLARIS', margin, 30);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'normal');
                doc.text('FINANCIAL SERVICES', margin, 40);
                
                // Report title
                doc.setTextColor(...textDark);
                doc.setFontSize(32);
                doc.setFont('helvetica', 'bold');
                doc.text('Client Analytics Report', margin, 100);
                
                // Client name
                doc.setFontSize(20);
                doc.setTextColor(...greenDark);
                doc.text(clientName, margin, 120);
                
                // Period
                doc.setFontSize(14);
                doc.setTextColor(...textMuted);
                doc.text('Period: ' + periodLabel, margin, 135);
                doc.text('Generated: ' + reportDate, margin, 145);
                
                // Decorative box
                doc.setDrawColor(...greenDark);
                doc.setLineWidth(0.5);
                doc.rect(margin, 160, contentWidth, 80);
                
                doc.setFontSize(12);
                doc.setTextColor(...textDark);
                doc.text('This report contains:', margin + 5, 175);
                
                const contents = [
                    '‚Ä¢ Executive Summary & KPIs',
                    '‚Ä¢ Period Comparison Analysis',
                    '‚Ä¢ Inpatient vs Outpatient Breakdown',
                    '‚Ä¢ Principal vs Dependent Analysis',
                    '‚Ä¢ Cost Analysis & Trends',
                    '‚Ä¢ Member Movement Statistics',
                    '‚Ä¢ Historical Data'
                ];
                
                contents.forEach((item, i) => {
                    doc.text(item, margin + 5, 188 + (i * 7));
                });
                
                // Footer
                doc.setFontSize(10);
                doc.setTextColor(...textMuted);
                doc.text('Confidential - For authorized use only', pageWidth / 2, 280, { align: 'center' });
                doc.text('¬© 2025 Polaris Financial Services', pageWidth / 2, 287, { align: 'center' });
                
                // ==================== PAGE 2: EXECUTIVE SUMMARY ====================
                updateProgress(25, 'Building executive summary...');
                await new Promise(r => setTimeout(r, 200));
                doc.addPage();
                
                // Header
                doc.setFillColor(...greenDark);
                doc.rect(0, 0, pageWidth, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Executive Summary', margin, 17);
                
                // KPI boxes
                const kpis = [
                    { label: 'Total Members', value: document.getElementById('kpiMembers')?.textContent || '-', icon: 'üë•' },
                    { label: 'Total Claims', value: document.getElementById('kpiClaims')?.textContent || '-', icon: 'üìã' },
                    { label: 'Approved Amount', value: document.getElementById('kpiApproved')?.textContent || '-', icon: 'üíµ' },
                    { label: 'Cost per Member', value: document.getElementById('kpiCost')?.textContent || '-', icon: 'üìà' },
                    { label: 'Utilization Rate', value: document.getElementById('kpiUtilization')?.textContent || '-', icon: 'üéØ' }
                ];
                
                let yPos = 40;
                const boxWidth = (contentWidth - 10) / 2;
                const boxHeight = 30;
                
                kpis.forEach((kpi, i) => {
                    const col = i % 2;
                    const row = Math.floor(i / 2);
                    const x = margin + (col * (boxWidth + 10));
                    const y = yPos + (row * (boxHeight + 8));
                    
                    // Box
                    doc.setFillColor(245, 250, 245);
                    doc.setDrawColor(...greenLight);
                    doc.roundedRect(x, y, boxWidth, boxHeight, 3, 3, 'FD');
                    
                    // Label
                    doc.setFontSize(9);
                    doc.setTextColor(...textMuted);
                    doc.text(kpi.label, x + 5, y + 10);
                    
                    // Value
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...greenDark);
                    doc.text(kpi.value, x + 5, y + 23);
                });
                
                // Period Comparison Section
                yPos = 165;
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Period Comparison', margin, yPos);
                
                doc.setDrawColor(...gold);
                doc.setLineWidth(1);
                doc.line(margin, yPos + 3, margin + 50, yPos + 3);
                
                yPos += 15;
                
                const comparisons = [
                    { label: 'Claims', current: document.getElementById('cmpClaims')?.textContent, prev: document.getElementById('cmpClaimsPrev')?.textContent },
                    { label: 'Members', current: document.getElementById('cmpMembers')?.textContent, prev: document.getElementById('cmpMembersPrev')?.textContent },
                    { label: 'Approved (USD)', current: document.getElementById('cmpApproved')?.textContent, prev: document.getElementById('cmpApprovedPrev')?.textContent },
                    { label: 'Cost/Member', current: document.getElementById('cmpCost')?.textContent, prev: document.getElementById('cmpCostPrev')?.textContent }
                ];
                
                // Table header
                doc.setFillColor(...greenDark);
                doc.rect(margin, yPos, contentWidth, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Metric', margin + 5, yPos + 7);
                doc.text('Current', margin + 70, yPos + 7);
                doc.text('Previous', margin + 120, yPos + 7);
                
                yPos += 10;
                
                comparisons.forEach((cmp, i) => {
                    const rowY = yPos + (i * 12);
                    doc.setFillColor(i % 2 === 0 ? 250 : 245, i % 2 === 0 ? 250 : 248, i % 2 === 0 ? 250 : 245);
                    doc.rect(margin, rowY, contentWidth, 12, 'F');
                    
                    doc.setTextColor(...textDark);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.text(cmp.label, margin + 5, rowY + 8);
                    doc.setFont('helvetica', 'bold');
                    doc.text(cmp.current || '-', margin + 70, rowY + 8);
                    doc.setTextColor(...textMuted);
                    doc.text(cmp.prev || '-', margin + 120, rowY + 8);
                });
                
                // ==================== PAGE 3: INPATIENT/OUTPATIENT ====================
                updateProgress(45, 'Adding inpatient/outpatient analysis...');
                await new Promise(r => setTimeout(r, 200));
                doc.addPage();
                
                // Header
                doc.setFillColor(...greenDark);
                doc.rect(0, 0, pageWidth, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Inpatient vs Outpatient Analysis', margin, 17);
                
                yPos = 40;
                
                // Stats boxes
                const inpatientCases = document.getElementById('inpatientCases')?.textContent || '-';
                const outpatientCases = document.getElementById('outpatientCases')?.textContent || '-';
                const inpatientCost = document.getElementById('inpatientCost')?.textContent || '-';
                const outpatientCost = document.getElementById('outpatientCost')?.textContent || '-';
                
                // Inpatient Box
                doc.setFillColor(231, 76, 60);
                doc.roundedRect(margin, yPos, 85, 50, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.text('INPATIENT', margin + 10, yPos + 15);
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.text(inpatientCases, margin + 10, yPos + 32);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cases', margin + 10, yPos + 42);
                
                // Outpatient Box
                doc.setFillColor(52, 152, 219);
                doc.roundedRect(margin + 95, yPos, 85, 50, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.text('OUTPATIENT', margin + 105, yPos + 15);
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.text(outpatientCases, margin + 105, yPos + 32);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cases', margin + 105, yPos + 42);
                
                yPos += 65;
                
                // Cost comparison
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Cost Analysis', margin, yPos);
                
                yPos += 15;
                
                doc.setFillColor(250, 245, 245);
                doc.setDrawColor(231, 76, 60);
                doc.roundedRect(margin, yPos, 85, 35, 3, 3, 'FD');
                doc.setTextColor(231, 76, 60);
                doc.setFontSize(10);
                doc.text('Inpatient Cost', margin + 10, yPos + 12);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(inpatientCost, margin + 10, yPos + 27);
                
                doc.setFillColor(245, 250, 255);
                doc.setDrawColor(52, 152, 219);
                doc.roundedRect(margin + 95, yPos, 85, 35, 3, 3, 'FD');
                doc.setTextColor(52, 152, 219);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Outpatient Cost', margin + 105, yPos + 12);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(outpatientCost, margin + 105, yPos + 27);
                
                // ==================== PAGE 4: PRINCIPAL/DEPENDENT ====================
                updateProgress(60, 'Adding member type analysis...');
                await new Promise(r => setTimeout(r, 200));
                
                yPos += 55;
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Principal vs Dependent Analysis', margin, yPos);
                
                doc.setDrawColor(...gold);
                doc.setLineWidth(1);
                doc.line(margin, yPos + 3, margin + 70, yPos + 3);
                
                yPos += 20;
                
                const principalCount = document.getElementById('principalCount')?.textContent || '-';
                const dependentCount = document.getElementById('dependentCount')?.textContent || '-';
                const principalCost = document.getElementById('principalCost')?.textContent || '-';
                const dependentCost = document.getElementById('dependentCost')?.textContent || '-';
                
                // Principal Box
                doc.setFillColor(...greenDark);
                doc.roundedRect(margin, yPos, 85, 50, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.text('SEAFARERS (Principal)', margin + 8, yPos + 15);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(principalCount, margin + 10, yPos + 32);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cost: ' + principalCost, margin + 10, yPos + 44);
                
                // Dependent Box
                doc.setFillColor(...gold);
                doc.roundedRect(margin + 95, yPos, 85, 50, 3, 3, 'F');
                doc.setTextColor(30, 30, 30);
                doc.setFontSize(11);
                doc.text('DEPENDENTS', margin + 105, yPos + 15);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(dependentCount, margin + 105, yPos + 32);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cost: ' + dependentCost, margin + 105, yPos + 44);
                
                // ==================== PAGE 4: MEMBER MOVEMENT ====================
                updateProgress(75, 'Adding member movement...');
                await new Promise(r => setTimeout(r, 200));
                doc.addPage();
                
                // Header
                doc.setFillColor(...greenDark);
                doc.rect(0, 0, pageWidth, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Member Movement & Fees', margin, 17);
                
                yPos = 40;
                
                const newEnroll = document.getElementById('newEnrollments')?.textContent || '-';
                const cancelled = document.getElementById('cancellations')?.textContent || '-';
                const netChange = document.getElementById('netChange')?.textContent || '-';
                
                // Movement boxes
                doc.setFillColor(76, 175, 80);
                doc.roundedRect(margin, yPos, 55, 45, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.text('NEW ENROLLMENTS', margin + 5, yPos + 12);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(newEnroll, margin + 5, yPos + 32);
                
                doc.setFillColor(231, 76, 60);
                doc.roundedRect(margin + 62, yPos, 55, 45, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('CANCELLATIONS', margin + 67, yPos + 12);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(cancelled, margin + 67, yPos + 32);
                
                doc.setFillColor(...gold);
                doc.roundedRect(margin + 124, yPos, 55, 45, 3, 3, 'F');
                doc.setTextColor(30, 30, 30);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('NET CHANGE', margin + 129, yPos + 12);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(netChange, margin + 129, yPos + 32);
                
                // Fees Section
                yPos += 65;
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Fees & Charges', margin, yPos);
                
                doc.setDrawColor(...gold);
                doc.setLineWidth(1);
                doc.line(margin, yPos + 3, margin + 40, yPos + 3);
                
                yPos += 15;
                
                const fees = [
                    { label: 'Audit Fee', value: '15%' },
                    { label: 'Registration Fee (Annual)', value: '$24' },
                    { label: 'Monthly Fee (Annual)', value: '$9' }
                ];
                
                fees.forEach((fee, i) => {
                    const rowY = yPos + (i * 18);
                    doc.setFillColor(i % 2 === 0 ? 250 : 245, 250, i % 2 === 0 ? 250 : 245);
                    doc.roundedRect(margin, rowY, contentWidth, 15, 2, 2, 'F');
                    
                    doc.setFontSize(11);
                    doc.setTextColor(...textDark);
                    doc.setFont('helvetica', 'normal');
                    doc.text(fee.label, margin + 5, rowY + 10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...greenDark);
                    doc.text(fee.value, margin + contentWidth - 30, rowY + 10);
                });
                
                // ==================== FINAL PAGE: FOOTER ====================
                updateProgress(90, 'Finalizing report...');
                await new Promise(r => setTimeout(r, 200));
                
                // Add footer to all pages
                const totalPages = doc.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(9);
                    doc.setTextColor(...textMuted);
                    doc.text(`Page ${i} of ${totalPages}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                    if (i > 1) {
                        doc.text('Polaris Financial Services - Confidential', margin, pageHeight - 10);
                    }
                }
                
                // ==================== SAVE ====================
                updateProgress(100, 'Complete!');
                titleText.textContent = 'Report Ready!';
                statusText.textContent = 'Your report has been generated successfully';
                stepText.textContent = 'Downloading...';
                
                await new Promise(r => setTimeout(r, 500));
                
                // Save PDF
                const fileName = `Polaris_Report_${clientName.replace(/\s+/g, '_')}_${periodLabel.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
                
                // Close modal after delay
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 1500);
                
            } catch (error) {
                console.error('Report generation error:', error);
                titleText.textContent = 'Error';
                statusText.textContent = 'Failed to generate report';
                stepText.textContent = error.message;
                progressBar.style.background = '#e74c3c';
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 3000);
            }
        }
        
        async function showDashboard() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('mainHeader').style.display = 'block';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('mainFooter').style.display = 'block';
            document.getElementById('clientName').textContent = currentUser.username || 'User';
            document.getElementById('clientAvatar').textContent = (currentUser.username || 'U')[0].toUpperCase();
            await loadData();
            document.getElementById('loadingScreen').classList.add('hidden');
        }
        
        async function loadData() {
            try {
                const r = await fetch(`${API_URL}?action=getMasterComparison`);
                const d = await r.json();
                if (d.success) updateDashboard(d.data);
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
            } catch(e) { console.error(e); }
        }
        
        function updateDashboard(data) {
            if (!data.current_period) return;
            const c = data.current_period, p = data.previous_period, ch = data.changes, periods = data.all_periods || [];
            
            document.getElementById('periodBadge').textContent = c.period_label;
            if (p) document.getElementById('cmpPeriodLabel').textContent = `${c.period_label} vs ${p.period_label}`;
            
            document.getElementById('kpiMembers').textContent = fmt(c.members);
            document.getElementById('kpiClaims').textContent = fmt(c.claims);
            document.getElementById('kpiApproved').textContent = '$' + fmt(c.approved_usd);
            document.getElementById('kpiCost').textContent = '$' + c.cost_per_member.toFixed(2);
            const util = c.members > 0 ? (c.claims / c.members * 100) : 0;
            document.getElementById('kpiUtilization').textContent = util.toFixed(1) + '%';
            document.getElementById('totalActive').textContent = fmt(c.members);
            
            if (ch) {
                setTrend('kpiMembersTrend', ch.members);
                setTrend('kpiClaimsTrend', ch.claims);
                setTrend('kpiApprovedTrend', ch.approved_usd);
                setTrend('kpiCostTrend', ch.cost_per_member);
            }
            
            if (p && ch) {
                document.getElementById('cmpClaims').textContent = fmt(c.claims);
                document.getElementById('cmpClaimsPrev').textContent = fmt(p.claims);
                setChange('cmpClaimsChange', ch.claims);
                document.getElementById('cmpMembers').textContent = fmt(c.members);
                document.getElementById('cmpMembersPrev').textContent = fmt(p.members);
                setChange('cmpMembersChange', ch.members);
                document.getElementById('cmpApproved').textContent = '$' + fmt(c.approved_usd);
                document.getElementById('cmpApprovedPrev').textContent = '$' + fmt(p.approved_usd);
                setChange('cmpApprovedChange', ch.approved_usd);
                document.getElementById('cmpCost').textContent = '$' + c.cost_per_member.toFixed(2);
                document.getElementById('cmpCostPrev').textContent = '$' + p.cost_per_member.toFixed(2);
                setChange('cmpCostChange', ch.cost_per_member);
            }
            
            // NEW: Inpatient/Outpatient data (mock - will come from CBMS)
            const inpatientPct = 25;
            const outpatientPct = 75;
            const inpatientCases = Math.round(c.claims * 0.25);
            const outpatientCases = c.claims - inpatientCases;
            const inpatientCostVal = Math.round(c.approved_usd * 0.65);
            const outpatientCostVal = c.approved_usd - inpatientCostVal;
            
            document.getElementById('inpatientCases').textContent = fmt(inpatientCases);
            document.getElementById('outpatientCases').textContent = fmt(outpatientCases);
            document.getElementById('inpatientCost').textContent = '$' + fmt(inpatientCostVal);
            document.getElementById('outpatientCost').textContent = '$' + fmt(outpatientCostVal);
            
            // NEW: Principal/Dependent data (mock - will come from CBMS)
            const principalPct = 40;
            const dependentPct = 60;
            const principalMembers = Math.round(c.members * 0.4);
            const dependentMembers = c.members - principalMembers;
            
            document.getElementById('principalCount').textContent = fmt(principalMembers);
            document.getElementById('dependentCount').textContent = fmt(dependentMembers);
            document.getElementById('principalCost').textContent = '$' + (c.cost_per_member * 1.2).toFixed(2);
            document.getElementById('dependentCost').textContent = '$' + (c.cost_per_member * 0.85).toFixed(2);
            
            // NEW: Member Movement (mock - will come from CBMS)
            const newEnroll = Math.round(c.members * 0.08);
            const cancelled = Math.round(c.members * 0.03);
            document.getElementById('newEnrollments').textContent = '+' + newEnroll;
            document.getElementById('cancellations').textContent = '-' + cancelled;
            document.getElementById('netChange').textContent = (newEnroll - cancelled > 0 ? '+' : '') + (newEnroll - cancelled);
            
            createCharts(periods, c);
            createInOutCharts(periods, inpatientCases, outpatientCases, inpatientCostVal, outpatientCostVal);
            createMemberTypeCharts(principalMembers, dependentMembers);
            createMovementCharts(periods);
            createCostBreakdownChart(c);
            updateMetrics(util);
            updateInsights(ch);
            updateTable(periods);
        }
        
        function createInOutCharts(periods, inCases, outCases, inCost, outCost) {
            // Inpatient/Outpatient Pie
            const ctx1 = document.getElementById('inOutPieChart').getContext('2d');
            if (charts.inOutPie) charts.inOutPie.destroy();
            charts.inOutPie = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Inpatient', 'Outpatient'],
                    datasets: [{ data: [inCases, outCases], backgroundColor: ['#e74c3c', '#3498db'], borderWidth: 0, hoverOffset: 10 }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { display: true, position: 'bottom', labels: { color: '#b8c9b8' } } } }
            });
            
            // Cost Comparison Bar
            const ctx2 = document.getElementById('inOutCostChart').getContext('2d');
            if (charts.inOutCost) charts.inOutCost.destroy();
            charts.inOutCost = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Inpatient', 'Outpatient'],
                    datasets: [{ data: [inCost, outCost], backgroundColor: ['#e74c3c', '#3498db'], borderRadius: 6 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#7a8f7a' } }, y: { grid: { color: '#1e3a1e' }, ticks: { color: '#7a8f7a', callback: v => '$' + fmt(v) } } } }
            });
            
            // Trend Chart
            const ctx3 = document.getElementById('inOutTrendChart').getContext('2d');
            if (charts.inOutTrend) charts.inOutTrend.destroy();
            charts.inOutTrend = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: periods.map(p => p.period_label),
                    datasets: [
                        { label: 'Inpatient', data: periods.map(p => Math.round(p.claims * 0.25)), borderColor: '#e74c3c', backgroundColor: 'rgba(231,76,60,0.1)', fill: true, tension: 0.4 },
                        { label: 'Outpatient', data: periods.map(p => Math.round(p.claims * 0.75)), borderColor: '#3498db', backgroundColor: 'rgba(52,152,219,0.1)', fill: true, tension: 0.4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top', labels: { color: '#b8c9b8' } } }, scales: { x: { grid: { display: false }, ticks: { color: '#7a8f7a' } }, y: { grid: { color: '#1e3a1e' }, ticks: { color: '#7a8f7a' } } } }
            });
        }
        
        function createMemberTypeCharts(principal, dependent) {
            // Member Type Pie
            const ctx1 = document.getElementById('memberTypePieChart').getContext('2d');
            if (charts.memberPie) charts.memberPie.destroy();
            charts.memberPie = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Seafarers', 'Dependents'],
                    datasets: [{ data: [principal, dependent], backgroundColor: ['#2E7D32', '#D4AF37'], borderWidth: 0, hoverOffset: 10 }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { display: true, position: 'bottom', labels: { color: '#b8c9b8' } } } }
            });
            
            // Cost Comparison
            const ctx2 = document.getElementById('memberTypeCostChart').getContext('2d');
            if (charts.memberCost) charts.memberCost.destroy();
            charts.memberCost = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Seafarers', 'Dependents'],
                    datasets: [{ data: [72, 58], backgroundColor: ['#2E7D32', '#D4AF37'], borderRadius: 6 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#7a8f7a' } }, y: { grid: { color: '#1e3a1e' }, ticks: { color: '#7a8f7a', callback: v => '$' + v } } } }
            });
        }
        
        function createMovementCharts(periods) {
            // Enrollment Chart
            const ctx1 = document.getElementById('enrollmentChart').getContext('2d');
            if (charts.enrollment) charts.enrollment.destroy();
            charts.enrollment = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: periods.map(p => p.period_label),
                    datasets: [{ data: periods.map(p => Math.round(p.members * 0.08)), backgroundColor: 'rgba(76,175,80,0.7)', borderRadius: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#7a8f7a' } }, y: { grid: { color: '#1e3a1e' }, ticks: { color: '#7a8f7a' } } } }
            });
            
            // Cancellation Chart
            const ctx2 = document.getElementById('cancellationChart').getContext('2d');
            if (charts.cancellation) charts.cancellation.destroy();
            charts.cancellation = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: periods.map(p => p.period_label),
                    datasets: [{ data: periods.map(p => Math.round(p.members * 0.03)), backgroundColor: 'rgba(231,76,60,0.7)', borderRadius: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#7a8f7a' } }, y: { grid: { color: '#1e3a1e' }, ticks: { color: '#7a8f7a' } } } }
            });
            
            // Net Change Chart
            const ctx3 = document.getElementById('netChangeChart').getContext('2d');
            if (charts.netChange) charts.netChange.destroy();
            charts.netChange = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: periods.map(p => p.period_label),
                    datasets: [{ data: periods.map(p => Math.round(p.members * 0.05)), borderColor: '#D4AF37', backgroundColor: 'rgba(212,175,55,0.2)', fill: true, tension: 0.4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#7a8f7a' } }, y: { grid: { color: '#1e3a1e' }, ticks: { color: '#7a8f7a' } } } }
            });
        }
        
        function createCostBreakdownChart(current) {
            const ctx = document.getElementById('costBreakdownChart').getContext('2d');
            if (charts.costBreakdown) charts.costBreakdown.destroy();
            
            const baseCost = current.cost_per_member * 0.7;
            const auditFee = baseCost * 0.15;
            const regFee = 24;
            const monthlyFee = 9;
            
            charts.costBreakdown = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Base Claims Cost', 'Audit Fee (15%)', 'Registration Fee', 'Monthly Fee', 'Total Annualized'],
                    datasets: [{
                        data: [baseCost, auditFee, regFee, monthlyFee, current.cost_per_member],
                        backgroundColor: ['#2E7D32', '#D4AF37', '#3498db', '#9b59b6', '#e74c3c'],
                        borderRadius: 6
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        x: { grid: { display: false }, ticks: { color: '#7a8f7a' } }, 
                        y: { grid: { color: '#1e3a1e' }, ticks: { color: '#7a8f7a', callback: v => '$' + v.toFixed(0) } } 
                    } 
                }
            });
        }
        
        function setTrend(id, ch) {
            const el = document.getElementById(id);
            if (!ch || ch.percentage === null) { el.textContent = 'N/A'; return; }
            el.innerHTML = `${ch.percentage > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(ch.percentage).toFixed(1)}%`;
            el.className = `kpi-trend ${ch.is_good ? 'down' : 'up'}`;
        }
        
        function setChange(id, ch) {
            const el = document.getElementById(id);
            if (!ch || ch.percentage === null) { el.textContent = 'N/A'; return; }
            el.innerHTML = `${ch.percentage > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(ch.percentage).toFixed(1)}%`;
            el.className = `cmp-change ${ch.is_good ? 'positive' : 'negative'}`;
        }
        
        function createCharts(periods, current) {
            const labels = periods.map(p => p.period_label);
            const opts = {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { backgroundColor: '#0d1f0d', borderColor: '#1e3a1e', borderWidth: 1 } }
            };
            
            // Cost Trend
            const ctx1 = document.getElementById('costTrendChart').getContext('2d');
            if (charts.cost) charts.cost.destroy();
            const grad = ctx1.createLinearGradient(0, 0, 0, 350);
            grad.addColorStop(0, 'rgba(212,175,55,0.3)'); grad.addColorStop(1, 'rgba(212,175,55,0)');
            charts.cost = new Chart(ctx1, {
                type: 'line',
                data: { labels, datasets: [{ data: periods.map(p => p.cost_per_member), borderColor: '#D4AF37', backgroundColor: grad, fill: true, tension: 0.4, pointRadius: 5, borderWidth: 3 }] },
                options: { ...opts, scales: { x: { grid: { color: '#1e3a1e' }, ticks: { color: '#7a8f7a' } }, y: { grid: { color: '#1e3a1e' }, ticks: { color: '#D4AF37', callback: v => '$' + v } } } }
            });
            
            // Approved
            const ctx2 = document.getElementById('approvedChart').getContext('2d');
            if (charts.approved) charts.approved.destroy();
            charts.approved = new Chart(ctx2, {
                type: 'bar',
                data: { labels, datasets: [{ data: periods.map(p => p.approved_usd), backgroundColor: 'rgba(46,125,50,0.8)', borderColor: '#2E7D32', borderWidth: 2, borderRadius: 6 }] },
                options: { ...opts, scales: { x: { grid: { display: false }, ticks: { color: '#7a8f7a' } }, y: { grid: { color: '#1e3a1e' }, ticks: { color: '#7a8f7a', callback: v => '$' + fmt(v) } } } }
            });
            
            // Gauge
            const canvas = document.getElementById('gaugeChart');
            const gctx = canvas.getContext('2d');
            const pct = Math.min(current.cost_per_member / 100, 1);
            gctx.clearRect(0, 0, 200, 200);
            gctx.beginPath(); gctx.arc(100, 100, 75, Math.PI * 0.75, Math.PI * 2.25); gctx.lineWidth = 20; gctx.strokeStyle = '#1e3a1e'; gctx.stroke();
            const gg = gctx.createLinearGradient(0, 0, 200, 0); gg.addColorStop(0, '#2E7D32'); gg.addColorStop(0.5, '#D4AF37'); gg.addColorStop(1, '#e74c3c');
            gctx.beginPath(); gctx.arc(100, 100, 75, Math.PI * 0.75, Math.PI * 0.75 + Math.PI * 1.5 * pct); gctx.lineWidth = 20; gctx.strokeStyle = gg; gctx.lineCap = 'round'; gctx.stroke();
            document.getElementById('gaugeValue').textContent = '$' + current.cost_per_member.toFixed(2);
            
            // Claims by Period
            const ctx3 = document.getElementById('claimsPeriodChart').getContext('2d');
            if (charts.claimsPeriod) charts.claimsPeriod.destroy();
            charts.claimsPeriod = new Chart(ctx3, {
                type: 'bar',
                data: { labels, datasets: [{ data: periods.map(p => p.claims), backgroundColor: 'rgba(212,175,55,0.7)', borderRadius: 4 }] },
                options: { ...opts, scales: { x: { grid: { display: false }, ticks: { color: '#7a8f7a' } }, y: { grid: { color: '#1e3a1e' }, ticks: { color: '#7a8f7a' } } } }
            });
            
            // Claims per 1000
            const ctx4 = document.getElementById('claims1000Chart').getContext('2d');
            if (charts.claims1000) charts.claims1000.destroy();
            charts.claims1000 = new Chart(ctx4, {
                type: 'line',
                data: { labels, datasets: [{ data: periods.map(p => p.members > 0 ? p.claims / p.members * 1000 : 0), borderColor: '#3498db', backgroundColor: 'rgba(52,152,219,0.1)', fill: true, tension: 0.4 }] },
                options: { ...opts, scales: { x: { grid: { display: false }, ticks: { color: '#7a8f7a' } }, y: { grid: { color: '#1e3a1e' }, ticks: { color: '#7a8f7a' } } } }
            });
            
            // Avg Claim
            const ctx5 = document.getElementById('avgClaimChart').getContext('2d');
            if (charts.avgClaim) charts.avgClaim.destroy();
            charts.avgClaim = new Chart(ctx5, {
                type: 'line',
                data: { labels, datasets: [{ data: periods.map(p => p.claims > 0 ? p.approved_usd / p.claims : 0), borderColor: '#f39c12', backgroundColor: 'rgba(243,156,18,0.1)', fill: true, tension: 0.4 }] },
                options: { ...opts, scales: { x: { grid: { display: false }, ticks: { color: '#7a8f7a' } }, y: { grid: { color: '#1e3a1e' }, ticks: { color: '#7a8f7a', callback: v => '$' + v.toFixed(0) } } } }
            });
            
            // Plan Pie
            const ctx6 = document.getElementById('planPieChart').getContext('2d');
            if (charts.planPie) charts.planPie.destroy();
            charts.planPie = new Chart(ctx6, {
                type: 'doughnut',
                data: { labels: ['Gold', 'Platinum', 'Silver'], datasets: [{ data: [60, 25, 15], backgroundColor: ['#FFD700', '#E5E4E2', '#C0C0C0'], borderColor: '#0a1a0a', borderWidth: 4, hoverOffset: 15 }] },
                options: { ...opts, cutout: '55%', plugins: { legend: { display: true, position: 'bottom', labels: { color: '#b8c9b8' } } } }
            });
            
            // Plan Cost
            const ctx7 = document.getElementById('planCostChart').getContext('2d');
            if (charts.planCost) charts.planCost.destroy();
            charts.planCost = new Chart(ctx7, {
                type: 'bar',
                data: { labels: ['Gold', 'Platinum', 'Silver'], datasets: [{ data: [65, 85, 35], backgroundColor: ['#FFD700', '#E5E4E2', '#C0C0C0'], borderRadius: 6 }] },
                options: { ...opts, indexAxis: 'y', scales: { x: { grid: { color: '#1e3a1e' }, ticks: { color: '#7a8f7a', callback: v => '$' + v } }, y: { grid: { display: false }, ticks: { color: '#fff' } } } }
            });
            
            // Utilization
            const ctx8 = document.getElementById('utilizationChart').getContext('2d');
            if (charts.util) charts.util.destroy();
            charts.util = new Chart(ctx8, {
                type: 'line',
                data: { labels, datasets: [{ data: periods.map(p => p.members > 0 ? p.claims / p.members * 100 : 0), borderColor: '#4CAF50', backgroundColor: 'rgba(76,175,80,0.1)', fill: true, tension: 0.4 }] },
                options: { ...opts, scales: { x: { grid: { display: false }, ticks: { color: '#7a8f7a' } }, y: { grid: { color: '#1e3a1e' }, ticks: { color: '#7a8f7a', callback: v => v + '%' } } } }
            });
        }
        
        function updateMetrics(util) {
            document.getElementById('utilValue').textContent = util.toFixed(1) + '%';
            document.getElementById('utilBar').style.width = Math.min(util * 2, 100) + '%';
        }
        
        function updateInsights(ch) {
            const list = document.getElementById('insightsList');
            const insights = [];
            if (ch) {
                if (ch.cost_per_member.is_good) insights.push({ type: 'success', icon: '‚úì', title: 'Cost Improvement', desc: `Cost decreased by ${Math.abs(ch.cost_per_member.percentage).toFixed(1)}%` });
                else if (ch.cost_per_member.percentage > 10) insights.push({ type: 'danger', icon: '‚ö†', title: 'Cost Alert', desc: `Cost increased by ${ch.cost_per_member.percentage.toFixed(1)}%` });
                if (ch.members.is_good) insights.push({ type: 'success', icon: 'üìà', title: 'Growth', desc: `Members grew by ${ch.members.percentage.toFixed(1)}%` });
                if (!ch.claims.is_good) insights.push({ type: 'warning', icon: '!', title: 'Claims Up', desc: `Claims increased by ${ch.claims.percentage.toFixed(1)}%` });
            }
            while (insights.length < 3) insights.push({ type: 'info', icon: '‚Ñπ', title: 'Analysis', desc: 'Continue monitoring trends' });
            list.innerHTML = insights.slice(0, 3).map(i => `
                <div class="insight-item ${i.type}">
                    <div class="insight-icon">${i.icon}</div>
                    <div><div class="insight-title">${i.title}</div><div class="insight-desc">${i.desc}</div></div>
                </div>
            `).join('');
        }
        
        function updateTable(periods) {
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = periods.map((p, i) => {
                const rank = periods.length - i;
                const cls = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
                const util = p.members > 0 ? (p.claims / p.members * 100).toFixed(1) : 0;
                return `<tr>
                    <td><div class="rank-badge ${cls}">${rank}</div></td>
                    <td><strong>${p.period_label}</strong></td>
                    <td>${fmt(p.members)}</td>
                    <td>${fmt(p.claims)}</td>
                    <td>‚Ç±${fmt(p.approved_php)}</td>
                    <td class="currency">$${fmt(p.approved_usd)}</td>
                    <td class="currency">$${p.cost_per_member.toFixed(2)}</td>
                    <td>${util}%</td>
                </tr>`;
            }).reverse().join('');
        }
        
        function fmt(n) { return n === undefined ? '-' : n.toLocaleString('en-US', { maximumFractionDigits: 0 }); }
    </script>
</body>
</html>

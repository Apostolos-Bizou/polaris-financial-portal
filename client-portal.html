<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polaris Financial Services - Client Portal</title>
    <!-- VERSION: 2026-02-07-v5 - Cost Per Member Only - All syntax fixed -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --polaris-green: #1B5E20;
            --polaris-green-light: #2E7D32;
            --polaris-gold: #D4AF37;
            --gold-plan: #FFD700;
            --platinum-plan: #E5E4E2;
            --silver-plan: #C0C0C0;
            --bg-dark: #0a1a0a;
            --bg-card: #0d1f0d;
            --text-primary: #ffffff;
            --text-secondary: #b8c9b8;
            --text-muted: #7a8f7a;
            --border-color: #1e3a1e;
            --success: #4CAF50;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Open Sans', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }
        h1, h2, h3 { font-family: 'Montserrat', sans-serif; }
        
        .bg-pattern {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(ellipse at 20% 20%, rgba(27, 94, 32, 0.15) 0%, transparent 50%),
                        radial-gradient(ellipse at 80% 80%, rgba(212, 175, 55, 0.08) 0%, transparent 50%);
        }
        
        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 10000;
            transition: opacity 0.5s;
        }
        .loading-screen.hidden { opacity: 0; visibility: hidden; }
        .loader-ring {
            width: 80px; height: 80px; border: 3px solid var(--border-color);
            border-top-color: var(--polaris-gold); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 1.5rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .login-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: flex;
            align-items: center; justify-content: center; z-index: 9999;
        }
        .login-modal.hidden { display: none; }
        .login-box {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 20px; padding: 3rem; width: 100%; max-width: 420px;
        }
        .login-box::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--polaris-green), var(--polaris-gold));
        }
        .login-title {
            font-size: 1.75rem; font-weight: 700; text-align: center;
            margin-bottom: 0.5rem;
        }
        .login-subtitle {
            text-align: center; color: var(--text-secondary);
            margin-bottom: 2rem;
        }
        .login-input {
            width: 100%; background: var(--bg-dark);
            border: 1px solid var(--border-color); border-radius: 10px;
            padding: 1rem; color: var(--text-primary);
            font-family: inherit; margin-bottom: 1rem;
        }
        .login-input:focus { outline: none; border-color: var(--polaris-green); }
        .login-btn {
            width: 100%; background: linear-gradient(135deg, var(--polaris-green), var(--polaris-green-light));
            border: none; border-radius: 10px; padding: 1rem;
            color: white; font-family: 'Montserrat', sans-serif;
            font-weight: 700; cursor: pointer; transition: transform 0.3s;
        }
        .login-btn:hover { transform: translateY(-2px); }
        .login-error { color: var(--danger); text-align: center; margin-top: 1rem; }
        
        .header {
            background: rgba(10, 26, 10, 0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem; position: sticky; top: 0; z-index: 100;
        }
        .header-content {
            max-width: 1600px; margin: 0 auto;
            display: flex; align-items: center; justify-content: space-between;
        }
        .logo-section { display: flex; align-items: center; gap: 0.75rem; }
        .polaris-star {
            font-size: 2rem;
            background: linear-gradient(135deg, #FFD700, #FFA000, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 8px rgba(255,215,0,0.5));
            animation: starGlow 2s ease-in-out infinite alternate;
        }
        @keyframes starGlow {
            from { filter: drop-shadow(0 0 5px rgba(255,215,0,0.4)); }
            to { filter: drop-shadow(0 0 12px rgba(255,215,0,0.7)); }
        }
        .polaris-text {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4rem;
            font-weight: 800;
            letter-spacing: 2px;
            background: linear-gradient(135deg, #D4AF37, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .logo-section img { height: 40px; }
        .portal-badge {
            background: var(--polaris-gold); color: var(--bg-dark);
            padding: 0.3rem 0.8rem; border-radius: 15px;
            font-size: 0.7rem; font-weight: 700;
        }
        .user-section { display: flex; align-items: center; gap: 1rem; }
        .client-badge {
            display: flex; align-items: center; gap: 0.5rem;
            background: var(--bg-card); border: 1px solid var(--border-color);
            padding: 0.4rem 1rem 0.4rem 0.4rem; border-radius: 25px;
        }
        .client-avatar {
            width: 32px; height: 32px; border-radius: 50%;
            background: var(--polaris-green); display: flex;
            align-items: center; justify-content: center; font-weight: 700;
        }
        .logout-btn {
            background: transparent; border: 1px solid var(--border-color);
            color: var(--text-secondary); padding: 0.5rem 1rem;
            border-radius: 8px; cursor: pointer;
        }
        .logout-btn:hover { background: var(--danger); border-color: var(--danger); color: white; }
        .active-members-btn {
            display: flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, var(--polaris-gold), #FFA000);
            color: var(--bg-dark); padding: 0.6rem 1.25rem;
            border-radius: 25px; text-decoration: none;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem; font-weight: 700;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(212,175,55,0.3);
        }
        .active-members-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212,175,55,0.5);
        }
        .report-btn {
            display: flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, #2E7D32, #4CAF50);
            color: white; padding: 0.6rem 1.25rem;
            border: none; border-radius: 25px; cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem; font-weight: 700;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(46,125,50,0.3);
        }
        .report-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(46,125,50,0.5);
        }
        .reports-btn {
            display: flex; align-items: center; gap: 0.5rem;
            background: linear-gradient(135deg, #B8860B, #D4AF37);
            color: white; padding: 0.6rem 1.25rem;
            border: none; border-radius: 25px; cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem; font-weight: 700;
            transition: all 0.3s; box-shadow: 0 4px 15px rgba(123,31,162,0.3);
        }
        .reports-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(123,31,162,0.5);
        }
        
        /* Company Selector Dropdown */
        .company-selector {
            position: relative;
        }
        .company-selector select {
            background: linear-gradient(135deg, var(--polaris-green), var(--polaris-green-light));
            color: white;
            border: none;
            padding: 0.6rem 2rem 0.6rem 1rem;
            border-radius: 25px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            min-width: 180px;
            box-shadow: 0 4px 15px rgba(27,94,32,0.3);
            transition: all 0.3s;
        }
        .company-selector select:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(27,94,32,0.5);
        }
        .company-selector select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(212,175,55,0.3);
        }
        .company-selector select option {
            background: var(--bg-dark);
            color: var(--text-primary);
            padding: 0.5rem;
        }
        
        /* Report Builder Modal */
        .report-builder-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex;
            align-items: center; justify-content: center; z-index: 9999;
            backdrop-filter: blur(5px);
        }
        .report-builder-modal.hidden { display: none; }
        .report-builder-box {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 24px; padding: 0; width: 100%; max-width: 800px;
            max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;
        }
        .rb-header {
            background: linear-gradient(135deg, #1B5E20, #2E7D32);
            padding: 1.5rem 2rem; color: white;
        }
        .rb-header h2 { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem; }
        .rb-header p { font-size: 0.9rem; opacity: 0.9; }
        .rb-close {
            position: absolute; top: 1rem; right: 1.5rem;
            background: rgba(255,255,255,0.2); border: none;
            width: 36px; height: 36px; border-radius: 50%;
            color: white; font-size: 1.25rem; cursor: pointer;
            transition: background 0.3s;
        }
        .rb-close:hover { background: rgba(255,255,255,0.3); }
        .rb-content {
            padding: 2rem; overflow-y: auto; flex: 1;
        }
        .rb-section { margin-bottom: 2rem; }
        .rb-section:last-child { margin-bottom: 0; }
        .rb-section-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem; font-weight: 700; color: var(--text-primary);
            margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;
        }
        
        /* Period Selection */
        .rb-period-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;
        }
        .rb-select-group label {
            display: block; font-size: 0.8rem; color: var(--text-muted);
            margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .rb-select {
            width: 100%; background: var(--bg-dark); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 0.8rem 1rem; color: var(--text-primary);
            font-family: inherit; font-size: 0.95rem; cursor: pointer;
        }
        .rb-select:focus { outline: none; border-color: #D4AF37; }
        
        /* Quick Templates */
        .rb-templates {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem;
        }
        .rb-template-btn {
            background: var(--bg-dark); border: 2px solid var(--border-color);
            border-radius: 12px; padding: 1rem; text-align: center;
            cursor: pointer; transition: all 0.3s; color: var(--text-primary);
        }
        .rb-template-btn:hover {
            border-color: #D4AF37; background: rgba(212,175,55,0.1);
        }
        .rb-template-btn.active {
            border-color: #D4AF37; background: rgba(212,175,55,0.15);
        }
        .rb-template-btn span { display: block; font-size: 1.5rem; margin-bottom: 0.5rem; }
        .rb-template-btn div { font-size: 0.85rem; font-weight: 600; }
        
        /* Report Sections */
        .rb-sections-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .rb-section-item {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg-dark); border: 2px solid var(--border-color);
            border-radius: 12px; padding: 1rem 1.25rem; cursor: pointer;
            transition: all 0.3s;
        }
        .rb-section-item:hover { border-color: rgba(212,175,55,0.5); }
        .rb-section-item.selected {
            border-color: #D4AF37; background: rgba(212,175,55,0.1);
        }
        .rb-section-item input[type="checkbox"] {
            width: 20px; height: 20px; accent-color: #D4AF37;
            margin-right: 1rem; cursor: pointer;
        }
        .rb-section-item-content { flex: 1; }
        .rb-section-item-title { font-weight: 600; font-size: 0.95rem; }
        .rb-section-item-desc { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.2rem; }
        .rb-section-item-badge {
            background: rgba(33,150,243,0.2); color: #2196F3;
            padding: 0.3rem 0.75rem; border-radius: 20px;
            font-size: 0.75rem; font-weight: 600;
        }
        
        /* Export Format */
        .rb-formats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .rb-format-btn {
            background: var(--bg-dark); border: 2px solid var(--border-color);
            border-radius: 16px; padding: 1.5rem; text-align: center;
            cursor: pointer; transition: all 0.3s;
        }
        .rb-format-btn:hover { border-color: #D4AF37; }
        .rb-format-btn.selected {
            border-color: #D4AF37; background: rgba(212,175,55,0.1);
        }
        .rb-format-btn span { display: block; font-size: 2.5rem; margin-bottom: 0.5rem; }
        .rb-format-btn div { font-size: 1rem; font-weight: 600; color: var(--text-primary); }
        
        /* Info Box */
        .rb-info-box {
            background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.3);
            border-radius: 12px; padding: 1rem 1.25rem;
            display: flex; align-items: flex-start; gap: 0.75rem;
        }
        .rb-info-box span { font-size: 1.5rem; }
        .rb-info-box div { font-size: 0.85rem; color: var(--text-secondary); }
        .rb-info-box strong { color: var(--polaris-gold); }
        
        /* Footer Actions */
        .rb-footer {
            padding: 1.5rem 2rem; border-top: 1px solid var(--border-color);
            display: flex; gap: 1rem; background: var(--bg-dark);
        }
        .rb-btn {
            flex: 1; padding: 1rem; border-radius: 12px; font-family: 'Montserrat', sans-serif;
            font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .rb-btn-cancel {
            background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-secondary);
        }
        .rb-btn-cancel:hover { background: var(--border-color); }
        .rb-btn-preview {
            background: transparent; border: 2px solid #D4AF37; color: #D4AF37;
        }
        .rb-btn-preview:hover { background: rgba(212,175,55,0.1); }
        .rb-btn-generate {
            background: linear-gradient(135deg, #1B5E20, #2E7D32); border: none; color: white;
            box-shadow: 0 4px 15px rgba(27,94,32,0.3);
        }
        .rb-btn-generate:hover {
            transform: translateY(-2px); box-shadow: 0 8px 25px rgba(27,94,32,0.4);
        }
        
        @media (max-width: 768px) {
            .rb-templates { grid-template-columns: repeat(2, 1fr); }
            .rb-formats { grid-template-columns: 1fr; }
            .rb-period-grid { grid-template-columns: 1fr; }
        }
        
        /* Report Modal */
        .report-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex;
            align-items: center; justify-content: center; z-index: 9999;
        }
        .report-modal.hidden { display: none; }
        .report-box {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 20px; padding: 2rem; width: 100%; max-width: 500px;
            text-align: center;
        }
        .report-progress {
            width: 100%; height: 8px; background: var(--bg-dark);
            border-radius: 4px; margin: 1.5rem 0; overflow: hidden;
        }
        .report-progress-bar {
            height: 100%; background: linear-gradient(90deg, var(--polaris-green), var(--polaris-gold));
            border-radius: 4px; transition: width 0.3s;
        }
        
        .main-content { max-width: 1600px; margin: 0 auto; padding: 2rem; }
        
        .page-header { margin-bottom: 2rem; }
        .page-title {
            font-size: 1.75rem; font-weight: 700;
            display: flex; align-items: center; gap: 0.75rem;
        }
        .page-subtitle { color: var(--text-secondary); margin-top: 0.5rem; }
        .period-badge {
            display: inline-block; background: var(--bg-card);
            border: 1px solid var(--polaris-gold); color: var(--polaris-gold);
            padding: 0.4rem 1rem; border-radius: 20px;
            font-family: 'Montserrat', sans-serif; font-weight: 600;
        }
        
        .section { margin-bottom: 2.5rem; }
        .section-title {
            font-size: 1.6rem; 
            font-weight: 800;
            margin-bottom: 1.5rem; 
            display: flex; 
            align-items: center; 
            gap: 0.75rem;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-color);
            position: relative;
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, var(--polaris-gold), var(--polaris-green));
        }
        
        .kpi-grid {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 1.25rem; margin-bottom: 2rem;
        }
        .kpi-card {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 16px; padding: 1.5rem;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        .kpi-card::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 100%; height: 4px; border-radius: 16px 16px 0 0;
            background: linear-gradient(90deg, var(--polaris-green), var(--polaris-gold));
        }
        .kpi-icon { font-size: 2rem; margin-bottom: 0.75rem; }
        .kpi-label {
            font-size: 0.75rem; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem;
        }
        .kpi-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.75rem; font-weight: 800;
            color: var(--polaris-gold);
        }
        .kpi-trend {
            display: inline-flex; align-items: center; gap: 0.3rem;
            margin-top: 0.5rem; padding: 0.25rem 0.6rem;
            border-radius: 15px; font-size: 0.8rem; font-weight: 600;
        }
        .kpi-trend.up { background: rgba(231, 76, 60, 0.15); color: var(--danger); }
        .kpi-trend.down { background: rgba(76, 175, 80, 0.15); color: var(--success); }
        
        .comparison-banner {
            background: linear-gradient(135deg, var(--bg-card), rgba(27, 94, 32, 0.2));
            border: 1px solid var(--border-color); border-radius: 20px;
            padding: 2rem; margin-bottom: 2rem;
        }
        .comparison-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 1.5rem;
        }
        .comparison-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.25rem;
        }
        .cmp-card {
            background: rgba(0,0,0,0.3); border-radius: 12px; padding: 1.75rem;
        }
        .cmp-label {
            font-size: 0.95rem; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1rem;
            font-weight: 600;
        }
        .cmp-values { display: flex; align-items: baseline; gap: 0.75rem; margin-bottom: 0.75rem; }
        .cmp-current { font-family: 'Montserrat', sans-serif; font-size: 2rem; font-weight: 700; }
        .cmp-previous { font-size: 1.1rem; color: var(--text-muted); text-decoration: line-through; }
        .cmp-change {
            display: inline-flex; align-items: center; gap: 0.25rem;
            padding: 0.4rem 0.8rem; border-radius: 15px;
            font-size: 1rem; font-weight: 600;
        }
        .cmp-change.positive { background: rgba(76, 175, 80, 0.2); color: var(--success); }
        .cmp-change.negative { background: rgba(231, 76, 60, 0.2); color: var(--danger); }
        
        .chart-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.25rem;
        }
        .chart-grid.three { grid-template-columns: repeat(3, 1fr); }
        .chart-card {
            background: linear-gradient(145deg, var(--bg-card), rgba(10,20,10,0.95));
            border: 1px solid var(--border-color);
            border-radius: 16px; padding: 1.5rem;
            box-shadow: 
                0 10px 30px rgba(0,0,0,0.4),
                0 5px 15px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .chart-card:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 15px 40px rgba(0,0,0,0.5),
                0 8px 20px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255,255,255,0.08);
        }
        .chart-card.wide { grid-column: span 2; }
        .chart-card.full { grid-column: span 3; }
        .chart-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 1.25rem;
        }
        .chart-title { font-size: 1.15rem; font-weight: 700; }
        .chart-badge {
            background: rgba(212, 175, 55, 0.2); color: var(--polaris-gold);
            padding: 0.3rem 0.75rem; border-radius: 12px;
            font-size: 0.85rem; font-weight: 600;
        }
        .chart-container { height: 280px; position: relative; }
        .chart-container.tall { height: 350px; }
        
        .gauge-container {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; height: 260px;
        }
        .gauge-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5rem; font-weight: 800;
            color: var(--polaris-gold); margin-top: 1rem;
        }
        .gauge-label { color: var(--text-muted); margin-top: 0.25rem; }
        .gauge-target { color: var(--text-secondary); margin-top: 0.5rem; }
        .gauge-target span { color: var(--polaris-gold); font-weight: 600; }
        
        .stats-mini-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;
        }
        .stat-mini {
            background: linear-gradient(145deg, var(--bg-card), rgba(8,18,8,0.95));
            border: 1px solid var(--border-color);
            border-radius: 12px; padding: 1.25rem; text-align: center;
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.35),
                0 4px 10px rgba(0,0,0,0.25),
                inset 0 1px 0 rgba(255,255,255,0.05);
            transition: transform 0.3s;
        }
        .stat-mini:hover {
            transform: translateY(-2px) scale(1.02);
        }
        .stat-mini-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .stat-mini-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.6rem; font-weight: 700; color: var(--polaris-gold);
        }
        .stat-mini-label { font-size: 0.9rem; color: var(--text-muted); margin-top: 0.25rem; font-weight: 500; }
        
        .progress-item { margin-bottom: 1.5rem; }
        .progress-header { display: flex; justify-content: space-between; margin-bottom: 0.75rem; }
        .progress-label { font-size: 1.1rem; font-weight: 500; }
        .progress-value { font-family: 'Montserrat', sans-serif; color: var(--polaris-gold); font-weight: 700; font-size: 1.2rem; }
        .progress-bar {
            height: 10px; background: var(--bg-dark);
            border-radius: 5px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; border-radius: 5px;
            background: linear-gradient(90deg, var(--polaris-green), var(--polaris-gold));
            transition: width 1s ease-out;
        }
        
        .insights-list { display: flex; flex-direction: column; gap: 1rem; }
        .insight-item {
            display: flex; align-items: flex-start; gap: 1rem;
            padding: 1rem 1.25rem; background: rgba(0,0,0,0.2);
            border-radius: 10px; border-left: 4px solid var(--polaris-green);
        }
        .insight-item.success { border-left-color: var(--success); }
        .insight-item.warning { border-left-color: var(--warning); }
        .insight-item.danger { border-left-color: var(--danger); }
        .insight-icon { font-size: 1.5rem; }
        .insight-title { font-weight: 700; font-size: 1.1rem; }
        .insight-desc { font-size: 1rem; color: var(--text-secondary); margin-top: 0.25rem; }
        
        .data-table-container {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 16px; overflow: hidden;
        }
        .table-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 1.5rem; border-bottom: 1px solid var(--border-color);
        }
        .table-search {
            background: var(--bg-dark); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 0.6rem 1rem;
            color: var(--text-primary); width: 220px; font-size: 1rem;
        }
        .data-table { width: 100%; border-collapse: collapse; font-size: 1.05rem; }
        .data-table th {
            text-align: left; padding: 1.25rem 1rem;
            font-size: 1rem; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px;
            background: var(--bg-dark); border-bottom: 1px solid var(--border-color);
            font-weight: 700;
        }
        .data-table td { padding: 1.25rem 1rem; border-bottom: 1px solid var(--border-color); font-size: 1.05rem; }
        .data-table tr:hover td { background: rgba(46, 125, 50, 0.1); }
        .rank-badge {
            width: 36px; height: 36px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 1rem;
        }
        .rank-badge.gold { background: var(--gold-plan); color: var(--bg-dark); }
        .rank-badge.silver { background: var(--silver-plan); color: var(--bg-dark); }
        .rank-badge.bronze { background: #CD7F32; color: white; }
        .currency { font-family: 'Montserrat', sans-serif; color: var(--polaris-gold); font-weight: 600; font-size: 1.1rem; }
        
        .footer {
            text-align: center; padding: 2rem;
            border-top: 1px solid var(--border-color); margin-top: 2rem;
            color: var(--text-muted); font-size: 0.85rem;
        }
        
        @media (max-width: 1200px) {
            .kpi-grid { grid-template-columns: repeat(3, 1fr); }
            .chart-grid, .chart-grid.three { grid-template-columns: 1fr; }
            .chart-card.wide, .chart-card.full { grid-column: span 1; }
        }
        @media (max-width: 768px) {
            .kpi-grid, .comparison-grid, .stats-mini-grid { grid-template-columns: 1fr; }
            .header-content { flex-direction: column; gap: 1rem; }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <div class="loading-screen" id="loadingScreen">
        <div class="loader-ring"></div>
        <div style="color: var(--text-secondary); letter-spacing: 2px;">LOADING DASHBOARD</div>
    </div>
    
    <div class="login-modal" id="loginModal">
        <div class="login-box">
            <h2 class="login-title">Client Portal</h2>
            <p class="login-subtitle">Sign in to access your analytics</p>
            <input type="text" class="login-input" id="loginUsername" placeholder="Username">
            <input type="password" class="login-input" id="loginPassword" placeholder="Password">
            <button class="login-btn" onclick="handleLogin()">Sign In</button>
            <p class="login-error" id="loginError"></p>
        </div>
    </div>
    
    <header class="header" id="mainHeader" style="display:none">
        <div class="header-content">
            <div class="logo-section">
                <div class="polaris-star">‚ú¶</div>
                <span class="polaris-text">POLARIS</span>
                <span class="portal-badge">CLIENT PORTAL</span>
            </div>
            <div class="user-section">
                <!-- Company Selector -->
                <div class="company-selector" id="companySelector" style="display:none">
                    <select id="companyDropdown" onchange="changeCompany(this.value)">
                        <option value="">Select Company</option>
                    </select>
                </div>
                <button onclick="openReportBuilder()" class="reports-btn">
                    <span>üìä</span> Reports
                </button>
                <a href="#" id="activeMembersBtn" class="active-members-btn" onclick="openActiveMembers()">
                    <span>üë•</span> Active Members
                </a>
                <div class="client-badge">
                    <div class="client-avatar" id="clientAvatar">U</div>
                    <span id="clientName">User</span>
                </div>
                <button class="logout-btn" onclick="handleLogout()">Sign Out</button>
            </div>
        </div>
    </header>
    
    <main class="main-content" id="mainContent" style="display:none">
        <div class="page-header">
            <h1 class="page-title">üìä Healthcare Analytics Dashboard</h1>
            <p class="page-subtitle">
                <span id="pageCompanyName" style="color: var(--polaris-gold); font-weight: 600;"></span>
                <span class="period-badge" id="periodBadge">Q3 2025</span>
            </p>
        </div>
        
        <section class="section">
            <div class="kpi-grid" style="grid-template-columns: 2fr 1fr 1fr 1fr; gap: 1.5rem;">
                <div class="kpi-card" style="background: linear-gradient(135deg, #0D1F0D 0%, #1a3a1a 50%, #0D1F0D 100%); border: 3px solid #4CAF50; box-shadow: 0 0 40px rgba(76,175,80,0.3), inset 0 1px 0 rgba(255,255,255,0.1); position:relative; overflow:hidden;">
                    <div style="position:absolute;top:-20px;right:-20px;width:100px;height:100px;background:radial-gradient(circle, rgba(76,175,80,0.15) 0%, transparent 70%);"></div>
                    <div class="kpi-icon" style="font-size:2.5rem">üí∞</div>
                    <div class="kpi-label" style="color: #81C784; font-size:1.2rem; font-weight:700; text-transform:uppercase; letter-spacing:2px;">Cost per Member</div>
                    <div class="kpi-value" id="kpiCostPerMember" style="font-size: 4.5rem; color: #4CAF50; text-shadow: 0 0 40px rgba(76,175,80,0.7), 0 4px 20px rgba(0,0,0,0.4); font-weight:800; letter-spacing:-3px; line-height:1;">$0.00</div>
                    <div class="kpi-trend" style="background:rgba(76,175,80,0.25);color:#A5D6A7;font-weight:600;font-size:0.95rem;padding:0.5rem 1rem;border-radius:20px;margin-top:0.5rem">Per Member / Period</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üë•</div>
                    <div class="kpi-label">Total Members</div>
                    <div class="kpi-value" id="kpiMembers">-</div>
                    <div class="kpi-trend" id="kpiMembersTrend">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üìã</div>
                    <div class="kpi-label">Total Claims</div>
                    <div class="kpi-value" id="kpiClaims">-</div>
                    <div class="kpi-trend" id="kpiClaimsTrend">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üéØ</div>
                    <div class="kpi-label">Utilization Rate</div>
                    <div class="kpi-value" id="kpiUtilization">-</div>
                    <div class="kpi-trend" style="background:rgba(255,255,255,0.1);color:var(--text-secondary)">Target: 15%</div>
                </div>
            </div>
        </section>
        
        <!-- INPATIENT vs OUTPATIENT Section - TOP PRIORITY -->
        <section class="section">
            <h2 class="section-title">üè• Inpatient vs Outpatient Analysis</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üìä Cases Distribution</h3>
                        <span class="chart-badge">Current Period</span>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem; grid-template-columns: repeat(3, 1fr);">
                        <div class="stat-mini" style="border-left:4px solid #e74c3c">
                            <div class="stat-mini-icon">üè®</div>
                            <div class="stat-mini-value" id="inpatientCases">-</div>
                            <div class="stat-mini-label">Inpatient Cases</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #3498db">
                            <div class="stat-mini-icon">üèÉ</div>
                            <div class="stat-mini-value" id="outpatientCases">-</div>
                            <div class="stat-mini-label">Outpatient Cases</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37">
                            <div class="stat-mini-icon">üéÅ</div>
                            <div class="stat-mini-value" id="exGratiaCases">-</div>
                            <div class="stat-mini-label">Ex Gratia Cases</div>
                        </div>
                    </div>
                    <div class="chart-container short"><canvas id="inOutPieChart"></canvas></div>
                </div>
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title">üìà Inpatient vs Outpatient Trend</h3>
                    </div>
                    <div class="chart-container"><canvas id="inOutTrendChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- PRINCIPAL vs DEPENDENT Section -->
        <section class="section">
            <h2 class="section-title">üë• Principal vs Dependent Analysis</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üë§ Member Type Distribution</h3>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem">
                        <div class="stat-mini" style="border-left:4px solid #2E7D32">
                            <div class="stat-mini-icon">‚öì</div>
                            <div class="stat-mini-value" id="principalCount">-</div>
                            <div class="stat-mini-label">Seafarers (Principal)</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37">
                            <div class="stat-mini-icon">üë®‚Äçüë©‚Äçüëß</div>
                            <div class="stat-mini-value" id="dependentCount">-</div>
                            <div class="stat-mini-label">Dependents</div>
                        </div>
                    </div>
                    <div class="chart-container short"><canvas id="memberTypePieChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üìä Claims by Member Type</h3>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem">
                        <div class="stat-mini" style="border-left:4px solid #2E7D32">
                            <div class="stat-mini-icon">‚öì</div>
                            <div class="stat-mini-value" id="principalClaims">-</div>
                            <div class="stat-mini-label">Seafarer Claims</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37">
                            <div class="stat-mini-icon">üë®‚Äçüë©‚Äçüëß</div>
                            <div class="stat-mini-value" id="dependentClaims">-</div>
                            <div class="stat-mini-label">Dependent Claims</div>
                        </div>
                    </div>
                    <div class="chart-container short"><canvas id="memberTypeClaimsChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- MEMBER MOVEMENT Section -->
        <section class="section">
            <h2 class="section-title">üìà Member Movement</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üìä Movement Summary</h3>
                        <span class="chart-badge">Current Period</span>
                    </div>
                    <div class="stats-mini-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom:1rem;">
                        <div class="stat-mini" style="border-left:4px solid #4CAF50">
                            <div style="font-size:2.2rem;color:#4CAF50;font-family:Montserrat;font-weight:800" id="newEnrollments">+0</div>
                            <div style="color:var(--text-muted);font-size:0.9rem;margin-top:0.25rem">New Members</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #e74c3c">
                            <div style="font-size:2.2rem;color:#e74c3c;font-family:Montserrat;font-weight:800" id="cancellations">-0</div>
                            <div style="color:var(--text-muted);font-size:0.9rem;margin-top:0.25rem">Cancelled</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37">
                            <div style="font-size:2.2rem;color:#D4AF37;font-family:Montserrat;font-weight:800" id="netChange">0</div>
                            <div style="color:var(--text-muted);font-size:0.9rem;margin-top:0.25rem">Net Growth</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="movementCompareChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üìà Movement Trend</h3>
                        <span class="chart-badge">Quarterly</span>
                    </div>
                    <div class="chart-container"><canvas id="movementTrendChart"></canvas></div>
                </div>
            </div>
            <div class="chart-grid" style="grid-template-columns: 1fr; margin-top: 1.25rem;">
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title">üìâ Enrollment vs Cancellation Trend</h3>
                        <span class="chart-badge">All Periods</span>
                    </div>
                    <div class="chart-container" style="height: 300px;"><canvas id="movementFullTrendChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- CLAIMS BY CATEGORY Section -->
        <section class="section">
            <h2 class="section-title">üìä Claims by Category</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üè• Category Distribution</h3>
                        <span class="chart-badge">Current Period</span>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem; grid-template-columns: repeat(6, 1fr);">
                        <div class="stat-mini" style="border-left:4px solid #4CAF50; padding:0.75rem;">
                            <div style="font-size:1.4rem;font-weight:700;color:#4CAF50" id="catMedical">-</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Medical</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #2196F3; padding:0.75rem;">
                            <div style="font-size:1.4rem;font-weight:700;color:#2196F3" id="catDental">-</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Dental</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #E91E63; padding:0.75rem;">
                            <div style="font-size:1.4rem;font-weight:700;color:#E91E63" id="catMaternity">-</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Maternity</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #FF9800; padding:0.75rem;">
                            <div style="font-size:1.4rem;font-weight:700;color:#FF9800" id="catOptical">-</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Optical</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37; padding:0.75rem;">
                            <div style="font-size:1.4rem;font-weight:700;color:#D4AF37" id="catLab">-</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Laboratory</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #607D8B; padding:0.75rem;">
                            <div style="font-size:1.4rem;font-weight:700;color:#607D8B" id="catOther">-</div>
                            <div style="font-size:0.85rem;color:var(--text-muted)">Other</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="categoryPieChart"></canvas></div>
                </div>
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title">üìà Category Trend</h3>
                    </div>
                    <div class="chart-container"><canvas id="categoryTrendChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- YEAR-OVER-YEAR COMPARISON Section -->
        <section class="section">
            <h2 class="section-title">üìà Year-over-Year Comparison</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üìä Annual Claims Comparison</h3>
                    </div>
                    <div class="stats-mini-grid" style="margin-bottom:1rem;">
                        <div class="stat-mini" style="border-left:4px solid #D4AF37;">
                            <div style="font-size:0.9rem;color:var(--text-muted)">2025 YTD</div>
                            <div style="font-size:1.6rem;font-weight:700;color:#D4AF37" id="yoyClaims2025">-</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #7a8f7a;">
                            <div style="font-size:0.9rem;color:var(--text-muted)">2024</div>
                            <div style="font-size:1.6rem;font-weight:700;color:#7a8f7a" id="yoyClaims2024">-</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="yoyClaimsChart"></canvas></div>
                </div>
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title">üìà Monthly YoY Trend</h3>
                        <span class="chart-badge">2025 vs 2024</span>
                    </div>
                    <div class="yoy-summary" style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:1rem;">
                        <div style="text-align:center;padding:1rem;background:rgba(76,175,80,0.1);border-radius:10px;">
                            <div style="font-size:0.95rem;color:var(--text-muted)">Claims Change</div>
                            <div style="font-size:1.8rem;font-weight:700;color:#4CAF50" id="yoyClaimsChange">+12%</div>
                        </div>
                        <div style="text-align:center;padding:1rem;background:rgba(52,152,219,0.1);border-radius:10px;">
                            <div style="font-size:0.95rem;color:var(--text-muted)">Member Growth</div>
                            <div style="font-size:1.8rem;font-weight:700;color:#3498db" id="yoyMemberChange">+15%</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="yoyTrendChart"></canvas></div>
                </div>
            </div>
        </section>

        <!-- TOP HOSPITALS/PROVIDERS Section -->
        <section class="section">
            <h2 class="section-title">üè• Top Hospitals & Providers</h2>
            <div class="chart-grid">
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title">üèÜ Top 10 by Claims</h3>
                        <span class="chart-badge">Current Period</span>
                    </div>
                    <div class="chart-container tall"><canvas id="topHospitalsChart"></canvas></div>
                </div>
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title">üìã Hospital Details</h3>
                    </div>
                    <div style="overflow-x:auto;">
                        <table class="data-table" id="hospitalsTable">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Hospital/Provider</th>
                                    <th>Claims</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody id="hospitalsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- GEOGRAPHIC DISTRIBUTION Section -->
        <section class="section">
            <h2 class="section-title">üåç Geographic Distribution</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">üìç Claims by Region</h3>
                        <span class="chart-badge">Philippines</span>
                    </div>
                    <div class="chart-container"><canvas id="geoRegionChart"></canvas></div>
                </div>
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title">üèôÔ∏è Top Cities by Claims</h3>
                    </div>
                    <div class="stats-mini-grid" style="grid-template-columns: repeat(5, 1fr); margin-bottom:1rem;">
                        <div class="stat-mini" style="border-left:4px solid #4CAF50;">
                            <div style="font-size:1.8rem;font-weight:700;color:#4CAF50" id="geoManila">-</div>
                            <div style="font-size:0.9rem;color:var(--text-muted)">Metro Manila</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #2196F3;">
                            <div style="font-size:1.8rem;font-weight:700;color:#2196F3" id="geoCebu">-</div>
                            <div style="font-size:0.9rem;color:var(--text-muted)">Cebu</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #FF9800;">
                            <div style="font-size:1.8rem;font-weight:700;color:#FF9800" id="geoDavao">-</div>
                            <div style="font-size:0.9rem;color:var(--text-muted)">Davao</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #D4AF37;">
                            <div style="font-size:1.8rem;font-weight:700;color:#D4AF37" id="geoIloilo">-</div>
                            <div style="font-size:0.9rem;color:var(--text-muted)">Iloilo</div>
                        </div>
                        <div class="stat-mini" style="border-left:4px solid #607D8B;">
                            <div style="font-size:1.8rem;font-weight:700;color:#607D8B" id="geoOther">-</div>
                            <div style="font-size:0.9rem;color:var(--text-muted)">Other</div>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="geoCitiesChart"></canvas></div>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="comparison-banner">
                <div class="comparison-header">
                    <h2 class="section-title" style="margin:0">üìä Period Comparison</h2>
                    <span class="period-badge" id="cmpPeriodLabel">Q3 vs Q2 2025</span>
                </div>
                <div class="comparison-grid">
                    <div class="cmp-card">
                        <div class="cmp-label">Total Claims</div>
                        <div class="cmp-values">
                            <span class="cmp-current" id="cmpClaims">-</span>
                            <span class="cmp-previous" id="cmpClaimsPrev">-</span>
                        </div>
                        <span class="cmp-change" id="cmpClaimsChange">-</span>
                    </div>
                    <div class="cmp-card">
                        <div class="cmp-label">Total Members</div>
                        <div class="cmp-values">
                            <span class="cmp-current" id="cmpMembers">-</span>
                            <span class="cmp-previous" id="cmpMembersPrev">-</span>
                        </div>
                        <span class="cmp-change" id="cmpMembersChange">-</span>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="section">
            <h2 class="section-title">üìã Claims Analysis</h2>
            <div class="chart-grid three">
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">üìä Claims by Period</h3></div>
                    <div class="chart-container"><canvas id="claimsPeriodChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">üè• Claims per 1000</h3></div>
                    <div class="chart-container"><canvas id="claims1000Chart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">üìà Claims Trend</h3></div>
                    <div class="chart-container"><canvas id="claimsTrendChart"></canvas></div>
                </div>
            </div>
        </section>
        
        <section class="section">
            <h2 class="section-title">üèÜ Plan Performance</h2>
            <div class="stats-mini-grid" style="margin-bottom:1.5rem">
                <div class="stat-mini">
                    <div class="stat-mini-icon">ü•á</div>
                    <div class="stat-mini-value" id="goldMembers">60%</div>
                    <div class="stat-mini-label">Gold Members</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon">üíé</div>
                    <div class="stat-mini-value" id="platMembers">25%</div>
                    <div class="stat-mini-label">Platinum</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon">ü•à</div>
                    <div class="stat-mini-value" id="silverMembers">15%</div>
                    <div class="stat-mini-label">Silver</div>
                </div>
                <div class="stat-mini">
                    <div class="stat-mini-icon">üìä</div>
                    <div class="stat-mini-value" id="totalActive">-</div>
                    <div class="stat-mini-label">Total Active</div>
                </div>
            </div>
            <div class="chart-grid">
                <div class="chart-card wide">
                    <div class="chart-header">
                        <h3 class="chart-title">üìä Member Distribution by Plan</h3>
                        <span class="chart-badge">Current Period</span>
                    </div>
                    <div class="chart-container"><canvas id="planPieChart"></canvas></div>
                </div>
            </div>
        </section>
        
        <section class="section">
            <h2 class="section-title">üìà Utilization Metrics</h2>
            <div class="chart-grid three">
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">üìä Utilization Trend</h3></div>
                    <div class="chart-container"><canvas id="utilizationChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">üè• Key Metrics</h3></div>
                    <div style="padding:1rem 0">
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-label">Utilization Rate</span>
                                <span class="progress-value" id="utilValue">0%</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" id="utilBar" style="width:0%"></div></div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-label">Claims Ratio</span>
                                <span class="progress-value" id="claimsRatioValue">30%</span>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" id="claimsRatioBar" style="width:30%"></div></div>
                        </div>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">üí° AI Insights</h3></div>
                    <div class="insights-list" id="insightsList"></div>
                </div>
            </div>
        </section>
        
        <section class="section">
            <div class="data-table-container">
                <div class="table-header">
                    <h3 class="section-title" style="margin:0">üìÖ Historical Data</h3>
                    <input type="text" class="table-search" placeholder="Search..." id="tableSearch">
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th><th>Period</th><th>Members</th><th>Claims</th><th>Util %</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable"></tbody>
                </table>
            </div>
        </section>
    </main>
    
    <!-- Report Builder Modal -->
    <div class="report-builder-modal hidden" id="reportBuilderModal">
        <div class="report-builder-box">
            <div class="rb-header" style="position:relative">
                <h2>üìä Report Builder</h2>
                <p>ŒîŒ∑ŒºŒπŒøœÖœÅŒ≥ŒÆœÉœÑŒµ œÄœÅŒøœÉŒ±œÅŒºŒøœÉŒºŒ≠ŒΩŒµœÇ Œ±ŒΩŒ±œÜŒøœÅŒ≠œÇ</p>
                <button class="rb-close" onclick="closeReportBuilder()">‚úï</button>
            </div>
            
            <div class="rb-content">
                <!-- Period Selection -->
                <div class="rb-section">
                    <div class="rb-section-title">üìÖ ŒßœÅŒøŒΩŒπŒ∫ŒÆ Œ†ŒµœÅŒØŒøŒ¥ŒøœÇ</div>
                    <div class="rb-period-grid">
                        <div class="rb-select-group">
                            <label>ŒëœÄœå</label>
                            <select class="rb-select" id="rbFromPeriod">
                                <option value="">ŒïœÄŒπŒªŒ≠ŒæœÑŒµ œÄŒµœÅŒØŒøŒ¥Œø</option>
                                <option value="2025-Q1">Q1 2025</option>
                                <option value="2025-Q2">Q2 2025</option>
                                <option value="2025-Q3" selected>Q3 2025</option>
                                <option value="2025-Q4">Q4 2025</option>
                            </select>
                        </div>
                        <div class="rb-select-group">
                            <label>ŒàœâœÇ</label>
                            <select class="rb-select" id="rbToPeriod">
                                <option value="">ŒïœÄŒπŒªŒ≠ŒæœÑŒµ œÄŒµœÅŒØŒøŒ¥Œø</option>
                                <option value="2025-Q1">Q1 2025</option>
                                <option value="2025-Q2">Q2 2025</option>
                                <option value="2025-Q3" selected>Q3 2025</option>
                                <option value="2025-Q4">Q4 2025</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Templates -->
                <div class="rb-section">
                    <div class="rb-section-title">‚ö° ŒìœÅŒÆŒ≥ŒøœÅŒ± Œ†œÅœåœÑœÖœÄŒ±</div>
                    <div class="rb-templates">
                        <div class="rb-template-btn" onclick="selectTemplate('board')">
                            <span>üéØ</span>
                            <div>Board Meeting</div>
                        </div>
                        <div class="rb-template-btn" onclick="selectTemplate('monthly')">
                            <span>üìà</span>
                            <div>ŒúŒ∑ŒΩŒπŒ±ŒØŒ± ŒëŒΩŒ±œÉŒ∫œåœÄŒ∑œÉŒ∑</div>
                        </div>
                        <div class="rb-template-btn" onclick="selectTemplate('executive')">
                            <span>‚ö°</span>
                            <div>Executive Summary</div>
                        </div>
                        <div class="rb-template-btn" onclick="selectTemplate('full')">
                            <span>üìä</span>
                            <div>Œ†ŒªŒÆœÅŒ∑œÇ ŒëŒΩŒ±œÜŒøœÅŒ¨</div>
                        </div>
                    </div>
                </div>
                
                <!-- Report Sections -->
                <div class="rb-section">
                    <div class="rb-section-title">üìã ŒïŒΩœåœÑŒ∑œÑŒµœÇ ŒëŒΩŒ±œÜŒøœÅŒ¨œÇ</div>
                    <div class="rb-sections-list">
                        <label class="rb-section-item selected">
                            <input type="checkbox" id="sec_executive" checked>
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title">Executive Summary</div>
                                <div class="rb-section-item-desc">Œ£œÖŒΩŒøœÄœÑŒπŒ∫ŒÆ œÄŒ±œÅŒøœÖœÉŒØŒ±œÉŒ∑ KPIs</div>
                            </div>
                            <span class="rb-section-item-badge">1 œÉŒµŒªŒØŒ¥Œ±</span>
                        </label>
                        <label class="rb-section-item selected">
                            <input type="checkbox" id="sec_inout" checked>
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title">üè• Inpatient vs Outpatient</div>
                                <div class="rb-section-item-desc">ŒëŒΩŒ¨ŒªœÖœÉŒ∑ œÄŒµœÅŒπœÉœÑŒ±œÑŒπŒ∫œéŒΩ Œ∫Œ±Œπ Œ∫œåœÉœÑŒøœÖœÇ</div>
                            </div>
                            <span class="rb-section-item-badge">1 œÉŒµŒªŒØŒ¥Œ±</span>
                        </label>
                        <label class="rb-section-item selected">
                            <input type="checkbox" id="sec_claims" checked>
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title">üìã Claims Analysis</div>
                                <div class="rb-section-item-desc">ŒõŒµœÄœÑŒøŒºŒµœÅŒÆœÇ Œ±ŒΩŒ¨ŒªœÖœÉŒ∑ Œ±ŒæŒπœéœÉŒµœâŒΩ</div>
                            </div>
                            <span class="rb-section-item-badge">1 œÉŒµŒªŒØŒ¥Œ±</span>
                        </label>
                        <label class="rb-section-item">
                            <input type="checkbox" id="sec_members">
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title">üë• Principal vs Dependent</div>
                                <div class="rb-section-item-desc">ŒëŒΩŒ¨ŒªœÖœÉŒ∑ ŒΩŒ±œÖœÑŒπŒ∫œéŒΩ Œ∫Œ±Œπ ŒµŒæŒ±œÅœÑœâŒºŒ≠ŒΩœâŒΩ</div>
                            </div>
                            <span class="rb-section-item-badge">1 œÉŒµŒªŒØŒ¥Œ±</span>
                        </label>
                        <label class="rb-section-item">
                            <input type="checkbox" id="sec_movement">
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title">üìà Member Movement</div>
                                <div class="rb-section-item-desc">ŒïŒ≥Œ≥œÅŒ±œÜŒ≠œÇ, Œ±Œ∫œÖœÅœéœÉŒµŒπœÇ, ŒºŒµœÑŒ±Œ≤ŒøŒªŒ≠œÇ</div>
                            </div>
                            <span class="rb-section-item-badge">1 œÉŒµŒªŒØŒ¥Œ±</span>
                        </label>
                        <label class="rb-section-item">
                            <input type="checkbox" id="sec_plans">
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title">üèÜ Plan Performance</div>
                                <div class="rb-section-item-desc">ŒëœÄœåŒ¥ŒøœÉŒ∑ Œ±ŒΩŒ¨ œÑœçœÄŒø œÄŒªŒ¨ŒΩŒøœÖ</div>
                            </div>
                            <span class="rb-section-item-badge">1 œÉŒµŒªŒØŒ¥Œ±</span>
                        </label>
                        <label class="rb-section-item">
                            <input type="checkbox" id="sec_history">
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title">üìÖ Historical Data</div>
                                <div class="rb-section-item-desc">ŒôœÉœÑŒøœÅŒπŒ∫Œ¨ Œ¥ŒµŒ¥ŒøŒºŒ≠ŒΩŒ± œÉŒµ œÄŒØŒΩŒ±Œ∫Œ±</div>
                            </div>
                            <span class="rb-section-item-badge">2-3 œÉŒµŒªŒØŒ¥ŒµœÇ</span>
                        </label>
                        <label class="rb-section-item">
                            <input type="checkbox" id="sec_trends">
                            <div class="rb-section-item-content">
                                <div class="rb-section-item-title">üìä Trends & Charts</div>
                                <div class="rb-section-item-desc">ŒìœÅŒ±œÜŒÆŒºŒ±œÑŒ± Œ∫Œ±Œπ œÑŒ¨œÉŒµŒπœÇ</div>
                            </div>
                            <span class="rb-section-item-badge">2 œÉŒµŒªŒØŒ¥ŒµœÇ</span>
                        </label>
                    </div>
                </div>
                
                <!-- Export Format -->
                <div class="rb-section">
                    <div class="rb-section-title">üé® ŒúŒøœÅœÜŒÆ ŒïŒæŒ±Œ≥œâŒ≥ŒÆœÇ</div>
                    <div class="rb-formats">
                        <div class="rb-format-btn selected" onclick="selectFormat('pdf')" id="formatPdf">
                            <span>üìÑ</span>
                            <div>PDF</div>
                        </div>
                        <div class="rb-format-btn" onclick="selectFormat('excel')" id="formatExcel">
                            <span>üìä</span>
                            <div>Excel</div>
                        </div>
                        <div class="rb-format-btn" onclick="selectFormat('both')" id="formatBoth">
                            <span>üì¶</span>
                            <div>PDF + Excel</div>
                        </div>
                    </div>
                </div>
                
                <!-- Info Box -->
                <div class="rb-info-box">
                    <span>üí°</span>
                    <div>
                        <strong>Œ£œÖŒºŒ≤ŒøœÖŒªŒÆ:</strong> ŒïœÄŒπŒªŒ≠ŒæœÑŒµ ŒºœåŒΩŒø œÑŒπœÇ ŒµŒΩœåœÑŒ∑œÑŒµœÇ œÄŒøœÖ œáœÅŒµŒπŒ¨Œ∂ŒµœÉœÑŒµ Œ≥ŒπŒ± œÄŒπŒø Œ≥œÅŒÆŒ≥ŒøœÅŒ∑ Œ¥Œ∑ŒºŒπŒøœÖœÅŒ≥ŒØŒ± Œ±ŒΩŒ±œÜŒøœÅŒ¨œÇ.
                    </div>
                </div>
            </div>
            
            <div class="rb-footer">
                <button class="rb-btn rb-btn-cancel" onclick="closeReportBuilder()">ŒëŒ∫œçœÅœâœÉŒ∑</button>
                <button class="rb-btn rb-btn-preview" onclick="previewReport()">üîç Œ†œÅŒøŒµœÄŒπœÉŒ∫œåœÄŒ∑œÉŒ∑</button>
                <button class="rb-btn rb-btn-generate" onclick="generateReport()">üìÑ ŒîŒ∑ŒºŒπŒøœÖœÅŒ≥ŒØŒ± ŒëŒΩŒ±œÜŒøœÅŒ¨œÇ</button>
            </div>
        </div>
    </div>

    <!-- Report Generation Modal -->
    <div class="report-modal hidden" id="reportModal">
        <div class="report-box">
            <div style="font-size:3rem;margin-bottom:1rem">üìÑ</div>
            <h3 style="font-size:1.25rem;font-weight:700;margin-bottom:0.5rem" id="reportTitle">Generating Report...</h3>
            <p style="color:var(--text-secondary);margin-bottom:1rem" id="reportStatus">Preparing your personalized report</p>
            <div class="report-progress">
                <div class="report-progress-bar" id="reportProgressBar" style="width:0%"></div>
            </div>
            <p style="color:var(--text-muted);font-size:0.85rem" id="reportStep">Initializing...</p>
        </div>
    </div>
    
    <footer class="footer" id="mainFooter" style="display:none">
        <p>¬© 2025 Polaris Financial Services. All rights reserved.</p>
        <p style="margin-top:0.5rem">Last updated: <span id="lastUpdated">-</span></p>
    </footer>
    
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxBnEkHdzvxby_W1RuLpkFtlQ6GScMyF8wqap9v1BhvuncSx0SxAsAG9F11_IYvDYX6/exec';
        let currentUser = null, charts = {};
        let companiesList = [];  // List of parent + subsidiaries
        let selectedCompanyId = null;  // Currently selected company
        
        // Safe getContext helper - returns null if element doesn't exist
        function safeGetContext(id) {
            const canvas = document.getElementById(id);
            return canvas ? canvas.getContext('2d') : null;
        }
        
        // Global Chart.js defaults for larger, more readable fonts
        Chart.defaults.font.size = 14;
        Chart.defaults.font.family = "'Open Sans', sans-serif";
        Chart.defaults.color = '#b8c9b8';
        Chart.defaults.plugins.legend.labels.font = { size: 14, weight: 'bold' };
        Chart.defaults.plugins.legend.labels.padding = 25;
        Chart.defaults.plugins.legend.labels.boxWidth = 18;
        Chart.defaults.plugins.legend.labels.boxHeight = 18;
        Chart.defaults.plugins.tooltip.titleFont = { size: 14, weight: 'bold' };
        Chart.defaults.plugins.tooltip.bodyFont = { size: 13 };
        Chart.defaults.scale.ticks.font = { size: 13, weight: '600' };
        
        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('polaris_user');
            if (saved) { currentUser = JSON.parse(saved); showDashboard(); }
            else document.getElementById('loadingScreen').classList.add('hidden');
        });
        
        async function handleLogin() {
            const u = document.getElementById('loginUsername').value;
            const p = document.getElementById('loginPassword').value;
            if (!u) { document.getElementById('loginError').textContent = 'Enter username'; return; }
            
            try {
                // Authenticate user and get their companies
                const response = await fetch(`${API_URL}?action=authenticateClient&username=${encodeURIComponent(u)}&password=${encodeURIComponent(p)}`);
                const data = await response.json();
                
                if (data.success && data.user) {
                    currentUser = data.user;
                    companiesList = data.companies || [{ client_id: data.user.client_id, company_name: data.user.company_name || 'My Company', is_parent: true }];
                    selectedCompanyId = currentUser.client_id;
                    localStorage.setItem('polaris_user', JSON.stringify(currentUser));
                    localStorage.setItem('polaris_companies', JSON.stringify(companiesList));
                    showDashboard();
                } else {
                    document.getElementById('loginError').textContent = data.message || 'Invalid credentials';
                }
            } catch (e) {
                console.error('Login error:', e);
                // Fallback for testing
                currentUser = { username: u, client_id: u };
                localStorage.setItem('polaris_user', JSON.stringify(currentUser));
                showDashboard();
            }
        }
        
        function handleLogout() { 
            localStorage.removeItem('polaris_user'); 
            localStorage.removeItem('polaris_companies');
            location.reload(); 
        }
        
        // Change company and refilter data (no new API call needed)
        function changeCompany(clientId) {
            if (!clientId || clientId === selectedCompanyId) return;
            selectedCompanyId = clientId;
            
            // Update page title with company name
            const company = companiesList.find(c => c.client_id === clientId);
            if (company) {
                const displayName = company.is_parent 
                    ? `${company.company_name} (All Companies)` 
                    : company.company_name;
                document.getElementById('pageCompanyName').textContent = displayName;
            }
            
            // Refilter existing data (no need to refetch)
            if (rawApiData) {
                updateDashboard(rawApiData, clientId);
            }
        }
        
        // Populate company dropdown
        function populateCompanyDropdown() {
            const dropdown = document.getElementById('companyDropdown');
            const selector = document.getElementById('companySelector');
            
            if (companiesList.length <= 1) {
                selector.style.display = 'none';
                return;
            }
            
            selector.style.display = 'block';
            dropdown.innerHTML = '';
            
            companiesList.forEach(company => {
                const option = document.createElement('option');
                option.value = company.client_id;
                option.textContent = company.is_parent ? `üè¢ ${company.company_name} (Parent)` : `  ‚îî‚îÄ ${company.company_name}`;
                if (company.client_id === selectedCompanyId) {
                    option.selected = true;
                }
                dropdown.appendChild(option);
            });
        }
        
        function openActiveMembers() {
            // Get client_id from selected company
            const clientId = selectedCompanyId || currentUser.client_id || currentUser.username || '';
            const url = 'https://apostolos-bizou.github.io/polaris-member-tracker/?client=' + encodeURIComponent(clientId);
            window.open(url, '_blank');
        }
        
        // Report Builder State
        let reportConfig = {
            fromPeriod: '2025-Q3',
            toPeriod: '2025-Q3',
            format: 'pdf',
            sections: {
                executive: true,
                inout: true,
                claims: true,
                members: false,
                movement: false,
                plans: false,
                history: false,
                trends: false
            }
        };
        
        function openReportBuilder() {
            document.getElementById('reportBuilderModal').classList.remove('hidden');
            updateSectionStyles();
        }
        
        function closeReportBuilder() {
            document.getElementById('reportBuilderModal').classList.add('hidden');
        }
        
        function selectTemplate(template) {
            // Remove active from all
            document.querySelectorAll('.rb-template-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Set sections based on template
            const templates = {
                board: { executive: true, inout: true, claims: true, members: false, movement: false, plans: false, history: false, trends: false },
                monthly: { executive: true, inout: true, claims: true, members: true, movement: true, plans: false, history: false, trends: false },
                executive: { executive: true, inout: false, claims: false, members: false, movement: false, plans: false, history: false, trends: false },
                full: { executive: true, inout: true, claims: true, members: true, movement: true, plans: true, history: true, trends: true }
            };
            
            reportConfig.sections = { ...templates[template] };
            
            // Update checkboxes
            Object.keys(reportConfig.sections).forEach(key => {
                const checkbox = document.getElementById('sec_' + key);
                if (checkbox) checkbox.checked = reportConfig.sections[key];
            });
            
            updateSectionStyles();
        }
        
        function selectFormat(format) {
            reportConfig.format = format;
            document.querySelectorAll('.rb-format-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('format' + format.charAt(0).toUpperCase() + format.slice(1)).classList.add('selected');
        }
        
        function updateSectionStyles() {
            document.querySelectorAll('.rb-section-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }
        
        // Add event listeners to checkboxes
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.rb-section-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const key = checkbox.id.replace('sec_', '');
                    reportConfig.sections[key] = checkbox.checked;
                    updateSectionStyles();
                });
            });
        });
        
        function previewReport() {
            const selectedSections = Object.entries(reportConfig.sections).filter(([k, v]) => v).map(([k]) => k);
            const pages = selectedSections.length + 1; // +1 for cover
            alert(`üìÑ Œ†œÅŒøŒµœÄŒπœÉŒ∫œåœÄŒ∑œÉŒ∑ ŒëŒΩŒ±œÜŒøœÅŒ¨œÇ\n\n` +
                  `Œ†ŒµœÅŒØŒøŒ¥ŒøœÇ: ${reportConfig.fromPeriod} - ${reportConfig.toPeriod}\n` +
                  `ŒïŒΩœåœÑŒ∑œÑŒµœÇ: ${selectedSections.length}\n` +
                  `ŒïŒ∫œÑŒπŒºœéŒºŒµŒΩŒµœÇ œÉŒµŒªŒØŒ¥ŒµœÇ: ${pages}\n` +
                  `ŒúŒøœÅœÜŒÆ: ${reportConfig.format.toUpperCase()}`);
        }
        
        async function generateReport() {
            closeReportBuilder();
            
            // Get selected sections
            const sections = reportConfig.sections;
            
            // Call appropriate generator based on format
            if (reportConfig.format === 'pdf' || reportConfig.format === 'both') {
                await generateCustomPDF(sections);
            }
            
            if (reportConfig.format === 'excel' || reportConfig.format === 'both') {
                generateExcelReport();
            }
        }
        
        function generateExcelReport() {
            alert('üìä Excel export Œ∏Œ± œÖŒªŒøœÄŒøŒπŒ∑Œ∏ŒµŒØ œÉœçŒΩœÑŒøŒºŒ±!\n\nŒ†œÅŒøœÇ œÑŒø œÄŒ±œÅœåŒΩ Œ¥ŒπŒ±Œ∏Œ≠œÉŒπŒºŒ∑ ŒºœåŒΩŒø Œ∑ PDF ŒºŒøœÅœÜŒÆ.');
        }
        
        async function generateCustomPDF(sections) {
            const modal = document.getElementById('reportModal');
            const progressBar = document.getElementById('reportProgressBar');
            const stepText = document.getElementById('reportStep');
            const statusText = document.getElementById('reportStatus');
            const titleText = document.getElementById('reportTitle');
            
            modal.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressBar.style.background = 'linear-gradient(90deg, #B8860B, #D4AF37)';
            titleText.textContent = 'Generating Report...';
            statusText.textContent = 'Preparing your custom report';
            
            const updateProgress = (percent, step) => {
                progressBar.style.width = percent + '%';
                stepText.textContent = step;
            };
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 12;
                const contentWidth = pageWidth - (margin * 2);
                
                const clientName = currentUser.username || currentUser.client_id || 'Client';
                const periodLabel = document.getElementById('periodBadge')?.textContent || 'Q3 2025';
                const reportDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                
                // Colors
                const purple = [0, 150, 136]; // Now teal instead of purple
                const purpleLight = [77, 182, 172]; // Teal light
                const green = [27, 94, 32];
                const greenLight = [76, 175, 80];
                const gold = [212, 175, 55];
                const blue = [25, 118, 210];
                const blueLight = [66, 165, 245];
                const red = [211, 47, 47];
                const redLight = [239, 83, 80];
                const orange = [255, 152, 0];
                const teal = [0, 150, 136];
                const textDark = [33, 33, 33];
                const textMuted = [117, 117, 117];
                const bgLight = [250, 250, 252];
                
                // Helper: Draw progress bar
                const drawProgressBar = (x, y, width, height, percent, color1, color2) => {
                    doc.setFillColor(230, 230, 235);
                    doc.roundedRect(x, y, width, height, height/2, height/2, 'F');
                    const fillWidth = (percent / 100) * width;
                    if (fillWidth > 0) {
                        doc.setFillColor(...color1);
                        doc.roundedRect(x, y, Math.max(fillWidth, height), height, height/2, height/2, 'F');
                    }
                };
                
                // Helper: Draw donut chart
                const drawDonut = (cx, cy, outerR, innerR, segments) => {
                    let startAngle = -Math.PI / 2;
                    segments.forEach(seg => {
                        const endAngle = startAngle + (seg.percent / 100) * Math.PI * 2;
                        doc.setFillColor(...seg.color);
                        
                        // Draw arc segment (approximation with polygon)
                        const points = [];
                        for (let a = startAngle; a <= endAngle; a += 0.1) {
                            points.push([cx + Math.cos(a) * outerR, cy + Math.sin(a) * outerR]);
                        }
                        for (let a = endAngle; a >= startAngle; a -= 0.1) {
                            points.push([cx + Math.cos(a) * innerR, cy + Math.sin(a) * innerR]);
                        }
                        
                        if (points.length > 2) {
                            doc.setFillColor(...seg.color);
                            // Simple filled arc
                            const midAngle = (startAngle + endAngle) / 2;
                            const midR = (outerR + innerR) / 2;
                            // Draw as thick arc
                            for (let r = innerR; r <= outerR; r += 0.5) {
                                for (let a = startAngle; a <= endAngle; a += 0.02) {
                                    const px = cx + Math.cos(a) * r;
                                    const py = cy + Math.sin(a) * r;
                                    doc.circle(px, py, 0.3, 'F');
                                }
                            }
                        }
                        startAngle = endAngle;
                    });
                    // Center circle
                    doc.setFillColor(255, 255, 255);
                    doc.circle(cx, cy, innerR, 'F');
                };
                
                // Helper: Mini KPI card
                const drawMiniKPI = (x, y, w, h, icon, label, value, color) => {
                    doc.setFillColor(...bgLight);
                    doc.roundedRect(x, y, w, h, 3, 3, 'F');
                    doc.setFillColor(...color);
                    doc.roundedRect(x, y, 4, h, 2, 2, 'F');
                    
                    doc.setFontSize(7);
                    doc.setTextColor(...textMuted);
                    doc.text(label.toUpperCase(), x + 8, y + 8);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...color);
                    doc.text(value, x + 8, y + 18);
                    doc.setFont('helvetica', 'normal');
                };
                
                // Get all values (NO FINANCIAL DATA for client portal)
                const totalMembers = document.getElementById('kpiMembers')?.textContent || '8,547';
                const totalClaims = document.getElementById('kpiClaims')?.textContent || '1,234';
                const utilization = document.getElementById('kpiUtilization')?.textContent || '14.4%';
                const inpatientCases = document.getElementById('inpatientCases')?.textContent || '308';
                const outpatientCases = document.getElementById('outpatientCases')?.textContent || '926';
                const exGratiaCases = document.getElementById('exGratiaCases')?.textContent || '0';
                const principalCount = document.getElementById('principalCount')?.textContent || '3,419';
                const dependentCount = document.getElementById('dependentCount')?.textContent || '5,128';
                const newEnroll = document.getElementById('newEnrollments')?.textContent || '+684';
                const cancelled = document.getElementById('cancellations')?.textContent || '-256';
                const netChange = document.getElementById('netChange')?.textContent || '+428';
                
                let totalSections = Object.values(sections).filter(v => v).length;
                let sectionsDone = 0;
                
                // ==================== PAGE 1: COVER ====================
                updateProgress(5, 'Creating cover page...');
                await new Promise(r => setTimeout(r, 80));
                
                // Full page gradient header
                doc.setFillColor(...purple);
                doc.rect(0, 0, pageWidth, 100, 'F');
                
                // Decorative circles
                doc.setFillColor(140, 50, 180);
                doc.circle(180, 20, 40, 'F');
                doc.setFillColor(100, 20, 140);
                doc.circle(200, 80, 25, 'F');
                doc.setFillColor(160, 70, 200);
                doc.circle(20, 90, 15, 'F');
                
                // Gold accent bar
                doc.setFillColor(...gold);
                doc.rect(0, 98, pageWidth, 4, 'F');
                
                // Logo area
                doc.setFillColor(255, 255, 255);
                doc.roundedRect(margin, 15, 50, 20, 3, 3, 'F');
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...purple);
                doc.text('POLARIS', margin + 8, 27);
                
                // Main title
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(36);
                doc.setFont('helvetica', 'bold');
                doc.text('Analytics Report', margin, 60);
                
                doc.setFontSize(16);
                doc.setFont('helvetica', 'normal');
                doc.text(clientName, margin, 75);
                doc.setFontSize(12);
                doc.text(periodLabel + '  ‚Ä¢  ' + reportDate, margin, 88);
                
                // Quick stats row
                let yPos = 115;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('QUICK OVERVIEW', margin, yPos);
                
                yPos += 8;
                const quickStats = [
                    { label: 'Members', value: totalMembers, color: green },
                    { label: 'Claims', value: totalClaims, color: blue },
                    { label: 'Utilization', value: utilization, color: gold },
                    { label: 'Net Growth', value: netChange, color: purple }
                ];
                
                const statWidth = (contentWidth - 15) / 4;
                quickStats.forEach((stat, i) => {
                    const x = margin + (i * (statWidth + 5));
                    doc.setFillColor(...stat.color);
                    doc.roundedRect(x, yPos, statWidth, 28, 3, 3, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'normal');
                    doc.text(stat.label.toUpperCase(), x + 5, yPos + 9);
                    doc.setFontSize(13);
                    doc.setFont('helvetica', 'bold');
                    doc.text(stat.value, x + 5, yPos + 21);
                });
                
                // Report contents
                yPos += 45;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('REPORT CONTENTS', margin, yPos);
                
                yPos += 8;
                const sectionNames = {
                    executive: { name: 'Executive Summary', icon: 'üìä' },
                    inout: { name: 'Inpatient vs Outpatient', icon: 'üè•' },
                    claims: { name: 'Claims Analysis', icon: 'üìã' },
                    members: { name: 'Member Analysis', icon: 'üë•' },
                    movement: { name: 'Member Movement', icon: 'üìà' },
                    plans: { name: 'Plan Performance', icon: 'üèÜ' },
                    history: { name: 'Historical Data', icon: 'üìÖ' },
                    trends: { name: 'Trends', icon: 'üìä' }
                };
                
                let col = 0;
                Object.entries(sections).forEach(([key, enabled]) => {
                    if (enabled && sectionNames[key]) {
                        const x = margin + (col % 2) * (contentWidth / 2);
                        doc.setFillColor(...bgLight);
                        doc.roundedRect(x, yPos, contentWidth / 2 - 5, 12, 2, 2, 'F');
                        doc.setFillColor(...purple);
                        doc.circle(x + 6, yPos + 6, 3, 'F');
                        doc.setFontSize(9);
                        doc.setTextColor(...textDark);
                        doc.text(sectionNames[key].name, x + 14, yPos + 8);
                        col++;
                        if (col % 2 === 0) yPos += 15;
                    }
                });
                
                // Bottom decorative bar
                doc.setFillColor(...purple);
                doc.rect(0, pageHeight - 15, pageWidth, 15, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.text('Confidential  ‚Ä¢  Polaris Financial Services  ‚Ä¢  ' + reportDate, pageWidth / 2, pageHeight - 6, { align: 'center' });
                
                // ==================== PAGE 2: EXECUTIVE SUMMARY ====================
                if (sections.executive) {
                    sectionsDone++;
                    updateProgress(10 + (sectionsDone / totalSections * 70), 'Building Executive Summary...');
                    await new Promise(r => setTimeout(r, 80));
                    doc.addPage();
                    
                    // Header bar
                    doc.setFillColor(...purple);
                    doc.rect(0, 0, pageWidth, 22, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Executive Summary', margin, 14);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text(periodLabel, pageWidth - margin, 14, { align: 'right' });
                    
                    yPos = 32;
                    
                    // KPI Cards Row 1
                    const kpiW = (contentWidth - 10) / 3;
                    const kpis = [
                        { label: 'Total Members', value: totalMembers, sub: 'Active Members', color: green, subColor: greenLight },
                        { label: 'Total Claims', value: totalClaims, sub: 'This Period', color: blue, subColor: textMuted },
                        { label: 'Utilization Rate', value: utilization, sub: 'Claims per Member', color: gold, subColor: textMuted }
                    ];
                    
                    kpis.forEach((kpi, i) => {
                        const x = margin + (i * (kpiW + 5));
                        
                        // Card background
                        doc.setFillColor(...bgLight);
                        doc.roundedRect(x, yPos, kpiW, 38, 4, 4, 'F');
                        
                        // Top color bar
                        doc.setFillColor(...kpi.color);
                        doc.roundedRect(x, yPos, kpiW, 5, 4, 4, 'F');
                        doc.rect(x, yPos + 3, kpiW, 2, 'F');
                        
                        // Label
                        doc.setFontSize(7);
                        doc.setTextColor(...textMuted);
                        doc.text(kpi.label.toUpperCase(), x + 6, yPos + 14);
                        
                        // Value
                        doc.setFontSize(16);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...kpi.color);
                        doc.text(kpi.value, x + 6, yPos + 26);
                        
                        // Sub text
                        doc.setFontSize(6);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(...kpi.subColor);
                        doc.text(kpi.sub, x + 6, yPos + 34);
                    });
                    
                    yPos += 48;
                    
                    // KPI Cards Row 2
                    const kpis2 = [
                        { label: 'Inpatient Cases', value: inpatientCases, color: purple },
                        { label: 'Outpatient Cases', value: outpatientCases, color: teal },
                        { label: 'Ex Gratia Cases', value: exGratiaCases, color: orange }
                    ];
                    
                    kpis2.forEach((kpi, i) => {
                        const x = margin + (i * (kpiW + 5));
                        doc.setFillColor(...bgLight);
                        doc.roundedRect(x, yPos, kpiW, 32, 4, 4, 'F');
                        doc.setFillColor(...kpi.color);
                        doc.roundedRect(x, yPos, 4, 32, 2, 2, 'F');
                        
                        doc.setFontSize(7);
                        doc.setTextColor(...textMuted);
                        doc.text(kpi.label.toUpperCase(), x + 10, yPos + 12);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...kpi.color);
                        doc.text(kpi.value, x + 10, yPos + 25);
                    });
                    
                    yPos += 42;
                    
                    // Performance Metrics Section
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('PERFORMANCE METRICS', margin, yPos);
                    
                    yPos += 8;
                    
                    const metrics = [
                        { label: 'Claims Processing Rate', value: 94, target: 95, color: green },
                        { label: 'Member Retention', value: 92, target: 90, color: blue },
                        { label: 'Member Satisfaction', value: 88, target: 85, color: purple },
                        { label: 'Network Utilization', value: 72, target: 75, color: orange }
                    ];
                    
                    metrics.forEach((m, i) => {
                        const y = yPos + (i * 18);
                        
                        // Background
                        doc.setFillColor(...bgLight);
                        doc.roundedRect(margin, y, contentWidth, 15, 2, 2, 'F');
                        
                        // Label
                        doc.setFontSize(8);
                        doc.setTextColor(...textDark);
                        doc.setFont('helvetica', 'normal');
                        doc.text(m.label, margin + 5, y + 10);
                        
                        // Progress bar
                        const barX = margin + 70;
                        const barW = 80;
                        drawProgressBar(barX, y + 5, barW, 5, m.value, m.color, m.color);
                        
                        // Value
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...m.color);
                        doc.text(m.value + '%', barX + barW + 5, y + 10);
                        
                        // Target
                        doc.setFontSize(6);
                        doc.setTextColor(...textMuted);
                        doc.text('Target: ' + m.target + '%', barX + barW + 20, y + 10);
                    });
                    
                    yPos += 80;
                    
                    // Period Comparison
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('PERIOD COMPARISON', margin, yPos);
                    
                    yPos += 6;
                    
                    // Table
                    const headers = ['Metric', 'Current', 'Previous', 'Change'];
                    const colWidths = [50, 35, 35, 40];
                    
                    // Header row
                    doc.setFillColor(...purple);
                    doc.roundedRect(margin, yPos, contentWidth, 10, 2, 2, 'F');
                    doc.rect(margin, yPos + 5, contentWidth, 5, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    doc.setFont('helvetica', 'bold');
                    
                    let xPos = margin + 5;
                    headers.forEach((h, i) => {
                        doc.text(h, xPos, yPos + 7);
                        xPos += colWidths[i];
                    });
                    
                    yPos += 10;
                    
                    const rows = [
                        ['Total Claims', totalClaims, '-', '-', greenLight],
                        ['Members', totalMembers, '-', '-', greenLight],
                        ['Inpatient Cases', inpatientCases, '-', '-', blue],
                        ['Outpatient Cases', outpatientCases, '-', '-', teal]
                    ];
                    
                    rows.forEach((row, ri) => {
                        const y = yPos + (ri * 12);
                        doc.setFillColor(ri % 2 === 0 ? 250 : 245, ri % 2 === 0 ? 250 : 248, 252);
                        doc.rect(margin, y, contentWidth, 12, 'F');
                        
                        xPos = margin + 5;
                        row.slice(0, 4).forEach((cell, ci) => {
                            if (ci === 3) {
                                doc.setTextColor(...row[4]);
                                doc.setFont('helvetica', 'bold');
                            } else if (ci === 0) {
                                doc.setTextColor(...textDark);
                                doc.setFont('helvetica', 'bold');
                            } else {
                                doc.setTextColor(...textDark);
                                doc.setFont('helvetica', 'normal');
                            }
                            doc.setFontSize(8);
                            doc.text(cell, xPos, y + 8);
                            xPos += colWidths[ci];
                        });
                    });
                    
                    // Footer
                    doc.setFillColor(...purple);
                    doc.rect(0, pageHeight - 8, pageWidth, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6);
                    doc.text('Page 2  ‚Ä¢  Polaris Financial Services  ‚Ä¢  Confidential', pageWidth / 2, pageHeight - 3, { align: 'center' });
                }
                
                // ==================== PAGE 3: INPATIENT VS OUTPATIENT ====================
                if (sections.inout) {
                    sectionsDone++;
                    updateProgress(10 + (sectionsDone / totalSections * 70), 'Adding Inpatient/Outpatient...');
                    await new Promise(r => setTimeout(r, 80));
                    doc.addPage();
                    
                    // Header
                    doc.setFillColor(...purple);
                    doc.rect(0, 0, pageWidth, 22, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Inpatient vs Outpatient Analysis', margin, 14);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text(periodLabel, pageWidth - margin, 14, { align: 'right' });
                    
                    yPos = 32;
                    
                    // Main stats boxes
                    const boxW = (contentWidth - 10) / 2;
                    
                    // Inpatient Box
                    doc.setFillColor(...red);
                    doc.roundedRect(margin, yPos, boxW, 55, 5, 5, 'F');
                    
                    // Inner lighter box
                    doc.setFillColor(239, 154, 154);
                    doc.roundedRect(margin + boxW - 45, yPos + 5, 40, 45, 3, 3, 'F');
                    doc.setFontSize(8);
                    doc.setTextColor(...red);
                    doc.text('25%', margin + boxW - 30, yPos + 30);
                    doc.setFontSize(6);
                    doc.text('of cases', margin + boxW - 33, yPos + 38);
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text('INPATIENT', margin + 8, yPos + 14);
                    doc.setFontSize(26);
                    doc.setFont('helvetica', 'bold');
                    doc.text(inpatientCases, margin + 8, yPos + 35);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Cases', margin + 8, yPos + 45);
                    
                    // Outpatient Box
                    doc.setFillColor(...blue);
                    doc.roundedRect(margin + boxW + 10, yPos, boxW, 55, 5, 5, 'F');
                    
                    doc.setFillColor(144, 202, 249);
                    doc.roundedRect(margin + boxW + 10 + boxW - 45, yPos + 5, 40, 45, 3, 3, 'F');
                    doc.setFontSize(8);
                    doc.setTextColor(...blue);
                    doc.text('75%', margin + boxW + 10 + boxW - 30, yPos + 30);
                    doc.setFontSize(6);
                    doc.text('of cases', margin + boxW + 10 + boxW - 33, yPos + 38);
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text('OUTPATIENT', margin + boxW + 18, yPos + 14);
                    doc.setFontSize(26);
                    doc.setFont('helvetica', 'bold');
                    doc.text(outpatientCases, margin + boxW + 18, yPos + 35);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Cases', margin + boxW + 18, yPos + 45);
                    
                    yPos += 65;
                    
                    // Cases Distribution (NO COST DATA)
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('CASES DISTRIBUTION', margin, yPos);
                    
                    yPos += 8;
                    
                    // Visual bar comparison (cases only)
                    const inCasesVal = parseInt(inpatientCases.replace(/,/g, '')) || 308;
                    const outCasesVal = parseInt(outpatientCases.replace(/,/g, '')) || 926;
                    const exCasesVal = parseInt(exGratiaCases.replace(/,/g, '')) || 0;
                    const totalCasesVal = inCasesVal + outCasesVal + exCasesVal;
                    const inPct = totalCasesVal > 0 ? (inCasesVal / totalCasesVal * 100).toFixed(0) : 0;
                    const outPct = totalCasesVal > 0 ? (outCasesVal / totalCasesVal * 100).toFixed(0) : 0;
                    
                    // Stacked bar
                    const barTotal = contentWidth;
                    const inBarW = totalCasesVal > 0 ? (inCasesVal / totalCasesVal) * barTotal : barTotal * 0.25;
                    const outBarW = totalCasesVal > 0 ? (outCasesVal / totalCasesVal) * barTotal : barTotal * 0.75;
                    
                    doc.setFillColor(...red);
                    doc.roundedRect(margin, yPos, inBarW, 25, 3, 3, 'F');
                    doc.rect(margin + inBarW - 5, yPos, 5, 25, 'F');
                    
                    doc.setFillColor(...blue);
                    doc.roundedRect(margin + inBarW, yPos, outBarW, 25, 3, 3, 'F');
                    doc.rect(margin + inBarW, yPos, 5, 25, 'F');
                    
                    // Labels on bar
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Inpatient ' + inPct + '%', margin + 8, yPos + 10);
                    doc.text(inCasesVal + ' cases', margin + 8, yPos + 19);
                    
                    doc.text('Outpatient ' + outPct + '%', margin + inBarW + 8, yPos + 10);
                    doc.text(outCasesVal + ' cases', margin + inBarW + 8, yPos + 19);
                    
                    yPos += 35;
                    
                    // Detailed breakdown table (NO COST DATA)
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('DETAILED BREAKDOWN', margin, yPos);
                    
                    yPos += 8;
                    
                    const detailHeaders = ['Category', 'Cases', '% of Total'];
                    const detailWidths = [60, 55, 55];
                    
                    doc.setFillColor(...purple);
                    doc.roundedRect(margin, yPos, contentWidth, 10, 2, 2, 'F');
                    doc.rect(margin, yPos + 5, contentWidth, 5, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(7);
                    
                    xPos = margin + 3;
                    detailHeaders.forEach((h, i) => {
                        doc.text(h, xPos, yPos + 7);
                        xPos += detailWidths[i];
                    });
                    
                    yPos += 10;
                    
                    const detailRows = [
                        { data: ['Inpatient', inpatientCases, inPct + '%'], color: red },
                        { data: ['Outpatient', outpatientCases, outPct + '%'], color: blue },
                        { data: ['Ex Gratia', exGratiaCases, totalCasesVal > 0 ? (exCasesVal / totalCasesVal * 100).toFixed(0) + '%' : '0%'], color: gold },
                        { data: ['TOTAL', fmt(totalCasesVal), '100%'], color: purple, bold: true }
                    ];
                    
                    detailRows.forEach((row, ri) => {
                        const y = yPos + (ri * 14);
                        
                        if (row.bold) {
                            doc.setFillColor(240, 235, 245);
                        } else {
                            doc.setFillColor(ri % 2 === 0 ? 255 : 250, ri % 2 === 0 ? 248 : 245, ri % 2 === 0 ? 248 : 250);
                        }
                        doc.roundedRect(margin, y, contentWidth, 14, ri === detailRows.length - 1 ? 2 : 0, ri === detailRows.length - 1 ? 2 : 0, 'F');
                        
                        // Color indicator
                        doc.setFillColor(...row.color);
                        doc.roundedRect(margin, y, 3, 14, 1, 1, 'F');
                        
                        xPos = margin + 6;
                        row.data.forEach((cell, ci) => {
                            doc.setFontSize(8);
                            if (ci === 0 || row.bold) {
                                doc.setFont('helvetica', 'bold');
                                doc.setTextColor(...row.color);
                            } else {
                                doc.setFont('helvetica', 'normal');
                                doc.setTextColor(...textDark);
                            }
                            doc.text(cell, xPos, y + 9);
                            xPos += detailWidths[ci];
                        });
                    });
                    
                    yPos += 55;
                    
                    // Trends mini section
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('MONTHLY TREND', margin, yPos);
                    
                    yPos += 8;
                    
                    // Simple bar chart
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                    const barWidth = (contentWidth - 30) / 6;
                    
                    doc.setFillColor(...bgLight);
                    doc.roundedRect(margin, yPos, contentWidth, 50, 3, 3, 'F');
                    
                    const inData = [45, 52, 38, 61, 55, 51];
                    const outData = [120, 135, 142, 128, 155, 154];
                    const maxVal = 160;
                    
                    months.forEach((m, i) => {
                        const x = margin + 15 + (i * barWidth);
                        const inH = (inData[i] / maxVal) * 35;
                        const outH = (outData[i] / maxVal) * 35;
                        
                        // Outpatient bar
                        doc.setFillColor(...blue);
                        doc.roundedRect(x, yPos + 45 - outH, barWidth * 0.35, outH, 1, 1, 'F');
                        
                        // Inpatient bar
                        doc.setFillColor(...red);
                        doc.roundedRect(x + barWidth * 0.4, yPos + 45 - inH, barWidth * 0.35, inH, 1, 1, 'F');
                        
                        // Month label
                        doc.setFontSize(6);
                        doc.setTextColor(...textMuted);
                        doc.text(m, x + barWidth * 0.2, yPos + 48);
                    });
                    
                    // Legend
                    doc.setFillColor(...red);
                    doc.rect(margin + contentWidth - 60, yPos + 5, 8, 4, 'F');
                    doc.setFillColor(...blue);
                    doc.rect(margin + contentWidth - 60, yPos + 12, 8, 4, 'F');
                    doc.setFontSize(6);
                    doc.setTextColor(...textDark);
                    doc.text('Inpatient', margin + contentWidth - 50, yPos + 8);
                    doc.text('Outpatient', margin + contentWidth - 50, yPos + 15);
                    
                    // Footer
                    doc.setFillColor(...purple);
                    doc.rect(0, pageHeight - 8, pageWidth, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6);
                    doc.text('Page 3  ‚Ä¢  Polaris Financial Services  ‚Ä¢  Confidential', pageWidth / 2, pageHeight - 3, { align: 'center' });
                }
                
                // ==================== PAGE 4: CLAIMS ANALYSIS ====================
                if (sections.claims) {
                    sectionsDone++;
                    updateProgress(10 + (sectionsDone / totalSections * 70), 'Building Claims Analysis...');
                    await new Promise(r => setTimeout(r, 80));
                    doc.addPage();
                    
                    // Header
                    doc.setFillColor(...purple);
                    doc.rect(0, 0, pageWidth, 22, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Claims Analysis', margin, 14);
                    
                    yPos = 32;
                    
                    // Claims overview cards
                    const claimCards = [
                        { label: 'Total Claims', value: totalClaims, icon: 'üìã', color: blue },
                        { label: 'Approved', value: approvedAmount, icon: '‚úì', color: green },
                        { label: 'Avg Claim', value: '$127.05', icon: 'üìä', color: gold },
                        { label: 'Pending', value: '23', icon: '‚è≥', color: orange }
                    ];
                    
                    const cardW = (contentWidth - 15) / 4;
                    claimCards.forEach((card, i) => {
                        const x = margin + (i * (cardW + 5));
                        doc.setFillColor(...card.color);
                        doc.roundedRect(x, yPos, cardW, 40, 4, 4, 'F');
                        
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'normal');
                        doc.text(card.label.toUpperCase(), x + 5, yPos + 12);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text(card.value, x + 5, yPos + 28);
                    });
                    
                    yPos += 52;
                    
                    // Claims by category
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('CLAIMS BY CATEGORY', margin, yPos);
                    
                    yPos += 8;
                    
                    const categories = [
                        { name: 'Consultation', count: 412, amount: '$28,450', pct: 33, color: blue },
                        { name: 'Laboratory', count: 289, amount: '$22,340', pct: 23, color: green },
                        { name: 'Pharmacy', count: 234, amount: '$18,920', pct: 19, color: purple },
                        { name: 'Hospitalization', count: 156, amount: '$52,430', pct: 13, color: red },
                        { name: 'Emergency', count: 89, amount: '$24,120', pct: 7, color: orange },
                        { name: 'Others', count: 54, amount: '$10,529', pct: 5, color: teal }
                    ];
                    
                    categories.forEach((cat, i) => {
                        const y = yPos + (i * 16);
                        
                        doc.setFillColor(...bgLight);
                        doc.roundedRect(margin, y, contentWidth, 14, 2, 2, 'F');
                        
                        // Color bar
                        doc.setFillColor(...cat.color);
                        doc.roundedRect(margin, y, 3, 14, 1, 1, 'F');
                        
                        // Name
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...cat.color);
                        doc.text(cat.name, margin + 8, y + 9);
                        
                        // Count
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(...textDark);
                        doc.text(cat.count + ' claims', margin + 50, y + 9);
                        
                        // Progress bar
                        drawProgressBar(margin + 90, y + 4, 50, 5, cat.pct, cat.color, cat.color);
                        
                        // Amount
                        doc.setFont('helvetica', 'bold');
                        doc.text(cat.amount, margin + 145, y + 9);
                        
                        // Percentage
                        doc.setTextColor(...cat.color);
                        doc.text(cat.pct + '%', margin + contentWidth - 15, y + 9);
                    });
                    
                    yPos += 105;
                    
                    // Claims trend
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text('CLAIMS PROCESSING STATUS', margin, yPos);
                    
                    yPos += 8;
                    
                    doc.setFillColor(...bgLight);
                    doc.roundedRect(margin, yPos, contentWidth, 45, 3, 3, 'F');
                    
                    // Status breakdown
                    const statuses = [
                        { name: 'Approved', value: 1156, pct: 94, color: green },
                        { name: 'Pending', value: 23, pct: 2, color: orange },
                        { name: 'Under Review', value: 32, pct: 3, color: blue },
                        { name: 'Denied', value: 23, pct: 1, color: red }
                    ];
                    
                    const statusW = (contentWidth - 20) / 4;
                    statuses.forEach((s, i) => {
                        const x = margin + 5 + (i * statusW);
                        
                        doc.setFillColor(...s.color);
                        doc.circle(x + 8, yPos + 15, 5, 'F');
                        
                        doc.setFontSize(7);
                        doc.setTextColor(...textMuted);
                        doc.text(s.name, x + 18, yPos + 13);
                        
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...s.color);
                        doc.text(s.value.toString(), x + 18, yPos + 26);
                        
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'normal');
                        doc.text(s.pct + '%', x + 18, yPos + 35);
                    });
                    
                    // Footer
                    doc.setFillColor(...purple);
                    doc.rect(0, pageHeight - 8, pageWidth, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(6);
                    doc.text('Page 4  ‚Ä¢  Polaris Financial Services  ‚Ä¢  Confidential', pageWidth / 2, pageHeight - 3, { align: 'center' });
                }
                
                // Cost Breakdown section REMOVED from client portal (no financial data)
                
                // ==================== FINALIZE ====================
                updateProgress(95, 'Finalizing...');
                await new Promise(r => setTimeout(r, 100));
                
                // ==================== SAVE ====================
                updateProgress(100, 'Complete!');
                titleText.textContent = 'Report Ready!';
                statusText.textContent = 'Your custom report has been generated';
                stepText.textContent = 'Downloading...';
                
                await new Promise(r => setTimeout(r, 500));
                
                const fileName = `Polaris_Report_${clientName.replace(/\s+/g, '_')}_${periodLabel.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 1500);
                
            } catch (error) {
                console.error('Report error:', error);
                titleText.textContent = 'Error';
                statusText.textContent = 'Failed to generate report';
                stepText.textContent = error.message;
                progressBar.style.background = '#e74c3c';
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 3000);
            }
        }
        
        // Store dashboard data globally for report
        let dashboardData = null;
        
        async function generateClientReport() {
            const modal = document.getElementById('reportModal');
            const progressBar = document.getElementById('reportProgressBar');
            const stepText = document.getElementById('reportStep');
            const statusText = document.getElementById('reportStatus');
            const titleText = document.getElementById('reportTitle');
            
            modal.classList.remove('hidden');
            
            const updateProgress = (percent, step) => {
                progressBar.style.width = percent + '%';
                stepText.textContent = step;
            };
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);
                
                // Get current data
                const clientName = currentUser.username || currentUser.client_id || 'Client';
                const periodLabel = document.getElementById('periodBadge')?.textContent || 'Current Period';
                const reportDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                
                // Colors
                const greenDark = [27, 94, 32];
                const greenLight = [46, 125, 50];
                const gold = [212, 175, 55];
                const textDark = [30, 30, 30];
                const textMuted = [120, 120, 120];
                
                // ==================== PAGE 1: COVER ====================
                updateProgress(10, 'Creating cover page...');
                await new Promise(r => setTimeout(r, 200));
                
                // Green header bar
                doc.setFillColor(...greenDark);
                doc.rect(0, 0, pageWidth, 60, 'F');
                
                // Gold accent line
                doc.setFillColor(...gold);
                doc.rect(0, 58, pageWidth, 4, 'F');
                
                // Company name
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(28);
                doc.setFont('helvetica', 'bold');
                doc.text('POLARIS', margin, 30);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'normal');
                doc.text('FINANCIAL SERVICES', margin, 40);
                
                // Report title
                doc.setTextColor(...textDark);
                doc.setFontSize(32);
                doc.setFont('helvetica', 'bold');
                doc.text('Client Analytics Report', margin, 100);
                
                // Client name
                doc.setFontSize(20);
                doc.setTextColor(...greenDark);
                doc.text(clientName, margin, 120);
                
                // Period
                doc.setFontSize(14);
                doc.setTextColor(...textMuted);
                doc.text('Period: ' + periodLabel, margin, 135);
                doc.text('Generated: ' + reportDate, margin, 145);
                
                // Decorative box
                doc.setDrawColor(...greenDark);
                doc.setLineWidth(0.5);
                doc.rect(margin, 160, contentWidth, 80);
                
                doc.setFontSize(12);
                doc.setTextColor(...textDark);
                doc.text('This report contains:', margin + 5, 175);
                
                const contents = [
                    '‚Ä¢ Executive Summary & KPIs',
                    '‚Ä¢ Period Comparison Analysis',
                    '‚Ä¢ Inpatient vs Outpatient Breakdown',
                    '‚Ä¢ Principal vs Dependent Analysis',
                    '‚Ä¢ Cost Analysis & Trends',
                    '‚Ä¢ Member Movement Statistics',
                    '‚Ä¢ Historical Data'
                ];
                
                contents.forEach((item, i) => {
                    doc.text(item, margin + 5, 188 + (i * 7));
                });
                
                // Footer
                doc.setFontSize(10);
                doc.setTextColor(...textMuted);
                doc.text('Confidential - For authorized use only', pageWidth / 2, 280, { align: 'center' });
                doc.text('¬© 2025 Polaris Financial Services', pageWidth / 2, 287, { align: 'center' });
                
                // ==================== PAGE 2: EXECUTIVE SUMMARY ====================
                updateProgress(25, 'Building executive summary...');
                await new Promise(r => setTimeout(r, 200));
                doc.addPage();
                
                // Header
                doc.setFillColor(...greenDark);
                doc.rect(0, 0, pageWidth, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Executive Summary', margin, 17);
                
                // KPI boxes
                const kpis = [
                    { label: 'Total Members', value: document.getElementById('kpiMembers')?.textContent || '-', icon: 'üë•' },
                    { label: 'Total Claims', value: document.getElementById('kpiClaims')?.textContent || '-', icon: 'üìã' },
                    { label: 'Approved Amount', value: document.getElementById('kpiApproved')?.textContent || '-', icon: 'üíµ' },
                    { label: 'Cost per Member', value: document.getElementById('kpiCost')?.textContent || '-', icon: 'üìà' },
                    { label: 'Utilization Rate', value: document.getElementById('kpiUtilization')?.textContent || '-', icon: 'üéØ' }
                ];
                
                let yPos = 40;
                const boxWidth = (contentWidth - 10) / 2;
                const boxHeight = 30;
                
                kpis.forEach((kpi, i) => {
                    const col = i % 2;
                    const row = Math.floor(i / 2);
                    const x = margin + (col * (boxWidth + 10));
                    const y = yPos + (row * (boxHeight + 8));
                    
                    // Box
                    doc.setFillColor(245, 250, 245);
                    doc.setDrawColor(...greenLight);
                    doc.roundedRect(x, y, boxWidth, boxHeight, 3, 3, 'FD');
                    
                    // Label
                    doc.setFontSize(9);
                    doc.setTextColor(...textMuted);
                    doc.text(kpi.label, x + 5, y + 10);
                    
                    // Value
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...greenDark);
                    doc.text(kpi.value, x + 5, y + 23);
                });
                
                // Period Comparison Section
                yPos = 165;
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Period Comparison', margin, yPos);
                
                doc.setDrawColor(...gold);
                doc.setLineWidth(1);
                doc.line(margin, yPos + 3, margin + 50, yPos + 3);
                
                yPos += 15;
                
                const comparisons = [
                    { label: 'Claims', current: document.getElementById('cmpClaims')?.textContent, prev: document.getElementById('cmpClaimsPrev')?.textContent },
                    { label: 'Members', current: document.getElementById('cmpMembers')?.textContent, prev: document.getElementById('cmpMembersPrev')?.textContent },
                    { label: 'Approved (USD)', current: document.getElementById('cmpApproved')?.textContent, prev: document.getElementById('cmpApprovedPrev')?.textContent },
                    { label: 'Cost/Member', current: document.getElementById('cmpCost')?.textContent, prev: document.getElementById('cmpCostPrev')?.textContent }
                ];
                
                // Table header
                doc.setFillColor(...greenDark);
                doc.rect(margin, yPos, contentWidth, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Metric', margin + 5, yPos + 7);
                doc.text('Current', margin + 70, yPos + 7);
                doc.text('Previous', margin + 120, yPos + 7);
                
                yPos += 10;
                
                comparisons.forEach((cmp, i) => {
                    const rowY = yPos + (i * 12);
                    doc.setFillColor(i % 2 === 0 ? 250 : 245, i % 2 === 0 ? 250 : 248, i % 2 === 0 ? 250 : 245);
                    doc.rect(margin, rowY, contentWidth, 12, 'F');
                    
                    doc.setTextColor(...textDark);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.text(cmp.label, margin + 5, rowY + 8);
                    doc.setFont('helvetica', 'bold');
                    doc.text(cmp.current || '-', margin + 70, rowY + 8);
                    doc.setTextColor(...textMuted);
                    doc.text(cmp.prev || '-', margin + 120, rowY + 8);
                });
                
                // ==================== PAGE 3: INPATIENT/OUTPATIENT ====================
                updateProgress(45, 'Adding inpatient/outpatient analysis...');
                await new Promise(r => setTimeout(r, 200));
                doc.addPage();
                
                // Header
                doc.setFillColor(...greenDark);
                doc.rect(0, 0, pageWidth, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Inpatient vs Outpatient Analysis', margin, 17);
                
                yPos = 40;
                
                // Stats boxes
                const inpatientCases = document.getElementById('inpatientCases')?.textContent || '-';
                const outpatientCases = document.getElementById('outpatientCases')?.textContent || '-';
                const inpatientCost = document.getElementById('inpatientCost')?.textContent || '-';
                const outpatientCost = document.getElementById('outpatientCost')?.textContent || '-';
                
                // Inpatient Box
                doc.setFillColor(231, 76, 60);
                doc.roundedRect(margin, yPos, 85, 50, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.text('INPATIENT', margin + 10, yPos + 15);
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.text(inpatientCases, margin + 10, yPos + 32);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cases', margin + 10, yPos + 42);
                
                // Outpatient Box
                doc.setFillColor(52, 152, 219);
                doc.roundedRect(margin + 95, yPos, 85, 50, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.text('OUTPATIENT', margin + 105, yPos + 15);
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.text(outpatientCases, margin + 105, yPos + 32);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cases', margin + 105, yPos + 42);
                
                yPos += 65;
                
                // Cost comparison
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Cost Analysis', margin, yPos);
                
                yPos += 15;
                
                doc.setFillColor(250, 245, 245);
                doc.setDrawColor(231, 76, 60);
                doc.roundedRect(margin, yPos, 85, 35, 3, 3, 'FD');
                doc.setTextColor(231, 76, 60);
                doc.setFontSize(10);
                doc.text('Inpatient Cost', margin + 10, yPos + 12);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(inpatientCost, margin + 10, yPos + 27);
                
                doc.setFillColor(245, 250, 255);
                doc.setDrawColor(52, 152, 219);
                doc.roundedRect(margin + 95, yPos, 85, 35, 3, 3, 'FD');
                doc.setTextColor(52, 152, 219);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Outpatient Cost', margin + 105, yPos + 12);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(outpatientCost, margin + 105, yPos + 27);
                
                // ==================== PAGE 4: PRINCIPAL/DEPENDENT ====================
                updateProgress(60, 'Adding member type analysis...');
                await new Promise(r => setTimeout(r, 200));
                
                yPos += 55;
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Principal vs Dependent Analysis', margin, yPos);
                
                doc.setDrawColor(...gold);
                doc.setLineWidth(1);
                doc.line(margin, yPos + 3, margin + 70, yPos + 3);
                
                yPos += 20;
                
                const principalCount = document.getElementById('principalCount')?.textContent || '-';
                const dependentCount = document.getElementById('dependentCount')?.textContent || '-';
                const principalCost = document.getElementById('principalCost')?.textContent || '-';
                const dependentCost = document.getElementById('dependentCost')?.textContent || '-';
                
                // Principal Box
                doc.setFillColor(...greenDark);
                doc.roundedRect(margin, yPos, 85, 50, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.text('SEAFARERS (Principal)', margin + 8, yPos + 15);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(principalCount, margin + 10, yPos + 32);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cost: ' + principalCost, margin + 10, yPos + 44);
                
                // Dependent Box
                doc.setFillColor(...gold);
                doc.roundedRect(margin + 95, yPos, 85, 50, 3, 3, 'F');
                doc.setTextColor(30, 30, 30);
                doc.setFontSize(11);
                doc.text('DEPENDENTS', margin + 105, yPos + 15);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(dependentCount, margin + 105, yPos + 32);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cost: ' + dependentCost, margin + 105, yPos + 44);
                
                // ==================== PAGE 4: MEMBER MOVEMENT ====================
                updateProgress(75, 'Adding member movement...');
                await new Promise(r => setTimeout(r, 200));
                doc.addPage();
                
                // Header
                doc.setFillColor(...greenDark);
                doc.rect(0, 0, pageWidth, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Member Movement & Fees', margin, 17);
                
                yPos = 40;
                
                const newEnroll = document.getElementById('newEnrollments')?.textContent || '-';
                const cancelled = document.getElementById('cancellations')?.textContent || '-';
                const netChange = document.getElementById('netChange')?.textContent || '-';
                
                // Movement boxes
                doc.setFillColor(76, 175, 80);
                doc.roundedRect(margin, yPos, 55, 45, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.text('NEW ENROLLMENTS', margin + 5, yPos + 12);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(newEnroll, margin + 5, yPos + 32);
                
                doc.setFillColor(231, 76, 60);
                doc.roundedRect(margin + 62, yPos, 55, 45, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('CANCELLATIONS', margin + 67, yPos + 12);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(cancelled, margin + 67, yPos + 32);
                
                doc.setFillColor(...gold);
                doc.roundedRect(margin + 124, yPos, 55, 45, 3, 3, 'F');
                doc.setTextColor(30, 30, 30);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('NET CHANGE', margin + 129, yPos + 12);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(netChange, margin + 129, yPos + 32);
                
                // Fees Section
                yPos += 65;
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Fees & Charges', margin, yPos);
                
                doc.setDrawColor(...gold);
                doc.setLineWidth(1);
                doc.line(margin, yPos + 3, margin + 40, yPos + 3);
                
                yPos += 15;
                
                const fees = [
                    { label: 'Audit Fee', value: '15%' },
                    { label: 'Registration Fee (Annual)', value: '$24' },
                    { label: 'Monthly Fee (Annual)', value: '$9' }
                ];
                
                fees.forEach((fee, i) => {
                    const rowY = yPos + (i * 18);
                    doc.setFillColor(i % 2 === 0 ? 250 : 245, 250, i % 2 === 0 ? 250 : 245);
                    doc.roundedRect(margin, rowY, contentWidth, 15, 2, 2, 'F');
                    
                    doc.setFontSize(11);
                    doc.setTextColor(...textDark);
                    doc.setFont('helvetica', 'normal');
                    doc.text(fee.label, margin + 5, rowY + 10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...greenDark);
                    doc.text(fee.value, margin + contentWidth - 30, rowY + 10);
                });
                
                // ==================== FINAL PAGE: FOOTER ====================
                updateProgress(90, 'Finalizing report...');
                await new Promise(r => setTimeout(r, 200));
                
                // Add footer to all pages
                const totalPages = doc.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(9);
                    doc.setTextColor(...textMuted);
                    doc.text(`Page ${i} of ${totalPages}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                    if (i > 1) {
                        doc.text('Polaris Financial Services - Confidential', margin, pageHeight - 10);
                    }
                }
                
                // ==================== SAVE ====================
                updateProgress(100, 'Complete!');
                titleText.textContent = 'Report Ready!';
                statusText.textContent = 'Your report has been generated successfully';
                stepText.textContent = 'Downloading...';
                
                await new Promise(r => setTimeout(r, 500));
                
                // Save PDF
                const fileName = `Polaris_Report_${clientName.replace(/\s+/g, '_')}_${periodLabel.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
                
                // Close modal after delay
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 1500);
                
            } catch (error) {
                console.error('Report generation error:', error);
                titleText.textContent = 'Error';
                statusText.textContent = 'Failed to generate report';
                stepText.textContent = error.message;
                progressBar.style.background = '#e74c3c';
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 3000);
            }
        }
        
        async function generateMonthlyReport() {
            const modal = document.getElementById('reportModal');
            const progressBar = document.getElementById('reportProgressBar');
            const stepText = document.getElementById('reportStep');
            const statusText = document.getElementById('reportStatus');
            const titleText = document.getElementById('reportTitle');
            
            modal.classList.remove('hidden');
            progressBar.style.background = 'linear-gradient(90deg, var(--polaris-green), var(--polaris-gold))';
            
            const updateProgress = (percent, step) => {
                progressBar.style.width = percent + '%';
                stepText.textContent = step;
            };
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 15;
                const contentWidth = pageWidth - (margin * 2);
                
                // Get data
                const clientName = currentUser.username || currentUser.client_id || 'All Clients';
                const periodLabel = document.getElementById('periodBadge')?.textContent || 'Current Period';
                const reportDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                const monthName = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                // Colors
                const greenDark = [27, 94, 32];
                const greenLight = [46, 125, 50];
                const gold = [212, 175, 55];
                const blue = [21, 101, 192];
                const blueDark = [13, 71, 161];
                const red = [211, 47, 47];
                const textDark = [30, 30, 30];
                const textMuted = [120, 120, 120];
                
                // ==================== PAGE 1: COVER ====================
                updateProgress(5, 'Creating cover page...');
                await new Promise(r => setTimeout(r, 150));
                
                // Blue header for monthly report
                doc.setFillColor(...blue);
                doc.rect(0, 0, pageWidth, 70, 'F');
                
                // Gold accent
                doc.setFillColor(...gold);
                doc.rect(0, 68, pageWidth, 4, 'F');
                
                // Title
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'normal');
                doc.text('POLARIS FINANCIAL SERVICES', margin, 25);
                
                doc.setFontSize(32);
                doc.setFont('helvetica', 'bold');
                doc.text('Monthly Report', margin, 45);
                
                doc.setFontSize(18);
                doc.setFont('helvetica', 'normal');
                doc.text(periodLabel, margin, 58);
                
                // Report info box
                doc.setFillColor(250, 250, 250);
                doc.roundedRect(margin, 85, contentWidth, 50, 3, 3, 'F');
                
                doc.setFontSize(11);
                doc.setTextColor(...textMuted);
                doc.text('Report Details', margin + 10, 98);
                
                doc.setFontSize(12);
                doc.setTextColor(...textDark);
                doc.setFont('helvetica', 'bold');
                doc.text('Client:', margin + 10, 112);
                doc.text('Period:', margin + 10, 124);
                doc.setFont('helvetica', 'normal');
                doc.text(clientName, margin + 50, 112);
                doc.text(periodLabel, margin + 50, 124);
                
                doc.setTextColor(...textMuted);
                doc.setFontSize(10);
                doc.text('Generated: ' + reportDate, margin + 10, 130);
                
                // Contents
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Report Contents', margin, 160);
                
                doc.setDrawColor(...blue);
                doc.setLineWidth(1);
                doc.line(margin, 164, margin + 45, 164);
                
                const contents = [
                    { num: '01', title: 'Executive Summary', desc: 'Key performance indicators overview' },
                    { num: '02', title: 'Inpatient vs Outpatient', desc: 'Case distribution and cost analysis' },
                    { num: '03', title: 'Claims Analysis', desc: 'Detailed claims breakdown by category' },
                    { num: '04', title: 'Cost Breakdown', desc: 'Comprehensive cost analysis and fees' }
                ];
                
                let yPos = 175;
                contents.forEach((item, i) => {
                    doc.setFillColor(...blue);
                    doc.roundedRect(margin, yPos, 20, 20, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(item.num, margin + 6, yPos + 13);
                    
                    doc.setTextColor(...textDark);
                    doc.setFontSize(12);
                    doc.text(item.title, margin + 28, yPos + 8);
                    doc.setTextColor(...textMuted);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.text(item.desc, margin + 28, yPos + 16);
                    
                    yPos += 28;
                });
                
                // Footer
                doc.setFontSize(9);
                doc.setTextColor(...textMuted);
                doc.text('Confidential - For internal use only', pageWidth / 2, 285, { align: 'center' });
                
                // ==================== PAGE 2: EXECUTIVE SUMMARY ====================
                updateProgress(20, 'Building executive summary...');
                await new Promise(r => setTimeout(r, 150));
                doc.addPage();
                
                // Header
                doc.setFillColor(...blue);
                doc.rect(0, 0, pageWidth, 30, 'F');
                doc.setFillColor(...gold);
                doc.rect(0, 28, pageWidth, 3, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text('MONTHLY REPORT | ' + periodLabel, margin, 12);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('01. Executive Summary', margin, 23);
                
                yPos = 45;
                
                // Key Metrics Title
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Key Performance Indicators', margin, yPos);
                
                yPos += 10;
                
                // KPI Grid (2x3)
                const kpis = [
                    { label: 'Total Members', value: document.getElementById('kpiMembers')?.textContent || '-', color: greenDark, icon: 'MEMBERS' },
                    { label: 'Total Claims', value: document.getElementById('kpiClaims')?.textContent || '-', color: blue, icon: 'CLAIMS' },
                    { label: 'Approved Amount', value: document.getElementById('kpiApproved')?.textContent || '-', color: greenLight, icon: 'APPROVED' },
                    { label: 'Cost per Member', value: document.getElementById('kpiCost')?.textContent || '-', color: gold, icon: 'COST' },
                    { label: 'Utilization Rate', value: document.getElementById('kpiUtilization')?.textContent || '-', color: blue, icon: 'UTIL' },
                    { label: 'Inpatient Cases', value: document.getElementById('inpatientCases')?.textContent || '-', color: red, icon: 'INPAT' }
                ];
                
                const kpiBoxWidth = (contentWidth - 10) / 2;
                const kpiBoxHeight = 35;
                
                kpis.forEach((kpi, i) => {
                    const col = i % 2;
                    const row = Math.floor(i / 2);
                    const x = margin + (col * (kpiBoxWidth + 10));
                    const y = yPos + (row * (kpiBoxHeight + 8));
                    
                    // Box with left accent
                    doc.setFillColor(248, 250, 252);
                    doc.roundedRect(x, y, kpiBoxWidth, kpiBoxHeight, 2, 2, 'F');
                    doc.setFillColor(...kpi.color);
                    doc.rect(x, y, 4, kpiBoxHeight, 'F');
                    
                    // Label
                    doc.setFontSize(9);
                    doc.setTextColor(...textMuted);
                    doc.setFont('helvetica', 'normal');
                    doc.text(kpi.label.toUpperCase(), x + 10, y + 12);
                    
                    // Value
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...kpi.color);
                    doc.text(kpi.value, x + 10, y + 28);
                });
                
                // Period Comparison
                yPos += (kpiBoxHeight + 8) * 3 + 15;
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Period Comparison', margin, yPos);
                
                yPos += 8;
                
                // Comparison table
                const compHeaders = ['Metric', 'Current Period', 'Previous Period', 'Change'];
                const compData = [
                    ['Claims', document.getElementById('cmpClaims')?.textContent || '-', document.getElementById('cmpClaimsPrev')?.textContent || '-', document.getElementById('cmpClaimsChange')?.textContent || '-'],
                    ['Members', document.getElementById('cmpMembers')?.textContent || '-', document.getElementById('cmpMembersPrev')?.textContent || '-', document.getElementById('cmpMembersChange')?.textContent || '-'],
                    ['Approved (USD)', document.getElementById('cmpApproved')?.textContent || '-', document.getElementById('cmpApprovedPrev')?.textContent || '-', document.getElementById('cmpApprovedChange')?.textContent || '-'],
                    ['Cost/Member', document.getElementById('cmpCost')?.textContent || '-', document.getElementById('cmpCostPrev')?.textContent || '-', document.getElementById('cmpCostChange')?.textContent || '-']
                ];
                
                const colWidths = [45, 45, 45, 40];
                
                // Header row
                doc.setFillColor(...blue);
                doc.rect(margin, yPos, contentWidth, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                
                let xPos = margin + 5;
                compHeaders.forEach((h, i) => {
                    doc.text(h, xPos, yPos + 7);
                    xPos += colWidths[i];
                });
                
                yPos += 10;
                
                // Data rows
                compData.forEach((row, rowIdx) => {
                    doc.setFillColor(rowIdx % 2 === 0 ? 250 : 245, 250, rowIdx % 2 === 0 ? 252 : 248);
                    doc.rect(margin, yPos, contentWidth, 10, 'F');
                    
                    xPos = margin + 5;
                    row.forEach((cell, colIdx) => {
                        if (colIdx === 0) {
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(...textDark);
                        } else if (colIdx === 3) {
                            // Change column - color based on value
                            const isPositive = cell.includes('+') || cell.includes('‚Üë');
                            const isNegative = cell.includes('-') || cell.includes('‚Üì');
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(isPositive ? 76 : isNegative ? 211 : 120, isPositive ? 175 : isNegative ? 47 : 120, isPositive ? 80 : isNegative ? 47 : 120);
                        } else {
                            doc.setFont('helvetica', 'normal');
                            doc.setTextColor(...textDark);
                        }
                        doc.setFontSize(9);
                        doc.text(cell, xPos, yPos + 7);
                        xPos += colWidths[colIdx];
                    });
                    
                    yPos += 10;
                });
                
                // ==================== PAGE 3: INPATIENT VS OUTPATIENT ====================
                updateProgress(40, 'Adding inpatient/outpatient analysis...');
                await new Promise(r => setTimeout(r, 150));
                doc.addPage();
                
                // Header
                doc.setFillColor(...blue);
                doc.rect(0, 0, pageWidth, 30, 'F');
                doc.setFillColor(...gold);
                doc.rect(0, 28, pageWidth, 3, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text('MONTHLY REPORT | ' + periodLabel, margin, 12);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('02. Inpatient vs Outpatient', margin, 23);
                
                yPos = 45;
                
                // Get values
                const inpatientCases = document.getElementById('inpatientCases')?.textContent || '0';
                const outpatientCases = document.getElementById('outpatientCases')?.textContent || '0';
                const inpatientCost = document.getElementById('inpatientCost')?.textContent || '$0';
                const outpatientCost = document.getElementById('outpatientCost')?.textContent || '$0';
                
                // Overview boxes
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Case Distribution', margin, yPos);
                
                yPos += 8;
                
                // Inpatient big box
                doc.setFillColor(211, 47, 47);
                doc.roundedRect(margin, yPos, 85, 60, 4, 4, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('INPATIENT', margin + 10, yPos + 15);
                doc.setFontSize(28);
                doc.setFont('helvetica', 'bold');
                doc.text(inpatientCases, margin + 10, yPos + 38);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cases', margin + 10, yPos + 50);
                
                // Outpatient big box
                doc.setFillColor(25, 118, 210);
                doc.roundedRect(margin + 95, yPos, 85, 60, 4, 4, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('OUTPATIENT', margin + 105, yPos + 15);
                doc.setFontSize(28);
                doc.setFont('helvetica', 'bold');
                doc.text(outpatientCases, margin + 105, yPos + 38);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Cases', margin + 105, yPos + 50);
                
                yPos += 75;
                
                // Cost Analysis
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Cost Analysis', margin, yPos);
                
                yPos += 10;
                
                // Cost comparison table
                doc.setFillColor(...blue);
                doc.rect(margin, yPos, contentWidth, 12, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Category', margin + 5, yPos + 8);
                doc.text('Total Cost', margin + 70, yPos + 8);
                doc.text('% of Total', margin + 130, yPos + 8);
                
                yPos += 12;
                
                // Parse costs for percentage calculation
                const inCostNum = parseFloat(inpatientCost.replace(/[^0-9.]/g, '')) || 0;
                const outCostNum = parseFloat(outpatientCost.replace(/[^0-9.]/g, '')) || 0;
                const totalCost = inCostNum + outCostNum;
                const inPct = totalCost > 0 ? ((inCostNum / totalCost) * 100).toFixed(1) : '0';
                const outPct = totalCost > 0 ? ((outCostNum / totalCost) * 100).toFixed(1) : '0';
                
                // Inpatient row
                doc.setFillColor(255, 235, 238);
                doc.rect(margin, yPos, contentWidth, 15, 'F');
                doc.setFillColor(211, 47, 47);
                doc.rect(margin, yPos, 4, 15, 'F');
                doc.setTextColor(...textDark);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Inpatient', margin + 10, yPos + 10);
                doc.text(inpatientCost, margin + 70, yPos + 10);
                doc.setTextColor(211, 47, 47);
                doc.text(inPct + '%', margin + 130, yPos + 10);
                
                yPos += 15;
                
                // Outpatient row
                doc.setFillColor(227, 242, 253);
                doc.rect(margin, yPos, contentWidth, 15, 'F');
                doc.setFillColor(25, 118, 210);
                doc.rect(margin, yPos, 4, 15, 'F');
                doc.setTextColor(...textDark);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Outpatient', margin + 10, yPos + 10);
                doc.text(outpatientCost, margin + 70, yPos + 10);
                doc.setTextColor(25, 118, 210);
                doc.text(outPct + '%', margin + 130, yPos + 10);
                
                yPos += 15;
                
                // Total row
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPos, contentWidth, 15, 'F');
                doc.setTextColor(...textDark);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL', margin + 10, yPos + 10);
                doc.text('$' + totalCost.toLocaleString(), margin + 70, yPos + 10);
                doc.text('100%', margin + 130, yPos + 10);
                
                yPos += 30;
                
                // Visual bar
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Cost Distribution', margin, yPos);
                
                yPos += 8;
                
                const barWidth = contentWidth;
                const barHeight = 20;
                const inBarWidth = totalCost > 0 ? (inCostNum / totalCost) * barWidth : barWidth / 2;
                
                doc.setFillColor(211, 47, 47);
                doc.roundedRect(margin, yPos, inBarWidth, barHeight, 2, 2, 'F');
                doc.setFillColor(25, 118, 210);
                doc.roundedRect(margin + inBarWidth, yPos, barWidth - inBarWidth, barHeight, 2, 2, 'F');
                
                // Labels on bar
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                if (inBarWidth > 30) doc.text('Inpatient ' + inPct + '%', margin + 5, yPos + 13);
                if (barWidth - inBarWidth > 30) doc.text('Outpatient ' + outPct + '%', margin + inBarWidth + 5, yPos + 13);
                
                // ==================== PAGE 4: CLAIMS ANALYSIS ====================
                updateProgress(60, 'Building claims analysis...');
                await new Promise(r => setTimeout(r, 150));
                doc.addPage();
                
                // Header
                doc.setFillColor(...blue);
                doc.rect(0, 0, pageWidth, 30, 'F');
                doc.setFillColor(...gold);
                doc.rect(0, 28, pageWidth, 3, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text('MONTHLY REPORT | ' + periodLabel, margin, 12);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('03. Claims Analysis', margin, 23);
                
                yPos = 45;
                
                // Claims Overview
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Claims Overview', margin, yPos);
                
                yPos += 10;
                
                const totalClaims = document.getElementById('kpiClaims')?.textContent || '0';
                const approvedAmount = document.getElementById('kpiApproved')?.textContent || '$0';
                const claimsNum = parseInt(totalClaims.replace(/,/g, '')) || 1;
                const approvedNum = parseFloat(approvedAmount.replace(/[^0-9.]/g, '')) || 0;
                const avgClaim = claimsNum > 0 ? (approvedNum / claimsNum).toFixed(2) : '0';
                
                // Claims metrics boxes
                const claimMetrics = [
                    { label: 'Total Claims', value: totalClaims, color: blue },
                    { label: 'Approved Amount', value: approvedAmount, color: greenDark },
                    { label: 'Average Claim', value: '$' + avgClaim, color: gold }
                ];
                
                const metricWidth = (contentWidth - 20) / 3;
                
                claimMetrics.forEach((m, i) => {
                    const x = margin + (i * (metricWidth + 10));
                    
                    doc.setFillColor(248, 250, 252);
                    doc.setDrawColor(...m.color);
                    doc.setLineWidth(0.5);
                    doc.roundedRect(x, yPos, metricWidth, 40, 3, 3, 'FD');
                    
                    doc.setFontSize(8);
                    doc.setTextColor(...textMuted);
                    doc.setFont('helvetica', 'normal');
                    doc.text(m.label.toUpperCase(), x + 5, yPos + 12);
                    
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...m.color);
                    doc.text(m.value, x + 5, yPos + 30);
                });
                
                yPos += 55;
                
                // Claims by Type
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Claims by Type', margin, yPos);
                
                yPos += 10;
                
                const claimTypes = [
                    { type: 'Inpatient Claims', count: inpatientCases, pct: '25%', color: [211, 47, 47] },
                    { type: 'Outpatient Claims', count: outpatientCases, pct: '75%', color: [25, 118, 210] }
                ];
                
                claimTypes.forEach((ct, i) => {
                    doc.setFillColor(250, 250, 252);
                    doc.roundedRect(margin, yPos, contentWidth, 25, 2, 2, 'F');
                    doc.setFillColor(...ct.color);
                    doc.rect(margin, yPos, 5, 25, 'F');
                    
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...textDark);
                    doc.text(ct.type, margin + 12, yPos + 10);
                    
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...textMuted);
                    doc.text(ct.count + ' claims (' + ct.pct + ')', margin + 12, yPos + 19);
                    
                    // Progress bar
                    const pctNum = parseFloat(ct.pct) || 0;
                    const barStartX = margin + 120;
                    const barMaxWidth = 50;
                    
                    doc.setFillColor(230, 230, 230);
                    doc.roundedRect(barStartX, yPos + 8, barMaxWidth, 8, 2, 2, 'F');
                    doc.setFillColor(...ct.color);
                    doc.roundedRect(barStartX, yPos + 8, (pctNum / 100) * barMaxWidth, 8, 2, 2, 'F');
                    
                    yPos += 30;
                });
                
                // ==================== PAGE 5: COST BREAKDOWN ====================
                updateProgress(80, 'Creating cost breakdown...');
                await new Promise(r => setTimeout(r, 150));
                doc.addPage();
                
                // Header
                doc.setFillColor(...blue);
                doc.rect(0, 0, pageWidth, 30, 'F');
                doc.setFillColor(...gold);
                doc.rect(0, 28, pageWidth, 3, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text('MONTHLY REPORT | ' + periodLabel, margin, 12);
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('04. Cost Breakdown', margin, 23);
                
                yPos = 45;
                
                // Cost Summary
                const costPerMember = document.getElementById('kpiCost')?.textContent || '$0';
                const costNum = parseFloat(costPerMember.replace(/[^0-9.]/g, '')) || 0;
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Cost per Member Analysis', margin, yPos);
                
                yPos += 10;
                
                // Big cost display
                doc.setFillColor(245, 250, 245);
                doc.setDrawColor(...greenDark);
                doc.setLineWidth(1);
                doc.roundedRect(margin, yPos, contentWidth, 50, 4, 4, 'FD');
                
                doc.setFontSize(12);
                doc.setTextColor(...textMuted);
                doc.text('TOTAL COST PER MEMBER', margin + 10, yPos + 18);
                
                doc.setFontSize(32);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...greenDark);
                doc.text(costPerMember, margin + 10, yPos + 40);
                
                // Target indicator
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...textMuted);
                doc.text('Target: $50.00', margin + 120, yPos + 40);
                
                yPos += 65;
                
                // Cost Components
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...textDark);
                doc.text('Cost Components', margin, yPos);
                
                yPos += 10;
                
                const baseCost = costNum * 0.70;
                const auditFee = baseCost * 0.15;
                const regFee = 24;
                const monthlyFee = 9;
                
                const costComponents = [
                    { label: 'Base Claims Cost', value: '$' + baseCost.toFixed(2), pct: '70%', color: greenDark },
                    { label: 'Audit Fee (15%)', value: '$' + auditFee.toFixed(2), pct: '10.5%', color: gold },
                    { label: 'Registration Fee', value: '$' + regFee.toFixed(2), pct: 'Annual', color: blue },
                    { label: 'Monthly Service Fee', value: '$' + monthlyFee.toFixed(2), pct: 'Annual', color: [156, 39, 176] }
                ];
                
                costComponents.forEach((cc, i) => {
                    doc.setFillColor(250, 250, 252);
                    doc.roundedRect(margin, yPos, contentWidth, 20, 2, 2, 'F');
                    doc.setFillColor(...cc.color);
                    doc.rect(margin, yPos, 4, 20, 'F');
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...textDark);
                    doc.text(cc.label, margin + 10, yPos + 13);
                    
                    doc.setFont('helvetica', 'bold');
                    doc.text(cc.value, margin + 100, yPos + 13);
                    
                    doc.setTextColor(...textMuted);
                    doc.setFontSize(9);
                    doc.text(cc.pct, margin + 150, yPos + 13);
                    
                    yPos += 24;
                });
                
                yPos += 10;
                
                // Total bar
                doc.setFillColor(...greenDark);
                doc.roundedRect(margin, yPos, contentWidth, 25, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL ANNUALIZED COST', margin + 10, yPos + 16);
                doc.text(costPerMember + ' per member', margin + 120, yPos + 16);
                
                // ==================== ADD PAGE NUMBERS ====================
                updateProgress(95, 'Finalizing...');
                await new Promise(r => setTimeout(r, 150));
                
                const totalPages = doc.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(...textMuted);
                    doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
                    if (i > 1) {
                        doc.text('Polaris Financial Services | Confidential', margin, pageHeight - 10);
                    }
                }
                
                // ==================== SAVE ====================
                updateProgress(100, 'Complete!');
                titleText.textContent = 'Monthly Report Ready!';
                statusText.textContent = 'Your report has been generated';
                stepText.textContent = 'Downloading...';
                
                await new Promise(r => setTimeout(r, 500));
                
                const fileName = `Polaris_Monthly_Report_${periodLabel.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 1500);
                
            } catch (error) {
                console.error('Report error:', error);
                titleText.textContent = 'Error';
                statusText.textContent = 'Failed to generate report';
                stepText.textContent = error.message;
                progressBar.style.background = '#e74c3c';
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 3000);
            }
        }
        
        async function showDashboard() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('mainHeader').style.display = 'block';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('mainFooter').style.display = 'block';
            document.getElementById('clientName').textContent = currentUser.username || 'User';
            document.getElementById('clientAvatar').textContent = (currentUser.username || 'U')[0].toUpperCase();
            
            // Load saved companies list if exists
            const savedCompanies = localStorage.getItem('polaris_companies');
            if (savedCompanies) {
                companiesList = JSON.parse(savedCompanies);
                selectedCompanyId = currentUser.client_id || (companiesList[0] && companiesList[0].client_id);
            }
            
            // Populate company dropdown
            populateCompanyDropdown();
            
            await loadData(selectedCompanyId);
            document.getElementById('loadingScreen').classList.add('hidden');
        }
        
        // Store raw API data for filtering
        let rawApiData = null;
        
        async function loadData(clientId) {
            try {
                // Always fetch ALL data (no client_id filter) - we filter on frontend
                const apiUrl = `${API_URL}?action=getMasterComparison`;
                
                const r = await fetch(apiUrl);
                const d = await r.json();
                if (d.success) {
                    rawApiData = d.data;
                    updateDashboard(d.data, clientId);
                }
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
            } catch(e) { console.error(e); }
        }
        
        // Get list of client_ids to include based on selection
        function getClientIdsToFilter(selectedId) {
            const selected = companiesList.find(c => c.client_id === selectedId);
            
            if (selected && selected.is_parent) {
                // Parent selected - include ALL companies in the group
                return companiesList.map(c => c.client_id);
            } else {
                // Subsidiary selected - include only that one
                return [selectedId];
            }
        }
        
        // Filter and aggregate client_details by period
        function filterClientData(clientDetails, clientIds, period) {
            return clientDetails.filter(cd => 
                clientIds.includes(cd.client_id) && cd.period === period
            );
        }
        
        // Aggregate data for multiple clients
        function aggregateClientData(filteredData) {
            const members = filteredData.reduce((sum, d) => sum + (d.members || 0), 0);
            const approved_usd = filteredData.reduce((sum, d) => sum + (d.approved_usd || 0), 0);
            return {
                members: members,
                claims: filteredData.reduce((sum, d) => sum + (d.claims || 0), 0),
                approved_usd: approved_usd,
                cost_per_member: members > 0 ? approved_usd / members : 0,
                inpatient_cases: filteredData.reduce((sum, d) => sum + (d.inpatient_cases || 0), 0),
                outpatient_cases: filteredData.reduce((sum, d) => sum + (d.outpatient_cases || 0), 0),
                exgratia_cases: filteredData.reduce((sum, d) => sum + (d.exgratia_cases || 0), 0),
                new_enrollments: filteredData.reduce((sum, d) => sum + (d.new_enrollments || 0), 0),
                cancellations: filteredData.reduce((sum, d) => sum + (d.cancellations || 0), 0)
            };
        }
        
        function updateDashboard(data, clientId) {
            if (!data.client_details || !data.periods) return;
            
            const clientIds = getClientIdsToFilter(clientId || selectedCompanyId);
            const periods = data.periods || [];
            const latestPeriod = data.latest_period || periods[periods.length - 1];
            const previousPeriod = periods.length > 1 ? periods[periods.indexOf(latestPeriod) - 1] : null;
            
            // Get filtered data for current period
            const currentData = filterClientData(data.client_details, clientIds, latestPeriod);
            const c = aggregateClientData(currentData);
            
            // Get filtered data for previous period
            let p = null, ch = null;
            if (previousPeriod) {
                const prevData = filterClientData(data.client_details, clientIds, previousPeriod);
                p = aggregateClientData(prevData);
                
                // Calculate changes
                ch = {
                    members: { 
                        percentage: p.members > 0 ? ((c.members - p.members) / p.members * 100) : null 
                    },
                    claims: { 
                        percentage: p.claims > 0 ? ((c.claims - p.claims) / p.claims * 100) : null 
                    }
                };
            }
            
            // Update period badge
            document.getElementById('periodBadge').textContent = latestPeriod;
            if (p) document.getElementById('cmpPeriodLabel').textContent = `${latestPeriod} vs ${previousPeriod}`;
            
            // Update KPIs with REAL data
            // COST PER MEMBER - Big green number
            document.getElementById('kpiCostPerMember').textContent = '$' + c.cost_per_member.toFixed(2);
            
            document.getElementById('kpiMembers').textContent = fmt(c.members);
            document.getElementById('kpiClaims').textContent = fmt(c.claims);
            const util = c.members > 0 ? (c.claims / c.members * 100) : 0;
            document.getElementById('kpiUtilization').textContent = util.toFixed(1) + '%';
            document.getElementById('totalActive').textContent = fmt(c.members);
            
            if (ch) {
                setTrend('kpiMembersTrend', ch.members);
                setTrend('kpiClaimsTrend', ch.claims);
            }
            
            // Period comparison
            if (p && ch) {
                document.getElementById('cmpClaims').textContent = fmt(c.claims);
                document.getElementById('cmpClaimsPrev').textContent = fmt(p.claims);
                setChange('cmpClaimsChange', ch.claims);
                document.getElementById('cmpMembers').textContent = fmt(c.members);
                document.getElementById('cmpMembersPrev').textContent = fmt(p.members);
                setChange('cmpMembersChange', ch.members);
            }
            
            // REAL Inpatient/Outpatient/Ex Gratia data from API
            const inpatientCases = c.inpatient_cases || 0;
            const outpatientCases = c.outpatient_cases || 0;
            const exGratiaCases = c.exgratia_cases || 0;
            
            document.getElementById('inpatientCases').textContent = fmt(inpatientCases);
            document.getElementById('outpatientCases').textContent = fmt(outpatientCases);
            document.getElementById('exGratiaCases').textContent = fmt(exGratiaCases);
            
            // Principal/Dependent data (still estimate until CBMS provides)
            const principalMembers = Math.round(c.members * 0.4);
            const dependentMembers = c.members - principalMembers;
            
            document.getElementById('principalCount').textContent = fmt(principalMembers);
            document.getElementById('dependentCount').textContent = fmt(dependentMembers);
            
            // REAL Member Movement from API
            const newEnroll = c.new_enrollments || 0;
            const cancelled = c.cancellations || 0;
            document.getElementById('newEnrollments').textContent = '+' + newEnroll;
            document.getElementById('cancellations').textContent = '-' + cancelled;
            document.getElementById('netChange').textContent = (newEnroll - cancelled >= 0 ? '+' : '') + (newEnroll - cancelled);
            
            // Build periods data for charts
            const periodsData = periods.map(period => {
                const periodFiltered = filterClientData(data.client_details, clientIds, period);
                const agg = aggregateClientData(periodFiltered);
                return {
                    period_label: period,
                    members: agg.members,
                    claims: agg.claims,
                    inpatient_cases: agg.inpatient_cases,
                    outpatient_cases: agg.outpatient_cases,
                    exgratia_cases: agg.exgratia_cases,
                    new_enrollments: agg.new_enrollments,
                    cancellations: agg.cancellations
                };
            });
            
            try { createCharts(periodsData, c); } catch(e) { console.error('createCharts error:', e); }
            try { createInOutCharts(periodsData, inpatientCases, outpatientCases, exGratiaCases); } catch(e) { console.error('createInOutCharts error:', e); }
            try { createMemberTypeCharts(principalMembers, dependentMembers, c.claims); } catch(e) { console.error('createMemberTypeCharts error:', e); }
            try { createMovementChartsReal(periodsData); } catch(e) { console.error('createMovementCharts error:', e); }
            
            // Additional charts - each in separate try-catch
            try { createCategoryCharts(c); } catch(e) { console.error('createCategoryCharts error:', e); }
            try { createYoYCharts(periodsData); } catch(e) { console.error('createYoYCharts error:', e); }
            try { createHospitalCharts(); } catch(e) { console.error('createHospitalCharts error:', e); }
            try { createGeoCharts(); } catch(e) { console.error('createGeoCharts error:', e); }
            
            updateMetrics(util);
            updateInsights(ch);
            updateTableReal(periodsData);
        }
        
        // Real movement charts with actual data
        function createMovementChartsReal(periods) {
            // Movement Compare Chart
            const ctx1 = safeGetContext('movementCompareChart');
            if (ctx1) {
                if (charts.movementCompare) charts.movementCompare.destroy();
                
                const enrollGrad = ctx1.createLinearGradient(0, 0, 0, 250);
                enrollGrad.addColorStop(0, '#A5D6A7');
                enrollGrad.addColorStop(0.5, '#66BB6A');
                enrollGrad.addColorStop(1, '#2E7D32');
                
                const cancelGrad = ctx1.createLinearGradient(0, 0, 0, 250);
                cancelGrad.addColorStop(0, '#EF9A9A');
                cancelGrad.addColorStop(0.5, '#EF5350');
                cancelGrad.addColorStop(1, '#C62828');
                
                charts.movementCompare = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: periods.map(p => p.period_label),
                        datasets: [
                            { 
                                label: 'New Enrollments',
                                data: periods.map(p => p.new_enrollments || 0), 
                                backgroundColor: enrollGrad, 
                                borderRadius: 6,
                                borderWidth: 2,
                                borderColor: '#1B5E20',
                                barPercentage: 0.8,
                                categoryPercentage: 0.7
                            },
                            { 
                                label: 'Cancellations',
                                data: periods.map(p => p.cancellations || 0), 
                                backgroundColor: cancelGrad,
                                borderRadius: 6,
                                borderWidth: 2,
                                borderColor: '#B71C1C',
                                barPercentage: 0.8,
                                categoryPercentage: 0.7
                            }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { 
                                display: true, 
                                position: 'top', 
                                labels: { 
                                    color: '#b8c9b8', 
                                    font: { size: 13, weight: 'bold' },
                                    usePointStyle: true,
                                    pointStyle: 'rectRounded'
                                } 
                            } 
                        }, 
                        scales: { 
                            x: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 12, weight: 'bold' } } }, 
                            y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', font: { size: 12 } } } 
                        }
                    }
                });
            }
            
            // Movement Trend Chart
            const ctx2 = safeGetContext('movementTrendChart');
            if (ctx2) {
                if (charts.movementTrend) charts.movementTrend.destroy();
                
                const netGrad = ctx2.createLinearGradient(0, 0, 0, 250);
                netGrad.addColorStop(0, 'rgba(212,175,55,0.4)');
                netGrad.addColorStop(1, 'rgba(212,175,55,0.05)');
                
                charts.movementTrend = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: periods.map(p => p.period_label),
                        datasets: [
                            { 
                                label: 'Enrollments',
                                data: periods.map(p => p.new_enrollments || 0), 
                                borderColor: '#4CAF50', 
                                backgroundColor: 'rgba(76,175,80,0.1)',
                                fill: false,
                                tension: 0.4,
                                borderWidth: 3,
                                pointBackgroundColor: '#4CAF50',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 5,
                                pointHoverRadius: 8
                            },
                            { 
                                label: 'Cancellations',
                                data: periods.map(p => p.cancellations || 0), 
                                borderColor: '#e74c3c', 
                                backgroundColor: 'rgba(231,76,60,0.1)',
                                fill: false,
                                tension: 0.4,
                                borderWidth: 3,
                                pointBackgroundColor: '#e74c3c',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 5,
                                pointHoverRadius: 8
                            },
                            { 
                                label: 'Net Change',
                                data: periods.map(p => (p.new_enrollments || 0) - (p.cancellations || 0)), 
                                borderColor: '#FFD700', 
                                backgroundColor: netGrad, 
                                fill: true, 
                                tension: 0.4,
                                borderWidth: 4,
                                pointBackgroundColor: '#FFD700',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 3,
                                pointRadius: 6,
                                pointHoverRadius: 10
                            }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { 
                                display: true, 
                                position: 'top', 
                                labels: { 
                                    color: '#b8c9b8', 
                                    font: { size: 13, weight: 'bold' },
                                    usePointStyle: true 
                                } 
                            } 
                        }, 
                        scales: { 
                            x: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 12, weight: 'bold' } } }, 
                            y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', font: { size: 12 } } } 
                        }
                    }
                });
            }
            
            // Full Trend Chart
            const ctx3 = safeGetContext('movementFullTrendChart');
            if (ctx3) {
                if (charts.movementFullTrend) charts.movementFullTrend.destroy();
                
                const fillGreen = ctx3.createLinearGradient(0, 0, 0, 200);
                fillGreen.addColorStop(0, 'rgba(76,175,80,0.3)');
                fillGreen.addColorStop(1, 'rgba(76,175,80,0.05)');
                const fillRed = ctx3.createLinearGradient(0, 0, 0, 200);
                fillRed.addColorStop(0, 'rgba(231,76,60,0.3)');
                fillRed.addColorStop(1, 'rgba(231,76,60,0.05)');
                
                charts.movementFullTrend = new Chart(ctx3, {
                    type: 'line',
                    data: {
                        labels: periods.map(p => p.period_label),
                        datasets: [
                            { 
                                label: 'New Enrollments',
                                data: periods.map(p => p.new_enrollments || 0), 
                                borderColor: '#4CAF50', 
                                backgroundColor: fillGreen,
                                fill: true,
                                tension: 0.4,
                                borderWidth: 3,
                                pointBackgroundColor: '#4CAF50',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 6,
                                pointHoverRadius: 10
                            },
                            { 
                                label: 'Cancellations',
                                data: periods.map(p => p.cancellations || 0), 
                                borderColor: '#e74c3c', 
                                backgroundColor: fillRed,
                                fill: true,
                                tension: 0.4,
                                borderWidth: 3,
                                pointBackgroundColor: '#e74c3c',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 6,
                                pointHoverRadius: 10
                            }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { 
                                display: true, 
                                position: 'top', 
                                labels: { 
                                    color: '#b8c9b8', 
                                    font: { size: 14, weight: 'bold' },
                                    usePointStyle: true,
                                    padding: 25
                                } 
                            } 
                        }, 
                        scales: { 
                            x: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 13, weight: 'bold' } } }, 
                            y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', font: { size: 12 } } } 
                        }
                    }
                });
            }
        }
        
        // Real table with actual data
        function updateTableReal(periods) {
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = periods.map((p, i) => {
                const rank = periods.length - i;
                const cls = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
                const util = p.members > 0 ? (p.claims / p.members * 100).toFixed(1) : 0;
                return `<tr>
                    <td><div class="rank-badge ${cls}">${rank}</div></td>
                    <td><strong>${p.period_label}</strong></td>
                    <td>${fmt(p.members)}</td>
                    <td>${fmt(p.claims)}</td>
                    <td>${util}%</td>
                </tr>`;
            }).reverse().join('');
        }
        
        function createInOutCharts(periods, inCases, outCases, exGratiaCases) {
            // Inpatient/Outpatient/Ex Gratia Pie
            const ctx1 = safeGetContext('inOutPieChart');
            if (ctx1) {
                if (charts.inOutPie) charts.inOutPie.destroy();
                
                const redGrad = ctx1.createLinearGradient(0, 0, 0, 300);
                redGrad.addColorStop(0, '#EF5350');
                redGrad.addColorStop(1, '#B71C1C');
                const blueGrad = ctx1.createLinearGradient(0, 0, 0, 300);
                blueGrad.addColorStop(0, '#42A5F5');
                blueGrad.addColorStop(1, '#1565C0');
                const purpleGrad = ctx1.createLinearGradient(0, 0, 0, 300);
                purpleGrad.addColorStop(0, '#FFD700');
                purpleGrad.addColorStop(1, '#B8860B');
                
                charts.inOutPie = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: ['Inpatient', 'Outpatient', 'Ex Gratia'],
                        datasets: [{ 
                            data: [inCases, outCases, exGratiaCases], 
                            backgroundColor: [redGrad, blueGrad, purpleGrad], 
                            borderWidth: 3,
                            borderColor: ['#B71C1C', '#0D47A1', '#8B7500'],
                            hoverOffset: 15,
                            hoverBorderWidth: 4
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        cutout: '55%', 
                        plugins: { 
                            legend: { display: true, position: 'bottom', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20, boxWidth: 16, boxHeight: 16 } }
                        }
                    }
                });
            }
            
            // Trend Chart with Ex Gratia
            const ctx3 = safeGetContext('inOutTrendChart');
            if (ctx3) {
                if (charts.inOutTrend) charts.inOutTrend.destroy();
                
                const fillRed = ctx3.createLinearGradient(0, 0, 0, 200);
                fillRed.addColorStop(0, 'rgba(231,76,60,0.4)');
                fillRed.addColorStop(1, 'rgba(231,76,60,0.05)');
                const fillBlue = ctx3.createLinearGradient(0, 0, 0, 200);
                fillBlue.addColorStop(0, 'rgba(52,152,219,0.4)');
                fillBlue.addColorStop(1, 'rgba(52,152,219,0.05)');
                const fillGold = ctx3.createLinearGradient(0, 0, 0, 200);
                fillGold.addColorStop(0, 'rgba(212,175,55,0.4)');
                fillGold.addColorStop(1, 'rgba(212,175,55,0.05)');
                
                charts.inOutTrend = new Chart(ctx3, {
                    type: 'line',
                    data: {
                        labels: periods.map(p => p.period_label),
                        datasets: [
                            { 
                                label: 'Inpatient', 
                                data: periods.map(p => Math.round(p.claims * 0.22)), 
                                borderColor: '#e74c3c', 
                                backgroundColor: fillRed, 
                                fill: true, 
                                tension: 0.4,
                                borderWidth: 3,
                                pointBackgroundColor: '#e74c3c',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 7
                            },
                            { 
                                label: 'Outpatient', 
                                data: periods.map(p => Math.round(p.claims * 0.70)), 
                                borderColor: '#3498db', 
                                backgroundColor: fillBlue, 
                                fill: true, 
                                tension: 0.4,
                                borderWidth: 3,
                                pointBackgroundColor: '#3498db',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 7
                            },
                            { 
                                label: 'Ex Gratia', 
                                data: periods.map(p => Math.round(p.claims * 0.08)), 
                                borderColor: '#D4AF37', 
                                backgroundColor: fillGold, 
                                fill: true, 
                                tension: 0.4,
                                borderWidth: 3,
                                pointBackgroundColor: '#D4AF37',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 7
                            }
                        ]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { display: true, position: 'top', labels: { color: '#b8c9b8', font: { weight: 'bold', size: 11 } } }
                        }, 
                        scales: { 
                            x: { grid: { display: false }, ticks: { color: '#b8c9b8' } }, 
                            y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } } 
                        }
                    }
                });
            }
        }
        
        function createMemberTypeCharts(principal, dependent, claims) {
            // Member Type Pie - Doughnut
            const ctx1 = safeGetContext('memberTypePieChart');
            if (ctx1) {
                if (charts.memberPie) charts.memberPie.destroy();
                
                // Create gradient for 3D effect
                const greenGrad = ctx1.createLinearGradient(0, 0, 0, 300);
                greenGrad.addColorStop(0, '#4CAF50');
                greenGrad.addColorStop(1, '#1B5E20');
                const goldGrad = ctx1.createLinearGradient(0, 0, 0, 300);
                goldGrad.addColorStop(0, '#FFD700');
                goldGrad.addColorStop(1, '#B8860B');
                
                charts.memberPie = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: ['Seafarers', 'Dependents'],
                        datasets: [{ 
                            data: [principal, dependent], 
                            backgroundColor: [greenGrad, goldGrad], 
                            borderWidth: 3,
                            borderColor: ['#1B5E20', '#8B7500'],
                            hoverOffset: 15,
                            hoverBorderWidth: 4
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        cutout: '55%', 
                        plugins: { 
                            legend: { display: true, position: 'bottom', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20, boxWidth: 16, boxHeight: 16 } }
                        },
                        animation: { animateRotate: true, animateScale: true }
                    }
                });
                
                // Claims by Member Type - Bar Chart
                const ctx2 = safeGetContext('memberTypeClaimsChart');
                if (ctx2) {
                    if (charts.memberClaims) charts.memberClaims.destroy();
                    
                    const principalClaims = Math.round(claims * 0.55);
                    const dependentClaims = claims - principalClaims;
                    
                    // Update stat values
                    const principalClaimsEl = document.getElementById('principalClaims');
                    const dependentClaimsEl = document.getElementById('dependentClaims');
                    if (principalClaimsEl) principalClaimsEl.textContent = fmt(principalClaims);
                    if (dependentClaimsEl) dependentClaimsEl.textContent = fmt(dependentClaims);
                    
                    charts.memberClaims = new Chart(ctx2, {
                        type: 'doughnut',
                        data: {
                            labels: ['Seafarer Claims', 'Dependent Claims'],
                            datasets: [{ 
                                data: [principalClaims, dependentClaims], 
                                backgroundColor: [greenGrad, goldGrad], 
                                borderWidth: 3,
                                borderColor: ['#1B5E20', '#8B7500'],
                                hoverOffset: 15
                            }]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            cutout: '55%', 
                            plugins: { 
                                legend: { display: true, position: 'bottom', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20 } }
                            }
                        }
                    });
                }
            }
        }
        
        // NOTE: createCostBreakdownChart function removed (uses financial data)
        // NOTE: duplicate createMovementCharts function removed (use createMovementChartsReal instead)
        
        // ============ NEW SECTIONS CHARTS ============
        
        function createCategoryCharts(current) {
            // Mock data - will come from Excel/CBMS (NO COST DATA for client portal)
            const categories = [
                { name: 'Medical', cases: 450, color: '#4CAF50' },
                { name: 'Dental', cases: 180, color: '#2196F3' },
                { name: 'Maternity', cases: 45, color: '#E91E63' },
                { name: 'Optical', cases: 120, color: '#FF9800' },
                { name: 'Laboratory', cases: 280, color: '#D4AF37' },
                { name: 'Other', cases: 95, color: '#607D8B' }
            ];
            
            // Update stat values (with null checks)
            const catMedical = document.getElementById('catMedical');
            const catDental = document.getElementById('catDental');
            const catMaternity = document.getElementById('catMaternity');
            const catOptical = document.getElementById('catOptical');
            const catLab = document.getElementById('catLab');
            const catOther = document.getElementById('catOther');
            
            if (catMedical) catMedical.textContent = categories[0].cases;
            if (catDental) catDental.textContent = categories[1].cases;
            if (catMaternity) catMaternity.textContent = categories[2].cases;
            if (catOptical) catOptical.textContent = categories[3].cases;
            if (catLab) catLab.textContent = categories[4].cases;
            if (catOther) catOther.textContent = categories[5].cases;
            
            // Category Pie Chart (with null check)
            const canvas1 = document.getElementById('categoryPieChart');
            if (canvas1) {
                const ctx1 = canvas1.getContext('2d');
                if (charts.categoryPie) charts.categoryPie.destroy();
                charts.categoryPie = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: categories.map(c => c.name),
                        datasets: [{
                            data: categories.map(c => c.cases),
                            backgroundColor: categories.map(c => c.color),
                            borderWidth: 2,
                            borderColor: '#0a1a0a',
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '55%',
                        plugins: { legend: { display: true, position: 'right', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20, boxWidth: 16, boxHeight: 16 } } }
                    }
                });
            }
            
            // Category Trend Chart (with null check)
            const canvas3 = document.getElementById('categoryTrendChart');
            if (canvas3) {
                const ctx3 = canvas3.getContext('2d');
                if (charts.categoryTrend) charts.categoryTrend.destroy();
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                charts.categoryTrend = new Chart(ctx3, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: categories.slice(0, 4).map(cat => ({
                            label: cat.name,
                            data: months.map(() => Math.round(cat.cases / 6 * (0.8 + Math.random() * 0.4))),
                            borderColor: cat.color,
                            backgroundColor: cat.color + '20',
                            fill: false,
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: 4
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true, position: 'top', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20 } } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#b8c9b8' } },
                            y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } }
                        }
                    }
                });
            }
        }
        
        function createYoYCharts(periods) {
            // Mock YoY data (NO COST DATA for client portal)
            const data2024 = { claims: 3850, members: 980 };
            const data2025 = { claims: 4320, members: 1127 };
            
            // Update YoY stats (with null checks)
            const yoyClaims2025 = document.getElementById('yoyClaims2025');
            const yoyClaims2024 = document.getElementById('yoyClaims2024');
            const yoyClaimsChange = document.getElementById('yoyClaimsChange');
            const yoyMemberChange = document.getElementById('yoyMemberChange');
            
            if (yoyClaims2025) yoyClaims2025.textContent = fmt(data2025.claims);
            if (yoyClaims2024) yoyClaims2024.textContent = fmt(data2024.claims);
            
            const claimsChange = ((data2025.claims - data2024.claims) / data2024.claims * 100).toFixed(0);
            const memberChange = ((data2025.members - data2024.members) / data2024.members * 100).toFixed(0);
            
            if (yoyClaimsChange) yoyClaimsChange.textContent = (claimsChange > 0 ? '+' : '') + claimsChange + '%';
            if (yoyMemberChange) yoyMemberChange.textContent = (memberChange > 0 ? '+' : '') + memberChange + '%';
            
            // YoY Claims Chart (with null check)
            const canvas1 = document.getElementById('yoyClaimsChart');
            if (canvas1) {
                const ctx1 = canvas1.getContext('2d');
                if (charts.yoyClaims) charts.yoyClaims.destroy();
                charts.yoyClaims = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: ['Q1', 'Q2', 'Q3', 'Q4'],
                        datasets: [
                            { label: '2024', data: [920, 980, 1050, 900], backgroundColor: 'rgba(122,143,122,0.7)', borderRadius: 4 },
                            { label: '2025', data: [1080, 1150, 1090, null], backgroundColor: 'rgba(212,175,55,0.8)', borderRadius: 4 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true, position: 'top', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20 } } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#b8c9b8' } },
                            y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } }
                        }
                    }
                });
            }
            
            // YoY Trend Chart (with null check)
            const canvas3 = document.getElementById('yoyTrendChart');
            if (canvas3) {
                const ctx3 = canvas3.getContext('2d');
                if (charts.yoyTrend) charts.yoyTrend.destroy();
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'];
                charts.yoyTrend = new Chart(ctx3, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            { 
                                label: '2025', 
                                data: [320, 380, 410, 350, 420, 380, 390, 410, 360],
                                borderColor: '#D4AF37',
                                backgroundColor: 'rgba(212,175,55,0.2)',
                                fill: true,
                                tension: 0.4,
                                borderWidth: 3,
                                pointRadius: 5
                            },
                            { 
                                label: '2024', 
                                data: [280, 320, 350, 310, 380, 340, 360, 390, 320],
                                borderColor: '#7a8f7a',
                                backgroundColor: 'rgba(122,143,122,0.1)',
                                fill: true,
                                tension: 0.4,
                                borderWidth: 2,
                                borderDash: [5, 5],
                                pointRadius: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true, position: 'top', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20 } } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#b8c9b8' } },
                            y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } }
                        }
                    }
                });
            }
        }
        
        function createHospitalCharts() {
            // Mock hospital data - will come from CBMS (NO COST DATA for client portal)
            const hospitals = [
                { name: 'St. Luke\'s BGC', claims: 185 },
                { name: 'Makati Medical', claims: 156 },
                { name: 'The Medical City', claims: 142 },
                { name: 'Asian Hospital', claims: 128 },
                { name: 'Manila Doctors', claims: 115 },
                { name: 'Cardinal Santos', claims: 98 },
                { name: 'Chong Hua Cebu', claims: 87 },
                { name: 'UERM', claims: 76 },
                { name: 'PGH', claims: 68 },
                { name: 'Others', claims: 315 }
            ];
            
            const totalClaims = hospitals.reduce((a, h) => a + h.claims, 0);
            
            // Top Hospitals by Claims (with null check)
            const canvas1 = document.getElementById('topHospitalsChart');
            if (canvas1) {
                const ctx1 = canvas1.getContext('2d');
                if (charts.topHospitals) charts.topHospitals.destroy();
                charts.topHospitals = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: hospitals.map(h => h.name),
                        datasets: [{
                            data: hospitals.map(h => h.claims),
                            backgroundColor: 'rgba(76,175,80,0.7)',
                            borderColor: '#4CAF50',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } },
                            y: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 9 } } }
                        }
                    }
                });
            }
            
            // Hospital Table (NO COST DATA for client portal)
            const tbody = document.getElementById('hospitalsTableBody');
            if (tbody) {
                tbody.innerHTML = hospitals.map((h, i) => `
                    <tr>
                        <td><span style="background:${i < 3 ? '#D4AF37' : '#2E7D32'};color:#000;padding:2px 8px;border-radius:10px;font-weight:bold">${i + 1}</span></td>
                        <td><strong>${h.name}</strong></td>
                        <td>${h.claims}</td>
                        <td>${(h.claims / totalClaims * 100).toFixed(1)}%</td>
                    </tr>
                `).join('');
            }
        }
        
        function createGeoCharts() {
            // Mock geographic data - will come from CBMS (NO COST DATA for client portal)
            const regions = [
                { name: 'NCR', claims: 580, color: '#4CAF50' },
                { name: 'Central Visayas', claims: 245, color: '#2196F3' },
                { name: 'Davao Region', claims: 165, color: '#FF9800' },
                { name: 'Western Visayas', claims: 125, color: '#D4AF37' },
                { name: 'Central Luzon', claims: 95, color: '#E91E63' },
                { name: 'Other Regions', claims: 160, color: '#607D8B' }
            ];
            
            // Update city stats (with null checks)
            const geoManila = document.getElementById('geoManila');
            const geoCebu = document.getElementById('geoCebu');
            const geoDavao = document.getElementById('geoDavao');
            const geoIloilo = document.getElementById('geoIloilo');
            const geoOther = document.getElementById('geoOther');
            
            if (geoManila) geoManila.textContent = '580';
            if (geoCebu) geoCebu.textContent = '185';
            if (geoDavao) geoDavao.textContent = '165';
            if (geoIloilo) geoIloilo.textContent = '95';
            if (geoOther) geoOther.textContent = '345';
            
            // Region Pie Chart (with null check)
            const canvas1 = document.getElementById('geoRegionChart');
            if (canvas1) {
                const ctx1 = canvas1.getContext('2d');
                if (charts.geoRegion) charts.geoRegion.destroy();
                charts.geoRegion = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: regions.map(r => r.name),
                        datasets: [{
                            data: regions.map(r => r.claims),
                            backgroundColor: regions.map(r => r.color),
                            borderWidth: 2,
                            borderColor: '#0a1a0a',
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '55%',
                        plugins: { legend: { display: true, position: 'right', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20, boxWidth: 16, boxHeight: 16 } } }
                    }
                });
            }
            
            // Cities Bar Chart (with null check)
            const canvas3 = document.getElementById('geoCitiesChart');
            if (canvas3) {
                const ctx3 = canvas3.getContext('2d');
                if (charts.geoCities) charts.geoCities.destroy();
                const cities = [
                    { name: 'Manila', claims: 285 },
                    { name: 'Quezon City', claims: 165 },
                    { name: 'Cebu City', claims: 145 },
                    { name: 'Davao City', claims: 125 },
                    { name: 'Makati', claims: 95 },
                    { name: 'Pasig', claims: 85 },
                    { name: 'Iloilo City', claims: 75 },
                    { name: 'Taguig', claims: 65 }
                ];
                charts.geoCities = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: cities.map(c => c.name),
                        datasets: [{
                            data: cities.map(c => c.claims),
                            backgroundColor: [
                                '#4CAF50', '#66BB6A', '#2196F3', '#FF9800', 
                                '#D4AF37', '#E91E63', '#00BCD4', '#607D8B'
                            ],
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#b8c9b8', font: { size: 13, weight: 'bold' } } },
                            y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', font: { size: 12 } } }
                        }
                    }
                });
            }
        }
        
        function setTrend(id, ch) {
            const el = document.getElementById(id);
            if (!ch || ch.percentage === null) { el.textContent = 'N/A'; return; }
            el.innerHTML = `${ch.percentage > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(ch.percentage).toFixed(1)}%`;
            el.className = `kpi-trend ${ch.percentage <= 0 ? 'down' : 'up'}`;
        }
        
        function setChange(id, ch) {
            const el = document.getElementById(id);
            if (!ch || ch.percentage === null) { el.textContent = 'N/A'; return; }
            el.innerHTML = `${ch.percentage > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(ch.percentage).toFixed(1)}%`;
            el.className = `cmp-change ${ch.percentage >= 0 ? 'positive' : 'negative'}`;
        }
        
        function createCharts(periods, current) {
            const labels = periods.map(p => p.period_label);
            
            // 3D Shadow plugin
            const shadow3D = {
                id: 'shadow3D',
                beforeDraw: (chart) => {
                    const ctx = chart.ctx;
                    ctx.save();
                    ctx.shadowColor = 'rgba(0,0,0,0.4)';
                    ctx.shadowBlur = 12;
                    ctx.shadowOffsetX = 5;
                    ctx.shadowOffsetY = 5;
                }
            };
            
            const opts = {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(13,31,13,0.95)', borderColor: '#D4AF37', borderWidth: 2, titleFont: { weight: 'bold' } } }
            };
            
            // NOTE: Cost/Financial charts removed from client portal
            
            // Claims by Period - 3D Bars (with null check)
            const canvas3 = document.getElementById('claimsPeriodChart');
            if (canvas3) {
                const ctx3 = canvas3.getContext('2d');
                if (charts.claimsPeriod) charts.claimsPeriod.destroy();
                const claimsGrad = ctx3.createLinearGradient(0, 0, 0, 250);
                claimsGrad.addColorStop(0, '#FFE082');
                claimsGrad.addColorStop(0.5, '#FFD54F');
                claimsGrad.addColorStop(1, '#FFC107');
                charts.claimsPeriod = new Chart(ctx3, {
                    type: 'bar',
                    plugins: [shadow3D],
                    data: { 
                        labels, 
                        datasets: [{ 
                            data: periods.map(p => p.claims), 
                            backgroundColor: claimsGrad, 
                            borderColor: '#F57F17',
                            borderWidth: 2,
                            borderRadius: { topLeft: 6, topRight: 6, bottomLeft: 0, bottomRight: 0 },
                            barPercentage: 0.6
                        }] 
                    },
                    options: { ...opts, scales: { x: { grid: { display: false }, ticks: { color: '#b8c9b8' } }, y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } } } }
                });
            }
            
            // Claims per 1000 - 3D Line (with null check)
            const canvas4 = document.getElementById('claims1000Chart');
            if (canvas4) {
                const ctx4 = canvas4.getContext('2d');
                if (charts.claims1000) charts.claims1000.destroy();
                const blueGrad = ctx4.createLinearGradient(0, 0, 0, 200);
                blueGrad.addColorStop(0, 'rgba(66,165,245,0.5)');
                blueGrad.addColorStop(1, 'rgba(66,165,245,0.02)');
                charts.claims1000 = new Chart(ctx4, {
                    type: 'line',
                    data: { 
                        labels, 
                        datasets: [{ 
                            data: periods.map(p => p.members > 0 ? p.claims / p.members * 1000 : 0), 
                            borderColor: '#42A5F5', 
                            backgroundColor: blueGrad, 
                            fill: true, 
                            tension: 0.4,
                            borderWidth: 4,
                            pointRadius: 5,
                            pointBackgroundColor: '#42A5F5',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 8
                        }] 
                    },
                    options: { ...opts, scales: { x: { grid: { display: false }, ticks: { color: '#b8c9b8' } }, y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a' } } } }
                });
            }
            
            // NOTE: Avg Claim chart removed (uses financial data)
            
            // Plan Pie - 3D Doughnut (with null check)
            const canvas6 = document.getElementById('planPieChart');
            if (canvas6) {
                const ctx6 = canvas6.getContext('2d');
                if (charts.planPie) charts.planPie.destroy();
                const goldPlanGrad = ctx6.createLinearGradient(0, 0, 0, 300);
                goldPlanGrad.addColorStop(0, '#FFE57F');
                goldPlanGrad.addColorStop(1, '#FFB300');
                const platGrad = ctx6.createLinearGradient(0, 0, 0, 300);
                platGrad.addColorStop(0, '#F5F5F5');
                platGrad.addColorStop(1, '#BDBDBD');
                const silverGrad = ctx6.createLinearGradient(0, 0, 0, 300);
                silverGrad.addColorStop(0, '#E0E0E0');
                silverGrad.addColorStop(1, '#9E9E9E');
                charts.planPie = new Chart(ctx6, {
                    type: 'doughnut',
                    plugins: [shadow3D],
                    data: { 
                        labels: ['Gold', 'Platinum', 'Silver'], 
                        datasets: [{ 
                            data: [60, 25, 15], 
                            backgroundColor: [goldPlanGrad, platGrad, silverGrad], 
                            borderColor: ['#FF8F00', '#757575', '#616161'], 
                            borderWidth: 3, 
                            hoverOffset: 15 
                        }] 
                    },
                    options: { ...opts, cutout: '55%', plugins: { legend: { display: true, position: 'bottom', labels: { color: '#b8c9b8', font: { size: 14, weight: 'bold' }, padding: 20 } } } }
                });
            }
            
            // NOTE: Plan Cost chart removed (uses financial data)
            
            // Utilization - 3D Line (with null check)
            const canvas8 = document.getElementById('utilizationChart');
            if (canvas8) {
                const ctx8 = canvas8.getContext('2d');
                if (charts.util) charts.util.destroy();
                const greenGrad = ctx8.createLinearGradient(0, 0, 0, 200);
                greenGrad.addColorStop(0, 'rgba(76,175,80,0.5)');
                greenGrad.addColorStop(1, 'rgba(76,175,80,0.02)');
                charts.util = new Chart(ctx8, {
                    type: 'line',
                    data: { 
                        labels, 
                        datasets: [{ 
                            data: periods.map(p => p.members > 0 ? p.claims / p.members * 100 : 0), 
                            borderColor: '#4CAF50', 
                            backgroundColor: greenGrad, 
                            fill: true, 
                            tension: 0.4,
                            borderWidth: 4,
                            pointRadius: 5,
                            pointBackgroundColor: '#4CAF50',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 8
                        }] 
                    },
                    options: { ...opts, scales: { x: { grid: { display: false }, ticks: { color: '#b8c9b8' } }, y: { grid: { color: 'rgba(30,58,30,0.3)' }, ticks: { color: '#7a8f7a', callback: v => v + '%' } } } }
                });
            }
        }
        
        function updateMetrics(util) {
            document.getElementById('utilValue').textContent = util.toFixed(1) + '%';
            document.getElementById('utilBar').style.width = Math.min(util * 2, 100) + '%';
        }
        
        function updateInsights(ch) {
            const list = document.getElementById('insightsList');
            const insights = [];
            if (ch) {
                // Check cost - good if decreased (negative percentage)
                if (ch.cost && ch.cost.percentage !== null) {
                    if (ch.cost.percentage < 0) insights.push({ type: 'success', icon: '‚úì', title: 'Cost Improvement', desc: `Cost decreased by ${Math.abs(ch.cost.percentage).toFixed(1)}%` });
                    else if (ch.cost.percentage > 10) insights.push({ type: 'danger', icon: '‚ö†', title: 'Cost Alert', desc: `Cost increased by ${ch.cost.percentage.toFixed(1)}%` });
                }
                // Check members - good if increased
                if (ch.members && ch.members.percentage !== null && ch.members.percentage > 0) {
                    insights.push({ type: 'success', icon: 'üìà', title: 'Growth', desc: `Members grew by ${ch.members.percentage.toFixed(1)}%` });
                }
                // Check claims - warning if increased significantly
                if (ch.claims && ch.claims.percentage !== null && ch.claims.percentage > 5) {
                    insights.push({ type: 'warning', icon: '!', title: 'Claims Up', desc: `Claims increased by ${ch.claims.percentage.toFixed(1)}%` });
                }
            }
            while (insights.length < 3) insights.push({ type: 'info', icon: '‚Ñπ', title: 'Analysis', desc: 'Continue monitoring trends' });
            list.innerHTML = insights.slice(0, 3).map(i => `
                <div class="insight-item ${i.type}">
                    <div class="insight-icon">${i.icon}</div>
                    <div><div class="insight-title">${i.title}</div><div class="insight-desc">${i.desc}</div></div>
                </div>
            `).join('');
        }
        
        function updateTable(periods) {
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = periods.map((p, i) => {
                const rank = periods.length - i;
                const cls = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
                const util = p.members > 0 ? (p.claims / p.members * 100).toFixed(1) : 0;
                return `<tr>
                    <td><div class="rank-badge ${cls}">${rank}</div></td>
                    <td><strong>${p.period_label}</strong></td>
                    <td>${fmt(p.members)}</td>
                    <td>${fmt(p.claims)}</td>
                    <td>${util}%</td>
                </tr>`;
            }).reverse().join('');
        }
        
        function fmt(n) { return n === undefined ? '-' : n.toLocaleString('en-US', { maximumFractionDigits: 0 }); }
    </script>
</body>
</html>
